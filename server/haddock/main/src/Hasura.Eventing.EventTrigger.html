<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- |</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- = Event Triggers</span><span>
</span><span id="line-3"></span><span class="hs-comment">--</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Event triggers are like ordinary SQL triggers, except instead of calling a SQL</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- procedure, they call a webhook. The event delivery mechanism involves coordination</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- between both the database and graphql-engine: only the SQL database knows</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- when the events should fire, but only graphql-engine know how to actually</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- deliver them.</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- Therefore, event triggers are implemented in two parts:</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- 1. Every event trigger is backed by a bona fide SQL trigger. When the SQL trigger</span><span>
</span><span id="line-13"></span><span class="hs-comment">--    fires, it creates a new record in the hdb_catalog.event_log table.</span><span>
</span><span id="line-14"></span><span class="hs-comment">--</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- 2. Concurrently, a thread in graphql-engine monitors the hdb_catalog.event_log</span><span>
</span><span id="line-16"></span><span class="hs-comment">--    table for new events. When new event(s) are found, it uses the information</span><span>
</span><span id="line-17"></span><span class="hs-comment">--    (URL,payload and headers) stored in the event to deliver the event</span><span>
</span><span id="line-18"></span><span class="hs-comment">--    to the webhook.</span><span>
</span><span id="line-19"></span><span class="hs-comment">--</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- The creation and deletion of SQL trigger itself is managed by the metadata DDL</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- APIs (see Hasura.RQL.DDL.EventTrigger), so this module focuses on event delivery.</span><span>
</span><span id="line-22"></span><span class="hs-comment">--</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- Most of the subtleties involve guaranteeing reliable delivery of events:</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- we guarantee that every event will be delivered at least once,</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- even if graphql-engine crashes. This means we have to record the state</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- of each event in the database, and we have to retry</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- failed requests at a regular (user-configurable) interval.</span><span>
</span><span id="line-28"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Eventing.EventTrigger</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#initEventEngineCtx"><span class="hs-identifier">initEventEngineCtx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#createFetchedEventsStatsLogger"><span class="hs-identifier">createFetchedEventsStatsLogger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#closeFetchedEventsStatsLogger"><span class="hs-identifier">closeFetchedEventsStatsLogger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier">processEventQueue</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultMaxEventThreads"><span class="hs-identifier">defaultMaxEventThreads</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultFetchInterval"><span class="hs-identifier">defaultFetchInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier">Event</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier">EventEngineCtx</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-comment">-- Exported for testing</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier">saveLockedEventTriggerEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier">removeEventTriggerEventFromLockedEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier">logQErr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lifted-async-0.10.2.3-d63f7c0774c9603306fb6be4536181f7e6facdd649f3f450b4e7dfd3d91cda94/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html"><span class="hs-identifier">Control.Concurrent.Async.Lifted.Safe</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LA</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier">Forever</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier">sleep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TVar</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/fold-debounce-0.2.0.11-622279410c8c77ef4e9411a4aa9d0e5522a31abe0d691c392836ec8bbde58a43/share/doc/html/src/Control.FoldDebounce.html"><span class="hs-identifier">Control.FoldDebounce</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FDebounce</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.html"><span class="hs-identifier">Control.Lens</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadMask</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">bracket_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">finally</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mask_</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.STM</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/monad-control-1.0.3.1-db4229aec3d9c1011503cf06798714c732b74d731fab23998dd34d578ed6d457/share/doc/html/src/Control.Monad.Trans.Control.html"><span class="hs-identifier">Control.Monad.Trans.Control</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/monad-control-1.0.3.1-db4229aec3d9c1011503cf06798714c732b74d731fab23998dd34d578ed6d457/share/doc/html/src/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier">MonadBaseControl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.html"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Key.html"><span class="hs-identifier">Data.Aeson.Key</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Key</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.KeyMap.html"><span class="hs-identifier">Data.Aeson.KeyMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">KeyMap</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-aeson-1.2.2-81109da53433966d8b3e225f0220e71a6ae7fcd29eb5d0360770d3cdcf621c9c/share/doc/html/src/Data.Aeson.Lens.html"><span class="hs-identifier">Data.Aeson.Lens</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">JL</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/data-has-0.4.0.0-dac5c7adae74e1856a42108dcba181ae6d833a24d6271d4129aff0f1aaae2f5f/share/doc/html/src/Data.Has.html"><span class="hs-identifier">Data.Has</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Strict.html"><span class="hs-identifier">Data.HashMap.Strict</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.SerializableBlob.html"><span class="hs-identifier">Data.SerializableBlob</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SB</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.String</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-d0f6d61f5277bae932134563876cbceb4967915f364959864c72abbc2978d8ed/share/doc/html/src/Data.Text.html"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.NonEmpty.html"><span class="hs-identifier">Data.Text.NonEmpty</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Time</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html"><span class="hs-identifier">Hasura.Backends.Postgres.SQL.Types</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#TableName"><span class="hs-identifier">TableName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.Backend.html"><span class="hs-identifier">Hasura.Eventing.Backend</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html"><span class="hs-identifier">Hasura.Eventing.Common</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.HTTP.html"><span class="hs-identifier">Hasura.Eventing.HTTP</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.HTTP.html"><span class="hs-identifier">Hasura.HTTP</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.HTTP.html#getHTTPExceptionStatus"><span class="hs-identifier">getHTTPExceptionStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Webhook.Transform.html"><span class="hs-identifier">Hasura.RQL.DDL.Webhook.Transform</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html"><span class="hs-identifier">Hasura.RQL.Types.BackendType</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.Types.EventTrigger</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Metrics.html"><span class="hs-identifier">Hasura.Server.Metrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier">ServerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html"><span class="hs-identifier">Hasura.Server.Prometheus</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Network.HTTP.Client.Transformable.html"><span class="hs-identifier">Network.HTTP.Client.Transformable</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HTTP</span></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html"><span class="hs-identifier">Refined</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#NonNegative"><span class="hs-identifier">NonNegative</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#Positive"><span class="hs-identifier">Positive</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.Unsafe.Type.html#Refined"><span class="hs-identifier">Refined</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#unrefine"><span class="hs-identifier">unrefine</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.Unsafe.html"><span class="hs-identifier">Refined.Unsafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.Unsafe.html#unsafeRefine"><span class="hs-identifier">unsafeRefine</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Distribution.html"><span class="hs-identifier">System.Metrics.Distribution</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Distribution</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html"><span class="hs-identifier">System.Metrics.Gauge</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Gauge</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Counter.html"><span class="hs-identifier">System.Metrics.Prometheus.Counter</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Prometheus.Counter</span></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.CounterVector.html"><span class="hs-identifier">System.Metrics.Prometheus.CounterVector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.CounterVector.html#CounterVector"><span class="hs-identifier">CounterVector</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.CounterVector.html"><span class="hs-identifier">System.Metrics.Prometheus.CounterVector</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CounterVector</span></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html"><span class="hs-identifier">System.Metrics.Prometheus.Gauge</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Prometheus.Gauge</span></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Histogram.html"><span class="hs-identifier">System.Metrics.Prometheus.Histogram</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Prometheus.Histogram</span></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lifted-base-0.2.3.12-dda1adedff1e58883d645c3d159e5d196513de2aea81f9a332fe2d42327ade1a/share/doc/html/src/System.Timeout.Lifted.html"><span class="hs-identifier">System.Timeout.Lifted</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lifted-base-0.2.3.12-dda1adedff1e58883d645c3d159e5d196513de2aea81f9a332fe2d42327ade1a/share/doc/html/src/System.Timeout.Lifted.html#timeout"><span class="hs-identifier">timeout</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-keyword">newtype</span><span> </span><span id="EventInternalErr"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span></span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="EventInternalErr"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687716915"><span id="local-6989586621687716920"><span class="annot"><span class="annottext">EventInternalErr -&gt; EventInternalErr -&gt; Bool
(EventInternalErr -&gt; EventInternalErr -&gt; Bool)
-&gt; (EventInternalErr -&gt; EventInternalErr -&gt; Bool)
-&gt; Eq EventInternalErr
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
== :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
$c/= :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
/= :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Logging.html#ToEngineLog"><span class="hs-identifier hs-type">L.ToEngineLog</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-type">EventInternalErr</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-103"></span><span>  </span><span id="local-6989586621687716933"><span class="annot"><span class="annottext">toEngineLog :: EventInternalErr -&gt; (LogLevel, EngineLogType Hasura, Value)
</span><a href="#local-6989586621687716933"><span class="hs-identifier hs-var hs-var hs-var hs-var">toEngineLog</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-type">EventInternalErr</span></a></span><span> </span><span id="local-6989586621687716935"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687716935"><span class="hs-identifier hs-var">qerr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">L.LevelError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EngineLogType Hasura
</span><a href="Hasura.Logging.html#eventTriggerLogType"><span class="hs-identifier hs-var">L.eventTriggerLogType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">J.toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687716935"><span class="hs-identifier hs-var">qerr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">{- Note [Maintenance mode]
~~~~~~~~~~~~~~~~~~~~~~~~~~

Maintenance mode is a mode in which users can upgrade their graphql-engine
without any down time. More on maintenance mode can be found here:
https://github.com/hasura/graphql-engine-mono/issues/431.

Basically, there are a few main things that maintenance mode boils down to:

1. No operation that may change the metadata will be allowed.
2. Migrations are not applied when the graphql-engine is started, so the
   catalog schema will be in the older version.
3. Event triggers should continue working in the new code with the older
   catalog schema i.e it should work even if there are any schema changes
   to the `hdb_catalog.event_log` table.

#1 and #2 are fairly self-explanatory. For #3, we need to support fetching
events depending upon the catalog version. So, fetch events works in the
following way now:

1. Check if maintenance mode is enabled
2. If maintenance mode is enabled then read the catalog version from the DB
   and accordingly fire the appropriate query to the events log table.
   When maintenance mode is disabled, we query the events log table according
   to the latest catalog, we do not read the catalog version for this.
-}</span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span class="annot"><span class="hs-comment">-- | See Note [Maintenance Mode]</span></span><span>
</span><span id="line-133"></span><span class="hs-keyword">data</span><span> </span><span id="EventEngineCtx"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-var">EventEngineCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EventEngineCtx"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-var">EventEngineCtx</span></a></span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_eeCtxEventThreadsCapacity"><span class="annot"><span class="annottext">EventEngineCtx -&gt; TVar Int
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxEventThreadsCapacity"><span class="hs-identifier hs-var hs-var">_eeCtxEventThreadsCapacity</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>    </span><span id="_eeCtxFetchInterval"><span class="annot"><span class="annottext">EventEngineCtx -&gt; DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxFetchInterval"><span class="hs-identifier hs-var hs-var">_eeCtxFetchInterval</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DiffTime</span></span><span class="hs-special">,</span><span>
</span><span id="line-136"></span><span>    </span><span id="_eeCtxFetchSize"><span class="annot"><span class="annottext">EventEngineCtx -&gt; Refined NonNegative Int
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxFetchSize"><span class="hs-identifier hs-var hs-var">_eeCtxFetchSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.Unsafe.Type.html#Refined"><span class="hs-identifier hs-type">Refined</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#NonNegative"><span class="hs-identifier hs-type">NonNegative</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-keyword">data</span><span> </span><span id="DeliveryInfo"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-var">DeliveryInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DeliveryInfo"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-var">DeliveryInfo</span></a></span></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="diCurrentRetry"><span class="annot"><span class="annottext">DeliveryInfo -&gt; Int
</span><a href="Hasura.Eventing.EventTrigger.html#diCurrentRetry"><span class="hs-identifier hs-var hs-var">diCurrentRetry</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-141"></span><span>    </span><span id="diMaxRetries"><span class="annot"><span class="annottext">DeliveryInfo -&gt; Int
</span><a href="Hasura.Eventing.EventTrigger.html#diMaxRetries"><span class="hs-identifier hs-var hs-var">diMaxRetries</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687716947"><span id="local-6989586621687716953"><span id="local-6989586621687716957"><span class="annot"><span class="annottext">Int -&gt; DeliveryInfo -&gt; ShowS
[DeliveryInfo] -&gt; ShowS
DeliveryInfo -&gt; String
(Int -&gt; DeliveryInfo -&gt; ShowS)
-&gt; (DeliveryInfo -&gt; String)
-&gt; ([DeliveryInfo] -&gt; ShowS)
-&gt; Show DeliveryInfo
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; DeliveryInfo -&gt; ShowS
showsPrec :: Int -&gt; DeliveryInfo -&gt; ShowS
$cshow :: DeliveryInfo -&gt; String
show :: DeliveryInfo -&gt; String
$cshowList :: [DeliveryInfo] -&gt; ShowS
showList :: [DeliveryInfo] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687716961"><span id="local-6989586621687716963"><span class="annot"><span class="annottext">(forall x. DeliveryInfo -&gt; Rep DeliveryInfo x)
-&gt; (forall x. Rep DeliveryInfo x -&gt; DeliveryInfo)
-&gt; Generic DeliveryInfo
forall x. Rep DeliveryInfo x -&gt; DeliveryInfo
forall x. DeliveryInfo -&gt; Rep DeliveryInfo x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. DeliveryInfo -&gt; Rep DeliveryInfo x
from :: forall x. DeliveryInfo -&gt; Rep DeliveryInfo x
$cto :: forall x. Rep DeliveryInfo x -&gt; DeliveryInfo
to :: forall x. Rep DeliveryInfo x -&gt; DeliveryInfo
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687716967"><span id="local-6989586621687716972"><span class="annot"><span class="annottext">DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
(DeliveryInfo -&gt; DeliveryInfo -&gt; Bool)
-&gt; (DeliveryInfo -&gt; DeliveryInfo -&gt; Bool) -&gt; Eq DeliveryInfo
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
== :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
$c/= :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
/= :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621687716978"><span id="local-6989586621687716982"><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier hs-type">J.ToJSON</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-type">DeliveryInfo</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-146"></span><span>  </span><span id="local-6989586621687717080"><span class="annot"><span class="annottext">toJSON :: DeliveryInfo -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; DeliveryInfo -&gt; Value
forall a.
(Generic a, GToJSON' Value Zero (Rep a)) =&gt;
Options -&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#genericToJSON"><span class="hs-identifier hs-var">J.genericToJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#hasuraJSON"><span class="hs-identifier hs-var">hasuraJSON</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">omitNothingFields :: Bool
</span><a href="#local-6989586621687717083"><span class="hs-identifier hs-var">J.omitNothingFields</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">}</span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621687717151"><span class="annot"><span class="annottext">toEncoding :: DeliveryInfo -&gt; Encoding
</span><a href="#local-6989586621687717151"><span class="hs-identifier hs-var hs-var hs-var hs-var">toEncoding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; DeliveryInfo -&gt; Encoding
forall a.
(Generic a, GToJSON' Encoding Zero (Rep a)) =&gt;
Options -&gt; a -&gt; Encoding
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#genericToEncoding"><span class="hs-identifier hs-var">J.genericToEncoding</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#hasuraJSON"><span class="hs-identifier hs-var">hasuraJSON</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">omitNothingFields :: Bool
</span><a href="#local-6989586621687717083"><span class="hs-identifier hs-var">J.omitNothingFields</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">}</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="hs-keyword">newtype</span><span> </span><span id="QualifiedTableStrict"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-var">QualifiedTableStrict</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="QualifiedTableStrict"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-var">QualifiedTableStrict</span></a></span></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="getQualifiedTable"><span class="annot"><span class="annottext">QualifiedTableStrict -&gt; QualifiedTable
</span><a href="Hasura.Eventing.EventTrigger.html#getQualifiedTable"><span class="hs-identifier hs-var hs-var">getQualifiedTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#QualifiedTable"><span class="hs-identifier hs-type">QualifiedTable</span></a></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687717157"><span id="local-6989586621687717163"><span id="local-6989586621687717167"><span class="annot"><span class="annottext">Int -&gt; QualifiedTableStrict -&gt; ShowS
[QualifiedTableStrict] -&gt; ShowS
QualifiedTableStrict -&gt; String
(Int -&gt; QualifiedTableStrict -&gt; ShowS)
-&gt; (QualifiedTableStrict -&gt; String)
-&gt; ([QualifiedTableStrict] -&gt; ShowS)
-&gt; Show QualifiedTableStrict
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; QualifiedTableStrict -&gt; ShowS
showsPrec :: Int -&gt; QualifiedTableStrict -&gt; ShowS
$cshow :: QualifiedTableStrict -&gt; String
show :: QualifiedTableStrict -&gt; String
$cshowList :: [QualifiedTableStrict] -&gt; ShowS
showList :: [QualifiedTableStrict] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687717171"><span id="local-6989586621687717177"><span class="annot"><span class="annottext">QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
(QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool)
-&gt; (QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool)
-&gt; Eq QualifiedTableStrict
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
== :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
$c/= :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
/= :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621687717185"><span id="local-6989586621687717189"><span id="local-6989586621687717192"><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier hs-type">J.ToJSON</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-type">QualifiedTableStrict</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-155"></span><span>  </span><span id="local-6989586621687717206"><span class="annot"><span class="annottext">toJSON :: QualifiedTableStrict -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-type">QualifiedTableStrict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#QualifiedObject"><span class="hs-identifier hs-type">QualifiedObject</span></a></span><span> </span><span id="local-6989586621687717208"><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621687717208"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span id="local-6989586621687717209"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687717209"><span class="hs-identifier hs-var">tn</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#object"><span class="hs-identifier hs-var">J.object</span></a></span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;schema&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; SchemaName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621687717208"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-158"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;name&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; TableName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687717209"><span class="hs-identifier hs-var">tn</span></a></span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-keyword">data</span><span> </span><span id="EventPayload"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-var">EventPayload</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687716342"><span class="annot"><a href="#local-6989586621687716342"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#BackendType"><span class="hs-identifier hs-type">BackendType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EventPayload"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-var">EventPayload</span></a></span></span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="epId"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; EventId
</span><a href="Hasura.Eventing.EventTrigger.html#epId"><span class="hs-identifier hs-var hs-var">epId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-163"></span><span>    </span><span id="epTable"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; TableName b
</span><a href="Hasura.Eventing.EventTrigger.html#epTable"><span class="hs-identifier hs-var hs-var">epTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716342"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-164"></span><span>    </span><span id="epTrigger"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; TriggerMetadata
</span><a href="Hasura.Eventing.EventTrigger.html#epTrigger"><span class="hs-identifier hs-var hs-var">epTrigger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerMetadata"><span class="hs-identifier hs-type">TriggerMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-165"></span><span>    </span><span id="epEvent"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; Value
</span><a href="Hasura.Eventing.EventTrigger.html#epEvent"><span class="hs-identifier hs-var hs-var">epEvent</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-166"></span><span>    </span><span id="epDeliveryInfo"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; DeliveryInfo
</span><a href="Hasura.Eventing.EventTrigger.html#epDeliveryInfo"><span class="hs-identifier hs-var hs-var">epDeliveryInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-type">DeliveryInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-167"></span><span>    </span><span id="epCreatedAt"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; LocalTime
</span><a href="Hasura.Eventing.EventTrigger.html#epCreatedAt"><span class="hs-identifier hs-var hs-var">epCreatedAt</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Time.LocalTime</span></span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687717220"><span id="local-6989586621687717222"><span class="annot"><span class="annottext">(forall x. EventPayload b -&gt; Rep (EventPayload b) x)
-&gt; (forall x. Rep (EventPayload b) x -&gt; EventPayload b)
-&gt; Generic (EventPayload b)
forall x. Rep (EventPayload b) x -&gt; EventPayload b
forall x. EventPayload b -&gt; Rep (EventPayload b) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (b :: BackendType) x.
Rep (EventPayload b) x -&gt; EventPayload b
forall (b :: BackendType) x.
EventPayload b -&gt; Rep (EventPayload b) x
$cfrom :: forall (b :: BackendType) x.
EventPayload b -&gt; Rep (EventPayload b) x
from :: forall x. EventPayload b -&gt; Rep (EventPayload b) x
$cto :: forall (b :: BackendType) x.
Rep (EventPayload b) x -&gt; EventPayload b
to :: forall x. Rep (EventPayload b) x -&gt; EventPayload b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span id="local-6989586621687716364"><span id="local-6989586621687717226"><span id="local-6989586621687717240"><span id="local-6989586621687717244"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716364"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716364"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span id="local-6989586621687716366"><span id="local-6989586621687717250"><span id="local-6989586621687717263"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716366"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716366"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621687716368"><span id="local-6989586621687717270"><span id="local-6989586621687717274"><span id="local-6989586621687717277"><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716368"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier hs-type">J.ToJSON</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716368"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-176"></span><span>  </span><span id="local-6989586621687717410"><span class="annot"><span class="annottext">toJSON :: EventPayload b -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; EventPayload b -&gt; Value
forall a.
(Generic a, GToJSON' Value Zero (Rep a)) =&gt;
Options -&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#genericToJSON"><span class="hs-identifier hs-var">J.genericToJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#hasuraJSON"><span class="hs-identifier hs-var">hasuraJSON</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">omitNothingFields :: Bool
</span><a href="#local-6989586621687717083"><span class="hs-identifier hs-var">J.omitNothingFields</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">}</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultMaxEventThreads"><span class="hs-identifier hs-type">defaultMaxEventThreads</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.Unsafe.Type.html#Refined"><span class="hs-identifier hs-type">Refined</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#Positive"><span class="hs-identifier hs-type">Positive</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-179"></span><span id="defaultMaxEventThreads"><span class="annot"><span class="annottext">defaultMaxEventThreads :: Refined Positive Int
</span><a href="Hasura.Eventing.EventTrigger.html#defaultMaxEventThreads"><span class="hs-identifier hs-var hs-var">defaultMaxEventThreads</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Refined Positive Int
forall {k} (p :: k) x. Predicate p x =&gt; x -&gt; Refined p x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.Unsafe.html#unsafeRefine"><span class="hs-identifier hs-var">unsafeRefine</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100</span></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultFetchInterval"><span class="hs-identifier hs-type">defaultFetchInterval</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DiffTime</span></span><span>
</span><span id="line-182"></span><span id="defaultFetchInterval"><span class="annot"><span class="annottext">defaultFetchInterval :: DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#defaultFetchInterval"><span class="hs-identifier hs-var hs-var">defaultFetchInterval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Seconds -&gt; DiffTime
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Data.Time.Clock.Units.html#seconds"><span class="hs-identifier hs-var">seconds</span></a></span><span> </span><span class="annot"><span class="annottext">Seconds
</span><span class="hs-number">1</span></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span id="local-6989586621687716377"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#initEventEngineCtx"><span class="hs-identifier hs-type">initEventEngineCtx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716377"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.Unsafe.Type.html#Refined"><span class="hs-identifier hs-type">Refined</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#Positive"><span class="hs-identifier hs-type">Positive</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.Unsafe.Type.html#Refined"><span class="hs-identifier hs-type">Refined</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#NonNegative"><span class="hs-identifier hs-type">NonNegative</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Data.Time.Clock.Units.html#Milliseconds"><span class="hs-identifier hs-type">Milliseconds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.Unsafe.Type.html#Refined"><span class="hs-identifier hs-type">Refined</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#NonNegative"><span class="hs-identifier hs-type">NonNegative</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687716377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span></span><span>
</span><span id="line-185"></span><span id="initEventEngineCtx"><span class="annot"><span class="annottext">initEventEngineCtx :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Refined Positive Int
-&gt; Refined NonNegative Milliseconds
-&gt; Refined NonNegative Int
-&gt; m EventEngineCtx
</span><a href="Hasura.Eventing.EventTrigger.html#initEventEngineCtx"><span class="hs-identifier hs-var hs-var">initEventEngineCtx</span></a></span></span><span> </span><span id="local-6989586621687717418"><span class="annot"><span class="annottext">Refined Positive Int
</span><a href="#local-6989586621687717418"><span class="hs-identifier hs-var">maxThreads</span></a></span></span><span> </span><span id="local-6989586621687717419"><span class="annot"><span class="annottext">Refined NonNegative Milliseconds
</span><a href="#local-6989586621687717419"><span class="hs-identifier hs-var">fetchInterval</span></a></span></span><span> </span><span id="local-6989586621687717420"><span class="annot"><span class="annottext">Refined NonNegative Int
</span><a href="#local-6989586621687717420"><span class="hs-identifier hs-var">_eeCtxFetchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-186"></span><span>  </span><span id="local-6989586621687717421"><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621687717421"><span class="hs-identifier hs-var">_eeCtxEventThreadsCapacity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TVar Int) -&gt; m (TVar Int)
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (TVar Int) -&gt; m (TVar Int)) -&gt; IO (TVar Int) -&gt; m (TVar Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (TVar Int)
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO (TVar Int)) -&gt; Int -&gt; IO (TVar Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Refined Positive Int -&gt; Int
forall {k} (p :: k) x. Refined p x -&gt; x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#unrefine"><span class="hs-identifier hs-var">unrefine</span></a></span><span> </span><span class="annot"><span class="annottext">Refined Positive Int
</span><a href="#local-6989586621687717418"><span class="hs-identifier hs-var">maxThreads</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687717424"><span class="annot"><span class="annottext">_eeCtxFetchInterval :: DiffTime
</span><a href="#local-6989586621687717424"><span class="hs-identifier hs-var hs-var">_eeCtxFetchInterval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Milliseconds -&gt; DiffTime
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Data.Time.Clock.Units.html#milliseconds"><span class="hs-identifier hs-var">milliseconds</span></a></span><span> </span><span class="annot"><span class="annottext">(Milliseconds -&gt; DiffTime) -&gt; Milliseconds -&gt; DiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Milliseconds -&gt; Milliseconds
forall {k} (p :: k) x. Refined p x -&gt; x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#unrefine"><span class="hs-identifier hs-var">unrefine</span></a></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Milliseconds
</span><a href="#local-6989586621687717419"><span class="hs-identifier hs-var">fetchInterval</span></a></span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><span class="annottext">EventEngineCtx -&gt; m EventEngineCtx
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">TVar Int
DiffTime
Refined NonNegative Int
_eeCtxEventThreadsCapacity :: TVar Int
_eeCtxFetchInterval :: DiffTime
_eeCtxFetchSize :: Refined NonNegative Int
_eeCtxFetchSize :: Refined NonNegative Int
_eeCtxEventThreadsCapacity :: TVar Int
_eeCtxFetchInterval :: DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxEventThreadsCapacity"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span id="local-6989586621687716392"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier hs-type">saveLockedEventTriggerEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716392"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687716392"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-191"></span><span id="saveLockedEventTriggerEvents"><span class="annot"><span class="annottext">saveLockedEventTriggerEvents :: forall (m :: * -&gt; *).
MonadIO m =&gt;
SourceName
-&gt; [EventId] -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier hs-var hs-var">saveLockedEventTriggerEvents</span></a></span></span><span> </span><span id="local-6989586621687717441"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687717441"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621687717442"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621687717442"><span class="hs-identifier hs-var">eventIds</span></a></span></span><span> </span><span id="local-6989586621687717443"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621687717443"><span class="hs-identifier hs-var">lockedEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-192"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>      </span><span id="local-6989586621687717445"><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621687717445"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
-&gt; STM (HashMap SourceName (Set EventId))
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621687717443"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span>
</span><span id="line-196"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; HashMap SourceName (Set EventId) -&gt; Maybe (Set EventId)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687717441"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621687717445"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-197"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Set EventId)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621687717443"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName (Set EventId) -&gt; STM ())
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Set EventId -&gt; HashMap SourceName (Set EventId)
forall k v. Hashable k =&gt; k -&gt; v -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.Strict.html#singleton"><span class="hs-identifier hs-var">HashMap.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687717441"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EventId] -&gt; Set EventId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621687717442"><span class="hs-identifier hs-var">eventIds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Set EventId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621687717443"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName (Set EventId) -&gt; STM ())
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">(Set EventId -&gt; Set EventId -&gt; Set EventId)
-&gt; SourceName
-&gt; Set EventId
-&gt; HashMap SourceName (Set EventId)
-&gt; HashMap SourceName (Set EventId)
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.Strict.html#insertWith"><span class="hs-identifier hs-var">HashMap.insertWith</span></a></span><span> </span><span class="annot"><span class="annottext">Set EventId -&gt; Set EventId -&gt; Set EventId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.union</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687717441"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EventId] -&gt; Set EventId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621687717442"><span class="hs-identifier hs-var">eventIds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621687717445"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span id="local-6989586621687716410"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier hs-type">removeEventTriggerEventFromLockedEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716410"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687716410"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-202"></span><span id="removeEventTriggerEventFromLockedEvents"><span class="annot"><span class="annottext">removeEventTriggerEventFromLockedEvents :: forall (m :: * -&gt; *).
MonadIO m =&gt;
SourceName
-&gt; EventId -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier hs-var hs-var">removeEventTriggerEventFromLockedEvents</span></a></span></span><span> </span><span id="local-6989586621687717460"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687717460"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621687717461"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687717461"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span id="local-6989586621687717462"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621687717462"><span class="hs-identifier hs-var">lockedEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-203"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span>      </span><span id="local-6989586621687717463"><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621687717463"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
-&gt; STM (HashMap SourceName (Set EventId))
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621687717462"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span>
</span><span id="line-207"></span><span>      </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621687717462"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName (Set EventId) -&gt; STM ())
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">(Set EventId -&gt; Set EventId)
-&gt; SourceName
-&gt; HashMap SourceName (Set EventId)
-&gt; HashMap SourceName (Set EventId)
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v) -&gt; k -&gt; HashMap k v -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.Strict.html#adjust"><span class="hs-identifier hs-var">HashMap.adjust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventId -&gt; Set EventId -&gt; Set EventId
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.delete</span></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687717461"><span class="hs-identifier hs-var">eventId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687717460"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621687717463"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span class="hs-keyword">type</span><span> </span><span id="BackendEventWithSource"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#BackendEventWithSource"><span class="hs-identifier hs-var">BackendEventWithSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html#AnyBackend"><span class="hs-identifier hs-type">AB.AnyBackend</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="hs-keyword">type</span><span> </span><span id="FetchEventArguments"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchEventArguments"><span class="hs-identifier hs-var">FetchEventArguments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#BackendEventWithSource"><span class="hs-identifier hs-type">BackendEventWithSource</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-keyword">newtype</span><span> </span><span id="EventsCount"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventsCount"><span class="hs-identifier hs-var">EventsCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EventsCount"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventsCount"><span class="hs-identifier hs-var">EventsCount</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unEventsCount"><span class="annot"><span class="annottext">EventsCount -&gt; Int
</span><a href="Hasura.Eventing.EventTrigger.html#unEventsCount"><span class="hs-identifier hs-var hs-var">unEventsCount</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">}</span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687717470"><span id="local-6989586621687717474"><span class="annot"><span class="annottext">EventsCount -&gt; EventsCount -&gt; Bool
(EventsCount -&gt; EventsCount -&gt; Bool)
-&gt; (EventsCount -&gt; EventsCount -&gt; Bool) -&gt; Eq EventsCount
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: EventsCount -&gt; EventsCount -&gt; Bool
== :: EventsCount -&gt; EventsCount -&gt; Bool
$c/= :: EventsCount -&gt; EventsCount -&gt; Bool
/= :: EventsCount -&gt; EventsCount -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687717479"><span id="local-6989586621687717483"><span id="local-6989586621687717487"><span class="annot"><span class="annottext">Int -&gt; EventsCount -&gt; ShowS
[EventsCount] -&gt; ShowS
EventsCount -&gt; String
(Int -&gt; EventsCount -&gt; ShowS)
-&gt; (EventsCount -&gt; String)
-&gt; ([EventsCount] -&gt; ShowS)
-&gt; Show EventsCount
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; EventsCount -&gt; ShowS
showsPrec :: Int -&gt; EventsCount -&gt; ShowS
$cshow :: EventsCount -&gt; String
show :: EventsCount -&gt; String
$cshowList :: [EventsCount] -&gt; ShowS
showList :: [EventsCount] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687717490"><span id="local-6989586621687717494"><span id="local-6989586621687717498"><span id="local-6989586621687717502"><span class="annot"><span class="annottext">[EventsCount] -&gt; Value
[EventsCount] -&gt; Encoding
EventsCount -&gt; Value
EventsCount -&gt; Encoding
(EventsCount -&gt; Value)
-&gt; (EventsCount -&gt; Encoding)
-&gt; ([EventsCount] -&gt; Value)
-&gt; ([EventsCount] -&gt; Encoding)
-&gt; ToJSON EventsCount
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
$ctoJSON :: EventsCount -&gt; Value
toJSON :: EventsCount -&gt; Value
$ctoEncoding :: EventsCount -&gt; Encoding
toEncoding :: EventsCount -&gt; Encoding
$ctoJSONList :: [EventsCount] -&gt; Value
toJSONList :: [EventsCount] -&gt; Value
$ctoEncodingList :: [EventsCount] -&gt; Encoding
toEncodingList :: [EventsCount] -&gt; Encoding
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">J.ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687717507"><span id="local-6989586621687717512"><span class="annot"><span class="annottext">Value -&gt; Parser [EventsCount]
Value -&gt; Parser EventsCount
(Value -&gt; Parser EventsCount)
-&gt; (Value -&gt; Parser [EventsCount]) -&gt; FromJSON EventsCount
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
$cparseJSON :: Value -&gt; Parser EventsCount
parseJSON :: Value -&gt; Parser EventsCount
$cparseJSONList :: Value -&gt; Parser [EventsCount]
parseJSONList :: Value -&gt; Parser [EventsCount]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.FromJSON.html#FromJSON"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">J.FromJSON</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687717518"><span id="local-6989586621687717522"><span id="local-6989586621687717526"><span id="local-6989586621687717530"><span id="local-6989586621687717534"><span id="local-6989586621687717538"><span id="local-6989586621687717542"><span class="annot"><span class="annottext">Integer -&gt; EventsCount
EventsCount -&gt; EventsCount
EventsCount -&gt; EventsCount -&gt; EventsCount
(EventsCount -&gt; EventsCount -&gt; EventsCount)
-&gt; (EventsCount -&gt; EventsCount -&gt; EventsCount)
-&gt; (EventsCount -&gt; EventsCount -&gt; EventsCount)
-&gt; (EventsCount -&gt; EventsCount)
-&gt; (EventsCount -&gt; EventsCount)
-&gt; (EventsCount -&gt; EventsCount)
-&gt; (Integer -&gt; EventsCount)
-&gt; Num EventsCount
forall a.
(a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (Integer -&gt; a)
-&gt; Num a
$c+ :: EventsCount -&gt; EventsCount -&gt; EventsCount
+ :: EventsCount -&gt; EventsCount -&gt; EventsCount
$c- :: EventsCount -&gt; EventsCount -&gt; EventsCount
- :: EventsCount -&gt; EventsCount -&gt; EventsCount
$c* :: EventsCount -&gt; EventsCount -&gt; EventsCount
* :: EventsCount -&gt; EventsCount -&gt; EventsCount
$cnegate :: EventsCount -&gt; EventsCount
negate :: EventsCount -&gt; EventsCount
$cabs :: EventsCount -&gt; EventsCount
abs :: EventsCount -&gt; EventsCount
$csignum :: EventsCount -&gt; EventsCount
signum :: EventsCount -&gt; EventsCount
$cfromInteger :: Integer -&gt; EventsCount
fromInteger :: Integer -&gt; EventsCount
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Num</span></span></span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="hs-keyword">newtype</span><span> </span><span id="NumEventsFetchedPerSource"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-var">NumEventsFetchedPerSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NumEventsFetchedPerSource"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-var">NumEventsFetchedPerSource</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unNumEventsFetchedPerSource"><span class="annot"><span class="annottext">NumEventsFetchedPerSource -&gt; HashMap SourceName EventsCount
</span><a href="Hasura.Eventing.EventTrigger.html#unNumEventsFetchedPerSource"><span class="hs-identifier hs-var hs-var">unNumEventsFetchedPerSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventsCount"><span class="hs-identifier hs-type">EventsCount</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687717550"><span id="local-6989586621687717557"><span class="annot"><span class="annottext">NumEventsFetchedPerSource -&gt; NumEventsFetchedPerSource -&gt; Bool
(NumEventsFetchedPerSource -&gt; NumEventsFetchedPerSource -&gt; Bool)
-&gt; (NumEventsFetchedPerSource -&gt; NumEventsFetchedPerSource -&gt; Bool)
-&gt; Eq NumEventsFetchedPerSource
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: NumEventsFetchedPerSource -&gt; NumEventsFetchedPerSource -&gt; Bool
== :: NumEventsFetchedPerSource -&gt; NumEventsFetchedPerSource -&gt; Bool
$c/= :: NumEventsFetchedPerSource -&gt; NumEventsFetchedPerSource -&gt; Bool
/= :: NumEventsFetchedPerSource -&gt; NumEventsFetchedPerSource -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687717564"><span id="local-6989586621687717571"><span id="local-6989586621687717575"><span class="annot"><span class="annottext">Int -&gt; NumEventsFetchedPerSource -&gt; ShowS
[NumEventsFetchedPerSource] -&gt; ShowS
NumEventsFetchedPerSource -&gt; String
(Int -&gt; NumEventsFetchedPerSource -&gt; ShowS)
-&gt; (NumEventsFetchedPerSource -&gt; String)
-&gt; ([NumEventsFetchedPerSource] -&gt; ShowS)
-&gt; Show NumEventsFetchedPerSource
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; NumEventsFetchedPerSource -&gt; ShowS
showsPrec :: Int -&gt; NumEventsFetchedPerSource -&gt; ShowS
$cshow :: NumEventsFetchedPerSource -&gt; String
show :: NumEventsFetchedPerSource -&gt; String
$cshowList :: [NumEventsFetchedPerSource] -&gt; ShowS
showList :: [NumEventsFetchedPerSource] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621687717580"><span id="local-6989586621687717584"><span id="local-6989586621687717587"><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier hs-type">J.ToJSON</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-type">NumEventsFetchedPerSource</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-220"></span><span>  </span><span id="local-6989586621687717592"><span class="annot"><span class="annottext">toJSON :: NumEventsFetchedPerSource -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-type">NumEventsFetchedPerSource</span></a></span><span> </span><span id="local-6989586621687717593"><span class="annot"><span class="annottext">HashMap SourceName EventsCount
</span><a href="#local-6989586621687717593"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-221"></span><span>    </span><span class="annot"><span class="annottext">Object -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#Object"><span class="hs-identifier hs-var">J.Object</span></a></span><span> </span><span class="annot"><span class="annottext">(Object -&gt; Value) -&gt; Object -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Object
forall v. [(Key, v)] -&gt; KeyMap v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.KeyMap.html#fromList"><span class="hs-identifier hs-var">KeyMap.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Pair] -&gt; Object) -&gt; [Pair] -&gt; Object
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((SourceName, EventsCount) -&gt; Pair)
-&gt; [(SourceName, EventsCount)] -&gt; [Pair]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Key
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Key.html#fromText"><span class="hs-identifier hs-var">Key.fromText</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Key) -&gt; (SourceName -&gt; Text) -&gt; SourceName -&gt; Key
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Text
</span><a href="Hasura.RQL.Types.Common.html#sourceNameToText"><span class="hs-identifier hs-var">sourceNameToText</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SourceName -&gt; Key)
-&gt; (EventsCount -&gt; Value) -&gt; (SourceName, EventsCount) -&gt; Pair
forall b c b' c'. (b -&gt; c) -&gt; (b' -&gt; c') -&gt; (b, b') -&gt; (c, c')
forall (a :: * -&gt; * -&gt; *) b c b' c'.
Arrow a =&gt;
a b c -&gt; a b' c' -&gt; a (b, b') (c, c')
</span><span class="hs-operator hs-var">***</span></span><span> </span><span class="annot"><span class="annottext">EventsCount -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">J.toJSON</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SourceName, EventsCount)] -&gt; [Pair])
-&gt; [(SourceName, EventsCount)] -&gt; [Pair]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName EventsCount -&gt; [(SourceName, EventsCount)]
forall k v. HashMap k v -&gt; [(k, v)]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#toList"><span class="hs-identifier hs-var">HashMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName EventsCount
</span><a href="#local-6989586621687717593"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621687717603"><span id="local-6989586621687717607"><span class="annot"><span class="hs-identifier hs-type">Semigroup</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-type">NumEventsFetchedPerSource</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-type">NumEventsFetchedPerSource</span></a></span><span> </span><span id="local-6989586621687717615"><span class="annot"><span class="annottext">HashMap SourceName EventsCount
</span><a href="#local-6989586621687717615"><span class="hs-identifier hs-var">lMap</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621687717616"><span class="annot"><span class="annottext">&lt;&gt; :: NumEventsFetchedPerSource
-&gt; NumEventsFetchedPerSource -&gt; NumEventsFetchedPerSource
</span><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-type">NumEventsFetchedPerSource</span></a></span><span> </span><span id="local-6989586621687717617"><span class="annot"><span class="annottext">HashMap SourceName EventsCount
</span><a href="#local-6989586621687717617"><span class="hs-identifier hs-var">rMap</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><span class="annottext">HashMap SourceName EventsCount -&gt; NumEventsFetchedPerSource
</span><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-var">NumEventsFetchedPerSource</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName EventsCount -&gt; NumEventsFetchedPerSource)
-&gt; HashMap SourceName EventsCount -&gt; NumEventsFetchedPerSource
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EventsCount -&gt; EventsCount -&gt; EventsCount)
-&gt; HashMap SourceName EventsCount
-&gt; HashMap SourceName EventsCount
-&gt; HashMap SourceName EventsCount
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; HashMap k v -&gt; HashMap k v -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.Strict.html#unionWith"><span class="hs-identifier hs-var">HashMap.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">EventsCount -&gt; EventsCount -&gt; EventsCount
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(+)</span></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName EventsCount
</span><a href="#local-6989586621687717615"><span class="hs-identifier hs-var">lMap</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName EventsCount
</span><a href="#local-6989586621687717617"><span class="hs-identifier hs-var">rMap</span></a></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621687717624"><span id="local-6989586621687717628"><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-type">NumEventsFetchedPerSource</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-228"></span><span>  </span><span id="local-6989586621687717635"><span class="annot"><span class="annottext">mempty :: NumEventsFetchedPerSource
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">mempty</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap SourceName EventsCount -&gt; NumEventsFetchedPerSource
</span><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-var">NumEventsFetchedPerSource</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName EventsCount
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="hs-keyword">data</span><span> </span><span id="FetchedEventsStats"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-var">FetchedEventsStats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FetchedEventsStats"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-var">FetchedEventsStats</span></a></span></span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_fesNumEventsFetched"><span class="annot"><span class="annottext">FetchedEventsStats -&gt; NumEventsFetchedPerSource
</span><a href="Hasura.Eventing.EventTrigger.html#_fesNumEventsFetched"><span class="hs-identifier hs-var hs-var">_fesNumEventsFetched</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-type">NumEventsFetchedPerSource</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-232"></span><span>    </span><span id="_fesNumFetches"><span class="annot"><span class="annottext">FetchedEventsStats -&gt; Int
</span><a href="Hasura.Eventing.EventTrigger.html#_fesNumFetches"><span class="hs-identifier hs-var hs-var">_fesNumFetches</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687717640"><span id="local-6989586621687717644"><span class="annot"><span class="annottext">FetchedEventsStats -&gt; FetchedEventsStats -&gt; Bool
(FetchedEventsStats -&gt; FetchedEventsStats -&gt; Bool)
-&gt; (FetchedEventsStats -&gt; FetchedEventsStats -&gt; Bool)
-&gt; Eq FetchedEventsStats
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: FetchedEventsStats -&gt; FetchedEventsStats -&gt; Bool
== :: FetchedEventsStats -&gt; FetchedEventsStats -&gt; Bool
$c/= :: FetchedEventsStats -&gt; FetchedEventsStats -&gt; Bool
/= :: FetchedEventsStats -&gt; FetchedEventsStats -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687717648"><span id="local-6989586621687717650"><span class="annot"><span class="annottext">(forall x. FetchedEventsStats -&gt; Rep FetchedEventsStats x)
-&gt; (forall x. Rep FetchedEventsStats x -&gt; FetchedEventsStats)
-&gt; Generic FetchedEventsStats
forall x. Rep FetchedEventsStats x -&gt; FetchedEventsStats
forall x. FetchedEventsStats -&gt; Rep FetchedEventsStats x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. FetchedEventsStats -&gt; Rep FetchedEventsStats x
from :: forall x. FetchedEventsStats -&gt; Rep FetchedEventsStats x
$cto :: forall x. Rep FetchedEventsStats x -&gt; FetchedEventsStats
to :: forall x. Rep FetchedEventsStats x -&gt; FetchedEventsStats
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687717653"><span id="local-6989586621687717658"><span id="local-6989586621687717662"><span class="annot"><span class="annottext">Int -&gt; FetchedEventsStats -&gt; ShowS
[FetchedEventsStats] -&gt; ShowS
FetchedEventsStats -&gt; String
(Int -&gt; FetchedEventsStats -&gt; ShowS)
-&gt; (FetchedEventsStats -&gt; String)
-&gt; ([FetchedEventsStats] -&gt; ShowS)
-&gt; Show FetchedEventsStats
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; FetchedEventsStats -&gt; ShowS
showsPrec :: Int -&gt; FetchedEventsStats -&gt; ShowS
$cshow :: FetchedEventsStats -&gt; String
show :: FetchedEventsStats -&gt; String
$cshowList :: [FetchedEventsStats] -&gt; ShowS
showList :: [FetchedEventsStats] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621687717667"><span id="local-6989586621687717671"><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier hs-type">J.ToJSON</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-type">FetchedEventsStats</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-237"></span><span>  </span><span id="local-6989586621687717735"><span class="annot"><span class="annottext">toJSON :: FetchedEventsStats -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; FetchedEventsStats -&gt; Value
forall a.
(Generic a, GToJSON' Value Zero (Rep a)) =&gt;
Options -&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#genericToJSON"><span class="hs-identifier hs-var">J.genericToJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#hasuraJSON"><span class="hs-identifier hs-var">hasuraJSON</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span id="local-6989586621687717797"><span class="annot"><span class="annottext">toEncoding :: FetchedEventsStats -&gt; Encoding
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toEncoding"><span class="hs-identifier hs-var hs-var hs-var hs-var">toEncoding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; FetchedEventsStats -&gt; Encoding
forall a.
(Generic a, GToJSON' Encoding Zero (Rep a)) =&gt;
Options -&gt; a -&gt; Encoding
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#genericToEncoding"><span class="hs-identifier hs-var">J.genericToEncoding</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#hasuraJSON"><span class="hs-identifier hs-var">hasuraJSON</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Logging.html#ToEngineLog"><span class="hs-identifier hs-type">L.ToEngineLog</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-type">FetchedEventsStats</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-241"></span><span>  </span><span id="local-6989586621687717803"><span class="annot"><span class="annottext">toEngineLog :: FetchedEventsStats -&gt; (LogLevel, EngineLogType Hasura, Value)
</span><a href="Hasura.Logging.html#toEngineLog"><span class="hs-identifier hs-var hs-var hs-var hs-var">toEngineLog</span></a></span></span><span> </span><span id="local-6989586621687717804"><span class="annot"><span class="annottext">FetchedEventsStats
</span><a href="#local-6989586621687717804"><span class="hs-identifier hs-var">stats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">L.LevelInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EngineLogType Hasura
</span><a href="Hasura.Logging.html#eventTriggerProcessLogType"><span class="hs-identifier hs-var">L.eventTriggerProcessLogType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FetchedEventsStats -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">J.toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">FetchedEventsStats
</span><a href="#local-6989586621687717804"><span class="hs-identifier hs-var">stats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621687717809"><span id="local-6989586621687717813"><span class="annot"><span class="hs-identifier hs-type">Semigroup</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-type">FetchedEventsStats</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-type">FetchedEventsStats</span></a></span><span> </span><span id="local-6989586621687717819"><span class="annot"><span class="annottext">NumEventsFetchedPerSource
</span><a href="#local-6989586621687717819"><span class="hs-identifier hs-var">lMap</span></a></span></span><span> </span><span id="local-6989586621687717820"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687717820"><span class="hs-identifier hs-var">lFetches</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621687717821"><span class="annot"><span class="annottext">&lt;&gt; :: FetchedEventsStats -&gt; FetchedEventsStats -&gt; FetchedEventsStats
</span><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-type">FetchedEventsStats</span></a></span><span> </span><span id="local-6989586621687717822"><span class="annot"><span class="annottext">NumEventsFetchedPerSource
</span><a href="#local-6989586621687717822"><span class="hs-identifier hs-var">rMap</span></a></span></span><span> </span><span id="local-6989586621687717823"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687717823"><span class="hs-identifier hs-var">rFetches</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><span class="annottext">NumEventsFetchedPerSource -&gt; Int -&gt; FetchedEventsStats
</span><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-var">FetchedEventsStats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NumEventsFetchedPerSource
</span><a href="#local-6989586621687717819"><span class="hs-identifier hs-var">lMap</span></a></span><span> </span><span class="annot"><span class="annottext">NumEventsFetchedPerSource
-&gt; NumEventsFetchedPerSource -&gt; NumEventsFetchedPerSource
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">NumEventsFetchedPerSource
</span><a href="#local-6989586621687717822"><span class="hs-identifier hs-var">rMap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687717820"><span class="hs-identifier hs-var">lFetches</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687717823"><span class="hs-identifier hs-var">rFetches</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621687717828"><span id="local-6989586621687717832"><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-type">FetchedEventsStats</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-249"></span><span>  </span><span id="local-6989586621687717835"><span class="annot"><span class="annottext">mempty :: FetchedEventsStats
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">mempty</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NumEventsFetchedPerSource -&gt; Int -&gt; FetchedEventsStats
</span><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-var">FetchedEventsStats</span></a></span><span> </span><span class="annot"><span class="annottext">NumEventsFetchedPerSource
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-keyword">type</span><span> </span><span id="FetchedEventsStatsLogger"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStatsLogger"><span class="hs-identifier hs-var">FetchedEventsStatsLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/fold-debounce-0.2.0.11-622279410c8c77ef4e9411a4aa9d0e5522a31abe0d691c392836ec8bbde58a43/share/doc/html/src/Control.FoldDebounce.html#Trigger"><span class="hs-identifier hs-type">FDebounce.Trigger</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-type">FetchedEventsStats</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-type">FetchedEventsStats</span></a></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-comment">-- | Logger to accumulate stats of fetched events over a period of time and log once using @'L.Logger L.Hasura'.</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- See @'createStatsLogger' for more details.</span><span>
</span><span id="line-255"></span><span id="local-6989586621687716452"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#createFetchedEventsStatsLogger"><span class="hs-identifier hs-type">createFetchedEventsStatsLogger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716452"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687716452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStatsLogger"><span class="hs-identifier hs-type">FetchedEventsStatsLogger</span></a></span></span><span>
</span><span id="line-256"></span><span id="createFetchedEventsStatsLogger"><span class="annot"><span class="annottext">createFetchedEventsStatsLogger :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; m FetchedEventsStatsLogger
</span><a href="Hasura.Eventing.EventTrigger.html#createFetchedEventsStatsLogger"><span class="hs-identifier hs-var hs-var">createFetchedEventsStatsLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; m FetchedEventsStatsLogger
forall (m :: * -&gt; *) stats impl.
(MonadIO m, ToEngineLog stats impl, Monoid stats) =&gt;
Logger impl -&gt; m (Trigger stats stats)
</span><a href="Hasura.Logging.html#createStatsLogger"><span class="hs-identifier hs-var">L.createStatsLogger</span></a></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="annot"><span class="hs-comment">-- | Close the fetched events stats logger.</span></span><span>
</span><span id="line-259"></span><span id="local-6989586621687716460"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#closeFetchedEventsStatsLogger"><span class="hs-identifier hs-type">closeFetchedEventsStatsLogger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716460"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStatsLogger"><span class="hs-identifier hs-type">FetchedEventsStatsLogger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687716460"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-260"></span><span id="closeFetchedEventsStatsLogger"><span class="annot"><span class="annottext">closeFetchedEventsStatsLogger :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; FetchedEventsStatsLogger -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#closeFetchedEventsStatsLogger"><span class="hs-identifier hs-var hs-var">closeFetchedEventsStatsLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EngineLogType Hasura
-&gt; Logger Hasura -&gt; FetchedEventsStatsLogger -&gt; m ()
forall (m :: * -&gt; *) impl stats.
(MonadIO m, EnabledLogTypes impl) =&gt;
EngineLogType impl -&gt; Logger impl -&gt; Trigger stats stats -&gt; m ()
</span><a href="Hasura.Logging.html#closeStatsLogger"><span class="hs-identifier hs-var">L.closeStatsLogger</span></a></span><span> </span><span class="annot"><span class="annottext">EngineLogType Hasura
</span><a href="Hasura.Logging.html#eventTriggerProcessLogType"><span class="hs-identifier hs-var">L.eventTriggerProcessLogType</span></a></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span class="annot"><span class="hs-comment">-- | Log statistics of fetched events. See @'logStats' for more details.</span></span><span>
</span><span id="line-263"></span><span id="local-6989586621687716465"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#logFetchedEventsStatistics"><span class="hs-identifier hs-type">logFetchedEventsStatistics</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716465"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-265"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStatsLogger"><span class="hs-identifier hs-type">FetchedEventsStatsLogger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#BackendEventWithSource"><span class="hs-identifier hs-type">BackendEventWithSource</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><a href="#local-6989586621687716465"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-268"></span><span id="logFetchedEventsStatistics"><span class="annot"><span class="annottext">logFetchedEventsStatistics :: forall (m :: * -&gt; *).
MonadIO m =&gt;
FetchedEventsStatsLogger -&gt; [BackendEventWithSource] -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logFetchedEventsStatistics"><span class="hs-identifier hs-var hs-var">logFetchedEventsStatistics</span></a></span></span><span> </span><span id="local-6989586621687717894"><span class="annot"><span class="annottext">FetchedEventsStatsLogger
</span><a href="#local-6989586621687717894"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621687717895"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687717895"><span class="hs-identifier hs-var">backendEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><span class="annottext">FetchedEventsStatsLogger -&gt; FetchedEventsStats -&gt; m ()
forall (m :: * -&gt; *) stats.
MonadIO m =&gt;
Trigger stats stats -&gt; stats -&gt; m ()
</span><a href="Hasura.Logging.html#logStats"><span class="hs-identifier hs-var">L.logStats</span></a></span><span> </span><span class="annot"><span class="annottext">FetchedEventsStatsLogger
</span><a href="#local-6989586621687717894"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NumEventsFetchedPerSource -&gt; Int -&gt; FetchedEventsStats
</span><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStats"><span class="hs-identifier hs-var">FetchedEventsStats</span></a></span><span> </span><span class="annot"><span class="annottext">NumEventsFetchedPerSource
</span><a href="#local-6989586621687717897"><span class="hs-identifier hs-var">numEventsFetchedPerSource</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-271"></span><span>    </span><span id="local-6989586621687717897"><span class="annot"><span class="annottext">numEventsFetchedPerSource :: NumEventsFetchedPerSource
</span><a href="#local-6989586621687717897"><span class="hs-identifier hs-var hs-var">numEventsFetchedPerSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-272"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687717898"><span class="annot"><span class="annottext">sourceNames :: [SourceName]
</span><a href="#local-6989586621687717898"><span class="hs-identifier hs-var hs-var">sourceNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((BackendEventWithSource -&gt; SourceName)
 -&gt; [BackendEventWithSource] -&gt; [SourceName])
-&gt; [BackendEventWithSource]
-&gt; (BackendEventWithSource -&gt; SourceName)
-&gt; [SourceName]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">(BackendEventWithSource -&gt; SourceName)
-&gt; [BackendEventWithSource] -&gt; [SourceName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687717895"><span class="hs-identifier hs-var">backendEvents</span></a></span><span>
</span><span id="line-273"></span><span>            </span><span class="annot"><span class="annottext">((BackendEventWithSource -&gt; SourceName) -&gt; [SourceName])
-&gt; (BackendEventWithSource -&gt; SourceName) -&gt; [SourceName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687717900"><span class="annot"><span class="annottext">BackendEventWithSource
</span><a href="#local-6989586621687717900"><span class="hs-identifier hs-var">backendEvent</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><span class="annottext">BackendEventWithSource
</span><a href="#local-6989586621687717900"><span class="hs-identifier hs-var">backendEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventWithSource b -&gt; SourceName
forall (b :: BackendType).
Backend b =&gt;
EventWithSource b -&gt; SourceName
forall (b :: BackendType). EventWithSource b -&gt; SourceName
</span><a href="Hasura.RQL.Types.EventTrigger.html#_ewsSourceName"><span class="hs-identifier hs-var">_ewsSourceName</span></a></span><span>
</span><span id="line-274"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">HashMap SourceName EventsCount -&gt; NumEventsFetchedPerSource
</span><a href="Hasura.Eventing.EventTrigger.html#NumEventsFetchedPerSource"><span class="hs-identifier hs-var">NumEventsFetchedPerSource</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName EventsCount -&gt; NumEventsFetchedPerSource)
-&gt; HashMap SourceName EventsCount -&gt; NumEventsFetchedPerSource
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EventsCount -&gt; EventsCount -&gt; EventsCount)
-&gt; [(SourceName, EventsCount)] -&gt; HashMap SourceName EventsCount
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; [(k, v)] -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.Strict.html#fromListWith"><span class="hs-identifier hs-var">HashMap.fromListWith</span></a></span><span> </span><span class="annot"><span class="annottext">EventsCount -&gt; EventsCount -&gt; EventsCount
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(+)</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687717905"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EventsCount
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621687717905"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687717905"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SourceName]
</span><a href="#local-6989586621687717898"><span class="hs-identifier hs-var">sourceNames</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="hs-pragma">{-# ANN</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-pragma hs-type">processEventQueue</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><span class="hs-pragma">&quot;HLint: ignore Use withAsync&quot;</span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="annot"><span class="hs-pragma hs-type">String</span></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="hs-comment">-- | `upperBoundEventTriggerTimeout` is the maximum amount of time</span><span>
</span><span id="line-279"></span><span class="hs-comment">--    an event trigger can take to process. This function is intended</span><span>
</span><span id="line-280"></span><span class="hs-comment">--    to use with a timeout.</span><span>
</span><span id="line-281"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#upperBoundEventTriggerTimeout"><span class="hs-identifier hs-type">upperBoundEventTriggerTimeout</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DiffTime</span></span><span>
</span><span id="line-282"></span><span id="upperBoundEventTriggerTimeout"><span class="annot"><span class="annottext">upperBoundEventTriggerTimeout :: DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#upperBoundEventTriggerTimeout"><span class="hs-identifier hs-var hs-var">upperBoundEventTriggerTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Minutes -&gt; DiffTime
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Data.Time.Clock.Units.html#minutes"><span class="hs-identifier hs-var">minutes</span></a></span><span> </span><span class="annot"><span class="annottext">Minutes
</span><span class="hs-number">30</span></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="hs-comment">-- | Service events from our in-DB queue.</span><span>
</span><span id="line-285"></span><span class="hs-comment">--</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- There are a few competing concerns and constraints here; we want to...</span><span>
</span><span id="line-287"></span><span class="hs-comment">--   - fetch events in batches for lower DB pressure</span><span>
</span><span id="line-288"></span><span class="hs-comment">--   - don't fetch more than N at a time (since that can mean: space leak, less</span><span>
</span><span id="line-289"></span><span class="hs-comment">--     effective scale out, possible double sends for events we've checked out</span><span>
</span><span id="line-290"></span><span class="hs-comment">--     on exit (TODO clean shutdown procedure))</span><span>
</span><span id="line-291"></span><span class="hs-comment">--   - try not to cause webhook workers to stall waiting on DB fetch</span><span>
</span><span id="line-292"></span><span class="hs-comment">--   - limit webhook HTTP concurrency per HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE</span><span>
</span><span id="line-293"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier hs-type">processEventQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687716497"><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-296"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/monad-control-1.0.3.1-db4229aec3d9c1011503cf06798714c732b74d731fab23998dd34d578ed6d457/share/doc/html/src/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/constraints-0.13.4-50ce339e2ef398cdf6965bdd48656adf620ab887368a22e14fa1c6033bdc6766/share/doc/html/src/Data.Constraint.Forall.html#Forall"><span class="hs-identifier hs-type">LA.Forall</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lifted-async-0.10.2.3-d63f7c0774c9603306fb6be4536181f7e6facdd649f3f450b4e7dfd3d91cda94/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html#Pure"><span class="hs-identifier hs-type">LA.Pure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-298"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-299"></span><span>    </span><span class="annot"><a href="Hasura.Tracing.Class.html#MonadTrace"><span class="hs-identifier hs-type">Tracing.MonadTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><a href="Hasura.Server.Types.html#MonadGetPolicies"><span class="hs-identifier hs-type">MonadGetPolicies</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-302"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-303"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchedEventsStatsLogger"><span class="hs-identifier hs-type">FetchedEventsStatsLogger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-304"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/http-client-0.7.13.1-88628f48a025e46598ca658ea231eb27d6340417f49e950fbf8c438edb3ebbdc/share/doc/html/src/Network.HTTP.Client.Types.html#Manager"><span class="hs-identifier hs-type">HTTP.Manager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#SchemaCache"><span class="hs-identifier hs-type">SchemaCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#EventTriggerMetrics"><span class="hs-identifier hs-type">EventTriggerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#TriggersErrorLogLevelStatus"><span class="hs-identifier hs-type">TriggersErrorLogLevelStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-313"></span><span>  </span><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier hs-type">Forever</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span id="processEventQueue"><span class="annot"><span class="annottext">processEventQueue :: forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m, Forall (Pure m), MonadMask m,
 MonadTrace m, MonadGetPolicies m) =&gt;
Logger Hasura
-&gt; FetchedEventsStatsLogger
-&gt; Manager
-&gt; IO SchemaCache
-&gt; IO EventEngineCtx
-&gt; TVar Int
-&gt; LockedEventsCtx
-&gt; ServerMetrics
-&gt; EventTriggerMetrics
-&gt; MaintenanceMode ()
-&gt; TriggersErrorLogLevelStatus
-&gt; m (Forever m)
</span><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier hs-var hs-var">processEventQueue</span></a></span></span><span> </span><span id="local-6989586621687718018"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687718018"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621687718019"><span class="annot"><span class="annottext">FetchedEventsStatsLogger
</span><a href="#local-6989586621687718019"><span class="hs-identifier hs-var">statsLogger</span></a></span></span><span> </span><span id="local-6989586621687718020"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621687718020"><span class="hs-identifier hs-var">httpMgr</span></a></span></span><span> </span><span id="local-6989586621687718021"><span class="annot"><span class="annottext">IO SchemaCache
</span><a href="#local-6989586621687718021"><span class="hs-identifier hs-var">getSchemaCache</span></a></span></span><span> </span><span id="local-6989586621687718022"><span class="annot"><span class="annottext">IO EventEngineCtx
</span><a href="#local-6989586621687718022"><span class="hs-identifier hs-var">getEventEngineCtx</span></a></span></span><span> </span><span id="local-6989586621687718023"><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621687718023"><span class="hs-identifier hs-var">activeEventProcessingThreads</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687718025"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
leEvents :: TVar (HashMap SourceName (Set EventId))
leEvents :: LockedEventsCtx -&gt; TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621687718025"><span class="hs-identifier hs-var hs-var">leEvents</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621687718027"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621687718027"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span> </span><span id="local-6989586621687718028"><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span></span><span> </span><span id="local-6989586621687718029"><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621687718029"><span class="hs-identifier hs-var">maintenanceMode</span></a></span></span><span> </span><span id="local-6989586621687718030"><span class="annot"><span class="annottext">TriggersErrorLogLevelStatus
</span><a href="#local-6989586621687718030"><span class="hs-identifier hs-var">triggersErrorLogLevelStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-315"></span><span>  </span><span id="local-6989586621687718031"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718031"><span class="hs-identifier hs-var">events0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [BackendEventWithSource]
</span><a href="#local-6989586621687718032"><span class="hs-identifier hs-var">popEventsBatch</span></a></span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><span class="annottext">Forever m -&gt; m (Forever m)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Forever m -&gt; m (Forever m)) -&gt; Forever m -&gt; m (Forever m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([BackendEventWithSource], Int, Bool)
-&gt; (([BackendEventWithSource], Int, Bool)
    -&gt; m ([BackendEventWithSource], Int, Bool))
-&gt; Forever m
forall (m :: * -&gt; *) a. a -&gt; (a -&gt; m a) -&gt; Forever m
</span><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier hs-var">Forever</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718031"><span class="hs-identifier hs-var">events0</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([BackendEventWithSource], Int, Bool)
-&gt; m ([BackendEventWithSource], Int, Bool)
</span><a href="#local-6989586621687718034"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-318"></span><span>    </span><span class="annot"><a href="#local-6989586621687718032"><span class="hs-identifier hs-type">popEventsBatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#BackendEventWithSource"><span class="hs-identifier hs-type">BackendEventWithSource</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-319"></span><span>    </span><span id="local-6989586621687718032"><span class="annot"><span class="annottext">popEventsBatch :: m [BackendEventWithSource]
</span><a href="#local-6989586621687718032"><span class="hs-identifier hs-var hs-var">popEventsBatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-320"></span><span>      </span><span class="hs-comment">{-
        SELECT FOR UPDATE .. SKIP LOCKED can throw serialization errors in RepeatableRead: https://stackoverflow.com/a/53289263/1911889
        We can avoid this safely by running it in ReadCommitted as Postgres will recheck the
        predicate condition if a row is updated concurrently: https://www.postgresql.org/docs/9.5/transaction-iso.html#XACT-READ-COMMITTED

        Every other action on an event_log row (like post-processing, archival, etc) are single writes (no R-W or W-R)
        so it is safe to perform them in ReadCommitted as well (the writes will then acquire some serial order).
        Any serial order of updates to a row will lead to an eventually consistent state as the row will have
        (delivered=t or error=t or archived=t) after a fixed number of tries (assuming it begins with locked='f').
      -}</span><span>
</span><span id="line-330"></span><span>      </span><span id="local-6989586621687718035"><span class="annot"><span class="annottext">SourceCache
</span><a href="#local-6989586621687718035"><span class="hs-identifier hs-var">allSources</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; SourceCache) -&gt; m SchemaCache -&gt; m SourceCache
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO SchemaCache -&gt; m SchemaCache
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO SchemaCache
</span><a href="#local-6989586621687718021"><span class="hs-identifier hs-var">getSchemaCache</span></a></span><span>
</span><span id="line-331"></span><span>      </span><span id="local-6989586621687718038"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718038"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Int -&gt; Int
forall {k} (p :: k) x. Refined p x -&gt; x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#unrefine"><span class="hs-identifier hs-var">unrefine</span></a></span><span> </span><span class="annot"><span class="annottext">(Refined NonNegative Int -&gt; Int)
-&gt; (EventEngineCtx -&gt; Refined NonNegative Int)
-&gt; EventEngineCtx
-&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EventEngineCtx -&gt; Refined NonNegative Int
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxFetchSize"><span class="hs-identifier hs-var">_eeCtxFetchSize</span></a></span><span> </span><span class="annot"><span class="annottext">(EventEngineCtx -&gt; Int) -&gt; m EventEngineCtx -&gt; m Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO EventEngineCtx -&gt; m EventEngineCtx
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO EventEngineCtx
</span><a href="#local-6989586621687718022"><span class="hs-identifier hs-var">getEventEngineCtx</span></a></span><span>
</span><span id="line-332"></span><span>      </span><span id="local-6989586621687718039"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718039"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [BackendEventWithSource] -&gt; m [BackendEventWithSource]
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-333"></span><span>        </span><span class="annot"><span class="annottext">(IO [BackendEventWithSource] -&gt; m [BackendEventWithSource])
-&gt; (IO [[BackendEventWithSource]] -&gt; IO [BackendEventWithSource])
-&gt; IO [[BackendEventWithSource]]
-&gt; m [BackendEventWithSource]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([[BackendEventWithSource]] -&gt; [BackendEventWithSource])
-&gt; IO [[BackendEventWithSource]] -&gt; IO [BackendEventWithSource]
forall a b. (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[[BackendEventWithSource]] -&gt; [BackendEventWithSource]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span>
</span><span id="line-334"></span><span>        </span><span class="annot"><span class="annottext">(IO [[BackendEventWithSource]] -&gt; m [BackendEventWithSource])
-&gt; IO [[BackendEventWithSource]] -&gt; m [BackendEventWithSource]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-335"></span><span>        </span><span class="hs-comment">-- fetch pending events across all the sources asynchronously</span><span>
</span><span id="line-336"></span><span>        </span><span class="annot"><span class="annottext">[(SourceName, BackendSourceInfo)]
-&gt; ((SourceName, BackendSourceInfo) -&gt; IO [BackendEventWithSource])
-&gt; IO [[BackendEventWithSource]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, MonadBaseControl IO m, Forall (Pure m)) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lifted-async-0.10.2.3-d63f7c0774c9603306fb6be4536181f7e6facdd649f3f450b4e7dfd3d91cda94/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html#forConcurrently"><span class="hs-identifier hs-var">LA.forConcurrently</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceCache -&gt; [(SourceName, BackendSourceInfo)]
forall k v. HashMap k v -&gt; [(k, v)]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#toList"><span class="hs-identifier hs-var">HashMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCache
</span><a href="#local-6989586621687718035"><span class="hs-identifier hs-var">allSources</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687718042"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718042"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687718043"><span class="annot"><span class="annottext">BackendSourceInfo
</span><a href="#local-6989586621687718043"><span class="hs-identifier hs-var">sourceCache</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-337"></span><span>          </span><span class="annot"><span class="annottext">forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceInfo
</span><a href="#local-6989586621687718043"><span class="hs-identifier hs-var">sourceCache</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687718097"><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687718099"><span id="local-6989586621687718100"><span id="local-6989586621687718101"><span id="local-6989586621687718102"><span id="local-6989586621687718103"><span id="local-6989586621687718104"><span id="local-6989586621687718105"><span id="local-6989586621687718106"><span id="local-6989586621687718107"><span id="local-6989586621687718108"><span id="local-6989586621687718109"><span class="annot"><span class="annottext">Maybe QueryTagsConfig
TableCache b
FunctionCache b
StoredProcedureCache b
NativeQueryCache b
LogicalModelCache b
BackendSourceKind b
SourceName
SourceConfig b
ResolvedSourceCustomization
DBObjectsIntrospection b
_siName :: SourceName
_siSourceKind :: BackendSourceKind b
_siTables :: TableCache b
_siFunctions :: FunctionCache b
_siNativeQueries :: NativeQueryCache b
_siStoredProcedures :: StoredProcedureCache b
_siLogicalModels :: LogicalModelCache b
_siConfiguration :: SourceConfig b
_siQueryTagsConfig :: Maybe QueryTagsConfig
_siCustomization :: ResolvedSourceCustomization
_siDbObjectsIntrospection :: DBObjectsIntrospection b
_siName :: forall (b :: BackendType). SourceInfo b -&gt; SourceName
_siSourceKind :: forall (b :: BackendType). SourceInfo b -&gt; BackendSourceKind b
_siTables :: forall (b :: BackendType). SourceInfo b -&gt; TableCache b
_siFunctions :: forall (b :: BackendType). SourceInfo b -&gt; FunctionCache b
_siNativeQueries :: forall (b :: BackendType). SourceInfo b -&gt; NativeQueryCache b
_siStoredProcedures :: forall (b :: BackendType). SourceInfo b -&gt; StoredProcedureCache b
_siLogicalModels :: forall (b :: BackendType). SourceInfo b -&gt; LogicalModelCache b
_siConfiguration :: forall (b :: BackendType). SourceInfo b -&gt; SourceConfig b
_siQueryTagsConfig :: forall (b :: BackendType). SourceInfo b -&gt; Maybe QueryTagsConfig
_siCustomization :: forall (b :: BackendType).
SourceInfo b -&gt; ResolvedSourceCustomization
_siDbObjectsIntrospection :: forall (b :: BackendType). SourceInfo b -&gt; DBObjectsIntrospection b
</span><a href="#local-6989586621687718099"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687718097"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-338"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718121"><span class="annot"><span class="annottext">tables :: [TableInfo b]
</span><a href="#local-6989586621687718121"><span class="hs-identifier hs-var hs-var">tables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableCache b -&gt; [TableInfo b]
forall k v. HashMap k v -&gt; [v]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#elems"><span class="hs-identifier hs-var">HashMap.elems</span></a></span><span> </span><span class="annot"><span class="annottext">TableCache b
</span><a href="#local-6989586621687718101"><span class="hs-identifier hs-var">_siTables</span></a></span><span>
</span><span id="line-339"></span><span>                </span><span id="local-6989586621687718123"><span class="annot"><span class="annottext">triggerMap :: [EventTriggerInfoMap b]
</span><a href="#local-6989586621687718123"><span class="hs-identifier hs-var hs-var">triggerMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableInfo b -&gt; EventTriggerInfoMap b
forall (b :: BackendType). TableInfo b -&gt; EventTriggerInfoMap b
</span><a href="Hasura.Table.Cache.html#_tiEventTriggerInfoMap"><span class="hs-identifier hs-var">_tiEventTriggerInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">(TableInfo b -&gt; EventTriggerInfoMap b)
-&gt; [TableInfo b] -&gt; [EventTriggerInfoMap b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[TableInfo b]
</span><a href="#local-6989586621687718121"><span class="hs-identifier hs-var">tables</span></a></span><span>
</span><span id="line-340"></span><span>                </span><span id="local-6989586621687718125"><span class="annot"><span class="annottext">eventTriggerCount :: Int
</span><a href="#local-6989586621687718125"><span class="hs-identifier hs-var hs-var">eventTriggerCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall a. Num a =&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfoMap b -&gt; Int
forall k v. HashMap k v -&gt; Int
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#size"><span class="hs-identifier hs-var">HashMap.size</span></a></span><span> </span><span class="annot"><span class="annottext">(EventTriggerInfoMap b -&gt; Int) -&gt; [EventTriggerInfoMap b] -&gt; [Int]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[EventTriggerInfoMap b]
</span><a href="#local-6989586621687718123"><span class="hs-identifier hs-var">triggerMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>                </span><span id="local-6989586621687718128"><span class="annot"><span class="annottext">triggerNames :: [TriggerName]
</span><a href="#local-6989586621687718128"><span class="hs-identifier hs-var hs-var">triggerNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EventTriggerInfoMap b -&gt; [TriggerName])
-&gt; [EventTriggerInfoMap b] -&gt; [TriggerName]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfoMap b -&gt; [TriggerName]
forall k v. HashMap k v -&gt; [k]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#keys"><span class="hs-identifier hs-var">HashMap.keys</span></a></span><span> </span><span class="annot"><span class="annottext">[EventTriggerInfoMap b]
</span><a href="#local-6989586621687718123"><span class="hs-identifier hs-var">triggerMap</span></a></span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span>            </span><span class="hs-comment">-- only process events for this source if at least one event trigger exists</span><span>
</span><span id="line-344"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718125"><span class="hs-identifier hs-var">eventTriggerCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-345"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-346"></span><span>                </span><span id="local-6989586621687718132"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718132"><span class="hs-identifier hs-var">eventPollStartTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-347"></span><span>                </span><span class="annot"><span class="annottext">ExceptT QErr IO [Event b] -&gt; IO (Either QErr [Event b])
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b
-&gt; SourceName
-&gt; [TriggerName]
-&gt; MaintenanceMode ()
-&gt; FetchBatchSize
-&gt; m [Event b]
</span><a href="Hasura.Eventing.Backend.html#fetchUndeliveredEvents"><span class="hs-identifier hs-var">fetchUndeliveredEvents</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687718097"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718106"><span class="hs-identifier hs-var">_siConfiguration</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718042"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621687718128"><span class="hs-identifier hs-var">triggerNames</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621687718029"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; FetchBatchSize
</span><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-var">FetchBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718038"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO (Either QErr [Event b])
-&gt; (Either QErr [Event b] -&gt; IO [BackendEventWithSource])
-&gt; IO [BackendEventWithSource]
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-348"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687718137"><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621687718137"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-349"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718138"><span class="annot"><span class="annottext">eventFetchCount :: Int64
</span><a href="#local-6989586621687718138"><span class="hs-identifier hs-var hs-var">eventFetchCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int64) -&gt; Int -&gt; Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Event b] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621687718137"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-350"></span><span>                    </span><span class="annot"><span class="annottext">Gauge -&gt; Int64 -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#set"><span class="hs-identifier hs-var">Prometheus.Gauge.set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#eventsFetchedPerBatch"><span class="hs-identifier hs-var">eventsFetchedPerBatch</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621687718138"><span class="hs-identifier hs-var">eventFetchCount</span></a></span><span>
</span><span id="line-351"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Event b] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621687718137"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; IO [BackendEventWithSource]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-353"></span><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>                        </span><span id="local-6989586621687718143"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718143"><span class="hs-identifier hs-var">eventsFetchedTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span> </span><span class="hs-comment">-- This is also the poll end time</span><span>
</span><span id="line-355"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718144"><span class="annot"><span class="annottext">eventPollTime :: Double
</span><a href="#local-6989586621687718144"><span class="hs-identifier hs-var hs-var">eventPollTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; Double
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; Double) -&gt; NominalDiffTime -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">diffUTCTime</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718143"><span class="hs-identifier hs-var">eventsFetchedTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718132"><span class="hs-identifier hs-var">eventPollStartTime</span></a></span><span>
</span><span id="line-356"></span><span>                        </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Distribution.html#add"><span class="hs-identifier hs-var">EKG.Distribution.add</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smEventFetchTimePerBatch"><span class="hs-identifier hs-var">smEventFetchTimePerBatch</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621687718027"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621687718144"><span class="hs-identifier hs-var">eventPollTime</span></a></span><span>
</span><span id="line-357"></span><span>                        </span><span class="annot"><span class="annottext">Histogram -&gt; Double -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Histogram.html#observe"><span class="hs-identifier hs-var">Prometheus.Histogram.observe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Histogram
</span><a href="Hasura.Server.Prometheus.html#eventsFetchTimePerBatch"><span class="hs-identifier hs-var">eventsFetchTimePerBatch</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621687718144"><span class="hs-identifier hs-var">eventPollTime</span></a></span><span>
</span><span id="line-358"></span><span>                        </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Distribution.html#add"><span class="hs-identifier hs-var">EKG.Distribution.add</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smNumEventsFetchedPerBatch"><span class="hs-identifier hs-var">smNumEventsFetchedPerBatch</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621687718027"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Double) -&gt; Int -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Event b] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621687718137"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>                        </span><span class="annot"><span class="annottext">SourceName
-&gt; [EventId] -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
SourceName
-&gt; [EventId] -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier hs-var">saveLockedEventTriggerEvents</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718042"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">(Event b -&gt; EventId) -&gt; [Event b] -&gt; [EventId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621687718137"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621687718025"><span class="hs-identifier hs-var">leEvents</span></a></span><span>
</span><span id="line-360"></span><span>                        </span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; IO [BackendEventWithSource]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([BackendEventWithSource] -&gt; IO [BackendEventWithSource])
-&gt; [BackendEventWithSource] -&gt; IO [BackendEventWithSource]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Event b -&gt; BackendEventWithSource)
-&gt; [Event b] -&gt; [BackendEventWithSource]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621687718152"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718152"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687718097"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">(EventWithSource b -&gt; BackendEventWithSource)
-&gt; EventWithSource b -&gt; BackendEventWithSource
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event b
-&gt; SourceConfig b -&gt; SourceName -&gt; UTCTime -&gt; EventWithSource b
forall (b :: BackendType).
Event b
-&gt; SourceConfig b -&gt; SourceName -&gt; UTCTime -&gt; EventWithSource b
</span><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-var">EventWithSource</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718152"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718106"><span class="hs-identifier hs-var">_siConfiguration</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718042"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718143"><span class="hs-identifier hs-var">eventsFetchedTime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621687718137"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-361"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687718155"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687718155"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>                    </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687718018"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(EventInternalErr -&gt; IO ()) -&gt; EventInternalErr -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; EventInternalErr
</span><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687718155"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-363"></span><span>                    </span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; IO [BackendEventWithSource]
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-364"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; IO [BackendEventWithSource]
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span>      </span><span class="hs-comment">-- Log the statistics of events fetched</span><span>
</span><span id="line-367"></span><span>      </span><span class="annot"><span class="annottext">FetchedEventsStatsLogger -&gt; [BackendEventWithSource] -&gt; m ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
FetchedEventsStatsLogger -&gt; [BackendEventWithSource] -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logFetchedEventsStatistics"><span class="hs-identifier hs-var">logFetchedEventsStatistics</span></a></span><span> </span><span class="annot"><span class="annottext">FetchedEventsStatsLogger
</span><a href="#local-6989586621687718019"><span class="hs-identifier hs-var">statsLogger</span></a></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718039"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-368"></span><span>      </span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; m [BackendEventWithSource]
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718039"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span>    </span><span class="hs-comment">-- !!! CAREFUL !!!</span><span>
</span><span id="line-371"></span><span>    </span><span class="hs-comment">--     The logic here in particular is subtle and has been fixed, broken,</span><span>
</span><span id="line-372"></span><span>    </span><span class="hs-comment">--     and fixed again in several different ways, several times.</span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-comment">-- !!! CAREFUL !!!</span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-comment">-- work on this batch of events while prefetching the next. Recurse after we've forked workers</span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-comment">-- for each in the batch, minding the requested pool size.</span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><a href="#local-6989586621687718034"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchEventArguments"><span class="hs-identifier hs-type">FetchEventArguments</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687716497"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchEventArguments"><span class="hs-identifier hs-type">FetchEventArguments</span></a></span><span>
</span><span id="line-378"></span><span>    </span><span id="local-6989586621687718034"><span class="annot"><span class="annottext">go :: ([BackendEventWithSource], Int, Bool)
-&gt; m ([BackendEventWithSource], Int, Bool)
</span><a href="#local-6989586621687718034"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687718157"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718157"><span class="hs-identifier hs-var">events</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621687718158"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718158"><span class="hs-identifier hs-var">fullFetchCount</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621687718159"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687718159"><span class="hs-identifier hs-var">alreadyWarned</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-379"></span><span>      </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687718160"><span id="local-6989586621687718161"><span id="local-6989586621687718162"><span class="annot"><span class="annottext">TVar Int
DiffTime
Refined NonNegative Int
_eeCtxEventThreadsCapacity :: EventEngineCtx -&gt; TVar Int
_eeCtxFetchInterval :: EventEngineCtx -&gt; DiffTime
_eeCtxFetchSize :: EventEngineCtx -&gt; Refined NonNegative Int
_eeCtxEventThreadsCapacity :: TVar Int
_eeCtxFetchInterval :: DiffTime
_eeCtxFetchSize :: Refined NonNegative Int
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxEventThreadsCapacity"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO EventEngineCtx -&gt; m EventEngineCtx
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO EventEngineCtx
</span><a href="#local-6989586621687718022"><span class="hs-identifier hs-var">getEventEngineCtx</span></a></span><span>
</span><span id="line-380"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718163"><span class="annot"><span class="annottext">fetchBatchSize :: Int
</span><a href="#local-6989586621687718163"><span class="hs-identifier hs-var hs-var">fetchBatchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Int -&gt; Int
forall {k} (p :: k) x. Refined p x -&gt; x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#unrefine"><span class="hs-identifier hs-var">unrefine</span></a></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Int
</span><a href="#local-6989586621687718162"><span class="hs-identifier hs-var">_eeCtxFetchSize</span></a></span><span>
</span><span id="line-381"></span><span>      </span><span class="hs-comment">-- process events ASAP until we've caught up; only then can we sleep</span><span>
</span><span id="line-382"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718157"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; (IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">sleep</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687718161"><span class="hs-identifier hs-var">_eeCtxFetchInterval</span></a></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span>      </span><span class="hs-comment">-- Prefetch next events payload while concurrently working through our current batch.</span><span>
</span><span id="line-385"></span><span>      </span><span class="hs-comment">-- NOTE: we probably don't need to prefetch so early, but probably not</span><span>
</span><span id="line-386"></span><span>      </span><span class="hs-comment">-- worth the effort for something more fine-tuned</span><span>
</span><span id="line-387"></span><span>      </span><span id="local-6989586621687718165"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718165"><span class="hs-identifier hs-var">eventsNext</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [BackendEventWithSource]
-&gt; (Async [BackendEventWithSource] -&gt; m [BackendEventWithSource])
-&gt; m [BackendEventWithSource]
forall (m :: * -&gt; *) a b.
(MonadBaseControl IO m, Forall (Pure m)) =&gt;
m a -&gt; (Async a -&gt; m b) -&gt; m b
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lifted-async-0.10.2.3-d63f7c0774c9603306fb6be4536181f7e6facdd649f3f450b4e7dfd3d91cda94/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html#withAsync"><span class="hs-identifier hs-var">LA.withAsync</span></a></span><span> </span><span class="annot"><span class="annottext">m [BackendEventWithSource]
</span><a href="#local-6989586621687718032"><span class="hs-identifier hs-var">popEventsBatch</span></a></span><span> </span><span class="annot"><span class="annottext">((Async [BackendEventWithSource] -&gt; m [BackendEventWithSource])
 -&gt; m [BackendEventWithSource])
-&gt; (Async [BackendEventWithSource] -&gt; m [BackendEventWithSource])
-&gt; m [BackendEventWithSource]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687718167"><span class="annot"><span class="annottext">Async [BackendEventWithSource]
</span><a href="#local-6989586621687718167"><span class="hs-identifier hs-var">eventsNextA</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-388"></span><span>        </span><span class="hs-comment">-- process approximately in order, minding HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE:</span><span>
</span><span id="line-389"></span><span>        </span><span class="annot"><span class="annottext">[BackendEventWithSource]
-&gt; (BackendEventWithSource -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718157"><span class="hs-identifier hs-var">events</span></a></span><span> </span><span class="annot"><span class="annottext">((BackendEventWithSource -&gt; m ()) -&gt; m ())
-&gt; (BackendEventWithSource -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687718169"><span class="annot"><span class="annottext">BackendEventWithSource
</span><a href="#local-6989586621687718169"><span class="hs-identifier hs-var">eventWithSource</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-390"></span><span>          </span><span class="hs-comment">-- NOTE: we implement a logical bracket pattern here with the</span><span>
</span><span id="line-391"></span><span>          </span><span class="hs-comment">-- increment and decrement of _eeCtxEventThreadsCapacity which</span><span>
</span><span id="line-392"></span><span>          </span><span class="hs-comment">-- depends on not putting anything that can throw in the body here:</span><span>
</span><span id="line-393"></span><span>          </span><span class="annot"><span class="annottext">forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">BackendEventWithSource
</span><a href="#local-6989586621687718169"><span class="hs-identifier hs-var">eventWithSource</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687718203"><span id="local-6989586621687718204"><span class="annot"><span class="annottext">EventWithSource b
</span><a href="#local-6989586621687718204"><span class="hs-identifier hs-var">eventWithSource'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687718203"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-394"></span><span>            </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-395"></span><span>              </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-396"></span><span>                </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span>
</span><span id="line-397"></span><span>                </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-398"></span><span>                  </span><span class="hs-comment">-- block until &lt; HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE threads:</span><span>
</span><span id="line-399"></span><span>                  </span><span id="local-6989586621687718205"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718205"><span class="hs-identifier hs-var">maxCapacity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Int -&gt; STM Int
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621687718160"><span class="hs-identifier hs-var">_eeCtxEventThreadsCapacity</span></a></span><span>
</span><span id="line-400"></span><span>                  </span><span id="local-6989586621687718206"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718206"><span class="hs-identifier hs-var">activeThreadCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Int -&gt; STM Int
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621687718023"><span class="hs-identifier hs-var">activeEventProcessingThreads</span></a></span><span>
</span><span id="line-401"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; STM ()
</span><span class="hs-identifier hs-var">check</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM ()) -&gt; Bool -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718205"><span class="hs-identifier hs-var">maxCapacity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718206"><span class="hs-identifier hs-var">activeThreadCount</span></a></span><span>
</span><span id="line-402"></span><span>                  </span><span class="annot"><span class="annottext">TVar Int -&gt; (Int -&gt; Int) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621687718023"><span class="hs-identifier hs-var">activeEventProcessingThreads</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>              </span><span class="hs-comment">-- since there is some capacity in our worker threads, we can launch another:</span><span>
</span><span id="line-404"></span><span>              </span><span id="local-6989586621687718209"><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621687718209"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-405"></span><span>                </span><span class="annot"><span class="annottext">m () -&gt; m (Async ())
forall (m :: * -&gt; *) a.
(MonadBaseControl IO m, Forall (Pure m)) =&gt;
m a -&gt; m (Async a)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lifted-async-0.10.2.3-d63f7c0774c9603306fb6be4536181f7e6facdd649f3f450b4e7dfd3d91cda94/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html#async"><span class="hs-identifier hs-var">LA.async</span></a></span><span>
</span><span id="line-406"></span><span>                  </span><span class="annot"><span class="annottext">(m () -&gt; m (Async ())) -&gt; m () -&gt; m (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT (Logger Hasura, Manager) m ()
 -&gt; (Logger Hasura, Manager) -&gt; m ())
-&gt; (Logger Hasura, Manager)
-&gt; ReaderT (Logger Hasura, Manager) m ()
-&gt; m ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Logger Hasura, Manager) m ()
-&gt; (Logger Hasura, Manager) -&gt; m ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687718018"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621687718020"><span class="hs-identifier hs-var">httpMgr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>                  </span><span class="annot"><span class="annottext">(ReaderT (Logger Hasura, Manager) m () -&gt; m ())
-&gt; ReaderT (Logger Hasura, Manager) m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventWithSource b -&gt; ReaderT (Logger Hasura, Manager) m ()
forall (io :: * -&gt; *) r (b :: BackendType).
(MonadBaseControl IO io, MonadIO io, MonadReader r io,
 Has Manager r, Has (Logger Hasura) r, MonadMask io,
 BackendEventTrigger b, MonadTrace io, MonadGetPolicies io) =&gt;
EventWithSource b -&gt; io ()
</span><a href="#local-6989586621687718212"><span class="hs-identifier hs-var">processEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventWithSource b
</span><a href="#local-6989586621687718204"><span class="hs-identifier hs-var">eventWithSource'</span></a></span><span>
</span><span id="line-408"></span><span>                  </span><span class="annot"><span class="annottext">ReaderT (Logger Hasura, Manager) m ()
-&gt; ReaderT (Logger Hasura, Manager) m ()
-&gt; ReaderT (Logger Hasura, Manager) m ()
forall (m :: * -&gt; *) a b. MonadMask m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span>
</span><span id="line-409"></span><span>                  </span><span class="hs-comment">-- NOTE!: this needs to happen IN THE FORKED THREAD:</span><span>
</span><span id="line-410"></span><span>                  </span><span class="annot"><span class="annottext">ReaderT (Logger Hasura, Manager) m ()
</span><a href="#local-6989586621687718213"><span class="hs-identifier hs-var">decrementActiveThreadCount</span></a></span><span>
</span><span id="line-411"></span><span>              </span><span class="annot"><span class="annottext">Async () -&gt; m ()
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; Async a -&gt; m ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lifted-async-0.10.2.3-d63f7c0774c9603306fb6be4536181f7e6facdd649f3f450b4e7dfd3d91cda94/share/doc/html/src/Control.Concurrent.Async.Lifted.html#link"><span class="hs-identifier hs-var">LA.link</span></a></span><span> </span><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621687718209"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span>        </span><span class="hs-comment">-- return when next batch ready; some 'processEvent' threads may be running.</span><span>
</span><span id="line-414"></span><span>        </span><span class="annot"><span class="annottext">Async [BackendEventWithSource] -&gt; m [BackendEventWithSource]
forall (m :: * -&gt; *) a.
(MonadBase IO m, Forall (Pure m)) =&gt;
Async a -&gt; m a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lifted-async-0.10.2.3-d63f7c0774c9603306fb6be4536181f7e6facdd649f3f450b4e7dfd3d91cda94/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html#wait"><span class="hs-identifier hs-var">LA.wait</span></a></span><span> </span><span class="annot"><span class="annottext">Async [BackendEventWithSource]
</span><a href="#local-6989586621687718167"><span class="hs-identifier hs-var">eventsNextA</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718216"><span class="annot"><span class="annottext">lenEvents :: Int
</span><a href="#local-6989586621687718216"><span class="hs-identifier hs-var hs-var">lenEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718157"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-417"></span><span>      </span><span class="hs-keyword">if</span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718216"><span class="hs-identifier hs-var">lenEvents</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718163"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-419"></span><span>            </span><span class="hs-comment">-- If we've seen N fetches in a row from the DB come back full (i.e. only limited</span><span>
</span><span id="line-420"></span><span>            </span><span class="hs-comment">-- by our LIMIT clause), then we say we're clearly falling behind:</span><span>
</span><span id="line-421"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718217"><span class="annot"><span class="annottext">clearlyBehind :: Bool
</span><a href="#local-6989586621687718217"><span class="hs-identifier hs-var hs-var">clearlyBehind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718158"><span class="hs-identifier hs-var">fullFetchCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span>
</span><span id="line-422"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687718159"><span class="hs-identifier hs-var">alreadyWarned</span></a></span><span>
</span><span id="line-423"></span><span>              </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687718217"><span class="hs-identifier hs-var">clearlyBehind</span></a></span><span>
</span><span id="line-424"></span><span>              </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687718018"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-425"></span><span>              </span><span class="annot"><span class="annottext">(UnstructuredLog -&gt; m ()) -&gt; UnstructuredLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; SerializableBlob -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">L.LevelWarn</span></a></span><span>
</span><span id="line-426"></span><span>              </span><span class="annot"><span class="annottext">(SerializableBlob -&gt; UnstructuredLog)
-&gt; SerializableBlob -&gt; UnstructuredLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; SerializableBlob
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-427"></span><span>              </span><span class="annot"><span class="annottext">(String -&gt; SerializableBlob) -&gt; String -&gt; SerializableBlob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Events processor may not be keeping up with events generated in postgres, &quot;</span></span><span>
</span><span id="line-428"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;or we're working on a backlog of events. Consider increasing &quot;</span></span><span>
</span><span id="line-429"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE&quot;</span></span><span>
</span><span id="line-430"></span><span>            </span><span class="annot"><span class="annottext">([BackendEventWithSource], Int, Bool)
-&gt; m ([BackendEventWithSource], Int, Bool)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718165"><span class="hs-identifier hs-var">eventsNext</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718158"><span class="hs-identifier hs-var">fullFetchCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687718159"><span class="hs-identifier hs-var">alreadyWarned</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687718217"><span class="hs-identifier hs-var">clearlyBehind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718216"><span class="hs-identifier hs-var">lenEvents</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718163"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687718159"><span class="hs-identifier hs-var">alreadyWarned</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>              </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-434"></span><span>              </span><span class="hs-comment">-- emit as warning in case users are only logging warning severity and saw above</span><span>
</span><span id="line-435"></span><span>              </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687718018"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-436"></span><span>              </span><span class="annot"><span class="annottext">(UnstructuredLog -&gt; m ()) -&gt; UnstructuredLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; SerializableBlob -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">L.LevelWarn</span></a></span><span>
</span><span id="line-437"></span><span>              </span><span class="annot"><span class="annottext">(SerializableBlob -&gt; UnstructuredLog)
-&gt; SerializableBlob -&gt; UnstructuredLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; SerializableBlob
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-438"></span><span>              </span><span class="annot"><span class="annottext">(String -&gt; SerializableBlob) -&gt; String -&gt; SerializableBlob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;It looks like the events processor is keeping up again.&quot;</span></span><span>
</span><span id="line-439"></span><span>            </span><span class="annot"><span class="annottext">([BackendEventWithSource], Int, Bool)
-&gt; m ([BackendEventWithSource], Int, Bool)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621687718165"><span class="hs-identifier hs-var">eventsNext</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span>    </span><span id="local-6989586621687718213"><span class="annot"><span class="annottext">decrementActiveThreadCount :: ReaderT (Logger Hasura, Manager) m ()
</span><a href="#local-6989586621687718213"><span class="hs-identifier hs-var hs-var">decrementActiveThreadCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-442"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; ReaderT (Logger Hasura, Manager) m ()
forall a. IO a -&gt; ReaderT (Logger Hasura, Manager) m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-443"></span><span>        </span><span class="annot"><span class="annottext">(IO () -&gt; ReaderT (Logger Hasura, Manager) m ())
-&gt; IO () -&gt; ReaderT (Logger Hasura, Manager) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span>
</span><span id="line-444"></span><span>        </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar Int -&gt; (Int -&gt; Int) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621687718023"><span class="hs-identifier hs-var">activeEventProcessingThreads</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">subtract</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span>    </span><span class="hs-comment">-- \| Extract a trace context from an event trigger payload.</span><span>
</span><span id="line-447"></span><span>    </span><span class="annot"><a href="#local-6989586621687718225"><span class="hs-identifier hs-type">extractEventContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687716670"><span class="annot"><a href="#local-6989586621687716670"><span class="hs-identifier hs-type">io</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716670"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687716670"><span class="hs-identifier hs-type">io</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.Tracing.Context.html#TraceContext"><span class="hs-identifier hs-type">Tracing.TraceContext</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>    </span><span id="local-6989586621687718225"><span class="annot"><span class="annottext">extractEventContext :: forall (io :: * -&gt; *).
MonadIO io =&gt;
Value -&gt; io (Maybe TraceContext)
</span><a href="#local-6989586621687718225"><span class="hs-identifier hs-var hs-var">extractEventContext</span></a></span></span><span> </span><span id="local-6989586621687718274"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718274"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-449"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718275"><span class="annot"><span class="annottext">traceIdMaybe :: Maybe TraceId
</span><a href="#local-6989586621687718275"><span class="hs-identifier hs-var hs-var">traceIdMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-450"></span><span>            </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe TraceId
</span><a href="Hasura.Tracing.TraceId.html#traceIdFromHex"><span class="hs-identifier hs-var">Tracing.traceIdFromHex</span></a></span><span>
</span><span id="line-451"></span><span>              </span><span class="annot"><span class="annottext">(ByteString -&gt; Maybe TraceId)
-&gt; (Text -&gt; ByteString) -&gt; Text -&gt; Maybe TraceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#txtToBs"><span class="hs-identifier hs-var">txtToBs</span></a></span><span>
</span><span id="line-452"></span><span>              </span><span class="annot"><span class="annottext">(Text -&gt; Maybe TraceId) -&gt; Maybe Text -&gt; Maybe TraceId
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718274"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-453"></span><span>              </span><span class="annot"><span class="annottext">Value -&gt; Getting (First Text) Value Text -&gt; Maybe Text
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.Fold.html#%5E%3F"><span class="hs-operator hs-var">^?</span></a></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Traversal' Value Value
forall t. AsValue t =&gt; Key -&gt; Traversal' t Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-aeson-1.2.2-81109da53433966d8b3e225f0220e71a6ae7fcd29eb5d0360770d3cdcf621c9c/share/doc/html/src/Data.Aeson.Lens.html#key"><span class="hs-identifier hs-var">JL.key</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;trace_context&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Value -&gt; Const (First Text) Value)
 -&gt; Value -&gt; Const (First Text) Value)
-&gt; Getting (First Text) Value Text
-&gt; Getting (First Text) Value Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Traversal' Value Value
forall t. AsValue t =&gt; Key -&gt; Traversal' t Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-aeson-1.2.2-81109da53433966d8b3e225f0220e71a6ae7fcd29eb5d0360770d3cdcf621c9c/share/doc/html/src/Data.Aeson.Lens.html#key"><span class="hs-identifier hs-var">JL.key</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;trace_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Value -&gt; Const (First Text) Value)
 -&gt; Value -&gt; Const (First Text) Value)
-&gt; Getting (First Text) Value Text
-&gt; Getting (First Text) Value Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Getting (First Text) Value Text
forall t. AsValue t =&gt; Prism' t Text
Prism' Value Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-aeson-1.2.2-81109da53433966d8b3e225f0220e71a6ae7fcd29eb5d0360770d3cdcf621c9c/share/doc/html/src/Data.Aeson.Lens.html#_String"><span class="hs-identifier hs-var">JL._String</span></a></span><span>
</span><span id="line-454"></span><span>      </span><span class="annot"><span class="annottext">Maybe TraceId
-&gt; (TraceId -&gt; io TraceContext) -&gt; io (Maybe TraceContext)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">Maybe TraceId
</span><a href="#local-6989586621687718275"><span class="hs-identifier hs-var">traceIdMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">((TraceId -&gt; io TraceContext) -&gt; io (Maybe TraceContext))
-&gt; (TraceId -&gt; io TraceContext) -&gt; io (Maybe TraceContext)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687718283"><span class="annot"><span class="annottext">TraceId
</span><a href="#local-6989586621687718283"><span class="hs-identifier hs-var">traceId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-455"></span><span>        </span><span id="local-6989586621687718284"><span class="annot"><span class="annottext">SpanId
</span><a href="#local-6989586621687718284"><span class="hs-identifier hs-var">freshSpanId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">io SpanId
forall (m :: * -&gt; *). MonadIO m =&gt; m SpanId
</span><a href="Hasura.Tracing.TraceId.html#randomSpanId"><span class="hs-identifier hs-var">Tracing.randomSpanId</span></a></span><span>
</span><span id="line-456"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718286"><span class="annot"><span class="annottext">parentSpanId :: Maybe SpanId
</span><a href="#local-6989586621687718286"><span class="hs-identifier hs-var hs-var">parentSpanId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-457"></span><span>              </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe SpanId
</span><a href="Hasura.Tracing.TraceId.html#spanIdFromHex"><span class="hs-identifier hs-var">Tracing.spanIdFromHex</span></a></span><span>
</span><span id="line-458"></span><span>                </span><span class="annot"><span class="annottext">(ByteString -&gt; Maybe SpanId)
-&gt; (Text -&gt; ByteString) -&gt; Text -&gt; Maybe SpanId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#txtToBs"><span class="hs-identifier hs-var">txtToBs</span></a></span><span>
</span><span id="line-459"></span><span>                </span><span class="annot"><span class="annottext">(Text -&gt; Maybe SpanId) -&gt; Maybe Text -&gt; Maybe SpanId
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718274"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-460"></span><span>                </span><span class="annot"><span class="annottext">Value -&gt; Getting (First Text) Value Text -&gt; Maybe Text
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.Fold.html#%5E%3F"><span class="hs-operator hs-var">^?</span></a></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Traversal' Value Value
forall t. AsValue t =&gt; Key -&gt; Traversal' t Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-aeson-1.2.2-81109da53433966d8b3e225f0220e71a6ae7fcd29eb5d0360770d3cdcf621c9c/share/doc/html/src/Data.Aeson.Lens.html#key"><span class="hs-identifier hs-var">JL.key</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;trace_context&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Value -&gt; Const (First Text) Value)
 -&gt; Value -&gt; Const (First Text) Value)
-&gt; Getting (First Text) Value Text
-&gt; Getting (First Text) Value Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Traversal' Value Value
forall t. AsValue t =&gt; Key -&gt; Traversal' t Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-aeson-1.2.2-81109da53433966d8b3e225f0220e71a6ae7fcd29eb5d0360770d3cdcf621c9c/share/doc/html/src/Data.Aeson.Lens.html#key"><span class="hs-identifier hs-var">JL.key</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;span_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Value -&gt; Const (First Text) Value)
 -&gt; Value -&gt; Const (First Text) Value)
-&gt; Getting (First Text) Value Text
-&gt; Getting (First Text) Value Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Getting (First Text) Value Text
forall t. AsValue t =&gt; Prism' t Text
Prism' Value Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-aeson-1.2.2-81109da53433966d8b3e225f0220e71a6ae7fcd29eb5d0360770d3cdcf621c9c/share/doc/html/src/Data.Aeson.Lens.html#_String"><span class="hs-identifier hs-var">JL._String</span></a></span><span>
</span><span id="line-461"></span><span>            </span><span id="local-6989586621687718288"><span class="annot"><span class="annottext">samplingState :: SamplingState
</span><a href="#local-6989586621687718288"><span class="hs-identifier hs-var hs-var">samplingState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-462"></span><span>              </span><span class="annot"><span class="annottext">Maybe Text -&gt; SamplingState
forall s. (IsString s, Eq s) =&gt; Maybe s -&gt; SamplingState
</span><a href="Hasura.Tracing.Sampling.html#samplingStateFromHeader"><span class="hs-identifier hs-var">Tracing.samplingStateFromHeader</span></a></span><span>
</span><span id="line-463"></span><span>                </span><span class="annot"><span class="annottext">(Maybe Text -&gt; SamplingState) -&gt; Maybe Text -&gt; SamplingState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718274"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-464"></span><span>                </span><span class="annot"><span class="annottext">Value -&gt; Getting (First Text) Value Text -&gt; Maybe Text
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.Fold.html#%5E%3F"><span class="hs-operator hs-var">^?</span></a></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Traversal' Value Value
forall t. AsValue t =&gt; Key -&gt; Traversal' t Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-aeson-1.2.2-81109da53433966d8b3e225f0220e71a6ae7fcd29eb5d0360770d3cdcf621c9c/share/doc/html/src/Data.Aeson.Lens.html#key"><span class="hs-identifier hs-var">JL.key</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;trace_context&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Value -&gt; Const (First Text) Value)
 -&gt; Value -&gt; Const (First Text) Value)
-&gt; Getting (First Text) Value Text
-&gt; Getting (First Text) Value Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Traversal' Value Value
forall t. AsValue t =&gt; Key -&gt; Traversal' t Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-aeson-1.2.2-81109da53433966d8b3e225f0220e71a6ae7fcd29eb5d0360770d3cdcf621c9c/share/doc/html/src/Data.Aeson.Lens.html#key"><span class="hs-identifier hs-var">JL.key</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;sampling_state&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Value -&gt; Const (First Text) Value)
 -&gt; Value -&gt; Const (First Text) Value)
-&gt; Getting (First Text) Value Text
-&gt; Getting (First Text) Value Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Getting (First Text) Value Text
forall t. AsValue t =&gt; Prism' t Text
Prism' Value Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-aeson-1.2.2-81109da53433966d8b3e225f0220e71a6ae7fcd29eb5d0360770d3cdcf621c9c/share/doc/html/src/Data.Aeson.Lens.html#_String"><span class="hs-identifier hs-var">JL._String</span></a></span><span>
</span><span id="line-465"></span><span>        </span><span class="annot"><span class="annottext">TraceContext -&gt; io TraceContext
forall a. a -&gt; io a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TraceContext -&gt; io TraceContext)
-&gt; TraceContext -&gt; io TraceContext
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TraceId -&gt; SpanId -&gt; Maybe SpanId -&gt; SamplingState -&gt; TraceContext
</span><a href="Hasura.Tracing.Context.html#TraceContext"><span class="hs-identifier hs-var">Tracing.TraceContext</span></a></span><span> </span><span class="annot"><span class="annottext">TraceId
</span><a href="#local-6989586621687718283"><span class="hs-identifier hs-var">traceId</span></a></span><span> </span><span class="annot"><span class="annottext">SpanId
</span><a href="#local-6989586621687718284"><span class="hs-identifier hs-var">freshSpanId</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SpanId
</span><a href="#local-6989586621687718286"><span class="hs-identifier hs-var">parentSpanId</span></a></span><span> </span><span class="annot"><span class="annottext">SamplingState
</span><a href="#local-6989586621687718288"><span class="hs-identifier hs-var">samplingState</span></a></span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span>    </span><span class="annot"><a href="#local-6989586621687718212"><span class="hs-identifier hs-type">processEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-468"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687716659"><span class="annot"><a href="#local-6989586621687716659"><span class="hs-identifier hs-type">io</span></a></span></span><span> </span><span id="local-6989586621687716660"><span class="annot"><a href="#local-6989586621687716660"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621687716661"><span class="annot"><a href="#local-6989586621687716661"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-469"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/monad-control-1.0.3.1-db4229aec3d9c1011503cf06798714c732b74d731fab23998dd34d578ed6d457/share/doc/html/src/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716659"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-470"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716659"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-471"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621687716660"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716659"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-472"></span><span>        </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/data-has-0.4.0.0-dac5c7adae74e1856a42108dcba181ae6d833a24d6271d4129aff0f1aaae2f5f/share/doc/html/src/Data.Has.html#Has"><span class="hs-identifier hs-type">Has</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/http-client-0.7.13.1-88628f48a025e46598ca658ea231eb27d6340417f49e950fbf8c438edb3ebbdc/share/doc/html/src/Network.HTTP.Client.Types.html#Manager"><span class="hs-identifier hs-type">HTTP.Manager</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716660"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-473"></span><span>        </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/data-has-0.4.0.0-dac5c7adae74e1856a42108dcba181ae6d833a24d6271d4129aff0f1aaae2f5f/share/doc/html/src/Data.Has.html#Has"><span class="hs-identifier hs-type">Has</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687716660"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621687716659"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-475"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716661"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-476"></span><span>        </span><span class="annot"><a href="Hasura.Tracing.Class.html#MonadTrace"><span class="hs-identifier hs-type">Tracing.MonadTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716659"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-477"></span><span>        </span><span class="annot"><a href="Hasura.Server.Types.html#MonadGetPolicies"><span class="hs-identifier hs-type">MonadGetPolicies</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716659"><span class="hs-identifier hs-type">io</span></a></span><span>
</span><span id="line-478"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-479"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716661"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-480"></span><span>      </span><span class="annot"><a href="#local-6989586621687716659"><span class="hs-identifier hs-type">io</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>    </span><span id="local-6989586621687718212"><span class="annot"><span class="annottext">processEvent :: forall (io :: * -&gt; *) r (b :: BackendType).
(MonadBaseControl IO io, MonadIO io, MonadReader r io,
 Has Manager r, Has (Logger Hasura) r, MonadMask io,
 BackendEventTrigger b, MonadTrace io, MonadGetPolicies io) =&gt;
EventWithSource b -&gt; io ()
</span><a href="#local-6989586621687718212"><span class="hs-identifier hs-var hs-var">processEvent</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span> </span><span id="local-6989586621687718485"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621687718486"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718486"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687718487"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718487"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621687718488"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718488"><span class="hs-identifier hs-var">eventFetchedTime</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-482"></span><span>      </span><span class="hs-comment">-- IO action for fetching the configured metrics granularity</span><span>
</span><span id="line-483"></span><span>      </span><span id="local-6989586621687718489"><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718489"><span class="hs-identifier hs-var">getPrometheusMetricsGranularity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">io (IO GranularPrometheusMetricsState)
forall (m :: * -&gt; *).
MonadGetPolicies m =&gt;
m (IO GranularPrometheusMetricsState)
</span><a href="Hasura.Server.Types.html#runGetPrometheusMetricsGranularity"><span class="hs-identifier hs-var">runGetPrometheusMetricsGranularity</span></a></span><span>
</span><span id="line-484"></span><span>      </span><span class="hs-comment">-- Track Queue Time of Event (in seconds). See `smEventQueueTime`</span><span>
</span><span id="line-485"></span><span>      </span><span class="hs-comment">-- Queue Time = Time when the event was fetched from DB - Time when the event is being processed</span><span>
</span><span id="line-486"></span><span>      </span><span id="local-6989586621687718491"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718491"><span class="hs-identifier hs-var">eventProcessTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; io UTCTime
forall a. IO a -&gt; io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-487"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718492"><span class="annot"><span class="annottext">eventQueueTime :: Double
</span><a href="#local-6989586621687718492"><span class="hs-identifier hs-var hs-var">eventQueueTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; Double
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; Double) -&gt; NominalDiffTime -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">diffUTCTime</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718491"><span class="hs-identifier hs-var">eventProcessTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718488"><span class="hs-identifier hs-var">eventFetchedTime</span></a></span><span>
</span><span id="line-488"></span><span>      </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; io ()
forall a. IO a -&gt; io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; io ()) -&gt; IO () -&gt; io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Distribution.html#add"><span class="hs-identifier hs-var">EKG.Distribution.add</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smEventQueueTime"><span class="hs-identifier hs-var">smEventQueueTime</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621687718027"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621687718492"><span class="hs-identifier hs-var">eventQueueTime</span></a></span><span>
</span><span id="line-489"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; io ()
forall a. IO a -&gt; io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-490"></span><span>        </span><span class="annot"><span class="annottext">(IO () -&gt; io ()) -&gt; IO () -&gt; io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; HistogramVector (Maybe DynamicEventTriggerLabel)
-&gt; DynamicEventTriggerLabel
-&gt; Double
-&gt; IO ()
forall l (m :: * -&gt; *).
(Ord l, MonadIO m) =&gt;
IO GranularPrometheusMetricsState
-&gt; Bool -&gt; HistogramVector (Maybe l) -&gt; l -&gt; Double -&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#observeHistogramWithLabel"><span class="hs-identifier hs-var">observeHistogramWithLabel</span></a></span><span>
</span><span id="line-491"></span><span>          </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718489"><span class="hs-identifier hs-var">getPrometheusMetricsGranularity</span></a></span><span>
</span><span id="line-492"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-493"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics
-&gt; HistogramVector (Maybe DynamicEventTriggerLabel)
</span><a href="Hasura.Server.Prometheus.html#eventQueueTimeSeconds"><span class="hs-identifier hs-var">eventQueueTimeSeconds</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SourceName -&gt; DynamicEventTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicEventTriggerLabel"><span class="hs-identifier hs-var">DynamicEventTriggerLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#tmName"><span class="hs-identifier hs-var">tmName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; TriggerMetadata
forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718487"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>          </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621687718492"><span class="hs-identifier hs-var">eventQueueTime</span></a></span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span>      </span><span id="local-6989586621687718499"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621687718499"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO SchemaCache -&gt; io SchemaCache
forall a. IO a -&gt; io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO SchemaCache
</span><a href="#local-6989586621687718021"><span class="hs-identifier hs-var">getSchemaCache</span></a></span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span>      </span><span id="local-6989586621687718500"><span class="annot"><span class="annottext">Text -&gt; io () -&gt; io ()
</span><a href="#local-6989586621687718500"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-500"></span><span>        </span><span class="annot"><span class="annottext">Value -&gt; io (Maybe TraceContext)
forall (io :: * -&gt; *).
MonadIO io =&gt;
Value -&gt; io (Maybe TraceContext)
</span><a href="#local-6989586621687718225"><span class="hs-identifier hs-var">extractEventContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; Value
forall (b :: BackendType). Event b -&gt; Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eEvent"><span class="hs-identifier hs-var">eEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">io (Maybe TraceContext)
-&gt; (Maybe TraceContext -&gt; Text -&gt; io () -&gt; io ())
-&gt; io (Text -&gt; io () -&gt; io ())
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-501"></span><span>          </span><span class="annot"><span class="annottext">Maybe TraceContext
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SamplingPolicy -&gt; Text -&gt; io () -&gt; io ()
forall (m :: * -&gt; *) a.
(MonadIO m, MonadTrace m) =&gt;
SamplingPolicy -&gt; Text -&gt; m a -&gt; m a
</span><a href="Hasura.Tracing.Class.html#newTrace"><span class="hs-identifier hs-var">Tracing.newTrace</span></a></span><span> </span><span class="annot"><span class="annottext">SamplingPolicy
</span><a href="Hasura.Tracing.Sampling.html#sampleAlways"><span class="hs-identifier hs-var">Tracing.sampleAlways</span></a></span><span>
</span><span id="line-502"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621687718505"><span class="annot"><span class="annottext">TraceContext
</span><a href="#local-6989586621687718505"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TraceContext -&gt; SamplingPolicy -&gt; Text -&gt; io () -&gt; io ()
forall a. TraceContext -&gt; SamplingPolicy -&gt; Text -&gt; io a -&gt; io a
forall (m :: * -&gt; *) a.
MonadTrace m =&gt;
TraceContext -&gt; SamplingPolicy -&gt; Text -&gt; m a -&gt; m a
</span><a href="Hasura.Tracing.Class.html#newTraceWith"><span class="hs-identifier hs-var">Tracing.newTraceWith</span></a></span><span> </span><span class="annot"><span class="annottext">TraceContext
</span><a href="#local-6989586621687718505"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">SamplingPolicy
</span><a href="Hasura.Tracing.Sampling.html#sampleAlways"><span class="hs-identifier hs-var">Tracing.sampleAlways</span></a></span><span>
</span><span id="line-503"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718509"><span class="annot"><span class="annottext">spanName :: EventTriggerInfo b -&gt; Text
</span><a href="#local-6989586621687718509"><span class="hs-identifier hs-var hs-var">spanName</span></a></span></span><span> </span><span id="local-6989586621687718510"><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718510"><span class="hs-identifier hs-var">eti</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Event trigger: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">NonEmptyText -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.NonEmpty.html#unNonEmptyText"><span class="hs-identifier hs-var">unNonEmptyText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; NonEmptyText
</span><a href="Hasura.RQL.Types.EventTrigger.html#unTriggerName"><span class="hs-identifier hs-var">unTriggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; TriggerName
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718510"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span>      </span><span id="local-6989586621687718514"><span class="annot"><span class="annottext">Either QErr (MaintenanceMode MaintenanceModeVersion)
</span><a href="#local-6989586621687718514"><span class="hs-identifier hs-var">maintenanceModeVersionEither</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-506"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621687718029"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-507"></span><span>          </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-508"></span><span>            </span><span class="annot"><span class="annottext">ExceptT QErr io MaintenanceModeVersion
-&gt; io (Either QErr MaintenanceModeVersion)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b -&gt; m MaintenanceModeVersion
</span><a href="Hasura.Eventing.Backend.html#getMaintenanceModeVersion"><span class="hs-identifier hs-var">getMaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687716661"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718486"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">io (Either QErr MaintenanceModeVersion)
-&gt; (Either QErr MaintenanceModeVersion
    -&gt; Either QErr (MaintenanceMode MaintenanceModeVersion))
-&gt; io (Either QErr (MaintenanceMode MaintenanceModeVersion))
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-509"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687718517"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687718517"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Either QErr (MaintenanceMode MaintenanceModeVersion)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687718517"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-510"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687718518"><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="#local-6989586621687718518"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
-&gt; Either QErr (MaintenanceMode MaintenanceModeVersion)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(MaintenanceMode MaintenanceModeVersion
 -&gt; Either QErr (MaintenanceMode MaintenanceModeVersion))
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; Either QErr (MaintenanceMode MaintenanceModeVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaintenanceModeVersion -&gt; MaintenanceMode MaintenanceModeVersion
forall a. a -&gt; MaintenanceMode a
</span><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-var">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="#local-6989586621687718518"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>          </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either QErr (MaintenanceMode MaintenanceModeVersion)
-&gt; io (Either QErr (MaintenanceMode MaintenanceModeVersion))
forall a. a -&gt; io a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr (MaintenanceMode MaintenanceModeVersion)
 -&gt; io (Either QErr (MaintenanceMode MaintenanceModeVersion)))
-&gt; Either QErr (MaintenanceMode MaintenanceModeVersion)
-&gt; io (Either QErr (MaintenanceMode MaintenanceModeVersion))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
-&gt; Either QErr (MaintenanceMode MaintenanceModeVersion)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
forall a. MaintenanceMode a
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr (MaintenanceMode MaintenanceModeVersion)
</span><a href="#local-6989586621687718514"><span class="hs-identifier hs-var">maintenanceModeVersionEither</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-514"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687718520"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687718520"><span class="hs-identifier hs-var">maintenanceModeVersionErr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687718520"><span class="hs-identifier hs-var">maintenanceModeVersionErr</span></a></span><span>
</span><span id="line-515"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687718521"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687718521"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-516"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; Event b -&gt; Either Text (EventTriggerInfo b)
forall (b :: BackendType).
Backend b =&gt;
SchemaCache -&gt; Event b -&gt; Either Text (EventTriggerInfo b)
</span><a href="Hasura.Eventing.EventTrigger.html#getEventTriggerInfoFromEvent"><span class="hs-identifier hs-var">getEventTriggerInfoFromEvent</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621687718499"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-517"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687718523"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687718523"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-518"></span><span>              </span><span class="hs-comment">--  This rare error can happen in the following known cases:</span><span>
</span><span id="line-519"></span><span>              </span><span class="hs-comment">--  i) schema cache is not up-to-date (due to some bug, say during schema syncing across multiple instances)</span><span>
</span><span id="line-520"></span><span>              </span><span class="hs-comment">--  ii) the event trigger is dropped when this event was just fetched</span><span>
</span><span id="line-521"></span><span>              </span><span class="annot"><span class="annottext">QErr -&gt; io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span> </span><span class="annot"><span class="annottext">(QErr -&gt; io ()) -&gt; QErr -&gt; io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#err500"><span class="hs-identifier hs-var">err500</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#Unexpected"><span class="hs-identifier hs-var">Unexpected</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687718523"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-522"></span><span>              </span><span id="local-6989586621687718526"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718526"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; io UTCTime
forall a. IO a -&gt; io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-523"></span><span>              </span><span class="hs-comment">-- For such an event, we unlock the event and retry after a minute</span><span>
</span><span id="line-524"></span><span>              </span><span class="annot"><span class="annottext">ExceptT QErr io () -&gt; io (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceConfig b
-&gt; Event b
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; ExceptT QErr io ()
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m ()
forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m ()
</span><a href="Hasura.Eventing.Backend.html#setRetry"><span class="hs-identifier hs-var">setRetry</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718486"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NominalDiffTime -&gt; UTCTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">addUTCTime</span></span><span> </span><span class="annot"><span class="annottext">NominalDiffTime
</span><span class="hs-number">60</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718526"><span class="hs-identifier hs-var">currentTime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687718521"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-525"></span><span>                </span><span class="annot"><span class="annottext">io (Either QErr ()) -&gt; (Either QErr () -&gt; io ()) -&gt; io ()
forall a b. io a -&gt; (a -&gt; io b) -&gt; io b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ())
-&gt; (QErr -&gt; io ()) -&gt; Either QErr () -&gt; io ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-526"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687718530"><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; io () -&gt; io ()
</span><a href="#local-6989586621687718500"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; Text
forall {b :: BackendType}. EventTriggerInfo b -&gt; Text
</span><a href="#local-6989586621687718509"><span class="hs-identifier hs-var">spanName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718531"><span class="annot"><span class="annottext">webhook :: EnvRecord ResolvedWebhook
</span><a href="#local-6989586621687718531"><span class="hs-identifier hs-var hs-var">webhook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WebhookConfInfo -&gt; EnvRecord ResolvedWebhook
</span><a href="Hasura.RQL.Types.EventTrigger.html#wciCachedValue"><span class="hs-identifier hs-var">wciCachedValue</span></a></span><span> </span><span class="annot"><span class="annottext">(WebhookConfInfo -&gt; EnvRecord ResolvedWebhook)
-&gt; WebhookConfInfo -&gt; EnvRecord ResolvedWebhook
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; WebhookConfInfo
forall (b :: BackendType). EventTriggerInfo b -&gt; WebhookConfInfo
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiWebhookInfo"><span class="hs-identifier hs-var">etiWebhookInfo</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-528"></span><span>                  </span><span id="local-6989586621687718534"><span class="annot"><span class="annottext">retryConf :: RetryConf
</span><a href="#local-6989586621687718534"><span class="hs-identifier hs-var hs-var">retryConf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; RetryConf
forall (b :: BackendType). EventTriggerInfo b -&gt; RetryConf
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiRetryConf"><span class="hs-identifier hs-var">etiRetryConf</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-529"></span><span>                  </span><span id="local-6989586621687718536"><span class="annot"><span class="annottext">timeoutSeconds :: Int
</span><a href="#local-6989586621687718536"><span class="hs-identifier hs-var hs-var">timeoutSeconds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#defaultTimeoutSeconds"><span class="hs-identifier hs-var">defaultTimeoutSeconds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RetryConf -&gt; Maybe Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcTimeoutSec"><span class="hs-identifier hs-var">rcTimeoutSec</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718534"><span class="hs-identifier hs-var">retryConf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>                  </span><span id="local-6989586621687718540"><span class="annot"><span class="annottext">httpTimeout :: ResponseTimeout
</span><a href="#local-6989586621687718540"><span class="hs-identifier hs-var hs-var">httpTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ResponseTimeout
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/http-client-0.7.13.1-88628f48a025e46598ca658ea231eb27d6340417f49e950fbf8c438edb3ebbdc/share/doc/html/src/Network.HTTP.Client.html#responseTimeoutMicro"><span class="hs-identifier hs-var">HTTP.responseTimeoutMicro</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718536"><span class="hs-identifier hs-var">timeoutSeconds</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000000</span></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621687718543"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621687718543"><span class="hs-identifier hs-var">headers</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687718544"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718544"><span class="hs-identifier hs-var">logHeaders</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EventHeaderInfo] -&gt; ([Header], [HeaderConf])
</span><a href="Hasura.Eventing.HTTP.html#prepareHeaders"><span class="hs-identifier hs-var">prepareHeaders</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; [EventHeaderInfo]
forall (b :: BackendType). EventTriggerInfo b -&gt; [EventHeaderInfo]
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiHeaders"><span class="hs-identifier hs-var">etiHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>                  </span><span id="local-6989586621687718547"><span class="annot"><span class="annottext">ep :: EventPayload b
</span><a href="#local-6989586621687718547"><span class="hs-identifier hs-var hs-var">ep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetryConf -&gt; Event b -&gt; EventPayload b
forall (b :: BackendType). RetryConf -&gt; Event b -&gt; EventPayload b
</span><a href="Hasura.Eventing.EventTrigger.html#createEventPayload"><span class="hs-identifier hs-var">createEventPayload</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718534"><span class="hs-identifier hs-var">retryConf</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-533"></span><span>                  </span><span id="local-6989586621687718549"><span class="annot"><span class="annottext">payload :: ByteString
</span><a href="#local-6989586621687718549"><span class="hs-identifier hs-var hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.html#encode"><span class="hs-identifier hs-var">J.encode</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; ByteString) -&gt; Value -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventPayload b -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">J.toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">EventPayload b
</span><a href="#local-6989586621687718547"><span class="hs-identifier hs-var">ep</span></a></span><span>
</span><span id="line-534"></span><span>                  </span><span id="local-6989586621687718551"><span class="annot"><span class="annottext">extraLogCtx :: ExtraLogContext
</span><a href="#local-6989586621687718551"><span class="hs-identifier hs-var hs-var">extraLogCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Maybe TriggerName -&gt; ExtraLogContext
</span><a href="Hasura.Eventing.HTTP.html#ExtraLogContext"><span class="hs-identifier hs-var">ExtraLogContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventPayload b -&gt; EventId
forall (b :: BackendType). EventPayload b -&gt; EventId
</span><a href="Hasura.Eventing.EventTrigger.html#epId"><span class="hs-identifier hs-var">epId</span></a></span><span> </span><span class="annot"><span class="annottext">EventPayload b
</span><a href="#local-6989586621687718547"><span class="hs-identifier hs-var">ep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; Maybe TriggerName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TriggerName -&gt; Maybe TriggerName)
-&gt; TriggerName -&gt; Maybe TriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; TriggerName
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>                  </span><span id="local-6989586621687718553"><span class="annot"><span class="annottext">requestTransform :: Maybe RequestTransform
</span><a href="#local-6989586621687718553"><span class="hs-identifier hs-var hs-var">requestTransform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; Maybe RequestTransform
forall (b :: BackendType).
EventTriggerInfo b -&gt; Maybe RequestTransform
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiRequestTransform"><span class="hs-identifier hs-var">etiRequestTransform</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-536"></span><span>                  </span><span id="local-6989586621687718555"><span class="annot"><span class="annottext">responseTransform :: Maybe ResponseTransform
</span><a href="#local-6989586621687718555"><span class="hs-identifier hs-var hs-var">responseTransform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataResponseTransform -&gt; ResponseTransform
</span><a href="Hasura.RQL.DDL.Webhook.Transform.html#mkResponseTransform"><span class="hs-identifier hs-var">mkResponseTransform</span></a></span><span> </span><span class="annot"><span class="annottext">(MetadataResponseTransform -&gt; ResponseTransform)
-&gt; Maybe MetadataResponseTransform -&gt; Maybe ResponseTransform
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; Maybe MetadataResponseTransform
forall (b :: BackendType).
EventTriggerInfo b -&gt; Maybe MetadataResponseTransform
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiResponseTransform"><span class="hs-identifier hs-var">etiResponseTransform</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-537"></span><span>                  </span><span id="local-6989586621687718558"><span class="annot"><span class="annottext">eventTriggerProcessingTimeout :: DiffTime
</span><a href="#local-6989586621687718558"><span class="hs-identifier hs-var hs-var">eventTriggerProcessingTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; (Int -&gt; DiffTime) -&gt; Maybe Int -&gt; DiffTime
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#upperBoundEventTriggerTimeout"><span class="hs-identifier hs-var">upperBoundEventTriggerTimeout</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; DiffTime
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#upperBoundEventTriggerTimeout"><span class="hs-identifier hs-var">upperBoundEventTriggerTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; DiffTime) -&gt; (Int -&gt; DiffTime) -&gt; Int -&gt; DiffTime
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; DiffTime
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RetryConf -&gt; Maybe Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcTimeoutSec"><span class="hs-identifier hs-var">rcTimeoutSec</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718534"><span class="hs-identifier hs-var">retryConf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>                  </span><span id="local-6989586621687718561"><span class="annot"><span class="annottext">eventTriggerProcessAction :: io ()
</span><a href="#local-6989586621687718561"><span class="hs-identifier hs-var hs-var">eventTriggerProcessAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>                    </span><span id="local-6989586621687718562"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718562"><span class="hs-identifier hs-var">eventExecutionStartTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; io UTCTime
forall a. IO a -&gt; io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-540"></span><span>                    </span><span id="local-6989586621687718563"><span class="annot"><span class="annottext">Either
  (TransformableRequestError 'EventType)
  (Request, HTTPResp 'EventType)
</span><a href="#local-6989586621687718563"><span class="hs-identifier hs-var">eitherReqRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-541"></span><span>                      </span><span class="annot"><span class="annottext">ExceptT
  (TransformableRequestError 'EventType)
  io
  (Request, HTTPResp 'EventType)
-&gt; io
     (Either
        (TransformableRequestError 'EventType)
        (Request, HTTPResp 'EventType))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span>
</span><span id="line-542"></span><span>                        </span><span class="annot"><span class="annottext">(ExceptT
   (TransformableRequestError 'EventType)
   io
   (Request, HTTPResp 'EventType)
 -&gt; io
      (Either
         (TransformableRequestError 'EventType)
         (Request, HTTPResp 'EventType)))
-&gt; ExceptT
     (TransformableRequestError 'EventType)
     io
     (Request, HTTPResp 'EventType)
-&gt; io
     (Either
        (TransformableRequestError 'EventType)
        (Request, HTTPResp 'EventType))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Header]
-&gt; ResponseTimeout
-&gt; ByteString
-&gt; Maybe RequestTransform
-&gt; ResolvedWebhook
-&gt; ExceptT (TransformableRequestError 'EventType) io RequestDetails
forall (a :: TriggerTypes) (m :: * -&gt; *).
MonadError (TransformableRequestError a) m =&gt;
[Header]
-&gt; ResponseTimeout
-&gt; ByteString
-&gt; Maybe RequestTransform
-&gt; ResolvedWebhook
-&gt; m RequestDetails
</span><a href="Hasura.Eventing.HTTP.html#mkRequest"><span class="hs-identifier hs-var">mkRequest</span></a></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621687718543"><span class="hs-identifier hs-var">headers</span></a></span><span> </span><span class="annot"><span class="annottext">ResponseTimeout
</span><a href="#local-6989586621687718540"><span class="hs-identifier hs-var">httpTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687718549"><span class="hs-identifier hs-var">payload</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe RequestTransform
</span><a href="#local-6989586621687718553"><span class="hs-identifier hs-var">requestTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EnvRecord ResolvedWebhook -&gt; ResolvedWebhook
forall a. EnvRecord a -&gt; a
</span><a href="Hasura.RQL.Types.Common.html#_envVarValue"><span class="hs-identifier hs-var">_envVarValue</span></a></span><span> </span><span class="annot"><span class="annottext">EnvRecord ResolvedWebhook
</span><a href="#local-6989586621687718531"><span class="hs-identifier hs-var">webhook</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-543"></span><span>                        </span><span class="annot"><span class="annottext">ExceptT (TransformableRequestError 'EventType) io RequestDetails
-&gt; (RequestDetails
    -&gt; ExceptT
         (TransformableRequestError 'EventType)
         io
         (Request, HTTPResp 'EventType))
-&gt; ExceptT
     (TransformableRequestError 'EventType)
     io
     (Request, HTTPResp 'EventType)
forall a b.
ExceptT (TransformableRequestError 'EventType) io a
-&gt; (a -&gt; ExceptT (TransformableRequestError 'EventType) io b)
-&gt; ExceptT (TransformableRequestError 'EventType) io b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687718566"><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621687718566"><span class="hs-identifier hs-var">reqDetails</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-544"></span><span>                          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718567"><span class="annot"><span class="annottext">request :: Request
</span><a href="#local-6989586621687718567"><span class="hs-identifier hs-var hs-var">request</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RequestDetails -&gt; Request
</span><a href="Hasura.Eventing.HTTP.html#extractRequest"><span class="hs-identifier hs-var">extractRequest</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621687718566"><span class="hs-identifier hs-var">reqDetails</span></a></span><span>
</span><span id="line-545"></span><span>                              </span><span id="local-6989586621687718569"><span class="annot"><span class="annottext">logger' :: Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; RequestDetails
-&gt; ExceptT (TransformableRequestError 'EventType) io ()
</span><a href="#local-6989586621687718569"><span class="hs-identifier hs-var hs-var">logger'</span></a></span></span><span> </span><span id="local-6989586621687718570"><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
</span><a href="#local-6989586621687718570"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span id="local-6989586621687718571"><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621687718571"><span class="hs-identifier hs-var">details</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-546"></span><span>                                </span><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; ExtraLogContext
-&gt; RequestDetails
-&gt; Text
-&gt; [HeaderConf]
-&gt; TriggersErrorLogLevelStatus
-&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; ExtraLogContext
-&gt; RequestDetails
-&gt; Text
-&gt; [HeaderConf]
-&gt; TriggersErrorLogLevelStatus
-&gt; m ()
</span><a href="Hasura.Eventing.HTTP.html#logHTTPForET"><span class="hs-identifier hs-var">logHTTPForET</span></a></span><span> </span><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
</span><a href="#local-6989586621687718570"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">ExtraLogContext
</span><a href="#local-6989586621687718551"><span class="hs-identifier hs-var">extraLogCtx</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621687718571"><span class="hs-identifier hs-var">details</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EnvRecord ResolvedWebhook -&gt; Text
forall a. EnvRecord a -&gt; Text
</span><a href="Hasura.RQL.Types.Common.html#_envVarName"><span class="hs-identifier hs-var">_envVarName</span></a></span><span> </span><span class="annot"><span class="annottext">EnvRecord ResolvedWebhook
</span><a href="#local-6989586621687718531"><span class="hs-identifier hs-var">webhook</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718544"><span class="hs-identifier hs-var">logHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">TriggersErrorLogLevelStatus
</span><a href="#local-6989586621687718030"><span class="hs-identifier hs-var">triggersErrorLogLevelStatus</span></a></span><span>
</span><span id="line-547"></span><span>                                </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall a.
IO a -&gt; ExceptT (TransformableRequestError 'EventType) io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ())
-&gt; IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>                                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
</span><a href="#local-6989586621687718570"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-549"></span><span>                                    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687718574"><span class="annot"><span class="annottext">HTTPErr 'EventType
</span><a href="#local-6989586621687718574"><span class="hs-identifier hs-var">_err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>                                    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687718575"><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621687718575"><span class="hs-identifier hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-551"></span><span>                                      </span><span class="annot"><span class="annottext">Counter -&gt; Int64 -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Counter.html#add"><span class="hs-identifier hs-var">Prometheus.Counter.add</span></a></span><span>
</span><span id="line-552"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Counter
</span><a href="Hasura.Server.Prometheus.html#eventTriggerBytesReceived"><span class="hs-identifier hs-var">eventTriggerBytesReceived</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HTTPResp 'EventType -&gt; Int64
forall (a :: TriggerTypes). HTTPResp a -&gt; Int64
</span><a href="Hasura.Eventing.HTTP.html#hrsSize"><span class="hs-identifier hs-var">hrsSize</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621687718575"><span class="hs-identifier hs-var">response</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-554"></span><span>                                  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#RequestDetails"><span class="hs-identifier hs-type">RequestDetails</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687718580"><span class="annot"><span class="annottext">Int64
_rdOriginalSize :: Int64
_rdOriginalSize :: RequestDetails -&gt; Int64
</span><a href="#local-6989586621687718580"><span class="hs-identifier hs-var hs-var">_rdOriginalSize</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687718582"><span class="annot"><span class="annottext">Maybe Int64
_rdTransformedSize :: Maybe Int64
_rdTransformedSize :: RequestDetails -&gt; Maybe Int64
</span><a href="#local-6989586621687718582"><span class="hs-identifier hs-var hs-var">_rdTransformedSize</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621687718571"><span class="hs-identifier hs-var">details</span></a></span><span>
</span><span id="line-555"></span><span>                                   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Counter -&gt; Int64 -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Counter.html#add"><span class="hs-identifier hs-var">Prometheus.Counter.add</span></a></span><span>
</span><span id="line-556"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Counter
</span><a href="Hasura.Server.Prometheus.html#eventTriggerBytesSent"><span class="hs-identifier hs-var">eventTriggerBytesSent</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; Maybe Int64 -&gt; Int64
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621687718580"><span class="hs-identifier hs-var">_rdOriginalSize</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int64
</span><a href="#local-6989586621687718582"><span class="hs-identifier hs-var">_rdTransformedSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-558"></span><span>                          </span><span class="hs-comment">-- Event Triggers have a configuration parameter called</span><span>
</span><span id="line-559"></span><span>                          </span><span class="hs-comment">-- HASURA_GRAPHQL_EVENTS_HTTP_WORKERS, which is used</span><span>
</span><span id="line-560"></span><span>                          </span><span class="hs-comment">-- to control the concurrency of http delivery.</span><span>
</span><span id="line-561"></span><span>                          </span><span class="hs-comment">-- This bracket is used to increment and decrement an</span><span>
</span><span id="line-562"></span><span>                          </span><span class="hs-comment">-- HTTP Worker EKG Gauge for the duration of the</span><span>
</span><span id="line-563"></span><span>                          </span><span class="hs-comment">-- request invocation</span><span>
</span><span id="line-564"></span><span>                          </span><span id="local-6989586621687718585"><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621687718585"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-565"></span><span>                            </span><span class="annot"><span class="annottext">ExceptT (TransformableRequestError 'EventType) io ()
-&gt; ExceptT (TransformableRequestError 'EventType) io ()
-&gt; ExceptT
     (TransformableRequestError 'EventType) io (HTTPResp 'EventType)
-&gt; ExceptT
     (TransformableRequestError 'EventType) io (HTTPResp 'EventType)
forall (m :: * -&gt; *) a c b. MonadMask m =&gt; m a -&gt; m c -&gt; m b -&gt; m b
</span><span class="hs-identifier hs-var">bracket_</span></span><span>
</span><span id="line-566"></span><span>                              </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-567"></span><span>                                  </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall a.
IO a -&gt; ExceptT (TransformableRequestError 'EventType) io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ())
-&gt; IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html#inc"><span class="hs-identifier hs-var">EKG.Gauge.inc</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smNumEventHTTPWorkers"><span class="hs-identifier hs-var">smNumEventHTTPWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621687718027"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-568"></span><span>                                  </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall a.
IO a -&gt; ExceptT (TransformableRequestError 'EventType) io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ())
-&gt; IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#inc"><span class="hs-identifier hs-var">Prometheus.Gauge.inc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#eventTriggerHTTPWorkers"><span class="hs-identifier hs-var">eventTriggerHTTPWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-569"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>                              </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-571"></span><span>                                  </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall a.
IO a -&gt; ExceptT (TransformableRequestError 'EventType) io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ())
-&gt; IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html#dec"><span class="hs-identifier hs-var">EKG.Gauge.dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smNumEventHTTPWorkers"><span class="hs-identifier hs-var">smNumEventHTTPWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621687718027"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-572"></span><span>                                  </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall a.
IO a -&gt; ExceptT (TransformableRequestError 'EventType) io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ())
-&gt; IO () -&gt; ExceptT (TransformableRequestError 'EventType) io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#dec"><span class="hs-identifier hs-var">Prometheus.Gauge.dec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#eventTriggerHTTPWorkers"><span class="hs-identifier hs-var">eventTriggerHTTPWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-574"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestDetails
-&gt; Maybe ResponseTransform
-&gt; Maybe SessionVariables
-&gt; (Either (HTTPErr 'EventType) (HTTPResp 'EventType)
    -&gt; RequestDetails
    -&gt; ExceptT (TransformableRequestError 'EventType) io ())
-&gt; ExceptT
     (TransformableRequestError 'EventType) io (HTTPResp 'EventType)
forall r (m :: * -&gt; *) (a :: TriggerTypes).
(MonadReader r m, MonadError (TransformableRequestError a) m,
 Has Manager r, Has (Logger Hasura) r, MonadIO m, MonadTrace m) =&gt;
RequestDetails
-&gt; Maybe ResponseTransform
-&gt; Maybe SessionVariables
-&gt; (Either (HTTPErr a) (HTTPResp a) -&gt; RequestDetails -&gt; m ())
-&gt; m (HTTPResp a)
</span><a href="Hasura.Eventing.HTTP.html#invokeRequest"><span class="hs-identifier hs-var">invokeRequest</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621687718566"><span class="hs-identifier hs-var">reqDetails</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseTransform
</span><a href="#local-6989586621687718555"><span class="hs-identifier hs-var">responseTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestDetails -&gt; Maybe SessionVariables
</span><a href="Hasura.Eventing.HTTP.html#_rdSessionVars"><span class="hs-identifier hs-var">_rdSessionVars</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621687718566"><span class="hs-identifier hs-var">reqDetails</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; RequestDetails
-&gt; ExceptT (TransformableRequestError 'EventType) io ()
</span><a href="#local-6989586621687718569"><span class="hs-identifier hs-var">logger'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>                          </span><span class="annot"><span class="annottext">(Request, HTTPResp 'EventType)
-&gt; ExceptT
     (TransformableRequestError 'EventType)
     io
     (Request, HTTPResp 'EventType)
forall a. a -&gt; ExceptT (TransformableRequestError 'EventType) io a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621687718567"><span class="hs-identifier hs-var">request</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621687718585"><span class="hs-identifier hs-var">resp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (TransformableRequestError 'EventType)
  (Request, HTTPResp 'EventType)
</span><a href="#local-6989586621687718563"><span class="hs-identifier hs-var">eitherReqRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-577"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687718594"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621687718594"><span class="hs-identifier hs-var">req</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687718595"><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621687718595"><span class="hs-identifier hs-var">resp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-578"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718596"><span class="annot"><span class="annottext">reqBody :: Value
</span><a href="#local-6989586621687718596"><span class="hs-identifier hs-var hs-var">reqBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value -&gt; Value
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#Null"><span class="hs-identifier hs-var">J.Null</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Value -&gt; Value) -&gt; Maybe Value -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Getting (First ByteString) Request ByteString
-&gt; Request -&gt; Maybe ByteString
forall s (m :: * -&gt; *) a.
MonadReader s m =&gt;
Getting (First a) s a -&gt; m (Maybe a)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.Fold.html#preview"><span class="hs-identifier hs-var">preview</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RequestBody -&gt; Const (First ByteString) RequestBody)
-&gt; Request -&gt; Const (First ByteString) Request
Lens' Request RequestBody
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Network.HTTP.Client.Transformable.html#body"><span class="hs-identifier hs-var">HTTP.body</span></a></span><span> </span><span class="annot"><span class="annottext">((RequestBody -&gt; Const (First ByteString) RequestBody)
 -&gt; Request -&gt; Const (First ByteString) Request)
-&gt; ((ByteString -&gt; Const (First ByteString) ByteString)
    -&gt; RequestBody -&gt; Const (First ByteString) RequestBody)
-&gt; Getting (First ByteString) Request ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Const (First ByteString) ByteString)
-&gt; RequestBody -&gt; Const (First ByteString) RequestBody
Prism' RequestBody ByteString
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Network.HTTP.Client.Transformable.html#_RequestBodyLBS"><span class="hs-identifier hs-var">HTTP._RequestBodyLBS</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621687718594"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; (ByteString -&gt; Maybe Value) -&gt; Maybe Value
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. FromJSON a =&gt; ByteString -&gt; Maybe a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.html#decode"><span class="hs-identifier hs-var">J.decode</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span>
</span><span id="line-579"></span><span>                        </span><span class="annot"><span class="annottext">SourceConfig b
-&gt; Event b
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPResp 'EventType
-&gt; io (Either QErr ())
forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b) =&gt;
SourceConfig b
-&gt; Event b
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPResp a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processSuccess"><span class="hs-identifier hs-var">processSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718486"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718544"><span class="hs-identifier hs-var">logHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718596"><span class="hs-identifier hs-var">reqBody</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687718521"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621687718595"><span class="hs-identifier hs-var">resp</span></a></span><span> </span><span class="annot"><span class="annottext">io (Either QErr ()) -&gt; (Either QErr () -&gt; io ()) -&gt; io ()
forall a b. io a -&gt; (a -&gt; io b) -&gt; io b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ())
-&gt; (QErr -&gt; io ()) -&gt; Either QErr () -&gt; io ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-580"></span><span>                        </span><span id="local-6989586621687718603"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718603"><span class="hs-identifier hs-var">eventExecutionFinishTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; io UTCTime
forall a. IO a -&gt; io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-581"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718604"><span class="annot"><span class="annottext">eventWebhookProcessingTime' :: Double
</span><a href="#local-6989586621687718604"><span class="hs-identifier hs-var hs-var">eventWebhookProcessingTime'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; Double
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; Double) -&gt; NominalDiffTime -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">diffUTCTime</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718603"><span class="hs-identifier hs-var">eventExecutionFinishTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718562"><span class="hs-identifier hs-var">eventExecutionStartTime</span></a></span><span>
</span><span id="line-582"></span><span>                            </span><span class="hs-comment">-- For event_processing_time, the start time is defined as the expected delivery time for an event, i.e.:</span><span>
</span><span id="line-583"></span><span>                            </span><span class="hs-comment">--  - For event with no retries: created_at (at UTC) time</span><span>
</span><span id="line-584"></span><span>                            </span><span class="hs-comment">--  - For event with retries: next_retry_at (at UTC) time</span><span>
</span><span id="line-585"></span><span>
</span><span id="line-586"></span><span>                            </span><span class="hs-comment">-- The timestamps in the DB are supposed to be UTC time, so the timestamps (`eventExecutionFinishTime` and</span><span>
</span><span id="line-587"></span><span>                            </span><span class="hs-comment">-- `eventStartTime`) used here in calculation are all UTC time.</span><span>
</span><span id="line-588"></span><span>                            </span><span id="local-6989586621687718605"><span class="annot"><span class="annottext">eventStartTime :: UTCTime
</span><a href="#local-6989586621687718605"><span class="hs-identifier hs-var hs-var">eventStartTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; Maybe UTCTime -&gt; UTCTime
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; UTCTime
forall (b :: BackendType). Event b -&gt; UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eCreatedAtUTC"><span class="hs-identifier hs-var">eCreatedAtUTC</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; Maybe UTCTime
forall (b :: BackendType). Event b -&gt; Maybe UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eRetryAtUTC"><span class="hs-identifier hs-var">eRetryAtUTC</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-589"></span><span>                            </span><span id="local-6989586621687718608"><span class="annot"><span class="annottext">eventProcessingTime' :: Double
</span><a href="#local-6989586621687718608"><span class="hs-identifier hs-var hs-var">eventProcessingTime'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; Double
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; Double) -&gt; NominalDiffTime -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">diffUTCTime</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718603"><span class="hs-identifier hs-var">eventExecutionFinishTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718605"><span class="hs-identifier hs-var">eventStartTime</span></a></span><span>
</span><span id="line-590"></span><span>                        </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; HistogramVector (Maybe DynamicEventTriggerLabel)
-&gt; DynamicEventTriggerLabel
-&gt; Double
-&gt; io ()
forall l (m :: * -&gt; *).
(Ord l, MonadIO m) =&gt;
IO GranularPrometheusMetricsState
-&gt; Bool -&gt; HistogramVector (Maybe l) -&gt; l -&gt; Double -&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#observeHistogramWithLabel"><span class="hs-identifier hs-var">observeHistogramWithLabel</span></a></span><span>
</span><span id="line-591"></span><span>                          </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718489"><span class="hs-identifier hs-var">getPrometheusMetricsGranularity</span></a></span><span>
</span><span id="line-592"></span><span>                          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-593"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics
-&gt; HistogramVector (Maybe DynamicEventTriggerLabel)
</span><a href="Hasura.Server.Prometheus.html#eventProcessingTime"><span class="hs-identifier hs-var">eventProcessingTime</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-594"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SourceName -&gt; DynamicEventTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicEventTriggerLabel"><span class="hs-identifier hs-var">DynamicEventTriggerLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; TriggerName
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718487"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>                          </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621687718608"><span class="hs-identifier hs-var">eventProcessingTime'</span></a></span><span>
</span><span id="line-596"></span><span>                        </span><span class="annot"><span class="annottext">IO () -&gt; io ()
forall a. IO a -&gt; io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; io ()) -&gt; IO () -&gt; io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-597"></span><span>                          </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Distribution.html#add"><span class="hs-identifier hs-var">EKG.Distribution.add</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smEventWebhookProcessingTime"><span class="hs-identifier hs-var">smEventWebhookProcessingTime</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621687718027"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621687718604"><span class="hs-identifier hs-var">eventWebhookProcessingTime'</span></a></span><span>
</span><span id="line-598"></span><span>                          </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; HistogramVector (Maybe DynamicEventTriggerLabel)
-&gt; DynamicEventTriggerLabel
-&gt; Double
-&gt; IO ()
forall l (m :: * -&gt; *).
(Ord l, MonadIO m) =&gt;
IO GranularPrometheusMetricsState
-&gt; Bool -&gt; HistogramVector (Maybe l) -&gt; l -&gt; Double -&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#observeHistogramWithLabel"><span class="hs-identifier hs-var">observeHistogramWithLabel</span></a></span><span>
</span><span id="line-599"></span><span>                            </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718489"><span class="hs-identifier hs-var">getPrometheusMetricsGranularity</span></a></span><span>
</span><span id="line-600"></span><span>                            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-601"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics
-&gt; HistogramVector (Maybe DynamicEventTriggerLabel)
</span><a href="Hasura.Server.Prometheus.html#eventWebhookProcessingTime"><span class="hs-identifier hs-var">eventWebhookProcessingTime</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SourceName -&gt; DynamicEventTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicEventTriggerLabel"><span class="hs-identifier hs-var">DynamicEventTriggerLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; TriggerName
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718487"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span>                            </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621687718604"><span class="hs-identifier hs-var">eventWebhookProcessingTime'</span></a></span><span>
</span><span id="line-604"></span><span>                          </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Distribution.html#add"><span class="hs-identifier hs-var">EKG.Distribution.add</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smEventProcessingTime"><span class="hs-identifier hs-var">smEventProcessingTime</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621687718027"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621687718608"><span class="hs-identifier hs-var">eventProcessingTime'</span></a></span><span>
</span><span id="line-605"></span><span>                          </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel
-&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel
-&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#incEventTriggerCounterWithLabel"><span class="hs-identifier hs-var">incEventTriggerCounterWithLabel</span></a></span><span>
</span><span id="line-606"></span><span>                            </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718489"><span class="hs-identifier hs-var">getPrometheusMetricsGranularity</span></a></span><span>
</span><span id="line-607"></span><span>                            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-608"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; CounterVector EventStatusWithTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#eventProcessedTotal"><span class="hs-identifier hs-var">eventProcessedTotal</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventStatusLabel
-&gt; Maybe DynamicEventTriggerLabel -&gt; EventStatusWithTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#EventStatusWithTriggerLabel"><span class="hs-identifier hs-var">EventStatusWithTriggerLabel</span></a></span><span> </span><span class="annot"><span class="annottext">EventStatusLabel
</span><a href="Hasura.Server.Prometheus.html#eventSuccessLabel"><span class="hs-identifier hs-var">eventSuccessLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynamicEventTriggerLabel -&gt; Maybe DynamicEventTriggerLabel
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SourceName -&gt; DynamicEventTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicEventTriggerLabel"><span class="hs-identifier hs-var">DynamicEventTriggerLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; TriggerName
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718487"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>                          </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel
-&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel
-&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#incEventTriggerCounterWithLabel"><span class="hs-identifier hs-var">incEventTriggerCounterWithLabel</span></a></span><span>
</span><span id="line-611"></span><span>                            </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718489"><span class="hs-identifier hs-var">getPrometheusMetricsGranularity</span></a></span><span>
</span><span id="line-612"></span><span>                            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-613"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; CounterVector EventStatusWithTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#eventInvocationTotal"><span class="hs-identifier hs-var">eventInvocationTotal</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventStatusLabel
-&gt; Maybe DynamicEventTriggerLabel -&gt; EventStatusWithTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#EventStatusWithTriggerLabel"><span class="hs-identifier hs-var">EventStatusWithTriggerLabel</span></a></span><span> </span><span class="annot"><span class="annottext">EventStatusLabel
</span><a href="Hasura.Server.Prometheus.html#eventSuccessLabel"><span class="hs-identifier hs-var">eventSuccessLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynamicEventTriggerLabel -&gt; Maybe DynamicEventTriggerLabel
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SourceName -&gt; DynamicEventTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicEventTriggerLabel"><span class="hs-identifier hs-var">DynamicEventTriggerLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; TriggerName
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718487"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687718618"><span class="annot"><span class="annottext">TransformableRequestError 'EventType
</span><a href="#local-6989586621687718618"><span class="hs-identifier hs-var">eventError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-616"></span><span>                        </span><span class="hs-comment">-- TODO (paritosh): We can also add a label to the metric to indicate the type of error</span><span>
</span><span id="line-617"></span><span>                        </span><span class="annot"><span class="annottext">IO () -&gt; io ()
forall a. IO a -&gt; io a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-618"></span><span>                          </span><span class="annot"><span class="annottext">(IO () -&gt; io ()) -&gt; IO () -&gt; io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel
-&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel
-&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#incEventTriggerCounterWithLabel"><span class="hs-identifier hs-var">incEventTriggerCounterWithLabel</span></a></span><span>
</span><span id="line-619"></span><span>                            </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718489"><span class="hs-identifier hs-var">getPrometheusMetricsGranularity</span></a></span><span>
</span><span id="line-620"></span><span>                            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-621"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; CounterVector EventStatusWithTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#eventInvocationTotal"><span class="hs-identifier hs-var">eventInvocationTotal</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-622"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventStatusLabel
-&gt; Maybe DynamicEventTriggerLabel -&gt; EventStatusWithTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#EventStatusWithTriggerLabel"><span class="hs-identifier hs-var">EventStatusWithTriggerLabel</span></a></span><span> </span><span class="annot"><span class="annottext">EventStatusLabel
</span><a href="Hasura.Server.Prometheus.html#eventFailedLabel"><span class="hs-identifier hs-var">eventFailedLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynamicEventTriggerLabel -&gt; Maybe DynamicEventTriggerLabel
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SourceName -&gt; DynamicEventTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicEventTriggerLabel"><span class="hs-identifier hs-var">DynamicEventTriggerLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; TriggerName
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718487"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-623"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TransformableRequestError 'EventType
</span><a href="#local-6989586621687718618"><span class="hs-identifier hs-var">eventError</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-624"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPError"><span class="hs-identifier hs-type">HTTPError</span></a></span><span> </span><span id="local-6989586621687718621"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718621"><span class="hs-identifier hs-var">reqBody</span></a></span></span><span> </span><span id="local-6989586621687718622"><span class="annot"><span class="annottext">HTTPErr 'EventType
</span><a href="#local-6989586621687718622"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-625"></span><span>                            </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b, MonadGetPolicies m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; RetryConf
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; EventTriggerMetrics
-&gt; HTTPErr a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processError"><span class="hs-identifier hs-var">processError</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687716661"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718486"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718534"><span class="hs-identifier hs-var">retryConf</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718544"><span class="hs-identifier hs-var">logHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718621"><span class="hs-identifier hs-var">reqBody</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687718521"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr 'EventType
</span><a href="#local-6989586621687718622"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">io (Either QErr ()) -&gt; (Either QErr () -&gt; io ()) -&gt; io ()
forall a b. io a -&gt; (a -&gt; io b) -&gt; io b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ())
-&gt; (QErr -&gt; io ()) -&gt; Either QErr () -&gt; io ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-626"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.HTTP.html#TransformationError"><span class="hs-identifier hs-type">TransformationError</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621687718625"><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621687718625"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-627"></span><span>                            </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687718018"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(UnstructuredLog -&gt; io ()) -&gt; UnstructuredLog -&gt; io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; SerializableBlob -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">L.LevelError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; SerializableBlob
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.SerializableBlob.html#fromLBS"><span class="hs-identifier hs-var">SB.fromLBS</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; SerializableBlob) -&gt; ByteString -&gt; SerializableBlob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TransformErrorBundle -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.html#encode"><span class="hs-identifier hs-var">J.encode</span></a></span><span> </span><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621687718625"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-628"></span><span>
</span><span id="line-629"></span><span>                            </span><span class="hs-comment">-- Record an Event Error</span><span>
</span><span id="line-630"></span><span>                            </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.Backend.html#recordError%27"><span class="hs-identifier hs-var">recordError'</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687716661"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718486"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetError"><span class="hs-identifier hs-var">PESetError</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687718521"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">io (Either QErr ()) -&gt; (Either QErr () -&gt; io ()) -&gt; io ()
forall a b. io a -&gt; (a -&gt; io b) -&gt; io b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ())
-&gt; (QErr -&gt; io ()) -&gt; Either QErr () -&gt; io ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-631"></span><span>              </span><span class="hs-comment">-- Try to process the event trigger with a timeout of min(`uppserBoundEventTriggerTimeout`, event's response timeout),</span><span>
</span><span id="line-632"></span><span>              </span><span class="hs-comment">-- so that we're never blocked forever while processing a single event trigger.</span><span>
</span><span id="line-633"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-634"></span><span>              </span><span class="hs-comment">-- If the request times out, then process it as an erroneous invocation and move on.</span><span>
</span><span id="line-635"></span><span>              </span><span class="annot"><span class="annottext">Int -&gt; io () -&gt; io (Maybe ())
forall (m :: * -&gt; *) a.
MonadBaseControl IO m =&gt;
Int -&gt; m a -&gt; m (Maybe a)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lifted-base-0.2.3.12-dda1adedff1e58883d645c3d159e5d196513de2aea81f9a332fe2d42327ade1a/share/doc/html/src/System.Timeout.Lifted.html#timeout"><span class="hs-identifier hs-var">timeout</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Int
forall a. Num a =&gt; Integer -&gt; a
</span><span class="hs-identifier hs-var">fromInteger</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; Integer
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Data.Time.Clock.Units.html#diffTimeToMicroSeconds"><span class="hs-identifier hs-var">diffTimeToMicroSeconds</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687718558"><span class="hs-identifier hs-var">eventTriggerProcessingTimeout</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">io ()
</span><a href="#local-6989586621687718561"><span class="hs-identifier hs-var">eventTriggerProcessAction</span></a></span><span>
</span><span id="line-636"></span><span>                </span><span class="annot"><span class="annottext">io (Maybe ()) -&gt; io () -&gt; io ()
forall (m :: * -&gt; *) a. Monad m =&gt; m (Maybe a) -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onNothingM"><span class="hs-operator hs-var">`onNothingM`</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-637"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718631"><span class="annot"><span class="annottext">eventTriggerTimeoutMessage :: Text
</span><a href="#local-6989586621687718631"><span class="hs-identifier hs-var hs-var">eventTriggerTimeoutMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Event Trigger &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; TriggerName
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621687718530"><span class="hs-identifier hs-var">eti</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; timed out while processing.&quot;</span></span><span>
</span><span id="line-638"></span><span>                      </span><span id="local-6989586621687718633"><span class="annot"><span class="annottext">eventTriggerTimeoutError :: QErr
</span><a href="#local-6989586621687718633"><span class="hs-identifier hs-var hs-var">eventTriggerTimeoutError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#err500"><span class="hs-identifier hs-var">err500</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#TimeoutErrorCode"><span class="hs-identifier hs-var">TimeoutErrorCode</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687718631"><span class="hs-identifier hs-var">eventTriggerTimeoutMessage</span></a></span><span>
</span><span id="line-639"></span><span>                  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687718018"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(EventInternalErr -&gt; io ()) -&gt; EventInternalErr -&gt; io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; EventInternalErr
</span><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687718633"><span class="hs-identifier hs-var">eventTriggerTimeoutError</span></a></span><span>
</span><span id="line-640"></span><span>                  </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b, MonadGetPolicies m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; RetryConf
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; EventTriggerMetrics
-&gt; HTTPErr a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processError"><span class="hs-identifier hs-var">processError</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687716661"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718486"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718534"><span class="hs-identifier hs-var">retryConf</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718544"><span class="hs-identifier hs-var">logHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#Null"><span class="hs-identifier hs-var">J.Null</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687718521"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718028"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; HTTPErr Any
forall (a :: TriggerTypes). String -&gt; HTTPErr a
</span><a href="Hasura.Eventing.HTTP.html#HOther"><span class="hs-identifier hs-var">HOther</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; HTTPErr Any) -&gt; String -&gt; HTTPErr Any
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-d0f6d61f5277bae932134563876cbceb4967915f364959864c72abbc2978d8ed/share/doc/html/src/Data.Text.Show.html#unpack"><span class="hs-identifier hs-var">T.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687718631"><span class="hs-identifier hs-var">eventTriggerTimeoutMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-641"></span><span>                    </span><span class="annot"><span class="annottext">io (Either QErr ()) -&gt; (Either QErr () -&gt; io ()) -&gt; io ()
forall a b. io a -&gt; (a -&gt; io b) -&gt; io b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ())
-&gt; (QErr -&gt; io ()) -&gt; Either QErr () -&gt; io ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span>      </span><span class="hs-comment">-- removing an event from the _eeCtxLockedEvents after the event has been processed:</span><span>
</span><span id="line-644"></span><span>      </span><span class="annot"><span class="annottext">SourceName
-&gt; EventId -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; io ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
SourceName
-&gt; EventId -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier hs-var">removeEventTriggerEventFromLockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687718487"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718485"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621687718025"><span class="hs-identifier hs-var">leEvents</span></a></span><span>
</span><span id="line-645"></span><span>
</span><span id="line-646"></span><span id="local-6989586621687716769"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#createEventPayload"><span class="hs-identifier hs-type">createEventPayload</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RetryConf"><span class="hs-identifier hs-type">RetryConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716769"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716769"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-647"></span><span id="createEventPayload"><span class="annot"><span class="annottext">createEventPayload :: forall (b :: BackendType). RetryConf -&gt; Event b -&gt; EventPayload b
</span><a href="Hasura.Eventing.EventTrigger.html#createEventPayload"><span class="hs-identifier hs-var hs-var">createEventPayload</span></a></span></span><span> </span><span id="local-6989586621687718637"><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718637"><span class="hs-identifier hs-var">retryConf</span></a></span></span><span> </span><span id="local-6989586621687718638"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718638"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-648"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span>
</span><span id="line-649"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">epId :: EventId
</span><a href="Hasura.Eventing.EventTrigger.html#epId"><span class="hs-identifier hs-var">epId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718638"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-650"></span><span>      </span><span class="annot"><span class="annottext">epTable :: TableName b
</span><a href="Hasura.Eventing.EventTrigger.html#epTable"><span class="hs-identifier hs-var">epTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; TableName b
forall (b :: BackendType). Event b -&gt; TableName b
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTable"><span class="hs-identifier hs-var">eTable</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718638"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-651"></span><span>      </span><span class="annot"><span class="annottext">epTrigger :: TriggerMetadata
</span><a href="Hasura.Eventing.EventTrigger.html#epTrigger"><span class="hs-identifier hs-var">epTrigger</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; TriggerMetadata
forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718638"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-652"></span><span>      </span><span class="annot"><span class="annottext">epEvent :: Value
</span><a href="Hasura.Eventing.EventTrigger.html#epEvent"><span class="hs-identifier hs-var">epEvent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; Value
forall (b :: BackendType). Event b -&gt; Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eEvent"><span class="hs-identifier hs-var">eEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718638"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-653"></span><span>      </span><span class="annot"><span class="annottext">epDeliveryInfo :: DeliveryInfo
</span><a href="Hasura.Eventing.EventTrigger.html#epDeliveryInfo"><span class="hs-identifier hs-var">epDeliveryInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-654"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-type">DeliveryInfo</span></a></span><span>
</span><span id="line-655"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">diCurrentRetry :: Int
</span><a href="Hasura.Eventing.EventTrigger.html#diCurrentRetry"><span class="hs-identifier hs-var">diCurrentRetry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; Int
forall (b :: BackendType). Event b -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTries"><span class="hs-identifier hs-var">eTries</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718638"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-656"></span><span>            </span><span class="annot"><span class="annottext">diMaxRetries :: Int
</span><a href="Hasura.Eventing.EventTrigger.html#diMaxRetries"><span class="hs-identifier hs-var">diMaxRetries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetryConf -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcNumRetries"><span class="hs-identifier hs-var">rcNumRetries</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718637"><span class="hs-identifier hs-var">retryConf</span></a></span><span>
</span><span id="line-657"></span><span>          </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-658"></span><span>      </span><span class="annot"><span class="annottext">epCreatedAt :: LocalTime
</span><a href="Hasura.Eventing.EventTrigger.html#epCreatedAt"><span class="hs-identifier hs-var">epCreatedAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; LocalTime
forall (b :: BackendType). Event b -&gt; LocalTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eCreatedAt"><span class="hs-identifier hs-var">eCreatedAt</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718638"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-659"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processSuccess"><span class="hs-identifier hs-type">processSuccess</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687716807"><span class="annot"><a href="#local-6989586621687716807"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621687716806"><span class="annot"><a href="#local-6989586621687716806"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621687716808"><span class="annot"><a href="#local-6989586621687716808"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-663"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716806"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716807"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-664"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716807"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-665"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716807"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-666"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-667"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-668"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-669"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPResp"><span class="hs-identifier hs-type">HTTPResp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716808"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-670"></span><span>  </span><span class="annot"><a href="#local-6989586621687716806"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-671"></span><span id="processSuccess"><span class="annot"><span class="annottext">processSuccess :: forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b) =&gt;
SourceConfig b
-&gt; Event b
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPResp a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processSuccess"><span class="hs-identifier hs-var hs-var">processSuccess</span></a></span></span><span> </span><span id="local-6989586621687718647"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718647"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687718648"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718648"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621687718649"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718649"><span class="hs-identifier hs-var">reqHeaders</span></a></span></span><span> </span><span id="local-6989586621687718650"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718650"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span id="local-6989586621687718651"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687718651"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span id="local-6989586621687718652"><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621687718652"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-672"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718653"><span class="annot"><span class="annottext">respBody :: SerializableBlob
</span><a href="#local-6989586621687718653"><span class="hs-identifier hs-var hs-var">respBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; SerializableBlob
forall (a :: TriggerTypes). HTTPResp a -&gt; SerializableBlob
</span><a href="Hasura.Eventing.HTTP.html#hrsBody"><span class="hs-identifier hs-var">hrsBody</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621687718652"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-673"></span><span>      </span><span id="local-6989586621687718655"><span class="annot"><span class="annottext">respHeaders :: [HeaderConf]
</span><a href="#local-6989586621687718655"><span class="hs-identifier hs-var hs-var">respHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; [HeaderConf]
forall (a :: TriggerTypes). HTTPResp a -&gt; [HeaderConf]
</span><a href="Hasura.Eventing.HTTP.html#hrsHeaders"><span class="hs-identifier hs-var">hrsHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621687718652"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-674"></span><span>      </span><span id="local-6989586621687718657"><span class="annot"><span class="annottext">respStatus :: Int
</span><a href="#local-6989586621687718657"><span class="hs-identifier hs-var hs-var">respStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; Int
forall (a :: TriggerTypes). HTTPResp a -&gt; Int
</span><a href="Hasura.Eventing.HTTP.html#hrsStatus"><span class="hs-identifier hs-var">hrsStatus</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621687718652"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-675"></span><span>      </span><span id="local-6989586621687718659"><span class="annot"><span class="annottext">eid :: EventId
</span><a href="#local-6989586621687718659"><span class="hs-identifier hs-var hs-var">eid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718648"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-676"></span><span>      </span><span id="local-6989586621687718660"><span class="annot"><span class="annottext">invocation :: Invocation 'EventType
</span><a href="#local-6989586621687718660"><span class="hs-identifier hs-var hs-var">invocation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; SerializableBlob
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687718659"><span class="hs-identifier hs-var">eid</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718650"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718657"><span class="hs-identifier hs-var">respStatus</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718649"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621687718653"><span class="hs-identifier hs-var">respBody</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718655"><span class="hs-identifier hs-var">respHeaders</span></a></span><span>
</span><span id="line-677"></span><span>  </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; Invocation 'EventType
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.Backend.html#recordSuccess"><span class="hs-identifier hs-var">recordSuccess</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687716807"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718647"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718648"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687718660"><span class="hs-identifier hs-var">invocation</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687718651"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-678"></span><span>
</span><span id="line-679"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processError"><span class="hs-identifier hs-type">processError</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-680"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687716816"><span class="annot"><a href="#local-6989586621687716816"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621687716815"><span class="annot"><a href="#local-6989586621687716815"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621687716817"><span class="annot"><a href="#local-6989586621687716817"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-681"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716815"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-682"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716816"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-683"></span><span>    </span><span class="annot"><a href="Hasura.Server.Types.html#MonadGetPolicies"><span class="hs-identifier hs-type">MonadGetPolicies</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716815"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-685"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716816"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-686"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716816"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-687"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RetryConf"><span class="hs-identifier hs-type">RetryConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-688"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-689"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-690"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-691"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#EventTriggerMetrics"><span class="hs-identifier hs-type">EventTriggerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-692"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPErr"><span class="hs-identifier hs-type">HTTPErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716817"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-693"></span><span>  </span><span class="annot"><a href="#local-6989586621687716815"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-694"></span><span id="processError"><span class="annot"><span class="annottext">processError :: forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b, MonadGetPolicies m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; RetryConf
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; EventTriggerMetrics
-&gt; HTTPErr a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processError"><span class="hs-identifier hs-var hs-var">processError</span></a></span></span><span> </span><span id="local-6989586621687718677"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718677"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687718678"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718678"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621687718679"><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718679"><span class="hs-identifier hs-var">retryConf</span></a></span></span><span> </span><span id="local-6989586621687718680"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718680"><span class="hs-identifier hs-var">reqHeaders</span></a></span></span><span> </span><span id="local-6989586621687718681"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718681"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span id="local-6989586621687718682"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687718682"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span id="local-6989586621687718683"><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718683"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span></span><span> </span><span id="local-6989586621687718684"><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621687718684"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-695"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718685"><span class="annot"><span class="annottext">invocation :: Invocation 'EventType
</span><a href="#local-6989586621687718685"><span class="hs-identifier hs-var hs-var">invocation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621687718684"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-696"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HClient"><span class="hs-identifier hs-type">HClient</span></a></span><span> </span><span id="local-6989586621687718687"><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621687718687"><span class="hs-identifier hs-var">httpException</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-697"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718688"><span class="annot"><span class="annottext">statusMaybe :: Maybe Int
</span><a href="#local-6989586621687718688"><span class="hs-identifier hs-var hs-var">statusMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HttpException -&gt; Maybe Int
</span><a href="Hasura.HTTP.html#getHTTPExceptionStatus"><span class="hs-identifier hs-var">getHTTPExceptionStatus</span></a></span><span> </span><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621687718687"><span class="hs-identifier hs-var">httpException</span></a></span><span>
</span><span id="line-698"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; SerializableBlob
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718678"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718681"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621687718688"><span class="hs-identifier hs-var">statusMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718680"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; SerializableBlob
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.SerializableBlob.html#fromLBS"><span class="hs-identifier hs-var">SB.fromLBS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HttpException -&gt; ByteString
</span><a href="Hasura.Eventing.HTTP.html#httpExceptionErrorEncoding"><span class="hs-identifier hs-var">httpExceptionErrorEncoding</span></a></span><span> </span><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621687718687"><span class="hs-identifier hs-var">httpException</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-699"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HStatus"><span class="hs-identifier hs-type">HStatus</span></a></span><span> </span><span id="local-6989586621687718691"><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621687718691"><span class="hs-identifier hs-var">errResp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-700"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718692"><span class="annot"><span class="annottext">respPayload :: SerializableBlob
</span><a href="#local-6989586621687718692"><span class="hs-identifier hs-var hs-var">respPayload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; SerializableBlob
forall (a :: TriggerTypes). HTTPResp a -&gt; SerializableBlob
</span><a href="Hasura.Eventing.HTTP.html#hrsBody"><span class="hs-identifier hs-var">hrsBody</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621687718691"><span class="hs-identifier hs-var">errResp</span></a></span><span>
</span><span id="line-701"></span><span>              </span><span id="local-6989586621687718693"><span class="annot"><span class="annottext">respHeaders :: [HeaderConf]
</span><a href="#local-6989586621687718693"><span class="hs-identifier hs-var hs-var">respHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; [HeaderConf]
forall (a :: TriggerTypes). HTTPResp a -&gt; [HeaderConf]
</span><a href="Hasura.Eventing.HTTP.html#hrsHeaders"><span class="hs-identifier hs-var">hrsHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621687718691"><span class="hs-identifier hs-var">errResp</span></a></span><span>
</span><span id="line-702"></span><span>              </span><span id="local-6989586621687718694"><span class="annot"><span class="annottext">respStatus :: Int
</span><a href="#local-6989586621687718694"><span class="hs-identifier hs-var hs-var">respStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; Int
forall (a :: TriggerTypes). HTTPResp a -&gt; Int
</span><a href="Hasura.Eventing.HTTP.html#hrsStatus"><span class="hs-identifier hs-var">hrsStatus</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621687718691"><span class="hs-identifier hs-var">errResp</span></a></span><span>
</span><span id="line-703"></span><span>          </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; SerializableBlob
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718678"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718681"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718694"><span class="hs-identifier hs-var">respStatus</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718680"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621687718692"><span class="hs-identifier hs-var">respPayload</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718693"><span class="hs-identifier hs-var">respHeaders</span></a></span><span>
</span><span id="line-704"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HOther"><span class="hs-identifier hs-type">HOther</span></a></span><span> </span><span id="local-6989586621687718695"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621687718695"><span class="hs-identifier hs-var">detail</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-705"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718696"><span class="annot"><span class="annottext">errMsg :: SerializableBlob
</span><a href="#local-6989586621687718696"><span class="hs-identifier hs-var hs-var">errMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; SerializableBlob
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.SerializableBlob.html#fromLBS"><span class="hs-identifier hs-var">SB.fromLBS</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; SerializableBlob) -&gt; ByteString -&gt; SerializableBlob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.html#encode"><span class="hs-identifier hs-var">J.encode</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621687718695"><span class="hs-identifier hs-var">detail</span></a></span><span>
</span><span id="line-706"></span><span>          </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; SerializableBlob
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718678"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718681"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">500</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718680"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621687718696"><span class="hs-identifier hs-var">errMsg</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-707"></span><span>  </span><span id="local-6989586621687718697"><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621687718697"><span class="hs-identifier hs-var">retryOrError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Event b
-&gt; RetryConf
-&gt; EventTriggerMetrics
-&gt; HTTPErr a
-&gt; m ProcessEventError
forall (m :: * -&gt; *) (b :: BackendType) (a :: TriggerTypes).
(MonadIO m, MonadGetPolicies m) =&gt;
Event b
-&gt; RetryConf
-&gt; EventTriggerMetrics
-&gt; HTTPErr a
-&gt; m ProcessEventError
</span><a href="Hasura.Eventing.EventTrigger.html#retryOrSetError"><span class="hs-identifier hs-var">retryOrSetError</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718678"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718679"><span class="hs-identifier hs-var">retryConf</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718683"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621687718684"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-708"></span><span>  </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; Invocation 'EventType
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.Backend.html#recordError"><span class="hs-identifier hs-var">recordError</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687716816"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687718677"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718678"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687718685"><span class="hs-identifier hs-var">invocation</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621687718697"><span class="hs-identifier hs-var">retryOrError</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687718682"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span id="local-6989586621687716843"><span id="local-6989586621687716844"><span id="local-6989586621687716845"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#retryOrSetError"><span class="hs-identifier hs-type">retryOrSetError</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-711"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716843"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-712"></span><span>    </span><span class="annot"><a href="Hasura.Server.Types.html#MonadGetPolicies"><span class="hs-identifier hs-type">MonadGetPolicies</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716843"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-713"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-714"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716844"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-715"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RetryConf"><span class="hs-identifier hs-type">RetryConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-716"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#EventTriggerMetrics"><span class="hs-identifier hs-type">EventTriggerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-717"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPErr"><span class="hs-identifier hs-type">HTTPErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716845"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-718"></span><span>  </span><span class="annot"><a href="#local-6989586621687716843"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#ProcessEventError"><span class="hs-identifier hs-type">ProcessEventError</span></a></span></span></span></span><span>
</span><span id="line-719"></span><span id="retryOrSetError"><span class="annot"><span class="annottext">retryOrSetError :: forall (m :: * -&gt; *) (b :: BackendType) (a :: TriggerTypes).
(MonadIO m, MonadGetPolicies m) =&gt;
Event b
-&gt; RetryConf
-&gt; EventTriggerMetrics
-&gt; HTTPErr a
-&gt; m ProcessEventError
</span><a href="Hasura.Eventing.EventTrigger.html#retryOrSetError"><span class="hs-identifier hs-var hs-var">retryOrSetError</span></a></span></span><span> </span><span id="local-6989586621687718717"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718717"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621687718718"><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718718"><span class="hs-identifier hs-var">retryConf</span></a></span></span><span> </span><span id="local-6989586621687718719"><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718719"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span></span><span> </span><span id="local-6989586621687718720"><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621687718720"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-720"></span><span>  </span><span id="local-6989586621687718721"><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718721"><span class="hs-identifier hs-var">getPrometheusMetricsGranularity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (IO GranularPrometheusMetricsState)
forall (m :: * -&gt; *).
MonadGetPolicies m =&gt;
m (IO GranularPrometheusMetricsState)
</span><a href="Hasura.Server.Types.html#runGetPrometheusMetricsGranularity"><span class="hs-identifier hs-var">runGetPrometheusMetricsGranularity</span></a></span><span>
</span><span id="line-721"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718722"><span class="annot"><span class="annottext">mretryHeader :: Maybe Text
</span><a href="#local-6989586621687718722"><span class="hs-identifier hs-var hs-var">mretryHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPErr a -&gt; Maybe Text
forall {a :: TriggerTypes}. HTTPErr a -&gt; Maybe Text
</span><a href="#local-6989586621687718723"><span class="hs-identifier hs-var">getRetryAfterHeaderFromError</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621687718720"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-722"></span><span>      </span><span id="local-6989586621687718724"><span class="annot"><span class="annottext">tries :: Int
</span><a href="#local-6989586621687718724"><span class="hs-identifier hs-var hs-var">tries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; Int
forall (b :: BackendType). Event b -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTries"><span class="hs-identifier hs-var">eTries</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718717"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-723"></span><span>      </span><span id="local-6989586621687718725"><span class="annot"><span class="annottext">mretryHeaderSeconds :: Maybe Int
</span><a href="#local-6989586621687718725"><span class="hs-identifier hs-var hs-var">mretryHeaderSeconds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621687718722"><span class="hs-identifier hs-var">mretryHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text -&gt; (Text -&gt; Maybe Int) -&gt; Maybe Int
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Int
</span><a href="#local-6989586621687718726"><span class="hs-identifier hs-var">parseRetryHeader</span></a></span><span>
</span><span id="line-724"></span><span>      </span><span id="local-6989586621687718727"><span class="annot"><span class="annottext">triesExhausted :: Bool
</span><a href="#local-6989586621687718727"><span class="hs-identifier hs-var hs-var">triesExhausted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718724"><span class="hs-identifier hs-var">tries</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">RetryConf -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcNumRetries"><span class="hs-identifier hs-var">rcNumRetries</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718718"><span class="hs-identifier hs-var">retryConf</span></a></span><span>
</span><span id="line-725"></span><span>      </span><span id="local-6989586621687718728"><span class="annot"><span class="annottext">noRetryHeader :: Bool
</span><a href="#local-6989586621687718728"><span class="hs-identifier hs-var hs-var">noRetryHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621687718725"><span class="hs-identifier hs-var">mretryHeaderSeconds</span></a></span><span>
</span><span id="line-726"></span><span>  </span><span class="hs-comment">-- current_try = tries + 1 , allowed_total_tries = rcNumRetries retryConf + 1</span><span>
</span><span id="line-727"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687718727"><span class="hs-identifier hs-var">triesExhausted</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687718728"><span class="hs-identifier hs-var">noRetryHeader</span></a></span><span>
</span><span id="line-728"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-729"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-730"></span><span>        </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel
-&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel
-&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#incEventTriggerCounterWithLabel"><span class="hs-identifier hs-var">incEventTriggerCounterWithLabel</span></a></span><span>
</span><span id="line-731"></span><span>          </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718721"><span class="hs-identifier hs-var">getPrometheusMetricsGranularity</span></a></span><span>
</span><span id="line-732"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-733"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; CounterVector EventStatusWithTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#eventProcessedTotal"><span class="hs-identifier hs-var">eventProcessedTotal</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621687718719"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-734"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventStatusLabel
-&gt; Maybe DynamicEventTriggerLabel -&gt; EventStatusWithTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#EventStatusWithTriggerLabel"><span class="hs-identifier hs-var">EventStatusWithTriggerLabel</span></a></span><span> </span><span class="annot"><span class="annottext">EventStatusLabel
</span><a href="Hasura.Server.Prometheus.html#eventFailedLabel"><span class="hs-identifier hs-var">eventFailedLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynamicEventTriggerLabel -&gt; Maybe DynamicEventTriggerLabel
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SourceName -&gt; DynamicEventTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicEventTriggerLabel"><span class="hs-identifier hs-var">DynamicEventTriggerLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#tmName"><span class="hs-identifier hs-var">tmName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; TriggerMetadata
forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718717"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; SourceName
forall (b :: BackendType). Event b -&gt; SourceName
</span><a href="Hasura.RQL.Types.EventTrigger.html#eSource"><span class="hs-identifier hs-var">eSource</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718717"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-735"></span><span>      </span><span class="annot"><span class="annottext">ProcessEventError -&gt; m ProcessEventError
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetError"><span class="hs-identifier hs-var">PESetError</span></a></span><span>
</span><span id="line-736"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-737"></span><span>      </span><span id="local-6989586621687718731"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718731"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; m UTCTime
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-738"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718732"><span class="annot"><span class="annottext">delay :: Int
</span><a href="#local-6989586621687718732"><span class="hs-identifier hs-var hs-var">delay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RetryConf -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcIntervalSec"><span class="hs-identifier hs-var">rcIntervalSec</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621687718718"><span class="hs-identifier hs-var">retryConf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621687718725"><span class="hs-identifier hs-var">mretryHeaderSeconds</span></a></span><span>
</span><span id="line-739"></span><span>          </span><span id="local-6989586621687718734"><span class="annot"><span class="annottext">diff :: NominalDiffTime
</span><a href="#local-6989586621687718734"><span class="hs-identifier hs-var hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; NominalDiffTime
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718732"><span class="hs-identifier hs-var">delay</span></a></span><span>
</span><span id="line-740"></span><span>          </span><span id="local-6989586621687718735"><span class="annot"><span class="annottext">retryTime :: UTCTime
</span><a href="#local-6989586621687718735"><span class="hs-identifier hs-var hs-var">retryTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; UTCTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">addUTCTime</span></span><span> </span><span class="annot"><span class="annottext">NominalDiffTime
</span><a href="#local-6989586621687718734"><span class="hs-identifier hs-var">diff</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718731"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-741"></span><span>      </span><span class="annot"><span class="annottext">ProcessEventError -&gt; m ProcessEventError
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ProcessEventError -&gt; m ProcessEventError)
-&gt; ProcessEventError -&gt; m ProcessEventError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetRetry"><span class="hs-identifier hs-var">PESetRetry</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687718735"><span class="hs-identifier hs-var">retryTime</span></a></span><span>
</span><span id="line-742"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-743"></span><span>    </span><span id="local-6989586621687718723"><span class="annot"><span class="annottext">getRetryAfterHeaderFromError :: HTTPErr a -&gt; Maybe Text
</span><a href="#local-6989586621687718723"><span class="hs-identifier hs-var hs-var">getRetryAfterHeaderFromError</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HStatus"><span class="hs-identifier hs-type">HStatus</span></a></span><span> </span><span id="local-6989586621687718737"><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621687718737"><span class="hs-identifier hs-var">resp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; Maybe Text
forall (a :: TriggerTypes). HTTPResp a -&gt; Maybe Text
</span><a href="Hasura.Eventing.HTTP.html#getRetryAfterHeaderFromResp"><span class="hs-identifier hs-var">getRetryAfterHeaderFromResp</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621687718737"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-744"></span><span>    </span><span class="annot"><a href="#local-6989586621687718723"><span class="hs-identifier hs-var">getRetryAfterHeaderFromError</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span>    </span><span id="local-6989586621687718726"><span class="annot"><span class="annottext">parseRetryHeader :: Text -&gt; Maybe Int
</span><a href="#local-6989586621687718726"><span class="hs-identifier hs-var hs-var">parseRetryHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Bool) -&gt; Maybe Int -&gt; Maybe Int
forall (m :: * -&gt; *) a. MonadPlus m =&gt; (a -&gt; Bool) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mfilter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Maybe Int)
-&gt; (Text -&gt; Maybe Int) -&gt; Text -&gt; Maybe Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Int
forall a. Read a =&gt; String -&gt; Maybe a
</span><span class="hs-identifier hs-var">readMaybe</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Maybe Int) -&gt; (Text -&gt; String) -&gt; Text -&gt; Maybe Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-d0f6d61f5277bae932134563876cbceb4967915f364959864c72abbc2978d8ed/share/doc/html/src/Data.Text.Show.html#unpack"><span class="hs-identifier hs-var">T.unpack</span></a></span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-type">mkInvocation</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-749"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-750"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-751"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-752"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-753"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.SerializableBlob.html#SerializableBlob"><span class="hs-identifier hs-type">SB.SerializableBlob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-754"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-755"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span>
</span><span id="line-756"></span><span id="mkInvocation"><span class="annot"><span class="annottext">mkInvocation :: EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; SerializableBlob
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var hs-var">mkInvocation</span></a></span></span><span> </span><span id="local-6989586621687718748"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687718748"><span class="hs-identifier hs-var">eid</span></a></span></span><span> </span><span id="local-6989586621687718749"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718749"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span id="local-6989586621687718750"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621687718750"><span class="hs-identifier hs-var">statusMaybe</span></a></span></span><span> </span><span id="local-6989586621687718751"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718751"><span class="hs-identifier hs-var">reqHeaders</span></a></span></span><span> </span><span id="local-6989586621687718752"><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621687718752"><span class="hs-identifier hs-var">respBody</span></a></span></span><span> </span><span id="local-6989586621687718753"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718753"><span class="hs-identifier hs-var">respHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-757"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718754"><span class="annot"><span class="annottext">resp :: Response 'EventType
</span><a href="#local-6989586621687718754"><span class="hs-identifier hs-var hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-758"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621687718750"><span class="hs-identifier hs-var">statusMaybe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-759"></span><span>          </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SerializableBlob -&gt; Response 'EventType
forall (a :: TriggerTypes). SerializableBlob -&gt; Response a
</span><a href="Hasura.Eventing.HTTP.html#mkClientErr"><span class="hs-identifier hs-var">mkClientErr</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621687718752"><span class="hs-identifier hs-var">respBody</span></a></span><span>
</span><span id="line-760"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621687718756"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718756"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-761"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718756"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718756"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">300</span></span><span>
</span><span id="line-762"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SerializableBlob -&gt; [HeaderConf] -&gt; Response 'EventType
forall (a :: TriggerTypes).
Int -&gt; SerializableBlob -&gt; [HeaderConf] -&gt; Response a
</span><a href="Hasura.Eventing.HTTP.html#mkResp"><span class="hs-identifier hs-var">mkResp</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687718756"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621687718752"><span class="hs-identifier hs-var">respBody</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718753"><span class="hs-identifier hs-var">respHeaders</span></a></span><span>
</span><span id="line-763"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SerializableBlob -&gt; Response 'EventType
forall (a :: TriggerTypes). SerializableBlob -&gt; Response a
</span><a href="Hasura.Eventing.HTTP.html#mkClientErr"><span class="hs-identifier hs-var">mkClientErr</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621687718752"><span class="hs-identifier hs-var">respBody</span></a></span><span>
</span><span id="line-764"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EventId
-&gt; Maybe Int
-&gt; WebhookRequest
-&gt; Response 'EventType
-&gt; Invocation 'EventType
forall (a :: TriggerTypes).
EventId
-&gt; Maybe Int -&gt; WebhookRequest -&gt; Response a -&gt; Invocation a
</span><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-var">Invocation</span></a></span><span>
</span><span id="line-765"></span><span>        </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687718748"><span class="hs-identifier hs-var">eid</span></a></span><span>
</span><span id="line-766"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621687718750"><span class="hs-identifier hs-var">statusMaybe</span></a></span><span>
</span><span id="line-767"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; [HeaderConf] -&gt; Text -&gt; WebhookRequest
</span><a href="Hasura.Eventing.HTTP.html#mkWebhookReq"><span class="hs-identifier hs-var">mkWebhookReq</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687718749"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621687718751"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.RQL.Types.Eventing.html#invocationVersionET"><span class="hs-identifier hs-var">invocationVersionET</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-768"></span><span>        </span><span class="annot"><span class="annottext">Response 'EventType
</span><a href="#local-6989586621687718754"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-769"></span><span>
</span><span id="line-770"></span><span id="local-6989586621687716749"><span id="local-6989586621687716750"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-type">logQErr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621687716749"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716750"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/data-has-0.4.0.0-dac5c7adae74e1856a42108dcba181ae6d833a24d6271d4129aff0f1aaae2f5f/share/doc/html/src/Data.Has.html#Has"><span class="hs-identifier hs-type">Has</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687716749"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716750"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687716750"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-771"></span><span id="logQErr"><span class="annot"><span class="annottext">logQErr :: forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var hs-var">logQErr</span></a></span></span><span> </span><span id="local-6989586621687718772"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687718772"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-772"></span><span>  </span><span id="local-6989586621687718773"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687718773"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(r -&gt; Logger Hasura) -&gt; m (Logger Hasura)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">r -&gt; Logger Hasura
forall a t. Has a t =&gt; t -&gt; a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/data-has-0.4.0.0-dac5c7adae74e1856a42108dcba181ae6d833a24d6271d4129aff0f1aaae2f5f/share/doc/html/src/Data.Has.html#getter"><span class="hs-identifier hs-var">getter</span></a></span><span>
</span><span id="line-773"></span><span>  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687718773"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(EventInternalErr -&gt; m ()) -&gt; EventInternalErr -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; EventInternalErr
</span><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687718772"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-774"></span><span>
</span><span id="line-775"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#getEventTriggerInfoFromEvent"><span class="hs-identifier hs-type">getEventTriggerInfoFromEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-776"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687716751"><span class="annot"><a href="#local-6989586621687716751"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716751"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#SchemaCache"><span class="hs-identifier hs-type">SchemaCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716751"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-d0f6d61f5277bae932134563876cbceb4967915f364959864c72abbc2978d8ed/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventTriggerInfo"><span class="hs-identifier hs-type">EventTriggerInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687716751"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-777"></span><span id="getEventTriggerInfoFromEvent"><span class="annot"><span class="annottext">getEventTriggerInfoFromEvent :: forall (b :: BackendType).
Backend b =&gt;
SchemaCache -&gt; Event b -&gt; Either Text (EventTriggerInfo b)
</span><a href="Hasura.Eventing.EventTrigger.html#getEventTriggerInfoFromEvent"><span class="hs-identifier hs-var hs-var">getEventTriggerInfoFromEvent</span></a></span></span><span> </span><span id="local-6989586621687718800"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621687718800"><span class="hs-identifier hs-var">sc</span></a></span></span><span> </span><span id="local-6989586621687718801"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718801"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-778"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718802"><span class="annot"><span class="annottext">table :: TableName b
</span><a href="#local-6989586621687718802"><span class="hs-identifier hs-var hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; TableName b
forall (b :: BackendType). Event b -&gt; TableName b
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTable"><span class="hs-identifier hs-var">eTable</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718801"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-779"></span><span>      </span><span id="local-6989586621687718803"><span class="annot"><span class="annottext">mTableInfo :: Maybe (TableInfo b)
</span><a href="#local-6989586621687718803"><span class="hs-identifier hs-var hs-var">mTableInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
Backend b =&gt;
SourceName -&gt; TableName b -&gt; SourceCache -&gt; Maybe (TableInfo b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#unsafeTableInfo"><span class="hs-identifier hs-var">unsafeTableInfo</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687716751"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; SourceName
forall (b :: BackendType). Event b -&gt; SourceName
</span><a href="Hasura.RQL.Types.EventTrigger.html#eSource"><span class="hs-identifier hs-var">eSource</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718801"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687718802"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceCache -&gt; Maybe (TableInfo b))
-&gt; SourceCache -&gt; Maybe (TableInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621687718800"><span class="hs-identifier hs-var">sc</span></a></span><span>
</span><span id="line-780"></span><span>  </span><span id="local-6989586621687718805"><span class="annot"><span class="annottext">TableInfo b
</span><a href="#local-6989586621687718805"><span class="hs-identifier hs-var">tableInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TableInfo b)
-&gt; Either Text (TableInfo b) -&gt; Either Text (TableInfo b)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TableInfo b)
</span><a href="#local-6989586621687718803"><span class="hs-identifier hs-var">mTableInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Text (TableInfo b) -&gt; Either Text (TableInfo b))
-&gt; Either Text (TableInfo b) -&gt; Either Text (TableInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text (TableInfo b)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;table '&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687718802"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;' not found&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687718807"><span class="annot"><span class="annottext">triggerName :: TriggerName
</span><a href="#local-6989586621687718807"><span class="hs-identifier hs-var hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#tmName"><span class="hs-identifier hs-var">tmName</span></a></span><span> </span><span class="annot"><span class="annottext">(TriggerMetadata -&gt; TriggerName) -&gt; TriggerMetadata -&gt; TriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event b -&gt; TriggerMetadata
forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621687718801"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-782"></span><span>      </span><span id="local-6989586621687718808"><span class="annot"><span class="annottext">mEventTriggerInfo :: Maybe (EventTriggerInfo b)
</span><a href="#local-6989586621687718808"><span class="hs-identifier hs-var hs-var">mEventTriggerInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; HashMap TriggerName (EventTriggerInfo b)
-&gt; Maybe (EventTriggerInfo b)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687718807"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableInfo b -&gt; HashMap TriggerName (EventTriggerInfo b)
forall (b :: BackendType). TableInfo b -&gt; EventTriggerInfoMap b
</span><a href="Hasura.Table.Cache.html#_tiEventTriggerInfoMap"><span class="hs-identifier hs-var">_tiEventTriggerInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">TableInfo b
</span><a href="#local-6989586621687718805"><span class="hs-identifier hs-var">tableInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-783"></span><span>  </span><span class="annot"><span class="annottext">Maybe (EventTriggerInfo b)
-&gt; Either Text (EventTriggerInfo b)
-&gt; Either Text (EventTriggerInfo b)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (EventTriggerInfo b)
</span><a href="#local-6989586621687718808"><span class="hs-identifier hs-var">mEventTriggerInfo</span></a></span><span>
</span><span id="line-784"></span><span>    </span><span class="annot"><span class="annottext">(Either Text (EventTriggerInfo b)
 -&gt; Either Text (EventTriggerInfo b))
-&gt; Either Text (EventTriggerInfo b)
-&gt; Either Text (EventTriggerInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text (EventTriggerInfo b)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span>
</span><span id="line-785"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event trigger '&quot;</span></span><span>
</span><span id="line-786"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687718807"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-787"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;' on table '&quot;</span></span><span>
</span><span id="line-788"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687718802"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-789"></span><span>          </span><span class="annot"><span class="annottext">TableName b -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;' not found&quot;</span></span><span>
</span><span id="line-790"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-791"></span><span>
</span><span id="line-792"></span><span id="local-6989586621687716813"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#incEventTriggerCounterWithLabel"><span class="hs-identifier hs-type">incEventTriggerCounterWithLabel</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-793"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687716813"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-794"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#GranularPrometheusMetricsState"><span class="hs-identifier hs-type">GranularPrometheusMetricsState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-795"></span><span>  </span><span class="hs-comment">-- should the metric be observed without a label when granularMetricsState is OFF</span><span>
</span><span id="line-796"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-797"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.CounterVector.html#CounterVector"><span class="hs-identifier hs-type">CounterVector</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html#EventStatusWithTriggerLabel"><span class="hs-identifier hs-type">EventStatusWithTriggerLabel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-798"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#EventStatusWithTriggerLabel"><span class="hs-identifier hs-type">EventStatusWithTriggerLabel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-799"></span><span>  </span><span class="annot"><a href="#local-6989586621687716813"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-800"></span><span id="incEventTriggerCounterWithLabel"><span class="annot"><span class="annottext">incEventTriggerCounterWithLabel :: forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel
-&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#incEventTriggerCounterWithLabel"><span class="hs-identifier hs-var hs-var">incEventTriggerCounterWithLabel</span></a></span></span><span> </span><span id="local-6989586621687718817"><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718817"><span class="hs-identifier hs-var">getMetricState</span></a></span></span><span> </span><span id="local-6989586621687718818"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687718818"><span class="hs-identifier hs-var">alwaysObserve</span></a></span></span><span> </span><span id="local-6989586621687718819"><span class="annot"><span class="annottext">CounterVector EventStatusWithTriggerLabel
</span><a href="#local-6989586621687718819"><span class="hs-identifier hs-var">counterVector</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Prometheus.html#EventStatusWithTriggerLabel"><span class="hs-identifier hs-type">EventStatusWithTriggerLabel</span></a></span><span> </span><span id="local-6989586621687718820"><span class="annot"><span class="annottext">EventStatusLabel
</span><a href="#local-6989586621687718820"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span id="local-6989586621687718821"><span class="annot"><span class="annottext">Maybe DynamicEventTriggerLabel
</span><a href="#local-6989586621687718821"><span class="hs-identifier hs-var">tl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-801"></span><span>  </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState -&gt; Bool -&gt; IO () -&gt; IO () -&gt; m ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState -&gt; Bool -&gt; IO () -&gt; IO () -&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#recordMetricWithLabel"><span class="hs-identifier hs-var">recordMetricWithLabel</span></a></span><span>
</span><span id="line-802"></span><span>    </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687718817"><span class="hs-identifier hs-var">getMetricState</span></a></span><span>
</span><span id="line-803"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687718818"><span class="hs-identifier hs-var">alwaysObserve</span></a></span><span>
</span><span id="line-804"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel -&gt; IO ()
forall label. Ord label =&gt; CounterVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.CounterVector.html#inc"><span class="hs-identifier hs-var">CounterVector.inc</span></a></span><span> </span><span class="annot"><span class="annottext">CounterVector EventStatusWithTriggerLabel
</span><a href="#local-6989586621687718819"><span class="hs-identifier hs-var">counterVector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventStatusLabel
-&gt; Maybe DynamicEventTriggerLabel -&gt; EventStatusWithTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#EventStatusWithTriggerLabel"><span class="hs-identifier hs-var">EventStatusWithTriggerLabel</span></a></span><span> </span><span class="annot"><span class="annottext">EventStatusLabel
</span><a href="#local-6989586621687718820"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DynamicEventTriggerLabel
</span><a href="#local-6989586621687718821"><span class="hs-identifier hs-var">tl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CounterVector EventStatusWithTriggerLabel
-&gt; EventStatusWithTriggerLabel -&gt; IO ()
forall label. Ord label =&gt; CounterVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.CounterVector.html#inc"><span class="hs-identifier hs-var">CounterVector.inc</span></a></span><span> </span><span class="annot"><span class="annottext">CounterVector EventStatusWithTriggerLabel
</span><a href="#local-6989586621687718819"><span class="hs-identifier hs-var">counterVector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventStatusLabel
-&gt; Maybe DynamicEventTriggerLabel -&gt; EventStatusWithTriggerLabel
</span><a href="Hasura.Server.Prometheus.html#EventStatusWithTriggerLabel"><span class="hs-identifier hs-var">EventStatusWithTriggerLabel</span></a></span><span> </span><span class="annot"><span class="annottext">EventStatusLabel
</span><a href="#local-6989586621687718820"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DynamicEventTriggerLabel
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-806"></span></pre></body></html>