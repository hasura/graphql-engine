<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Arrows #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | Top-level functions concerned specifically with operations on the schema cache, such as</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- rebuilding it from the catalog and incorporating schema changes. See the module documentation for</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- &quot;Hasura.RQL.DDL.Schema&quot; for more details.</span><span>
</span><span id="line-8"></span><span class="hs-comment">--</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- __Note__: this module is __mutually recursive__ with other @Hasura.RQL.DDL.Schema.*@ modules, which</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- both define pieces of the implementation of building the schema cache and define handlers that</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- trigger schema cache rebuilds.</span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache</span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier">RebuildableSchemaCache</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#lastBuiltSchemaCache"><span class="hs-identifier">lastBuiltSchemaCache</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRebuildableSchemaCache"><span class="hs-identifier">buildRebuildableSchemaCache</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRebuildableSchemaCacheWithReason"><span class="hs-identifier">buildRebuildableSchemaCacheWithReason</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier">CacheRWT</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#runCacheRWT"><span class="hs-identifier">runCacheRWT</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkBooleanPermissionMap"><span class="hs-identifier">mkBooleanPermissionMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">where</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Arrow.Extended.html"><span class="hs-identifier">Control.Arrow.Extended</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#forConcurrentlyEIO"><span class="hs-identifier">forConcurrentlyEIO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(.=)</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Retry</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Retry</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">align</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Dependent.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DMap</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isLeft</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Environment.html"><span class="hs-identifier">Data.Environment</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Env</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.HashMap.Strict.Extended.html"><span class="hs-identifier">Data.HashMap.Strict.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.HashMap.Strict.InsOrd.Extended.html"><span class="hs-identifier">Data.HashMap.Strict.InsOrd.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OMap</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HS</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Proxy</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.These</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">These</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">getCurrentTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Database.PG.Query</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Connection</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.Source.html"><span class="hs-identifier">Hasura.Backends.MSSQL.DDL.Source</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MSSQL</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.html"><span class="hs-identifier">Hasura.Backends.Postgres.Connection</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html"><span class="hs-identifier">Hasura.Backends.Postgres.DDL.Source</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#initCatalogForSource"><span class="hs-identifier">initCatalogForSource</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Types.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Types</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Schema.html"><span class="hs-identifier">Hasura.GraphQL.Schema</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Schema.html#buildGQLContext"><span class="hs-identifier">buildGQLContext</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Incremental.html"><span class="hs-identifier">Hasura.Incremental</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Inc</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html"><span class="hs-identifier">Hasura.Metadata.Class</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Action.html"><span class="hs-identifier">Hasura.RQL.DDL.Action</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.CustomTypes.html"><span class="hs-identifier">Hasura.RQL.DDL.CustomTypes</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.DDL.EventTrigger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html#buildEventTriggerInfo"><span class="hs-identifier">buildEventTriggerInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.InheritedRoles.html"><span class="hs-identifier">Hasura.RQL.DDL.InheritedRoles</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.InheritedRoles.html#resolveInheritedRole"><span class="hs-identifier">resolveInheritedRole</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteRelationship.html"><span class="hs-identifier">Hasura.RQL.DDL.RemoteRelationship</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.RemoteRelationship.html#CreateRemoteSchemaRemoteRelationship"><span class="hs-identifier">CreateRemoteSchemaRemoteRelationship</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteRelationship.html#PartiallyResolvedSource"><span class="hs-identifier">PartiallyResolvedSource</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteRelationship.html#buildRemoteFieldInfo"><span class="hs-identifier">buildRemoteFieldInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteRelationship.html#getRemoteSchemaEntityJoinColumns"><span class="hs-identifier">getRemoteSchemaEntityJoinColumns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteSchema.html"><span class="hs-identifier">Hasura.RQL.DDL.RemoteSchema</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteSchema.Permission.html"><span class="hs-identifier">Hasura.RQL.DDL.RemoteSchema.Permission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.RemoteSchema.Permission.html#resolveRoleBasedRemoteSchema"><span class="hs-identifier">resolveRoleBasedRemoteSchema</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.ScheduledTrigger.html"><span class="hs-identifier">Hasura.RQL.DDL.ScheduledTrigger</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Common</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Dependencies.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Dependencies</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Fields.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Fields</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Permission</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Function.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Function</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Table.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Table</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.html"><span class="hs-identifier">Hasura.RQL.Types</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#fmFunction"><span class="hs-identifier">fmFunction</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#tmTable"><span class="hs-identifier">tmTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html"><span class="hs-identifier">Hasura.RQL.Types.Endpoint</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Eventing.Backend</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html"><span class="hs-identifier">Hasura.RQL.Types.Roles.Internal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CheckPermission"><span class="hs-identifier">CheckPermission</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.Tag.html"><span class="hs-identifier">Hasura.SQL.Tag</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.Tag.html"><span class="hs-identifier">Hasura.SQL.Tag</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tag</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#EventingMode"><span class="hs-identifier">EventingMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-76"></span><span>    </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><a href="Hasura.Server.Types.html#ReadOnlyMode"><span class="hs-identifier">ReadOnlyMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.GraphQL.Draft.Syntax</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Manager.html"><span class="hs-identifier">Network.HTTP.Client.Manager</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP.Client.Manager.html#HasHttpManagerM"><span class="hs-identifier">HasHttpManagerM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">{- Note [Roles Inheritance]
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Roles may have parent roles defined from which they can inherit permission and this is
called as roles inheritance. Roles which have parents can also be parents of other roles.
So, cycle in roles should be disallowed and this is done in the `orderRoles` function.

When the metadata contains a permission for a role for a entity, then it will override the
inherited permission, if any.

Roles inheritance work differently for different features:

1. Select permissions
~~~~~~~~~~~~~~~~~~~~~

See note [Inherited roles architecture for read queries]

2. Mutation permissions and remote schema permissions
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For mutation and remote schema permissions, an inherited role can only inherit permission
from its parent roles when the relevant parts of the permissions are equal i.e. the non-relevant
parts are discarded for the equality, for example, in two remote schema permissions the order
of the fields in an Object type is discarded.

When an inherited role cannot inherit permission from its parents due to a conflict, then we mark
the inherited role and the entity (remote schema or table) combination as inconsistent in the metadata.

3. Actions and Custom function permissions
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Currently, actions and custom function permissions can be thought of as a boolean. Either a role has
permission to the entity or it doesn't, so in these cases there's no possiblity of a conflict. An inherited
role will have access to the action/function if any one of the parents have permission to access the
action/function.

-}</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRebuildableSchemaCache"><span class="hs-identifier hs-type">buildRebuildableSchemaCache</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-123"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#Metadata"><span class="hs-identifier hs-type">Metadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-126"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#CacheBuild"><span class="hs-identifier hs-type">CacheBuild</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-type">RebuildableSchemaCache</span></a></span><span>
</span><span id="line-127"></span><span id="buildRebuildableSchemaCache"><span class="annot"><span class="annottext">buildRebuildableSchemaCache :: Logger Hasura
-&gt; Environment -&gt; Metadata -&gt; CacheBuild RebuildableSchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRebuildableSchemaCache"><span class="hs-identifier hs-var hs-var">buildRebuildableSchemaCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-128"></span><span>  </span><span class="annot"><span class="annottext">BuildReason
-&gt; Logger Hasura
-&gt; Environment
-&gt; Metadata
-&gt; CacheBuild RebuildableSchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRebuildableSchemaCacheWithReason"><span class="hs-identifier hs-var">buildRebuildableSchemaCacheWithReason</span></a></span><span> </span><span class="annot"><span class="annottext">BuildReason
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CatalogSync"><span class="hs-identifier hs-var">CatalogSync</span></a></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRebuildableSchemaCacheWithReason"><span class="hs-identifier hs-type">buildRebuildableSchemaCacheWithReason</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#BuildReason"><span class="hs-identifier hs-type">BuildReason</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#Metadata"><span class="hs-identifier hs-type">Metadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#CacheBuild"><span class="hs-identifier hs-type">CacheBuild</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-type">RebuildableSchemaCache</span></a></span><span>
</span><span id="line-136"></span><span id="buildRebuildableSchemaCacheWithReason"><span class="annot"><span class="annottext">buildRebuildableSchemaCacheWithReason :: BuildReason
-&gt; Logger Hasura
-&gt; Environment
-&gt; Metadata
-&gt; CacheBuild RebuildableSchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRebuildableSchemaCacheWithReason"><span class="hs-identifier hs-var hs-var">buildRebuildableSchemaCacheWithReason</span></a></span></span><span> </span><span id="local-6989586621688410613"><span class="annot"><span class="annottext">BuildReason
</span><a href="#local-6989586621688410613"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span id="local-6989586621688410612"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688410612"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688410611"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688410611"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621688410610"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688410610"><span class="hs-identifier hs-var">metadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-137"></span><span>  </span><span id="local-6989586621688410609"><span class="annot"><span class="annottext">Result
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
</span><a href="#local-6989586621688410609"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="annottext">(ReaderT
   BuildReason
   CacheBuild
   (Result
      (ReaderT BuildReason CacheBuild)
      (Metadata, InvalidationKeys)
      SchemaCache)
 -&gt; BuildReason
 -&gt; CacheBuild
      (Result
         (ReaderT BuildReason CacheBuild)
         (Metadata, InvalidationKeys)
         SchemaCache))
-&gt; BuildReason
-&gt; ReaderT
     BuildReason
     CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
-&gt; CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT
  BuildReason
  CacheBuild
  (Result
     (ReaderT BuildReason CacheBuild)
     (Metadata, InvalidationKeys)
     SchemaCache)
-&gt; BuildReason
-&gt; CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">BuildReason
</span><a href="#local-6989586621688410613"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   BuildReason
   CacheBuild
   (Result
      (ReaderT BuildReason CacheBuild)
      (Metadata, InvalidationKeys)
      SchemaCache)
 -&gt; CacheBuild
      (Result
         (ReaderT BuildReason CacheBuild)
         (Metadata, InvalidationKeys)
         SchemaCache))
-&gt; ReaderT
     BuildReason
     CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
-&gt; CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-139"></span><span>      </span><span class="annot"><span class="annottext">Rule
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
-&gt; (Metadata, InvalidationKeys)
-&gt; ReaderT
     BuildReason
     CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
Rule m a b -&gt; a -&gt; m (Result m a b)
</span><a href="Hasura.Incremental.Internal.Rule.html#build"><span class="hs-identifier hs-var">Inc.build</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger Hasura
-&gt; Environment
-&gt; Rule
     (ReaderT BuildReason CacheBuild)
     (Metadata, InvalidationKeys)
     SchemaCache
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr, ArrowCache m arr, MonadIO m,
 MonadBaseControl IO m, MonadError QErr m,
 MonadReader BuildReason m, HasHttpManagerM m, MonadResolveSource m,
 HasServerConfigCtx m) =&gt;
Logger Hasura
-&gt; Environment -&gt; arr (Metadata, InvalidationKeys) SchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#buildSchemaCacheRule"><span class="hs-identifier hs-var">buildSchemaCacheRule</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688410612"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688410611"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688410610"><span class="hs-identifier hs-var">metadata</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InvalidationKeys
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#initialInvalidationKeys"><span class="hs-identifier hs-var">initialInvalidationKeys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span>  </span><span class="annot"><span class="annottext">RebuildableSchemaCache -&gt; CacheBuild RebuildableSchemaCache
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RebuildableSchemaCache -&gt; CacheBuild RebuildableSchemaCache)
-&gt; RebuildableSchemaCache -&gt; CacheBuild RebuildableSchemaCache
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache
-&gt; InvalidationKeys
-&gt; Rule
     (ReaderT BuildReason CacheBuild)
     (Metadata, InvalidationKeys)
     SchemaCache
-&gt; RebuildableSchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-var">RebuildableSchemaCache</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
-&gt; SchemaCache
forall (m :: * -&gt; *) a b. Result m a b -&gt; b
</span><a href="Hasura.Incremental.Internal.Rule.html#result"><span class="hs-identifier hs-var hs-var">Inc.result</span></a></span><span> </span><span class="annot"><span class="annottext">Result
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
</span><a href="#local-6989586621688410609"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidationKeys
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#initialInvalidationKeys"><span class="hs-identifier hs-var">initialInvalidationKeys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
-&gt; Rule
     (ReaderT BuildReason CacheBuild)
     (Metadata, InvalidationKeys)
     SchemaCache
forall (m :: * -&gt; *) a b. Result m a b -&gt; Rule m a b
</span><a href="Hasura.Incremental.Internal.Rule.html#rebuildRule"><span class="hs-identifier hs-var hs-var">Inc.rebuildRule</span></a></span><span> </span><span class="annot"><span class="annottext">Result
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
</span><a href="#local-6989586621688410609"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span id="local-6989586621688410599"><span id="local-6989586621688410600"><span class="hs-keyword">newtype</span><span> </span><span id="CacheRWT"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-var">CacheRWT</span></a></span></span><span> </span><span id="local-6989586621688411348"><span class="annot"><a href="#local-6989586621688411348"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688411347"><span class="annot"><a href="#local-6989586621688411347"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- The CacheInvalidations component of the state could actually be collected using WriterT, but</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-comment">-- WriterT implementations prior to transformers-0.5.6.0 (which added</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-comment">-- Control.Monad.Trans.Writer.CPS) are leaky, and we don&#8217;t have that yet.</span><span>
</span><span id="line-147"></span><span>    </span><span id="CacheRWT"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-var">CacheRWT</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-type">RebuildableSchemaCache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheInvalidations"><span class="hs-identifier hs-type">CacheInvalidations</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688411348"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411347"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621688410594"><span id="local-6989586621688410596"><span class="annot"><span class="annottext">a -&gt; CacheRWT m b -&gt; CacheRWT m a
(a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b
(forall a b. (a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b)
-&gt; (forall a b. a -&gt; CacheRWT m b -&gt; CacheRWT m a)
-&gt; Functor (CacheRWT m)
forall a b. a -&gt; CacheRWT m b -&gt; CacheRWT m a
forall a b. (a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b
forall (m :: * -&gt; *) a b.
Functor m =&gt;
a -&gt; CacheRWT m b -&gt; CacheRWT m a
forall (m :: * -&gt; *) a b.
Functor m =&gt;
(a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; CacheRWT m b -&gt; CacheRWT m a
$c&lt;$ :: forall (m :: * -&gt; *) a b.
Functor m =&gt;
a -&gt; CacheRWT m b -&gt; CacheRWT m a
fmap :: (a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b
$cfmap :: forall (m :: * -&gt; *) a b.
Functor m =&gt;
(a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-150"></span><span>      </span><span id="local-6989586621688410582"><span id="local-6989586621688410584"><span id="local-6989586621688410586"><span id="local-6989586621688410588"><span id="local-6989586621688410590"><span class="annot"><span class="annottext">Functor (CacheRWT m)
a -&gt; CacheRWT m a
Functor (CacheRWT m)
-&gt; (forall a. a -&gt; CacheRWT m a)
-&gt; (forall a b.
    CacheRWT m (a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m c)
-&gt; (forall a b. CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b)
-&gt; (forall a b. CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m a)
-&gt; Applicative (CacheRWT m)
CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b
CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m a
CacheRWT m (a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b
(a -&gt; b -&gt; c) -&gt; CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m c
forall a. a -&gt; CacheRWT m a
forall a b. CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m a
forall a b. CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b
forall a b. CacheRWT m (a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b
forall a b c.
(a -&gt; b -&gt; c) -&gt; CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m c
forall (m :: * -&gt; *). Monad m =&gt; Functor (CacheRWT m)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; CacheRWT m a
forall (m :: * -&gt; *) a b.
Monad m =&gt;
CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m a
forall (m :: * -&gt; *) a b.
Monad m =&gt;
CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b
forall (m :: * -&gt; *) a b.
Monad m =&gt;
CacheRWT m (a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b
forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; b -&gt; c) -&gt; CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m a
$c&lt;* :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m a
*&gt; :: CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b
$c*&gt; :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b
liftA2 :: (a -&gt; b -&gt; c) -&gt; CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m c
$cliftA2 :: forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; b -&gt; c) -&gt; CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m c
&lt;*&gt; :: CacheRWT m (a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b
$c&lt;*&gt; :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
CacheRWT m (a -&gt; b) -&gt; CacheRWT m a -&gt; CacheRWT m b
pure :: a -&gt; CacheRWT m a
$cpure :: forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; CacheRWT m a
$cp1Applicative :: forall (m :: * -&gt; *). Monad m =&gt; Functor (CacheRWT m)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-151"></span><span>      </span><span id="local-6989586621688410574"><span id="local-6989586621688410576"><span id="local-6989586621688410578"><span class="annot"><span class="annottext">Applicative (CacheRWT m)
a -&gt; CacheRWT m a
Applicative (CacheRWT m)
-&gt; (forall a b.
    CacheRWT m a -&gt; (a -&gt; CacheRWT m b) -&gt; CacheRWT m b)
-&gt; (forall a b. CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b)
-&gt; (forall a. a -&gt; CacheRWT m a)
-&gt; Monad (CacheRWT m)
CacheRWT m a -&gt; (a -&gt; CacheRWT m b) -&gt; CacheRWT m b
CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b
forall a. a -&gt; CacheRWT m a
forall a b. CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b
forall a b. CacheRWT m a -&gt; (a -&gt; CacheRWT m b) -&gt; CacheRWT m b
forall (m :: * -&gt; *). Monad m =&gt; Applicative (CacheRWT m)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; CacheRWT m a
forall (m :: * -&gt; *) a b.
Monad m =&gt;
CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b
forall (m :: * -&gt; *) a b.
Monad m =&gt;
CacheRWT m a -&gt; (a -&gt; CacheRWT m b) -&gt; CacheRWT m b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: a -&gt; CacheRWT m a
$creturn :: forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; CacheRWT m a
&gt;&gt; :: CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b
$c&gt;&gt; :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
CacheRWT m a -&gt; CacheRWT m b -&gt; CacheRWT m b
&gt;&gt;= :: CacheRWT m a -&gt; (a -&gt; CacheRWT m b) -&gt; CacheRWT m b
$c&gt;&gt;= :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
CacheRWT m a -&gt; (a -&gt; CacheRWT m b) -&gt; CacheRWT m b
$cp1Monad :: forall (m :: * -&gt; *). Monad m =&gt; Applicative (CacheRWT m)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-152"></span><span>      </span><span id="local-6989586621688410570"><span class="annot"><span class="annottext">Monad (CacheRWT m)
Monad (CacheRWT m)
-&gt; (forall a. IO a -&gt; CacheRWT m a) -&gt; MonadIO (CacheRWT m)
IO a -&gt; CacheRWT m a
forall a. IO a -&gt; CacheRWT m a
forall (m :: * -&gt; *).
Monad m -&gt; (forall a. IO a -&gt; m a) -&gt; MonadIO m
forall (m :: * -&gt; *). MonadIO m =&gt; Monad (CacheRWT m)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; CacheRWT m a
liftIO :: IO a -&gt; CacheRWT m a
$cliftIO :: forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; CacheRWT m a
$cp1MonadIO :: forall (m :: * -&gt; *). MonadIO m =&gt; Monad (CacheRWT m)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadIO</span></span></span><span class="hs-special">,</span><span>
</span><span id="line-153"></span><span>      </span><span id="local-6989586621688410562"><span id="local-6989586621688410564"><span id="local-6989586621688410566"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621688410600"><span class="hs-identifier hs-type">r</span></a></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-154"></span><span>      </span><span id="local-6989586621688410556"><span id="local-6989586621688410558"><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="#local-6989586621688410599"><span class="hs-identifier hs-type">e</span></a></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-155"></span><span>      </span><span id="local-6989586621688410552"><span class="annot"><span class="annottext">MonadError QErr (CacheRWT m)
MonadError QErr (CacheRWT m)
-&gt; (forall a. TxE QErr a -&gt; CacheRWT m a) -&gt; MonadTx (CacheRWT m)
TxE QErr a -&gt; CacheRWT m a
forall a. TxE QErr a -&gt; CacheRWT m a
forall (m :: * -&gt; *).
MonadError QErr m -&gt; (forall a. TxE QErr a -&gt; m a) -&gt; MonadTx m
forall (m :: * -&gt; *). MonadTx m =&gt; MonadError QErr (CacheRWT m)
forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; CacheRWT m a
liftTx :: TxE QErr a -&gt; CacheRWT m a
$cliftTx :: forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; CacheRWT m a
$cp1MonadTx :: forall (m :: * -&gt; *). MonadTx m =&gt; MonadError QErr (CacheRWT m)
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#C%3AMonadTx"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadTx</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-156"></span><span>      </span><span id="local-6989586621688410548"><span class="annot"><span class="annottext">Monad (CacheRWT m)
CacheRWT m UserInfo
Monad (CacheRWT m) -&gt; CacheRWT m UserInfo -&gt; UserInfoM (CacheRWT m)
forall (m :: * -&gt; *). Monad m -&gt; m UserInfo -&gt; UserInfoM m
forall (m :: * -&gt; *). UserInfoM m =&gt; Monad (CacheRWT m)
forall (m :: * -&gt; *). UserInfoM m =&gt; CacheRWT m UserInfo
askUserInfo :: CacheRWT m UserInfo
$caskUserInfo :: forall (m :: * -&gt; *). UserInfoM m =&gt; CacheRWT m UserInfo
$cp1UserInfoM :: forall (m :: * -&gt; *). UserInfoM m =&gt; Monad (CacheRWT m)
</span><a href="Hasura.Session.html#C%3AUserInfoM"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">UserInfoM</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-157"></span><span>      </span><span id="local-6989586621688410544"><span class="annot"><span class="annottext">Monad (CacheRWT m)
CacheRWT m Manager
Monad (CacheRWT m)
-&gt; CacheRWT m Manager -&gt; HasHttpManagerM (CacheRWT m)
forall (m :: * -&gt; *). Monad m -&gt; m Manager -&gt; HasHttpManagerM m
forall (m :: * -&gt; *). HasHttpManagerM m =&gt; Monad (CacheRWT m)
forall (m :: * -&gt; *). HasHttpManagerM m =&gt; CacheRWT m Manager
askHttpManager :: CacheRWT m Manager
$caskHttpManager :: forall (m :: * -&gt; *). HasHttpManagerM m =&gt; CacheRWT m Manager
$cp1HasHttpManagerM :: forall (m :: * -&gt; *). HasHttpManagerM m =&gt; Monad (CacheRWT m)
</span><a href="Network.HTTP.Client.Manager.html#C%3AHasHttpManagerM"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">HasHttpManagerM</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-158"></span><span>      </span><span id="local-6989586621688410540"><span class="annot"><span class="annottext">Monad (CacheRWT m)
CacheRWT m SystemDefined
Monad (CacheRWT m)
-&gt; CacheRWT m SystemDefined -&gt; HasSystemDefined (CacheRWT m)
forall (m :: * -&gt; *).
Monad m -&gt; m SystemDefined -&gt; HasSystemDefined m
forall (m :: * -&gt; *). HasSystemDefined m =&gt; Monad (CacheRWT m)
forall (m :: * -&gt; *).
HasSystemDefined m =&gt;
CacheRWT m SystemDefined
askSystemDefined :: CacheRWT m SystemDefined
$caskSystemDefined :: forall (m :: * -&gt; *).
HasSystemDefined m =&gt;
CacheRWT m SystemDefined
$cp1HasSystemDefined :: forall (m :: * -&gt; *). HasSystemDefined m =&gt; Monad (CacheRWT m)
</span><a href="Hasura.RQL.Types.html#C%3AHasSystemDefined"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">HasSystemDefined</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-159"></span><span>      </span><span id="local-6989586621688410482"><span id="local-6989586621688410484"><span id="local-6989586621688410486"><span id="local-6989586621688410488"><span id="local-6989586621688410490"><span id="local-6989586621688410492"><span id="local-6989586621688410494"><span id="local-6989586621688410496"><span id="local-6989586621688410498"><span id="local-6989586621688410500"><span id="local-6989586621688410502"><span id="local-6989586621688410504"><span id="local-6989586621688410506"><span id="local-6989586621688410508"><span id="local-6989586621688410510"><span id="local-6989586621688410512"><span id="local-6989586621688410514"><span id="local-6989586621688410516"><span id="local-6989586621688410518"><span id="local-6989586621688410520"><span id="local-6989586621688410522"><span id="local-6989586621688410524"><span id="local-6989586621688410526"><span id="local-6989586621688410528"><span id="local-6989586621688410530"><span id="local-6989586621688410532"><span id="local-6989586621688410534"><span id="local-6989586621688410536"><span class="annot"><span class="annottext">MonadError QErr (CacheRWT m)
CacheRWT m Bool
CacheRWT m [ActionLogItem]
CacheRWT m ()
CacheRWT m ([CronEvent], [OneOffScheduledEvent])
CacheRWT m (Metadata, MetadataResourceVersion)
CacheRWT m Text
CacheRWT m CatalogState
CacheRWT m MetadataResourceVersion
[TriggerName] -&gt; CacheRWT m [CronTriggerStats]
[CronEventSeed] -&gt; CacheRWT m ()
MonadError QErr (CacheRWT m)
-&gt; CacheRWT m MetadataResourceVersion
-&gt; CacheRWT m (Metadata, MetadataResourceVersion)
-&gt; (MetadataResourceVersion
    -&gt; InstanceId
    -&gt; CacheRWT m [(MetadataResourceVersion, CacheInvalidations)])
-&gt; (MetadataResourceVersion
    -&gt; Metadata -&gt; CacheRWT m MetadataResourceVersion)
-&gt; (MetadataResourceVersion
    -&gt; InstanceId -&gt; CacheInvalidations -&gt; CacheRWT m ())
-&gt; CacheRWT m CatalogState
-&gt; (CatalogStateType -&gt; Value -&gt; CacheRWT m ())
-&gt; CacheRWT m Text
-&gt; CacheRWT m Bool
-&gt; ([TriggerName] -&gt; CacheRWT m [CronTriggerStats])
-&gt; CacheRWT m ([CronEvent], [OneOffScheduledEvent])
-&gt; ([CronEventSeed] -&gt; CacheRWT m ())
-&gt; (OneOffEvent -&gt; CacheRWT m EventId)
-&gt; (Invocation 'ScheduledType
    -&gt; ScheduledEventType -&gt; CacheRWT m ())
-&gt; (EventId
    -&gt; ScheduledEventOp -&gt; ScheduledEventType -&gt; CacheRWT m ())
-&gt; (ScheduledEventType -&gt; [EventId] -&gt; CacheRWT m Int)
-&gt; CacheRWT m ()
-&gt; (ClearCronEvents -&gt; CacheRWT m ())
-&gt; (ScheduledEventPagination
    -&gt; [ScheduledEventStatus]
    -&gt; CacheRWT m (WithTotalCount [OneOffScheduledEvent]))
-&gt; (TriggerName
    -&gt; ScheduledEventPagination
    -&gt; [ScheduledEventStatus]
    -&gt; CacheRWT m (WithTotalCount [CronEvent]))
-&gt; (GetInvocationsBy
    -&gt; ScheduledEventPagination
    -&gt; CacheRWT m (WithTotalCount [ScheduledEventInvocation]))
-&gt; (EventId -&gt; ScheduledEventType -&gt; CacheRWT m ())
-&gt; (ActionName
    -&gt; SessionVariables -&gt; [Header] -&gt; Value -&gt; CacheRWT m ActionId)
-&gt; CacheRWT m [ActionLogItem]
-&gt; (ActionId -&gt; AsyncActionStatus -&gt; CacheRWT m ())
-&gt; (ActionId -&gt; CacheRWT m ActionLogResponse)
-&gt; (ActionName -&gt; CacheRWT m ())
-&gt; (LockedActionIdArray -&gt; CacheRWT m ())
-&gt; MonadMetadataStorage (CacheRWT m)
EventId -&gt; ScheduledEventType -&gt; CacheRWT m ()
EventId -&gt; ScheduledEventOp -&gt; ScheduledEventType -&gt; CacheRWT m ()
Invocation 'ScheduledType -&gt; ScheduledEventType -&gt; CacheRWT m ()
TriggerName
-&gt; ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; CacheRWT m (WithTotalCount [CronEvent])
ActionName -&gt; CacheRWT m ()
ActionName
-&gt; SessionVariables -&gt; [Header] -&gt; Value -&gt; CacheRWT m ActionId
ActionId -&gt; CacheRWT m ActionLogResponse
ActionId -&gt; AsyncActionStatus -&gt; CacheRWT m ()
LockedActionIdArray -&gt; CacheRWT m ()
OneOffEvent -&gt; CacheRWT m EventId
ScheduledEventType -&gt; [EventId] -&gt; CacheRWT m Int
ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; CacheRWT m (WithTotalCount [OneOffScheduledEvent])
ClearCronEvents -&gt; CacheRWT m ()
GetInvocationsBy
-&gt; ScheduledEventPagination
-&gt; CacheRWT m (WithTotalCount [ScheduledEventInvocation])
CatalogStateType -&gt; Value -&gt; CacheRWT m ()
MetadataResourceVersion
-&gt; InstanceId
-&gt; CacheRWT m [(MetadataResourceVersion, CacheInvalidations)]
MetadataResourceVersion
-&gt; InstanceId -&gt; CacheInvalidations -&gt; CacheRWT m ()
MetadataResourceVersion
-&gt; Metadata -&gt; CacheRWT m MetadataResourceVersion
forall (m :: * -&gt; *).
MonadError QErr m
-&gt; m MetadataResourceVersion
-&gt; m (Metadata, MetadataResourceVersion)
-&gt; (MetadataResourceVersion
    -&gt; InstanceId -&gt; m [(MetadataResourceVersion, CacheInvalidations)])
-&gt; (MetadataResourceVersion
    -&gt; Metadata -&gt; m MetadataResourceVersion)
-&gt; (MetadataResourceVersion
    -&gt; InstanceId -&gt; CacheInvalidations -&gt; m ())
-&gt; m CatalogState
-&gt; (CatalogStateType -&gt; Value -&gt; m ())
-&gt; m Text
-&gt; m Bool
-&gt; ([TriggerName] -&gt; m [CronTriggerStats])
-&gt; m ([CronEvent], [OneOffScheduledEvent])
-&gt; ([CronEventSeed] -&gt; m ())
-&gt; (OneOffEvent -&gt; m EventId)
-&gt; (Invocation 'ScheduledType -&gt; ScheduledEventType -&gt; m ())
-&gt; (EventId -&gt; ScheduledEventOp -&gt; ScheduledEventType -&gt; m ())
-&gt; (ScheduledEventType -&gt; [EventId] -&gt; m Int)
-&gt; m ()
-&gt; (ClearCronEvents -&gt; m ())
-&gt; (ScheduledEventPagination
    -&gt; [ScheduledEventStatus]
    -&gt; m (WithTotalCount [OneOffScheduledEvent]))
-&gt; (TriggerName
    -&gt; ScheduledEventPagination
    -&gt; [ScheduledEventStatus]
    -&gt; m (WithTotalCount [CronEvent]))
-&gt; (GetInvocationsBy
    -&gt; ScheduledEventPagination
    -&gt; m (WithTotalCount [ScheduledEventInvocation]))
-&gt; (EventId -&gt; ScheduledEventType -&gt; m ())
-&gt; (ActionName
    -&gt; SessionVariables -&gt; [Header] -&gt; Value -&gt; m ActionId)
-&gt; m [ActionLogItem]
-&gt; (ActionId -&gt; AsyncActionStatus -&gt; m ())
-&gt; (ActionId -&gt; m ActionLogResponse)
-&gt; (ActionName -&gt; m ())
-&gt; (LockedActionIdArray -&gt; m ())
-&gt; MonadMetadataStorage m
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
MonadError QErr (CacheRWT m)
forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; CacheRWT m Bool
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CacheRWT m [ActionLogItem]
forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CacheRWT m ([CronEvent], [OneOffScheduledEvent])
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CacheRWT m (Metadata, MetadataResourceVersion)
forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; CacheRWT m Text
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CacheRWT m CatalogState
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CacheRWT m MetadataResourceVersion
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
[TriggerName] -&gt; CacheRWT m [CronTriggerStats]
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
[CronEventSeed] -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
EventId -&gt; ScheduledEventType -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
EventId -&gt; ScheduledEventOp -&gt; ScheduledEventType -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
Invocation 'ScheduledType -&gt; ScheduledEventType -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
TriggerName
-&gt; ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; CacheRWT m (WithTotalCount [CronEvent])
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ActionName -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ActionName
-&gt; SessionVariables -&gt; [Header] -&gt; Value -&gt; CacheRWT m ActionId
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ActionId -&gt; CacheRWT m ActionLogResponse
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ActionId -&gt; AsyncActionStatus -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
LockedActionIdArray -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
OneOffEvent -&gt; CacheRWT m EventId
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ScheduledEventType -&gt; [EventId] -&gt; CacheRWT m Int
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; CacheRWT m (WithTotalCount [OneOffScheduledEvent])
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ClearCronEvents -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
GetInvocationsBy
-&gt; ScheduledEventPagination
-&gt; CacheRWT m (WithTotalCount [ScheduledEventInvocation])
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CatalogStateType -&gt; Value -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
MetadataResourceVersion
-&gt; InstanceId
-&gt; CacheRWT m [(MetadataResourceVersion, CacheInvalidations)]
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
MetadataResourceVersion
-&gt; InstanceId -&gt; CacheInvalidations -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
MetadataResourceVersion
-&gt; Metadata -&gt; CacheRWT m MetadataResourceVersion
setProcessingActionLogsToPending :: LockedActionIdArray -&gt; CacheRWT m ()
$csetProcessingActionLogsToPending :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
LockedActionIdArray -&gt; CacheRWT m ()
clearActionData :: ActionName -&gt; CacheRWT m ()
$cclearActionData :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ActionName -&gt; CacheRWT m ()
fetchActionResponse :: ActionId -&gt; CacheRWT m ActionLogResponse
$cfetchActionResponse :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ActionId -&gt; CacheRWT m ActionLogResponse
setActionStatus :: ActionId -&gt; AsyncActionStatus -&gt; CacheRWT m ()
$csetActionStatus :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ActionId -&gt; AsyncActionStatus -&gt; CacheRWT m ()
fetchUndeliveredActionEvents :: CacheRWT m [ActionLogItem]
$cfetchUndeliveredActionEvents :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CacheRWT m [ActionLogItem]
insertAction :: ActionName
-&gt; SessionVariables -&gt; [Header] -&gt; Value -&gt; CacheRWT m ActionId
$cinsertAction :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ActionName
-&gt; SessionVariables -&gt; [Header] -&gt; Value -&gt; CacheRWT m ActionId
deleteScheduledEvent :: EventId -&gt; ScheduledEventType -&gt; CacheRWT m ()
$cdeleteScheduledEvent :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
EventId -&gt; ScheduledEventType -&gt; CacheRWT m ()
getInvocations :: GetInvocationsBy
-&gt; ScheduledEventPagination
-&gt; CacheRWT m (WithTotalCount [ScheduledEventInvocation])
$cgetInvocations :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
GetInvocationsBy
-&gt; ScheduledEventPagination
-&gt; CacheRWT m (WithTotalCount [ScheduledEventInvocation])
getCronEvents :: TriggerName
-&gt; ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; CacheRWT m (WithTotalCount [CronEvent])
$cgetCronEvents :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
TriggerName
-&gt; ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; CacheRWT m (WithTotalCount [CronEvent])
getOneOffScheduledEvents :: ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; CacheRWT m (WithTotalCount [OneOffScheduledEvent])
$cgetOneOffScheduledEvents :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; CacheRWT m (WithTotalCount [OneOffScheduledEvent])
clearFutureCronEvents :: ClearCronEvents -&gt; CacheRWT m ()
$cclearFutureCronEvents :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ClearCronEvents -&gt; CacheRWT m ()
unlockAllLockedScheduledEvents :: CacheRWT m ()
$cunlockAllLockedScheduledEvents :: forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; CacheRWT m ()
unlockScheduledEvents :: ScheduledEventType -&gt; [EventId] -&gt; CacheRWT m Int
$cunlockScheduledEvents :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
ScheduledEventType -&gt; [EventId] -&gt; CacheRWT m Int
setScheduledEventOp :: EventId -&gt; ScheduledEventOp -&gt; ScheduledEventType -&gt; CacheRWT m ()
$csetScheduledEventOp :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
EventId -&gt; ScheduledEventOp -&gt; ScheduledEventType -&gt; CacheRWT m ()
insertScheduledEventInvocation :: Invocation 'ScheduledType -&gt; ScheduledEventType -&gt; CacheRWT m ()
$cinsertScheduledEventInvocation :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
Invocation 'ScheduledType -&gt; ScheduledEventType -&gt; CacheRWT m ()
insertOneOffScheduledEvent :: OneOffEvent -&gt; CacheRWT m EventId
$cinsertOneOffScheduledEvent :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
OneOffEvent -&gt; CacheRWT m EventId
insertCronEvents :: [CronEventSeed] -&gt; CacheRWT m ()
$cinsertCronEvents :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
[CronEventSeed] -&gt; CacheRWT m ()
getScheduledEventsForDelivery :: CacheRWT m ([CronEvent], [OneOffScheduledEvent])
$cgetScheduledEventsForDelivery :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CacheRWT m ([CronEvent], [OneOffScheduledEvent])
getDeprivedCronTriggerStats :: [TriggerName] -&gt; CacheRWT m [CronTriggerStats]
$cgetDeprivedCronTriggerStats :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
[TriggerName] -&gt; CacheRWT m [CronTriggerStats]
checkMetadataStorageHealth :: CacheRWT m Bool
$ccheckMetadataStorageHealth :: forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; CacheRWT m Bool
getDatabaseUid :: CacheRWT m Text
$cgetDatabaseUid :: forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; CacheRWT m Text
setCatalogState :: CatalogStateType -&gt; Value -&gt; CacheRWT m ()
$csetCatalogState :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CatalogStateType -&gt; Value -&gt; CacheRWT m ()
getCatalogState :: CacheRWT m CatalogState
$cgetCatalogState :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CacheRWT m CatalogState
notifySchemaCacheSync :: MetadataResourceVersion
-&gt; InstanceId -&gt; CacheInvalidations -&gt; CacheRWT m ()
$cnotifySchemaCacheSync :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
MetadataResourceVersion
-&gt; InstanceId -&gt; CacheInvalidations -&gt; CacheRWT m ()
setMetadata :: MetadataResourceVersion
-&gt; Metadata -&gt; CacheRWT m MetadataResourceVersion
$csetMetadata :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
MetadataResourceVersion
-&gt; Metadata -&gt; CacheRWT m MetadataResourceVersion
fetchMetadataNotifications :: MetadataResourceVersion
-&gt; InstanceId
-&gt; CacheRWT m [(MetadataResourceVersion, CacheInvalidations)]
$cfetchMetadataNotifications :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
MetadataResourceVersion
-&gt; InstanceId
-&gt; CacheRWT m [(MetadataResourceVersion, CacheInvalidations)]
fetchMetadata :: CacheRWT m (Metadata, MetadataResourceVersion)
$cfetchMetadata :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CacheRWT m (Metadata, MetadataResourceVersion)
fetchMetadataResourceVersion :: CacheRWT m MetadataResourceVersion
$cfetchMetadataResourceVersion :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
CacheRWT m MetadataResourceVersion
$cp1MonadMetadataStorage :: forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
MonadError QErr (CacheRWT m)
</span><a href="Hasura.Metadata.Class.html#C%3AMonadMetadataStorage"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadMetadataStorage</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-160"></span><span>      </span><span id="local-6989586621688410462"><span id="local-6989586621688410464"><span id="local-6989586621688410466"><span id="local-6989586621688410468"><span id="local-6989586621688410470"><span id="local-6989586621688410472"><span id="local-6989586621688410474"><span id="local-6989586621688410476"><span id="local-6989586621688410478"><span class="annot"><span class="annottext">MonadMetadataStorage (CacheRWT m)
CacheRWT m CatalogState
[CronEventSeed] -&gt; CacheRWT m ()
EventId -&gt; ScheduledEventType -&gt; CacheRWT m ()
ActionName -&gt; CacheRWT m ()
OneOffEvent -&gt; CacheRWT m EventId
GetScheduledEvents -&gt; CacheRWT m Value
ClearCronEvents -&gt; CacheRWT m ()
GetInvocationsBy
-&gt; ScheduledEventPagination
-&gt; CacheRWT m (WithTotalCount [ScheduledEventInvocation])
CatalogStateType -&gt; Value -&gt; CacheRWT m ()
MonadMetadataStorage (CacheRWT m)
-&gt; (OneOffEvent -&gt; CacheRWT m EventId)
-&gt; ([CronEventSeed] -&gt; CacheRWT m ())
-&gt; (ClearCronEvents -&gt; CacheRWT m ())
-&gt; (ActionName -&gt; CacheRWT m ())
-&gt; (GetInvocationsBy
    -&gt; ScheduledEventPagination
    -&gt; CacheRWT m (WithTotalCount [ScheduledEventInvocation]))
-&gt; (GetScheduledEvents -&gt; CacheRWT m Value)
-&gt; (EventId -&gt; ScheduledEventType -&gt; CacheRWT m ())
-&gt; CacheRWT m CatalogState
-&gt; (CatalogStateType -&gt; Value -&gt; CacheRWT m ())
-&gt; MonadMetadataStorageQueryAPI (CacheRWT m)
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
MonadMetadataStorage (CacheRWT m)
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
CacheRWT m CatalogState
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
[CronEventSeed] -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
EventId -&gt; ScheduledEventType -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
ActionName -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
OneOffEvent -&gt; CacheRWT m EventId
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
GetScheduledEvents -&gt; CacheRWT m Value
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
ClearCronEvents -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
GetInvocationsBy
-&gt; ScheduledEventPagination
-&gt; CacheRWT m (WithTotalCount [ScheduledEventInvocation])
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
CatalogStateType -&gt; Value -&gt; CacheRWT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m
-&gt; (OneOffEvent -&gt; m EventId)
-&gt; ([CronEventSeed] -&gt; m ())
-&gt; (ClearCronEvents -&gt; m ())
-&gt; (ActionName -&gt; m ())
-&gt; (GetInvocationsBy
    -&gt; ScheduledEventPagination
    -&gt; m (WithTotalCount [ScheduledEventInvocation]))
-&gt; (GetScheduledEvents -&gt; m Value)
-&gt; (EventId -&gt; ScheduledEventType -&gt; m ())
-&gt; m CatalogState
-&gt; (CatalogStateType -&gt; Value -&gt; m ())
-&gt; MonadMetadataStorageQueryAPI m
updateCatalogState :: CatalogStateType -&gt; Value -&gt; CacheRWT m ()
$cupdateCatalogState :: forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
CatalogStateType -&gt; Value -&gt; CacheRWT m ()
fetchCatalogState :: CacheRWT m CatalogState
$cfetchCatalogState :: forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
CacheRWT m CatalogState
dropEvent :: EventId -&gt; ScheduledEventType -&gt; CacheRWT m ()
$cdropEvent :: forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
EventId -&gt; ScheduledEventType -&gt; CacheRWT m ()
fetchScheduledEvents :: GetScheduledEvents -&gt; CacheRWT m Value
$cfetchScheduledEvents :: forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
GetScheduledEvents -&gt; CacheRWT m Value
fetchInvocations :: GetInvocationsBy
-&gt; ScheduledEventPagination
-&gt; CacheRWT m (WithTotalCount [ScheduledEventInvocation])
$cfetchInvocations :: forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
GetInvocationsBy
-&gt; ScheduledEventPagination
-&gt; CacheRWT m (WithTotalCount [ScheduledEventInvocation])
deleteActionData :: ActionName -&gt; CacheRWT m ()
$cdeleteActionData :: forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
ActionName -&gt; CacheRWT m ()
dropFutureCronEvents :: ClearCronEvents -&gt; CacheRWT m ()
$cdropFutureCronEvents :: forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
ClearCronEvents -&gt; CacheRWT m ()
createCronEvents :: [CronEventSeed] -&gt; CacheRWT m ()
$ccreateCronEvents :: forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
[CronEventSeed] -&gt; CacheRWT m ()
createOneOffScheduledEvent :: OneOffEvent -&gt; CacheRWT m EventId
$ccreateOneOffScheduledEvent :: forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
OneOffEvent -&gt; CacheRWT m EventId
$cp1MonadMetadataStorageQueryAPI :: forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
MonadMetadataStorage (CacheRWT m)
</span><a href="Hasura.Metadata.Class.html#C%3AMonadMetadataStorageQueryAPI"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadMetadataStorageQueryAPI</span></a></span></span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>      </span><span id="local-6989586621688410452"><span id="local-6989586621688410454"><span id="local-6989586621688410456"><span id="local-6989586621688410458"><span class="annot"><span class="annottext">Monad (CacheRWT m)
CacheRWT m TraceContext
CacheRWT m Reporter
Monad (CacheRWT m)
-&gt; (forall a. Text -&gt; CacheRWT m a -&gt; CacheRWT m a)
-&gt; CacheRWT m TraceContext
-&gt; CacheRWT m Reporter
-&gt; (TracingMetadata -&gt; CacheRWT m ())
-&gt; MonadTrace (CacheRWT m)
TracingMetadata -&gt; CacheRWT m ()
Text -&gt; CacheRWT m a -&gt; CacheRWT m a
forall a. Text -&gt; CacheRWT m a -&gt; CacheRWT m a
forall (m :: * -&gt; *).
Monad m
-&gt; (forall a. Text -&gt; m a -&gt; m a)
-&gt; m TraceContext
-&gt; m Reporter
-&gt; (TracingMetadata -&gt; m ())
-&gt; MonadTrace m
forall (m :: * -&gt; *). MonadTrace m =&gt; Monad (CacheRWT m)
forall (m :: * -&gt; *). MonadTrace m =&gt; CacheRWT m TraceContext
forall (m :: * -&gt; *). MonadTrace m =&gt; CacheRWT m Reporter
forall (m :: * -&gt; *).
MonadTrace m =&gt;
TracingMetadata -&gt; CacheRWT m ()
forall (m :: * -&gt; *) a.
MonadTrace m =&gt;
Text -&gt; CacheRWT m a -&gt; CacheRWT m a
attachMetadata :: TracingMetadata -&gt; CacheRWT m ()
$cattachMetadata :: forall (m :: * -&gt; *).
MonadTrace m =&gt;
TracingMetadata -&gt; CacheRWT m ()
currentReporter :: CacheRWT m Reporter
$ccurrentReporter :: forall (m :: * -&gt; *). MonadTrace m =&gt; CacheRWT m Reporter
currentContext :: CacheRWT m TraceContext
$ccurrentContext :: forall (m :: * -&gt; *). MonadTrace m =&gt; CacheRWT m TraceContext
trace :: Text -&gt; CacheRWT m a -&gt; CacheRWT m a
$ctrace :: forall (m :: * -&gt; *) a.
MonadTrace m =&gt;
Text -&gt; CacheRWT m a -&gt; CacheRWT m a
$cp1MonadTrace :: forall (m :: * -&gt; *). MonadTrace m =&gt; Monad (CacheRWT m)
</span><a href="Hasura.Tracing.html#C%3AMonadTrace"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Tracing.MonadTrace</span></a></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>      </span><span id="local-6989586621688410448"><span class="annot"><span class="annottext">Monad (CacheRWT m)
CacheRWT m ServerConfigCtx
Monad (CacheRWT m)
-&gt; CacheRWT m ServerConfigCtx -&gt; HasServerConfigCtx (CacheRWT m)
forall (m :: * -&gt; *).
Monad m -&gt; m ServerConfigCtx -&gt; HasServerConfigCtx m
forall (m :: * -&gt; *). HasServerConfigCtx m =&gt; Monad (CacheRWT m)
forall (m :: * -&gt; *).
HasServerConfigCtx m =&gt;
CacheRWT m ServerConfigCtx
askServerConfigCtx :: CacheRWT m ServerConfigCtx
$caskServerConfigCtx :: forall (m :: * -&gt; *).
HasServerConfigCtx m =&gt;
CacheRWT m ServerConfigCtx
$cp1HasServerConfigCtx :: forall (m :: * -&gt; *). HasServerConfigCtx m =&gt; Monad (CacheRWT m)
</span><a href="Hasura.RQL.Types.html#C%3AHasServerConfigCtx"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">HasServerConfigCtx</span></a></span></span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-special">)</span></span></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span id="local-6989586621688410440"><span id="local-6989586621688410446"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadBase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688410446"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-type">CacheRWT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410446"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span id="local-6989586621688410433"><span id="local-6989586621688410435"><span id="local-6989586621688410438"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688410438"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-type">CacheRWT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410438"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span id="local-6989586621688410430"><span id="local-6989586621688410431"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#runCacheRWT"><span class="hs-identifier hs-type">runCacheRWT</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-170"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="#local-6989586621688410431"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-type">RebuildableSchemaCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-type">CacheRWT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410431"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410430"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><a href="#local-6989586621688410431"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688410430"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-type">RebuildableSchemaCache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheInvalidations"><span class="hs-identifier hs-type">CacheInvalidations</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-174"></span><span id="runCacheRWT"><span class="annot"><span class="annottext">runCacheRWT :: RebuildableSchemaCache
-&gt; CacheRWT m a
-&gt; m (a, RebuildableSchemaCache, CacheInvalidations)
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#runCacheRWT"><span class="hs-identifier hs-var hs-var">runCacheRWT</span></a></span></span><span> </span><span id="local-6989586621688410429"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688410429"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-type">CacheRWT</span></a></span><span> </span><span id="local-6989586621688410428"><span class="annot"><span class="annottext">StateT (RebuildableSchemaCache, CacheInvalidations) m a
</span><a href="#local-6989586621688410428"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><span class="annottext">StateT (RebuildableSchemaCache, CacheInvalidations) m a
-&gt; (RebuildableSchemaCache, CacheInvalidations)
-&gt; m (a, (RebuildableSchemaCache, CacheInvalidations))
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">runStateT</span></span><span> </span><span class="annot"><span class="annottext">StateT (RebuildableSchemaCache, CacheInvalidations) m a
</span><a href="#local-6989586621688410428"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688410429"><span class="hs-identifier hs-var">cache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (a, (RebuildableSchemaCache, CacheInvalidations))
-&gt; ((a, (RebuildableSchemaCache, CacheInvalidations))
    -&gt; (a, RebuildableSchemaCache, CacheInvalidations))
-&gt; m (a, RebuildableSchemaCache, CacheInvalidations)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688410425"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688410425"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410424"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688410424"><span class="hs-identifier hs-var">newCache</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410423"><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688410423"><span class="hs-identifier hs-var">invalidations</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688410425"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688410424"><span class="hs-identifier hs-var">newCache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688410423"><span class="hs-identifier hs-var">invalidations</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTrans</span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-type">CacheRWT</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-178"></span><span>  </span><span id="local-6989586621688410420"><span class="annot"><span class="annottext">lift :: m a -&gt; CacheRWT m a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">lift</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateT (RebuildableSchemaCache, CacheInvalidations) m a
-&gt; CacheRWT m a
forall (m :: * -&gt; *) a.
StateT (RebuildableSchemaCache, CacheInvalidations) m a
-&gt; CacheRWT m a
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-var">CacheRWT</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT (RebuildableSchemaCache, CacheInvalidations) m a
 -&gt; CacheRWT m a)
-&gt; (m a -&gt; StateT (RebuildableSchemaCache, CacheInvalidations) m a)
-&gt; m a
-&gt; CacheRWT m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">m a -&gt; StateT (RebuildableSchemaCache, CacheInvalidations) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span id="local-6989586621688410417"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688410417"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#CacheRM"><span class="hs-identifier hs-type">CacheRM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-type">CacheRWT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410417"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-181"></span><span>  </span><span id="local-6989586621688410413"><span class="annot"><span class="annottext">askSchemaCache :: CacheRWT m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var hs-var hs-var hs-var">askSchemaCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateT (RebuildableSchemaCache, CacheInvalidations) m SchemaCache
-&gt; CacheRWT m SchemaCache
forall (m :: * -&gt; *) a.
StateT (RebuildableSchemaCache, CacheInvalidations) m a
-&gt; CacheRWT m a
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-var">CacheRWT</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT (RebuildableSchemaCache, CacheInvalidations) m SchemaCache
 -&gt; CacheRWT m SchemaCache)
-&gt; StateT
     (RebuildableSchemaCache, CacheInvalidations) m SchemaCache
-&gt; CacheRWT m SchemaCache
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((RebuildableSchemaCache, CacheInvalidations) -&gt; SchemaCache)
-&gt; StateT
     (RebuildableSchemaCache, CacheInvalidations) m SchemaCache
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RebuildableSchemaCache -&gt; SchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#lastBuiltSchemaCache"><span class="hs-identifier hs-var hs-var">lastBuiltSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">(RebuildableSchemaCache -&gt; SchemaCache)
-&gt; ((RebuildableSchemaCache, CacheInvalidations)
    -&gt; RebuildableSchemaCache)
-&gt; (RebuildableSchemaCache, CacheInvalidations)
-&gt; SchemaCache
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RebuildableSchemaCache, CacheInvalidations)
-&gt; Getting
     RebuildableSchemaCache
     (RebuildableSchemaCache, CacheInvalidations)
     RebuildableSchemaCache
-&gt; RebuildableSchemaCache
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  RebuildableSchemaCache
  (RebuildableSchemaCache, CacheInvalidations)
  RebuildableSchemaCache
forall s t a b. Field1 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_1</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span id="local-6989586621688410408"><span class="hs-keyword">instance</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688410408"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410408"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><a href="Network.HTTP.Client.Manager.html#HasHttpManagerM"><span class="hs-identifier hs-type">HasHttpManagerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410408"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410408"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.html#HasServerConfigCtx"><span class="hs-identifier hs-type">HasServerConfigCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410408"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-190"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-type">CacheRWT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410408"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-192"></span><span>  </span><span id="local-6989586621688410403"><span class="annot"><span class="annottext">buildSchemaCacheWithOptions :: BuildReason -&gt; CacheInvalidations -&gt; Metadata -&gt; CacheRWT m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCacheWithOptions"><span class="hs-identifier hs-var hs-var hs-var hs-var">buildSchemaCacheWithOptions</span></a></span></span><span> </span><span id="local-6989586621688410401"><span class="annot"><span class="annottext">BuildReason
</span><a href="#local-6989586621688410401"><span class="hs-identifier hs-var">buildReason</span></a></span></span><span> </span><span id="local-6989586621688410400"><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688410400"><span class="hs-identifier hs-var">invalidations</span></a></span></span><span> </span><span id="local-6989586621688410399"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688410399"><span class="hs-identifier hs-var">metadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateT (RebuildableSchemaCache, CacheInvalidations) m ()
-&gt; CacheRWT m ()
forall (m :: * -&gt; *) a.
StateT (RebuildableSchemaCache, CacheInvalidations) m a
-&gt; CacheRWT m a
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-var">CacheRWT</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-type">RebuildableSchemaCache</span></a></span><span> </span><span id="local-6989586621688410398"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688410398"><span class="hs-identifier hs-var">lastBuiltSC</span></a></span></span><span> </span><span id="local-6989586621688410397"><span class="annot"><span class="annottext">InvalidationKeys
</span><a href="#local-6989586621688410397"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span> </span><span id="local-6989586621688410396"><span class="annot"><span class="annottext">Rule
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
</span><a href="#local-6989586621688410396"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410395"><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688410395"><span class="hs-identifier hs-var">oldInvalidations</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (RebuildableSchemaCache, CacheInvalidations)
  m
  (RebuildableSchemaCache, CacheInvalidations)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410393"><span class="annot"><span class="annottext">metadataVersion :: Maybe MetadataResourceVersion
</span><a href="#local-6989586621688410393"><span class="hs-identifier hs-var hs-var">metadataVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; Maybe MetadataResourceVersion
</span><a href="Hasura.RQL.Types.SchemaCache.html#scMetadataResourceVersion"><span class="hs-identifier hs-var hs-var">scMetadataResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688410398"><span class="hs-identifier hs-var">lastBuiltSC</span></a></span><span>
</span><span id="line-195"></span><span>        </span><span id="local-6989586621688410391"><span class="annot"><span class="annottext">newInvalidationKeys :: InvalidationKeys
</span><a href="#local-6989586621688410391"><span class="hs-identifier hs-var hs-var">newInvalidationKeys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheInvalidations -&gt; InvalidationKeys -&gt; InvalidationKeys
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#invalidateKeys"><span class="hs-identifier hs-var">invalidateKeys</span></a></span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688410400"><span class="hs-identifier hs-var">invalidations</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidationKeys
</span><a href="#local-6989586621688410397"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span id="local-6989586621688410389"><span class="annot"><span class="annottext">Result
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
</span><a href="#local-6989586621688410389"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-197"></span><span>      </span><span class="annot"><span class="annottext">m (Result
     (ReaderT BuildReason CacheBuild)
     (Metadata, InvalidationKeys)
     SchemaCache)
-&gt; StateT
     (RebuildableSchemaCache, CacheInvalidations)
     m
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (Result
      (ReaderT BuildReason CacheBuild)
      (Metadata, InvalidationKeys)
      SchemaCache)
 -&gt; StateT
      (RebuildableSchemaCache, CacheInvalidations)
      m
      (Result
         (ReaderT BuildReason CacheBuild)
         (Metadata, InvalidationKeys)
         SchemaCache))
-&gt; m (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
-&gt; StateT
     (RebuildableSchemaCache, CacheInvalidations)
     m
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><span class="annottext">CacheBuild
  (Result
     (ReaderT BuildReason CacheBuild)
     (Metadata, InvalidationKeys)
     SchemaCache)
-&gt; m (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadError QErr m, HasHttpManagerM m,
 HasServerConfigCtx m, MonadResolveSource m) =&gt;
CacheBuild a -&gt; m a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#runCacheBuildM"><span class="hs-identifier hs-var">runCacheBuildM</span></a></span><span> </span><span class="annot"><span class="annottext">(CacheBuild
   (Result
      (ReaderT BuildReason CacheBuild)
      (Metadata, InvalidationKeys)
      SchemaCache)
 -&gt; m (Result
         (ReaderT BuildReason CacheBuild)
         (Metadata, InvalidationKeys)
         SchemaCache))
-&gt; CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
-&gt; m (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-199"></span><span>          </span><span class="annot"><span class="annottext">(ReaderT
   BuildReason
   CacheBuild
   (Result
      (ReaderT BuildReason CacheBuild)
      (Metadata, InvalidationKeys)
      SchemaCache)
 -&gt; BuildReason
 -&gt; CacheBuild
      (Result
         (ReaderT BuildReason CacheBuild)
         (Metadata, InvalidationKeys)
         SchemaCache))
-&gt; BuildReason
-&gt; ReaderT
     BuildReason
     CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
-&gt; CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT
  BuildReason
  CacheBuild
  (Result
     (ReaderT BuildReason CacheBuild)
     (Metadata, InvalidationKeys)
     SchemaCache)
-&gt; BuildReason
-&gt; CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">BuildReason
</span><a href="#local-6989586621688410401"><span class="hs-identifier hs-var">buildReason</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   BuildReason
   CacheBuild
   (Result
      (ReaderT BuildReason CacheBuild)
      (Metadata, InvalidationKeys)
      SchemaCache)
 -&gt; CacheBuild
      (Result
         (ReaderT BuildReason CacheBuild)
         (Metadata, InvalidationKeys)
         SchemaCache))
-&gt; ReaderT
     BuildReason
     CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
-&gt; CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-200"></span><span>            </span><span class="annot"><span class="annottext">Rule
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
-&gt; (Metadata, InvalidationKeys)
-&gt; ReaderT
     BuildReason
     CacheBuild
     (Result
        (ReaderT BuildReason CacheBuild)
        (Metadata, InvalidationKeys)
        SchemaCache)
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
Rule m a b -&gt; a -&gt; m (Result m a b)
</span><a href="Hasura.Incremental.Internal.Rule.html#build"><span class="hs-identifier hs-var">Inc.build</span></a></span><span> </span><span class="annot"><span class="annottext">Rule
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
</span><a href="#local-6989586621688410396"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688410399"><span class="hs-identifier hs-var">metadata</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InvalidationKeys
</span><a href="#local-6989586621688410391"><span class="hs-identifier hs-var">newInvalidationKeys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410387"><span class="annot"><span class="annottext">schemaCache :: SchemaCache
</span><a href="#local-6989586621688410387"><span class="hs-identifier hs-var hs-var">schemaCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
-&gt; SchemaCache
forall (m :: * -&gt; *) a b. Result m a b -&gt; b
</span><a href="Hasura.Incremental.Internal.Rule.html#result"><span class="hs-identifier hs-var hs-var">Inc.result</span></a></span><span> </span><span class="annot"><span class="annottext">Result
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
</span><a href="#local-6989586621688410389"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">scMetadataResourceVersion :: Maybe MetadataResourceVersion
</span><a href="Hasura.RQL.Types.SchemaCache.html#scMetadataResourceVersion"><span class="hs-identifier hs-var">scMetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe MetadataResourceVersion
</span><a href="#local-6989586621688410393"><span class="hs-identifier hs-var">metadataVersion</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-202"></span><span>        </span><span id="local-6989586621688410386"><span class="annot"><span class="annottext">prunedInvalidationKeys :: InvalidationKeys
</span><a href="#local-6989586621688410386"><span class="hs-identifier hs-var hs-var">prunedInvalidationKeys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; InvalidationKeys -&gt; InvalidationKeys
</span><a href="#local-6989586621688410385"><span class="hs-identifier hs-var">pruneInvalidationKeys</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688410387"><span class="hs-identifier hs-var">schemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidationKeys
</span><a href="#local-6989586621688410391"><span class="hs-identifier hs-var">newInvalidationKeys</span></a></span><span>
</span><span id="line-203"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621688410384"><span class="annot"><span class="annottext">newCache :: RebuildableSchemaCache
</span><a href="#local-6989586621688410384"><span class="hs-identifier hs-var hs-var">newCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SchemaCache
-&gt; InvalidationKeys
-&gt; Rule
     (ReaderT BuildReason CacheBuild)
     (Metadata, InvalidationKeys)
     SchemaCache
-&gt; RebuildableSchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-var">RebuildableSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688410387"><span class="hs-identifier hs-var">schemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidationKeys
</span><a href="#local-6989586621688410386"><span class="hs-identifier hs-var">prunedInvalidationKeys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
-&gt; Rule
     (ReaderT BuildReason CacheBuild)
     (Metadata, InvalidationKeys)
     SchemaCache
forall (m :: * -&gt; *) a b. Result m a b -&gt; Rule m a b
</span><a href="Hasura.Incremental.Internal.Rule.html#rebuildRule"><span class="hs-identifier hs-var hs-var">Inc.rebuildRule</span></a></span><span> </span><span class="annot"><span class="annottext">Result
  (ReaderT BuildReason CacheBuild)
  (Metadata, InvalidationKeys)
  SchemaCache
</span><a href="#local-6989586621688410389"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621688410383"><span class="annot"><span class="annottext">newInvalidations :: CacheInvalidations
</span><a href="#local-6989586621688410383"><span class="hs-identifier hs-var hs-var">newInvalidations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688410395"><span class="hs-identifier hs-var">oldInvalidations</span></a></span><span> </span><span class="annot"><span class="annottext">CacheInvalidations -&gt; CacheInvalidations -&gt; CacheInvalidations
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688410400"><span class="hs-identifier hs-var">invalidations</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><span class="annottext">(RebuildableSchemaCache, CacheInvalidations)
-&gt; StateT (RebuildableSchemaCache, CacheInvalidations) m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688410384"><span class="hs-identifier hs-var">newCache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688410383"><span class="hs-identifier hs-var">newInvalidations</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-comment">-- Prunes invalidation keys that no longer exist in the schema to avoid leaking memory by</span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-comment">-- hanging onto unnecessary keys.</span><span>
</span><span id="line-209"></span><span>      </span><span id="local-6989586621688410385"><span class="annot"><span class="annottext">pruneInvalidationKeys :: SchemaCache -&gt; InvalidationKeys -&gt; InvalidationKeys
</span><a href="#local-6989586621688410385"><span class="hs-identifier hs-var hs-var">pruneInvalidationKeys</span></a></span></span><span> </span><span id="local-6989586621688410381"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688410381"><span class="hs-identifier hs-var">schemaCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ASetter
  InvalidationKeys
  InvalidationKeys
  (HashMap RemoteSchemaName InvalidationKey)
  (HashMap RemoteSchemaName InvalidationKey)
-&gt; (HashMap RemoteSchemaName InvalidationKey
    -&gt; HashMap RemoteSchemaName InvalidationKey)
-&gt; InvalidationKeys
-&gt; InvalidationKeys
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  InvalidationKeys
  InvalidationKeys
  (HashMap RemoteSchemaName InvalidationKey)
  (HashMap RemoteSchemaName InvalidationKey)
Lens' InvalidationKeys (HashMap RemoteSchemaName InvalidationKey)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#ikRemoteSchemas"><span class="hs-identifier hs-var">ikRemoteSchemas</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap RemoteSchemaName InvalidationKey
  -&gt; HashMap RemoteSchemaName InvalidationKey)
 -&gt; InvalidationKeys -&gt; InvalidationKeys)
-&gt; (HashMap RemoteSchemaName InvalidationKey
    -&gt; HashMap RemoteSchemaName InvalidationKey)
-&gt; InvalidationKeys
-&gt; InvalidationKeys
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaName -&gt; InvalidationKey -&gt; Bool)
-&gt; HashMap RemoteSchemaName InvalidationKey
-&gt; HashMap RemoteSchemaName InvalidationKey
forall k v. (k -&gt; v -&gt; Bool) -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.filterWithKey</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688410377"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688410377"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">InvalidationKey
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-210"></span><span>        </span><span class="hs-comment">-- see Note [Keep invalidation keys for inconsistent objects]</span><span>
</span><span id="line-211"></span><span>        </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688410377"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; [RemoteSchemaName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; [RemoteSchemaName]
</span><a href="Hasura.RQL.Types.SchemaCache.html#getAllRemoteSchemas"><span class="hs-identifier hs-var">getAllRemoteSchemas</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688410381"><span class="hs-identifier hs-var">schemaCache</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>  </span><span id="local-6989586621688410374"><span class="annot"><span class="annottext">setMetadataResourceVersionInSchemaCache :: MetadataResourceVersion -&gt; CacheRWT m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#setMetadataResourceVersionInSchemaCache"><span class="hs-identifier hs-var hs-var hs-var hs-var">setMetadataResourceVersionInSchemaCache</span></a></span></span><span> </span><span id="local-6989586621688410372"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688410372"><span class="hs-identifier hs-var">resourceVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateT (RebuildableSchemaCache, CacheInvalidations) m ()
-&gt; CacheRWT m ()
forall (m :: * -&gt; *) a.
StateT (RebuildableSchemaCache, CacheInvalidations) m a
-&gt; CacheRWT m a
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#CacheRWT"><span class="hs-identifier hs-var">CacheRWT</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT (RebuildableSchemaCache, CacheInvalidations) m ()
 -&gt; CacheRWT m ())
-&gt; StateT (RebuildableSchemaCache, CacheInvalidations) m ()
-&gt; CacheRWT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621688410371"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688410371"><span class="hs-identifier hs-var">rebuildableSchemaCache</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410370"><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688410370"><span class="hs-identifier hs-var">invalidations</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (RebuildableSchemaCache, CacheInvalidations)
  m
  (RebuildableSchemaCache, CacheInvalidations)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">(RebuildableSchemaCache, CacheInvalidations)
-&gt; StateT (RebuildableSchemaCache, CacheInvalidations) m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span>
</span><span id="line-216"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688410371"><span class="hs-identifier hs-var">rebuildableSchemaCache</span></a></span><span>
</span><span id="line-217"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lastBuiltSchemaCache :: SchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#lastBuiltSchemaCache"><span class="hs-identifier hs-var">lastBuiltSchemaCache</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-218"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RebuildableSchemaCache -&gt; SchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#lastBuiltSchemaCache"><span class="hs-identifier hs-var hs-var">lastBuiltSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688410371"><span class="hs-identifier hs-var">rebuildableSchemaCache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scMetadataResourceVersion :: Maybe MetadataResourceVersion
</span><a href="Hasura.RQL.Types.SchemaCache.html#scMetadataResourceVersion"><span class="hs-identifier hs-var">scMetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; Maybe MetadataResourceVersion
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688410372"><span class="hs-identifier hs-var">resourceVersion</span></a></span><span>
</span><span id="line-220"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-221"></span><span>          </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-222"></span><span>        </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688410370"><span class="hs-identifier hs-var">invalidations</span></a></span><span>
</span><span id="line-223"></span><span>      </span><span class="hs-special">)</span></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span id="local-6989586621688411524"><span id="local-6989586621688411527"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#buildSchemaCacheRule"><span class="hs-identifier hs-type">buildSchemaCacheRule</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-comment">-- Note: by supplying BuildReason via MonadReader, it does not participate in caching, which is</span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-comment">-- what we want!</span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688411527"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411527"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-230"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411524"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411527"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688411524"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688411524"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411524"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#BuildReason"><span class="hs-identifier hs-type">BuildReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411524"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-235"></span><span>    </span><span class="annot"><a href="Network.HTTP.Client.Manager.html#HasHttpManagerM"><span class="hs-identifier hs-type">HasHttpManagerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411524"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411524"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-237"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.html#HasServerConfigCtx"><span class="hs-identifier hs-type">HasServerConfigCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411524"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#Metadata"><span class="hs-identifier hs-type">Metadata</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#InvalidationKeys"><span class="hs-identifier hs-type">InvalidationKeys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688411527"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#SchemaCache"><span class="hs-identifier hs-type">SchemaCache</span></a></span></span></span><span>
</span><span id="line-242"></span><span id="buildSchemaCacheRule"><span class="annot"><span class="annottext">buildSchemaCacheRule :: Logger Hasura
-&gt; Environment -&gt; arr (Metadata, InvalidationKeys) SchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#buildSchemaCacheRule"><span class="hs-identifier hs-var hs-var">buildSchemaCacheRule</span></a></span></span><span> </span><span id="local-6989586621688410369"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688410369"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688410368"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688410368"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410367"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688410367"><span class="hs-identifier hs-var">metadata</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410366"><span class="annot"><span class="annottext">InvalidationKeys
</span><a href="#local-6989586621688410366"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>  </span><span id="local-6989586621688410365"><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410365"><span class="hs-identifier hs-var">invalidationKeysDep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr InvalidationKeys (Dependency InvalidationKeys)
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowCache m arr =&gt;
arr a (Dependency a)
</span><a href="Hasura.Incremental.Internal.Cache.html#newDependency"><span class="hs-identifier hs-var">Inc.newDependency</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">InvalidationKeys
</span><a href="#local-6989586621688410366"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-comment">-- Step 1: Process metadata and collect dependency information.</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621688410363"><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410363"><span class="hs-identifier hs-var">outputs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410362"><span class="annot"><span class="annottext">Seq CollectedInfo
</span><a href="#local-6989586621688410362"><span class="hs-identifier hs-var">collectedInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><span class="annottext">WriterA
  (Seq CollectedInfo)
  arr
  (Metadata, Dependency InvalidationKeys)
  BuildOutputs
-&gt; (Monoid (Seq CollectedInfo), Arrow arr) =&gt;
   arr
     (Metadata, Dependency InvalidationKeys)
     (BuildOutputs, Seq CollectedInfo)
forall w (arr :: * -&gt; * -&gt; *) a b.
WriterA w arr a b -&gt; (Monoid w, Arrow arr) =&gt; arr a (b, w)
</span><a href="Control.Arrow.Trans.html#runWriterA"><span class="hs-identifier hs-var">runWriterA</span></a></span><span> </span><span class="annot"><span class="annottext">WriterA
  (Seq CollectedInfo)
  arr
  (Metadata, Dependency InvalidationKeys)
  BuildOutputs
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr, MonadIO m, MonadError QErr m,
 MonadReader BuildReason m, MonadBaseControl IO m,
 HasHttpManagerM m, HasServerConfigCtx m, MonadResolveSource m) =&gt;
arr (Metadata, Dependency InvalidationKeys) BuildOutputs
</span><a href="#local-6989586621688410360"><span class="hs-identifier hs-var">buildAndCollectInfo</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688410367"><span class="hs-identifier hs-var">metadata</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410365"><span class="hs-identifier hs-var">invalidationKeysDep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410359"><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621688410359"><span class="hs-identifier hs-var">inconsistentObjects</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410358"><span class="annot"><span class="annottext">[(MetadataObject, SchemaObjId, SchemaDependency)]
</span><a href="#local-6989586621688410358"><span class="hs-identifier hs-var">unresolvedDependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Seq CollectedInfo
-&gt; ([InconsistentMetadata],
    [(MetadataObject, SchemaObjId, SchemaDependency)])
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#partitionCollectedInfo"><span class="hs-identifier hs-var">partitionCollectedInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Seq CollectedInfo
</span><a href="#local-6989586621688410362"><span class="hs-identifier hs-var">collectedInfo</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-comment">-- Step 2: Resolve dependency information and drop dangling dependents.</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621688410356"><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410355"><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621688410355"><span class="hs-identifier hs-var">dependencyInconsistentObjects</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410354"><span class="annot"><span class="annottext">DepMap
</span><a href="#local-6989586621688410354"><span class="hs-identifier hs-var">resolvedDependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-252"></span><span>    </span><span class="annot"><span class="annottext">arr
  (BuildOutputs, [(MetadataObject, SchemaObjId, SchemaDependency)])
  (BuildOutputs, [InconsistentMetadata], DepMap)
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *).
(ArrowKleisli m arr, QErrM m) =&gt;
arr
  (BuildOutputs, [(MetadataObject, SchemaObjId, SchemaDependency)])
  (BuildOutputs, [InconsistentMetadata], DepMap)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Dependencies.html#resolveDependencies"><span class="hs-identifier hs-var">resolveDependencies</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410363"><span class="hs-identifier hs-var">outputs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(MetadataObject, SchemaObjId, SchemaDependency)]
</span><a href="#local-6989586621688410358"><span class="hs-identifier hs-var">unresolvedDependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-comment">-- Steps 3 and 4: Build the regular and relay GraphQL schemas in parallel</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span id="local-6989586621688410352"><span class="annot"><span class="annottext">SchemaIntrospection
</span><a href="#local-6989586621688410352"><span class="hs-identifier hs-var">adminIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410351"><span class="annot"><span class="annottext">HashMap RoleName (RoleContext GQLContext)
</span><a href="#local-6989586621688410351"><span class="hs-identifier hs-var">gqlContext</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410350"><span class="annot"><span class="annottext">GQLContext
</span><a href="#local-6989586621688410350"><span class="hs-identifier hs-var">gqlContextUnauth</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410349"><span class="annot"><span class="annottext">HashSet InconsistentMetadata
</span><a href="#local-6989586621688410349"><span class="hs-identifier hs-var">inconsistentRemoteSchemas</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaIntrospection
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410348"><span class="annot"><span class="annottext">HashMap RoleName (RoleContext GQLContext)
</span><a href="#local-6989586621688410348"><span class="hs-identifier hs-var">relayContext</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410347"><span class="annot"><span class="annottext">GQLContext
</span><a href="#local-6989586621688410347"><span class="hs-identifier hs-var">relayContextUnauth</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet InconsistentMetadata
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="annottext">arr
  (m [(SchemaIntrospection,
       HashMap RoleName (RoleContext GQLContext), GQLContext,
       HashSet InconsistentMetadata)])
  [(SchemaIntrospection, HashMap RoleName (RoleContext GQLContext),
    GQLContext, HashSet InconsistentMetadata)]
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-257"></span><span>      </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-258"></span><span>        </span><span id="local-6989586621688410345"><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688410345"><span class="hs-identifier hs-var">cxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m ServerConfigCtx
forall (m :: * -&gt; *). HasServerConfigCtx m =&gt; m ServerConfigCtx
</span><a href="Hasura.RQL.Types.html#askServerConfigCtx"><span class="hs-identifier hs-var">askServerConfigCtx</span></a></span><span>
</span><span id="line-259"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; [GraphQLQueryType]
-&gt; (GraphQLQueryType
    -&gt; ExceptT
         QErr
         IO
         (SchemaIntrospection, HashMap RoleName (RoleContext GQLContext),
          GQLContext, HashSet InconsistentMetadata))
-&gt; m [(SchemaIntrospection,
       HashMap RoleName (RoleContext GQLContext), GQLContext,
       HashSet InconsistentMetadata)]
forall (m :: * -&gt; *) e a b.
(MonadIO m, MonadError e m) =&gt;
Int -&gt; [a] -&gt; (a -&gt; ExceptT e IO b) -&gt; m [b]
</span><a href="Control.Concurrent.Extended.html#forConcurrentlyEIO"><span class="hs-identifier hs-var">forConcurrentlyEIO</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">GraphQLQueryType
</span><a href="Hasura.GraphQL.Execute.Types.html#QueryHasura"><span class="hs-identifier hs-var">QueryHasura</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">GraphQLQueryType
</span><a href="Hasura.GraphQL.Execute.Types.html#QueryRelay"><span class="hs-identifier hs-var">QueryRelay</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">((GraphQLQueryType
  -&gt; ExceptT
       QErr
       IO
       (SchemaIntrospection, HashMap RoleName (RoleContext GQLContext),
        GQLContext, HashSet InconsistentMetadata))
 -&gt; m [(SchemaIntrospection,
        HashMap RoleName (RoleContext GQLContext), GQLContext,
        HashSet InconsistentMetadata)])
-&gt; (GraphQLQueryType
    -&gt; ExceptT
         QErr
         IO
         (SchemaIntrospection, HashMap RoleName (RoleContext GQLContext),
          GQLContext, HashSet InconsistentMetadata))
-&gt; m [(SchemaIntrospection,
       HashMap RoleName (RoleContext GQLContext), GQLContext,
       HashSet InconsistentMetadata)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688410341"><span class="annot"><span class="annottext">GraphQLQueryType
</span><a href="#local-6989586621688410341"><span class="hs-identifier hs-var">queryType</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>          </span><span class="annot"><span class="annottext">ServerConfigCtx
-&gt; GraphQLQueryType
-&gt; SourceCache
-&gt; HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject)
-&gt; ActionCache
-&gt; AnnotatedCustomTypes
-&gt; ExceptT
     QErr
     IO
     (SchemaIntrospection, HashMap RoleName (RoleContext GQLContext),
      GQLContext, HashSet InconsistentMetadata)
forall (m :: * -&gt; *).
(MonadError QErr m, MonadIO m) =&gt;
ServerConfigCtx
-&gt; GraphQLQueryType
-&gt; SourceCache
-&gt; HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject)
-&gt; ActionCache
-&gt; AnnotatedCustomTypes
-&gt; m (SchemaIntrospection,
      HashMap RoleName (RoleContext GQLContext), GQLContext,
      HashSet InconsistentMetadata)
</span><a href="Hasura.GraphQL.Schema.html#buildGQLContext"><span class="hs-identifier hs-var">buildGQLContext</span></a></span><span>
</span><span id="line-261"></span><span>            </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688410345"><span class="hs-identifier hs-var">cxt</span></a></span><span>
</span><span id="line-262"></span><span>            </span><span class="annot"><span class="annottext">GraphQLQueryType
</span><a href="#local-6989586621688410341"><span class="hs-identifier hs-var">queryType</span></a></span><span>
</span><span id="line-263"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuildOutputs -&gt; SourceCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boSources"><span class="hs-identifier hs-var hs-var">_boSources</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuildOutputs
-&gt; HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boRemoteSchemas"><span class="hs-identifier hs-var hs-var">_boRemoteSchemas</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuildOutputs -&gt; ActionCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boActions"><span class="hs-identifier hs-var hs-var">_boActions</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuildOutputs -&gt; AnnotatedCustomTypes
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boCustomTypes"><span class="hs-identifier hs-var hs-var">_boCustomTypes</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688411216"><span class="annot"><a href="#local-6989586621688410336"><span class="hs-identifier hs-type">duplicateVariables</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#EndpointMetadata"><span class="hs-identifier hs-type">EndpointMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411216"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-269"></span><span>      </span><span id="local-6989586621688410336"><span class="annot"><span class="annottext">duplicateVariables :: EndpointMetadata a -&gt; Bool
</span><a href="#local-6989586621688410336"><span class="hs-identifier hs-var hs-var">duplicateVariables</span></a></span></span><span> </span><span id="local-6989586621688410335"><span class="annot"><span class="annottext">EndpointMetadata a
</span><a href="#local-6989586621688410335"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Bool) -&gt; [[Text]] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Bool) -&gt; ([Text] -&gt; Int) -&gt; [Text] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([[Text]] -&gt; Bool) -&gt; [[Text]] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; [[Text]]
forall a. Eq a =&gt; [a] -&gt; [[a]]
</span><span class="hs-identifier hs-var">group</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; [[Text]]) -&gt; [Text] -&gt; [[Text]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; [Text]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; [Text]) -&gt; [Text] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Text] -&gt; [Text]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe Text] -&gt; [Text]) -&gt; [Maybe Text] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Maybe Text)
-&gt; (Text -&gt; Maybe Text) -&gt; EndpointUrl -&gt; [Maybe Text]
forall a. (Text -&gt; a) -&gt; (Text -&gt; a) -&gt; EndpointUrl -&gt; [a]
</span><a href="Hasura.RQL.Types.Endpoint.html#splitPath"><span class="hs-identifier hs-var">splitPath</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Text -&gt; Text -&gt; Maybe Text
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata a -&gt; EndpointUrl
forall query. EndpointMetadata query -&gt; EndpointUrl
</span><a href="Hasura.RQL.Types.Endpoint.html#_ceUrl"><span class="hs-identifier hs-var hs-var">_ceUrl</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata a
</span><a href="#local-6989586621688410335"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>      </span><span id="local-6989586621688411241"><span class="annot"><a href="#local-6989586621688410325"><span class="hs-identifier hs-type">endpointObjId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#EndpointMetadata"><span class="hs-identifier hs-type">EndpointMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411241"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObjId"><span class="hs-identifier hs-type">MetadataObjId</span></a></span></span><span>
</span><span id="line-272"></span><span>      </span><span id="local-6989586621688410325"><span class="annot"><span class="annottext">endpointObjId :: EndpointMetadata q -&gt; MetadataObjId
</span><a href="#local-6989586621688410325"><span class="hs-identifier hs-var hs-var">endpointObjId</span></a></span></span><span> </span><span id="local-6989586621688410324"><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410324"><span class="hs-identifier hs-var">md</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EndpointName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOEndpoint"><span class="hs-identifier hs-var">MOEndpoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; EndpointName
forall query. EndpointMetadata query -&gt; EndpointName
</span><a href="Hasura.RQL.Types.Endpoint.html#_ceName"><span class="hs-identifier hs-var hs-var">_ceName</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410324"><span class="hs-identifier hs-var">md</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span>      </span><span id="local-6989586621688411220"><span class="annot"><a href="#local-6989586621688410321"><span class="hs-identifier hs-type">endpointObject</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#EndpointMetadata"><span class="hs-identifier hs-type">EndpointMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411220"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span></span><span>
</span><span id="line-275"></span><span>      </span><span id="local-6989586621688410321"><span class="annot"><span class="annottext">endpointObject :: EndpointMetadata q -&gt; MetadataObject
</span><a href="#local-6989586621688410321"><span class="hs-identifier hs-var hs-var">endpointObject</span></a></span></span><span> </span><span id="local-6989586621688410320"><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410320"><span class="hs-identifier hs-var">md</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; MetadataObjId
forall q. EndpointMetadata q -&gt; MetadataObjId
</span><a href="#local-6989586621688410325"><span class="hs-identifier hs-var">endpointObjId</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410320"><span class="hs-identifier hs-var">md</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe CreateEndpoint -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">(Maybe CreateEndpoint -&gt; Value) -&gt; Maybe CreateEndpoint -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EndpointName
-&gt; InsOrdHashMap EndpointName CreateEndpoint
-&gt; Maybe CreateEndpoint
forall k v. (Eq k, Hashable k) =&gt; k -&gt; InsOrdHashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; EndpointName
forall query. EndpointMetadata query -&gt; EndpointName
</span><a href="Hasura.RQL.Types.Endpoint.html#_ceName"><span class="hs-identifier hs-var hs-var">_ceName</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410320"><span class="hs-identifier hs-var">md</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap EndpointName CreateEndpoint -&gt; Maybe CreateEndpoint)
-&gt; InsOrdHashMap EndpointName CreateEndpoint
-&gt; Maybe CreateEndpoint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; InsOrdHashMap EndpointName CreateEndpoint
</span><a href="Hasura.RQL.Types.Metadata.html#_metaRestEndpoints"><span class="hs-identifier hs-var hs-var">_metaRestEndpoints</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688410367"><span class="hs-identifier hs-var">metadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>      </span><span class="annot"><a href="#local-6989586621688410315"><span class="hs-identifier hs-type">listedQueryObjects</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#CollectionName"><span class="hs-identifier hs-type">CollectionName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#ListedQuery"><span class="hs-identifier hs-type">ListedQuery</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span id="local-6989586621688410315"><span class="annot"><span class="annottext">listedQueryObjects :: (CollectionName, ListedQuery) -&gt; MetadataObject
</span><a href="#local-6989586621688410315"><span class="hs-identifier hs-var hs-var">listedQueryObjects</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410314"><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621688410314"><span class="hs-identifier hs-var">cName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410313"><span class="annot"><span class="annottext">ListedQuery
</span><a href="#local-6989586621688410313"><span class="hs-identifier hs-var">lq</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CollectionName -&gt; ListedQuery -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOQueryCollectionsQuery"><span class="hs-identifier hs-var">MOQueryCollectionsQuery</span></a></span><span> </span><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621688410314"><span class="hs-identifier hs-var">cName</span></a></span><span> </span><span class="annot"><span class="annottext">ListedQuery
</span><a href="#local-6989586621688410313"><span class="hs-identifier hs-var">lq</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ListedQuery -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">ListedQuery
</span><a href="#local-6989586621688410313"><span class="hs-identifier hs-var">lq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>      </span><span class="hs-comment">--  Cases of urls that generate invalid segments:</span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>      </span><span id="local-6989586621688410311"><span class="annot"><a href="#local-6989586621688410310"><span class="hs-identifier hs-type">hasInvalidSegments</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#EndpointMetadata"><span class="hs-identifier hs-type">EndpointMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410311"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-283"></span><span>      </span><span id="local-6989586621688410310"><span class="annot"><span class="annottext">hasInvalidSegments :: EndpointMetadata query -&gt; Bool
</span><a href="#local-6989586621688410310"><span class="hs-identifier hs-var hs-var">hasInvalidSegments</span></a></span></span><span> </span><span id="local-6989586621688410309"><span class="annot"><span class="annottext">EndpointMetadata query
</span><a href="#local-6989586621688410309"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Bool) -&gt; [Text] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;:&quot;</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; (Text -&gt; Text) -&gt; EndpointUrl -&gt; [Text]
forall a. (Text -&gt; a) -&gt; (Text -&gt; a) -&gt; EndpointUrl -&gt; [a]
</span><a href="Hasura.RQL.Types.Endpoint.html#splitPath"><span class="hs-identifier hs-var">splitPath</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata query -&gt; EndpointUrl
forall query. EndpointMetadata query -&gt; EndpointUrl
</span><a href="Hasura.RQL.Types.Endpoint.html#_ceUrl"><span class="hs-identifier hs-var hs-var">_ceUrl</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata query
</span><a href="#local-6989586621688410309"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>      </span><span id="local-6989586621688410307"><span class="annot"><span class="annottext">ceUrlTxt :: EndpointMetadata query -&gt; Text
</span><a href="#local-6989586621688410307"><span class="hs-identifier hs-var hs-var">ceUrlTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EndpointUrl -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">(EndpointUrl -&gt; Text)
-&gt; (EndpointMetadata query -&gt; EndpointUrl)
-&gt; EndpointMetadata query
-&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata query -&gt; EndpointUrl
forall query. EndpointMetadata query -&gt; EndpointUrl
</span><a href="Hasura.RQL.Types.Endpoint.html#_ceUrl"><span class="hs-identifier hs-var hs-var">_ceUrl</span></a></span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span>      </span><span id="local-6989586621688410305"><span class="annot"><span class="annottext">endpoints :: EndpointTrie GQLQueryWithText
</span><a href="#local-6989586621688410305"><span class="hs-identifier hs-var hs-var">endpoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EndpointMetadata GQLQueryWithText]
-&gt; EndpointTrie GQLQueryWithText
forall query.
Ord query =&gt;
[EndpointMetadata query] -&gt; EndpointTrie query
</span><a href="Hasura.RQL.Types.Endpoint.html#buildEndpointsTrie"><span class="hs-identifier hs-var">buildEndpointsTrie</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap EndpointName (EndpointMetadata GQLQueryWithText)
-&gt; [EndpointMetadata GQLQueryWithText]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">(HashMap EndpointName (EndpointMetadata GQLQueryWithText)
 -&gt; [EndpointMetadata GQLQueryWithText])
-&gt; HashMap EndpointName (EndpointMetadata GQLQueryWithText)
-&gt; [EndpointMetadata GQLQueryWithText]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
-&gt; HashMap EndpointName (EndpointMetadata GQLQueryWithText)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boEndpoints"><span class="hs-identifier hs-var hs-var">_boEndpoints</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span>      </span><span id="local-6989586621688410301"><span class="annot"><span class="annottext">duplicateF :: EndpointMetadata q -&gt; InconsistentMetadata
</span><a href="#local-6989586621688410301"><span class="hs-identifier hs-var hs-var">duplicateF</span></a></span></span><span> </span><span id="local-6989586621688410300"><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410300"><span class="hs-identifier hs-var">md</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; MetadataObject -&gt; InconsistentMetadata
</span><a href="Hasura.RQL.Types.Metadata.Object.html#DuplicateRestVariables"><span class="hs-identifier hs-var">DuplicateRestVariables</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; Text
forall query. EndpointMetadata query -&gt; Text
</span><a href="#local-6989586621688410307"><span class="hs-identifier hs-var">ceUrlTxt</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410300"><span class="hs-identifier hs-var">md</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; MetadataObject
forall q. EndpointMetadata q -&gt; MetadataObject
</span><a href="#local-6989586621688410321"><span class="hs-identifier hs-var">endpointObject</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410300"><span class="hs-identifier hs-var">md</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>      </span><span id="local-6989586621688410298"><span class="annot"><span class="annottext">duplicateRestVariables :: [InconsistentMetadata]
</span><a href="#local-6989586621688410298"><span class="hs-identifier hs-var hs-var">duplicateRestVariables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EndpointMetadata GQLQueryWithText -&gt; InconsistentMetadata)
-&gt; [EndpointMetadata GQLQueryWithText] -&gt; [InconsistentMetadata]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata GQLQueryWithText -&gt; InconsistentMetadata
forall q. EndpointMetadata q -&gt; InconsistentMetadata
</span><a href="#local-6989586621688410301"><span class="hs-identifier hs-var">duplicateF</span></a></span><span> </span><span class="annot"><span class="annottext">([EndpointMetadata GQLQueryWithText] -&gt; [InconsistentMetadata])
-&gt; [EndpointMetadata GQLQueryWithText] -&gt; [InconsistentMetadata]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EndpointMetadata GQLQueryWithText -&gt; Bool)
-&gt; [EndpointMetadata GQLQueryWithText]
-&gt; [EndpointMetadata GQLQueryWithText]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata GQLQueryWithText -&gt; Bool
forall a. EndpointMetadata a -&gt; Bool
</span><a href="#local-6989586621688410336"><span class="hs-identifier hs-var">duplicateVariables</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap EndpointName (EndpointMetadata GQLQueryWithText)
-&gt; [EndpointMetadata GQLQueryWithText]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">(HashMap EndpointName (EndpointMetadata GQLQueryWithText)
 -&gt; [EndpointMetadata GQLQueryWithText])
-&gt; HashMap EndpointName (EndpointMetadata GQLQueryWithText)
-&gt; [EndpointMetadata GQLQueryWithText]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
-&gt; HashMap EndpointName (EndpointMetadata GQLQueryWithText)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boEndpoints"><span class="hs-identifier hs-var hs-var">_boEndpoints</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>      </span><span id="local-6989586621688410297"><span class="annot"><span class="annottext">invalidF :: EndpointMetadata q -&gt; InconsistentMetadata
</span><a href="#local-6989586621688410297"><span class="hs-identifier hs-var hs-var">invalidF</span></a></span></span><span> </span><span id="local-6989586621688410296"><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410296"><span class="hs-identifier hs-var">md</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; MetadataObject -&gt; InconsistentMetadata
</span><a href="Hasura.RQL.Types.Metadata.Object.html#InvalidRestSegments"><span class="hs-identifier hs-var">InvalidRestSegments</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; Text
forall query. EndpointMetadata query -&gt; Text
</span><a href="#local-6989586621688410307"><span class="hs-identifier hs-var">ceUrlTxt</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410296"><span class="hs-identifier hs-var">md</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; MetadataObject
forall q. EndpointMetadata q -&gt; MetadataObject
</span><a href="#local-6989586621688410321"><span class="hs-identifier hs-var">endpointObject</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410296"><span class="hs-identifier hs-var">md</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>      </span><span id="local-6989586621688410294"><span class="annot"><span class="annottext">invalidRestSegments :: [InconsistentMetadata]
</span><a href="#local-6989586621688410294"><span class="hs-identifier hs-var hs-var">invalidRestSegments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EndpointMetadata GQLQueryWithText -&gt; InconsistentMetadata)
-&gt; [EndpointMetadata GQLQueryWithText] -&gt; [InconsistentMetadata]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata GQLQueryWithText -&gt; InconsistentMetadata
forall q. EndpointMetadata q -&gt; InconsistentMetadata
</span><a href="#local-6989586621688410297"><span class="hs-identifier hs-var">invalidF</span></a></span><span> </span><span class="annot"><span class="annottext">([EndpointMetadata GQLQueryWithText] -&gt; [InconsistentMetadata])
-&gt; [EndpointMetadata GQLQueryWithText] -&gt; [InconsistentMetadata]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EndpointMetadata GQLQueryWithText -&gt; Bool)
-&gt; [EndpointMetadata GQLQueryWithText]
-&gt; [EndpointMetadata GQLQueryWithText]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata GQLQueryWithText -&gt; Bool
forall a. EndpointMetadata a -&gt; Bool
</span><a href="#local-6989586621688410310"><span class="hs-identifier hs-var">hasInvalidSegments</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap EndpointName (EndpointMetadata GQLQueryWithText)
-&gt; [EndpointMetadata GQLQueryWithText]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">(HashMap EndpointName (EndpointMetadata GQLQueryWithText)
 -&gt; [EndpointMetadata GQLQueryWithText])
-&gt; HashMap EndpointName (EndpointMetadata GQLQueryWithText)
-&gt; [EndpointMetadata GQLQueryWithText]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
-&gt; HashMap EndpointName (EndpointMetadata GQLQueryWithText)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boEndpoints"><span class="hs-identifier hs-var hs-var">_boEndpoints</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span>      </span><span id="local-6989586621688410293"><span class="annot"><span class="annottext">ambiguousF' :: EndpointMetadata q -&gt; MetadataObject
</span><a href="#local-6989586621688410293"><span class="hs-identifier hs-var hs-var">ambiguousF'</span></a></span></span><span> </span><span id="local-6989586621688410292"><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410292"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; MetadataObjId
forall q. EndpointMetadata q -&gt; MetadataObjId
</span><a href="#local-6989586621688410325"><span class="hs-identifier hs-var">endpointObjId</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410292"><span class="hs-identifier hs-var">ep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q
</span><a href="#local-6989586621688410292"><span class="hs-identifier hs-var">ep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>      </span><span id="local-6989586621688410291"><span class="annot"><span class="annottext">ambiguousF :: [EndpointMetadata q] -&gt; InconsistentMetadata
</span><a href="#local-6989586621688410291"><span class="hs-identifier hs-var hs-var">ambiguousF</span></a></span></span><span> </span><span id="local-6989586621688410290"><span class="annot"><span class="annottext">[EndpointMetadata q]
</span><a href="#local-6989586621688410290"><span class="hs-identifier hs-var">mds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; [MetadataObject] -&gt; InconsistentMetadata
</span><a href="Hasura.RQL.Types.Metadata.Object.html#AmbiguousRestEndpoints"><span class="hs-identifier hs-var">AmbiguousRestEndpoints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EndpointUrl] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([EndpointUrl] -&gt; Text) -&gt; [EndpointUrl] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EndpointMetadata q -&gt; EndpointUrl)
-&gt; [EndpointMetadata q] -&gt; [EndpointUrl]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; EndpointUrl
forall query. EndpointMetadata query -&gt; EndpointUrl
</span><a href="Hasura.RQL.Types.Endpoint.html#_ceUrl"><span class="hs-identifier hs-var hs-var">_ceUrl</span></a></span><span> </span><span class="annot"><span class="annottext">[EndpointMetadata q]
</span><a href="#local-6989586621688410290"><span class="hs-identifier hs-var">mds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EndpointMetadata q -&gt; MetadataObject)
-&gt; [EndpointMetadata q] -&gt; [MetadataObject]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata q -&gt; MetadataObject
forall q. ToJSON q =&gt; EndpointMetadata q -&gt; MetadataObject
</span><a href="#local-6989586621688410293"><span class="hs-identifier hs-var">ambiguousF'</span></a></span><span> </span><span class="annot"><span class="annottext">[EndpointMetadata q]
</span><a href="#local-6989586621688410290"><span class="hs-identifier hs-var">mds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>      </span><span id="local-6989586621688410287"><span class="annot"><span class="annottext">ambiguousRestEndpoints :: [InconsistentMetadata]
</span><a href="#local-6989586621688410287"><span class="hs-identifier hs-var hs-var">ambiguousRestEndpoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Set [PathComponent Text],
  Set (EndpointMetadata GQLQueryWithText))
 -&gt; InconsistentMetadata)
-&gt; [(Set [PathComponent Text],
     Set (EndpointMetadata GQLQueryWithText))]
-&gt; [InconsistentMetadata]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EndpointMetadata GQLQueryWithText] -&gt; InconsistentMetadata
forall q. ToJSON q =&gt; [EndpointMetadata q] -&gt; InconsistentMetadata
</span><a href="#local-6989586621688410291"><span class="hs-identifier hs-var">ambiguousF</span></a></span><span> </span><span class="annot"><span class="annottext">([EndpointMetadata GQLQueryWithText] -&gt; InconsistentMetadata)
-&gt; ((Set [PathComponent Text],
     Set (EndpointMetadata GQLQueryWithText))
    -&gt; [EndpointMetadata GQLQueryWithText])
-&gt; (Set [PathComponent Text],
    Set (EndpointMetadata GQLQueryWithText))
-&gt; InconsistentMetadata
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Set (EndpointMetadata GQLQueryWithText)
-&gt; [EndpointMetadata GQLQueryWithText]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.elems</span></span><span> </span><span class="annot"><span class="annottext">(Set (EndpointMetadata GQLQueryWithText)
 -&gt; [EndpointMetadata GQLQueryWithText])
-&gt; ((Set [PathComponent Text],
     Set (EndpointMetadata GQLQueryWithText))
    -&gt; Set (EndpointMetadata GQLQueryWithText))
-&gt; (Set [PathComponent Text],
    Set (EndpointMetadata GQLQueryWithText))
-&gt; [EndpointMetadata GQLQueryWithText]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Set [PathComponent Text], Set (EndpointMetadata GQLQueryWithText))
-&gt; Set (EndpointMetadata GQLQueryWithText)
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Set [PathComponent Text],
   Set (EndpointMetadata GQLQueryWithText))]
 -&gt; [InconsistentMetadata])
-&gt; [(Set [PathComponent Text],
     Set (EndpointMetadata GQLQueryWithText))]
-&gt; [InconsistentMetadata]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EndpointTrie GQLQueryWithText
-&gt; [(Set [PathComponent Text],
     Set (EndpointMetadata GQLQueryWithText))]
forall a k v.
(Hashable a, Eq k, Hashable k, Ord v, Ord a) =&gt;
MultiMapPathTrie a k v -&gt; [(Set [PathComponent a], Set v)]
</span><a href="Hasura.RQL.Types.Endpoint.Trie.html#ambiguousPathsGrouped"><span class="hs-identifier hs-var">ambiguousPathsGrouped</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointTrie GQLQueryWithText
</span><a href="#local-6989586621688410305"><span class="hs-identifier hs-var">endpoints</span></a></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span>      </span><span id="local-6989586621688410284"><span class="annot"><span class="annottext">queryCollections :: QueryCollections
</span><a href="#local-6989586621688410284"><span class="hs-identifier hs-var hs-var">queryCollections</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuildOutputs -&gt; QueryCollections
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boQueryCollections"><span class="hs-identifier hs-var hs-var">_boQueryCollections</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span>
</span><span id="line-300"></span><span>      </span><span id="local-6989586621688410282"><span class="annot"><span class="annottext">allowLists :: [NormalizedQuery]
</span><a href="#local-6989586621688410282"><span class="hs-identifier hs-var hs-var">allowLists</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashSet NormalizedQuery -&gt; [NormalizedQuery]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">HS.toList</span></span><span> </span><span class="annot"><span class="annottext">(HashSet NormalizedQuery -&gt; [NormalizedQuery])
-&gt; (BuildOutputs -&gt; HashSet NormalizedQuery)
-&gt; BuildOutputs
-&gt; [NormalizedQuery]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">InlinedAllowlist -&gt; HashSet NormalizedQuery
</span><a href="Hasura.RQL.Types.Allowlist.html#iaGlobal"><span class="hs-identifier hs-var hs-var">iaGlobal</span></a></span><span> </span><span class="annot"><span class="annottext">(InlinedAllowlist -&gt; HashSet NormalizedQuery)
-&gt; (BuildOutputs -&gt; InlinedAllowlist)
-&gt; BuildOutputs
-&gt; HashSet NormalizedQuery
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BuildOutputs -&gt; InlinedAllowlist
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boAllowlist"><span class="hs-identifier hs-var hs-var">_boAllowlist</span></a></span><span> </span><span class="annot"><span class="annottext">(BuildOutputs -&gt; [NormalizedQuery])
-&gt; BuildOutputs -&gt; [NormalizedQuery]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span>
</span><span id="line-301"></span><span>      </span><span id="local-6989586621688410278"><span class="annot"><span class="annottext">inconsistentQueryCollections :: [InconsistentMetadata]
</span><a href="#local-6989586621688410278"><span class="hs-identifier hs-var hs-var">inconsistentQueryCollections</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SchemaIntrospection
-&gt; QueryCollections
-&gt; ((CollectionName, ListedQuery) -&gt; MetadataObject)
-&gt; EndpointTrie GQLQueryWithText
-&gt; [NormalizedQuery]
-&gt; [InconsistentMetadata]
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#getInconsistentQueryCollections"><span class="hs-identifier hs-var">getInconsistentQueryCollections</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaIntrospection
</span><a href="#local-6989586621688410352"><span class="hs-identifier hs-var">adminIntrospection</span></a></span><span> </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688410284"><span class="hs-identifier hs-var">queryCollections</span></a></span><span> </span><span class="annot"><span class="annottext">(CollectionName, ListedQuery) -&gt; MetadataObject
</span><a href="#local-6989586621688410315"><span class="hs-identifier hs-var">listedQueryObjects</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointTrie GQLQueryWithText
</span><a href="#local-6989586621688410305"><span class="hs-identifier hs-var">endpoints</span></a></span><span> </span><span class="annot"><span class="annottext">[NormalizedQuery]
</span><a href="#local-6989586621688410282"><span class="hs-identifier hs-var">allowLists</span></a></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span>  </span><span class="annot"><span class="annottext">arr SchemaCache SchemaCache
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-305"></span><span>      </span><span class="annot"><span class="annottext">SchemaCache :: SourceCache
-&gt; ActionCache
-&gt; RemoteSchemaMap
-&gt; InlinedAllowlist
-&gt; SchemaIntrospection
-&gt; HashMap RoleName (RoleContext GQLContext)
-&gt; GQLContext
-&gt; HashMap RoleName (RoleContext GQLContext)
-&gt; GQLContext
-&gt; DepMap
-&gt; [InconsistentMetadata]
-&gt; HashMap TriggerName CronTriggerInfo
-&gt; EndpointTrie GQLQueryWithText
-&gt; ApiLimit
-&gt; MetricsConfig
-&gt; Maybe MetadataResourceVersion
-&gt; SetGraphqlIntrospectionOptions
-&gt; [TlsAllow]
-&gt; QueryCollections
-&gt; SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#SchemaCache"><span class="hs-identifier hs-type">SchemaCache</span></a></span><span>
</span><span id="line-306"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scSources :: SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var">scSources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuildOutputs -&gt; SourceCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boSources"><span class="hs-identifier hs-var hs-var">_boSources</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-307"></span><span>          </span><span class="annot"><span class="annottext">scActions :: ActionCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scActions"><span class="hs-identifier hs-var">scActions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuildOutputs -&gt; ActionCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boActions"><span class="hs-identifier hs-var hs-var">_boActions</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-308"></span><span>          </span><span class="hs-comment">-- TODO this is not the right value: we should track what part of the schema</span><span>
</span><span id="line-309"></span><span>          </span><span class="hs-comment">-- we can stitch without consistencies, I think.</span><span>
</span><span id="line-310"></span><span>          </span><span class="annot"><span class="annottext">scRemoteSchemas :: RemoteSchemaMap
</span><a href="Hasura.RQL.Types.SchemaCache.html#scRemoteSchemas"><span class="hs-identifier hs-var">scRemoteSchemas</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((RemoteSchemaCtx, MetadataObject) -&gt; RemoteSchemaCtx)
-&gt; HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject)
-&gt; RemoteSchemaMap
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaCtx, MetadataObject) -&gt; RemoteSchemaCtx
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuildOutputs
-&gt; HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boRemoteSchemas"><span class="hs-identifier hs-var hs-var">_boRemoteSchemas</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- remoteSchemaMap</span><span>
</span><span id="line-311"></span><span>          </span><span class="annot"><span class="annottext">scAllowlist :: InlinedAllowlist
</span><a href="Hasura.RQL.Types.SchemaCache.html#scAllowlist"><span class="hs-identifier hs-var">scAllowlist</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuildOutputs -&gt; InlinedAllowlist
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boAllowlist"><span class="hs-identifier hs-var hs-var">_boAllowlist</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-312"></span><span>          </span><span class="hs-comment">-- , scCustomTypes = _boCustomTypes resolvedOutputs</span><span>
</span><span id="line-313"></span><span>          </span><span class="annot"><span class="annottext">scAdminIntrospection :: SchemaIntrospection
</span><a href="Hasura.RQL.Types.SchemaCache.html#scAdminIntrospection"><span class="hs-identifier hs-var">scAdminIntrospection</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SchemaIntrospection
</span><a href="#local-6989586621688410352"><span class="hs-identifier hs-var">adminIntrospection</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-314"></span><span>          </span><span class="annot"><span class="annottext">scGQLContext :: HashMap RoleName (RoleContext GQLContext)
</span><a href="Hasura.RQL.Types.SchemaCache.html#scGQLContext"><span class="hs-identifier hs-var">scGQLContext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (RoleContext GQLContext)
</span><a href="#local-6989586621688410351"><span class="hs-identifier hs-var">gqlContext</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-315"></span><span>          </span><span class="annot"><span class="annottext">scUnauthenticatedGQLContext :: GQLContext
</span><a href="Hasura.RQL.Types.SchemaCache.html#scUnauthenticatedGQLContext"><span class="hs-identifier hs-var">scUnauthenticatedGQLContext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQLContext
</span><a href="#local-6989586621688410350"><span class="hs-identifier hs-var">gqlContextUnauth</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-316"></span><span>          </span><span class="annot"><span class="annottext">scRelayContext :: HashMap RoleName (RoleContext GQLContext)
</span><a href="Hasura.RQL.Types.SchemaCache.html#scRelayContext"><span class="hs-identifier hs-var">scRelayContext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (RoleContext GQLContext)
</span><a href="#local-6989586621688410348"><span class="hs-identifier hs-var">relayContext</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-317"></span><span>          </span><span class="annot"><span class="annottext">scUnauthenticatedRelayContext :: GQLContext
</span><a href="Hasura.RQL.Types.SchemaCache.html#scUnauthenticatedRelayContext"><span class="hs-identifier hs-var">scUnauthenticatedRelayContext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQLContext
</span><a href="#local-6989586621688410347"><span class="hs-identifier hs-var">relayContextUnauth</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-318"></span><span>          </span><span class="hs-comment">-- , scGCtxMap = gqlSchema</span><span>
</span><span id="line-319"></span><span>          </span><span class="hs-comment">-- , scDefaultRemoteGCtx = remoteGQLSchema</span><span>
</span><span id="line-320"></span><span>          </span><span class="annot"><span class="annottext">scDepMap :: DepMap
</span><a href="Hasura.RQL.Types.SchemaCache.html#scDepMap"><span class="hs-identifier hs-var">scDepMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DepMap
</span><a href="#local-6989586621688410354"><span class="hs-identifier hs-var">resolvedDependencies</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-321"></span><span>          </span><span class="annot"><span class="annottext">scCronTriggers :: HashMap TriggerName CronTriggerInfo
</span><a href="Hasura.RQL.Types.SchemaCache.html#scCronTriggers"><span class="hs-identifier hs-var">scCronTriggers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuildOutputs -&gt; HashMap TriggerName CronTriggerInfo
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boCronTriggers"><span class="hs-identifier hs-var hs-var">_boCronTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-322"></span><span>          </span><span class="annot"><span class="annottext">scEndpoints :: EndpointTrie GQLQueryWithText
</span><a href="Hasura.RQL.Types.SchemaCache.html#scEndpoints"><span class="hs-identifier hs-var">scEndpoints</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EndpointTrie GQLQueryWithText
</span><a href="#local-6989586621688410305"><span class="hs-identifier hs-var">endpoints</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-323"></span><span>          </span><span class="annot"><span class="annottext">scInconsistentObjs :: [InconsistentMetadata]
</span><a href="Hasura.RQL.Types.SchemaCache.html#scInconsistentObjs"><span class="hs-identifier hs-var">scInconsistentObjs</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-324"></span><span>            </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621688410359"><span class="hs-identifier hs-var">inconsistentObjects</span></a></span><span>
</span><span id="line-325"></span><span>              </span><span class="annot"><span class="annottext">[InconsistentMetadata]
-&gt; [InconsistentMetadata] -&gt; [InconsistentMetadata]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621688410355"><span class="hs-identifier hs-var">dependencyInconsistentObjects</span></a></span><span>
</span><span id="line-326"></span><span>              </span><span class="annot"><span class="annottext">[InconsistentMetadata]
-&gt; [InconsistentMetadata] -&gt; [InconsistentMetadata]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashSet InconsistentMetadata -&gt; [InconsistentMetadata]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet InconsistentMetadata
</span><a href="#local-6989586621688410349"><span class="hs-identifier hs-var">inconsistentRemoteSchemas</span></a></span><span>
</span><span id="line-327"></span><span>              </span><span class="annot"><span class="annottext">[InconsistentMetadata]
-&gt; [InconsistentMetadata] -&gt; [InconsistentMetadata]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621688410298"><span class="hs-identifier hs-var">duplicateRestVariables</span></a></span><span>
</span><span id="line-328"></span><span>              </span><span class="annot"><span class="annottext">[InconsistentMetadata]
-&gt; [InconsistentMetadata] -&gt; [InconsistentMetadata]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621688410294"><span class="hs-identifier hs-var">invalidRestSegments</span></a></span><span>
</span><span id="line-329"></span><span>              </span><span class="annot"><span class="annottext">[InconsistentMetadata]
-&gt; [InconsistentMetadata] -&gt; [InconsistentMetadata]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621688410287"><span class="hs-identifier hs-var">ambiguousRestEndpoints</span></a></span><span>
</span><span id="line-330"></span><span>              </span><span class="annot"><span class="annottext">[InconsistentMetadata]
-&gt; [InconsistentMetadata] -&gt; [InconsistentMetadata]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621688410278"><span class="hs-identifier hs-var">inconsistentQueryCollections</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-331"></span><span>          </span><span class="annot"><span class="annottext">scApiLimits :: ApiLimit
</span><a href="Hasura.RQL.Types.SchemaCache.html#scApiLimits"><span class="hs-identifier hs-var">scApiLimits</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuildOutputs -&gt; ApiLimit
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boApiLimits"><span class="hs-identifier hs-var hs-var">_boApiLimits</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-332"></span><span>          </span><span class="annot"><span class="annottext">scMetricsConfig :: MetricsConfig
</span><a href="Hasura.RQL.Types.SchemaCache.html#scMetricsConfig"><span class="hs-identifier hs-var">scMetricsConfig</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuildOutputs -&gt; MetricsConfig
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boMetricsConfig"><span class="hs-identifier hs-var hs-var">_boMetricsConfig</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-333"></span><span>          </span><span class="annot"><span class="annottext">scMetadataResourceVersion :: Maybe MetadataResourceVersion
</span><a href="Hasura.RQL.Types.SchemaCache.html#scMetadataResourceVersion"><span class="hs-identifier hs-var">scMetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe MetadataResourceVersion
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-334"></span><span>          </span><span class="annot"><span class="annottext">scSetGraphqlIntrospectionOptions :: SetGraphqlIntrospectionOptions
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSetGraphqlIntrospectionOptions"><span class="hs-identifier hs-var">scSetGraphqlIntrospectionOptions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; SetGraphqlIntrospectionOptions
</span><a href="Hasura.RQL.Types.Metadata.html#_metaSetGraphqlIntrospectionOptions"><span class="hs-identifier hs-var hs-var">_metaSetGraphqlIntrospectionOptions</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688410367"><span class="hs-identifier hs-var">metadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-335"></span><span>          </span><span class="annot"><span class="annottext">scTlsAllowlist :: [TlsAllow]
</span><a href="Hasura.RQL.Types.SchemaCache.html#scTlsAllowlist"><span class="hs-identifier hs-var">scTlsAllowlist</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuildOutputs -&gt; [TlsAllow]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boTlsAllowlist"><span class="hs-identifier hs-var hs-var">_boTlsAllowlist</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-336"></span><span>          </span><span class="annot"><span class="annottext">scQueryCollections :: QueryCollections
</span><a href="Hasura.RQL.Types.SchemaCache.html#scQueryCollections"><span class="hs-identifier hs-var">scQueryCollections</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuildOutputs -&gt; QueryCollections
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boQueryCollections"><span class="hs-identifier hs-var hs-var">_boQueryCollections</span></a></span><span> </span><span class="annot"><span class="annottext">BuildOutputs
</span><a href="#local-6989586621688410356"><span class="hs-identifier hs-var">resolvedOutputs</span></a></span><span>
</span><span id="line-337"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-338"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-339"></span><span>    </span><span class="annot"><a href="#local-6989586621688410250"><span class="hs-identifier hs-type">getSourceConfigIfNeeded</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-340"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688411130"><span class="annot"><a href="#local-6989586621688411130"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688411132"><span class="annot"><a href="#local-6989586621688411132"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688411131"><span class="annot"><a href="#local-6989586621688411131"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-341"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688411132"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-342"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411131"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411132"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-343"></span><span>        </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688411132"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688411131"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411131"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-346"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411130"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-347"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-348"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Dependency"><span class="hs-identifier hs-type">Inc.Dependency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="annot"><a href="Hasura.Incremental.html#InvalidationKey"><span class="hs-identifier hs-type">Inc.InvalidationKey</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-349"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConnConfiguration"><span class="hs-identifier hs-type">SourceConnConfiguration</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411130"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-351"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>        </span><span class="annot"><a href="#local-6989586621688411132"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411130"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>    </span><span id="local-6989586621688410250"><span class="annot"><span class="annottext">getSourceConfigIfNeeded :: arr
  (Dependency (HashMap SourceName InvalidationKey), SourceName,
   SourceConnConfiguration b)
  (Maybe (SourceConfig b))
</span><a href="#local-6989586621688410250"><span class="hs-identifier hs-var hs-var">getSourceConfigIfNeeded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">arr
  (Dependency (HashMap SourceName InvalidationKey), SourceName,
   SourceConnConfiguration b)
  (Maybe (SourceConfig b))
-&gt; arr
     (Dependency (HashMap SourceName InvalidationKey), SourceName,
      SourceConnConfiguration b)
     (Maybe (SourceConfig b))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a b.
(ArrowCache m arr, Cacheable a) =&gt;
arr a b -&gt; arr a b
</span><a href="Hasura.Incremental.Internal.Cache.html#cache"><span class="hs-identifier hs-var">Inc.cache</span></a></span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410248"><span class="annot"><span class="annottext">Dependency (HashMap SourceName InvalidationKey)
</span><a href="#local-6989586621688410248"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410247"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410247"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410246"><span class="annot"><span class="annottext">SourceConnConfiguration b
</span><a href="#local-6989586621688410246"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410245"><span class="annot"><span class="annottext">metadataObj :: MetadataObject
</span><a href="#local-6989586621688410245"><span class="hs-identifier hs-var hs-var">metadataObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOSource"><span class="hs-identifier hs-var">MOSource</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410247"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Value -&gt; MetadataObject) -&gt; Value -&gt; MetadataObject
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410247"><span class="hs-identifier hs-var">sourceName</span></a></span><span>
</span><span id="line-355"></span><span>      </span><span class="annot"><span class="annottext">arr (Dependency (Maybe InvalidationKey)) (Maybe InvalidationKey)
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
(ArrowCache m arr, Cacheable a) =&gt;
arr (Dependency a) a
</span><a href="Hasura.Incremental.Internal.Cache.html#dependOn"><span class="hs-identifier hs-var">Inc.dependOn</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; Dependency (HashMap SourceName InvalidationKey)
-&gt; Dependency (Maybe InvalidationKey)
forall a k v.
(Select a, Selector a ~ ConstS k v) =&gt;
k -&gt; Dependency a -&gt; Dependency v
</span><a href="Hasura.Incremental.Internal.Dependency.html#selectKeyD"><span class="hs-identifier hs-var">Inc.selectKeyD</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410247"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">Dependency (HashMap SourceName InvalidationKey)
</span><a href="#local-6989586621688410248"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span>
</span><span id="line-356"></span><span>      </span><span class="hs-glyph">(|</span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) (SourceConfig b)
-&gt; arr (a, (MetadataObject, ())) (Maybe (SourceConfig b))
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-358"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ErrorA QErr arr (Either QErr (SourceConfig b)) (SourceConfig b)
forall (arr :: * -&gt; * -&gt; *) e a.
(ArrowChoice arr, ArrowError e arr) =&gt;
arr (Either e a) a
</span><a href="Control.Arrow.Trans.html#liftEitherA"><span class="hs-identifier hs-var">liftEitherA</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorA QErr arr (Either QErr (SourceConfig b)) (SourceConfig b)
-&gt; ErrorA
     QErr
     arr
     (m (Either QErr (SourceConfig b)))
     (Either QErr (SourceConfig b))
-&gt; ErrorA
     QErr arr (m (Either QErr (SourceConfig b))) (SourceConfig b)
forall k (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">&lt;&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (m (Either QErr (SourceConfig b)))
  (Either QErr (SourceConfig b))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; SourceConnConfiguration b
-&gt; Environment
-&gt; m (Either QErr (SourceConfig b))
forall (b :: BackendType) (m :: * -&gt; *).
(BackendMetadata b, MonadIO m, MonadResolveSource m) =&gt;
SourceName
-&gt; SourceConnConfiguration b
-&gt; Environment
-&gt; m (Either QErr (SourceConfig b))
</span><a href="Hasura.RQL.Types.Metadata.Backend.html#resolveSourceConfig"><span class="hs-identifier hs-var">resolveSourceConfig</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688411130"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410247"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConnConfiguration b
</span><a href="#local-6989586621688410246"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688410368"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-359"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688410245"><span class="hs-identifier hs-var">metadataObj</span></a></span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><a href="#local-6989586621688410237"><span class="hs-identifier hs-type">resolveSourceIfNeeded</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-363"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688410876"><span class="annot"><a href="#local-6989586621688410876"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688410878"><span class="annot"><a href="#local-6989586621688410878"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688410877"><span class="annot"><a href="#local-6989586621688410877"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-364"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410878"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-365"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410877"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410878"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-366"></span><span>        </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410878"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-367"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688410877"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-368"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688410877"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-369"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410877"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-370"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410876"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-371"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-372"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Dependency"><span class="hs-identifier hs-type">Inc.Dependency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="annot"><a href="Hasura.Incremental.html#InvalidationKey"><span class="hs-identifier hs-type">Inc.InvalidationKey</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-373"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410876"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-374"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>        </span><span class="annot"><a href="#local-6989586621688410878"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Source.html#ResolvedSource"><span class="hs-identifier hs-type">ResolvedSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410876"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>    </span><span id="local-6989586621688410237"><span class="annot"><span class="annottext">resolveSourceIfNeeded :: arr
  (Dependency (HashMap SourceName InvalidationKey), SourceMetadata b)
  (Maybe (ResolvedSource b))
</span><a href="#local-6989586621688410237"><span class="hs-identifier hs-var hs-var">resolveSourceIfNeeded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">arr
  (Dependency (HashMap SourceName InvalidationKey), SourceMetadata b)
  (Maybe (ResolvedSource b))
-&gt; arr
     (Dependency (HashMap SourceName InvalidationKey), SourceMetadata b)
     (Maybe (ResolvedSource b))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a b.
(ArrowCache m arr, Cacheable a) =&gt;
arr a b -&gt; arr a b
</span><a href="Hasura.Incremental.Internal.Cache.html#cache"><span class="hs-identifier hs-var">Inc.cache</span></a></span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410236"><span class="annot"><span class="annottext">Dependency (HashMap SourceName InvalidationKey)
</span><a href="#local-6989586621688410236"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410235"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410235"><span class="hs-identifier hs-var">sourceMetadata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-377"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410234"><span class="annot"><span class="annottext">sourceName :: SourceName
</span><a href="#local-6989586621688410234"><span class="hs-identifier hs-var hs-var">sourceName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; SourceName
forall (b :: BackendType). SourceMetadata b -&gt; SourceName
</span><a href="Hasura.RQL.Types.Metadata.html#_smName"><span class="hs-identifier hs-var hs-var">_smName</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410235"><span class="hs-identifier hs-var">sourceMetadata</span></a></span><span>
</span><span id="line-378"></span><span>          </span><span id="local-6989586621688410232"><span class="annot"><span class="annottext">metadataObj :: MetadataObject
</span><a href="#local-6989586621688410232"><span class="hs-identifier hs-var hs-var">metadataObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOSource"><span class="hs-identifier hs-var">MOSource</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410234"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Value -&gt; MetadataObject) -&gt; Value -&gt; MetadataObject
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410234"><span class="hs-identifier hs-var">sourceName</span></a></span><span>
</span><span id="line-379"></span><span>          </span><span class="annot"><a href="#local-6989586621688410231"><span class="hs-identifier hs-type">logAndResolveDatabaseMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410876"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SourceCustomization.html#SourceTypeCustomization"><span class="hs-identifier hs-type">SourceTypeCustomization</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688410877"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Source.html#ResolvedSource"><span class="hs-identifier hs-type">ResolvedSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410876"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>          </span><span id="local-6989586621688410231"><span class="annot"><span class="annottext">logAndResolveDatabaseMetadata :: SourceConfig b
-&gt; SourceTypeCustomization -&gt; m (Either QErr (ResolvedSource b))
</span><a href="#local-6989586621688410231"><span class="hs-identifier hs-var hs-var">logAndResolveDatabaseMetadata</span></a></span></span><span> </span><span id="local-6989586621688410230"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688410230"><span class="hs-identifier hs-var">scConfig</span></a></span></span><span> </span><span id="local-6989586621688410229"><span class="annot"><span class="annottext">SourceTypeCustomization
</span><a href="#local-6989586621688410229"><span class="hs-identifier hs-var">sType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-381"></span><span>            </span><span id="local-6989586621688410228"><span class="annot"><span class="annottext">Either QErr (ResolvedSource b)
</span><a href="#local-6989586621688410228"><span class="hs-identifier hs-var">resSource</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
-&gt; SourceConfig b
-&gt; SourceTypeCustomization
-&gt; m (Either QErr (ResolvedSource b))
forall (b :: BackendType) (m :: * -&gt; *).
(BackendMetadata b, MonadIO m, MonadBaseControl IO m,
 MonadResolveSource m) =&gt;
SourceMetadata b
-&gt; SourceConfig b
-&gt; SourceTypeCustomization
-&gt; m (Either QErr (ResolvedSource b))
</span><a href="Hasura.RQL.Types.Metadata.Backend.html#resolveDatabaseMetadata"><span class="hs-identifier hs-var">resolveDatabaseMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410235"><span class="hs-identifier hs-var">sourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688410230"><span class="hs-identifier hs-var">scConfig</span></a></span><span> </span><span class="annot"><span class="annottext">SourceTypeCustomization
</span><a href="#local-6989586621688410229"><span class="hs-identifier hs-var">sType</span></a></span><span>
</span><span id="line-382"></span><span>            </span><span class="annot"><span class="annottext">Either QErr (ResolvedSource b)
-&gt; (ResolvedSource b -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">Either QErr (ResolvedSource b)
</span><a href="#local-6989586621688410228"><span class="hs-identifier hs-var">resSource</span></a></span><span> </span><span class="annot"><span class="annottext">((ResolvedSource b -&gt; m ()) -&gt; m ())
-&gt; (ResolvedSource b -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ())
-&gt; (ResolvedSource b -&gt; IO ()) -&gt; ResolvedSource b -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688410369"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-383"></span><span>            </span><span class="annot"><span class="annottext">Either QErr (ResolvedSource b)
-&gt; m (Either QErr (ResolvedSource b))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Either QErr (ResolvedSource b)
</span><a href="#local-6989586621688410228"><span class="hs-identifier hs-var">resSource</span></a></span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span>      </span><span id="local-6989586621688410223"><span class="annot"><span class="annottext">Maybe (SourceConfig b)
</span><a href="#local-6989586621688410223"><span class="hs-identifier hs-var">maybeSourceConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr, MonadIO m,
 MonadResolveSource m, BackendMetadata b) =&gt;
arr
  (Dependency (HashMap SourceName InvalidationKey), SourceName,
   SourceConnConfiguration b)
  (Maybe (SourceConfig b))
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr, MonadIO m,
 MonadResolveSource m, BackendMetadata b) =&gt;
arr
  (Dependency (HashMap SourceName InvalidationKey), SourceName,
   SourceConnConfiguration b)
  (Maybe (SourceConfig b))
</span><a href="#local-6989586621688410250"><span class="hs-identifier hs-var">getSourceConfigIfNeeded</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410876"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dependency (HashMap SourceName InvalidationKey)
</span><a href="#local-6989586621688410236"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410234"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; SourceConnConfiguration b
forall (b :: BackendType).
SourceMetadata b -&gt; SourceConnConfiguration b
</span><a href="Hasura.RQL.Types.Metadata.html#_smConfiguration"><span class="hs-identifier hs-var hs-var">_smConfiguration</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410235"><span class="hs-identifier hs-var">sourceMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (SourceConfig b)
</span><a href="#local-6989586621688410223"><span class="hs-identifier hs-var">maybeSourceConfig</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-387"></span><span>        </span><span class="annot"><span class="annottext">Maybe (SourceConfig b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">arr (Maybe (ResolvedSource b)) (Maybe (ResolvedSource b))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Maybe (ResolvedSource b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688410221"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688410221"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-389"></span><span>          </span><span class="hs-glyph">(|</span><span>
</span><span id="line-390"></span><span>            </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) (ResolvedSource b)
-&gt; arr (a, (MetadataObject, ())) (Maybe (ResolvedSource b))
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-391"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ErrorA QErr arr (Either QErr (ResolvedSource b)) (ResolvedSource b)
forall (arr :: * -&gt; * -&gt; *) e a.
(ArrowChoice arr, ArrowError e arr) =&gt;
arr (Either e a) a
</span><a href="Control.Arrow.Trans.html#liftEitherA"><span class="hs-identifier hs-var">liftEitherA</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorA QErr arr (Either QErr (ResolvedSource b)) (ResolvedSource b)
-&gt; ErrorA
     QErr
     arr
     (m (Either QErr (ResolvedSource b)))
     (Either QErr (ResolvedSource b))
-&gt; ErrorA
     QErr arr (m (Either QErr (ResolvedSource b))) (ResolvedSource b)
forall k (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">&lt;&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (m (Either QErr (ResolvedSource b)))
  (Either QErr (ResolvedSource b))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">SourceConfig b
-&gt; SourceTypeCustomization -&gt; m (Either QErr (ResolvedSource b))
</span><a href="#local-6989586621688410231"><span class="hs-identifier hs-var">logAndResolveDatabaseMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688410221"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceCustomization -&gt; SourceTypeCustomization
</span><a href="Hasura.RQL.Types.SourceCustomization.html#getSourceTypeCustomization"><span class="hs-identifier hs-var">getSourceTypeCustomization</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceCustomization -&gt; SourceTypeCustomization)
-&gt; SourceCustomization -&gt; SourceTypeCustomization
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; SourceCustomization
forall (b :: BackendType). SourceMetadata b -&gt; SourceCustomization
</span><a href="Hasura.RQL.Types.Metadata.html#_smCustomization"><span class="hs-identifier hs-var hs-var">_smCustomization</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410235"><span class="hs-identifier hs-var">sourceMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>          </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688410232"><span class="hs-identifier hs-var">metadataObj</span></a></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-comment">-- impl notes (swann):</span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-comment">-- as our cache invalidation key (in a sense) we use the number of event triggers</span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-comment">-- present, rerunning catalog init when this changes. this is correct, because we</span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-comment">-- only care about the transition from zero event triggers to nonzero (not</span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-comment">-- necessarily one, as Anon has observed, because replace_metadata can add multiple</span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-comment">-- event triggers in one go)</span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-comment">-- a future optimisation would be to cache, on a per-source basis, whether or not</span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-comment">-- the event catalog itself exists, and to then trigger catalog init when an event</span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-comment">-- trigger is created _but only if_ this cached information says the event catalog</span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-comment">-- doesn't already exist.</span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span>    </span><span class="annot"><a href="#local-6989586621688410218"><span class="hs-identifier hs-type">initCatalogIfNeeded</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-409"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688411027"><span class="annot"><a href="#local-6989586621688411027"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688411029"><span class="annot"><a href="#local-6989586621688411029"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688411028"><span class="annot"><a href="#local-6989586621688411028"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-410"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688411029"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-411"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411028"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411029"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-412"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688411028"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-413"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411027"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-414"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.html#HasServerConfigCtx"><span class="hs-identifier hs-type">HasServerConfigCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411028"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-415"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411028"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-416"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688411028"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-417"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-418"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411027"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688411029"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RecreateEventTriggers"><span class="hs-identifier hs-type">RecreateEventTriggers</span></a></span><span>
</span><span id="line-419"></span><span>    </span><span id="local-6989586621688410218"><span class="annot"><span class="annottext">initCatalogIfNeeded :: arr (Int, SourceConfig b) RecreateEventTriggers
</span><a href="#local-6989586621688410218"><span class="hs-identifier hs-var hs-var">initCatalogIfNeeded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">arr (Int, SourceConfig b) RecreateEventTriggers
-&gt; arr (Int, SourceConfig b) RecreateEventTriggers
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a b.
(ArrowCache m arr, Cacheable a) =&gt;
arr a b -&gt; arr a b
</span><a href="Hasura.Incremental.Internal.Cache.html#cache"><span class="hs-identifier hs-var">Inc.cache</span></a></span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410217"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688410217"><span class="hs-identifier hs-var">numEventTriggers</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410216"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688410216"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-420"></span><span>      </span><span class="annot"><span class="annottext">(m RecreateEventTriggers -&gt; m RecreateEventTriggers)
-&gt; arr (m RecreateEventTriggers) RecreateEventTriggers
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a b.
ArrowKleisli m arr =&gt;
(a -&gt; m b) -&gt; arr a b
</span><a href="Control.Arrow.Extended.html#arrM"><span class="hs-identifier hs-var">arrM</span></a></span><span> </span><span class="annot"><span class="annottext">m RecreateEventTriggers -&gt; m RecreateEventTriggers
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-422"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688410217"><span class="hs-identifier hs-var">numEventTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-423"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-424"></span><span>              </span><span id="local-6989586621688410214"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688410214"><span class="hs-identifier hs-var">migrationTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; m UTCTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-425"></span><span>              </span><span id="local-6989586621688410213"><span class="annot"><span class="annottext">MaintenanceMode
</span><a href="#local-6989586621688410213"><span class="hs-identifier hs-var">maintenanceMode</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx -&gt; MaintenanceMode
</span><a href="Hasura.Server.Types.html#_sccMaintenanceMode"><span class="hs-identifier hs-var hs-var">_sccMaintenanceMode</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerConfigCtx -&gt; MaintenanceMode)
-&gt; m ServerConfigCtx -&gt; m MaintenanceMode
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m ServerConfigCtx
forall (m :: * -&gt; *). HasServerConfigCtx m =&gt; m ServerConfigCtx
</span><a href="Hasura.RQL.Types.html#askServerConfigCtx"><span class="hs-identifier hs-var">askServerConfigCtx</span></a></span><span>
</span><span id="line-426"></span><span>              </span><span id="local-6989586621688410210"><span class="annot"><span class="annottext">EventingMode
</span><a href="#local-6989586621688410210"><span class="hs-identifier hs-var">eventingMode</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx -&gt; EventingMode
</span><a href="Hasura.Server.Types.html#_sccEventingMode"><span class="hs-identifier hs-var hs-var">_sccEventingMode</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerConfigCtx -&gt; EventingMode)
-&gt; m ServerConfigCtx -&gt; m EventingMode
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m ServerConfigCtx
forall (m :: * -&gt; *). HasServerConfigCtx m =&gt; m ServerConfigCtx
</span><a href="Hasura.RQL.Types.html#askServerConfigCtx"><span class="hs-identifier hs-var">askServerConfigCtx</span></a></span><span>
</span><span id="line-427"></span><span>              </span><span id="local-6989586621688410208"><span class="annot"><span class="annottext">ReadOnlyMode
</span><a href="#local-6989586621688410208"><span class="hs-identifier hs-var">readOnlyMode</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx -&gt; ReadOnlyMode
</span><a href="Hasura.Server.Types.html#_sccReadOnlyMode"><span class="hs-identifier hs-var hs-var">_sccReadOnlyMode</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerConfigCtx -&gt; ReadOnlyMode)
-&gt; m ServerConfigCtx -&gt; m ReadOnlyMode
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m ServerConfigCtx
forall (m :: * -&gt; *). HasServerConfigCtx m =&gt; m ServerConfigCtx
</span><a href="Hasura.RQL.Types.html#askServerConfigCtx"><span class="hs-identifier hs-var">askServerConfigCtx</span></a></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>              </span><span class="hs-keyword">if</span><span>
</span><span id="line-430"></span><span>                  </span><span class="hs-comment">-- when safe mode is enabled, don't perform any migrations</span><span>
</span><span id="line-431"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ReadOnlyMode
</span><a href="#local-6989586621688410208"><span class="hs-identifier hs-var">readOnlyMode</span></a></span><span> </span><span class="annot"><span class="annottext">ReadOnlyMode -&gt; ReadOnlyMode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ReadOnlyMode
</span><a href="Hasura.Server.Types.html#ReadOnlyModeEnabled"><span class="hs-identifier hs-var">ReadOnlyModeEnabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers -&gt; m RecreateEventTriggers
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="Hasura.RQL.Types.EventTrigger.html#RETDoNothing"><span class="hs-identifier hs-var">RETDoNothing</span></a></span><span>
</span><span id="line-432"></span><span>                  </span><span class="hs-comment">-- when eventing mode is disabled, don't perform any migrations</span><span>
</span><span id="line-433"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EventingMode
</span><a href="#local-6989586621688410210"><span class="hs-identifier hs-var">eventingMode</span></a></span><span> </span><span class="annot"><span class="annottext">EventingMode -&gt; EventingMode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EventingMode
</span><a href="Hasura.Server.Types.html#EventingDisabled"><span class="hs-identifier hs-var">EventingDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers -&gt; m RecreateEventTriggers
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="Hasura.RQL.Types.EventTrigger.html#RETDoNothing"><span class="hs-identifier hs-var">RETDoNothing</span></a></span><span>
</span><span id="line-434"></span><span>                  </span><span class="hs-comment">-- when maintenance mode is enabled, don't perform any migrations</span><span>
</span><span id="line-435"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode
</span><a href="#local-6989586621688410213"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode -&gt; MaintenanceMode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode
</span><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-var">MaintenanceModeEnabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers -&gt; m RecreateEventTriggers
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="Hasura.RQL.Types.EventTrigger.html#RETDoNothing"><span class="hs-identifier hs-var">RETDoNothing</span></a></span><span>
</span><span id="line-436"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-437"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410202"><span class="annot"><span class="annottext">initCatalogAction :: m (Either QErr RecreateEventTriggers)
</span><a href="#local-6989586621688410202"><span class="hs-identifier hs-var hs-var">initCatalogAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-438"></span><span>                          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HasTag b =&gt; BackendTag b
forall (b :: BackendType). HasTag b =&gt; BackendTag b
</span><a href="Hasura.SQL.Tag.html#backendTag"><span class="hs-identifier hs-var">backendTag</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688411027"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-439"></span><span>                            </span><span class="annot"><span class="annottext">BackendTag b
</span><a href="Hasura.SQL.Tag.html#PostgresVanillaTag"><span class="hs-identifier hs-var">Tag.PostgresVanillaTag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>                              </span><span class="annot"><span class="annottext">ExceptT QErr m RecreateEventTriggers
-&gt; m (Either QErr RecreateEventTriggers)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m RecreateEventTriggers
 -&gt; m (Either QErr RecreateEventTriggers))
-&gt; ExceptT QErr m RecreateEventTriggers
-&gt; m (Either QErr RecreateEventTriggers)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PGExecCtx
-&gt; TxAccess
-&gt; TxET QErr m RecreateEventTriggers
-&gt; ExceptT QErr m RecreateEventTriggers
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
PGExecCtx -&gt; TxAccess -&gt; TxET QErr m a -&gt; ExceptT QErr m a
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#runTx"><span class="hs-identifier hs-var">runTx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGSourceConfig -&gt; PGExecCtx
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#_pscExecCtx"><span class="hs-identifier hs-var hs-var">_pscExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
PGSourceConfig
</span><a href="#local-6989586621688410216"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><span class="hs-identifier hs-var">Q.ReadWrite</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UTCTime -&gt; TxET QErr m RecreateEventTriggers
forall (m :: * -&gt; *).
MonadTx m =&gt;
UTCTime -&gt; m RecreateEventTriggers
</span><a href="Hasura.Backends.Postgres.DDL.Source.html#initCatalogForSource"><span class="hs-identifier hs-var">initCatalogForSource</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688410214"><span class="hs-identifier hs-var">migrationTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>                            </span><span class="annot"><span class="annottext">BackendTag b
</span><a href="Hasura.SQL.Tag.html#MSSQLTag"><span class="hs-identifier hs-var">Tag.MSSQLTag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-442"></span><span>                              </span><span class="annot"><span class="annottext">ExceptT QErr m RecreateEventTriggers
-&gt; m (Either QErr RecreateEventTriggers)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m RecreateEventTriggers
 -&gt; m (Either QErr RecreateEventTriggers))
-&gt; ExceptT QErr m RecreateEventTriggers
-&gt; m (Either QErr RecreateEventTriggers)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-443"></span><span>                                </span><span class="annot"><span class="annottext">MSSQLExecCtx
-&gt; TxET QErr m RecreateEventTriggers
-&gt; ExceptT QErr m RecreateEventTriggers
MSSQLExecCtx
-&gt; forall (m :: * -&gt; *) a.
   (MonadIO m, MonadBaseControl IO m) =&gt;
   TxET QErr m a -&gt; ExceptT QErr m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#mssqlRunReadWrite"><span class="hs-identifier hs-var hs-var">mssqlRunReadWrite</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; MSSQLExecCtx
</span><a href="Hasura.Backends.MSSQL.Connection.html#_mscExecCtx"><span class="hs-identifier hs-var hs-var">_mscExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
MSSQLSourceConfig
</span><a href="#local-6989586621688410216"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TxET QErr m RecreateEventTriggers
forall (m :: * -&gt; *). MonadMSSQLTx m =&gt; m RecreateEventTriggers
</span><a href="Hasura.Backends.MSSQL.DDL.Source.html#initCatalogForSource"><span class="hs-identifier hs-var">MSSQL.initCatalogForSource</span></a></span><span>
</span><span id="line-444"></span><span>                            </span><span class="hs-comment">-- TODO: When event triggers are supported on new databases,</span><span>
</span><span id="line-445"></span><span>                            </span><span class="hs-comment">-- the initialization of the source catalog should also return</span><span>
</span><span id="line-446"></span><span>                            </span><span class="hs-comment">-- if the event triggers are to be re-created or not, essentially</span><span>
</span><span id="line-447"></span><span>                            </span><span class="hs-comment">-- replacing the `RETDoNothing` below</span><span>
</span><span id="line-448"></span><span>                            </span><span class="annot"><span class="annottext">BackendTag b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either QErr RecreateEventTriggers
-&gt; m (Either QErr RecreateEventTriggers)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr RecreateEventTriggers
 -&gt; m (Either QErr RecreateEventTriggers))
-&gt; Either QErr RecreateEventTriggers
-&gt; m (Either QErr RecreateEventTriggers)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers -&gt; Either QErr RecreateEventTriggers
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="Hasura.RQL.Types.EventTrigger.html#RETDoNothing"><span class="hs-identifier hs-var">RETDoNothing</span></a></span><span>
</span><span id="line-449"></span><span>                    </span><span class="hs-comment">-- The `initCatalogForSource` action is retried here because</span><span>
</span><span id="line-450"></span><span>                    </span><span class="hs-comment">-- in cloud there will be multiple workers (graphql-engine instances)</span><span>
</span><span id="line-451"></span><span>                    </span><span class="hs-comment">-- trying to migrate the source catalog, when needed. This introduces</span><span>
</span><span id="line-452"></span><span>                    </span><span class="hs-comment">-- a race condition as both the workers try to migrate the source catalog</span><span>
</span><span id="line-453"></span><span>                    </span><span class="hs-comment">-- concurrently and when one of them succeeds the other ones will fail</span><span>
</span><span id="line-454"></span><span>                    </span><span class="hs-comment">-- and be in an inconsistent state. To avoid the inconsistency, we retry</span><span>
</span><span id="line-455"></span><span>                    </span><span class="hs-comment">-- migrating the catalog on error and in the retry `initCatalogForSource`</span><span>
</span><span id="line-456"></span><span>                    </span><span class="hs-comment">-- will see that the catalog is already migrated, so it won't attempt the</span><span>
</span><span id="line-457"></span><span>                    </span><span class="hs-comment">-- migration again</span><span>
</span><span id="line-458"></span><span>                    </span><span class="annot"><span class="annottext">Either QErr RecreateEventTriggers -&gt; m RecreateEventTriggers
forall e (m :: * -&gt; *) a. MonadError e m =&gt; Either e a -&gt; m a
</span><span class="hs-identifier hs-var">liftEither</span></span><span>
</span><span id="line-459"></span><span>                      </span><span class="annot"><span class="annottext">(Either QErr RecreateEventTriggers -&gt; m RecreateEventTriggers)
-&gt; m (Either QErr RecreateEventTriggers) -&gt; m RecreateEventTriggers
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">RetryPolicyM m
-&gt; (RetryStatus -&gt; Either QErr RecreateEventTriggers -&gt; m Bool)
-&gt; (RetryStatus -&gt; m (Either QErr RecreateEventTriggers))
-&gt; m (Either QErr RecreateEventTriggers)
forall (m :: * -&gt; *) b.
MonadIO m =&gt;
RetryPolicyM m
-&gt; (RetryStatus -&gt; b -&gt; m Bool) -&gt; (RetryStatus -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">Retry.retrying</span></span><span>
</span><span id="line-460"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Int -&gt; RetryPolicyM m
forall (m :: * -&gt; *). Monad m =&gt; Int -&gt; RetryPolicyM m
</span><span class="hs-identifier hs-var">Retry.constantDelay</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Int) -&gt; Integer -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; Integer
</span><a href="Data.Time.Clock.Units.html#diffTimeToMicroSeconds"><span class="hs-identifier hs-var">diffTimeToMicroSeconds</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; Integer) -&gt; DiffTime -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Seconds -&gt; DiffTime
</span><a href="Data.Time.Clock.Units.html#seconds"><span class="hs-identifier hs-var hs-var">seconds</span></a></span><span> </span><span class="annot"><span class="annottext">(Seconds -&gt; DiffTime) -&gt; Seconds -&gt; DiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; Seconds
</span><a href="Data.Time.Clock.Units.html#Seconds"><span class="hs-identifier hs-var">Seconds</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">10</span></span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>                            </span><span class="annot"><span class="annottext">RetryPolicyM m -&gt; RetryPolicyM m -&gt; RetryPolicyM m
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; RetryPolicy
</span><span class="hs-identifier hs-var">Retry.limitRetries</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span>
</span><span id="line-462"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Either QErr RecreateEventTriggers -&gt; m Bool)
-&gt; RetryStatus -&gt; Either QErr RecreateEventTriggers -&gt; m Bool
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">((Either QErr RecreateEventTriggers -&gt; m Bool)
 -&gt; RetryStatus -&gt; Either QErr RecreateEventTriggers -&gt; m Bool)
-&gt; (Either QErr RecreateEventTriggers -&gt; m Bool)
-&gt; RetryStatus
-&gt; Either QErr RecreateEventTriggers
-&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool)
-&gt; (Either QErr RecreateEventTriggers -&gt; Bool)
-&gt; Either QErr RecreateEventTriggers
-&gt; m Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Either QErr RecreateEventTriggers -&gt; Bool
forall a b. Either a b -&gt; Bool
</span><span class="hs-identifier hs-var">isLeft</span></span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (Either QErr RecreateEventTriggers)
-&gt; RetryStatus -&gt; m (Either QErr RecreateEventTriggers)
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">m (Either QErr RecreateEventTriggers)
</span><a href="#local-6989586621688410202"><span class="hs-identifier hs-var">initCatalogAction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers -&gt; m RecreateEventTriggers
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="Hasura.RQL.Types.EventTrigger.html#RETDoNothing"><span class="hs-identifier hs-var">RETDoNothing</span></a></span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span>    </span><span class="annot"><a href="#local-6989586621688410183"><span class="hs-identifier hs-type">buildSource</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-468"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688410859"><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688410861"><span class="annot"><a href="#local-6989586621688410861"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688410860"><span class="annot"><a href="#local-6989586621688410860"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-469"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410861"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-470"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410861"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-471"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410860"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410861"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-472"></span><span>        </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410861"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-473"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688410860"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.html#HasServerConfigCtx"><span class="hs-identifier hs-type">HasServerConfigCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410860"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-475"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688410860"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-476"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410860"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-477"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#BuildReason"><span class="hs-identifier hs-type">BuildReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410860"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-478"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-479"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-480"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-481"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.SQL.AnyBackend.html#AnyBackend"><span class="hs-identifier hs-type">AB.AnyBackend</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteRelationship.html#PartiallyResolvedSource"><span class="hs-identifier hs-type">PartiallyResolvedSource</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-482"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-483"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-484"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#TableCoreInfoG"><span class="hs-identifier hs-type">TableCoreInfoG</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-485"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#DBTablesMetadata"><span class="hs-identifier hs-type">DBTablesMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Function.html#DBFunctionsMetadata"><span class="hs-identifier hs-type">DBFunctionsMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-487"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#RemoteSchemaMap"><span class="hs-identifier hs-type">RemoteSchemaMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-488"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Dependency"><span class="hs-identifier hs-type">Inc.Dependency</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#InvalidationKeys"><span class="hs-identifier hs-type">InvalidationKeys</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-489"></span><span>        </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span>
</span><span id="line-490"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-491"></span><span>        </span><span class="annot"><a href="#local-6989586621688410861"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#BackendSourceInfo"><span class="hs-identifier hs-type">BackendSourceInfo</span></a></span><span>
</span><span id="line-492"></span><span>    </span><span id="local-6989586621688410183"><span class="annot"><span class="annottext">buildSource :: arr
  (HashMap SourceName (AnyBackend PartiallyResolvedSource),
   SourceMetadata b, SourceConfig b,
   HashMap
     (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)),
   DBTablesMetadata b, DBFunctionsMetadata b, RemoteSchemaMap,
   Dependency InvalidationKeys, OrderedRoles)
  BackendSourceInfo
</span><a href="#local-6989586621688410183"><span class="hs-identifier hs-var hs-var">buildSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410182"><span class="annot"><span class="annottext">HashMap SourceName (AnyBackend PartiallyResolvedSource)
</span><a href="#local-6989586621688410182"><span class="hs-identifier hs-var">allSources</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410181"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410181"><span class="hs-identifier hs-var">sourceMetadata</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410180"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688410180"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410179"><span class="annot"><span class="annottext">HashMap
  (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b))
</span><a href="#local-6989586621688410179"><span class="hs-identifier hs-var">tablesRawInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410178"><span class="annot"><span class="annottext">DBTablesMetadata b
</span><a href="#local-6989586621688410178"><span class="hs-identifier hs-var">_dbTables</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410177"><span class="annot"><span class="annottext">DBFunctionsMetadata b
</span><a href="#local-6989586621688410177"><span class="hs-identifier hs-var">dbFunctions</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410176"><span class="annot"><span class="annottext">RemoteSchemaMap
</span><a href="#local-6989586621688410176"><span class="hs-identifier hs-var">remoteSchemaMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410175"><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410175"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410174"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688410174"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-493"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span id="local-6989586621688410172"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410172"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621688410171"><span class="annot"><span class="annottext">Tables b
</span><a href="#local-6989586621688410171"><span class="hs-identifier hs-var">tables</span></a></span></span><span> </span><span id="local-6989586621688410170"><span class="annot"><span class="annottext">Functions b
</span><a href="#local-6989586621688410170"><span class="hs-identifier hs-var">functions</span></a></span></span><span> </span><span class="annot"><span class="annottext">SourceConnConfiguration b
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688410169"><span class="annot"><span class="annottext">Maybe QueryTagsConfig
</span><a href="#local-6989586621688410169"><span class="hs-identifier hs-var">queryTagsConfig</span></a></span></span><span> </span><span id="local-6989586621688410168"><span class="annot"><span class="annottext">SourceCustomization
</span><a href="#local-6989586621688410168"><span class="hs-identifier hs-var">sourceCustomization</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410181"><span class="hs-identifier hs-var">sourceMetadata</span></a></span><span>
</span><span id="line-494"></span><span>          </span><span id="local-6989586621688410167"><span class="annot"><span class="annottext">tablesMetadata :: [TableMetadata b]
</span><a href="#local-6989586621688410167"><span class="hs-identifier hs-var hs-var">tablesMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tables b -&gt; [TableMetadata b]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">Tables b
</span><a href="#local-6989586621688410171"><span class="hs-identifier hs-var">tables</span></a></span><span>
</span><span id="line-495"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TableBuildInput b]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410165"><span class="annot"><span class="annottext">[NonColumnTableInputs b]
</span><a href="#local-6989586621688410165"><span class="hs-identifier hs-var">nonColumnInputs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410164"><span class="annot"><span class="annottext">[TablePermissionInputs b]
</span><a href="#local-6989586621688410164"><span class="hs-identifier hs-var">permissions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(TableBuildInput b, NonColumnTableInputs b,
  TablePermissionInputs b)]
-&gt; ([TableBuildInput b], [NonColumnTableInputs b],
    [TablePermissionInputs b])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">([(TableBuildInput b, NonColumnTableInputs b,
   TablePermissionInputs b)]
 -&gt; ([TableBuildInput b], [NonColumnTableInputs b],
     [TablePermissionInputs b]))
-&gt; [(TableBuildInput b, NonColumnTableInputs b,
     TablePermissionInputs b)]
-&gt; ([TableBuildInput b], [NonColumnTableInputs b],
    [TablePermissionInputs b])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TableMetadata b
 -&gt; (TableBuildInput b, NonColumnTableInputs b,
     TablePermissionInputs b))
-&gt; [TableMetadata b]
-&gt; [(TableBuildInput b, NonColumnTableInputs b,
     TablePermissionInputs b)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TableMetadata b
-&gt; (TableBuildInput b, NonColumnTableInputs b,
    TablePermissionInputs b)
forall (b :: BackendType).
TableMetadata b
-&gt; (TableBuildInput b, NonColumnTableInputs b,
    TablePermissionInputs b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#mkTableInputs"><span class="hs-identifier hs-var">mkTableInputs</span></a></span><span> </span><span class="annot"><span class="annottext">[TableMetadata b]
</span><a href="#local-6989586621688410167"><span class="hs-identifier hs-var">tablesMetadata</span></a></span><span>
</span><span id="line-496"></span><span>          </span><span id="local-6989586621688410161"><span class="annot"><span class="annottext">eventTriggers :: [(TableName b, [EventTriggerConf b])]
</span><a href="#local-6989586621688410161"><span class="hs-identifier hs-var hs-var">eventTriggers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TableMetadata b -&gt; (TableName b, [EventTriggerConf b]))
-&gt; [TableMetadata b] -&gt; [(TableName b, [EventTriggerConf b])]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableMetadata b -&gt; TableName b
forall (b :: BackendType). TableMetadata b -&gt; TableName b
</span><a href="Hasura.RQL.Types.Metadata.html#_tmTable"><span class="hs-identifier hs-var hs-var">_tmTable</span></a></span><span> </span><span class="annot"><span class="annottext">(TableMetadata b -&gt; TableName b)
-&gt; (TableMetadata b -&gt; [EventTriggerConf b])
-&gt; TableMetadata b
-&gt; (TableName b, [EventTriggerConf b])
forall (a :: * -&gt; * -&gt; *) b c c'.
Arrow a =&gt;
a b c -&gt; a b c' -&gt; a b (c, c')
</span><span class="hs-operator hs-var">&amp;&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b)
-&gt; [EventTriggerConf b]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap TriggerName (EventTriggerConf b)
 -&gt; [EventTriggerConf b])
-&gt; (TableMetadata b
    -&gt; InsOrdHashMap TriggerName (EventTriggerConf b))
-&gt; TableMetadata b
-&gt; [EventTriggerConf b]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableMetadata b -&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
forall (b :: BackendType). TableMetadata b -&gt; EventTriggers b
</span><a href="Hasura.RQL.Types.Metadata.html#_tmEventTriggers"><span class="hs-identifier hs-var hs-var">_tmEventTriggers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TableMetadata b]
</span><a href="#local-6989586621688410167"><span class="hs-identifier hs-var">tablesMetadata</span></a></span><span>
</span><span id="line-497"></span><span>          </span><span id="local-6989586621688411006"><span id="local-6989586621688411007"><span class="annot"><a href="#local-6989586621688410157"><span class="hs-identifier hs-type">alignTableMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688411007"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688411006"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688411007"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688411006"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-498"></span><span>          </span><span id="local-6989586621688410157"><span class="annot"><span class="annottext">alignTableMap :: HashMap (TableName b) a
-&gt; HashMap (TableName b) c -&gt; HashMap (TableName b) (a, c)
</span><a href="#local-6989586621688410157"><span class="hs-identifier hs-var hs-var">alignTableMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; c -&gt; (a, c))
-&gt; HashMap (TableName b) a
-&gt; HashMap (TableName b) c
-&gt; HashMap (TableName b) (a, c)
forall k v1 v2 v3.
(Eq k, Hashable k) =&gt;
(v1 -&gt; v2 -&gt; v3) -&gt; HashMap k v1 -&gt; HashMap k v2 -&gt; HashMap k v3
</span><span class="hs-identifier hs-var">M.intersectionWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>          </span><span id="local-6989586621688410155"><span class="annot"><span class="annottext">metadataInvalidationKey :: Dependency InvalidationKey
</span><a href="#local-6989586621688410155"><span class="hs-identifier hs-var hs-var">metadataInvalidationKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Selector InvalidationKeys InvalidationKey
-&gt; Dependency InvalidationKeys -&gt; Dependency InvalidationKey
forall a b.
Select a =&gt;
Selector a b -&gt; Dependency a -&gt; Dependency b
</span><a href="Hasura.Incremental.Internal.Dependency.html#selectD"><span class="hs-identifier hs-var">Inc.selectD</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;_ikMetadata&quot; (FieldS InvalidationKeys InvalidationKey)
Selector InvalidationKeys InvalidationKey
</span><a href="#local-6989586621688410153"><span class="hs-var">#_ikMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410175"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span>
</span><span id="line-500"></span><span>          </span><span id="local-6989586621688410152"><span class="annot"><span class="annottext">numEventTriggers :: Int
</span><a href="#local-6989586621688410152"><span class="hs-identifier hs-var hs-var">numEventTriggers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Int) -&gt; [Int] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((TableName b, [EventTriggerConf b]) -&gt; Int)
-&gt; [(TableName b, [EventTriggerConf b])] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EventTriggerConf b] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([EventTriggerConf b] -&gt; Int)
-&gt; ((TableName b, [EventTriggerConf b]) -&gt; [EventTriggerConf b])
-&gt; (TableName b, [EventTriggerConf b])
-&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TableName b, [EventTriggerConf b]) -&gt; [EventTriggerConf b]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(TableName b, [EventTriggerConf b])]
</span><a href="#local-6989586621688410161"><span class="hs-identifier hs-var">eventTriggers</span></a></span><span>
</span><span id="line-501"></span><span>
</span><span id="line-502"></span><span>      </span><span id="local-6989586621688410150"><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="#local-6989586621688410150"><span class="hs-identifier hs-var">recreateEventTriggers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowCache m arr, MonadIO m, BackendMetadata b,
 HasServerConfigCtx m, MonadError QErr m, MonadBaseControl IO m) =&gt;
arr (Int, SourceConfig b) RecreateEventTriggers
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowCache m arr, MonadIO m, BackendMetadata b,
 HasServerConfigCtx m, MonadError QErr m, MonadBaseControl IO m) =&gt;
arr (Int, SourceConfig b) RecreateEventTriggers
</span><a href="#local-6989586621688410218"><span class="hs-identifier hs-var">initCatalogIfNeeded</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688410152"><span class="hs-identifier hs-var">numEventTriggers</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688410180"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span>      </span><span class="hs-comment">-- relationships and computed fields</span><span>
</span><span id="line-505"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410149"><span class="annot"><span class="annottext">nonColumnsByTable :: HashMap (TableName b) (NonColumnTableInputs b)
</span><a href="#local-6989586621688410149"><span class="hs-identifier hs-var hs-var">nonColumnsByTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NonColumnTableInputs b -&gt; TableName b)
-&gt; [NonColumnTableInputs b]
-&gt; HashMap (TableName b) (NonColumnTableInputs b)
forall k a. (Eq k, Hashable k) =&gt; (a -&gt; k) -&gt; [a] -&gt; HashMap k a
</span><a href="Hasura.Prelude.html#mapFromL"><span class="hs-identifier hs-var">mapFromL</span></a></span><span> </span><span class="annot"><span class="annottext">NonColumnTableInputs b -&gt; TableName b
forall (b :: BackendType). NonColumnTableInputs b -&gt; TableName b
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_nctiTable"><span class="hs-identifier hs-var hs-var">_nctiTable</span></a></span><span> </span><span class="annot"><span class="annottext">[NonColumnTableInputs b]
</span><a href="#local-6989586621688410165"><span class="hs-identifier hs-var">nonColumnInputs</span></a></span><span>
</span><span id="line-506"></span><span>      </span><span id="local-6989586621688410146"><span class="annot"><a href="#local-6989586621688410146"><span class="hs-identifier hs-var">tableCoreInfos</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#TableCoreInfo"><span class="hs-identifier hs-type">TableCoreInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-507"></span><span>        </span><span class="hs-glyph">(|</span><span>
</span><span id="line-508"></span><span>          </span><span class="annot"><span class="annottext">forall a.
arr
  (a,
   (TableName b,
    ((TableCoreInfoG b (ColumnInfo b) (ColumnInfo b),
      NonColumnTableInputs b),
     ())))
  (TableCoreInfo b)
-&gt; arr
     (a,
      (HashMap
         (TableName b)
         (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b),
          NonColumnTableInputs b),
       ()))
     (HashMap (TableName b) (TableCoreInfo b))
forall (arr :: * -&gt; * -&gt; *) k e a s b.
(ArrowDistribute arr, Eq k, Hashable k) =&gt;
arr (e, (k, (a, s))) b -&gt; arr (e, (HashMap k a, s)) (HashMap k b)
</span><a href="Hasura.Incremental.Internal.Rule.html#keyed"><span class="hs-identifier hs-var">Inc.keyed</span></a></span><span>
</span><span id="line-509"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">TableName b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410144"><span class="annot"><span class="annottext">TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)
</span><a href="#local-6989586621688410144"><span class="hs-identifier hs-var">tableRawInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410143"><span class="annot"><span class="annottext">NonColumnTableInputs b
</span><a href="#local-6989586621688410143"><span class="hs-identifier hs-var">nonColumnInput</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-510"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410142"><span class="annot"><span class="annottext">columns :: FieldInfoMap (ColumnInfo b)
</span><a href="#local-6989586621688410142"><span class="hs-identifier hs-var hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)
-&gt; FieldInfoMap (ColumnInfo b)
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn -&gt; FieldInfoMap field
</span><a href="Hasura.RQL.Types.Table.html#_tciFieldInfoMap"><span class="hs-identifier hs-var hs-var">_tciFieldInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)
</span><a href="#local-6989586621688410144"><span class="hs-identifier hs-var">tableRawInfo</span></a></span><span>
</span><span id="line-511"></span><span>                </span><span id="local-6989586621688410140"><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688410140"><span class="hs-identifier hs-var">allFields</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#FieldInfoMap"><span class="hs-identifier hs-type">FieldInfoMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#FieldInfo"><span class="hs-identifier hs-type">FieldInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (HashMap SourceName (AnyBackend PartiallyResolvedSource),
   SourceName,
   HashMap
     (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)),
   FieldInfoMap (ColumnInfo b), RemoteSchemaMap,
   DBFunctionsMetadata b, NonColumnTableInputs b)
  (FieldInfoMap (FieldInfo b))
forall (b :: BackendType) (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, ArrowKleisli m arr,
 MonadError QErr m, BackendMetadata b) =&gt;
arr
  (HashMap SourceName (AnyBackend PartiallyResolvedSource),
   SourceName,
   HashMap
     (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)),
   FieldInfoMap (ColumnInfo b), RemoteSchemaMap,
   DBFunctionsMetadata b, NonColumnTableInputs b)
  (FieldInfoMap (FieldInfo b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Fields.html#addNonColumnFields"><span class="hs-identifier hs-var">addNonColumnFields</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap SourceName (AnyBackend PartiallyResolvedSource)
</span><a href="#local-6989586621688410182"><span class="hs-identifier hs-var">allSources</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410172"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashMap
  (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b))
</span><a href="#local-6989586621688410179"><span class="hs-identifier hs-var">tablesRawInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (ColumnInfo b)
</span><a href="#local-6989586621688410142"><span class="hs-identifier hs-var">columns</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMap
</span><a href="#local-6989586621688410176"><span class="hs-identifier hs-var">remoteSchemaMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DBFunctionsMetadata b
</span><a href="#local-6989586621688410177"><span class="hs-identifier hs-var">dbFunctions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NonColumnTableInputs b
</span><a href="#local-6989586621688410143"><span class="hs-identifier hs-var">nonColumnInput</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span>                </span><span class="annot"><span class="annottext">arr (TableCoreInfo b) (TableCoreInfo b)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)
</span><a href="#local-6989586621688410144"><span class="hs-identifier hs-var">tableRawInfo</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">_tciFieldInfoMap :: FieldInfoMap (FieldInfo b)
</span><a href="Hasura.RQL.Types.Table.html#_tciFieldInfoMap"><span class="hs-identifier hs-var">_tciFieldInfoMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688410140"><span class="hs-identifier hs-var">allFields</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span>          </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap
  (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b))
</span><a href="#local-6989586621688410179"><span class="hs-identifier hs-var">tablesRawInfo</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b))
-&gt; HashMap (TableName b) (NonColumnTableInputs b)
-&gt; HashMap
     (TableName b)
     (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b),
      NonColumnTableInputs b)
forall a c.
HashMap (TableName b) a
-&gt; HashMap (TableName b) c -&gt; HashMap (TableName b) (a, c)
</span><a href="#local-6989586621688410157"><span class="hs-operator hs-var">`alignTableMap`</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap (TableName b) (NonColumnTableInputs b)
</span><a href="#local-6989586621688410149"><span class="hs-identifier hs-var">nonColumnsByTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span>      </span><span id="local-6989586621688410138"><span class="annot"><span class="annottext">Dependency (HashMap (TableName b) (TableCoreInfo b))
</span><a href="#local-6989586621688410138"><span class="hs-identifier hs-var">tableCoreInfosDep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (HashMap (TableName b) (TableCoreInfo b))
  (Dependency (HashMap (TableName b) (TableCoreInfo b)))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowCache m arr =&gt;
arr a (Dependency a)
</span><a href="Hasura.Incremental.Internal.Cache.html#newDependency"><span class="hs-identifier hs-var">Inc.newDependency</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">HashMap (TableName b) (TableCoreInfo b)
</span><a href="#local-6989586621688410146"><span class="hs-identifier hs-var">tableCoreInfos</span></a></span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span>      </span><span class="hs-comment">-- permissions and event triggers</span><span>
</span><span id="line-519"></span><span>      </span><span id="local-6989586621688410137"><span class="annot"><span class="annottext">HashMap (TableName b) (TableInfo b)
</span><a href="#local-6989586621688410137"><span class="hs-identifier hs-var">tableCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-520"></span><span>        </span><span class="hs-glyph">(|</span><span>
</span><span id="line-521"></span><span>          </span><span class="annot"><span class="annottext">forall a.
arr
  (a,
   (TableName b,
    (((TableCoreInfo b, TablePermissionInputs b),
      (TableName b, [EventTriggerConf b])),
     ())))
  (TableInfo b)
-&gt; arr
     (a,
      (HashMap
         (TableName b)
         ((TableCoreInfo b, TablePermissionInputs b),
          (TableName b, [EventTriggerConf b])),
       ()))
     (HashMap (TableName b) (TableInfo b))
forall (arr :: * -&gt; * -&gt; *) k e a s b.
(ArrowDistribute arr, Eq k, Hashable k) =&gt;
arr (e, (k, (a, s))) b -&gt; arr (e, (HashMap k a, s)) (HashMap k b)
</span><a href="Hasura.Incremental.Internal.Rule.html#keyed"><span class="hs-identifier hs-var">Inc.keyed</span></a></span><span>
</span><span id="line-522"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">TableName b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621688410136"><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688410136"><span class="hs-identifier hs-var">tableCoreInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410135"><span class="annot"><span class="annottext">TablePermissionInputs b
</span><a href="#local-6989586621688410135"><span class="hs-identifier hs-var">permissionInputs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410134"><span class="annot"><span class="annottext">[EventTriggerConf b]
</span><a href="#local-6989586621688410134"><span class="hs-identifier hs-var">eventTriggerConfs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-523"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410133"><span class="annot"><span class="annottext">tableFields :: FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688410133"><span class="hs-identifier hs-var hs-var">tableFields</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableCoreInfo b -&gt; FieldInfoMap (FieldInfo b)
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn -&gt; FieldInfoMap field
</span><a href="Hasura.RQL.Types.Table.html#_tciFieldInfoMap"><span class="hs-identifier hs-var hs-var">_tciFieldInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688410136"><span class="hs-identifier hs-var">tableCoreInfo</span></a></span><span>
</span><span id="line-524"></span><span>                </span><span id="local-6989586621688410132"><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621688410132"><span class="hs-identifier hs-var">permissionInfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-525"></span><span>                  </span><span class="annot"><span class="annottext">arr
  (Proxy b, SourceName,
   Dependency (HashMap (TableName b) (TableCoreInfo b)),
   FieldInfoMap (FieldInfo b), TablePermissionInputs b, OrderedRoles)
  (RolePermInfoMap b)
forall (b :: BackendType) (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr, ArrowCache m arr,
 MonadError QErr m, ArrowWriter (Seq CollectedInfo) arr,
 BackendMetadata b, Cacheable (Proxy b)) =&gt;
arr
  (Proxy b, SourceName, Dependency (TableCoreCache b),
   FieldInfoMap (FieldInfo b), TablePermissionInputs b, OrderedRoles)
  (RolePermInfoMap b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildTablePermissions"><span class="hs-identifier hs-var">buildTablePermissions</span></a></span><span>
</span><span id="line-526"></span><span>                    </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-527"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy b
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410172"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependency (HashMap (TableName b) (TableCoreInfo b))
</span><a href="#local-6989586621688410138"><span class="hs-identifier hs-var">tableCoreInfosDep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688410133"><span class="hs-identifier hs-var">tableFields</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TablePermissionInputs b
</span><a href="#local-6989586621688410135"><span class="hs-identifier hs-var">permissionInputs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688410174"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>                </span><span id="local-6989586621688410129"><span class="annot"><span class="annottext">EventTriggerInfoMap b
</span><a href="#local-6989586621688410129"><span class="hs-identifier hs-var">eventTriggerInfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (SourceName, SourceConfig b, TableCoreInfo b, [EventTriggerConf b],
   Dependency InvalidationKey, RecreateEventTriggers)
  (EventTriggerInfoMap b)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) (b :: BackendType).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, ArrowCache m arr, MonadIO m,
 MonadError QErr m, MonadBaseControl IO m,
 MonadReader BuildReason m, HasServerConfigCtx m, BackendMetadata b,
 BackendEventTrigger b) =&gt;
arr
  (SourceName, SourceConfig b, TableCoreInfo b, [EventTriggerConf b],
   Dependency InvalidationKey, RecreateEventTriggers)
  (EventTriggerInfoMap b)
</span><a href="#local-6989586621688410128"><span class="hs-identifier hs-var">buildTableEventTriggers</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410172"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688410180"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688410136"><span class="hs-identifier hs-var">tableCoreInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[EventTriggerConf b]
</span><a href="#local-6989586621688410134"><span class="hs-identifier hs-var">eventTriggerConfs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependency InvalidationKey
</span><a href="#local-6989586621688410155"><span class="hs-identifier hs-var">metadataInvalidationKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="#local-6989586621688410150"><span class="hs-identifier hs-var">recreateEventTriggers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>                </span><span class="annot"><span class="annottext">arr (TableInfo b) (TableInfo b)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">TableCoreInfo b
-&gt; RolePermInfoMap b
-&gt; EventTriggerInfoMap b
-&gt; RolePermInfo b
-&gt; TableInfo b
forall (b :: BackendType).
TableCoreInfo b
-&gt; RolePermInfoMap b
-&gt; EventTriggerInfoMap b
-&gt; RolePermInfo b
-&gt; TableInfo b
</span><a href="Hasura.RQL.Types.Table.html#TableInfo"><span class="hs-identifier hs-var">TableInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688410136"><span class="hs-identifier hs-var">tableCoreInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621688410132"><span class="hs-identifier hs-var">permissionInfos</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfoMap b
</span><a href="#local-6989586621688410129"><span class="hs-identifier hs-var">eventTriggerInfos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableCoreInfo b -&gt; RolePermInfo b
forall (b :: BackendType).
Backend b =&gt;
TableCoreInfo b -&gt; RolePermInfo b
</span><a href="Hasura.RQL.Types.Table.html#mkAdminRolePermInfo"><span class="hs-identifier hs-var">mkAdminRolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688410136"><span class="hs-identifier hs-var">tableCoreInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>          </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap (TableName b) (TableCoreInfo b)
</span><a href="#local-6989586621688410146"><span class="hs-identifier hs-var">tableCoreInfos</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap (TableName b) (TableCoreInfo b)
-&gt; HashMap (TableName b) (TablePermissionInputs b)
-&gt; HashMap (TableName b) (TableCoreInfo b, TablePermissionInputs b)
forall a c.
HashMap (TableName b) a
-&gt; HashMap (TableName b) c -&gt; HashMap (TableName b) (a, c)
</span><a href="#local-6989586621688410157"><span class="hs-operator hs-var">`alignTableMap`</span></a></span><span> </span><span class="annot"><span class="annottext">(TablePermissionInputs b -&gt; TableName b)
-&gt; [TablePermissionInputs b]
-&gt; HashMap (TableName b) (TablePermissionInputs b)
forall k a. (Eq k, Hashable k) =&gt; (a -&gt; k) -&gt; [a] -&gt; HashMap k a
</span><a href="Hasura.Prelude.html#mapFromL"><span class="hs-identifier hs-var">mapFromL</span></a></span><span> </span><span class="annot"><span class="annottext">TablePermissionInputs b -&gt; TableName b
forall (b :: BackendType). TablePermissionInputs b -&gt; TableName b
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_tpiTable"><span class="hs-identifier hs-var hs-var">_tpiTable</span></a></span><span> </span><span class="annot"><span class="annottext">[TablePermissionInputs b]
</span><a href="#local-6989586621688410164"><span class="hs-identifier hs-var">permissions</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap (TableName b) (TableCoreInfo b, TablePermissionInputs b)
-&gt; HashMap (TableName b) (TableName b, [EventTriggerConf b])
-&gt; HashMap
     (TableName b)
     ((TableCoreInfo b, TablePermissionInputs b),
      (TableName b, [EventTriggerConf b]))
forall a c.
HashMap (TableName b) a
-&gt; HashMap (TableName b) c -&gt; HashMap (TableName b) (a, c)
</span><a href="#local-6989586621688410157"><span class="hs-operator hs-var">`alignTableMap`</span></a></span><span> </span><span class="annot"><span class="annottext">((TableName b, [EventTriggerConf b]) -&gt; TableName b)
-&gt; [(TableName b, [EventTriggerConf b])]
-&gt; HashMap (TableName b) (TableName b, [EventTriggerConf b])
forall k a. (Eq k, Hashable k) =&gt; (a -&gt; k) -&gt; [a] -&gt; HashMap k a
</span><a href="Hasura.Prelude.html#mapFromL"><span class="hs-identifier hs-var">mapFromL</span></a></span><span> </span><span class="annot"><span class="annottext">(TableName b, [EventTriggerConf b]) -&gt; TableName b
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(TableName b, [EventTriggerConf b])]
</span><a href="#local-6989586621688410161"><span class="hs-identifier hs-var">eventTriggers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>
</span><span id="line-533"></span><span>      </span><span class="hs-comment">-- sql functions</span><span>
</span><span id="line-534"></span><span>      </span><span id="local-6989586621688410124"><span class="annot"><span class="annottext">HashMap (FunctionName b) (FunctionInfo b)
</span><a href="#local-6989586621688410124"><span class="hs-identifier hs-var">functionCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-535"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FunctionMetadata b -&gt; FunctionName b)
-&gt; [FunctionMetadata b]
-&gt; HashMap (FunctionName b) (FunctionMetadata b)
forall k a. (Eq k, Hashable k) =&gt; (a -&gt; k) -&gt; [a] -&gt; HashMap k a
</span><a href="Hasura.Prelude.html#mapFromL"><span class="hs-identifier hs-var">mapFromL</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionMetadata b -&gt; FunctionName b
forall (b :: BackendType). FunctionMetadata b -&gt; FunctionName b
</span><a href="Hasura.RQL.Types.Metadata.html#_fmFunction"><span class="hs-identifier hs-var hs-var">_fmFunction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Functions b -&gt; [FunctionMetadata b]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">Functions b
</span><a href="#local-6989586621688410170"><span class="hs-identifier hs-var">functions</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&gt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (HashMap (FunctionName b) (FunctionMetadata b))
  (HashMap (FunctionName b) (FunctionMetadata b))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span>          </span><span class="annot"><span class="annottext">forall a.
arr (a, ()) (HashMap (FunctionName b) (FunctionMetadata b))
-&gt; arr
     (a, (HashMap (FunctionName b) (FunctionMetadata b), ()))
     (HashMap (FunctionName b) (Maybe (FunctionInfo b)))
-&gt; arr (a, ()) (HashMap (FunctionName b) (Maybe (FunctionInfo b)))
forall (arr :: * -&gt; * -&gt; *) e s a b.
Arrow arr =&gt;
arr (e, s) a -&gt; arr (e, (a, s)) b -&gt; arr (e, s) b
</span><a href="Control.Arrow.Extended.html#%3E-%3E"><span class="hs-operator hs-var">&gt;-&gt;</span></a></span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-537"></span><span>                </span><span class="annot"><span class="annottext">forall a.
arr
  (a, (FunctionName b, (FunctionMetadata b, ())))
  (Maybe (FunctionInfo b))
-&gt; arr
     (a, (HashMap (FunctionName b) (FunctionMetadata b), ()))
     (HashMap (FunctionName b) (Maybe (FunctionInfo b)))
forall (arr :: * -&gt; * -&gt; *) k e a s b.
(ArrowDistribute arr, Eq k, Hashable k) =&gt;
arr (e, (k, (a, s))) b -&gt; arr (e, (HashMap k a, s)) (HashMap k b)
</span><a href="Hasura.Incremental.Internal.Rule.html#keyed"><span class="hs-identifier hs-var">Inc.keyed</span></a></span><span>
</span><span id="line-538"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">FunctionName b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#FunctionMetadata"><span class="hs-identifier hs-type">FunctionMetadata</span></a></span><span> </span><span id="local-6989586621688410120"><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621688410120"><span class="hs-identifier hs-var">qf</span></a></span></span><span> </span><span id="local-6989586621688410119"><span class="annot"><span class="annottext">FunctionConfig
</span><a href="#local-6989586621688410119"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span id="local-6989586621688410118"><span class="annot"><span class="annottext">[FunctionPermissionInfo]
</span><a href="#local-6989586621688410118"><span class="hs-identifier hs-var">functionPermissions</span></a></span></span><span> </span><span id="local-6989586621688410117"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688410117"><span class="hs-identifier hs-var">comment</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410116"><span class="annot"><span class="annottext">systemDefined :: SystemDefined
</span><a href="#local-6989586621688410116"><span class="hs-identifier hs-var hs-var">systemDefined</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SystemDefined
</span><a href="Hasura.RQL.Types.Common.html#SystemDefined"><span class="hs-identifier hs-var">SystemDefined</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-540"></span><span>                          </span><span id="local-6989586621688410114"><span class="annot"><span class="annottext">definition :: Value
</span><a href="#local-6989586621688410114"><span class="hs-identifier hs-var hs-var">definition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TrackFunction b -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">(TrackFunction b -&gt; Value) -&gt; TrackFunction b -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunctionName b -&gt; TrackFunction b
forall (b :: BackendType). FunctionName b -&gt; TrackFunction b
</span><a href="Hasura.RQL.DDL.Schema.Function.html#TrackFunction"><span class="hs-identifier hs-var">TrackFunction</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621688410120"><span class="hs-identifier hs-var">qf</span></a></span><span>
</span><span id="line-541"></span><span>                          </span><span id="local-6989586621688410112"><span class="annot"><span class="annottext">metadataObject :: MetadataObject
</span><a href="#local-6989586621688410112"><span class="hs-identifier hs-var hs-var">metadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-542"></span><span>                            </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span>
</span><span id="line-543"></span><span>                              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; AnyBackend SourceMetadataObjId -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOSourceObjId"><span class="hs-identifier hs-var">MOSourceObjId</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410172"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">(AnyBackend SourceMetadataObjId -&gt; MetadataObjId)
-&gt; AnyBackend SourceMetadataObjId -&gt; MetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-544"></span><span>                                  </span><span class="annot"><span class="annottext">SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId)
-&gt; SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-545"></span><span>                                    </span><span class="annot"><span class="annottext">FunctionName b -&gt; SourceMetadataObjId b
forall (b :: BackendType). FunctionName b -&gt; SourceMetadataObjId b
</span><a href="Hasura.RQL.Types.Metadata.Object.html#SMOFunction"><span class="hs-identifier hs-var">SMOFunction</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621688410120"><span class="hs-identifier hs-var">qf</span></a></span><span>
</span><span id="line-546"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span>                              </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688410114"><span class="hs-identifier hs-var">definition</span></a></span><span>
</span><span id="line-548"></span><span>                          </span><span id="local-6989586621688410108"><span class="annot"><span class="annottext">schemaObject :: SchemaObjId
</span><a href="#local-6989586621688410108"><span class="hs-identifier hs-var hs-var">schemaObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-549"></span><span>                            </span><span class="annot"><span class="annottext">SourceName -&gt; AnyBackend SourceObjId -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOSourceObj"><span class="hs-identifier hs-var">SOSourceObj</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410172"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">(AnyBackend SourceObjId -&gt; SchemaObjId)
-&gt; AnyBackend SourceObjId -&gt; SchemaObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-550"></span><span>                              </span><span class="annot"><span class="annottext">SourceObjId b -&gt; AnyBackend SourceObjId
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceObjId b -&gt; AnyBackend SourceObjId)
-&gt; SourceObjId b -&gt; AnyBackend SourceObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-551"></span><span>                                </span><span class="annot"><span class="annottext">FunctionName b -&gt; SourceObjId b
forall (b :: BackendType). FunctionName b -&gt; SourceObjId b
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOIFunction"><span class="hs-identifier hs-var">SOIFunction</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621688410120"><span class="hs-identifier hs-var">qf</span></a></span><span>
</span><span id="line-552"></span><span>                          </span><span id="local-6989586621688410105"><span class="annot"><span class="annottext">addFunctionContext :: Text -&gt; Text
</span><a href="#local-6989586621688410105"><span class="hs-identifier hs-var hs-var">addFunctionContext</span></a></span></span><span> </span><span id="local-6989586621688410104"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688410104"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in function &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621688410120"><span class="hs-identifier hs-var">qf</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionName b -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688410104"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-553"></span><span>                      </span><span class="hs-glyph">(|</span><span>
</span><span id="line-554"></span><span>                        </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) (FunctionInfo b)
-&gt; arr (a, (MetadataObject, ())) (Maybe (FunctionInfo b))
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-555"></span><span>                          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-556"></span><span>                              </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) (FunctionInfo b)
-&gt; ErrorA QErr arr (a, (Text -&gt; Text, ())) (FunctionInfo b)
forall (arr :: * -&gt; * -&gt; *) e s a.
ArrowError QErr arr =&gt;
arr (e, s) a -&gt; arr (e, (Text -&gt; Text, s)) a
</span><a href="Hasura.Base.Error.html#modifyErrA"><span class="hs-identifier hs-var">modifyErrA</span></a></span><span>
</span><span id="line-557"></span><span>                                </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-558"></span><span>                                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410101"><span class="annot"><span class="annottext">funcDefs :: [RawFunctionInfo b]
</span><a href="#local-6989586621688410101"><span class="hs-identifier hs-var hs-var">funcDefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RawFunctionInfo b]
-&gt; Maybe [RawFunctionInfo b] -&gt; [RawFunctionInfo b]
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Maybe [RawFunctionInfo b] -&gt; [RawFunctionInfo b])
-&gt; Maybe [RawFunctionInfo b] -&gt; [RawFunctionInfo b]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunctionName b
-&gt; DBFunctionsMetadata b -&gt; Maybe [RawFunctionInfo b]
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621688410120"><span class="hs-identifier hs-var">qf</span></a></span><span> </span><span class="annot"><span class="annottext">DBFunctionsMetadata b
</span><a href="#local-6989586621688410177"><span class="hs-identifier hs-var">dbFunctions</span></a></span><span>
</span><span id="line-559"></span><span>                                    </span><span id="local-6989586621688410098"><span class="annot"><span class="annottext">RawFunctionInfo b
</span><a href="#local-6989586621688410098"><span class="hs-identifier hs-var">rawfunctionInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ErrorA QErr arr (m (RawFunctionInfo b)) (RawFunctionInfo b)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">FunctionName b -&gt; [RawFunctionInfo b] -&gt; m (RawFunctionInfo b)
forall (b :: BackendType) (m :: * -&gt; *) a.
(QErrM m, Backend b) =&gt;
FunctionName b -&gt; [a] -&gt; m a
</span><a href="Hasura.RQL.DDL.Schema.Function.html#handleMultipleFunctions"><span class="hs-identifier hs-var">handleMultipleFunctions</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410859"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621688410120"><span class="hs-identifier hs-var">qf</span></a></span><span> </span><span class="annot"><span class="annottext">[RawFunctionInfo b]
</span><a href="#local-6989586621688410101"><span class="hs-identifier hs-var">funcDefs</span></a></span><span>
</span><span id="line-560"></span><span>                                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410095"><span class="annot"><span class="annottext">metadataPermissions :: HashMap RoleName FunctionPermissionInfo
</span><a href="#local-6989586621688410095"><span class="hs-identifier hs-var hs-var">metadataPermissions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FunctionPermissionInfo -&gt; RoleName)
-&gt; [FunctionPermissionInfo]
-&gt; HashMap RoleName FunctionPermissionInfo
forall k a. (Eq k, Hashable k) =&gt; (a -&gt; k) -&gt; [a] -&gt; HashMap k a
</span><a href="Hasura.Prelude.html#mapFromL"><span class="hs-identifier hs-var">mapFromL</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionPermissionInfo -&gt; RoleName
</span><a href="Hasura.RQL.Types.Function.html#_fpmRole"><span class="hs-identifier hs-var hs-var">_fpmRole</span></a></span><span> </span><span class="annot"><span class="annottext">[FunctionPermissionInfo]
</span><a href="#local-6989586621688410118"><span class="hs-identifier hs-var">functionPermissions</span></a></span><span>
</span><span id="line-561"></span><span>                                        </span><span id="local-6989586621688410093"><span class="annot"><span class="annottext">permissionsMap :: HashMap RoleName FunctionPermissionInfo
</span><a href="#local-6989586621688410093"><span class="hs-identifier hs-var hs-var">permissionsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RoleName -&gt; FunctionPermissionInfo)
-&gt; HashMap RoleName FunctionPermissionInfo
-&gt; OrderedRoles
-&gt; HashMap RoleName FunctionPermissionInfo
forall a.
(RoleName -&gt; a)
-&gt; HashMap RoleName a -&gt; OrderedRoles -&gt; HashMap RoleName a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkBooleanPermissionMap"><span class="hs-identifier hs-var">mkBooleanPermissionMap</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; FunctionPermissionInfo
</span><a href="Hasura.RQL.Types.Function.html#FunctionPermissionInfo"><span class="hs-identifier hs-var">FunctionPermissionInfo</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName FunctionPermissionInfo
</span><a href="#local-6989586621688410095"><span class="hs-identifier hs-var">metadataPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688410174"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span>
</span><span id="line-562"></span><span>                                    </span><span class="hs-special">(</span><span id="local-6989586621688410091"><span class="annot"><span class="annottext">FunctionInfo b
</span><a href="#local-6989586621688410091"><span class="hs-identifier hs-var">functionInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410090"><span class="annot"><span class="annottext">SchemaDependency
</span><a href="#local-6989586621688410090"><span class="hs-identifier hs-var">dep</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (m (FunctionInfo b, SchemaDependency))
  (FunctionInfo b, SchemaDependency)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; FunctionName b
-&gt; SystemDefined
-&gt; FunctionConfig
-&gt; HashMap RoleName FunctionPermissionInfo
-&gt; RawFunctionInfo b
-&gt; Maybe Text
-&gt; m (FunctionInfo b, SchemaDependency)
forall (b :: BackendType) (m :: * -&gt; *).
(BackendMetadata b, MonadError QErr m) =&gt;
SourceName
-&gt; FunctionName b
-&gt; SystemDefined
-&gt; FunctionConfig
-&gt; HashMap RoleName FunctionPermissionInfo
-&gt; RawFunctionInfo b
-&gt; Maybe Text
-&gt; m (FunctionInfo b, SchemaDependency)
</span><a href="Hasura.RQL.Types.Metadata.Backend.html#buildFunctionInfo"><span class="hs-identifier hs-var">buildFunctionInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410172"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621688410120"><span class="hs-identifier hs-var">qf</span></a></span><span> </span><span class="annot"><span class="annottext">SystemDefined
</span><a href="#local-6989586621688410116"><span class="hs-identifier hs-var">systemDefined</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionConfig
</span><a href="#local-6989586621688410119"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName FunctionPermissionInfo
</span><a href="#local-6989586621688410093"><span class="hs-identifier hs-var">permissionsMap</span></a></span><span> </span><span class="annot"><span class="annottext">RawFunctionInfo b
</span><a href="#local-6989586621688410098"><span class="hs-identifier hs-var">rawfunctionInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688410117"><span class="hs-identifier hs-var">comment</span></a></span><span>
</span><span id="line-563"></span><span>                                    </span><span class="annot"><span class="annottext">ErrorA
  QErr arr (MetadataObject, SchemaObjId, [SchemaDependency]) ()
forall (arr :: * -&gt; * -&gt; *).
ArrowWriter (Seq CollectedInfo) arr =&gt;
arr (MetadataObject, SchemaObjId, [SchemaDependency]) ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordDependencies"><span class="hs-identifier hs-var">recordDependencies</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688410112"><span class="hs-identifier hs-var">metadataObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SchemaObjId
</span><a href="#local-6989586621688410108"><span class="hs-identifier hs-var">schemaObject</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SchemaDependency
</span><a href="#local-6989586621688410090"><span class="hs-identifier hs-var">dep</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span>                                    </span><span class="annot"><span class="annottext">ErrorA QErr arr (FunctionInfo b) (FunctionInfo b)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">FunctionInfo b
</span><a href="#local-6989586621688410091"><span class="hs-identifier hs-var">functionInfo</span></a></span><span>
</span><span id="line-565"></span><span>                                </span><span class="hs-special">)</span><span>
</span><span id="line-566"></span><span>                            </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621688410105"><span class="hs-identifier hs-var">addFunctionContext</span></a></span><span>
</span><span id="line-567"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>                        </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688410112"><span class="hs-identifier hs-var">metadataObject</span></a></span><span>
</span><span id="line-569"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>              </span><span class="hs-glyph">|)</span><span>
</span><span id="line-571"></span><span>          </span><span class="annot"><span class="annottext">forall a.
arr (a, ()) (HashMap (FunctionName b) (Maybe (FunctionInfo b)))
-&gt; arr
     (a, (HashMap (FunctionName b) (Maybe (FunctionInfo b)), ()))
     (HashMap (FunctionName b) (FunctionInfo b))
-&gt; arr (a, ()) (HashMap (FunctionName b) (FunctionInfo b))
forall (arr :: * -&gt; * -&gt; *) e s a b.
Arrow arr =&gt;
arr (e, s) a -&gt; arr (e, (a, s)) b -&gt; arr (e, s) b
</span><a href="Control.Arrow.Extended.html#%3E-%3E"><span class="hs-operator hs-var">&gt;-&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688410087"><span class="annot"><span class="annottext">HashMap (FunctionName b) (Maybe (FunctionInfo b))
</span><a href="#local-6989586621688410087"><span class="hs-identifier hs-var">infos</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashMap (FunctionName b) (Maybe (FunctionInfo b))
-&gt; HashMap (FunctionName b) (FunctionInfo b)
forall k v. HashMap k (Maybe v) -&gt; HashMap k v
</span><a href="Data.HashMap.Strict.Extended.html#catMaybes"><span class="hs-identifier hs-var">M.catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap (FunctionName b) (Maybe (FunctionInfo b))
</span><a href="#local-6989586621688410087"><span class="hs-identifier hs-var">infos</span></a></span><span> </span><span class="hs-glyph">&gt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (HashMap (FunctionName b) (FunctionInfo b))
  (HashMap (FunctionName b) (FunctionInfo b))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span class="hs-special">)</span><span>
</span><span id="line-572"></span><span>
</span><span id="line-573"></span><span>      </span><span class="annot"><span class="annottext">arr BackendSourceInfo BackendSourceInfo
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">SourceInfo b -&gt; BackendSourceInfo
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceInfo b -&gt; BackendSourceInfo)
-&gt; SourceInfo b -&gt; BackendSourceInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; HashMap (TableName b) (TableInfo b)
-&gt; HashMap (FunctionName b) (FunctionInfo b)
-&gt; SourceConfig b
-&gt; Maybe QueryTagsConfig
-&gt; SourceCustomization
-&gt; SourceInfo b
forall (b :: BackendType).
SourceName
-&gt; TableCache b
-&gt; FunctionCache b
-&gt; SourceConfig b
-&gt; Maybe QueryTagsConfig
-&gt; SourceCustomization
-&gt; SourceInfo b
</span><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-var">SourceInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410172"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap (TableName b) (TableInfo b)
</span><a href="#local-6989586621688410137"><span class="hs-identifier hs-var">tableCache</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap (FunctionName b) (FunctionInfo b)
</span><a href="#local-6989586621688410124"><span class="hs-identifier hs-var">functionCache</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688410180"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe QueryTagsConfig
</span><a href="#local-6989586621688410169"><span class="hs-identifier hs-var">queryTagsConfig</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCustomization
</span><a href="#local-6989586621688410168"><span class="hs-identifier hs-var">sourceCustomization</span></a></span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span>    </span><span class="annot"><a href="#local-6989586621688410360"><span class="hs-identifier hs-type">buildAndCollectInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-576"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688411291"><span class="annot"><a href="#local-6989586621688411291"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688411290"><span class="annot"><a href="#local-6989586621688411290"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-577"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688411291"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-578"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411291"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-579"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411291"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-580"></span><span>        </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688411291"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-581"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688411290"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-582"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411290"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-583"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#BuildReason"><span class="hs-identifier hs-type">BuildReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411290"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-584"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688411290"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-585"></span><span>        </span><span class="annot"><a href="Network.HTTP.Client.Manager.html#HasHttpManagerM"><span class="hs-identifier hs-type">HasHttpManagerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411290"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.html#HasServerConfigCtx"><span class="hs-identifier hs-type">HasServerConfigCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411290"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-587"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688411290"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-588"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-589"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#Metadata"><span class="hs-identifier hs-type">Metadata</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Dependency"><span class="hs-identifier hs-type">Inc.Dependency</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#InvalidationKeys"><span class="hs-identifier hs-type">InvalidationKeys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688411291"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#BuildOutputs"><span class="hs-identifier hs-type">BuildOutputs</span></a></span><span>
</span><span id="line-590"></span><span>    </span><span id="local-6989586621688410360"><span class="annot"><span class="annottext">buildAndCollectInfo :: arr (Metadata, Dependency InvalidationKeys) BuildOutputs
</span><a href="#local-6989586621688410360"><span class="hs-identifier hs-var hs-var">buildAndCollectInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410084"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688410084"><span class="hs-identifier hs-var">metadata</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410083"><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410083"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-591"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#Metadata"><span class="hs-identifier hs-type">Metadata</span></a></span><span>
</span><span id="line-592"></span><span>            </span><span id="local-6989586621688410081"><span class="annot"><span class="annottext">Sources
</span><a href="#local-6989586621688410081"><span class="hs-identifier hs-var">sources</span></a></span></span><span>
</span><span id="line-593"></span><span>            </span><span id="local-6989586621688410080"><span class="annot"><span class="annottext">RemoteSchemas
</span><a href="#local-6989586621688410080"><span class="hs-identifier hs-var">remoteSchemas</span></a></span></span><span>
</span><span id="line-594"></span><span>            </span><span id="local-6989586621688410079"><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688410079"><span class="hs-identifier hs-var">collections</span></a></span></span><span>
</span><span id="line-595"></span><span>            </span><span id="local-6989586621688410078"><span class="annot"><span class="annottext">MetadataAllowlist
</span><a href="#local-6989586621688410078"><span class="hs-identifier hs-var">metadataAllowlist</span></a></span></span><span>
</span><span id="line-596"></span><span>            </span><span id="local-6989586621688410077"><span class="annot"><span class="annottext">CustomTypes
</span><a href="#local-6989586621688410077"><span class="hs-identifier hs-var">customTypes</span></a></span></span><span>
</span><span id="line-597"></span><span>            </span><span id="local-6989586621688410076"><span class="annot"><span class="annottext">Actions
</span><a href="#local-6989586621688410076"><span class="hs-identifier hs-var">actions</span></a></span></span><span>
</span><span id="line-598"></span><span>            </span><span id="local-6989586621688410075"><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621688410075"><span class="hs-identifier hs-var">cronTriggers</span></a></span></span><span>
</span><span id="line-599"></span><span>            </span><span id="local-6989586621688410074"><span class="annot"><span class="annottext">InsOrdHashMap EndpointName CreateEndpoint
</span><a href="#local-6989586621688410074"><span class="hs-identifier hs-var">endpoints</span></a></span></span><span>
</span><span id="line-600"></span><span>            </span><span id="local-6989586621688410073"><span class="annot"><span class="annottext">ApiLimit
</span><a href="#local-6989586621688410073"><span class="hs-identifier hs-var">apiLimits</span></a></span></span><span>
</span><span id="line-601"></span><span>            </span><span id="local-6989586621688410072"><span class="annot"><span class="annottext">MetricsConfig
</span><a href="#local-6989586621688410072"><span class="hs-identifier hs-var">metricsConfig</span></a></span></span><span>
</span><span id="line-602"></span><span>            </span><span id="local-6989586621688410071"><span class="annot"><span class="annottext">InheritedRoles
</span><a href="#local-6989586621688410071"><span class="hs-identifier hs-var">inheritedRoles</span></a></span></span><span>
</span><span id="line-603"></span><span>            </span><span id="local-6989586621688410070"><span class="annot"><span class="annottext">SetGraphqlIntrospectionOptions
</span><a href="#local-6989586621688410070"><span class="hs-identifier hs-var">_introspectionDisabledRoles</span></a></span></span><span>
</span><span id="line-604"></span><span>            </span><span id="local-6989586621688410069"><span class="annot"><span class="annottext">Network
</span><a href="#local-6989586621688410069"><span class="hs-identifier hs-var">networkConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688410084"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-605"></span><span>          </span><span id="local-6989586621688410068"><span class="annot"><span class="annottext">actionRoles :: [RoleName]
</span><a href="#local-6989586621688410068"><span class="hs-identifier hs-var hs-var">actionRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ActionPermissionMetadata -&gt; RoleName)
-&gt; [ActionPermissionMetadata] -&gt; [RoleName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ActionPermissionMetadata -&gt; RoleName
</span><a href="Hasura.RQL.Types.Action.html#_apmRole"><span class="hs-identifier hs-var hs-var">_apmRole</span></a></span><span> </span><span class="annot"><span class="annottext">([ActionPermissionMetadata] -&gt; [RoleName])
-&gt; (ActionMetadata -&gt; [ActionPermissionMetadata])
-&gt; ActionMetadata
-&gt; [RoleName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ActionMetadata -&gt; [ActionPermissionMetadata]
</span><a href="Hasura.RQL.Types.Action.html#_amPermissions"><span class="hs-identifier hs-var hs-var">_amPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">(ActionMetadata -&gt; [RoleName]) -&gt; [ActionMetadata] -&gt; [RoleName]
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Actions -&gt; [ActionMetadata]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">Actions
</span><a href="#local-6989586621688410076"><span class="hs-identifier hs-var">actions</span></a></span><span>
</span><span id="line-606"></span><span>          </span><span id="local-6989586621688410065"><span class="annot"><span class="annottext">remoteSchemaRoles :: [RoleName]
</span><a href="#local-6989586621688410065"><span class="hs-identifier hs-var hs-var">remoteSchemaRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaPermissionMetadata -&gt; RoleName)
-&gt; [RemoteSchemaPermissionMetadata] -&gt; [RoleName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionMetadata -&gt; RoleName
</span><a href="Hasura.RQL.Types.Metadata.html#_rspmRole"><span class="hs-identifier hs-var hs-var">_rspmRole</span></a></span><span> </span><span class="annot"><span class="annottext">([RemoteSchemaPermissionMetadata] -&gt; [RoleName])
-&gt; (RemoteSchemaMetadata -&gt; [RemoteSchemaPermissionMetadata])
-&gt; RemoteSchemaMetadata
-&gt; [RoleName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadata -&gt; [RemoteSchemaPermissionMetadata]
</span><a href="Hasura.RQL.Types.Metadata.html#_rsmPermissions"><span class="hs-identifier hs-var hs-var">_rsmPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaMetadata -&gt; [RoleName])
-&gt; [RemoteSchemaMetadata] -&gt; [RoleName]
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemas -&gt; [RemoteSchemaMetadata]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemas
</span><a href="#local-6989586621688410080"><span class="hs-identifier hs-var">remoteSchemas</span></a></span><span>
</span><span id="line-607"></span><span>          </span><span id="local-6989586621688410062"><span class="annot"><span class="annottext">sourceRoles :: HashSet RoleName
</span><a href="#local-6989586621688410062"><span class="hs-identifier hs-var hs-var">sourceRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-608"></span><span>            </span><span class="annot"><span class="annottext">[RoleName] -&gt; HashSet RoleName
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.fromList</span></span><span> </span><span class="annot"><span class="annottext">([RoleName] -&gt; HashSet RoleName) -&gt; [RoleName] -&gt; HashSet RoleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-609"></span><span>              </span><span class="annot"><span class="annottext">[[RoleName]] -&gt; [RoleName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[RoleName]] -&gt; [RoleName]) -&gt; [[RoleName]] -&gt; [RoleName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-610"></span><span>                </span><span class="annot"><span class="annottext">Sources -&gt; [BackendSourceMetadata]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">Sources
</span><a href="#local-6989586621688410081"><span class="hs-identifier hs-var">sources</span></a></span><span> </span><span class="annot"><span class="annottext">[BackendSourceMetadata]
-&gt; (BackendSourceMetadata -&gt; [[RoleName]]) -&gt; [[RoleName]]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688410059"><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621688410059"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-611"></span><span>                  </span><span class="annot"><span class="annottext">BackendSourceMetadata
-&gt; (forall (b :: BackendType).
    Backend b =&gt;
    SourceMetadata b -&gt; [[RoleName]])
-&gt; [[RoleName]]
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621688410059"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688410057"><span class="annot"><span class="annottext">Tables b
</span><a href="#local-6989586621688410057"><span class="hs-identifier hs-var">tables</span></a></span></span><span> </span><span id="local-6989586621688410056"><span class="annot"><span class="annottext">Functions b
</span><a href="#local-6989586621688410056"><span class="hs-identifier hs-var">_functions</span></a></span></span><span> </span><span class="annot"><span class="annottext">SourceConnConfiguration b
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe QueryTagsConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SourceCustomization
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-612"></span><span>                    </span><span id="local-6989586621688410055"><span class="annot"><span class="annottext">TableMetadata b
</span><a href="#local-6989586621688410055"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Tables b -&gt; [TableMetadata b]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">Tables b
</span><a href="#local-6989586621688410057"><span class="hs-identifier hs-var">tables</span></a></span><span>
</span><span id="line-613"></span><span>                    </span><span class="annot"><span class="annottext">[RoleName] -&gt; [[RoleName]]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([RoleName] -&gt; [[RoleName]]) -&gt; [RoleName] -&gt; [[RoleName]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-614"></span><span>                      </span><span class="annot"><span class="annottext">InsOrdHashMap RoleName (InsPermDef b) -&gt; [RoleName]
forall k v. InsOrdHashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">OMap.keys</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableMetadata b -&gt; InsOrdHashMap RoleName (InsPermDef b)
forall (b :: BackendType).
TableMetadata b -&gt; Permissions (InsPermDef b)
</span><a href="Hasura.RQL.Types.Metadata.html#_tmInsertPermissions"><span class="hs-identifier hs-var hs-var">_tmInsertPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">TableMetadata b
</span><a href="#local-6989586621688410055"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>                        </span><span class="annot"><span class="annottext">[RoleName] -&gt; [RoleName] -&gt; [RoleName]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap RoleName (SelPermDef b) -&gt; [RoleName]
forall k v. InsOrdHashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">OMap.keys</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableMetadata b -&gt; InsOrdHashMap RoleName (SelPermDef b)
forall (b :: BackendType).
TableMetadata b -&gt; Permissions (SelPermDef b)
</span><a href="Hasura.RQL.Types.Metadata.html#_tmSelectPermissions"><span class="hs-identifier hs-var hs-var">_tmSelectPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">TableMetadata b
</span><a href="#local-6989586621688410055"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-616"></span><span>                        </span><span class="annot"><span class="annottext">[RoleName] -&gt; [RoleName] -&gt; [RoleName]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap RoleName (UpdPermDef b) -&gt; [RoleName]
forall k v. InsOrdHashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">OMap.keys</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableMetadata b -&gt; InsOrdHashMap RoleName (UpdPermDef b)
forall (b :: BackendType).
TableMetadata b -&gt; Permissions (UpdPermDef b)
</span><a href="Hasura.RQL.Types.Metadata.html#_tmUpdatePermissions"><span class="hs-identifier hs-var hs-var">_tmUpdatePermissions</span></a></span><span> </span><span class="annot"><span class="annottext">TableMetadata b
</span><a href="#local-6989586621688410055"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>                        </span><span class="annot"><span class="annottext">[RoleName] -&gt; [RoleName] -&gt; [RoleName]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap RoleName (DelPermDef b) -&gt; [RoleName]
forall k v. InsOrdHashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">OMap.keys</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableMetadata b -&gt; InsOrdHashMap RoleName (DelPermDef b)
forall (b :: BackendType).
TableMetadata b -&gt; Permissions (DelPermDef b)
</span><a href="Hasura.RQL.Types.Metadata.html#_tmDeletePermissions"><span class="hs-identifier hs-var hs-var">_tmDeletePermissions</span></a></span><span> </span><span class="annot"><span class="annottext">TableMetadata b
</span><a href="#local-6989586621688410055"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-618"></span><span>          </span><span id="local-6989586621688410049"><span class="annot"><span class="annottext">inheritedRoleNames :: [RoleName]
</span><a href="#local-6989586621688410049"><span class="hs-identifier hs-var hs-var">inheritedRoleNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InheritedRoles -&gt; [RoleName]
forall k v. InsOrdHashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">OMap.keys</span></span><span> </span><span class="annot"><span class="annottext">InheritedRoles
</span><a href="#local-6989586621688410071"><span class="hs-identifier hs-var">inheritedRoles</span></a></span><span>
</span><span id="line-619"></span><span>          </span><span id="local-6989586621688410048"><span class="annot"><span class="annottext">allRoleNames :: HashSet RoleName
</span><a href="#local-6989586621688410048"><span class="hs-identifier hs-var hs-var">allRoleNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688410062"><span class="hs-identifier hs-var">sourceRoles</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName -&gt; HashSet RoleName -&gt; HashSet RoleName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[RoleName] -&gt; HashSet RoleName
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[RoleName]
</span><a href="#local-6989586621688410065"><span class="hs-identifier hs-var">remoteSchemaRoles</span></a></span><span> </span><span class="annot"><span class="annottext">[RoleName] -&gt; [RoleName] -&gt; [RoleName]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[RoleName]
</span><a href="#local-6989586621688410068"><span class="hs-identifier hs-var">actionRoles</span></a></span><span> </span><span class="annot"><span class="annottext">[RoleName] -&gt; [RoleName] -&gt; [RoleName]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[RoleName]
</span><a href="#local-6989586621688410049"><span class="hs-identifier hs-var">inheritedRoleNames</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span>
</span><span id="line-621"></span><span>          </span><span id="local-6989586621688410047"><span class="annot"><span class="annottext">remoteSchemaPermissions :: [AddRemoteSchemaPermission]
</span><a href="#local-6989586621688410047"><span class="hs-identifier hs-var hs-var">remoteSchemaPermissions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-622"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410046"><span class="annot"><span class="annottext">remoteSchemaPermsList :: [(RemoteSchemaName, [RemoteSchemaPermissionMetadata])]
</span><a href="#local-6989586621688410046"><span class="hs-identifier hs-var hs-var">remoteSchemaPermsList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap RemoteSchemaName [RemoteSchemaPermissionMetadata]
-&gt; [(RemoteSchemaName, [RemoteSchemaPermissionMetadata])]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap RemoteSchemaName [RemoteSchemaPermissionMetadata]
 -&gt; [(RemoteSchemaName, [RemoteSchemaPermissionMetadata])])
-&gt; InsOrdHashMap RemoteSchemaName [RemoteSchemaPermissionMetadata]
-&gt; [(RemoteSchemaName, [RemoteSchemaPermissionMetadata])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadata -&gt; [RemoteSchemaPermissionMetadata]
</span><a href="Hasura.RQL.Types.Metadata.html#_rsmPermissions"><span class="hs-identifier hs-var hs-var">_rsmPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaMetadata -&gt; [RemoteSchemaPermissionMetadata])
-&gt; RemoteSchemas
-&gt; InsOrdHashMap RemoteSchemaName [RemoteSchemaPermissionMetadata]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemas
</span><a href="#local-6989586621688410080"><span class="hs-identifier hs-var">remoteSchemas</span></a></span><span>
</span><span id="line-623"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[[AddRemoteSchemaPermission]] -&gt; [AddRemoteSchemaPermission]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[AddRemoteSchemaPermission]] -&gt; [AddRemoteSchemaPermission])
-&gt; [[AddRemoteSchemaPermission]] -&gt; [AddRemoteSchemaPermission]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-624"></span><span>                  </span><span class="annot"><span class="annottext">(((RemoteSchemaName, [RemoteSchemaPermissionMetadata])
  -&gt; [AddRemoteSchemaPermission])
 -&gt; [(RemoteSchemaName, [RemoteSchemaPermissionMetadata])]
 -&gt; [[AddRemoteSchemaPermission]])
-&gt; [(RemoteSchemaName, [RemoteSchemaPermissionMetadata])]
-&gt; ((RemoteSchemaName, [RemoteSchemaPermissionMetadata])
    -&gt; [AddRemoteSchemaPermission])
-&gt; [[AddRemoteSchemaPermission]]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">((RemoteSchemaName, [RemoteSchemaPermissionMetadata])
 -&gt; [AddRemoteSchemaPermission])
-&gt; [(RemoteSchemaName, [RemoteSchemaPermissionMetadata])]
-&gt; [[AddRemoteSchemaPermission]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">[(RemoteSchemaName, [RemoteSchemaPermissionMetadata])]
</span><a href="#local-6989586621688410046"><span class="hs-identifier hs-var">remoteSchemaPermsList</span></a></span><span> </span><span class="annot"><span class="annottext">(((RemoteSchemaName, [RemoteSchemaPermissionMetadata])
  -&gt; [AddRemoteSchemaPermission])
 -&gt; [[AddRemoteSchemaPermission]])
-&gt; ((RemoteSchemaName, [RemoteSchemaPermissionMetadata])
    -&gt; [AddRemoteSchemaPermission])
-&gt; [[AddRemoteSchemaPermission]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-625"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688410044"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688410044"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410043"><span class="annot"><span class="annottext">[RemoteSchemaPermissionMetadata]
</span><a href="#local-6989586621688410043"><span class="hs-identifier hs-var">remoteSchemaPerms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-626"></span><span>                        </span><span class="annot"><span class="annottext">((RemoteSchemaPermissionMetadata -&gt; AddRemoteSchemaPermission)
 -&gt; [RemoteSchemaPermissionMetadata] -&gt; [AddRemoteSchemaPermission])
-&gt; [RemoteSchemaPermissionMetadata]
-&gt; (RemoteSchemaPermissionMetadata -&gt; AddRemoteSchemaPermission)
-&gt; [AddRemoteSchemaPermission]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaPermissionMetadata -&gt; AddRemoteSchemaPermission)
-&gt; [RemoteSchemaPermissionMetadata] -&gt; [AddRemoteSchemaPermission]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">[RemoteSchemaPermissionMetadata]
</span><a href="#local-6989586621688410043"><span class="hs-identifier hs-var">remoteSchemaPerms</span></a></span><span> </span><span class="annot"><span class="annottext">((RemoteSchemaPermissionMetadata -&gt; AddRemoteSchemaPermission)
 -&gt; [AddRemoteSchemaPermission])
-&gt; (RemoteSchemaPermissionMetadata -&gt; AddRemoteSchemaPermission)
-&gt; [AddRemoteSchemaPermission]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#RemoteSchemaPermissionMetadata"><span class="hs-identifier hs-type">RemoteSchemaPermissionMetadata</span></a></span><span> </span><span id="local-6989586621688410041"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688410041"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621688410040"><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621688410040"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span id="local-6989586621688410039"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688410039"><span class="hs-identifier hs-var">comment</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-627"></span><span>                          </span><span class="annot"><span class="annottext">RemoteSchemaName
-&gt; RoleName
-&gt; RemoteSchemaPermissionDefinition
-&gt; Maybe Text
-&gt; AddRemoteSchemaPermission
</span><a href="Hasura.RQL.Types.RemoteSchema.html#AddRemoteSchemaPermission"><span class="hs-identifier hs-var">AddRemoteSchemaPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688410044"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688410041"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621688410040"><span class="hs-identifier hs-var">defn</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688410039"><span class="hs-identifier hs-var">comment</span></a></span><span>
</span><span id="line-628"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span>      </span><span class="hs-comment">-- roles which have some kind of permission (action/remote schema/table/function) set in the metadata</span><span>
</span><span id="line-631"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410037"><span class="annot"><span class="annottext">metadataRoles :: HashMap RoleName Role
</span><a href="#local-6989586621688410037"><span class="hs-identifier hs-var hs-var">metadataRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Role -&gt; RoleName) -&gt; [Role] -&gt; HashMap RoleName Role
forall k a. (Eq k, Hashable k) =&gt; (a -&gt; k) -&gt; [a] -&gt; HashMap k a
</span><a href="Hasura.Prelude.html#mapFromL"><span class="hs-identifier hs-var">mapFromL</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_rRoleName"><span class="hs-identifier hs-var hs-var">_rRoleName</span></a></span><span> </span><span class="annot"><span class="annottext">([Role] -&gt; HashMap RoleName Role)
-&gt; [Role] -&gt; HashMap RoleName Role
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; ParentRoles -&gt; Role
</span><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-operator hs-var">`Role`</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName -&gt; ParentRoles
</span><a href="Hasura.RQL.Types.Roles.html#ParentRoles"><span class="hs-identifier hs-var">ParentRoles</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RoleName -&gt; Role) -&gt; [RoleName] -&gt; [Role]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688410048"><span class="hs-identifier hs-var">allRoleNames</span></a></span><span>
</span><span id="line-632"></span><span>
</span><span id="line-633"></span><span>      </span><span id="local-6989586621688410033"><span class="annot"><span class="annottext">HashMap RoleName Role
</span><a href="#local-6989586621688410033"><span class="hs-identifier hs-var">resolvedInheritedRoles</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr (HashSet RoleName, [Role]) (HashMap RoleName Role)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, ArrowCache m arr,
 MonadError QErr m) =&gt;
arr (HashSet RoleName, [Role]) (HashMap RoleName Role)
</span><a href="#local-6989586621688410032"><span class="hs-identifier hs-var">buildInheritedRoles</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688410048"><span class="hs-identifier hs-var">allRoleNames</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InheritedRoles -&gt; [Role]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">InheritedRoles
</span><a href="#local-6989586621688410071"><span class="hs-identifier hs-var">inheritedRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-634"></span><span>
</span><span id="line-635"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410031"><span class="annot"><span class="annottext">allRoles :: HashMap RoleName Role
</span><a href="#local-6989586621688410031"><span class="hs-identifier hs-var hs-var">allRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName Role
</span><a href="#local-6989586621688410033"><span class="hs-identifier hs-var">resolvedInheritedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName Role
-&gt; HashMap RoleName Role -&gt; HashMap RoleName Role
forall k v.
(Eq k, Hashable k) =&gt;
HashMap k v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-operator hs-var">`M.union`</span></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName Role
</span><a href="#local-6989586621688410037"><span class="hs-identifier hs-var">metadataRoles</span></a></span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span>      </span><span id="local-6989586621688410029"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688410029"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr (m OrderedRoles) OrderedRoles
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">[Role] -&gt; m OrderedRoles
forall (m :: * -&gt; *). MonadError QErr m =&gt; [Role] -&gt; m OrderedRoles
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#orderRoles"><span class="hs-identifier hs-var">orderRoles</span></a></span><span> </span><span class="annot"><span class="annottext">([Role] -&gt; m OrderedRoles) -&gt; [Role] -&gt; m OrderedRoles
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName Role -&gt; [Role]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName Role
</span><a href="#local-6989586621688410031"><span class="hs-identifier hs-var">allRoles</span></a></span><span>
</span><span id="line-638"></span><span>
</span><span id="line-639"></span><span>      </span><span class="hs-comment">-- remote schemas</span><span>
</span><span id="line-640"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410027"><span class="annot"><span class="annottext">remoteSchemaInvalidationKeys :: Dependency (HashMap RemoteSchemaName InvalidationKey)
</span><a href="#local-6989586621688410027"><span class="hs-identifier hs-var hs-var">remoteSchemaInvalidationKeys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Selector
  InvalidationKeys (HashMap RemoteSchemaName InvalidationKey)
-&gt; Dependency InvalidationKeys
-&gt; Dependency (HashMap RemoteSchemaName InvalidationKey)
forall a b.
Select a =&gt;
Selector a b -&gt; Dependency a -&gt; Dependency b
</span><a href="Hasura.Incremental.Internal.Dependency.html#selectD"><span class="hs-identifier hs-var">Inc.selectD</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;_ikRemoteSchemas&quot;
  (FieldS
     InvalidationKeys (HashMap RemoteSchemaName InvalidationKey))
Selector
  InvalidationKeys (HashMap RemoteSchemaName InvalidationKey)
</span><a href="#local-6989586621688410026"><span class="hs-var">#_ikRemoteSchemas</span></a></span><span> </span><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410083"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span>
</span><span id="line-641"></span><span>      </span><span id="local-6989586621688410025"><span class="annot"><span class="annottext">HashMap
  RemoteSchemaName
  ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject)
</span><a href="#local-6989586621688410025"><span class="hs-identifier hs-var">remoteSchemaMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (Dependency (HashMap RemoteSchemaName InvalidationKey),
   [RemoteSchemaMetadata])
  (HashMap
     RemoteSchemaName
     ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject))
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, ArrowCache m arr, MonadIO m,
 HasHttpManagerM m) =&gt;
arr
  (Dependency (HashMap RemoteSchemaName InvalidationKey),
   [RemoteSchemaMetadata])
  (HashMap
     RemoteSchemaName
     ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject))
</span><a href="#local-6989586621688410024"><span class="hs-identifier hs-var">buildRemoteSchemas</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dependency (HashMap RemoteSchemaName InvalidationKey)
</span><a href="#local-6989586621688410027"><span class="hs-identifier hs-var">remoteSchemaInvalidationKeys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteSchemas -&gt; [RemoteSchemaMetadata]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemas
</span><a href="#local-6989586621688410080"><span class="hs-identifier hs-var">remoteSchemas</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410023"><span class="annot"><span class="annottext">remoteSchemaCtxMap :: RemoteSchemaMap
</span><a href="#local-6989586621688410023"><span class="hs-identifier hs-var hs-var">remoteSchemaCtxMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject)
 -&gt; RemoteSchemaCtx)
-&gt; HashMap
     RemoteSchemaName
     ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject)
-&gt; RemoteSchemaMap
forall v1 v2 k. (v1 -&gt; v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RemoteSchemaCtx, SchemaRemoteRelationships) -&gt; RemoteSchemaCtx
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((RemoteSchemaCtx, SchemaRemoteRelationships) -&gt; RemoteSchemaCtx)
-&gt; (((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject)
    -&gt; (RemoteSchemaCtx, SchemaRemoteRelationships))
-&gt; ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject)
-&gt; RemoteSchemaCtx
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject)
-&gt; (RemoteSchemaCtx, SchemaRemoteRelationships)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap
  RemoteSchemaName
  ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject)
</span><a href="#local-6989586621688410025"><span class="hs-identifier hs-var">remoteSchemaMap</span></a></span><span>
</span><span id="line-643"></span><span>
</span><span id="line-644"></span><span>      </span><span class="hs-comment">-- sources are build in two steps</span><span>
</span><span id="line-645"></span><span>      </span><span class="hs-comment">-- first we resolve them, and build the table cache</span><span>
</span><span id="line-646"></span><span>      </span><span id="local-6989586621688410021"><span class="annot"><span class="annottext">HashMap SourceName (AnyBackend PartiallyResolvedSource)
</span><a href="#local-6989586621688410021"><span class="hs-identifier hs-var">partiallyResolvedSources</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-647"></span><span>        </span><span class="hs-glyph">(|</span><span>
</span><span id="line-648"></span><span>          </span><span class="annot"><span class="annottext">forall a.
arr
  (a, (SourceName, (BackendSourceMetadata, ())))
  (Maybe (AnyBackend PartiallyResolvedSource))
-&gt; arr
     (a, (HashMap SourceName BackendSourceMetadata, ()))
     (HashMap SourceName (Maybe (AnyBackend PartiallyResolvedSource)))
forall (arr :: * -&gt; * -&gt; *) k e a s b.
(ArrowDistribute arr, Eq k, Hashable k) =&gt;
arr (e, (k, (a, s))) b -&gt; arr (e, (HashMap k a, s)) (HashMap k b)
</span><a href="Hasura.Incremental.Internal.Rule.html#keyed"><span class="hs-identifier hs-var">Inc.keyed</span></a></span><span>
</span><span id="line-649"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">SourceName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688410020"><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621688410020"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-650"></span><span>                </span><span class="annot"><span class="annottext">(forall (b :: BackendType).
 (BackendMetadata b, BackendMetadata b) =&gt;
 arr
   (SourceMetadata b, Dependency InvalidationKeys)
   (Maybe (AnyBackend PartiallyResolvedSource)))
-&gt; arr
     (BackendSourceMetadata, Dependency InvalidationKeys)
     (Maybe (AnyBackend PartiallyResolvedSource))
forall (c1 :: BackendType -&gt; Constraint)
       (c2 :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r
       (arr :: * -&gt; * -&gt; *) x.
(ArrowChoice arr, AllBackendsSatisfy c1, AllBackendsSatisfy c2) =&gt;
(forall (b :: BackendType). (c1 b, c2 b) =&gt; arr (i b, x) r)
-&gt; arr (AnyBackend i, x) r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackendArrow"><span class="hs-identifier hs-var">AB.dispatchAnyBackendArrow</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span>
</span><span id="line-651"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410018"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410018"><span class="hs-identifier hs-var">sourceMetadata</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688410017"><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410017"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-652"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410016"><span class="annot"><span class="annottext">sourceName :: SourceName
</span><a href="#local-6989586621688410016"><span class="hs-identifier hs-var hs-var">sourceName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; SourceName
forall (b :: BackendType). SourceMetadata b -&gt; SourceName
</span><a href="Hasura.RQL.Types.Metadata.html#_smName"><span class="hs-identifier hs-var hs-var">_smName</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410018"><span class="hs-identifier hs-var">sourceMetadata</span></a></span><span>
</span><span id="line-653"></span><span>                          </span><span id="local-6989586621688410015"><span class="annot"><span class="annottext">sourceInvalidationsKeys :: Dependency (HashMap SourceName InvalidationKey)
</span><a href="#local-6989586621688410015"><span class="hs-identifier hs-var hs-var">sourceInvalidationsKeys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Selector InvalidationKeys (HashMap SourceName InvalidationKey)
-&gt; Dependency InvalidationKeys
-&gt; Dependency (HashMap SourceName InvalidationKey)
forall a b.
Select a =&gt;
Selector a b -&gt; Dependency a -&gt; Dependency b
</span><a href="Hasura.Incremental.Internal.Dependency.html#selectD"><span class="hs-identifier hs-var">Inc.selectD</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;_ikSources&quot;
  (FieldS InvalidationKeys (HashMap SourceName InvalidationKey))
Selector InvalidationKeys (HashMap SourceName InvalidationKey)
</span><a href="#local-6989586621688410014"><span class="hs-var">#_ikSources</span></a></span><span> </span><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410017"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span>
</span><span id="line-654"></span><span>                      </span><span id="local-6989586621688410013"><span class="annot"><span class="annottext">Maybe (ResolvedSource b)
</span><a href="#local-6989586621688410013"><span class="hs-identifier hs-var">maybeResolvedSource</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (Dependency (HashMap SourceName InvalidationKey), SourceMetadata b)
  (Maybe (ResolvedSource b))
forall (b :: BackendType) (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr, MonadIO m,
 MonadBaseControl IO m, MonadResolveSource m, BackendMetadata b) =&gt;
arr
  (Dependency (HashMap SourceName InvalidationKey), SourceMetadata b)
  (Maybe (ResolvedSource b))
</span><a href="#local-6989586621688410237"><span class="hs-identifier hs-var">resolveSourceIfNeeded</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dependency (HashMap SourceName InvalidationKey)
</span><a href="#local-6989586621688410015"><span class="hs-identifier hs-var">sourceInvalidationsKeys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410018"><span class="hs-identifier hs-var">sourceMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>                      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (ResolvedSource b)
</span><a href="#local-6989586621688410013"><span class="hs-identifier hs-var">maybeResolvedSource</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-656"></span><span>                        </span><span class="annot"><span class="annottext">Maybe (ResolvedSource b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">arr
  (Maybe (AnyBackend PartiallyResolvedSource))
  (Maybe (AnyBackend PartiallyResolvedSource))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Maybe (AnyBackend PartiallyResolvedSource)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-657"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688410012"><span id="local-6989586621688410011"><span class="annot"><span class="annottext">ResolvedSource b
</span><a href="#local-6989586621688410011"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#ResolvedSource"><span class="hs-identifier hs-type">ResolvedSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410012"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-658"></span><span>                          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688410010"><span class="annot"><span class="annottext">metadataInvalidationKey :: Dependency InvalidationKey
</span><a href="#local-6989586621688410010"><span class="hs-identifier hs-var hs-var">metadataInvalidationKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Selector InvalidationKeys InvalidationKey
-&gt; Dependency InvalidationKeys -&gt; Dependency InvalidationKey
forall a b.
Select a =&gt;
Selector a b -&gt; Dependency a -&gt; Dependency b
</span><a href="Hasura.Incremental.Internal.Dependency.html#selectD"><span class="hs-identifier hs-var">Inc.selectD</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;_ikMetadata&quot; (FieldS InvalidationKeys InvalidationKey)
Selector InvalidationKeys InvalidationKey
</span><a href="#local-6989586621688410009"><span class="hs-var">#_ikMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410017"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span>
</span><span id="line-659"></span><span>                              </span><span class="hs-special">(</span><span id="local-6989586621688410008"><span class="annot"><span class="annottext">[TableBuildInput b]
</span><a href="#local-6989586621688410008"><span class="hs-identifier hs-var">tableInputs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[NonColumnTableInputs b]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TablePermissionInputs b]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(TableBuildInput b, NonColumnTableInputs b,
  TablePermissionInputs b)]
-&gt; ([TableBuildInput b], [NonColumnTableInputs b],
    [TablePermissionInputs b])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">([(TableBuildInput b, NonColumnTableInputs b,
   TablePermissionInputs b)]
 -&gt; ([TableBuildInput b], [NonColumnTableInputs b],
     [TablePermissionInputs b]))
-&gt; [(TableBuildInput b, NonColumnTableInputs b,
     TablePermissionInputs b)]
-&gt; ([TableBuildInput b], [NonColumnTableInputs b],
    [TablePermissionInputs b])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TableMetadata b
 -&gt; (TableBuildInput b, NonColumnTableInputs b,
     TablePermissionInputs b))
-&gt; [TableMetadata b]
-&gt; [(TableBuildInput b, NonColumnTableInputs b,
     TablePermissionInputs b)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TableMetadata b
-&gt; (TableBuildInput b, NonColumnTableInputs b,
    TablePermissionInputs b)
forall (b :: BackendType).
TableMetadata b
-&gt; (TableBuildInput b, NonColumnTableInputs b,
    TablePermissionInputs b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#mkTableInputs"><span class="hs-identifier hs-var">mkTableInputs</span></a></span><span> </span><span class="annot"><span class="annottext">([TableMetadata b]
 -&gt; [(TableBuildInput b, NonColumnTableInputs b,
      TablePermissionInputs b)])
-&gt; [TableMetadata b]
-&gt; [(TableBuildInput b, NonColumnTableInputs b,
     TablePermissionInputs b)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap (TableName b) (TableMetadata b) -&gt; [TableMetadata b]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap (TableName b) (TableMetadata b)
 -&gt; [TableMetadata b])
-&gt; InsOrdHashMap (TableName b) (TableMetadata b)
-&gt; [TableMetadata b]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; InsOrdHashMap (TableName b) (TableMetadata b)
forall (b :: BackendType). SourceMetadata b -&gt; Tables b
</span><a href="Hasura.RQL.Types.Metadata.html#_smTables"><span class="hs-identifier hs-var hs-var">_smTables</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410018"><span class="hs-identifier hs-var">sourceMetadata</span></a></span><span>
</span><span id="line-660"></span><span>                          </span><span id="local-6989586621688410006"><span class="annot"><span class="annottext">HashMap
  (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b))
</span><a href="#local-6989586621688410006"><span class="hs-identifier hs-var">tablesCoreInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-661"></span><span>                            </span><span class="annot"><span class="annottext">arr
  (SourceName, SourceConfig b,
   HashMap (TableName b) (DBTableMetadata b), [TableBuildInput b],
   Dependency InvalidationKey)
  (HashMap
     (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)))
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) (b :: BackendType).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, ArrowCache m arr, MonadIO m,
 MonadBaseControl IO m, BackendMetadata b) =&gt;
arr
  (SourceName, SourceConfig b, DBTablesMetadata b,
   [TableBuildInput b], Dependency InvalidationKey)
  (HashMap
     (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)))
</span><a href="Hasura.RQL.DDL.Schema.Table.html#buildTableCache"><span class="hs-identifier hs-var">buildTableCache</span></a></span><span>
</span><span id="line-662"></span><span>                              </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-663"></span><span>                                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688410016"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-664"></span><span>                                  </span><span class="annot"><span class="annottext">ResolvedSource b -&gt; SourceConfig b
forall (b :: BackendType). ResolvedSource b -&gt; SourceConfig b
</span><a href="Hasura.RQL.Types.Source.html#_rsConfig"><span class="hs-identifier hs-var hs-var">_rsConfig</span></a></span><span> </span><span class="annot"><span class="annottext">ResolvedSource b
</span><a href="#local-6989586621688410011"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-665"></span><span>                                  </span><span class="annot"><span class="annottext">ResolvedSource b -&gt; HashMap (TableName b) (DBTableMetadata b)
forall (b :: BackendType). ResolvedSource b -&gt; DBTablesMetadata b
</span><a href="Hasura.RQL.Types.Source.html#_rsTables"><span class="hs-identifier hs-var hs-var">_rsTables</span></a></span><span> </span><span class="annot"><span class="annottext">ResolvedSource b
</span><a href="#local-6989586621688410011"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-666"></span><span>                                  </span><span class="annot"><span class="annottext">[TableBuildInput b]
</span><a href="#local-6989586621688410008"><span class="hs-identifier hs-var">tableInputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-667"></span><span>                                  </span><span class="annot"><span class="annottext">Dependency InvalidationKey
</span><a href="#local-6989586621688410010"><span class="hs-identifier hs-var">metadataInvalidationKey</span></a></span><span>
</span><span id="line-668"></span><span>                                </span><span class="hs-special">)</span><span>
</span><span id="line-669"></span><span>                          </span><span class="annot"><span class="annottext">arr
  (Maybe (AnyBackend PartiallyResolvedSource))
  (Maybe (AnyBackend PartiallyResolvedSource))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span>
</span><span id="line-670"></span><span>                            </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-671"></span><span>                              </span><span class="annot"><span class="annottext">AnyBackend PartiallyResolvedSource
-&gt; Maybe (AnyBackend PartiallyResolvedSource)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(AnyBackend PartiallyResolvedSource
 -&gt; Maybe (AnyBackend PartiallyResolvedSource))
-&gt; AnyBackend PartiallyResolvedSource
-&gt; Maybe (AnyBackend PartiallyResolvedSource)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-672"></span><span>                                </span><span class="annot"><span class="annottext">forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
forall (i :: BackendType -&gt; *). HasTag b =&gt; i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410012"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">(PartiallyResolvedSource b -&gt; AnyBackend PartiallyResolvedSource)
-&gt; PartiallyResolvedSource b -&gt; AnyBackend PartiallyResolvedSource
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-673"></span><span>                                  </span><span class="annot"><span class="annottext">SourceMetadata b
-&gt; ResolvedSource b
-&gt; HashMap
     (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b))
-&gt; PartiallyResolvedSource b
forall (b :: BackendType).
SourceMetadata b
-&gt; ResolvedSource b
-&gt; HashMap
     (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b))
-&gt; PartiallyResolvedSource b
</span><a href="Hasura.RQL.DDL.RemoteRelationship.html#PartiallyResolvedSource"><span class="hs-identifier hs-var">PartiallyResolvedSource</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688410018"><span class="hs-identifier hs-var">sourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">ResolvedSource b
</span><a href="#local-6989586621688410011"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b))
</span><a href="#local-6989586621688410006"><span class="hs-identifier hs-var">tablesCoreInfo</span></a></span><span>
</span><span id="line-674"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-675"></span><span>                  </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-676"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621688410020"><span class="hs-identifier hs-var">exists</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410083"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span>        </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(SourceName, BackendSourceMetadata)]
-&gt; HashMap SourceName BackendSourceMetadata
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(SourceName, BackendSourceMetadata)]
 -&gt; HashMap SourceName BackendSourceMetadata)
-&gt; [(SourceName, BackendSourceMetadata)]
-&gt; HashMap SourceName BackendSourceMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sources -&gt; [(SourceName, BackendSourceMetadata)]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">Sources
</span><a href="#local-6989586621688410081"><span class="hs-identifier hs-var">sources</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>          </span><span class="annot"><span class="annottext">forall a.
arr
  (a, ())
  (HashMap SourceName (Maybe (AnyBackend PartiallyResolvedSource)))
-&gt; arr
     (a,
      (HashMap SourceName (Maybe (AnyBackend PartiallyResolvedSource)),
       ()))
     (HashMap SourceName (AnyBackend PartiallyResolvedSource))
-&gt; arr
     (a, ()) (HashMap SourceName (AnyBackend PartiallyResolvedSource))
forall (arr :: * -&gt; * -&gt; *) e s a b.
Arrow arr =&gt;
arr (e, s) a -&gt; arr (e, (a, s)) b -&gt; arr (e, s) b
</span><a href="Control.Arrow.Extended.html#%3E-%3E"><span class="hs-operator hs-var">&gt;-&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688410000"><span class="annot"><span class="annottext">HashMap SourceName (Maybe (AnyBackend PartiallyResolvedSource))
</span><a href="#local-6989586621688410000"><span class="hs-identifier hs-var">infos</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Maybe (AnyBackend PartiallyResolvedSource))
-&gt; HashMap SourceName (AnyBackend PartiallyResolvedSource)
forall k v. HashMap k (Maybe v) -&gt; HashMap k v
</span><a href="Data.HashMap.Strict.Extended.html#catMaybes"><span class="hs-identifier hs-var">M.catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Maybe (AnyBackend PartiallyResolvedSource))
</span><a href="#local-6989586621688410000"><span class="hs-identifier hs-var">infos</span></a></span><span> </span><span class="hs-glyph">&gt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (HashMap SourceName (AnyBackend PartiallyResolvedSource))
  (HashMap SourceName (AnyBackend PartiallyResolvedSource))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span>      </span><span class="hs-comment">-- then we can build the entire source output</span><span>
</span><span id="line-682"></span><span>      </span><span class="hs-comment">-- we need to have the table cache of all sources to build cross-sources relationships</span><span>
</span><span id="line-683"></span><span>      </span><span id="local-6989586621688409999"><span class="annot"><span class="annottext">HashMap SourceName (BackendSourceInfo, DMap BackendTag ScalarSet)
</span><a href="#local-6989586621688409999"><span class="hs-identifier hs-var">sourcesOutput</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-684"></span><span>        </span><span class="hs-glyph">(|</span><span>
</span><span id="line-685"></span><span>          </span><span class="annot"><span class="annottext">forall a.
arr
  (a, (SourceName, (AnyBackend PartiallyResolvedSource, ())))
  (BackendSourceInfo, DMap BackendTag ScalarSet)
-&gt; arr
     (a, (HashMap SourceName (AnyBackend PartiallyResolvedSource), ()))
     (HashMap SourceName (BackendSourceInfo, DMap BackendTag ScalarSet))
forall (arr :: * -&gt; * -&gt; *) k e a s b.
(ArrowDistribute arr, Eq k, Hashable k) =&gt;
arr (e, (k, (a, s))) b -&gt; arr (e, (HashMap k a, s)) (HashMap k b)
</span><a href="Hasura.Incremental.Internal.Rule.html#keyed"><span class="hs-identifier hs-var">Inc.keyed</span></a></span><span>
</span><span id="line-686"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">SourceName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688409998"><span class="annot"><span class="annottext">AnyBackend PartiallyResolvedSource
</span><a href="#local-6989586621688409998"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-687"></span><span>                </span><span class="annot"><span class="annottext">(forall (b :: BackendType).
 (BackendMetadata b, BackendEventTrigger b) =&gt;
 arr
   (PartiallyResolvedSource b,
    (HashMap SourceName (AnyBackend PartiallyResolvedSource),
     Dependency InvalidationKeys, RemoteSchemaMap, OrderedRoles))
   (BackendSourceInfo, DMap BackendTag ScalarSet))
-&gt; arr
     (AnyBackend PartiallyResolvedSource,
      (HashMap SourceName (AnyBackend PartiallyResolvedSource),
       Dependency InvalidationKeys, RemoteSchemaMap, OrderedRoles))
     (BackendSourceInfo, DMap BackendTag ScalarSet)
forall (c1 :: BackendType -&gt; Constraint)
       (c2 :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r
       (arr :: * -&gt; * -&gt; *) x.
(ArrowChoice arr, AllBackendsSatisfy c1, AllBackendsSatisfy c2) =&gt;
(forall (b :: BackendType). (c1 b, c2 b) =&gt; arr (i b, x) r)
-&gt; arr (AnyBackend i, x) r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackendArrow"><span class="hs-identifier hs-var">AB.dispatchAnyBackendArrow</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span>
</span><span id="line-688"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">proc</span><span>
</span><span id="line-689"></span><span>                      </span><span class="hs-special">(</span><span> </span><span id="local-6989586621688409997"><span id="local-6989586621688409996"><span class="annot"><a href="#local-6989586621688409996"><span class="hs-identifier hs-var">partiallyResolvedSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteRelationship.html#PartiallyResolvedSource"><span class="hs-identifier hs-type">PartiallyResolvedSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688409997"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-690"></span><span>                        </span><span class="hs-special">(</span><span id="local-6989586621688409995"><span class="annot"><a href="#local-6989586621688409995"><span class="hs-identifier hs-var">allResolvedSources</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409994"><span class="annot"><a href="#local-6989586621688409994"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409993"><span class="annot"><a href="#local-6989586621688409993"><span class="hs-identifier hs-var">remoteSchemaCtxMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409992"><span class="annot"><a href="#local-6989586621688409992"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-691"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-692"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-693"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteRelationship.html#PartiallyResolvedSource"><span class="hs-identifier hs-type">PartiallyResolvedSource</span></a></span><span> </span><span id="local-6989586621688409991"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688409991"><span class="hs-identifier hs-var">sourceMetadata</span></a></span></span><span> </span><span id="local-6989586621688409990"><span class="annot"><span class="annottext">ResolvedSource b
</span><a href="#local-6989586621688409990"><span class="hs-identifier hs-var">resolvedSource</span></a></span></span><span> </span><span id="local-6989586621688409989"><span class="annot"><span class="annottext">HashMap
  (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b))
</span><a href="#local-6989586621688409989"><span class="hs-identifier hs-var">tablesInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PartiallyResolvedSource b
</span><a href="#local-6989586621688409996"><span class="hs-identifier hs-var">partiallyResolvedSource</span></a></span><span>
</span><span id="line-694"></span><span>                          </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#ResolvedSource"><span class="hs-identifier hs-type">ResolvedSource</span></a></span><span> </span><span id="local-6989586621688409987"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688409987"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621688409986"><span class="annot"><span class="annottext">SourceTypeCustomization
</span><a href="#local-6989586621688409986"><span class="hs-identifier hs-var">_sourceCustomization</span></a></span></span><span> </span><span id="local-6989586621688409985"><span class="annot"><span class="annottext">DBTablesMetadata b
</span><a href="#local-6989586621688409985"><span class="hs-identifier hs-var">tablesMeta</span></a></span></span><span> </span><span id="local-6989586621688409984"><span class="annot"><span class="annottext">DBFunctionsMetadata b
</span><a href="#local-6989586621688409984"><span class="hs-identifier hs-var">functionsMeta</span></a></span></span><span> </span><span id="local-6989586621688409983"><span class="annot"><span class="annottext">HashSet (ScalarType b)
</span><a href="#local-6989586621688409983"><span class="hs-identifier hs-var">scalars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResolvedSource b
</span><a href="#local-6989586621688409990"><span class="hs-identifier hs-var">resolvedSource</span></a></span><span>
</span><span id="line-695"></span><span>                      </span><span id="local-6989586621688409982"><span class="annot"><span class="annottext">BackendSourceInfo
</span><a href="#local-6989586621688409982"><span class="hs-identifier hs-var">so</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-696"></span><span>                        </span><span class="annot"><span class="annottext">arr
  (HashMap SourceName (AnyBackend PartiallyResolvedSource),
   SourceMetadata b, SourceConfig b,
   HashMap
     (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)),
   DBTablesMetadata b, DBFunctionsMetadata b, RemoteSchemaMap,
   Dependency InvalidationKeys, OrderedRoles)
  BackendSourceInfo
forall (b :: BackendType) (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr, MonadBaseControl IO m,
 HasServerConfigCtx m, MonadIO m, MonadError QErr m,
 MonadReader BuildReason m, BackendMetadata b,
 BackendEventTrigger b) =&gt;
arr
  (HashMap SourceName (AnyBackend PartiallyResolvedSource),
   SourceMetadata b, SourceConfig b,
   HashMap
     (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b)),
   DBTablesMetadata b, DBFunctionsMetadata b, RemoteSchemaMap,
   Dependency InvalidationKeys, OrderedRoles)
  BackendSourceInfo
</span><a href="#local-6989586621688410183"><span class="hs-identifier hs-var">buildSource</span></a></span><span>
</span><span id="line-697"></span><span>                          </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-698"></span><span>                            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (AnyBackend PartiallyResolvedSource)
</span><a href="#local-6989586621688409995"><span class="hs-identifier hs-var">allResolvedSources</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-699"></span><span>                              </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621688409991"><span class="hs-identifier hs-var">sourceMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-700"></span><span>                              </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688409987"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-701"></span><span>                              </span><span class="annot"><span class="annottext">HashMap
  (TableName b) (TableCoreInfoG b (ColumnInfo b) (ColumnInfo b))
</span><a href="#local-6989586621688409989"><span class="hs-identifier hs-var">tablesInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-702"></span><span>                              </span><span class="annot"><span class="annottext">DBTablesMetadata b
</span><a href="#local-6989586621688409985"><span class="hs-identifier hs-var">tablesMeta</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-703"></span><span>                              </span><span class="annot"><span class="annottext">DBFunctionsMetadata b
</span><a href="#local-6989586621688409984"><span class="hs-identifier hs-var">functionsMeta</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-704"></span><span>                              </span><span class="annot"><span class="annottext">RemoteSchemaMap
</span><a href="#local-6989586621688409993"><span class="hs-identifier hs-var">remoteSchemaCtxMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-705"></span><span>                              </span><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688409994"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-706"></span><span>                              </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688409992"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span>
</span><span id="line-707"></span><span>                            </span><span class="hs-special">)</span><span>
</span><span id="line-708"></span><span>                      </span><span class="annot"><span class="annottext">arr
  (BackendSourceInfo, DMap BackendTag ScalarSet)
  (BackendSourceInfo, DMap BackendTag ScalarSet)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BackendSourceInfo
</span><a href="#local-6989586621688409982"><span class="hs-identifier hs-var">so</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BackendTag b -&gt; ScalarSet b -&gt; DMap BackendTag ScalarSet
forall k1 (k2 :: k1 -&gt; *) (v :: k1) (f :: k1 -&gt; *).
k2 v -&gt; f v -&gt; DMap k2 f
</span><span class="hs-identifier hs-var">DMap.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasTag b =&gt; BackendTag b
forall (b :: BackendType). HasTag b =&gt; BackendTag b
</span><a href="Hasura.SQL.Tag.html#backendTag"><span class="hs-identifier hs-var">backendTag</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688409997"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ScalarSet b -&gt; DMap BackendTag ScalarSet)
-&gt; ScalarSet b -&gt; DMap BackendTag ScalarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet (ScalarType b) -&gt; ScalarSet b
forall (b :: BackendType).
Backend b =&gt;
HashSet (ScalarType b) -&gt; ScalarSet b
</span><a href="Hasura.RQL.Types.CustomTypes.html#ScalarSet"><span class="hs-identifier hs-var">ScalarSet</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (ScalarType b)
</span><a href="#local-6989586621688409983"><span class="hs-identifier hs-var">scalars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-709"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-710"></span><span>                  </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-711"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AnyBackend PartiallyResolvedSource
</span><a href="#local-6989586621688409998"><span class="hs-identifier hs-var">exists</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-712"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap SourceName (AnyBackend PartiallyResolvedSource)
</span><a href="#local-6989586621688410021"><span class="hs-identifier hs-var">partiallyResolvedSources</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependency InvalidationKeys
</span><a href="#local-6989586621688410083"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMap
</span><a href="#local-6989586621688410023"><span class="hs-identifier hs-var">remoteSchemaCtxMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688410029"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-713"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-714"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-715"></span><span>          </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (AnyBackend PartiallyResolvedSource)
</span><a href="#local-6989586621688410021"><span class="hs-identifier hs-var">partiallyResolvedSources</span></a></span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span>      </span><span id="local-6989586621688409979"><span class="annot"><span class="annottext">HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject)
</span><a href="#local-6989586621688409979"><span class="hs-identifier hs-var">remoteSchemaCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-718"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap
  RemoteSchemaName
  ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject)
</span><a href="#local-6989586621688410025"><span class="hs-identifier hs-var">remoteSchemaMap</span></a></span><span> </span><span class="hs-glyph">&gt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (HashMap
     RemoteSchemaName
     ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject))
  (HashMap
     RemoteSchemaName
     ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span class="hs-special">)</span><span>
</span><span id="line-719"></span><span>          </span><span class="annot"><span class="annottext">forall a.
arr
  (a, ())
  (HashMap
     RemoteSchemaName
     ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject))
-&gt; arr
     (a,
      (HashMap
         RemoteSchemaName
         ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject),
       ()))
     (HashMap
        RemoteSchemaName
        (((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject),
         [AddRemoteSchemaPermission]))
-&gt; arr
     (a, ())
     (HashMap
        RemoteSchemaName
        (((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject),
         [AddRemoteSchemaPermission]))
forall (arr :: * -&gt; * -&gt; *) e s a b.
Arrow arr =&gt;
arr (e, s) a -&gt; arr (e, (a, s)) b -&gt; arr (e, s) b
</span><a href="Control.Arrow.Extended.html#%3E-%3E"><span class="hs-operator hs-var">&gt;-&gt;</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688409978"><span class="annot"><span class="annottext">HashMap
  RemoteSchemaName
  ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject)
</span><a href="#local-6989586621688409978"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-720"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap
  RemoteSchemaName
  ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject)
</span><a href="#local-6989586621688409978"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(AddRemoteSchemaPermission -&gt; RemoteSchemaName)
-&gt; [AddRemoteSchemaPermission]
-&gt; HashMap RemoteSchemaName [AddRemoteSchemaPermission]
forall k (t :: * -&gt; *) v.
(Eq k, Hashable k, Foldable t) =&gt;
(v -&gt; k) -&gt; t v -&gt; HashMap k [v]
</span><a href="Data.HashMap.Strict.Extended.html#groupOn"><span class="hs-identifier hs-var">M.groupOn</span></a></span><span> </span><span class="annot"><span class="annottext">AddRemoteSchemaPermission -&gt; RemoteSchemaName
</span><a href="Hasura.RQL.Types.RemoteSchema.html#_arspRemoteSchema"><span class="hs-identifier hs-var hs-var">_arspRemoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">[AddRemoteSchemaPermission]
</span><a href="#local-6989586621688410047"><span class="hs-identifier hs-var">remoteSchemaPermissions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-721"></span><span>                    </span><span class="hs-glyph">&gt;-</span><span>
</span><span id="line-722"></span><span>                      </span><span class="annot"><span class="annottext">(AddRemoteSchemaPermission -&gt; MetadataObject)
-&gt; arr
     (HashMap
        RemoteSchemaName
        ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject),
      HashMap RemoteSchemaName [AddRemoteSchemaPermission])
     (HashMap
        RemoteSchemaName
        (((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject),
         [AddRemoteSchemaPermission]))
forall a b (arr :: * -&gt; * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr) =&gt;
(b -&gt; MetadataObject)
-&gt; arr
     (HashMap RemoteSchemaName a, HashMap RemoteSchemaName [b])
     (HashMap RemoteSchemaName (a, [b]))
</span><a href="#local-6989586621688409975"><span class="hs-identifier hs-var">alignExtraRemoteSchemaInfo</span></a></span><span> </span><span class="annot"><span class="annottext">AddRemoteSchemaPermission -&gt; MetadataObject
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkRemoteSchemaPermissionMetadataObject"><span class="hs-identifier hs-var">mkRemoteSchemaPermissionMetadataObject</span></a></span><span>
</span><span id="line-723"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span>          </span><span class="annot"><span class="annottext">forall a.
arr
  (a, ())
  (HashMap
     RemoteSchemaName
     (((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject),
      [AddRemoteSchemaPermission]))
-&gt; arr
     (a,
      (HashMap
         RemoteSchemaName
         (((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject),
          [AddRemoteSchemaPermission]),
       ()))
     (HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject))
-&gt; arr
     (a, ())
     (HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject))
forall (arr :: * -&gt; * -&gt; *) e s a b.
Arrow arr =&gt;
arr (e, s) a -&gt; arr (e, (a, s)) b -&gt; arr (e, s) b
</span><a href="Control.Arrow.Extended.html#%3E-%3E"><span class="hs-operator hs-var">&gt;-&gt;</span></a></span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-725"></span><span>                </span><span class="annot"><span class="annottext">forall a.
arr
  (a,
   (RemoteSchemaName,
    ((((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject),
      [AddRemoteSchemaPermission]),
     ())))
  (RemoteSchemaCtx, MetadataObject)
-&gt; arr
     (a,
      (HashMap
         RemoteSchemaName
         (((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject),
          [AddRemoteSchemaPermission]),
       ()))
     (HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject))
forall (arr :: * -&gt; * -&gt; *) k e a s b.
(ArrowDistribute arr, Eq k, Hashable k) =&gt;
arr (e, (k, (a, s))) b -&gt; arr (e, (HashMap k a, s)) (HashMap k b)
</span><a href="Hasura.Incremental.Internal.Rule.html#keyed"><span class="hs-identifier hs-var">Inc.keyed</span></a></span><span>
</span><span id="line-726"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">RemoteSchemaName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621688409973"><span class="annot"><span class="annottext">RemoteSchemaCtx
</span><a href="#local-6989586621688409973"><span class="hs-identifier hs-var">remoteSchemaCtx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409972"><span class="annot"><span class="annottext">SchemaRemoteRelationships
</span><a href="#local-6989586621688409972"><span class="hs-identifier hs-var">relationships</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409971"><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688409971"><span class="hs-identifier hs-var">metadataObj</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409970"><span class="annot"><span class="annottext">[AddRemoteSchemaPermission]
</span><a href="#local-6989586621688409970"><span class="hs-identifier hs-var">remoteSchemaPerms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-727"></span><span>                      </span><span id="local-6989586621688409969"><span class="annot"><span class="annottext">HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621688409969"><span class="hs-identifier hs-var">metadataPermissionsMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-728"></span><span>                        </span><span class="annot"><span class="annottext">arr
  (RemoteSchemaCtx, [AddRemoteSchemaPermission])
  (HashMap RoleName IntrospectionResult)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, ArrowCache m arr,
 MonadError QErr m) =&gt;
arr
  (RemoteSchemaCtx, [AddRemoteSchemaPermission])
  (HashMap RoleName IntrospectionResult)
</span><a href="#local-6989586621688409968"><span class="hs-identifier hs-var">buildRemoteSchemaPermissions</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaCtx
</span><a href="#local-6989586621688409973"><span class="hs-identifier hs-var">remoteSchemaCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[AddRemoteSchemaPermission]
</span><a href="#local-6989586621688409970"><span class="hs-identifier hs-var">remoteSchemaPerms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>                      </span><span class="hs-comment">-- convert to the intermediate form `CheckPermission` whose `Semigroup`</span><span>
</span><span id="line-730"></span><span>                      </span><span class="hs-comment">-- instance is used to combine permissions</span><span>
</span><span id="line-731"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409967"><span class="annot"><span class="annottext">metadataCheckPermissionsMap :: HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621688409967"><span class="hs-identifier hs-var hs-var">metadataCheckPermissionsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntrospectionResult -&gt; CheckPermission IntrospectionResult
forall permissionType.
permissionType -&gt; CheckPermission permissionType
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPDefined"><span class="hs-identifier hs-var">CPDefined</span></a></span><span> </span><span class="annot"><span class="annottext">(IntrospectionResult -&gt; CheckPermission IntrospectionResult)
-&gt; HashMap RoleName IntrospectionResult
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621688409969"><span class="hs-identifier hs-var">metadataPermissionsMap</span></a></span><span>
</span><span id="line-732"></span><span>                      </span><span id="local-6989586621688409965"><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621688409965"><span class="hs-identifier hs-var">allRolesUnresolvedPermissionsMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-733"></span><span>                        </span><span class="annot"><span class="annottext">arr
  (m (HashMap RoleName (CheckPermission IntrospectionResult)))
  (HashMap RoleName (CheckPermission IntrospectionResult))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-734"></span><span>                          </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-735"></span><span>                            </span><span class="annot"><span class="annottext">(HashMap RoleName (CheckPermission IntrospectionResult)
 -&gt; Role
 -&gt; m (HashMap RoleName (CheckPermission IntrospectionResult)))
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; [Role]
-&gt; m (HashMap RoleName (CheckPermission IntrospectionResult))
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span>
</span><span id="line-736"></span><span>                              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688409963"><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621688409963"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span id="local-6989586621688409962"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409962"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#ParentRoles"><span class="hs-identifier hs-type">ParentRoles</span></a></span><span> </span><span id="local-6989586621688409961"><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688409961"><span class="hs-identifier hs-var">parentRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-737"></span><span>                                  </span><span id="local-6989586621688409960"><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621688409960"><span class="hs-identifier hs-var">rolePermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; Maybe (CheckPermission IntrospectionResult)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409962"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621688409963"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (CheckPermission IntrospectionResult)
 -&gt; m (CheckPermission IntrospectionResult))
-&gt; m (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-738"></span><span>                                    </span><span id="local-6989586621688409958"><span class="annot"><span class="annottext">[CheckPermission IntrospectionResult]
</span><a href="#local-6989586621688409958"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-739"></span><span>                                      </span><span class="annot"><span class="annottext">[RoleName]
-&gt; (RoleName -&gt; m (CheckPermission IntrospectionResult))
-&gt; m [CheckPermission IntrospectionResult]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688409961"><span class="hs-identifier hs-var">parentRoles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RoleName -&gt; m (CheckPermission IntrospectionResult))
 -&gt; m [CheckPermission IntrospectionResult])
-&gt; (RoleName -&gt; m (CheckPermission IntrospectionResult))
-&gt; m [CheckPermission IntrospectionResult]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688409956"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409956"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-740"></span><span>                                        </span><span class="annot"><span class="annottext">Maybe (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; Maybe (CheckPermission IntrospectionResult)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409956"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621688409963"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (CheckPermission IntrospectionResult)
 -&gt; m (CheckPermission IntrospectionResult))
-&gt; m (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-741"></span><span>                                          </span><span class="annot"><span class="annottext">Text -&gt; m (CheckPermission IntrospectionResult)
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m (CheckPermission IntrospectionResult))
-&gt; Text -&gt; m (CheckPermission IntrospectionResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-742"></span><span>                                            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;remote schema permissions: bad ordering of roles, could not find the permission of role: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; RoleName -&gt; Text
forall t. ToTxt t =&gt; Text -&gt; t -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3E%3E"><span class="hs-operator hs-var">&lt;&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409956"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-743"></span><span>                                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409953"><span class="annot"><span class="annottext">combinedPermission :: Maybe (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621688409953"><span class="hs-identifier hs-var hs-var">combinedPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (CheckPermission IntrospectionResult)
-&gt; CheckPermission IntrospectionResult
forall a. Semigroup a =&gt; NonEmpty a -&gt; a
</span><span class="hs-identifier hs-var">sconcat</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty (CheckPermission IntrospectionResult)
 -&gt; CheckPermission IntrospectionResult)
-&gt; Maybe (NonEmpty (CheckPermission IntrospectionResult))
-&gt; Maybe (CheckPermission IntrospectionResult)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[CheckPermission IntrospectionResult]
-&gt; Maybe (NonEmpty (CheckPermission IntrospectionResult))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><span class="hs-identifier hs-var">nonEmpty</span></span><span> </span><span class="annot"><span class="annottext">[CheckPermission IntrospectionResult]
</span><a href="#local-6989586621688409958"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span><span>
</span><span id="line-744"></span><span>                                    </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
-&gt; m (CheckPermission IntrospectionResult)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(CheckPermission IntrospectionResult
 -&gt; m (CheckPermission IntrospectionResult))
-&gt; CheckPermission IntrospectionResult
-&gt; m (CheckPermission IntrospectionResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
-&gt; Maybe (CheckPermission IntrospectionResult)
-&gt; CheckPermission IntrospectionResult
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
forall permissionType. CheckPermission permissionType
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPUndefined"><span class="hs-identifier hs-var">CPUndefined</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621688409953"><span class="hs-identifier hs-var">combinedPermission</span></a></span><span>
</span><span id="line-745"></span><span>                                  </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; m (HashMap RoleName (CheckPermission IntrospectionResult))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(HashMap RoleName (CheckPermission IntrospectionResult)
 -&gt; m (HashMap RoleName (CheckPermission IntrospectionResult)))
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; m (HashMap RoleName (CheckPermission IntrospectionResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RoleName
-&gt; CheckPermission IntrospectionResult
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409962"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621688409960"><span class="hs-identifier hs-var">rolePermission</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621688409963"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span>
</span><span id="line-746"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-747"></span><span>                              </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621688409967"><span class="hs-identifier hs-var">metadataCheckPermissionsMap</span></a></span><span>
</span><span id="line-748"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var hs-var">_unOrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688410029"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-749"></span><span>                      </span><span class="hs-comment">-- traverse through `allRolesUnresolvedPermissionsMap` to record any inconsistencies (if exists)</span><span>
</span><span id="line-750"></span><span>                      </span><span id="local-6989586621688409947"><span class="annot"><span class="annottext">[(RoleName, Maybe IntrospectionResult)]
</span><a href="#local-6989586621688409947"><span class="hs-identifier hs-var">resolvedPermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-751"></span><span>                        </span><span class="hs-glyph">(|</span><span>
</span><span id="line-752"></span><span>                          </span><span class="annot"><span class="annottext">forall a.
arr
  (a, ((RoleName, CheckPermission IntrospectionResult), ()))
  (RoleName, Maybe IntrospectionResult)
-&gt; arr
     (a, ([(RoleName, CheckPermission IntrospectionResult)], ()))
     [(RoleName, Maybe IntrospectionResult)]
forall (arr :: * -&gt; * -&gt; *) (t :: * -&gt; *) e a s b.
(ArrowChoice arr, Traversable t) =&gt;
arr (e, (a, s)) b -&gt; arr (e, (t a, s)) (t b)
</span><a href="Control.Arrow.Extended.html#traverseA"><span class="hs-identifier hs-var">traverseA</span></a></span><span>
</span><span id="line-753"></span><span>                            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688409945"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409945"><span class="hs-identifier hs-var">roleName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409944"><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621688409944"><span class="hs-identifier hs-var">checkPermission</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-754"></span><span>                                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409943"><span class="annot"><span class="annottext">inconsistentRoleEntity :: InconsistentRoleEntity
</span><a href="#local-6989586621688409943"><span class="hs-identifier hs-var hs-var">inconsistentRoleEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; InconsistentRoleEntity
</span><a href="Hasura.RQL.Types.Metadata.Object.html#InconsistentRemoteSchemaPermission"><span class="hs-identifier hs-var">InconsistentRemoteSchemaPermission</span></a></span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaName -&gt; InconsistentRoleEntity)
-&gt; RemoteSchemaName -&gt; InconsistentRoleEntity
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaCtx -&gt; RemoteSchemaName
</span><a href="Hasura.RQL.Types.SchemaCache.html#_rscName"><span class="hs-identifier hs-var hs-var">_rscName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaCtx
</span><a href="#local-6989586621688409973"><span class="hs-identifier hs-var">remoteSchemaCtx</span></a></span><span>
</span><span id="line-755"></span><span>                                </span><span id="local-6989586621688409940"><span class="annot"><span class="annottext">Maybe IntrospectionResult
</span><a href="#local-6989586621688409940"><span class="hs-identifier hs-var">resolvedCheckPermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (CheckPermission IntrospectionResult, RoleName,
   InconsistentRoleEntity)
  (Maybe IntrospectionResult)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) p.
(ArrowChoice arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr) =&gt;
arr (CheckPermission p, RoleName, InconsistentRoleEntity) (Maybe p)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier hs-var">resolveCheckPermission</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621688409944"><span class="hs-identifier hs-var">checkPermission</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409945"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InconsistentRoleEntity
</span><a href="#local-6989586621688409943"><span class="hs-identifier hs-var">inconsistentRoleEntity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-756"></span><span>                                </span><span class="annot"><span class="annottext">arr
  (RoleName, Maybe IntrospectionResult)
  (RoleName, Maybe IntrospectionResult)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409945"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe IntrospectionResult
</span><a href="#local-6989586621688409940"><span class="hs-identifier hs-var">resolvedCheckPermission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span>                            </span><span class="hs-special">)</span><span>
</span><span id="line-758"></span><span>                          </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; [(RoleName, CheckPermission IntrospectionResult)]
forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621688409965"><span class="hs-identifier hs-var">allRolesUnresolvedPermissionsMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-759"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409937"><span class="annot"><span class="annottext">remoteSchemaIntrospection :: RemoteSchemaIntrospection
</span><a href="#local-6989586621688409937"><span class="hs-identifier hs-var hs-var">remoteSchemaIntrospection</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntrospectionResult -&gt; RemoteSchemaIntrospection
</span><a href="Hasura.RQL.Types.SchemaCache.html#irDoc"><span class="hs-identifier hs-var hs-var">irDoc</span></a></span><span> </span><span class="annot"><span class="annottext">(IntrospectionResult -&gt; RemoteSchemaIntrospection)
-&gt; IntrospectionResult -&gt; RemoteSchemaIntrospection
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaCtx -&gt; IntrospectionResult
</span><a href="Hasura.RQL.Types.SchemaCache.html#_rscIntroOriginal"><span class="hs-identifier hs-var hs-var">_rscIntroOriginal</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaCtx
</span><a href="#local-6989586621688409973"><span class="hs-identifier hs-var">remoteSchemaCtx</span></a></span><span>
</span><span id="line-760"></span><span>                      </span><span id="local-6989586621688409934"><span class="annot"><span class="annottext">[(Name, InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name)))]
</span><a href="#local-6989586621688409934"><span class="hs-identifier hs-var">resolvedRelationships</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-761"></span><span>                        </span><span class="hs-glyph">(|</span><span>
</span><span id="line-762"></span><span>                          </span><span class="annot"><span class="annottext">forall a.
arr
  (a, ((Name, RemoteSchemaTypeRelationships), ()))
  (Name, InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name)))
-&gt; arr
     (a, ([(Name, RemoteSchemaTypeRelationships)], ()))
     [(Name, InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name)))]
forall (arr :: * -&gt; * -&gt; *) (t :: * -&gt; *) e a s b.
(ArrowChoice arr, Traversable t) =&gt;
arr (e, (a, s)) b -&gt; arr (e, (t a, s)) (t b)
</span><a href="Control.Arrow.Extended.html#traverseA"><span class="hs-identifier hs-var">traverseA</span></a></span><span>
</span><span id="line-763"></span><span>                            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688409933"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688409933"><span class="hs-identifier hs-var">typeName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409932"><span class="annot"><span class="annottext">RemoteSchemaTypeRelationships
</span><a href="#local-6989586621688409932"><span class="hs-identifier hs-var">typeRelationships</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-764"></span><span>                                </span><span id="local-6989586621688409931"><span class="annot"><span class="annottext">InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name))
</span><a href="#local-6989586621688409931"><span class="hs-identifier hs-var">resolvedRelationships</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-765"></span><span>                                  </span><span class="hs-glyph">(|</span><span>
</span><span id="line-766"></span><span>                                    </span><span class="annot"><span class="annottext">forall a.
arr (a, (RemoteRelationship, ())) (Maybe (RemoteFieldInfo Name))
-&gt; arr
     (a, (InsOrdHashMap RelName RemoteRelationship, ()))
     (InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name)))
forall (arr :: * -&gt; * -&gt; *) (t :: * -&gt; *) e a s b.
(ArrowChoice arr, Traversable t) =&gt;
arr (e, (a, s)) b -&gt; arr (e, (t a, s)) (t b)
</span><a href="Control.Arrow.Extended.html#traverseA"><span class="hs-identifier hs-var">traverseA</span></a></span><span>
</span><span id="line-767"></span><span>                                      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688409930"><span class="annot"><span class="annottext">RemoteRelationship
</span><a href="#local-6989586621688409930"><span class="hs-identifier hs-var">fromSchemaDef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-768"></span><span>                                          </span><span class="annot"><span class="annottext">arr
  ((HashMap SourceName (AnyBackend PartiallyResolvedSource),
    RemoteSchemaMap),
   (RemoteSchemaName, RemoteSchemaIntrospection, Name,
    RemoteRelationship))
  (Maybe (RemoteFieldInfo Name))
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowWriter (Seq CollectedInfo) arr,
 ArrowKleisli m arr, MonadError QErr m) =&gt;
arr
  ((HashMap SourceName (AnyBackend PartiallyResolvedSource),
    RemoteSchemaMap),
   (RemoteSchemaName, RemoteSchemaIntrospection, Name,
    RemoteRelationship))
  (Maybe (RemoteFieldInfo Name))
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRemoteSchemaRemoteRelationship"><span class="hs-identifier hs-var">buildRemoteSchemaRemoteRelationship</span></a></span><span>
</span><span id="line-769"></span><span>                                            </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-770"></span><span>                                              </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap SourceName (AnyBackend PartiallyResolvedSource)
</span><a href="#local-6989586621688410021"><span class="hs-identifier hs-var">partiallyResolvedSources</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMap
</span><a href="#local-6989586621688410023"><span class="hs-identifier hs-var">remoteSchemaCtxMap</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-771"></span><span>                                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaCtx -&gt; RemoteSchemaName
</span><a href="Hasura.RQL.Types.SchemaCache.html#_rscName"><span class="hs-identifier hs-var hs-var">_rscName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaCtx
</span><a href="#local-6989586621688409973"><span class="hs-identifier hs-var">remoteSchemaCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaIntrospection
</span><a href="#local-6989586621688409937"><span class="hs-identifier hs-var">remoteSchemaIntrospection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688409933"><span class="hs-identifier hs-var">typeName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteRelationship
</span><a href="#local-6989586621688409930"><span class="hs-identifier hs-var">fromSchemaDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>                                              </span><span class="hs-special">)</span><span>
</span><span id="line-773"></span><span>                                      </span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>                                    </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaTypeRelationships
-&gt; InsOrdHashMap RelName RemoteRelationship
</span><a href="Hasura.RQL.Types.Metadata.html#_rstrsRelationships"><span class="hs-identifier hs-var hs-var">_rstrsRelationships</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaTypeRelationships
</span><a href="#local-6989586621688409932"><span class="hs-identifier hs-var">typeRelationships</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-775"></span><span>                                </span><span class="annot"><span class="annottext">arr
  (Name, InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name)))
  (Name, InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name)))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688409933"><span class="hs-identifier hs-var">typeName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name))
</span><a href="#local-6989586621688409931"><span class="hs-identifier hs-var">resolvedRelationships</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-776"></span><span>                            </span><span class="hs-special">)</span><span>
</span><span id="line-777"></span><span>                          </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaRemoteRelationships
-&gt; [(Name, RemoteSchemaTypeRelationships)]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">SchemaRemoteRelationships
</span><a href="#local-6989586621688409972"><span class="hs-identifier hs-var">relationships</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-778"></span><span>                      </span><span class="annot"><span class="annottext">arr
  (RemoteSchemaCtx, MetadataObject) (RemoteSchemaCtx, MetadataObject)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span>
</span><span id="line-779"></span><span>                        </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-780"></span><span>                          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaCtx
</span><a href="#local-6989586621688409973"><span class="hs-identifier hs-var">remoteSchemaCtx</span></a></span><span>
</span><span id="line-781"></span><span>                              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_rscPermissions :: HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621688409927"><span class="hs-identifier hs-var">_rscPermissions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (Maybe IntrospectionResult)
-&gt; HashMap RoleName IntrospectionResult
forall k v. HashMap k (Maybe v) -&gt; HashMap k v
</span><a href="Data.HashMap.Strict.Extended.html#catMaybes"><span class="hs-identifier hs-var">M.catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap RoleName (Maybe IntrospectionResult)
 -&gt; HashMap RoleName IntrospectionResult)
-&gt; HashMap RoleName (Maybe IntrospectionResult)
-&gt; HashMap RoleName IntrospectionResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(RoleName, Maybe IntrospectionResult)]
-&gt; HashMap RoleName (Maybe IntrospectionResult)
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(RoleName, Maybe IntrospectionResult)]
</span><a href="#local-6989586621688409947"><span class="hs-identifier hs-var">resolvedPermissions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-782"></span><span>                                </span><span class="annot"><span class="annottext">_rscRemoteRelationships :: RemoteSchemaRelationships
</span><a href="#local-6989586621688409926"><span class="hs-identifier hs-var">_rscRemoteRelationships</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name))
-&gt; InsOrdHashMap RelName (RemoteFieldInfo Name)
forall k v. InsOrdHashMap k (Maybe v) -&gt; InsOrdHashMap k v
</span><a href="Data.HashMap.Strict.InsOrd.Extended.html#catMaybes"><span class="hs-identifier hs-var">OMap.catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name))
 -&gt; InsOrdHashMap RelName (RemoteFieldInfo Name))
-&gt; InsOrdHashMap
     Name (InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name)))
-&gt; RemoteSchemaRelationships
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Name, InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name)))]
-&gt; InsOrdHashMap
     Name (InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name)))
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; InsOrdHashMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, InsOrdHashMap RelName (Maybe (RemoteFieldInfo Name)))]
</span><a href="#local-6989586621688409934"><span class="hs-identifier hs-var">resolvedRelationships</span></a></span><span>
</span><span id="line-783"></span><span>                              </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-784"></span><span>                            </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688409971"><span class="hs-identifier hs-var">metadataObj</span></a></span><span>
</span><span id="line-785"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-786"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-787"></span><span>              </span><span class="hs-glyph">|)</span><span>
</span><span id="line-788"></span><span>
</span><span id="line-789"></span><span>      </span><span class="hs-comment">-- allowlist</span><span>
</span><span id="line-790"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409923"><span class="annot"><span class="annottext">inlinedAllowlist :: InlinedAllowlist
</span><a href="#local-6989586621688409923"><span class="hs-identifier hs-var hs-var">inlinedAllowlist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QueryCollections -&gt; MetadataAllowlist -&gt; InlinedAllowlist
</span><a href="Hasura.RQL.Types.Allowlist.html#inlineAllowlist"><span class="hs-identifier hs-var">inlineAllowlist</span></a></span><span> </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688410079"><span class="hs-identifier hs-var">collections</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataAllowlist
</span><a href="#local-6989586621688410078"><span class="hs-identifier hs-var">metadataAllowlist</span></a></span><span>
</span><span id="line-791"></span><span>
</span><span id="line-792"></span><span>      </span><span id="local-6989586621688409921"><span class="annot"><span class="annottext">HashMap EndpointName (EndpointMetadata GQLQueryWithText)
</span><a href="#local-6989586621688409921"><span class="hs-identifier hs-var">resolvedEndpoints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((EndpointName, CreateEndpoint) -&gt; EndpointName)
-&gt; ((EndpointName, CreateEndpoint) -&gt; MetadataObject)
-&gt; arr
     (QueryCollections, (EndpointName, CreateEndpoint))
     (Maybe (EndpointMetadata GQLQueryWithText))
-&gt; arr
     (QueryCollections, [(EndpointName, CreateEndpoint)])
     (HashMap EndpointName (EndpointMetadata GQLQueryWithText))
forall (arr :: * -&gt; * -&gt; *) k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, Eq k, Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMap"><span class="hs-identifier hs-var">buildInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">(EndpointName, CreateEndpoint) -&gt; EndpointName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(EndpointName, CreateEndpoint) -&gt; MetadataObject
forall a. ToJSON a =&gt; (EndpointName, a) -&gt; MetadataObject
</span><a href="#local-6989586621688409919"><span class="hs-identifier hs-var">mkEndpointMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">arr
  (QueryCollections, (EndpointName, CreateEndpoint))
  (Maybe (EndpointMetadata GQLQueryWithText))
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowKleisli m arr, MonadError QErr m,
 ArrowWriter (Seq CollectedInfo) arr) =&gt;
arr
  (QueryCollections, (EndpointName, CreateEndpoint))
  (Maybe (EndpointMetadata GQLQueryWithText))
</span><a href="#local-6989586621688409918"><span class="hs-identifier hs-var">buildEndpoint</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688410079"><span class="hs-identifier hs-var">collections</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap EndpointName CreateEndpoint
-&gt; [(EndpointName, CreateEndpoint)]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap EndpointName CreateEndpoint
</span><a href="#local-6989586621688410074"><span class="hs-identifier hs-var">endpoints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-793"></span><span>
</span><span id="line-794"></span><span>      </span><span class="hs-comment">-- custom types</span><span>
</span><span id="line-795"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409917"><span class="annot"><span class="annottext">scalarsMap :: DMap BackendTag ScalarSet
</span><a href="#local-6989586621688409917"><span class="hs-identifier hs-var hs-var">scalarsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DMap BackendTag ScalarSet] -&gt; DMap BackendTag ScalarSet
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([DMap BackendTag ScalarSet] -&gt; DMap BackendTag ScalarSet)
-&gt; [DMap BackendTag ScalarSet] -&gt; DMap BackendTag ScalarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((BackendSourceInfo, DMap BackendTag ScalarSet)
 -&gt; DMap BackendTag ScalarSet)
-&gt; [(BackendSourceInfo, DMap BackendTag ScalarSet)]
-&gt; [DMap BackendTag ScalarSet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(BackendSourceInfo, DMap BackendTag ScalarSet)
-&gt; DMap BackendTag ScalarSet
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(BackendSourceInfo, DMap BackendTag ScalarSet)]
 -&gt; [DMap BackendTag ScalarSet])
-&gt; [(BackendSourceInfo, DMap BackendTag ScalarSet)]
-&gt; [DMap BackendTag ScalarSet]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (BackendSourceInfo, DMap BackendTag ScalarSet)
-&gt; [(BackendSourceInfo, DMap BackendTag ScalarSet)]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (BackendSourceInfo, DMap BackendTag ScalarSet)
</span><a href="#local-6989586621688409999"><span class="hs-identifier hs-var">sourcesOutput</span></a></span><span>
</span><span id="line-796"></span><span>          </span><span id="local-6989586621688409916"><span class="annot"><span class="annottext">sourcesCache :: SourceCache
</span><a href="#local-6989586621688409916"><span class="hs-identifier hs-var hs-var">sourcesCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((BackendSourceInfo, DMap BackendTag ScalarSet)
 -&gt; BackendSourceInfo)
-&gt; HashMap
     SourceName (BackendSourceInfo, DMap BackendTag ScalarSet)
-&gt; SourceCache
forall v1 v2 k. (v1 -&gt; v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">(BackendSourceInfo, DMap BackendTag ScalarSet) -&gt; BackendSourceInfo
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (BackendSourceInfo, DMap BackendTag ScalarSet)
</span><a href="#local-6989586621688409999"><span class="hs-identifier hs-var">sourcesOutput</span></a></span><span>
</span><span id="line-797"></span><span>      </span><span id="local-6989586621688409915"><span class="annot"><span class="annottext">Maybe AnnotatedCustomTypes
</span><a href="#local-6989586621688409915"><span class="hs-identifier hs-var">maybeResolvedCustomTypes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-798"></span><span>        </span><span class="hs-glyph">(|</span><span>
</span><span id="line-799"></span><span>          </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) AnnotatedCustomTypes
-&gt; arr (a, (MetadataObject, ())) (Maybe AnnotatedCustomTypes)
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-800"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ErrorA QErr arr (m AnnotatedCustomTypes) AnnotatedCustomTypes
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">SourceCache
-&gt; CustomTypes
-&gt; DMap BackendTag ScalarSet
-&gt; m AnnotatedCustomTypes
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
SourceCache
-&gt; CustomTypes
-&gt; DMap BackendTag ScalarSet
-&gt; m AnnotatedCustomTypes
</span><a href="Hasura.RQL.DDL.CustomTypes.html#resolveCustomTypes"><span class="hs-identifier hs-var">resolveCustomTypes</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCache
</span><a href="#local-6989586621688409916"><span class="hs-identifier hs-var">sourcesCache</span></a></span><span> </span><span class="annot"><span class="annottext">CustomTypes
</span><a href="#local-6989586621688410077"><span class="hs-identifier hs-var">customTypes</span></a></span><span> </span><span class="annot"><span class="annottext">DMap BackendTag ScalarSet
</span><a href="#local-6989586621688409917"><span class="hs-identifier hs-var">scalarsMap</span></a></span><span>
</span><span id="line-801"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>          </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOCustomTypes"><span class="hs-identifier hs-var">MOCustomTypes</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; MetadataObject) -&gt; Value -&gt; MetadataObject
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CustomTypes -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">CustomTypes
</span><a href="#local-6989586621688410077"><span class="hs-identifier hs-var">customTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-803"></span><span>
</span><span id="line-804"></span><span>      </span><span class="hs-comment">-- actions</span><span>
</span><span id="line-805"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409912"><span class="annot"><span class="annottext">actionList :: [ActionMetadata]
</span><a href="#local-6989586621688409912"><span class="hs-identifier hs-var hs-var">actionList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Actions -&gt; [ActionMetadata]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">Actions
</span><a href="#local-6989586621688410076"><span class="hs-identifier hs-var">actions</span></a></span><span>
</span><span id="line-806"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621688409911"><span class="annot"><span class="annottext">ActionCache
</span><a href="#local-6989586621688409911"><span class="hs-identifier hs-var">actionCache</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409910"><span class="annot"><span class="annottext">AnnotatedCustomTypes
</span><a href="#local-6989586621688409910"><span class="hs-identifier hs-var">annotatedCustomTypes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe AnnotatedCustomTypes
</span><a href="#local-6989586621688409915"><span class="hs-identifier hs-var">maybeResolvedCustomTypes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-807"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688409909"><span class="annot"><span class="annottext">AnnotatedCustomTypes
</span><a href="#local-6989586621688409909"><span class="hs-identifier hs-var">resolvedCustomTypes</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-808"></span><span>          </span><span id="local-6989586621688409908"><span class="annot"><span class="annottext">ActionCache
</span><a href="#local-6989586621688409908"><span class="hs-identifier hs-var">actionCache'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  ((AnnotatedCustomTypes, DMap BackendTag ScalarSet, OrderedRoles),
   [ActionMetadata])
  ActionCache
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr) =&gt;
arr
  ((AnnotatedCustomTypes, DMap BackendTag ScalarSet, OrderedRoles),
   [ActionMetadata])
  ActionCache
</span><a href="#local-6989586621688409907"><span class="hs-identifier hs-var">buildActions</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnnotatedCustomTypes
</span><a href="#local-6989586621688409909"><span class="hs-identifier hs-var">resolvedCustomTypes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DMap BackendTag ScalarSet
</span><a href="#local-6989586621688409917"><span class="hs-identifier hs-var">scalarsMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688410029"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ActionMetadata]
</span><a href="#local-6989586621688409912"><span class="hs-identifier hs-var">actionList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-809"></span><span>          </span><span class="annot"><span class="annottext">arr
  (ActionCache, AnnotatedCustomTypes)
  (ActionCache, AnnotatedCustomTypes)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ActionCache
</span><a href="#local-6989586621688409908"><span class="hs-identifier hs-var">actionCache'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnnotatedCustomTypes
</span><a href="#local-6989586621688409909"><span class="hs-identifier hs-var">resolvedCustomTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-810"></span><span>
</span><span id="line-811"></span><span>        </span><span class="hs-comment">-- If the custom types themselves are inconsistent, we can&#8217;t really do</span><span>
</span><span id="line-812"></span><span>        </span><span class="hs-comment">-- anything with actions, so just mark them all inconsistent.</span><span>
</span><span id="line-813"></span><span>        </span><span class="annot"><span class="annottext">Maybe AnnotatedCustomTypes
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-814"></span><span>          </span><span class="annot"><span class="annottext">arr ([MetadataObject], Text) ()
forall w (arr :: * -&gt; * -&gt; *).
(ArrowWriter (Seq w) arr, AsInconsistentMetadata w) =&gt;
arr ([MetadataObject], Text) ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordInconsistencies"><span class="hs-identifier hs-var">recordInconsistencies</span></a></span><span>
</span><span id="line-815"></span><span>            </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-816"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(ActionMetadata -&gt; MetadataObject)
-&gt; [ActionMetadata] -&gt; [MetadataObject]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ActionMetadata -&gt; MetadataObject
</span><a href="#local-6989586621688409905"><span class="hs-identifier hs-var">mkActionMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">[ActionMetadata]
</span><a href="#local-6989586621688409912"><span class="hs-identifier hs-var">actionList</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-817"></span><span>                </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;custom types are inconsistent&quot;</span></span><span>
</span><span id="line-818"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-819"></span><span>          </span><span class="annot"><span class="annottext">arr
  (ActionCache, AnnotatedCustomTypes)
  (ActionCache, AnnotatedCustomTypes)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ActionCache
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnnotatedCustomTypes
</span><a href="Hasura.RQL.Types.CustomTypes.html#emptyAnnotatedCustomTypes"><span class="hs-identifier hs-var">emptyAnnotatedCustomTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-820"></span><span>
</span><span id="line-821"></span><span>      </span><span id="local-6989586621688409902"><span class="annot"><span class="annottext">HashMap TriggerName CronTriggerInfo
</span><a href="#local-6989586621688409902"><span class="hs-identifier hs-var">cronTriggersMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  ((), [CronTriggerMetadata]) (HashMap TriggerName CronTriggerInfo)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, ArrowCache m arr,
 MonadError QErr m) =&gt;
arr
  ((), [CronTriggerMetadata]) (HashMap TriggerName CronTriggerInfo)
</span><a href="#local-6989586621688409901"><span class="hs-identifier hs-var">buildCronTriggers</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CronTriggers -&gt; [CronTriggerMetadata]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621688410075"><span class="hs-identifier hs-var">cronTriggers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-822"></span><span>
</span><span id="line-823"></span><span>      </span><span class="annot"><span class="annottext">arr BuildOutputs BuildOutputs
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span>
</span><span id="line-824"></span><span>        </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-825"></span><span>          </span><span class="annot"><span class="annottext">BuildOutputs :: SourceCache
-&gt; ActionCache
-&gt; HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject)
-&gt; InlinedAllowlist
-&gt; AnnotatedCustomTypes
-&gt; HashMap TriggerName CronTriggerInfo
-&gt; HashMap EndpointName (EndpointMetadata GQLQueryWithText)
-&gt; ApiLimit
-&gt; MetricsConfig
-&gt; HashMap RoleName Role
-&gt; [TlsAllow]
-&gt; QueryCollections
-&gt; BuildOutputs
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#BuildOutputs"><span class="hs-identifier hs-type">BuildOutputs</span></a></span><span>
</span><span id="line-826"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_boSources :: SourceCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boSources"><span class="hs-identifier hs-var">_boSources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((BackendSourceInfo, DMap BackendTag ScalarSet)
 -&gt; BackendSourceInfo)
-&gt; HashMap
     SourceName (BackendSourceInfo, DMap BackendTag ScalarSet)
-&gt; SourceCache
forall v1 v2 k. (v1 -&gt; v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">(BackendSourceInfo, DMap BackendTag ScalarSet) -&gt; BackendSourceInfo
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (BackendSourceInfo, DMap BackendTag ScalarSet)
</span><a href="#local-6989586621688409999"><span class="hs-identifier hs-var">sourcesOutput</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-827"></span><span>              </span><span class="annot"><span class="annottext">_boActions :: ActionCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boActions"><span class="hs-identifier hs-var">_boActions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ActionCache
</span><a href="#local-6989586621688409911"><span class="hs-identifier hs-var">actionCache</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-828"></span><span>              </span><span class="annot"><span class="annottext">_boRemoteSchemas :: HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boRemoteSchemas"><span class="hs-identifier hs-var">_boRemoteSchemas</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap RemoteSchemaName (RemoteSchemaCtx, MetadataObject)
</span><a href="#local-6989586621688409979"><span class="hs-identifier hs-var">remoteSchemaCache</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-829"></span><span>              </span><span class="annot"><span class="annottext">_boAllowlist :: InlinedAllowlist
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boAllowlist"><span class="hs-identifier hs-var">_boAllowlist</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlinedAllowlist
</span><a href="#local-6989586621688409923"><span class="hs-identifier hs-var">inlinedAllowlist</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-830"></span><span>              </span><span class="annot"><span class="annottext">_boCustomTypes :: AnnotatedCustomTypes
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boCustomTypes"><span class="hs-identifier hs-var">_boCustomTypes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnnotatedCustomTypes
</span><a href="#local-6989586621688409910"><span class="hs-identifier hs-var">annotatedCustomTypes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-831"></span><span>              </span><span class="annot"><span class="annottext">_boCronTriggers :: HashMap TriggerName CronTriggerInfo
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boCronTriggers"><span class="hs-identifier hs-var">_boCronTriggers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName CronTriggerInfo
</span><a href="#local-6989586621688409902"><span class="hs-identifier hs-var">cronTriggersMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-832"></span><span>              </span><span class="annot"><span class="annottext">_boEndpoints :: HashMap EndpointName (EndpointMetadata GQLQueryWithText)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boEndpoints"><span class="hs-identifier hs-var">_boEndpoints</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap EndpointName (EndpointMetadata GQLQueryWithText)
</span><a href="#local-6989586621688409921"><span class="hs-identifier hs-var">resolvedEndpoints</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-833"></span><span>              </span><span class="annot"><span class="annottext">_boApiLimits :: ApiLimit
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boApiLimits"><span class="hs-identifier hs-var">_boApiLimits</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ApiLimit
</span><a href="#local-6989586621688410073"><span class="hs-identifier hs-var">apiLimits</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-834"></span><span>              </span><span class="annot"><span class="annottext">_boMetricsConfig :: MetricsConfig
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boMetricsConfig"><span class="hs-identifier hs-var">_boMetricsConfig</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetricsConfig
</span><a href="#local-6989586621688410072"><span class="hs-identifier hs-var">metricsConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-835"></span><span>              </span><span class="annot"><span class="annottext">_boRoles :: HashMap RoleName Role
</span><a href="#local-6989586621688409899"><span class="hs-identifier hs-var">_boRoles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Role -&gt; RoleName) -&gt; [Role] -&gt; HashMap RoleName Role
forall k a. (Eq k, Hashable k) =&gt; (a -&gt; k) -&gt; [a] -&gt; HashMap k a
</span><a href="Hasura.Prelude.html#mapFromL"><span class="hs-identifier hs-var">mapFromL</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_rRoleName"><span class="hs-identifier hs-var hs-var">_rRoleName</span></a></span><span> </span><span class="annot"><span class="annottext">([Role] -&gt; HashMap RoleName Role)
-&gt; [Role] -&gt; HashMap RoleName Role
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var hs-var">_unOrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688410029"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-836"></span><span>              </span><span class="annot"><span class="annottext">_boTlsAllowlist :: [TlsAllow]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boTlsAllowlist"><span class="hs-identifier hs-var">_boTlsAllowlist</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Network -&gt; [TlsAllow]
</span><a href="Hasura.RQL.Types.Network.html#networkTlsAllowlist"><span class="hs-identifier hs-var hs-var">networkTlsAllowlist</span></a></span><span> </span><span class="annot"><span class="annottext">Network
</span><a href="#local-6989586621688410069"><span class="hs-identifier hs-var">networkConfig</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-837"></span><span>              </span><span class="annot"><span class="annottext">_boQueryCollections :: QueryCollections
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_boQueryCollections"><span class="hs-identifier hs-var">_boQueryCollections</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688410079"><span class="hs-identifier hs-var">collections</span></a></span><span>
</span><span id="line-838"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-839"></span><span>
</span><span id="line-840"></span><span>    </span><span id="local-6989586621688409919"><span class="annot"><span class="annottext">mkEndpointMetadataObject :: (EndpointName, a) -&gt; MetadataObject
</span><a href="#local-6989586621688409919"><span class="hs-identifier hs-var hs-var">mkEndpointMetadataObject</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409897"><span class="annot"><span class="annottext">EndpointName
</span><a href="#local-6989586621688409897"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409896"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688409896"><span class="hs-identifier hs-var">createEndpoint</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-841"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409895"><span class="annot"><span class="annottext">objectId :: MetadataObjId
</span><a href="#local-6989586621688409895"><span class="hs-identifier hs-var hs-var">objectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EndpointName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOEndpoint"><span class="hs-identifier hs-var">MOEndpoint</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointName
</span><a href="#local-6989586621688409897"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-842"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="#local-6989586621688409895"><span class="hs-identifier hs-var">objectId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688409896"><span class="hs-identifier hs-var">createEndpoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span>
</span><span id="line-844"></span><span>    </span><span id="local-6989586621688410787"><span id="local-6989586621688410788"><span class="annot"><a href="#local-6989586621688409918"><span class="hs-identifier hs-type">buildEndpoint</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-845"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410788"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Arrow.Extended.html#ArrowKleisli"><span class="hs-identifier hs-type">ArrowKleisli</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410787"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410788"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410787"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410788"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-846"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">InsOrdHashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#CollectionName"><span class="hs-identifier hs-type">CollectionName</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#CreateCollection"><span class="hs-identifier hs-type">CreateCollection</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#EndpointName"><span class="hs-identifier hs-type">EndpointName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#CreateEndpoint"><span class="hs-identifier hs-type">CreateEndpoint</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410788"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#EndpointMetadata"><span class="hs-identifier hs-type">EndpointMetadata</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#GQLQueryWithText"><span class="hs-identifier hs-type">GQLQueryWithText</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-847"></span><span>    </span><span id="local-6989586621688409918"><span class="annot"><span class="annottext">buildEndpoint :: arr
  (QueryCollections, (EndpointName, CreateEndpoint))
  (Maybe (EndpointMetadata GQLQueryWithText))
</span><a href="#local-6989586621688409918"><span class="hs-identifier hs-var hs-var">buildEndpoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409894"><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688409894"><span class="hs-identifier hs-var">collections</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409893"><span class="annot"><span class="annottext">e :: (EndpointName, CreateEndpoint)
</span><a href="#local-6989586621688409893"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621688409892"><span class="annot"><span class="annottext">EndpointName
</span><a href="#local-6989586621688409892"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409891"><span class="annot"><span class="annottext">CreateEndpoint
</span><a href="#local-6989586621688409891"><span class="hs-identifier hs-var">createEndpoint</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-848"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409890"><span class="annot"><span class="annottext">endpoint :: CreateEndpoint
</span><a href="#local-6989586621688409890"><span class="hs-identifier hs-var hs-var">endpoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CreateEndpoint
</span><a href="#local-6989586621688409891"><span class="hs-identifier hs-var">createEndpoint</span></a></span><span>
</span><span id="line-849"></span><span>          </span><span class="hs-comment">-- QueryReference collName queryName = _edQuery endpoint</span><span>
</span><span id="line-850"></span><span>          </span><span id="local-6989586621688409889"><span class="annot"><span class="annottext">addContext :: Text -&gt; Text
</span><a href="#local-6989586621688409889"><span class="hs-identifier hs-var hs-var">addContext</span></a></span></span><span> </span><span id="local-6989586621688409888"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409888"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in endpoint &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">NonEmptyText -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointName -&gt; NonEmptyText
</span><a href="Hasura.RQL.Types.Endpoint.html#unEndpointName"><span class="hs-identifier hs-var hs-var">unEndpointName</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointName
</span><a href="#local-6989586621688409892"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409888"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-851"></span><span>      </span><span class="hs-glyph">(|</span><span>
</span><span id="line-852"></span><span>        </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) (EndpointMetadata GQLQueryWithText)
-&gt; arr
     (a, (MetadataObject, ()))
     (Maybe (EndpointMetadata GQLQueryWithText))
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-853"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-854"></span><span>              </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) (EndpointMetadata GQLQueryWithText)
-&gt; ErrorA
     QErr
     arr
     (a, (Text -&gt; Text, ()))
     (EndpointMetadata GQLQueryWithText)
forall (arr :: * -&gt; * -&gt; *) e s a.
ArrowError QErr arr =&gt;
arr (e, s) a -&gt; arr (e, (Text -&gt; Text, s)) a
</span><a href="Hasura.Base.Error.html#modifyErrA"><span class="hs-identifier hs-var">modifyErrA</span></a></span><span>
</span><span id="line-855"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (m (EndpointMetadata GQLQueryWithText))
  (EndpointMetadata GQLQueryWithText)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">QueryCollections
-&gt; CreateEndpoint -&gt; m (EndpointMetadata GQLQueryWithText)
forall (m :: * -&gt; *).
QErrM m =&gt;
QueryCollections
-&gt; CreateEndpoint -&gt; m (EndpointMetadata GQLQueryWithText)
</span><a href="#local-6989586621688409886"><span class="hs-identifier hs-var">resolveEndpoint</span></a></span><span> </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688409894"><span class="hs-identifier hs-var">collections</span></a></span><span> </span><span class="annot"><span class="annottext">CreateEndpoint
</span><a href="#local-6989586621688409890"><span class="hs-identifier hs-var">endpoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-856"></span><span>            </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621688409889"><span class="hs-identifier hs-var">addContext</span></a></span><span>
</span><span id="line-857"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-858"></span><span>        </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EndpointName, CreateEndpoint) -&gt; MetadataObject
forall a. ToJSON a =&gt; (EndpointName, a) -&gt; MetadataObject
</span><a href="#local-6989586621688409919"><span class="hs-identifier hs-var">mkEndpointMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">(EndpointName, CreateEndpoint)
</span><a href="#local-6989586621688409893"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-859"></span><span>
</span><span id="line-860"></span><span>    </span><span id="local-6989586621688410770"><span class="annot"><a href="#local-6989586621688409886"><span class="hs-identifier hs-type">resolveEndpoint</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-861"></span><span>      </span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410770"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-862"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">InsOrdHashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#CollectionName"><span class="hs-identifier hs-type">CollectionName</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#CreateCollection"><span class="hs-identifier hs-type">CreateCollection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-863"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#EndpointMetadata"><span class="hs-identifier hs-type">EndpointMetadata</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#QueryReference"><span class="hs-identifier hs-type">QueryReference</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-864"></span><span>      </span><span class="annot"><a href="#local-6989586621688410770"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#EndpointMetadata"><span class="hs-identifier hs-type">EndpointMetadata</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#GQLQueryWithText"><span class="hs-identifier hs-type">GQLQueryWithText</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-865"></span><span>    </span><span id="local-6989586621688409886"><span class="annot"><span class="annottext">resolveEndpoint :: QueryCollections
-&gt; CreateEndpoint -&gt; m (EndpointMetadata GQLQueryWithText)
</span><a href="#local-6989586621688409886"><span class="hs-identifier hs-var hs-var">resolveEndpoint</span></a></span></span><span> </span><span id="local-6989586621688409885"><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688409885"><span class="hs-identifier hs-var">collections</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(QueryReference -&gt; m GQLQueryWithText)
-&gt; CreateEndpoint -&gt; m (EndpointMetadata GQLQueryWithText)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">((QueryReference -&gt; m GQLQueryWithText)
 -&gt; CreateEndpoint -&gt; m (EndpointMetadata GQLQueryWithText))
-&gt; (QueryReference -&gt; m GQLQueryWithText)
-&gt; CreateEndpoint
-&gt; m (EndpointMetadata GQLQueryWithText)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#QueryReference"><span class="hs-identifier hs-type">QueryReference</span></a></span><span> </span><span id="local-6989586621688409882"><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621688409882"><span class="hs-identifier hs-var">collName</span></a></span></span><span> </span><span id="local-6989586621688409881"><span class="annot"><span class="annottext">QueryName
</span><a href="#local-6989586621688409881"><span class="hs-identifier hs-var">queryName</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-866"></span><span>      </span><span id="local-6989586621688409880"><span class="annot"><span class="annottext">CreateCollection
</span><a href="#local-6989586621688409880"><span class="hs-identifier hs-var">collection</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-867"></span><span>        </span><span class="annot"><span class="annottext">Maybe CreateCollection -&gt; m CreateCollection -&gt; m CreateCollection
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span>
</span><span id="line-868"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CollectionName -&gt; QueryCollections -&gt; Maybe CreateCollection
forall k v. (Eq k, Hashable k) =&gt; k -&gt; InsOrdHashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621688409882"><span class="hs-identifier hs-var">collName</span></a></span><span> </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688409885"><span class="hs-identifier hs-var">collections</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-869"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m CreateCollection
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotExists"><span class="hs-identifier hs-var">NotExists</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m CreateCollection) -&gt; Text -&gt; m CreateCollection
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;collection with name &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CollectionName -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621688409882"><span class="hs-identifier hs-var">collName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; does not exist&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>      </span><span id="local-6989586621688409877"><span class="annot"><span class="annottext">ListedQuery
</span><a href="#local-6989586621688409877"><span class="hs-identifier hs-var">listedQuery</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-871"></span><span>        </span><span class="annot"><span class="annottext">(Maybe ListedQuery -&gt; m ListedQuery -&gt; m ListedQuery)
-&gt; m ListedQuery -&gt; Maybe ListedQuery -&gt; m ListedQuery
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span>
</span><span id="line-872"></span><span>          </span><span class="annot"><span class="annottext">Maybe ListedQuery -&gt; m ListedQuery -&gt; m ListedQuery
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span>
</span><span id="line-873"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ListedQuery
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotExists"><span class="hs-identifier hs-var">NotExists</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ListedQuery) -&gt; Text -&gt; m ListedQuery
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-874"></span><span>              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;query with name &quot;</span></span><span>
</span><span id="line-875"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QueryName -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">QueryName
</span><a href="#local-6989586621688409881"><span class="hs-identifier hs-var">queryName</span></a></span><span>
</span><span id="line-876"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; does not exist in collection &quot;</span></span><span>
</span><span id="line-877"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CollectionName -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621688409882"><span class="hs-identifier hs-var">collName</span></a></span><span>
</span><span id="line-878"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-879"></span><span>          </span><span class="annot"><span class="annottext">(Maybe ListedQuery -&gt; m ListedQuery)
-&gt; Maybe ListedQuery -&gt; m ListedQuery
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ListedQuery -&gt; Bool) -&gt; [ListedQuery] -&gt; Maybe ListedQuery
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">QueryName -&gt; QueryName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">QueryName
</span><a href="#local-6989586621688409881"><span class="hs-identifier hs-var">queryName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(QueryName -&gt; Bool)
-&gt; (ListedQuery -&gt; QueryName) -&gt; ListedQuery -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ListedQuery -&gt; QueryName
</span><a href="Hasura.RQL.Types.QueryCollection.html#_lqName"><span class="hs-identifier hs-var hs-var">_lqName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CollectionDef -&gt; [ListedQuery]
</span><a href="Hasura.RQL.Types.QueryCollection.html#_cdQueries"><span class="hs-identifier hs-var hs-var">_cdQueries</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CreateCollection -&gt; CollectionDef
</span><a href="Hasura.RQL.Types.QueryCollection.html#_ccDefinition"><span class="hs-identifier hs-var hs-var">_ccDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">CreateCollection
</span><a href="#local-6989586621688409880"><span class="hs-identifier hs-var">collection</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-880"></span><span>
</span><span id="line-881"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409872"><span class="annot"><span class="annottext">lq :: GQLQueryWithText
</span><a href="#local-6989586621688409872"><span class="hs-identifier hs-var">lq</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#GQLQueryWithText"><span class="hs-identifier hs-type">GQLQueryWithText</span></a></span><span> </span><span id="local-6989586621688409870"><span class="annot"><span class="annottext">(Text, GQLQuery)
</span><a href="#local-6989586621688409870"><span class="hs-identifier hs-var">lqq</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ListedQuery -&gt; GQLQueryWithText
</span><a href="Hasura.RQL.Types.QueryCollection.html#_lqQuery"><span class="hs-identifier hs-var hs-var">_lqQuery</span></a></span><span> </span><span class="annot"><span class="annottext">ListedQuery
</span><a href="#local-6989586621688409877"><span class="hs-identifier hs-var">listedQuery</span></a></span><span>
</span><span id="line-882"></span><span>          </span><span id="local-6989586621688409868"><span class="annot"><span class="annottext">ds :: [ExecutableDefinition Name]
</span><a href="#local-6989586621688409868"><span class="hs-identifier hs-var hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExecutableDocument Name -&gt; [ExecutableDefinition Name]
forall var. ExecutableDocument var -&gt; [ExecutableDefinition var]
</span><span class="hs-identifier hs-var hs-var">G.getExecutableDefinitions</span></span><span> </span><span class="annot"><span class="annottext">(ExecutableDocument Name -&gt; [ExecutableDefinition Name])
-&gt; ExecutableDocument Name -&gt; [ExecutableDefinition Name]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GQLQuery -&gt; ExecutableDocument Name
</span><a href="Hasura.RQL.Types.QueryCollection.html#unGQLQuery"><span class="hs-identifier hs-var hs-var">unGQLQuery</span></a></span><span> </span><span class="annot"><span class="annottext">(GQLQuery -&gt; ExecutableDocument Name)
-&gt; GQLQuery -&gt; ExecutableDocument Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Text, GQLQuery) -&gt; GQLQuery
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Text, GQLQuery)
</span><a href="#local-6989586621688409870"><span class="hs-identifier hs-var">lqq</span></a></span><span>
</span><span id="line-883"></span><span>
</span><span id="line-884"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[ExecutableDefinition Name]
</span><a href="#local-6989586621688409868"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-885"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">G.ExecutableDefinitionOperation</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">G.OperationDefinitionTyped</span></span><span> </span><span id="local-6989586621688409863"><span class="annot"><span class="annottext">TypedOperationDefinition FragmentSpread Name
</span><a href="#local-6989586621688409863"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-886"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypedOperationDefinition FragmentSpread Name -&gt; OperationType
forall (frag :: * -&gt; *) var.
TypedOperationDefinition frag var -&gt; OperationType
</span><span class="hs-identifier hs-var hs-var">G._todType</span></span><span> </span><span class="annot"><span class="annottext">TypedOperationDefinition FragmentSpread Name
</span><a href="#local-6989586621688409863"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">OperationType -&gt; OperationType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">OperationType
</span><span class="hs-identifier hs-var">G.OperationTypeSubscription</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-887"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw405"><span class="hs-identifier hs-var">throw405</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;query with name &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QueryName -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">QueryName
</span><a href="#local-6989586621688409881"><span class="hs-identifier hs-var">queryName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; is a subscription&quot;</span></span><span>
</span><span id="line-888"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-889"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#BadRequest"><span class="hs-identifier hs-var">BadRequest</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;query with name &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QueryName -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">QueryName
</span><a href="#local-6989586621688409881"><span class="hs-identifier hs-var">queryName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; has no definitions.&quot;</span></span><span>
</span><span id="line-890"></span><span>        </span><span class="annot"><span class="annottext">[ExecutableDefinition Name]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#BadRequest"><span class="hs-identifier hs-var">BadRequest</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;query with name &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QueryName -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">QueryName
</span><a href="#local-6989586621688409881"><span class="hs-identifier hs-var">queryName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; has multiple definitions.&quot;</span></span><span>
</span><span id="line-891"></span><span>
</span><span id="line-892"></span><span>      </span><span class="annot"><span class="annottext">GQLQueryWithText -&gt; m GQLQueryWithText
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">GQLQueryWithText
</span><a href="#local-6989586621688409872"><span class="hs-identifier hs-var">lq</span></a></span><span>
</span><span id="line-893"></span><span>
</span><span id="line-894"></span><span>    </span><span class="annot"><a href="#local-6989586621688409858"><span class="hs-identifier hs-type">mkEventTriggerMetadataObject</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-895"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688410708"><span class="annot"><a href="#local-6989586621688410708"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688410710"><span class="annot"><a href="#local-6989586621688410710"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621688410709"><span class="annot"><a href="#local-6989586621688410709"><span class="hs-identifier hs-type">c</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-896"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410708"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-897"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688410710"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688410709"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410708"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RecreateEventTriggers"><span class="hs-identifier hs-type">RecreateEventTriggers</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventTriggerConf"><span class="hs-identifier hs-type">EventTriggerConf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410708"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-898"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span>
</span><span id="line-899"></span><span>    </span><span id="local-6989586621688409858"><span class="annot"><span class="annottext">mkEventTriggerMetadataObject :: (a, SourceName, c, TableName b, RecreateEventTriggers,
 EventTriggerConf b)
-&gt; MetadataObject
</span><a href="#local-6989586621688409858"><span class="hs-identifier hs-var hs-var">mkEventTriggerMetadataObject</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409857"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688409857"><span class="hs-identifier hs-var">source</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409856"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409856"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409855"><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621688409855"><span class="hs-identifier hs-var">eventTriggerConf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-900"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409854"><span class="annot"><span class="annottext">objectId :: MetadataObjId
</span><a href="#local-6989586621688409854"><span class="hs-identifier hs-var hs-var">objectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-901"></span><span>            </span><span class="annot"><span class="annottext">SourceName -&gt; AnyBackend SourceMetadataObjId -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOSourceObjId"><span class="hs-identifier hs-var">MOSourceObjId</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688409857"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">(AnyBackend SourceMetadataObjId -&gt; MetadataObjId)
-&gt; AnyBackend SourceMetadataObjId -&gt; MetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-902"></span><span>              </span><span class="annot"><span class="annottext">SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId)
-&gt; SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-903"></span><span>                </span><span class="annot"><span class="annottext">TableName b -&gt; TableMetadataObjId -&gt; SourceMetadataObjId b
forall (b :: BackendType).
TableName b -&gt; TableMetadataObjId -&gt; SourceMetadataObjId b
</span><a href="Hasura.RQL.Types.Metadata.Object.html#SMOTableObj"><span class="hs-identifier hs-var">SMOTableObj</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410708"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409856"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">(TableMetadataObjId -&gt; SourceMetadataObjId b)
-&gt; TableMetadataObjId -&gt; SourceMetadataObjId b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-904"></span><span>                  </span><span class="annot"><span class="annottext">TriggerName -&gt; TableMetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MTOTrigger"><span class="hs-identifier hs-var">MTOTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">(TriggerName -&gt; TableMetadataObjId)
-&gt; TriggerName -&gt; TableMetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-905"></span><span>                    </span><span class="annot"><span class="annottext">EventTriggerConf b -&gt; TriggerName
forall (b :: BackendType). EventTriggerConf b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etcName"><span class="hs-identifier hs-var hs-var">etcName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621688409855"><span class="hs-identifier hs-var">eventTriggerConf</span></a></span><span>
</span><span id="line-906"></span><span>          </span><span id="local-6989586621688409850"><span class="annot"><span class="annottext">definition :: Value
</span><a href="#local-6989586621688409850"><span class="hs-identifier hs-var hs-var">definition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;table&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; TableName b -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409856"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;configuration&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; EventTriggerConf b -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621688409855"><span class="hs-identifier hs-var">eventTriggerConf</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-907"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="#local-6989586621688409854"><span class="hs-identifier hs-var">objectId</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688409850"><span class="hs-identifier hs-var">definition</span></a></span><span>
</span><span id="line-908"></span><span>
</span><span id="line-909"></span><span>    </span><span id="local-6989586621688409847"><span class="annot"><span class="annottext">mkCronTriggerMetadataObject :: CronTriggerMetadata -&gt; MetadataObject
</span><a href="#local-6989586621688409847"><span class="hs-identifier hs-var hs-var">mkCronTriggerMetadataObject</span></a></span></span><span> </span><span id="local-6989586621688409846"><span class="annot"><span class="annottext">CronTriggerMetadata
</span><a href="#local-6989586621688409846"><span class="hs-identifier hs-var">catalogCronTrigger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-910"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409845"><span class="annot"><span class="annottext">definition :: Value
</span><a href="#local-6989586621688409845"><span class="hs-identifier hs-var hs-var">definition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata
</span><a href="#local-6989586621688409846"><span class="hs-identifier hs-var">catalogCronTrigger</span></a></span><span>
</span><span id="line-911"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span>
</span><span id="line-912"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOCronTrigger"><span class="hs-identifier hs-var">MOCronTrigger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CronTriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.ScheduledTrigger.html#ctName"><span class="hs-identifier hs-var hs-var">ctName</span></a></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata
</span><a href="#local-6989586621688409846"><span class="hs-identifier hs-var">catalogCronTrigger</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span>            </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688409845"><span class="hs-identifier hs-var">definition</span></a></span><span>
</span><span id="line-914"></span><span>
</span><span id="line-915"></span><span>    </span><span id="local-6989586621688409905"><span class="annot"><span class="annottext">mkActionMetadataObject :: ActionMetadata -&gt; MetadataObject
</span><a href="#local-6989586621688409905"><span class="hs-identifier hs-var hs-var">mkActionMetadataObject</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionMetadata"><span class="hs-identifier hs-type">ActionMetadata</span></a></span><span> </span><span id="local-6989586621688409841"><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621688409841"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621688409840"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688409840"><span class="hs-identifier hs-var">comment</span></a></span></span><span> </span><span id="local-6989586621688409839"><span class="annot"><span class="annottext">ActionDefinitionInput
</span><a href="#local-6989586621688409839"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span class="annot"><span class="annottext">[ActionPermissionMetadata]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-916"></span><span>      </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ActionName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOAction"><span class="hs-identifier hs-var">MOAction</span></a></span><span> </span><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621688409841"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CreateAction -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">(CreateAction -&gt; Value) -&gt; CreateAction -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ActionName -&gt; ActionDefinitionInput -&gt; Maybe Text -&gt; CreateAction
</span><a href="Hasura.RQL.DDL.Action.html#CreateAction"><span class="hs-identifier hs-var">CreateAction</span></a></span><span> </span><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621688409841"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">ActionDefinitionInput
</span><a href="#local-6989586621688409839"><span class="hs-identifier hs-var">defn</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688409840"><span class="hs-identifier hs-var">comment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-917"></span><span>
</span><span id="line-918"></span><span>    </span><span id="local-6989586621688409836"><span class="annot"><span class="annottext">mkRemoteSchemaMetadataObject :: RemoteSchemaMetadata -&gt; MetadataObject
</span><a href="#local-6989586621688409836"><span class="hs-identifier hs-var hs-var">mkRemoteSchemaMetadataObject</span></a></span></span><span> </span><span id="local-6989586621688409835"><span class="annot"><span class="annottext">RemoteSchemaMetadata
</span><a href="#local-6989586621688409835"><span class="hs-identifier hs-var">remoteSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-919"></span><span>      </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MORemoteSchema"><span class="hs-identifier hs-var">MORemoteSchema</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaMetadata -&gt; RemoteSchemaName
</span><a href="Hasura.RQL.Types.Metadata.html#_rsmName"><span class="hs-identifier hs-var hs-var">_rsmName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadata
</span><a href="#local-6989586621688409835"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaMetadata -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadata
</span><a href="#local-6989586621688409835"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span>    </span><span id="local-6989586621688409832"><span class="annot"><span class="annottext">mkInheritedRoleMetadataObject :: Role -&gt; MetadataObject
</span><a href="#local-6989586621688409832"><span class="hs-identifier hs-var hs-var">mkInheritedRoleMetadataObject</span></a></span></span><span> </span><span id="local-6989586621688409831"><span class="annot"><span class="annottext">inheritedRole :: Role
</span><a href="#local-6989586621688409831"><span class="hs-identifier hs-var">inheritedRole</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span id="local-6989586621688409830"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409830"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span class="annot"><span class="annottext">ParentRoles
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-922"></span><span>      </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOInheritedRole"><span class="hs-identifier hs-var">MOInheritedRole</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409830"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688409831"><span class="hs-identifier hs-var">inheritedRole</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-923"></span><span>
</span><span id="line-924"></span><span>    </span><span class="annot"><a href="#local-6989586621688409975"><span class="hs-identifier hs-type">alignExtraRemoteSchemaInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-925"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688410847"><span class="annot"><a href="#local-6989586621688410847"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621688410848"><span class="annot"><a href="#local-6989586621688410848"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688410849"><span class="annot"><a href="#local-6989586621688410849"><span class="hs-identifier hs-type">arr</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-926"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410849"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410849"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410849"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-927"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688410848"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-928"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410847"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-929"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">M.HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621688410848"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-930"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-931"></span><span>        </span><span class="annot"><a href="#local-6989586621688410849"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688410847"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621688410848"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-932"></span><span>    </span><span id="local-6989586621688409975"><span class="annot"><span class="annottext">alignExtraRemoteSchemaInfo :: (b -&gt; MetadataObject)
-&gt; arr
     (HashMap RemoteSchemaName a, HashMap RemoteSchemaName [b])
     (HashMap RemoteSchemaName (a, [b]))
</span><a href="#local-6989586621688409975"><span class="hs-identifier hs-var hs-var">alignExtraRemoteSchemaInfo</span></a></span></span><span> </span><span id="local-6989586621688409828"><span class="annot"><span class="annottext">b -&gt; MetadataObject
</span><a href="#local-6989586621688409828"><span class="hs-identifier hs-var">mkMetadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409827"><span class="annot"><span class="annottext">HashMap RemoteSchemaName a
</span><a href="#local-6989586621688409827"><span class="hs-identifier hs-var">baseInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409826"><span class="annot"><span class="annottext">HashMap RemoteSchemaName [b]
</span><a href="#local-6989586621688409826"><span class="hs-identifier hs-var">extraInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-933"></span><span>      </span><span id="local-6989586621688409825"><span class="annot"><span class="annottext">HashMap RemoteSchemaName (Maybe (a, [b]))
</span><a href="#local-6989586621688409825"><span class="hs-identifier hs-var">combinedInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-934"></span><span>        </span><span class="hs-glyph">(|</span><span>
</span><span id="line-935"></span><span>          </span><span class="annot"><span class="annottext">forall a.
arr (a, (RemoteSchemaName, (These a [b], ()))) (Maybe (a, [b]))
-&gt; arr
     (a, (HashMap RemoteSchemaName (These a [b]), ()))
     (HashMap RemoteSchemaName (Maybe (a, [b])))
forall (arr :: * -&gt; * -&gt; *) k e a s b.
(ArrowDistribute arr, Eq k, Hashable k) =&gt;
arr (e, (k, (a, s))) b -&gt; arr (e, (HashMap k a, s)) (HashMap k b)
</span><a href="Hasura.Incremental.Internal.Rule.html#keyed"><span class="hs-identifier hs-var">Inc.keyed</span></a></span><span>
</span><span id="line-936"></span><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688409824"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409824"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span></span><span> </span><span id="local-6989586621688409823"><span class="annot"><span class="annottext">These a [b]
</span><a href="#local-6989586621688409823"><span class="hs-identifier hs-var">infos</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">arr (RemoteSchemaName, These a [b]) (Maybe (a, [b]))
</span><a href="#local-6989586621688409822"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409824"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">These a [b]
</span><a href="#local-6989586621688409823"><span class="hs-identifier hs-var">infos</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-937"></span><span>          </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap RemoteSchemaName a
-&gt; HashMap RemoteSchemaName [b]
-&gt; HashMap RemoteSchemaName (These a [b])
forall (f :: * -&gt; *) a b.
Semialign f =&gt;
f a -&gt; f b -&gt; f (These a b)
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="annot"><span class="annottext">HashMap RemoteSchemaName a
</span><a href="#local-6989586621688409827"><span class="hs-identifier hs-var">baseInfo</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RemoteSchemaName [b]
</span><a href="#local-6989586621688409826"><span class="hs-identifier hs-var">extraInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-938"></span><span>      </span><span class="annot"><span class="annottext">arr
  (HashMap RemoteSchemaName (a, [b]))
  (HashMap RemoteSchemaName (a, [b]))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">HashMap RemoteSchemaName (Maybe (a, [b]))
-&gt; HashMap RemoteSchemaName (a, [b])
forall k v. HashMap k (Maybe v) -&gt; HashMap k v
</span><a href="Data.HashMap.Strict.Extended.html#catMaybes"><span class="hs-identifier hs-var">M.catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RemoteSchemaName (Maybe (a, [b]))
</span><a href="#local-6989586621688409825"><span class="hs-identifier hs-var">combinedInfo</span></a></span><span>
</span><span id="line-939"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-940"></span><span>        </span><span class="annot"><a href="#local-6989586621688409822"><span class="hs-identifier hs-type">combine</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span class="annot"><a href="#local-6989586621688410847"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621688410848"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410849"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688410847"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621688410848"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-941"></span><span>        </span><span id="local-6989586621688409822"><span class="annot"><span class="annottext">combine :: arr (RemoteSchemaName, These a [b]) (Maybe (a, [b]))
</span><a href="#local-6989586621688409822"><span class="hs-identifier hs-var hs-var">combine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409821"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409821"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409820"><span class="annot"><span class="annottext">These a [b]
</span><a href="#local-6989586621688409820"><span class="hs-identifier hs-var">infos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">These a [b]
</span><a href="#local-6989586621688409820"><span class="hs-identifier hs-var">infos</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-942"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">This</span></span><span> </span><span id="local-6989586621688409818"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688409818"><span class="hs-identifier hs-var">base</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">arr (Maybe (a, [b])) (Maybe (a, [b]))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">(a, [b]) -&gt; Maybe (a, [b])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688409818"><span class="hs-identifier hs-var">base</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-943"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span id="local-6989586621688409816"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688409816"><span class="hs-identifier hs-var">base</span></a></span></span><span> </span><span id="local-6989586621688409815"><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621688409815"><span class="hs-identifier hs-var">extras</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">arr (Maybe (a, [b])) (Maybe (a, [b]))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">(a, [b]) -&gt; Maybe (a, [b])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688409816"><span class="hs-identifier hs-var">base</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621688409815"><span class="hs-identifier hs-var">extras</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">That</span></span><span> </span><span id="local-6989586621688409813"><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621688409813"><span class="hs-identifier hs-var">extras</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-945"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409812"><span class="annot"><span class="annottext">errorMessage :: Text
</span><a href="#local-6989586621688409812"><span class="hs-identifier hs-var hs-var">errorMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;remote schema  &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; NonEmptyText
</span><a href="Hasura.RQL.Types.RemoteSchema.html#unRemoteSchemaName"><span class="hs-identifier hs-var hs-var">unRemoteSchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409821"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmptyText -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; does not exist&quot;</span></span><span>
</span><span id="line-946"></span><span>            </span><span class="annot"><span class="annottext">arr ([MetadataObject], Text) ()
forall w (arr :: * -&gt; * -&gt; *).
(ArrowWriter (Seq w) arr, AsInconsistentMetadata w) =&gt;
arr ([MetadataObject], Text) ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordInconsistencies"><span class="hs-identifier hs-var">recordInconsistencies</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(b -&gt; MetadataObject) -&gt; [b] -&gt; [MetadataObject]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; MetadataObject
</span><a href="#local-6989586621688409828"><span class="hs-identifier hs-var">mkMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621688409813"><span class="hs-identifier hs-var">extras</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409812"><span class="hs-identifier hs-var">errorMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-947"></span><span>            </span><span class="annot"><span class="annottext">arr (Maybe (a, [b])) (Maybe (a, [b]))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Maybe (a, [b])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-948"></span><span>
</span><span id="line-949"></span><span>    </span><span id="local-6989586621688410842"><span id="local-6989586621688410843"><span class="annot"><a href="#local-6989586621688409968"><span class="hs-identifier hs-type">buildRemoteSchemaPermissions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-950"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410843"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-951"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410843"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-952"></span><span>        </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410843"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-953"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410842"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410843"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-954"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410842"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-955"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-956"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#RemoteSchemaCtx"><span class="hs-identifier hs-type">RemoteSchemaCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#AddRemoteSchemaPermission"><span class="hs-identifier hs-type">AddRemoteSchemaPermission</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410843"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.HashMap</span></span><span> </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#IntrospectionResult"><span class="hs-identifier hs-type">IntrospectionResult</span></a></span></span></span><span>
</span><span id="line-957"></span><span>    </span><span id="local-6989586621688409968"><span class="annot"><span class="annottext">buildRemoteSchemaPermissions :: arr
  (RemoteSchemaCtx, [AddRemoteSchemaPermission])
  (HashMap RoleName IntrospectionResult)
</span><a href="#local-6989586621688409968"><span class="hs-identifier hs-var hs-var">buildRemoteSchemaPermissions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AddRemoteSchemaPermission -&gt; RoleName)
-&gt; (AddRemoteSchemaPermission -&gt; MetadataObject)
-&gt; arr
     (RemoteSchemaCtx, AddRemoteSchemaPermission)
     (Maybe IntrospectionResult)
-&gt; arr
     (RemoteSchemaCtx, [AddRemoteSchemaPermission])
     (HashMap RoleName IntrospectionResult)
forall (arr :: * -&gt; * -&gt; *) k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, Eq k, Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMap"><span class="hs-identifier hs-var">buildInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">AddRemoteSchemaPermission -&gt; RoleName
</span><a href="Hasura.RQL.Types.RemoteSchema.html#_arspRole"><span class="hs-identifier hs-var hs-var">_arspRole</span></a></span><span> </span><span class="annot"><span class="annottext">AddRemoteSchemaPermission -&gt; MetadataObject
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkRemoteSchemaPermissionMetadataObject"><span class="hs-identifier hs-var">mkRemoteSchemaPermissionMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">arr
  (RemoteSchemaCtx, AddRemoteSchemaPermission)
  (Maybe IntrospectionResult)
</span><a href="#local-6989586621688409809"><span class="hs-identifier hs-var">buildRemoteSchemaPermission</span></a></span><span>
</span><span id="line-958"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-959"></span><span>        </span><span id="local-6989586621688409809"><span class="annot"><span class="annottext">buildRemoteSchemaPermission :: arr
  (RemoteSchemaCtx, AddRemoteSchemaPermission)
  (Maybe IntrospectionResult)
</span><a href="#local-6989586621688409809"><span class="hs-identifier hs-var hs-var">buildRemoteSchemaPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409808"><span class="annot"><span class="annottext">RemoteSchemaCtx
</span><a href="#local-6989586621688409808"><span class="hs-identifier hs-var">remoteSchemaCtx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409807"><span class="annot"><span class="annottext">AddRemoteSchemaPermission
</span><a href="#local-6989586621688409807"><span class="hs-identifier hs-var">remoteSchemaPerm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-960"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#AddRemoteSchemaPermission"><span class="hs-identifier hs-type">AddRemoteSchemaPermission</span></a></span><span> </span><span id="local-6989586621688409806"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409806"><span class="hs-identifier hs-var">rsName</span></a></span></span><span> </span><span id="local-6989586621688409805"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409805"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621688409804"><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621688409804"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AddRemoteSchemaPermission
</span><a href="#local-6989586621688409807"><span class="hs-identifier hs-var">remoteSchemaPerm</span></a></span><span>
</span><span id="line-961"></span><span>              </span><span id="local-6989586621688409803"><span class="annot"><span class="annottext">metadataObject :: MetadataObject
</span><a href="#local-6989586621688409803"><span class="hs-identifier hs-var hs-var">metadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AddRemoteSchemaPermission -&gt; MetadataObject
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkRemoteSchemaPermissionMetadataObject"><span class="hs-identifier hs-var">mkRemoteSchemaPermissionMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">AddRemoteSchemaPermission
</span><a href="#local-6989586621688409807"><span class="hs-identifier hs-var">remoteSchemaPerm</span></a></span><span>
</span><span id="line-962"></span><span>              </span><span id="local-6989586621688409802"><span class="annot"><span class="annottext">schemaObject :: SchemaObjId
</span><a href="#local-6989586621688409802"><span class="hs-identifier hs-var hs-var">schemaObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; RoleName -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SORemoteSchemaPermission"><span class="hs-identifier hs-var">SORemoteSchemaPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409806"><span class="hs-identifier hs-var">rsName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409805"><span class="hs-identifier hs-var">roleName</span></a></span><span>
</span><span id="line-963"></span><span>              </span><span id="local-6989586621688409800"><span class="annot"><span class="annottext">providedSchemaDoc :: SchemaDocument
</span><a href="#local-6989586621688409800"><span class="hs-identifier hs-var hs-var">providedSchemaDoc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition -&gt; SchemaDocument
</span><a href="Hasura.RQL.Types.RemoteSchema.html#_rspdSchema"><span class="hs-identifier hs-var hs-var">_rspdSchema</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621688409804"><span class="hs-identifier hs-var">defn</span></a></span><span>
</span><span id="line-964"></span><span>              </span><span id="local-6989586621688409798"><span class="annot"><span class="annottext">addPermContext :: Text -&gt; Text
</span><a href="#local-6989586621688409798"><span class="hs-identifier hs-var hs-var">addPermContext</span></a></span></span><span> </span><span id="local-6989586621688409797"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409797"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in remote schema permission for role &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409805"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409797"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-965"></span><span>          </span><span class="hs-glyph">(|</span><span>
</span><span id="line-966"></span><span>            </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) IntrospectionResult
-&gt; arr (a, (MetadataObject, ())) (Maybe IntrospectionResult)
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-967"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-968"></span><span>                  </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) IntrospectionResult
-&gt; ErrorA QErr arr (a, (Text -&gt; Text, ())) IntrospectionResult
forall (arr :: * -&gt; * -&gt; *) e s a.
ArrowError QErr arr =&gt;
arr (e, s) a -&gt; arr (e, (Text -&gt; Text, s)) a
</span><a href="Hasura.Base.Error.html#modifyErrA"><span class="hs-identifier hs-var">modifyErrA</span></a></span><span>
</span><span id="line-969"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-970"></span><span>                        </span><span class="annot"><span class="annottext">ErrorA QErr arr (m ()) ()
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span>
</span><span id="line-971"></span><span>                          </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-972"></span><span>                            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688409805"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RoleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="Hasura.Session.html#adminRoleName"><span class="hs-identifier hs-var">adminRoleName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-973"></span><span>                              </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#ConstraintViolation"><span class="hs-identifier hs-var">ConstraintViolation</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cannot define permission for admin role&quot;</span></span><span>
</span><span id="line-974"></span><span>                        </span><span class="hs-special">(</span><span id="local-6989586621688409793"><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621688409793"><span class="hs-identifier hs-var">resolvedSchemaIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409792"><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688409792"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-975"></span><span>                          </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (m (IntrospectionResult, [SchemaDependency]))
  (IntrospectionResult, [SchemaDependency])
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">SchemaDocument
-&gt; RemoteSchemaCtx -&gt; m (IntrospectionResult, [SchemaDependency])
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
SchemaDocument
-&gt; RemoteSchemaCtx -&gt; m (IntrospectionResult, [SchemaDependency])
</span><a href="Hasura.RQL.DDL.RemoteSchema.Permission.html#resolveRoleBasedRemoteSchema"><span class="hs-identifier hs-var">resolveRoleBasedRemoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaDocument
</span><a href="#local-6989586621688409800"><span class="hs-identifier hs-var">providedSchemaDoc</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaCtx
</span><a href="#local-6989586621688409808"><span class="hs-identifier hs-var">remoteSchemaCtx</span></a></span><span>
</span><span id="line-976"></span><span>                        </span><span class="annot"><span class="annottext">ErrorA
  QErr arr (MetadataObject, SchemaObjId, [SchemaDependency]) ()
forall (arr :: * -&gt; * -&gt; *).
ArrowWriter (Seq CollectedInfo) arr =&gt;
arr (MetadataObject, SchemaObjId, [SchemaDependency]) ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordDependencies"><span class="hs-identifier hs-var">recordDependencies</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688409803"><span class="hs-identifier hs-var">metadataObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SchemaObjId
</span><a href="#local-6989586621688409802"><span class="hs-identifier hs-var">schemaObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688409792"><span class="hs-identifier hs-var">dependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-977"></span><span>                        </span><span class="annot"><span class="annottext">ErrorA QErr arr IntrospectionResult IntrospectionResult
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621688409793"><span class="hs-identifier hs-var">resolvedSchemaIntrospection</span></a></span><span>
</span><span id="line-978"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-979"></span><span>                </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621688409798"><span class="hs-identifier hs-var">addPermContext</span></a></span><span>
</span><span id="line-980"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-981"></span><span>            </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688409803"><span class="hs-identifier hs-var">metadataObject</span></a></span><span>
</span><span id="line-982"></span><span>
</span><span id="line-983"></span><span>    </span><span class="annot"><a href="#local-6989586621688410128"><span class="hs-identifier hs-type">buildTableEventTriggers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-984"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688410994"><span class="annot"><a href="#local-6989586621688410994"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688410993"><span class="annot"><a href="#local-6989586621688410993"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688410992"><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-985"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410994"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-986"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410994"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-987"></span><span>        </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410994"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-988"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410993"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410994"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-989"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688410993"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-990"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410993"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-991"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688410993"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-992"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#BuildReason"><span class="hs-identifier hs-type">BuildReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410993"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-993"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.html#HasServerConfigCtx"><span class="hs-identifier hs-type">HasServerConfigCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410993"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-994"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-995"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-996"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-997"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-998"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-999"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#TableCoreInfo"><span class="hs-identifier hs-type">TableCoreInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1000"></span><span>        </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventTriggerConf"><span class="hs-identifier hs-type">EventTriggerConf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-1001"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Dependency"><span class="hs-identifier hs-type">Inc.Dependency</span></a></span><span> </span><span class="annot"><a href="Hasura.Incremental.html#InvalidationKey"><span class="hs-identifier hs-type">Inc.InvalidationKey</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1002"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RecreateEventTriggers"><span class="hs-identifier hs-type">RecreateEventTriggers</span></a></span><span>
</span><span id="line-1003"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-1004"></span><span>        </span><span class="annot"><a href="#local-6989586621688410994"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventTriggerInfoMap"><span class="hs-identifier hs-type">EventTriggerInfoMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1005"></span><span>    </span><span id="local-6989586621688410128"><span class="annot"><span class="annottext">buildTableEventTriggers :: arr
  (SourceName, SourceConfig b, TableCoreInfo b, [EventTriggerConf b],
   Dependency InvalidationKey, RecreateEventTriggers)
  (EventTriggerInfoMap b)
</span><a href="#local-6989586621688410128"><span class="hs-identifier hs-var hs-var">buildTableEventTriggers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409791"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688409791"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409790"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688409790"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409789"><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688409789"><span class="hs-identifier hs-var">tableInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409788"><span class="annot"><span class="annottext">[EventTriggerConf b]
</span><a href="#local-6989586621688409788"><span class="hs-identifier hs-var">eventTriggerConfs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409787"><span class="annot"><span class="annottext">Dependency InvalidationKey
</span><a href="#local-6989586621688409787"><span class="hs-identifier hs-var">metadataInvalidationKey</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409786"><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="#local-6989586621688409786"><span class="hs-identifier hs-var">recreateEventTriggers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1006"></span><span>      </span><span class="annot"><span class="annottext">((Dependency InvalidationKey, SourceName, SourceConfig b,
  TableName b, RecreateEventTriggers, EventTriggerConf b)
 -&gt; TriggerName)
-&gt; ((Dependency InvalidationKey, SourceName, SourceConfig b,
     TableName b, RecreateEventTriggers, EventTriggerConf b)
    -&gt; MetadataObject)
-&gt; arr
     (TableCoreInfo b,
      (Dependency InvalidationKey, SourceName, SourceConfig b,
       TableName b, RecreateEventTriggers, EventTriggerConf b))
     (Maybe (EventTriggerInfo b))
-&gt; arr
     (TableCoreInfo b,
      [(Dependency InvalidationKey, SourceName, SourceConfig b,
        TableName b, RecreateEventTriggers, EventTriggerConf b)])
     (EventTriggerInfoMap b)
forall (arr :: * -&gt; * -&gt; *) k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, Eq k, Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMap"><span class="hs-identifier hs-var">buildInfoMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerConf b -&gt; TriggerName
forall (b :: BackendType). EventTriggerConf b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etcName"><span class="hs-identifier hs-var hs-var">etcName</span></a></span><span> </span><span class="annot"><span class="annottext">(EventTriggerConf b -&gt; TriggerName)
-&gt; ((Dependency InvalidationKey, SourceName, SourceConfig b,
     TableName b, RecreateEventTriggers, EventTriggerConf b)
    -&gt; EventTriggerConf b)
-&gt; (Dependency InvalidationKey, SourceName, SourceConfig b,
    TableName b, RecreateEventTriggers, EventTriggerConf b)
-&gt; TriggerName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Dependency InvalidationKey, SourceName, SourceConfig b,
 TableName b, RecreateEventTriggers, EventTriggerConf b)
-&gt; Getting
     (EventTriggerConf b)
     (Dependency InvalidationKey, SourceName, SourceConfig b,
      TableName b, RecreateEventTriggers, EventTriggerConf b)
     (EventTriggerConf b)
-&gt; EventTriggerConf b
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (EventTriggerConf b)
  (Dependency InvalidationKey, SourceName, SourceConfig b,
   TableName b, RecreateEventTriggers, EventTriggerConf b)
  (EventTriggerConf b)
forall s t a b. Field6 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_6</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a c.
Backend b =&gt;
(a, SourceName, c, TableName b, RecreateEventTriggers,
 EventTriggerConf b)
-&gt; MetadataObject
forall (b :: BackendType) a c.
Backend b =&gt;
(a, SourceName, c, TableName b, RecreateEventTriggers,
 EventTriggerConf b)
-&gt; MetadataObject
</span><a href="#local-6989586621688409858"><span class="hs-identifier hs-var">mkEventTriggerMetadataObject</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">arr
  (TableCoreInfo b,
   (Dependency InvalidationKey, SourceName, SourceConfig b,
    TableName b, RecreateEventTriggers, EventTriggerConf b))
  (Maybe (EventTriggerInfo b))
</span><a href="#local-6989586621688409784"><span class="hs-identifier hs-var">buildEventTrigger</span></a></span><span>
</span><span id="line-1007"></span><span>        </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-1008"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688409789"><span class="hs-identifier hs-var">tableInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(EventTriggerConf b
 -&gt; (Dependency InvalidationKey, SourceName, SourceConfig b,
     TableName b, RecreateEventTriggers, EventTriggerConf b))
-&gt; [EventTriggerConf b]
-&gt; [(Dependency InvalidationKey, SourceName, SourceConfig b,
     TableName b, RecreateEventTriggers, EventTriggerConf b)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dependency InvalidationKey
</span><a href="#local-6989586621688409787"><span class="hs-identifier hs-var">metadataInvalidationKey</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688409791"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688409790"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TableCoreInfo b -&gt; TableName b
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn -&gt; TableName b
</span><a href="Hasura.RQL.Types.Table.html#_tciName"><span class="hs-identifier hs-var hs-var">_tciName</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688409789"><span class="hs-identifier hs-var">tableInfo</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="#local-6989586621688409786"><span class="hs-identifier hs-var">recreateEventTriggers</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EventTriggerConf b]
</span><a href="#local-6989586621688409788"><span class="hs-identifier hs-var">eventTriggerConfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1009"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1010"></span><span>        </span><span id="local-6989586621688409784"><span class="annot"><span class="annottext">buildEventTrigger :: arr
  (TableCoreInfo b,
   (Dependency InvalidationKey, SourceName, SourceConfig b,
    TableName b, RecreateEventTriggers, EventTriggerConf b))
  (Maybe (EventTriggerInfo b))
</span><a href="#local-6989586621688409784"><span class="hs-identifier hs-var hs-var">buildEventTrigger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409782"><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688409782"><span class="hs-identifier hs-var">tableInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409781"><span class="annot"><span class="annottext">Dependency InvalidationKey
</span><a href="#local-6989586621688409781"><span class="hs-identifier hs-var">metadataInvalidationKey</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409780"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688409780"><span class="hs-identifier hs-var">source</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409779"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688409779"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409778"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409778"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409777"><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="#local-6989586621688409777"><span class="hs-identifier hs-var">recreateEventTriggers</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409776"><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621688409776"><span class="hs-identifier hs-var">eventTriggerConf</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1011"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409775"><span class="annot"><span class="annottext">triggerName :: TriggerName
</span><a href="#local-6989586621688409775"><span class="hs-identifier hs-var hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b -&gt; TriggerName
forall (b :: BackendType). EventTriggerConf b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etcName"><span class="hs-identifier hs-var hs-var">etcName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621688409776"><span class="hs-identifier hs-var">eventTriggerConf</span></a></span><span>
</span><span id="line-1012"></span><span>              </span><span id="local-6989586621688409774"><span class="annot"><span class="annottext">metadataObject :: MetadataObject
</span><a href="#local-6989586621688409774"><span class="hs-identifier hs-var hs-var">metadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Dependency InvalidationKey, SourceName, SourceConfig b,
 TableName b, RecreateEventTriggers, EventTriggerConf b)
-&gt; MetadataObject
forall (b :: BackendType) a c.
Backend b =&gt;
(a, SourceName, c, TableName b, RecreateEventTriggers,
 EventTriggerConf b)
-&gt; MetadataObject
</span><a href="#local-6989586621688409858"><span class="hs-identifier hs-var">mkEventTriggerMetadataObject</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dependency InvalidationKey
</span><a href="#local-6989586621688409781"><span class="hs-identifier hs-var">metadataInvalidationKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688409780"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688409779"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409778"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="#local-6989586621688409777"><span class="hs-identifier hs-var">recreateEventTriggers</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621688409776"><span class="hs-identifier hs-var">eventTriggerConf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1013"></span><span>              </span><span id="local-6989586621688409773"><span class="annot"><span class="annottext">schemaObjectId :: SchemaObjId
</span><a href="#local-6989586621688409773"><span class="hs-identifier hs-var hs-var">schemaObjectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1014"></span><span>                </span><span class="annot"><span class="annottext">SourceName -&gt; AnyBackend SourceObjId -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOSourceObj"><span class="hs-identifier hs-var">SOSourceObj</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688409780"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">(AnyBackend SourceObjId -&gt; SchemaObjId)
-&gt; AnyBackend SourceObjId -&gt; SchemaObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1015"></span><span>                  </span><span class="annot"><span class="annottext">SourceObjId b -&gt; AnyBackend SourceObjId
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceObjId b -&gt; AnyBackend SourceObjId)
-&gt; SourceObjId b -&gt; AnyBackend SourceObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1016"></span><span>                    </span><span class="annot"><span class="annottext">TableName b -&gt; TableObjId b -&gt; SourceObjId b
forall (b :: BackendType).
TableName b -&gt; TableObjId b -&gt; SourceObjId b
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOITableObj"><span class="hs-identifier hs-var">SOITableObj</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409778"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">(TableObjId b -&gt; SourceObjId b) -&gt; TableObjId b -&gt; SourceObjId b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1017"></span><span>                      </span><span class="annot"><span class="annottext">TriggerName -&gt; TableObjId b
forall (b :: BackendType). TriggerName -&gt; TableObjId b
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#TOTrigger"><span class="hs-identifier hs-var">TOTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688409775"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-1018"></span><span>              </span><span id="local-6989586621688409770"><span class="annot"><span class="annottext">addTriggerContext :: Text -&gt; Text
</span><a href="#local-6989586621688409770"><span class="hs-identifier hs-var hs-var">addTriggerContext</span></a></span></span><span> </span><span id="local-6989586621688409769"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409769"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in event trigger &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688409775"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409769"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1019"></span><span>          </span><span id="local-6989586621688409768"><span class="annot"><span class="annottext">BuildReason
</span><a href="#local-6989586621688409768"><span class="hs-identifier hs-var">buildReason</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr (m BuildReason) BuildReason
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">m BuildReason
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-1020"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409766"><span class="annot"><span class="annottext">reloadMetadataRecreateEventTrigger :: RecreateEventTriggers
</span><a href="#local-6989586621688409766"><span class="hs-identifier hs-var hs-var">reloadMetadataRecreateEventTrigger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1021"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BuildReason
</span><a href="#local-6989586621688409768"><span class="hs-identifier hs-var">buildReason</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1022"></span><span>                  </span><span class="annot"><span class="annottext">BuildReason
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CatalogSync"><span class="hs-identifier hs-var">CatalogSync</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="Hasura.RQL.Types.EventTrigger.html#RETDoNothing"><span class="hs-identifier hs-var">RETDoNothing</span></a></span><span>
</span><span id="line-1023"></span><span>                  </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CatalogUpdate"><span class="hs-identifier hs-type">CatalogUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (HashSet SourceName)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="Hasura.RQL.Types.EventTrigger.html#RETDoNothing"><span class="hs-identifier hs-var">RETDoNothing</span></a></span><span>
</span><span id="line-1024"></span><span>                  </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CatalogUpdate"><span class="hs-identifier hs-type">CatalogUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688409764"><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621688409764"><span class="hs-identifier hs-var">sources</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688409780"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; HashSet SourceName -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621688409764"><span class="hs-identifier hs-var">sources</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="Hasura.RQL.Types.EventTrigger.html#RETRecreate"><span class="hs-identifier hs-var">RETRecreate</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="Hasura.RQL.Types.EventTrigger.html#RETDoNothing"><span class="hs-identifier hs-var">RETDoNothing</span></a></span><span>
</span><span id="line-1025"></span><span>          </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1026"></span><span>            </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) (EventTriggerInfo b)
-&gt; arr (a, (MetadataObject, ())) (Maybe (EventTriggerInfo b))
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-1027"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1028"></span><span>                  </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) (EventTriggerInfo b)
-&gt; ErrorA QErr arr (a, (Text -&gt; Text, ())) (EventTriggerInfo b)
forall (arr :: * -&gt; * -&gt; *) e s a.
ArrowError QErr arr =&gt;
arr (e, s) a -&gt; arr (e, (Text -&gt; Text, s)) a
</span><a href="Hasura.Base.Error.html#modifyErrA"><span class="hs-identifier hs-var">modifyErrA</span></a></span><span>
</span><span id="line-1029"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1030"></span><span>                        </span><span class="hs-special">(</span><span id="local-6989586621688409762"><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688409762"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409761"><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688409761"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (m (EventTriggerInfo b, [SchemaDependency]))
  (EventTriggerInfo b, [SchemaDependency])
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Environment
-&gt; SourceName
-&gt; TableName b
-&gt; EventTriggerConf b
-&gt; m (EventTriggerInfo b, [SchemaDependency])
forall (b :: BackendType) (m :: * -&gt; *).
(Backend b, QErrM m) =&gt;
Environment
-&gt; SourceName
-&gt; TableName b
-&gt; EventTriggerConf b
-&gt; m (EventTriggerInfo b, [SchemaDependency])
</span><a href="Hasura.RQL.DDL.EventTrigger.html#buildEventTriggerInfo"><span class="hs-identifier hs-var">buildEventTriggerInfo</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688410368"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688409780"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409778"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621688409776"><span class="hs-identifier hs-var">eventTriggerConf</span></a></span><span>
</span><span id="line-1031"></span><span>                        </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (TableName b, HashMap FieldName (FieldInfo b), TriggerName,
   TriggerOpsDef b, SourceConfig b,
   Maybe (PrimaryKey b (ColumnInfo b)), RecreateEventTriggers)
  ()
</span><a href="#local-6989586621688409760"><span class="hs-identifier hs-var">recreateTriggerIfNeeded</span></a></span><span>
</span><span id="line-1032"></span><span>                          </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-1033"></span><span>                            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409778"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1034"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableCoreInfo b -&gt; HashMap FieldName (FieldInfo b)
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn -&gt; FieldInfoMap field
</span><a href="Hasura.RQL.Types.Table.html#_tciFieldInfoMap"><span class="hs-identifier hs-var hs-var">_tciFieldInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688409782"><span class="hs-identifier hs-var">tableInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1035"></span><span>                              </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688409775"><span class="hs-identifier hs-var">triggerName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1036"></span><span>                              </span><span class="annot"><span class="annottext">EventTriggerConf b -&gt; TriggerOpsDef b
forall (b :: BackendType). EventTriggerConf b -&gt; TriggerOpsDef b
</span><a href="Hasura.RQL.Types.EventTrigger.html#etcDefinition"><span class="hs-identifier hs-var hs-var">etcDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621688409776"><span class="hs-identifier hs-var">eventTriggerConf</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1037"></span><span>                              </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688409779"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1038"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableCoreInfo b -&gt; Maybe (PrimaryKey b (ColumnInfo b))
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn
-&gt; Maybe (PrimaryKey b primaryKeyColumn)
</span><a href="Hasura.RQL.Types.Table.html#_tciPrimaryKey"><span class="hs-identifier hs-var hs-var">_tciPrimaryKey</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo b
</span><a href="#local-6989586621688409782"><span class="hs-identifier hs-var">tableInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1039"></span><span>                              </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="#local-6989586621688409777"><span class="hs-identifier hs-var">recreateEventTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
-&gt; RecreateEventTriggers -&gt; RecreateEventTriggers
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="#local-6989586621688409766"><span class="hs-identifier hs-var">reloadMetadataRecreateEventTrigger</span></a></span><span>
</span><span id="line-1040"></span><span>                            </span><span class="hs-special">)</span><span>
</span><span id="line-1041"></span><span>                        </span><span class="annot"><span class="annottext">ErrorA
  QErr arr (MetadataObject, SchemaObjId, [SchemaDependency]) ()
forall (arr :: * -&gt; * -&gt; *).
ArrowWriter (Seq CollectedInfo) arr =&gt;
arr (MetadataObject, SchemaObjId, [SchemaDependency]) ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordDependencies"><span class="hs-identifier hs-var">recordDependencies</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688409774"><span class="hs-identifier hs-var">metadataObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SchemaObjId
</span><a href="#local-6989586621688409773"><span class="hs-identifier hs-var">schemaObjectId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688409761"><span class="hs-identifier hs-var">dependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1042"></span><span>                        </span><span class="annot"><span class="annottext">ErrorA QErr arr (EventTriggerInfo b) (EventTriggerInfo b)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688409762"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-1043"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-1044"></span><span>                </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName b -&gt; Text -&gt; Text
forall (b :: BackendType). Backend b =&gt; TableName b -&gt; Text -&gt; Text
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#addTableContext"><span class="hs-identifier hs-var">addTableContext</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688410992"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409778"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621688409770"><span class="hs-identifier hs-var">addTriggerContext</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1045"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-1046"></span><span>            </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688409774"><span class="hs-identifier hs-var">metadataObject</span></a></span><span>
</span><span id="line-1047"></span><span>
</span><span id="line-1048"></span><span>        </span><span id="local-6989586621688409760"><span class="annot"><span class="annottext">recreateTriggerIfNeeded :: ErrorA
  QErr
  arr
  (TableName b, HashMap FieldName (FieldInfo b), TriggerName,
   TriggerOpsDef b, SourceConfig b,
   Maybe (PrimaryKey b (ColumnInfo b)), RecreateEventTriggers)
  ()
</span><a href="#local-6989586621688409760"><span class="hs-identifier hs-var hs-var">recreateTriggerIfNeeded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1049"></span><span>          </span><span class="hs-comment">-- using `Inc.cache` here means that the response will be cached for the given output and the</span><span>
</span><span id="line-1050"></span><span>          </span><span class="hs-comment">-- next time this arrow recieves the same input, the cached response will be returned and the</span><span>
</span><span id="line-1051"></span><span>          </span><span class="hs-comment">-- computation will not be done again.</span><span>
</span><span id="line-1052"></span><span>          </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (TableName b, HashMap FieldName (FieldInfo b), TriggerName,
   TriggerOpsDef b, SourceConfig b,
   Maybe (PrimaryKey b (ColumnInfo b)), RecreateEventTriggers)
  ()
-&gt; ErrorA
     QErr
     arr
     (TableName b, HashMap FieldName (FieldInfo b), TriggerName,
      TriggerOpsDef b, SourceConfig b,
      Maybe (PrimaryKey b (ColumnInfo b)), RecreateEventTriggers)
     ()
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a b.
(ArrowCache m arr, Cacheable a) =&gt;
arr a b -&gt; arr a b
</span><a href="Hasura.Incremental.Internal.Cache.html#cache"><span class="hs-identifier hs-var">Inc.cache</span></a></span><span>
</span><span id="line-1053"></span><span>            </span><span class="hs-keyword">proc</span><span>
</span><span id="line-1054"></span><span>              </span><span class="hs-special">(</span><span> </span><span id="local-6989586621688409756"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409756"><span class="hs-identifier hs-var">tableName</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1055"></span><span>                </span><span id="local-6989586621688409755"><span class="annot"><span class="annottext">HashMap FieldName (FieldInfo b)
</span><a href="#local-6989586621688409755"><span class="hs-identifier hs-var">tableFieldInfoMap</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1056"></span><span>                </span><span id="local-6989586621688409754"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688409754"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1057"></span><span>                </span><span id="local-6989586621688409753"><span class="annot"><span class="annottext">TriggerOpsDef b
</span><a href="#local-6989586621688409753"><span class="hs-identifier hs-var">triggerDefinition</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1058"></span><span>                </span><span id="local-6989586621688409752"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688409752"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1059"></span><span>                </span><span id="local-6989586621688409751"><span class="annot"><span class="annottext">Maybe (PrimaryKey b (ColumnInfo b))
</span><a href="#local-6989586621688409751"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1060"></span><span>                </span><span id="local-6989586621688409750"><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="#local-6989586621688409750"><span class="hs-identifier hs-var">recreateEventTriggers</span></a></span></span><span>
</span><span id="line-1061"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-1062"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1063"></span><span>              </span><span class="annot"><span class="annottext">ErrorA QErr arr (m ()) ()
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-1064"></span><span>                </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1065"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409749"><span class="annot"><span class="annottext">tableColumns :: [ColumnInfo b]
</span><a href="#local-6989586621688409749"><span class="hs-identifier hs-var hs-var">tableColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap FieldName (ColumnInfo b) -&gt; [ColumnInfo b]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">(HashMap FieldName (ColumnInfo b) -&gt; [ColumnInfo b])
-&gt; HashMap FieldName (ColumnInfo b) -&gt; [ColumnInfo b]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(FieldInfo b -&gt; Maybe (ColumnInfo b))
-&gt; HashMap FieldName (FieldInfo b)
-&gt; HashMap FieldName (ColumnInfo b)
forall v1 v2 k. (v1 -&gt; Maybe v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><span class="hs-identifier hs-var">M.mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FieldInfo b
-&gt; Getting (First (ColumnInfo b)) (FieldInfo b) (ColumnInfo b)
-&gt; Maybe (ColumnInfo b)
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><span class="hs-operator hs-var">^?</span></span><span> </span><span class="annot"><span class="annottext">Getting (First (ColumnInfo b)) (FieldInfo b) (ColumnInfo b)
forall (b :: BackendType). Prism' (FieldInfo b) (ColumnInfo b)
</span><a href="Hasura.RQL.Types.Table.html#_FIColumn"><span class="hs-identifier hs-var">_FIColumn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap FieldName (FieldInfo b)
</span><a href="#local-6989586621688409755"><span class="hs-identifier hs-var">tableFieldInfoMap</span></a></span><span>
</span><span id="line-1066"></span><span>                  </span><span id="local-6989586621688409745"><span class="annot"><span class="annottext">BuildReason
</span><a href="#local-6989586621688409745"><span class="hs-identifier hs-var">buildReason</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m BuildReason
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-1067"></span><span>                  </span><span id="local-6989586621688409744"><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688409744"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m ServerConfigCtx
forall (m :: * -&gt; *). HasServerConfigCtx m =&gt; m ServerConfigCtx
</span><a href="Hasura.RQL.Types.html#askServerConfigCtx"><span class="hs-identifier hs-var">askServerConfigCtx</span></a></span><span>
</span><span id="line-1068"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409743"><span class="annot"><span class="annottext">isCatalogUpdate :: Bool
</span><a href="#local-6989586621688409743"><span class="hs-identifier hs-var hs-var">isCatalogUpdate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1069"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BuildReason
</span><a href="#local-6989586621688409745"><span class="hs-identifier hs-var">buildReason</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1070"></span><span>                          </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CatalogUpdate"><span class="hs-identifier hs-type">CatalogUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (HashSet SourceName)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1071"></span><span>                          </span><span class="annot"><span class="annottext">BuildReason
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CatalogSync"><span class="hs-identifier hs-var">CatalogSync</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1072"></span><span>                  </span><span class="hs-comment">-- we don't modify the existing event trigger definitions in the maintenance mode or in read-only mode</span><span>
</span><span id="line-1073"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span>
</span><span id="line-1074"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688409743"><span class="hs-identifier hs-var">isCatalogUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="#local-6989586621688409750"><span class="hs-identifier hs-var">recreateEventTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers -&gt; RecreateEventTriggers -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RecreateEventTriggers
</span><a href="Hasura.RQL.Types.EventTrigger.html#RETRecreate"><span class="hs-identifier hs-var">RETRecreate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1075"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx -&gt; MaintenanceMode
</span><a href="Hasura.Server.Types.html#_sccMaintenanceMode"><span class="hs-identifier hs-var hs-var">_sccMaintenanceMode</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688409744"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode -&gt; MaintenanceMode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span>
</span><span id="line-1076"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx -&gt; ReadOnlyMode
</span><a href="Hasura.Server.Types.html#_sccReadOnlyMode"><span class="hs-identifier hs-var hs-var">_sccReadOnlyMode</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688409744"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span> </span><span class="annot"><span class="annottext">ReadOnlyMode -&gt; ReadOnlyMode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ReadOnlyMode
</span><a href="Hasura.Server.Types.html#ReadOnlyModeDisabled"><span class="hs-identifier hs-var">ReadOnlyModeDisabled</span></a></span><span>
</span><span id="line-1077"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-1078"></span><span>                    </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1079"></span><span>                      </span><span class="annot"><span class="annottext">ServerConfigCtx
-&gt; SourceConfig b
-&gt; TableName b
-&gt; [ColumnInfo b]
-&gt; TriggerName
-&gt; TriggerOpsDef b
-&gt; Maybe (PrimaryKey b (ColumnInfo b))
-&gt; m (Either QErr ())
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadBaseControl IO m, MonadIO m,
 MonadError QErr m) =&gt;
ServerConfigCtx
-&gt; SourceConfig b
-&gt; TableName b
-&gt; [ColumnInfo b]
-&gt; TriggerName
-&gt; TriggerOpsDef b
-&gt; Maybe (PrimaryKey b (ColumnInfo b))
-&gt; m (Either QErr ())
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#createTableEventTrigger"><span class="hs-identifier hs-var">createTableEventTrigger</span></a></span><span>
</span><span id="line-1080"></span><span>                        </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688409744"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span>
</span><span id="line-1081"></span><span>                        </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688409752"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-1082"></span><span>                        </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688409756"><span class="hs-identifier hs-var">tableName</span></a></span><span>
</span><span id="line-1083"></span><span>                        </span><span class="annot"><span class="annottext">[ColumnInfo b]
</span><a href="#local-6989586621688409749"><span class="hs-identifier hs-var">tableColumns</span></a></span><span>
</span><span id="line-1084"></span><span>                        </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688409754"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-1085"></span><span>                        </span><span class="annot"><span class="annottext">TriggerOpsDef b
</span><a href="#local-6989586621688409753"><span class="hs-identifier hs-var">triggerDefinition</span></a></span><span>
</span><span id="line-1086"></span><span>                        </span><span class="annot"><span class="annottext">Maybe (PrimaryKey b (ColumnInfo b))
</span><a href="#local-6989586621688409751"><span class="hs-identifier hs-var">primaryKey</span></a></span><span>
</span><span id="line-1087"></span><span>
</span><span id="line-1088"></span><span>    </span><span id="local-6989586621688410776"><span id="local-6989586621688410777"><span class="annot"><a href="#local-6989586621688409901"><span class="hs-identifier hs-type">buildCronTriggers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1089"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410777"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1090"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410777"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1091"></span><span>        </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410777"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1092"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410776"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410777"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1093"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410776"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1094"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1095"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.ScheduledTrigger.html#CronTriggerMetadata"><span class="hs-identifier hs-type">CronTriggerMetadata</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1096"></span><span>        </span><span class="annot"><a href="#local-6989586621688410777"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#CronTriggerInfo"><span class="hs-identifier hs-type">CronTriggerInfo</span></a></span></span></span><span>
</span><span id="line-1097"></span><span>    </span><span id="local-6989586621688409901"><span class="annot"><span class="annottext">buildCronTriggers :: arr
  ((), [CronTriggerMetadata]) (HashMap TriggerName CronTriggerInfo)
</span><a href="#local-6989586621688409901"><span class="hs-identifier hs-var hs-var">buildCronTriggers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CronTriggerMetadata -&gt; TriggerName)
-&gt; (CronTriggerMetadata -&gt; MetadataObject)
-&gt; arr ((), CronTriggerMetadata) (Maybe CronTriggerInfo)
-&gt; arr
     ((), [CronTriggerMetadata]) (HashMap TriggerName CronTriggerInfo)
forall (arr :: * -&gt; * -&gt; *) k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, Eq k, Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMap"><span class="hs-identifier hs-var">buildInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.ScheduledTrigger.html#ctName"><span class="hs-identifier hs-var hs-var">ctName</span></a></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata -&gt; MetadataObject
</span><a href="#local-6989586621688409847"><span class="hs-identifier hs-var">mkCronTriggerMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">arr ((), CronTriggerMetadata) (Maybe CronTriggerInfo)
</span><a href="#local-6989586621688409736"><span class="hs-identifier hs-var">buildCronTrigger</span></a></span><span>
</span><span id="line-1098"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1099"></span><span>        </span><span id="local-6989586621688409736"><span class="annot"><span class="annottext">buildCronTrigger :: arr ((), CronTriggerMetadata) (Maybe CronTriggerInfo)
</span><a href="#local-6989586621688409736"><span class="hs-identifier hs-var hs-var">buildCronTrigger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409735"><span class="annot"><span class="annottext">CronTriggerMetadata
</span><a href="#local-6989586621688409735"><span class="hs-identifier hs-var">cronTrigger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1100"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409734"><span class="annot"><span class="annottext">triggerName :: Text
</span><a href="#local-6989586621688409734"><span class="hs-identifier hs-var hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">(TriggerName -&gt; Text) -&gt; TriggerName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.ScheduledTrigger.html#ctName"><span class="hs-identifier hs-var hs-var">ctName</span></a></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata
</span><a href="#local-6989586621688409735"><span class="hs-identifier hs-var">cronTrigger</span></a></span><span>
</span><span id="line-1101"></span><span>              </span><span id="local-6989586621688409732"><span class="annot"><span class="annottext">addCronTriggerContext :: Text -&gt; Text
</span><a href="#local-6989586621688409732"><span class="hs-identifier hs-var hs-var">addCronTriggerContext</span></a></span></span><span> </span><span id="local-6989586621688409731"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409731"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in cron trigger &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409734"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409731"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1102"></span><span>          </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1103"></span><span>            </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) CronTriggerInfo
-&gt; arr (a, (MetadataObject, ())) (Maybe CronTriggerInfo)
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-1104"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1105"></span><span>                  </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) CronTriggerInfo
-&gt; ErrorA QErr arr (a, (Text -&gt; Text, ())) CronTriggerInfo
forall (arr :: * -&gt; * -&gt; *) e s a.
ArrowError QErr arr =&gt;
arr (e, s) a -&gt; arr (e, (Text -&gt; Text, s)) a
</span><a href="Hasura.Base.Error.html#modifyErrA"><span class="hs-identifier hs-var">modifyErrA</span></a></span><span>
</span><span id="line-1106"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorA QErr arr (m CronTriggerInfo) CronTriggerInfo
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Environment -&gt; CronTriggerMetadata -&gt; m CronTriggerInfo
forall (m :: * -&gt; *).
QErrM m =&gt;
Environment -&gt; CronTriggerMetadata -&gt; m CronTriggerInfo
</span><a href="Hasura.RQL.DDL.ScheduledTrigger.html#resolveCronTrigger"><span class="hs-identifier hs-var">resolveCronTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688410368"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata
</span><a href="#local-6989586621688409735"><span class="hs-identifier hs-var">cronTrigger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1107"></span><span>                </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621688409732"><span class="hs-identifier hs-var">addCronTriggerContext</span></a></span><span>
</span><span id="line-1108"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-1109"></span><span>            </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CronTriggerMetadata -&gt; MetadataObject
</span><a href="#local-6989586621688409847"><span class="hs-identifier hs-var">mkCronTriggerMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata
</span><a href="#local-6989586621688409735"><span class="hs-identifier hs-var">cronTrigger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1110"></span><span>
</span><span id="line-1111"></span><span>    </span><span id="local-6989586621688410898"><span id="local-6989586621688410899"><span class="annot"><a href="#local-6989586621688410032"><span class="hs-identifier hs-type">buildInheritedRoles</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1112"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410899"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1113"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410899"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1114"></span><span>        </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410899"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1115"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410898"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410899"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1116"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410898"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1117"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1118"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashSet</span></span><span> </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#InheritedRole"><span class="hs-identifier hs-type">InheritedRole</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1119"></span><span>        </span><span class="annot"><a href="#local-6989586621688410899"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span></span></span><span>
</span><span id="line-1120"></span><span>    </span><span id="local-6989586621688410032"><span class="annot"><span class="annottext">buildInheritedRoles :: arr (HashSet RoleName, [Role]) (HashMap RoleName Role)
</span><a href="#local-6989586621688410032"><span class="hs-identifier hs-var hs-var">buildInheritedRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Role -&gt; RoleName)
-&gt; (Role -&gt; MetadataObject)
-&gt; arr (HashSet RoleName, Role) (Maybe Role)
-&gt; arr (HashSet RoleName, [Role]) (HashMap RoleName Role)
forall (arr :: * -&gt; * -&gt; *) k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, Eq k, Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMap"><span class="hs-identifier hs-var">buildInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_rRoleName"><span class="hs-identifier hs-var hs-var">_rRoleName</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; MetadataObject
</span><a href="#local-6989586621688409832"><span class="hs-identifier hs-var">mkInheritedRoleMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">arr (HashSet RoleName, Role) (Maybe Role)
</span><a href="#local-6989586621688409728"><span class="hs-identifier hs-var">buildInheritedRole</span></a></span><span>
</span><span id="line-1121"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1122"></span><span>        </span><span id="local-6989586621688409728"><span class="annot"><span class="annottext">buildInheritedRole :: arr (HashSet RoleName, Role) (Maybe Role)
</span><a href="#local-6989586621688409728"><span class="hs-identifier hs-var hs-var">buildInheritedRole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409727"><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688409727"><span class="hs-identifier hs-var">allRoles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409726"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688409726"><span class="hs-identifier hs-var">inheritedRole</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1123"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409725"><span class="annot"><span class="annottext">addInheritedRoleContext :: Text -&gt; Text
</span><a href="#local-6989586621688409725"><span class="hs-identifier hs-var hs-var">addInheritedRoleContext</span></a></span></span><span> </span><span id="local-6989586621688409724"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409724"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in inherited role &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; Text
</span><a href="Hasura.Session.html#roleNameToTxt"><span class="hs-identifier hs-var">roleNameToTxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_rRoleName"><span class="hs-identifier hs-var hs-var">_rRoleName</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688409726"><span class="hs-identifier hs-var">inheritedRole</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409724"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1124"></span><span>              </span><span id="local-6989586621688409722"><span class="annot"><span class="annottext">metadataObject :: MetadataObject
</span><a href="#local-6989586621688409722"><span class="hs-identifier hs-var hs-var">metadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; MetadataObject
</span><a href="#local-6989586621688409832"><span class="hs-identifier hs-var">mkInheritedRoleMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688409726"><span class="hs-identifier hs-var">inheritedRole</span></a></span><span>
</span><span id="line-1125"></span><span>              </span><span id="local-6989586621688409721"><span class="annot"><span class="annottext">schemaObject :: SchemaObjId
</span><a href="#local-6989586621688409721"><span class="hs-identifier hs-var hs-var">schemaObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SORole"><span class="hs-identifier hs-var">SORole</span></a></span><span> </span><span class="annot"><span class="annottext">(RoleName -&gt; SchemaObjId) -&gt; RoleName -&gt; SchemaObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_rRoleName"><span class="hs-identifier hs-var hs-var">_rRoleName</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688409726"><span class="hs-identifier hs-var">inheritedRole</span></a></span><span>
</span><span id="line-1126"></span><span>          </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1127"></span><span>            </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) Role
-&gt; arr (a, (MetadataObject, ())) (Maybe Role)
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-1128"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1129"></span><span>                  </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) Role
-&gt; ErrorA QErr arr (a, (Text -&gt; Text, ())) Role
forall (arr :: * -&gt; * -&gt; *) e s a.
ArrowError QErr arr =&gt;
arr (e, s) a -&gt; arr (e, (Text -&gt; Text, s)) a
</span><a href="Hasura.Base.Error.html#modifyErrA"><span class="hs-identifier hs-var">modifyErrA</span></a></span><span>
</span><span id="line-1130"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1131"></span><span>                        </span><span class="hs-special">(</span><span id="local-6989586621688409719"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688409719"><span class="hs-identifier hs-var">resolvedInheritedRole</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409718"><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688409718"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr arr (m (Role, [SchemaDependency])) (Role, [SchemaDependency])
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">HashSet RoleName -&gt; Role -&gt; m (Role, [SchemaDependency])
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
HashSet RoleName -&gt; Role -&gt; m (Role, [SchemaDependency])
</span><a href="Hasura.RQL.DDL.InheritedRoles.html#resolveInheritedRole"><span class="hs-identifier hs-var">resolveInheritedRole</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688409727"><span class="hs-identifier hs-var">allRoles</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688409726"><span class="hs-identifier hs-var">inheritedRole</span></a></span><span>
</span><span id="line-1132"></span><span>                        </span><span class="annot"><span class="annottext">ErrorA
  QErr arr (MetadataObject, SchemaObjId, [SchemaDependency]) ()
forall (arr :: * -&gt; * -&gt; *).
ArrowWriter (Seq CollectedInfo) arr =&gt;
arr (MetadataObject, SchemaObjId, [SchemaDependency]) ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordDependencies"><span class="hs-identifier hs-var">recordDependencies</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688409722"><span class="hs-identifier hs-var">metadataObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SchemaObjId
</span><a href="#local-6989586621688409721"><span class="hs-identifier hs-var">schemaObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688409718"><span class="hs-identifier hs-var">dependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1133"></span><span>                        </span><span class="annot"><span class="annottext">ErrorA QErr arr Role Role
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688409719"><span class="hs-identifier hs-var">resolvedInheritedRole</span></a></span><span>
</span><span id="line-1134"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-1135"></span><span>                </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621688409725"><span class="hs-identifier hs-var">addInheritedRoleContext</span></a></span><span>
</span><span id="line-1136"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-1137"></span><span>            </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688409722"><span class="hs-identifier hs-var">metadataObject</span></a></span><span>
</span><span id="line-1138"></span><span>
</span><span id="line-1139"></span><span>    </span><span id="local-6989586621688410783"><span id="local-6989586621688410784"><span class="annot"><a href="#local-6989586621688409907"><span class="hs-identifier hs-type">buildActions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1140"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410784"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1141"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410784"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1142"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410783"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410784"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1143"></span><span>        </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410784"><span class="hs-identifier hs-type">arr</span></a></span><span>
</span><span id="line-1144"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1145"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.CustomTypes.html#AnnotatedCustomTypes"><span class="hs-identifier hs-type">AnnotatedCustomTypes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DMap.DMap</span></span><span> </span><span class="annot"><a href="Hasura.SQL.Tag.html#BackendTag"><span class="hs-identifier hs-type">BackendTag</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.CustomTypes.html#ScalarSet"><span class="hs-identifier hs-type">ScalarSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1146"></span><span>        </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionMetadata"><span class="hs-identifier hs-type">ActionMetadata</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1147"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-1148"></span><span>        </span><span class="annot"><a href="#local-6989586621688410784"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionName"><span class="hs-identifier hs-type">ActionName</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionInfo"><span class="hs-identifier hs-type">ActionInfo</span></a></span></span></span><span>
</span><span id="line-1149"></span><span>    </span><span id="local-6989586621688409907"><span class="annot"><span class="annottext">buildActions :: arr
  ((AnnotatedCustomTypes, DMap BackendTag ScalarSet, OrderedRoles),
   [ActionMetadata])
  ActionCache
</span><a href="#local-6989586621688409907"><span class="hs-identifier hs-var hs-var">buildActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ActionMetadata -&gt; ActionName)
-&gt; (ActionMetadata -&gt; MetadataObject)
-&gt; arr
     ((AnnotatedCustomTypes, DMap BackendTag ScalarSet, OrderedRoles),
      ActionMetadata)
     (Maybe ActionInfo)
-&gt; arr
     ((AnnotatedCustomTypes, DMap BackendTag ScalarSet, OrderedRoles),
      [ActionMetadata])
     ActionCache
forall (arr :: * -&gt; * -&gt; *) k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, Eq k, Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMap"><span class="hs-identifier hs-var">buildInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">ActionMetadata -&gt; ActionName
</span><a href="Hasura.RQL.Types.Action.html#_amName"><span class="hs-identifier hs-var hs-var">_amName</span></a></span><span> </span><span class="annot"><span class="annottext">ActionMetadata -&gt; MetadataObject
</span><a href="#local-6989586621688409905"><span class="hs-identifier hs-var">mkActionMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">arr
  ((AnnotatedCustomTypes, DMap BackendTag ScalarSet, OrderedRoles),
   ActionMetadata)
  (Maybe ActionInfo)
</span><a href="#local-6989586621688409716"><span class="hs-identifier hs-var">buildAction</span></a></span><span>
</span><span id="line-1150"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1151"></span><span>        </span><span id="local-6989586621688409716"><span class="annot"><span class="annottext">buildAction :: arr
  ((AnnotatedCustomTypes, DMap BackendTag ScalarSet, OrderedRoles),
   ActionMetadata)
  (Maybe ActionInfo)
</span><a href="#local-6989586621688409716"><span class="hs-identifier hs-var hs-var">buildAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621688409715"><span class="annot"><span class="annottext">AnnotatedCustomTypes
</span><a href="#local-6989586621688409715"><span class="hs-identifier hs-var">resolvedCustomTypes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409714"><span class="annot"><span class="annottext">DMap BackendTag ScalarSet
</span><a href="#local-6989586621688409714"><span class="hs-identifier hs-var">scalarsMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409713"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688409713"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409712"><span class="annot"><span class="annottext">ActionMetadata
</span><a href="#local-6989586621688409712"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1152"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionMetadata"><span class="hs-identifier hs-type">ActionMetadata</span></a></span><span> </span><span id="local-6989586621688409711"><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621688409711"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621688409710"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688409710"><span class="hs-identifier hs-var">comment</span></a></span></span><span> </span><span id="local-6989586621688409709"><span class="annot"><span class="annottext">ActionDefinitionInput
</span><a href="#local-6989586621688409709"><span class="hs-identifier hs-var">def</span></a></span></span><span> </span><span id="local-6989586621688409708"><span class="annot"><span class="annottext">[ActionPermissionMetadata]
</span><a href="#local-6989586621688409708"><span class="hs-identifier hs-var">actionPermissions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ActionMetadata
</span><a href="#local-6989586621688409712"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-1153"></span><span>              </span><span id="local-6989586621688409707"><span class="annot"><span class="annottext">addActionContext :: Text -&gt; Text
</span><a href="#local-6989586621688409707"><span class="hs-identifier hs-var hs-var">addActionContext</span></a></span></span><span> </span><span id="local-6989586621688409706"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409706"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in action &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621688409711"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">ActionName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;; &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409706"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1154"></span><span>          </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1155"></span><span>            </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) ActionInfo
-&gt; arr (a, (MetadataObject, ())) (Maybe ActionInfo)
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-1156"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1157"></span><span>                  </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) ActionInfo
-&gt; ErrorA QErr arr (a, (Text -&gt; Text, ())) ActionInfo
forall (arr :: * -&gt; * -&gt; *) e s a.
ArrowError QErr arr =&gt;
arr (e, s) a -&gt; arr (e, (Text -&gt; Text, s)) a
</span><a href="Hasura.Base.Error.html#modifyErrA"><span class="hs-identifier hs-var">modifyErrA</span></a></span><span>
</span><span id="line-1158"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1159"></span><span>                        </span><span class="hs-special">(</span><span id="local-6989586621688409705"><span class="annot"><span class="annottext">ResolvedActionDefinition
</span><a href="#local-6989586621688409705"><span class="hs-identifier hs-var">resolvedDef</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409704"><span class="annot"><span class="annottext">AnnotatedOutputType
</span><a href="#local-6989586621688409704"><span class="hs-identifier hs-var">outObject</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1160"></span><span>                          </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (Either QErr (ResolvedActionDefinition, AnnotatedOutputType))
  (ResolvedActionDefinition, AnnotatedOutputType)
forall (arr :: * -&gt; * -&gt; *) e a.
(ArrowChoice arr, ArrowError e arr) =&gt;
arr (Either e a) a
</span><a href="Control.Arrow.Trans.html#liftEitherA"><span class="hs-identifier hs-var">liftEitherA</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (Either QErr (ResolvedActionDefinition, AnnotatedOutputType))
  (ResolvedActionDefinition, AnnotatedOutputType)
-&gt; ErrorA
     QErr
     arr
     (m (Either QErr (ResolvedActionDefinition, AnnotatedOutputType)))
     (Either QErr (ResolvedActionDefinition, AnnotatedOutputType))
-&gt; ErrorA
     QErr
     arr
     (m (Either QErr (ResolvedActionDefinition, AnnotatedOutputType)))
     (ResolvedActionDefinition, AnnotatedOutputType)
forall k (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">&lt;&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (m (Either QErr (ResolvedActionDefinition, AnnotatedOutputType)))
  (Either QErr (ResolvedActionDefinition, AnnotatedOutputType))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-1161"></span><span>                            </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-1162"></span><span>                              </span><span class="annot"><span class="annottext">ExceptT QErr m (ResolvedActionDefinition, AnnotatedOutputType)
-&gt; m (Either QErr (ResolvedActionDefinition, AnnotatedOutputType))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m (ResolvedActionDefinition, AnnotatedOutputType)
 -&gt; m (Either QErr (ResolvedActionDefinition, AnnotatedOutputType)))
-&gt; ExceptT QErr m (ResolvedActionDefinition, AnnotatedOutputType)
-&gt; m (Either QErr (ResolvedActionDefinition, AnnotatedOutputType))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Environment
-&gt; AnnotatedCustomTypes
-&gt; ActionDefinitionInput
-&gt; DMap BackendTag ScalarSet
-&gt; ExceptT QErr m (ResolvedActionDefinition, AnnotatedOutputType)
forall (m :: * -&gt; *).
QErrM m =&gt;
Environment
-&gt; AnnotatedCustomTypes
-&gt; ActionDefinitionInput
-&gt; DMap BackendTag ScalarSet
-&gt; m (ResolvedActionDefinition, AnnotatedOutputType)
</span><a href="Hasura.RQL.DDL.Action.html#resolveAction"><span class="hs-identifier hs-var">resolveAction</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688410368"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">AnnotatedCustomTypes
</span><a href="#local-6989586621688409715"><span class="hs-identifier hs-var">resolvedCustomTypes</span></a></span><span> </span><span class="annot"><span class="annottext">ActionDefinitionInput
</span><a href="#local-6989586621688409709"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">DMap BackendTag ScalarSet
</span><a href="#local-6989586621688409714"><span class="hs-identifier hs-var">scalarsMap</span></a></span><span>
</span><span id="line-1163"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409702"><span class="annot"><span class="annottext">permissionInfos :: [ActionPermissionInfo]
</span><a href="#local-6989586621688409702"><span class="hs-identifier hs-var hs-var">permissionInfos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ActionPermissionMetadata -&gt; ActionPermissionInfo)
-&gt; [ActionPermissionMetadata] -&gt; [ActionPermissionInfo]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; ActionPermissionInfo
</span><a href="Hasura.RQL.Types.Action.html#ActionPermissionInfo"><span class="hs-identifier hs-var">ActionPermissionInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(RoleName -&gt; ActionPermissionInfo)
-&gt; (ActionPermissionMetadata -&gt; RoleName)
-&gt; ActionPermissionMetadata
-&gt; ActionPermissionInfo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ActionPermissionMetadata -&gt; RoleName
</span><a href="Hasura.RQL.Types.Action.html#_apmRole"><span class="hs-identifier hs-var hs-var">_apmRole</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ActionPermissionMetadata]
</span><a href="#local-6989586621688409708"><span class="hs-identifier hs-var">actionPermissions</span></a></span><span>
</span><span id="line-1164"></span><span>                            </span><span id="local-6989586621688409700"><span class="annot"><span class="annottext">metadataPermissionMap :: HashMap RoleName ActionPermissionInfo
</span><a href="#local-6989586621688409700"><span class="hs-identifier hs-var hs-var">metadataPermissionMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ActionPermissionInfo -&gt; RoleName)
-&gt; [ActionPermissionInfo] -&gt; HashMap RoleName ActionPermissionInfo
forall k a. (Eq k, Hashable k) =&gt; (a -&gt; k) -&gt; [a] -&gt; HashMap k a
</span><a href="Hasura.Prelude.html#mapFromL"><span class="hs-identifier hs-var">mapFromL</span></a></span><span> </span><span class="annot"><span class="annottext">ActionPermissionInfo -&gt; RoleName
</span><a href="Hasura.RQL.Types.Action.html#_apiRole"><span class="hs-identifier hs-var hs-var">_apiRole</span></a></span><span> </span><span class="annot"><span class="annottext">[ActionPermissionInfo]
</span><a href="#local-6989586621688409702"><span class="hs-identifier hs-var">permissionInfos</span></a></span><span>
</span><span id="line-1165"></span><span>                            </span><span id="local-6989586621688409698"><span class="annot"><span class="annottext">permissionsMap :: HashMap RoleName ActionPermissionInfo
</span><a href="#local-6989586621688409698"><span class="hs-identifier hs-var hs-var">permissionsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RoleName -&gt; ActionPermissionInfo)
-&gt; HashMap RoleName ActionPermissionInfo
-&gt; OrderedRoles
-&gt; HashMap RoleName ActionPermissionInfo
forall a.
(RoleName -&gt; a)
-&gt; HashMap RoleName a -&gt; OrderedRoles -&gt; HashMap RoleName a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkBooleanPermissionMap"><span class="hs-identifier hs-var">mkBooleanPermissionMap</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; ActionPermissionInfo
</span><a href="Hasura.RQL.Types.Action.html#ActionPermissionInfo"><span class="hs-identifier hs-var">ActionPermissionInfo</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName ActionPermissionInfo
</span><a href="#local-6989586621688409700"><span class="hs-identifier hs-var">metadataPermissionMap</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688409713"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span>
</span><span id="line-1166"></span><span>                            </span><span id="local-6989586621688409697"><span class="annot"><span class="annottext">forwardClientHeaders :: Bool
</span><a href="#local-6989586621688409697"><span class="hs-identifier hs-var hs-var">forwardClientHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResolvedActionDefinition -&gt; Bool
forall a b. ActionDefinition a b -&gt; Bool
</span><a href="Hasura.RQL.Types.Action.html#_adForwardClientHeaders"><span class="hs-identifier hs-var hs-var">_adForwardClientHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">ResolvedActionDefinition
</span><a href="#local-6989586621688409705"><span class="hs-identifier hs-var">resolvedDef</span></a></span><span>
</span><span id="line-1167"></span><span>                            </span><span id="local-6989586621688409695"><span class="annot"><span class="annottext">outputType :: GType
</span><a href="#local-6989586621688409695"><span class="hs-identifier hs-var hs-var">outputType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GraphQLType -&gt; GType
</span><a href="Hasura.RQL.Types.CustomTypes.html#unGraphQLType"><span class="hs-identifier hs-var hs-var">unGraphQLType</span></a></span><span> </span><span class="annot"><span class="annottext">(GraphQLType -&gt; GType) -&gt; GraphQLType -&gt; GType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ActionDefinitionInput -&gt; GraphQLType
forall a b. ActionDefinition a b -&gt; GraphQLType
</span><a href="Hasura.RQL.Types.Action.html#_adOutputType"><span class="hs-identifier hs-var hs-var">_adOutputType</span></a></span><span> </span><span class="annot"><span class="annottext">ActionDefinitionInput
</span><a href="#local-6989586621688409709"><span class="hs-identifier hs-var">def</span></a></span><span>
</span><span id="line-1168"></span><span>                        </span><span class="annot"><span class="annottext">ErrorA QErr arr ActionInfo ActionInfo
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">ActionName
-&gt; (GType, AnnotatedOutputType)
-&gt; ResolvedActionDefinition
-&gt; HashMap RoleName ActionPermissionInfo
-&gt; Bool
-&gt; Maybe Text
-&gt; ActionInfo
</span><a href="Hasura.RQL.Types.Action.html#ActionInfo"><span class="hs-identifier hs-var">ActionInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621688409711"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GType
</span><a href="#local-6989586621688409695"><span class="hs-identifier hs-var">outputType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnnotatedOutputType
</span><a href="#local-6989586621688409704"><span class="hs-identifier hs-var">outObject</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ResolvedActionDefinition
</span><a href="#local-6989586621688409705"><span class="hs-identifier hs-var">resolvedDef</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName ActionPermissionInfo
</span><a href="#local-6989586621688409698"><span class="hs-identifier hs-var">permissionsMap</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688409697"><span class="hs-identifier hs-var">forwardClientHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688409710"><span class="hs-identifier hs-var">comment</span></a></span><span>
</span><span id="line-1169"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-1170"></span><span>                </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621688409707"><span class="hs-identifier hs-var">addActionContext</span></a></span><span>
</span><span id="line-1171"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-1172"></span><span>            </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ActionMetadata -&gt; MetadataObject
</span><a href="#local-6989586621688409905"><span class="hs-identifier hs-var">mkActionMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">ActionMetadata
</span><a href="#local-6989586621688409712"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1173"></span><span>
</span><span id="line-1174"></span><span>    </span><span id="local-6989586621688410891"><span id="local-6989586621688410892"><span class="annot"><a href="#local-6989586621688410024"><span class="hs-identifier hs-type">buildRemoteSchemas</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1175"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410892"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1176"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410892"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1177"></span><span>        </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410892"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1178"></span><span>        </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410891"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410892"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1179"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688410891"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1180"></span><span>        </span><span class="annot"><a href="Network.HTTP.Client.Manager.html#HasHttpManagerM"><span class="hs-identifier hs-type">HasHttpManagerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410891"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1181"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1182"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Dependency"><span class="hs-identifier hs-type">Inc.Dependency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="annot"><a href="Hasura.Incremental.html#InvalidationKey"><span class="hs-identifier hs-type">Inc.InvalidationKey</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1183"></span><span>        </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#RemoteSchemaMetadata"><span class="hs-identifier hs-type">RemoteSchemaMetadata</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1184"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-1185"></span><span>        </span><span class="annot"><a href="#local-6989586621688410892"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#RemoteSchemaCtx"><span class="hs-identifier hs-type">RemoteSchemaCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#SchemaRemoteRelationships"><span class="hs-identifier hs-type">SchemaRemoteRelationships</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1186"></span><span>    </span><span id="local-6989586621688410024"><span class="annot"><span class="annottext">buildRemoteSchemas :: arr
  (Dependency (HashMap RemoteSchemaName InvalidationKey),
   [RemoteSchemaMetadata])
  (HashMap
     RemoteSchemaName
     ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject))
</span><a href="#local-6989586621688410024"><span class="hs-identifier hs-var hs-var">buildRemoteSchemas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1187"></span><span>      </span><span class="annot"><span class="annottext">(RemoteSchemaMetadata -&gt; RemoteSchemaName)
-&gt; (RemoteSchemaMetadata -&gt; MetadataObject)
-&gt; arr
     (Dependency (HashMap RemoteSchemaName InvalidationKey),
      RemoteSchemaMetadata)
     (Maybe (RemoteSchemaCtx, SchemaRemoteRelationships))
-&gt; arr
     (Dependency (HashMap RemoteSchemaName InvalidationKey),
      [RemoteSchemaMetadata])
     (HashMap
        RemoteSchemaName
        ((RemoteSchemaCtx, SchemaRemoteRelationships), MetadataObject))
forall (arr :: * -&gt; * -&gt; *) k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectedInfo) arr, Eq k, Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k (b, MetadataObject))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMapPreservingMetadata"><span class="hs-identifier hs-var">buildInfoMapPreservingMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadata -&gt; RemoteSchemaName
</span><a href="Hasura.RQL.Types.Metadata.html#_rsmName"><span class="hs-identifier hs-var hs-var">_rsmName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadata -&gt; MetadataObject
</span><a href="#local-6989586621688409836"><span class="hs-identifier hs-var">mkRemoteSchemaMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">arr
  (Dependency (HashMap RemoteSchemaName InvalidationKey),
   RemoteSchemaMetadata)
  (Maybe (RemoteSchemaCtx, SchemaRemoteRelationships))
</span><a href="#local-6989586621688409690"><span class="hs-identifier hs-var">buildRemoteSchema</span></a></span><span>
</span><span id="line-1188"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1189"></span><span>        </span><span class="hs-comment">-- We want to cache this call because it fetches the remote schema over HTTP, and we don&#8217;t</span><span>
</span><span id="line-1190"></span><span>        </span><span class="hs-comment">-- want to re-run that if the remote schema definition hasn&#8217;t changed.</span><span>
</span><span id="line-1191"></span><span>        </span><span id="local-6989586621688409690"><span class="annot"><span class="annottext">buildRemoteSchema :: arr
  (Dependency (HashMap RemoteSchemaName InvalidationKey),
   RemoteSchemaMetadata)
  (Maybe (RemoteSchemaCtx, SchemaRemoteRelationships))
</span><a href="#local-6989586621688409690"><span class="hs-identifier hs-var hs-var">buildRemoteSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">arr
  (Dependency (HashMap RemoteSchemaName InvalidationKey),
   RemoteSchemaMetadata)
  (Maybe (RemoteSchemaCtx, SchemaRemoteRelationships))
-&gt; arr
     (Dependency (HashMap RemoteSchemaName InvalidationKey),
      RemoteSchemaMetadata)
     (Maybe (RemoteSchemaCtx, SchemaRemoteRelationships))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a b.
(ArrowCache m arr, Cacheable a) =&gt;
arr a b -&gt; arr a b
</span><a href="Hasura.Incremental.Internal.Cache.html#cache"><span class="hs-identifier hs-var">Inc.cache</span></a></span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409689"><span class="annot"><span class="annottext">Dependency (HashMap RemoteSchemaName InvalidationKey)
</span><a href="#local-6989586621688409689"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409688"><span class="annot"><span class="annottext">remoteSchema :: RemoteSchemaMetadata
</span><a href="#local-6989586621688409688"><span class="hs-identifier hs-var">remoteSchema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#RemoteSchemaMetadata"><span class="hs-identifier hs-type">RemoteSchemaMetadata</span></a></span><span> </span><span id="local-6989586621688409686"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409686"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621688409685"><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621688409685"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span id="local-6989586621688409684"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688409684"><span class="hs-identifier hs-var">comment</span></a></span></span><span> </span><span class="annot"><span class="annottext">[RemoteSchemaPermissionMetadata]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688409683"><span class="annot"><span class="annottext">SchemaRemoteRelationships
</span><a href="#local-6989586621688409683"><span class="hs-identifier hs-var">relationships</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1192"></span><span>          </span><span class="hs-comment">-- TODO is it strange how we convert from RemoteSchemaMetadata back</span><span>
</span><span id="line-1193"></span><span>          </span><span class="hs-comment">--      to AddRemoteSchemaQuery here? Document types please.</span><span>
</span><span id="line-1194"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409682"><span class="annot"><span class="annottext">addRemoteSchemaQuery :: AddRemoteSchemaQuery
</span><a href="#local-6989586621688409682"><span class="hs-identifier hs-var hs-var">addRemoteSchemaQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
-&gt; RemoteSchemaDef -&gt; Maybe Text -&gt; AddRemoteSchemaQuery
</span><a href="Hasura.RQL.Types.RemoteSchema.html#AddRemoteSchemaQuery"><span class="hs-identifier hs-var">AddRemoteSchemaQuery</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409686"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621688409685"><span class="hs-identifier hs-var">defn</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688409684"><span class="hs-identifier hs-var">comment</span></a></span><span>
</span><span id="line-1195"></span><span>          </span><span class="annot"><span class="annottext">arr (Dependency (Maybe InvalidationKey)) (Maybe InvalidationKey)
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
(ArrowCache m arr, Cacheable a) =&gt;
arr (Dependency a) a
</span><a href="Hasura.Incremental.Internal.Cache.html#dependOn"><span class="hs-identifier hs-var">Inc.dependOn</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
-&gt; Dependency (HashMap RemoteSchemaName InvalidationKey)
-&gt; Dependency (Maybe InvalidationKey)
forall a k v.
(Select a, Selector a ~ ConstS k v) =&gt;
k -&gt; Dependency a -&gt; Dependency v
</span><a href="Hasura.Incremental.Internal.Dependency.html#selectKeyD"><span class="hs-identifier hs-var">Inc.selectKeyD</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409686"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Dependency (HashMap RemoteSchemaName InvalidationKey)
</span><a href="#local-6989586621688409689"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span>
</span><span id="line-1196"></span><span>          </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1197"></span><span>            </span><span class="annot"><span class="annottext">forall a.
ErrorA
  QErr arr (a, ()) (RemoteSchemaCtx, SchemaRemoteRelationships)
-&gt; arr
     (a, (MetadataObject, ()))
     (Maybe (RemoteSchemaCtx, SchemaRemoteRelationships))
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-1198"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships))
  (RemoteSchemaCtx, SchemaRemoteRelationships)
forall (arr :: * -&gt; * -&gt; *) e a.
(ArrowChoice arr, ArrowError e arr) =&gt;
arr (Either e a) a
</span><a href="Control.Arrow.Trans.html#liftEitherA"><span class="hs-identifier hs-var">liftEitherA</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships))
  (RemoteSchemaCtx, SchemaRemoteRelationships)
-&gt; ErrorA
     QErr
     arr
     (m (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships)))
     (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships))
-&gt; ErrorA
     QErr
     arr
     (m (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships)))
     (RemoteSchemaCtx, SchemaRemoteRelationships)
forall k (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">&lt;&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (m (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships)))
  (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-1199"></span><span>                  </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-1200"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Either QErr RemoteSchemaCtx
 -&gt; Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships))
-&gt; m (Either QErr RemoteSchemaCtx)
-&gt; m (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((Either QErr RemoteSchemaCtx
  -&gt; Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships))
 -&gt; m (Either QErr RemoteSchemaCtx)
 -&gt; m (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships)))
-&gt; ((RemoteSchemaCtx
     -&gt; (RemoteSchemaCtx, SchemaRemoteRelationships))
    -&gt; Either QErr RemoteSchemaCtx
    -&gt; Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships))
-&gt; (RemoteSchemaCtx
    -&gt; (RemoteSchemaCtx, SchemaRemoteRelationships))
-&gt; m (Either QErr RemoteSchemaCtx)
-&gt; m (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaCtx -&gt; (RemoteSchemaCtx, SchemaRemoteRelationships))
-&gt; Either QErr RemoteSchemaCtx
-&gt; Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="annottext">SchemaRemoteRelationships
</span><a href="#local-6989586621688409683"><span class="hs-identifier hs-var">relationships</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Either QErr RemoteSchemaCtx)
 -&gt; m (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships)))
-&gt; m (Either QErr RemoteSchemaCtx)
-&gt; m (Either QErr (RemoteSchemaCtx, SchemaRemoteRelationships))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1201"></span><span>                      </span><span class="annot"><span class="annottext">ExceptT QErr m RemoteSchemaCtx -&gt; m (Either QErr RemoteSchemaCtx)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m RemoteSchemaCtx -&gt; m (Either QErr RemoteSchemaCtx))
-&gt; ExceptT QErr m RemoteSchemaCtx
-&gt; m (Either QErr RemoteSchemaCtx)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TraceT (ExceptT QErr m) RemoteSchemaCtx
-&gt; ExceptT QErr m RemoteSchemaCtx
forall a. TraceT (ExceptT QErr m) a -&gt; ExceptT QErr m a
</span><a href="#local-6989586621688409680"><span class="hs-identifier hs-var">noopTrace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceT (ExceptT QErr m) RemoteSchemaCtx
 -&gt; ExceptT QErr m RemoteSchemaCtx)
-&gt; TraceT (ExceptT QErr m) RemoteSchemaCtx
-&gt; ExceptT QErr m RemoteSchemaCtx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Environment
-&gt; AddRemoteSchemaQuery -&gt; TraceT (ExceptT QErr m) RemoteSchemaCtx
forall (m :: * -&gt; *).
(QErrM m, MonadIO m, HasHttpManagerM m, MonadTrace m) =&gt;
Environment -&gt; AddRemoteSchemaQuery -&gt; m RemoteSchemaCtx
</span><a href="Hasura.RQL.DDL.RemoteSchema.html#addRemoteSchemaP2Setup"><span class="hs-identifier hs-var">addRemoteSchemaP2Setup</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688410368"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">AddRemoteSchemaQuery
</span><a href="#local-6989586621688409682"><span class="hs-identifier hs-var">addRemoteSchemaQuery</span></a></span><span>
</span><span id="line-1202"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-1203"></span><span>            </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaMetadata -&gt; MetadataObject
</span><a href="#local-6989586621688409836"><span class="hs-identifier hs-var">mkRemoteSchemaMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadata
</span><a href="#local-6989586621688409688"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1204"></span><span>        </span><span class="hs-comment">-- TODO continue propagating MonadTrace up calls so that we can get tracing for remote schema introspection.</span><span>
</span><span id="line-1205"></span><span>        </span><span class="hs-comment">-- This will require modifying CacheBuild.</span><span>
</span><span id="line-1206"></span><span>        </span><span id="local-6989586621688409680"><span class="annot"><span class="annottext">noopTrace :: TraceT (ExceptT QErr m) a -&gt; ExceptT QErr m a
</span><a href="#local-6989586621688409680"><span class="hs-identifier hs-var hs-var">noopTrace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reporter -&gt; Text -&gt; TraceT (ExceptT QErr m) a -&gt; ExceptT QErr m a
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Reporter -&gt; Text -&gt; TraceT m a -&gt; m a
</span><a href="Hasura.Tracing.html#runTraceTWithReporter"><span class="hs-identifier hs-var">Tracing.runTraceTWithReporter</span></a></span><span> </span><span class="annot"><span class="annottext">Reporter
</span><a href="Hasura.Tracing.html#noReporter"><span class="hs-identifier hs-var">Tracing.noReporter</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;buildSchemaCacheRule&quot;</span></span><span>
</span><span id="line-1207"></span><span>
</span><span id="line-1208"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRemoteSchemaRemoteRelationship"><span class="hs-identifier hs-type">buildRemoteSchemaRemoteRelationship</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1209"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688410801"><span class="annot"><a href="#local-6989586621688410801"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688410800"><span class="annot"><a href="#local-6989586621688410800"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1210"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688410801"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1211"></span><span>    </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688410801"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1212"></span><span>    </span><span class="annot"><a href="Control.Arrow.Extended.html#ArrowKleisli"><span class="hs-identifier hs-type">ArrowKleisli</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410800"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410801"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1213"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688410800"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1214"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1215"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.SQL.AnyBackend.html#AnyBackend"><span class="hs-identifier hs-type">AB.AnyBackend</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteRelationship.html#PartiallyResolvedSource"><span class="hs-identifier hs-type">PartiallyResolvedSource</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#RemoteSchemaMap"><span class="hs-identifier hs-type">RemoteSchemaMap</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1216"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#RemoteSchemaIntrospection"><span class="hs-identifier hs-type">RemoteSchemaIntrospection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">G.Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Relationships.Remote.html#RemoteRelationship"><span class="hs-identifier hs-type">RemoteRelationship</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1217"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-1218"></span><span>    </span><span class="annot"><a href="#local-6989586621688410801"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Relationships.Remote.html#RemoteFieldInfo"><span class="hs-identifier hs-type">RemoteFieldInfo</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">G.Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-1219"></span><span id="buildRemoteSchemaRemoteRelationship"><span class="annot"><span class="annottext">buildRemoteSchemaRemoteRelationship :: arr
  ((HashMap SourceName (AnyBackend PartiallyResolvedSource),
    RemoteSchemaMap),
   (RemoteSchemaName, RemoteSchemaIntrospection, Name,
    RemoteRelationship))
  (Maybe (RemoteFieldInfo Name))
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRemoteSchemaRemoteRelationship"><span class="hs-identifier hs-var hs-var">buildRemoteSchemaRemoteRelationship</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1220"></span><span>  </span><span class="hs-keyword">proc</span><span>
</span><span id="line-1221"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409676"><span class="annot"><span class="annottext">HashMap SourceName (AnyBackend PartiallyResolvedSource)
</span><a href="#local-6989586621688409676"><span class="hs-identifier hs-var">allSources</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409675"><span class="annot"><span class="annottext">RemoteSchemaMap
</span><a href="#local-6989586621688409675"><span class="hs-identifier hs-var">remoteSchemaMap</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1222"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621688409674"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409674"><span class="hs-identifier hs-var">remoteSchema</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409673"><span class="annot"><span class="annottext">RemoteSchemaIntrospection
</span><a href="#local-6989586621688409673"><span class="hs-identifier hs-var">remoteSchemaIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409672"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688409672"><span class="hs-identifier hs-var">typeName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409671"><span class="annot"><span class="annottext">rr :: RemoteRelationship
</span><a href="#local-6989586621688409671"><span class="hs-identifier hs-var">rr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Relationships.Remote.html#RemoteRelationship"><span class="hs-identifier hs-type">RemoteRelationship</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688409668"><span id="local-6989586621688409669"><span class="annot"><span class="annottext">RelName
RemoteRelationshipDefinition
_rrDefinition :: RemoteRelationship -&gt; RemoteRelationshipDefinition
_rrName :: RemoteRelationship -&gt; RelName
_rrDefinition :: RemoteRelationshipDefinition
_rrName :: RelName
</span><a href="Hasura.RQL.Types.Relationships.Remote.html#_rrDefinition"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1223"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-1224"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1225"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409665"><span class="annot"><span class="annottext">metadataObject :: MetadataObject
</span><a href="#local-6989586621688409665"><span class="hs-identifier hs-var hs-var">metadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaName, Name, RemoteRelationship) -&gt; MetadataObject
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#mkRemoteSchemaRemoteRelationshipMetadataObject"><span class="hs-identifier hs-var">mkRemoteSchemaRemoteRelationshipMetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409674"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688409672"><span class="hs-identifier hs-var">typeName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteRelationship
</span><a href="#local-6989586621688409671"><span class="hs-identifier hs-var">rr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1226"></span><span>        </span><span id="local-6989586621688409663"><span class="annot"><span class="annottext">schemaObj :: SchemaObjId
</span><a href="#local-6989586621688409663"><span class="hs-identifier hs-var hs-var">schemaObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; Name -&gt; RelName -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SORemoteSchemaRemoteRelationship"><span class="hs-identifier hs-var">SORemoteSchemaRemoteRelationship</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409674"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688409672"><span class="hs-identifier hs-var">typeName</span></a></span><span> </span><span class="annot"><span class="annottext">RelName
</span><a href="#local-6989586621688409669"><span class="hs-identifier hs-var">_rrName</span></a></span><span>
</span><span id="line-1227"></span><span>        </span><span id="local-6989586621688409661"><span class="annot"><span class="annottext">addRemoteRelationshipContext :: Text -&gt; Text
</span><a href="#local-6989586621688409661"><span class="hs-identifier hs-var hs-var">addRemoteRelationshipContext</span></a></span></span><span> </span><span id="local-6989586621688409660"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409660"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in remote relationship&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RelName
</span><a href="#local-6989586621688409669"><span class="hs-identifier hs-var">_rrName</span></a></span><span> </span><span class="annot"><span class="annottext">RelName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688409660"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1228"></span><span>    </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1229"></span><span>      </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) (RemoteFieldInfo Name)
-&gt; arr (a, (MetadataObject, ())) (Maybe (RemoteFieldInfo Name))
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-1230"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-1231"></span><span>            </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) (RemoteFieldInfo Name)
-&gt; ErrorA QErr arr (a, (Text -&gt; Text, ())) (RemoteFieldInfo Name)
forall (arr :: * -&gt; * -&gt; *) e s a.
ArrowError QErr arr =&gt;
arr (e, s) a -&gt; arr (e, (Text -&gt; Text, s)) a
</span><a href="Hasura.Base.Error.html#modifyErrA"><span class="hs-identifier hs-var">modifyErrA</span></a></span><span>
</span><span id="line-1232"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1233"></span><span>                  </span><span id="local-6989586621688409659"><span class="annot"><span class="annottext">HashMap FieldName Name
</span><a href="#local-6989586621688409659"><span class="hs-identifier hs-var">allowedLHSJoinFields</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1234"></span><span>                    </span><span class="annot"><span class="annottext">ErrorA
  QErr arr (m (HashMap FieldName Name)) (HashMap FieldName Name)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span>
</span><span id="line-1235"></span><span>                      </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-1236"></span><span>                        </span><span class="annot"><span class="annottext">RemoteSchemaName
-&gt; RemoteSchemaIntrospection -&gt; Name -&gt; m (HashMap FieldName Name)
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
RemoteSchemaName
-&gt; RemoteSchemaIntrospection -&gt; Name -&gt; m (HashMap FieldName Name)
</span><a href="Hasura.RQL.DDL.RemoteRelationship.html#getRemoteSchemaEntityJoinColumns"><span class="hs-identifier hs-var">getRemoteSchemaEntityJoinColumns</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409674"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaIntrospection
</span><a href="#local-6989586621688409673"><span class="hs-identifier hs-var">remoteSchemaIntrospection</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688409672"><span class="hs-identifier hs-var">typeName</span></a></span><span>
</span><span id="line-1237"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621688409658"><span class="annot"><span class="annottext">RemoteFieldInfo Name
</span><a href="#local-6989586621688409658"><span class="hs-identifier hs-var">remoteField</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409657"><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688409657"><span class="hs-identifier hs-var">rhsDependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1238"></span><span>                    </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (m (RemoteFieldInfo Name, [SchemaDependency]))
  (RemoteFieldInfo Name, [SchemaDependency])
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span>
</span><span id="line-1239"></span><span>                      </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-1240"></span><span>                        </span><span class="annot"><span class="annottext">LHSIdentifier
-&gt; HashMap FieldName Name
-&gt; RemoteRelationship
-&gt; HashMap SourceName (AnyBackend PartiallyResolvedSource)
-&gt; RemoteSchemaMap
-&gt; m (RemoteFieldInfo Name, [SchemaDependency])
forall (m :: * -&gt; *) lhsJoinField.
QErrM m =&gt;
LHSIdentifier
-&gt; HashMap FieldName lhsJoinField
-&gt; RemoteRelationship
-&gt; HashMap SourceName (AnyBackend PartiallyResolvedSource)
-&gt; RemoteSchemaMap
-&gt; m (RemoteFieldInfo lhsJoinField, [SchemaDependency])
</span><a href="Hasura.RQL.DDL.RemoteRelationship.html#buildRemoteFieldInfo"><span class="hs-identifier hs-var">buildRemoteFieldInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; LHSIdentifier
</span><a href="Hasura.RQL.Types.Relationships.ToSchema.html#remoteSchemaToLHSIdentifier"><span class="hs-identifier hs-var">remoteSchemaToLHSIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409674"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap FieldName Name
</span><a href="#local-6989586621688409659"><span class="hs-identifier hs-var">allowedLHSJoinFields</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRelationship
</span><a href="#local-6989586621688409671"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (AnyBackend PartiallyResolvedSource)
</span><a href="#local-6989586621688409676"><span class="hs-identifier hs-var">allSources</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMap
</span><a href="#local-6989586621688409675"><span class="hs-identifier hs-var">remoteSchemaMap</span></a></span><span>
</span><span id="line-1241"></span><span>                  </span><span class="hs-comment">-- buildRemoteFieldInfo only knows how to construct dependencies on the RHS of the join condition,</span><span>
</span><span id="line-1242"></span><span>                  </span><span class="hs-comment">-- so the dependencies on the remote relationship on the LHS entity have to be computed here</span><span>
</span><span id="line-1243"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409655"><span class="annot"><span class="annottext">lhsDependencies :: [SchemaDependency]
</span><a href="#local-6989586621688409655"><span class="hs-identifier hs-var hs-var">lhsDependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1244"></span><span>                        </span><span class="hs-comment">-- a direct dependency on the remote schema on which this is defined</span><span>
</span><span id="line-1245"></span><span>                        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SchemaObjId -&gt; DependencyReason -&gt; SchemaDependency
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SchemaDependency"><span class="hs-identifier hs-var">SchemaDependency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SORemoteSchema"><span class="hs-identifier hs-var">SORemoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409674"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DependencyReason
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#DRRemoteRelationship"><span class="hs-identifier hs-var">DRRemoteRelationship</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1246"></span><span>                  </span><span class="annot"><span class="annottext">ErrorA
  QErr arr (MetadataObject, SchemaObjId, [SchemaDependency]) ()
forall (arr :: * -&gt; * -&gt; *).
ArrowWriter (Seq CollectedInfo) arr =&gt;
arr (MetadataObject, SchemaObjId, [SchemaDependency]) ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordDependencies"><span class="hs-identifier hs-var">recordDependencies</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688409665"><span class="hs-identifier hs-var">metadataObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SchemaObjId
</span><a href="#local-6989586621688409663"><span class="hs-identifier hs-var">schemaObj</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688409655"><span class="hs-identifier hs-var">lhsDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">[SchemaDependency] -&gt; [SchemaDependency] -&gt; [SchemaDependency]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688409657"><span class="hs-identifier hs-var">rhsDependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1247"></span><span>                  </span><span class="annot"><span class="annottext">ErrorA QErr arr (RemoteFieldInfo Name) (RemoteFieldInfo Name)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">RemoteFieldInfo Name
</span><a href="#local-6989586621688409658"><span class="hs-identifier hs-var">remoteField</span></a></span><span>
</span><span id="line-1248"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-1249"></span><span>          </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621688409661"><span class="hs-identifier hs-var">addRemoteRelationshipContext</span></a></span><span>
</span><span id="line-1250"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-1251"></span><span>      </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688409665"><span class="hs-identifier hs-var">metadataObject</span></a></span><span>
</span><span id="line-1252"></span><span>
</span><span id="line-1253"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#mkRemoteSchemaRemoteRelationshipMetadataObject"><span class="hs-identifier hs-type">mkRemoteSchemaRemoteRelationshipMetadataObject</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1254"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">G.Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Relationships.Remote.html#RemoteRelationship"><span class="hs-identifier hs-type">RemoteRelationship</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1255"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span>
</span><span id="line-1256"></span><span id="mkRemoteSchemaRemoteRelationshipMetadataObject"><span class="annot"><span class="annottext">mkRemoteSchemaRemoteRelationshipMetadataObject :: (RemoteSchemaName, Name, RemoteRelationship) -&gt; MetadataObject
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#mkRemoteSchemaRemoteRelationshipMetadataObject"><span class="hs-identifier hs-var hs-var">mkRemoteSchemaRemoteRelationshipMetadataObject</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688409651"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409651"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688409650"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688409650"><span class="hs-identifier hs-var">typeName</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Relationships.Remote.html#RemoteRelationship"><span class="hs-identifier hs-type">RemoteRelationship</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688409648"><span id="local-6989586621688409649"><span class="annot"><span class="annottext">RelName
RemoteRelationshipDefinition
_rrDefinition :: RemoteRelationshipDefinition
_rrName :: RelName
_rrDefinition :: RemoteRelationship -&gt; RemoteRelationshipDefinition
_rrName :: RemoteRelationship -&gt; RelName
</span><a href="#local-6989586621688409648"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1257"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688409647"><span class="annot"><span class="annottext">objectId :: MetadataObjId
</span><a href="#local-6989586621688409647"><span class="hs-identifier hs-var hs-var">objectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1258"></span><span>        </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; Name -&gt; RelName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MORemoteSchemaRemoteRelationship"><span class="hs-identifier hs-var">MORemoteSchemaRemoteRelationship</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409651"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688409650"><span class="hs-identifier hs-var">typeName</span></a></span><span> </span><span class="annot"><span class="annottext">RelName
</span><a href="#local-6989586621688409649"><span class="hs-identifier hs-var">_rrName</span></a></span><span>
</span><span id="line-1259"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="#local-6989586621688409647"><span class="hs-identifier hs-var">objectId</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; MetadataObject) -&gt; Value -&gt; MetadataObject
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1260"></span><span>        </span><span class="annot"><span class="annottext">CreateRemoteSchemaRemoteRelationship -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">(CreateRemoteSchemaRemoteRelationship -&gt; Value)
-&gt; CreateRemoteSchemaRemoteRelationship -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1261"></span><span>          </span><span class="annot"><span class="annottext">RemoteSchemaName
-&gt; Name
-&gt; RelName
-&gt; RemoteRelationshipDefinition
-&gt; CreateRemoteSchemaRemoteRelationship
</span><a href="Hasura.RQL.DDL.RemoteRelationship.html#CreateRemoteSchemaRemoteRelationship"><span class="hs-identifier hs-var">CreateRemoteSchemaRemoteRelationship</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688409651"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688409650"><span class="hs-identifier hs-var">typeName</span></a></span><span> </span><span class="annot"><span class="annottext">RelName
</span><a href="#local-6989586621688409649"><span class="hs-identifier hs-var">_rrName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRelationshipDefinition
</span><a href="#local-6989586621688409648"><span class="hs-identifier hs-var">_rrDefinition</span></a></span><span>
</span><span id="line-1262"></span><span>
</span><span id="line-1263"></span><span class="hs-comment">{- Note [Keep invalidation keys for inconsistent objects]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
After building the schema cache, we prune InvalidationKeys for objects
that no longer exist in the schema to avoid leaking memory for objects
that have been dropped. However, note that we *don&#8217;t* want to drop
keys for objects that are simply inconsistent!

Why? The object is still in the metadata, so next time we reload it,
we&#8217;ll reprocess that object. We want to reuse the cache if its
definition hasn&#8217;t changed, but if we dropped the invalidation key, it
will incorrectly be reprocessed (since the invalidation key changed
from present to absent). -}</span><span>
</span><span id="line-1275"></span></pre></body></html>