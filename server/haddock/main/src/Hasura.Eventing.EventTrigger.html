<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE PatternSynonyms #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- = Event Triggers</span><span>
</span><span id="line-6"></span><span class="hs-comment">--</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Event triggers are like ordinary SQL triggers, except instead of calling a SQL</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- procedure, they call a webhook. The event delivery mechanism involves coordination</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- between both the database and graphql-engine: only the SQL database knows</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- when the events should fire, but only graphql-engine know how to actually</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- deliver them.</span><span>
</span><span id="line-12"></span><span class="hs-comment">--</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- Therefore, event triggers are implemented in two parts:</span><span>
</span><span id="line-14"></span><span class="hs-comment">--</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- 1. Every event trigger is backed by a bona fide SQL trigger. When the SQL trigger</span><span>
</span><span id="line-16"></span><span class="hs-comment">--    fires, it creates a new record in the hdb_catalog.event_log table.</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- 2. Concurrently, a thread in graphql-engine monitors the hdb_catalog.event_log</span><span>
</span><span id="line-19"></span><span class="hs-comment">--    table for new events. When new event(s) are found, it uses the information</span><span>
</span><span id="line-20"></span><span class="hs-comment">--    (URL,payload and headers) stored in the event to deliver the event</span><span>
</span><span id="line-21"></span><span class="hs-comment">--    to the webhook.</span><span>
</span><span id="line-22"></span><span class="hs-comment">--</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- The creation and deletion of SQL trigger itself is managed by the metadata DDL</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- APIs (see Hasura.RQL.DDL.EventTrigger), so this module focuses on event delivery.</span><span>
</span><span id="line-25"></span><span class="hs-comment">--</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- Most of the subtleties involve guaranteeing reliable delivery of events:</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- we guarantee that every event will be delivered at least once,</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- even if graphql-engine crashes. This means we have to record the state</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- of each event in the database, and we have to retry</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- failed requests at a regular (user-configurable) interval.</span><span>
</span><span id="line-31"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Eventing.EventTrigger</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#initEventEngineCtx"><span class="hs-identifier">initEventEngineCtx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier">processEventQueue</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultMaxEventThreads"><span class="hs-identifier">defaultMaxEventThreads</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultFetchInterval"><span class="hs-identifier">defaultFetchInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultFetchBatchSize"><span class="hs-identifier">defaultFetchBatchSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier">Event</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier">EventEngineCtx</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#LogBehavior"><span class="hs-identifier">LogBehavior</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HeaderLogBehavior"><span class="hs-identifier">HeaderLogBehavior</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#ResponseLogBehavior"><span class="hs-identifier">ResponseLogBehavior</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-comment">-- Exported for testing</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier">saveLockedEventTriggerEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier">removeEventTriggerEventFromLockedEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">where</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async.Lifted.Safe</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LA</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier">Forever</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier">sleep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TVar</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadMask</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">bracket_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">finally</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mask_</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.STM</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson.TH</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Has</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.String</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.TByteString.html"><span class="hs-identifier">Data.TByteString</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TBS</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.NonEmpty.html"><span class="hs-identifier">Data.Text.NonEmpty</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Time</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html"><span class="hs-identifier">Hasura.Backends.Postgres.SQL.Types</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#TableName"><span class="hs-identifier">TableName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html"><span class="hs-identifier">Hasura.Eventing.Common</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.HTTP.html"><span class="hs-identifier">Hasura.Eventing.HTTP</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.HTTP.html"><span class="hs-identifier">Hasura.HTTP</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.HTTP.html#getHTTPExceptionStatus"><span class="hs-identifier">getHTTPExceptionStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Headers.html"><span class="hs-identifier">Hasura.RQL.DDL.Headers</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Webhook.Transform.html"><span class="hs-identifier">Hasura.RQL.DDL.Webhook.Transform</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.Types.EventTrigger</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Eventing.Backend</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.Backend.html"><span class="hs-identifier">Hasura.SQL.Backend</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Metrics.html"><span class="hs-identifier">Hasura.Server.Metrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier">ServerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Transformable.html"><span class="hs-identifier">Network.HTTP.Client.Transformable</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HTTP</span></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Metrics.Distribution</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Distribution</span></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Metrics.Gauge</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Gauge</span></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-keyword">newtype</span><span> </span><span id="EventInternalErr"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="EventInternalErr"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688875078"><span id="local-6989586621688875080"><span id="local-6989586621688875082"><span class="annot"><span class="annottext">Int -&gt; EventInternalErr -&gt; ShowS
[EventInternalErr] -&gt; ShowS
EventInternalErr -&gt; String
(Int -&gt; EventInternalErr -&gt; ShowS)
-&gt; (EventInternalErr -&gt; String)
-&gt; ([EventInternalErr] -&gt; ShowS)
-&gt; Show EventInternalErr
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [EventInternalErr] -&gt; ShowS
$cshowList :: [EventInternalErr] -&gt; ShowS
show :: EventInternalErr -&gt; String
$cshow :: EventInternalErr -&gt; String
showsPrec :: Int -&gt; EventInternalErr -&gt; ShowS
$cshowsPrec :: Int -&gt; EventInternalErr -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688875073"><span id="local-6989586621688875075"><span class="annot"><span class="annottext">EventInternalErr -&gt; EventInternalErr -&gt; Bool
(EventInternalErr -&gt; EventInternalErr -&gt; Bool)
-&gt; (EventInternalErr -&gt; EventInternalErr -&gt; Bool)
-&gt; Eq EventInternalErr
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
$c/= :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
== :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
$c== :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Logging.html#ToEngineLog"><span class="hs-identifier hs-type">L.ToEngineLog</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-type">EventInternalErr</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-96"></span><span>  </span><span id="local-6989586621688875068"><span class="annot"><span class="annottext">toEngineLog :: EventInternalErr -&gt; (LogLevel, EngineLogType Hasura, Value)
</span><a href="Hasura.Logging.html#toEngineLog"><span class="hs-identifier hs-var hs-var hs-var hs-var">toEngineLog</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-type">EventInternalErr</span></a></span><span> </span><span id="local-6989586621688875066"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688875066"><span class="hs-identifier hs-var">qerr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">L.LevelError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EngineLogType Hasura
</span><a href="Hasura.Logging.html#eventTriggerLogType"><span class="hs-identifier hs-var">L.eventTriggerLogType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688875066"><span class="hs-identifier hs-var">qerr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-comment">{- Note [Maintenance mode]
~~~~~~~~~~~~~~~~~~~~~~~~~~

Maintenance mode is a mode in which users can upgrade their graphql-engine
without any down time. More on maintenance mode can be found here:
https://github.com/hasura/graphql-engine-mono/issues/431.

Basically, there are a few main things that maintenance mode boils down to:

1. No operation that may change the metadata will be allowed.
2. Migrations are not applied when the graphql-engine is started, so the
   catalog schema will be in the older version.
3. Event triggers should continue working in the new code with the older
   catalog schema i.e it should work even if there are any schema changes
   to the `hdb_catalog.event_log` table.

#1 and #2 are fairly self-explanatory. For #3, we need to support fetching
events depending upon the catalog version. So, fetch events works in the
following way now:

1. Check if maintenance mode is enabled
2. If maintenance mode is enabled then read the catalog version from the DB
   and accordingly fire the appropriate query to the events log table.
   When maintenance mode is disabled, we query the events log table according
   to the latest catalog, we do not read the catalog version for this.
-}</span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="hs-comment">-- | See Note [Maintenance Mode]</span><span>
</span><span id="line-126"></span><span class="hs-keyword">data</span><span> </span><span id="EventEngineCtx"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-var">EventEngineCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EventEngineCtx"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-var">EventEngineCtx</span></a></span></span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_eeCtxEventThreadsCapacity"><span class="annot"><span class="annottext">EventEngineCtx -&gt; TVar Int
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxEventThreadsCapacity"><span class="hs-identifier hs-var hs-var">_eeCtxEventThreadsCapacity</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-128"></span><span>    </span><span id="_eeCtxFetchInterval"><span class="annot"><span class="annottext">EventEngineCtx -&gt; DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxFetchInterval"><span class="hs-identifier hs-var hs-var">_eeCtxFetchInterval</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DiffTime</span></span><span class="hs-special">,</span><span>
</span><span id="line-129"></span><span>    </span><span id="_eeCtxFetchSize"><span class="annot"><span class="annottext">EventEngineCtx -&gt; NonNegativeInt
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxFetchSize"><span class="hs-identifier hs-var hs-var">_eeCtxFetchSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#NonNegativeInt"><span class="hs-identifier hs-type">NonNegativeInt</span></a></span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span class="hs-keyword">data</span><span> </span><span id="DeliveryInfo"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-var">DeliveryInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DeliveryInfo"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-var">DeliveryInfo</span></a></span></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="diCurrentRetry"><span class="annot"><span class="annottext">DeliveryInfo -&gt; Int
</span><a href="Hasura.Eventing.EventTrigger.html#diCurrentRetry"><span class="hs-identifier hs-var hs-var">diCurrentRetry</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>    </span><span id="diMaxRetries"><span class="annot"><span class="annottext">DeliveryInfo -&gt; Int
</span><a href="Hasura.Eventing.EventTrigger.html#diMaxRetries"><span class="hs-identifier hs-var hs-var">diMaxRetries</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688875050"><span id="local-6989586621688875052"><span id="local-6989586621688875054"><span class="annot"><span class="annottext">Int -&gt; DeliveryInfo -&gt; ShowS
[DeliveryInfo] -&gt; ShowS
DeliveryInfo -&gt; String
(Int -&gt; DeliveryInfo -&gt; ShowS)
-&gt; (DeliveryInfo -&gt; String)
-&gt; ([DeliveryInfo] -&gt; ShowS)
-&gt; Show DeliveryInfo
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [DeliveryInfo] -&gt; ShowS
$cshowList :: [DeliveryInfo] -&gt; ShowS
show :: DeliveryInfo -&gt; String
$cshow :: DeliveryInfo -&gt; String
showsPrec :: Int -&gt; DeliveryInfo -&gt; ShowS
$cshowsPrec :: Int -&gt; DeliveryInfo -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688875046"><span id="local-6989586621688875048"><span class="annot"><span class="annottext">DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
(DeliveryInfo -&gt; DeliveryInfo -&gt; Bool)
-&gt; (DeliveryInfo -&gt; DeliveryInfo -&gt; Bool) -&gt; Eq DeliveryInfo
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
$c/= :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
== :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
$c== :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="hs-special">$(</span><span id="local-6989586621688875034"><span id="local-6989586621688875036"><span id="local-6989586621688875038"><span id="local-6989586621688875040"><span id="local-6989586621688875042"><span id="local-6989586621688875044"><span class="hs-identifier">deriveJSON</span><span> </span><span class="hs-identifier">hasuraJSON</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">omitNothingFields</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span class="hs-special">}</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">DeliveryInfo</span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-keyword">newtype</span><span> </span><span id="QualifiedTableStrict"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-var">QualifiedTableStrict</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="QualifiedTableStrict"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-var">QualifiedTableStrict</span></a></span></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="getQualifiedTable"><span class="annot"><span class="annottext">QualifiedTableStrict -&gt; QualifiedTable
</span><a href="Hasura.Eventing.EventTrigger.html#getQualifiedTable"><span class="hs-identifier hs-var hs-var">getQualifiedTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#QualifiedTable"><span class="hs-identifier hs-type">QualifiedTable</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688875022"><span id="local-6989586621688875024"><span id="local-6989586621688875026"><span class="annot"><span class="annottext">Int -&gt; QualifiedTableStrict -&gt; ShowS
[QualifiedTableStrict] -&gt; ShowS
QualifiedTableStrict -&gt; String
(Int -&gt; QualifiedTableStrict -&gt; ShowS)
-&gt; (QualifiedTableStrict -&gt; String)
-&gt; ([QualifiedTableStrict] -&gt; ShowS)
-&gt; Show QualifiedTableStrict
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [QualifiedTableStrict] -&gt; ShowS
$cshowList :: [QualifiedTableStrict] -&gt; ShowS
show :: QualifiedTableStrict -&gt; String
$cshow :: QualifiedTableStrict -&gt; String
showsPrec :: Int -&gt; QualifiedTableStrict -&gt; ShowS
$cshowsPrec :: Int -&gt; QualifiedTableStrict -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688875018"><span id="local-6989586621688875020"><span class="annot"><span class="annottext">QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
(QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool)
-&gt; (QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool)
-&gt; Eq QualifiedTableStrict
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
$c/= :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
== :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
$c== :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688875011"><span id="local-6989586621688875013"><span id="local-6989586621688875015"><span class="annot"><span class="hs-identifier hs-type">J.ToJSON</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-type">QualifiedTableStrict</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-146"></span><span>  </span><span id="local-6989586621688875010"><span class="annot"><span class="annottext">toJSON :: QualifiedTableStrict -&gt; Value
</span><a href="#local-6989586621688875010"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-type">QualifiedTableStrict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#QualifiedObject"><span class="hs-identifier hs-type">QualifiedObject</span></a></span><span> </span><span id="local-6989586621688875008"><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621688875008"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span id="local-6989586621688875007"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621688875007"><span class="hs-identifier hs-var">tn</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-148"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;schema&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; SchemaName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621688875008"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-149"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;name&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; TableName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621688875007"><span class="hs-identifier hs-var">tn</span></a></span><span>
</span><span id="line-150"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span id="local-6989586621688875003"><span id="local-6989586621688875004"></span></span><span class="hs-keyword">data</span><span> </span><span id="EventPayload"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-var">EventPayload</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688875183"><span class="annot"><a href="#local-6989586621688875183"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.SQL.Backend.html#BackendType"><span class="hs-identifier hs-type">BackendType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EventPayload"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-var">EventPayload</span></a></span></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="epId"><span class="annot"><span class="annottext">EventPayload b -&gt; EventId
</span><a href="Hasura.Eventing.EventTrigger.html#epId"><span class="hs-identifier hs-var hs-var">epId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-154"></span><span>    </span><span id="epTable"><span class="annot"><span class="annottext">EventPayload b -&gt; TableName b
</span><a href="Hasura.Eventing.EventTrigger.html#epTable"><span class="hs-identifier hs-var hs-var">epTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875183"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-155"></span><span>    </span><span id="epTrigger"><span class="annot"><span class="annottext">EventPayload b -&gt; TriggerMetadata
</span><a href="Hasura.Eventing.EventTrigger.html#epTrigger"><span class="hs-identifier hs-var hs-var">epTrigger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerMetadata"><span class="hs-identifier hs-type">TriggerMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-156"></span><span>    </span><span id="epEvent"><span class="annot"><span class="annottext">EventPayload b -&gt; Value
</span><a href="Hasura.Eventing.EventTrigger.html#epEvent"><span class="hs-identifier hs-var hs-var">epEvent</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span class="hs-special">,</span><span>
</span><span id="line-157"></span><span>    </span><span id="epDeliveryInfo"><span class="annot"><span class="annottext">EventPayload b -&gt; DeliveryInfo
</span><a href="Hasura.Eventing.EventTrigger.html#epDeliveryInfo"><span class="hs-identifier hs-var hs-var">epDeliveryInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-type">DeliveryInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-158"></span><span>    </span><span id="epCreatedAt"><span class="annot"><span class="annottext">EventPayload b -&gt; UTCTime
</span><a href="Hasura.Eventing.EventTrigger.html#epCreatedAt"><span class="hs-identifier hs-var hs-var">epCreatedAt</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Time.UTCTime</span></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. EventPayload b -&gt; Rep (EventPayload b) x)
-&gt; (forall x. Rep (EventPayload b) x -&gt; EventPayload b)
-&gt; Generic (EventPayload b)
forall x. Rep (EventPayload b) x -&gt; EventPayload b
forall x. EventPayload b -&gt; Rep (EventPayload b) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (b :: BackendType) x.
Rep (EventPayload b) x -&gt; EventPayload b
forall (b :: BackendType) x.
EventPayload b -&gt; Rep (EventPayload b) x
$cto :: forall (b :: BackendType) x.
Rep (EventPayload b) x -&gt; EventPayload b
$cfrom :: forall (b :: BackendType) x.
EventPayload b -&gt; Rep (EventPayload b) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span id="local-6989586621688874986"><span id="local-6989586621688874988"><span id="local-6989586621688874990"><span id="local-6989586621688874992"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688874992"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688874992"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span id="local-6989586621688874981"><span id="local-6989586621688874983"><span id="local-6989586621688874985"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688874985"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688874985"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span id="local-6989586621688874980"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688874973"><span id="local-6989586621688874975"><span id="local-6989586621688874977"><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688874980"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688874980"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-167"></span><span>  </span><span id="local-6989586621688874972"><span class="annot"><span class="annottext">toJSON :: EventPayload b -&gt; Value
</span><a href="#local-6989586621688874972"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; EventPayload b -&gt; Value
forall a.
(Generic a, GToJSON' Value Zero (Rep a)) =&gt;
Options -&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.genericToJSON</span></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="Hasura.Prelude.html#hasuraJSON"><span class="hs-identifier hs-var">hasuraJSON</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">omitNothingFields :: Bool
</span><a href="#local-6989586621688874969"><span class="hs-identifier hs-var">omitNothingFields</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">}</span></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultMaxEventThreads"><span class="hs-identifier hs-type">defaultMaxEventThreads</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-170"></span><span id="defaultMaxEventThreads"><span class="annot"><span class="annottext">defaultMaxEventThreads :: Int
</span><a href="Hasura.Eventing.EventTrigger.html#defaultMaxEventThreads"><span class="hs-identifier hs-var hs-var">defaultMaxEventThreads</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100</span></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultFetchInterval"><span class="hs-identifier hs-type">defaultFetchInterval</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DiffTime</span></span><span>
</span><span id="line-173"></span><span id="defaultFetchInterval"><span class="annot"><span class="annottext">defaultFetchInterval :: DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#defaultFetchInterval"><span class="hs-identifier hs-var hs-var">defaultFetchInterval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Seconds -&gt; DiffTime
</span><a href="Data.Time.Clock.Units.html#seconds"><span class="hs-identifier hs-var hs-var">seconds</span></a></span><span> </span><span class="annot"><span class="annottext">Seconds
</span><span class="hs-number">1</span></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultFetchBatchSize"><span class="hs-identifier hs-type">defaultFetchBatchSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#NonNegativeInt"><span class="hs-identifier hs-type">NonNegativeInt</span></a></span><span>
</span><span id="line-176"></span><span id="defaultFetchBatchSize"><span class="annot"><span class="annottext">defaultFetchBatchSize :: NonNegativeInt
</span><a href="Hasura.Eventing.EventTrigger.html#defaultFetchBatchSize"><span class="hs-identifier hs-var hs-var">defaultFetchBatchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; NonNegativeInt
</span><a href="Hasura.RQL.Types.Common.html#unsafeNonNegativeInt"><span class="hs-identifier hs-var">unsafeNonNegativeInt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100</span></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#initEventEngineCtx"><span class="hs-identifier hs-type">initEventEngineCtx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DiffTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#NonNegativeInt"><span class="hs-identifier hs-type">NonNegativeInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span>
</span><span id="line-179"></span><span id="initEventEngineCtx"><span class="annot"><span class="annottext">initEventEngineCtx :: Int -&gt; DiffTime -&gt; NonNegativeInt -&gt; STM EventEngineCtx
</span><a href="Hasura.Eventing.EventTrigger.html#initEventEngineCtx"><span class="hs-identifier hs-var hs-var">initEventEngineCtx</span></a></span></span><span> </span><span id="local-6989586621688874966"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874966"><span class="hs-identifier hs-var">maxT</span></a></span></span><span> </span><span id="local-6989586621688874965"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688874965"><span class="hs-identifier hs-var">_eeCtxFetchInterval</span></a></span></span><span> </span><span id="local-6989586621688874964"><span class="annot"><span class="annottext">NonNegativeInt
</span><a href="#local-6989586621688874964"><span class="hs-identifier hs-var">_eeCtxFetchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-180"></span><span>  </span><span id="local-6989586621688874963"><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621688874963"><span class="hs-identifier hs-var">_eeCtxEventThreadsCapacity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; STM (TVar Int)
forall a. a -&gt; STM (TVar a)
</span><span class="hs-identifier hs-var">newTVar</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874966"><span class="hs-identifier hs-var">maxT</span></a></span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><span class="annottext">EventEngineCtx -&gt; STM EventEngineCtx
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(EventEngineCtx -&gt; STM EventEngineCtx)
-&gt; EventEngineCtx -&gt; STM EventEngineCtx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventEngineCtx :: TVar Int -&gt; DiffTime -&gt; NonNegativeInt -&gt; EventEngineCtx
</span><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">TVar Int
DiffTime
NonNegativeInt
_eeCtxEventThreadsCapacity :: TVar Int
_eeCtxFetchSize :: NonNegativeInt
_eeCtxFetchInterval :: DiffTime
_eeCtxFetchSize :: NonNegativeInt
_eeCtxFetchInterval :: DiffTime
_eeCtxEventThreadsCapacity :: TVar Int
</span><a href="#local-6989586621688874963"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span id="local-6989586621688875286"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier hs-type">saveLockedEventTriggerEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688875286"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688875286"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-184"></span><span id="saveLockedEventTriggerEvents"><span class="annot"><span class="annottext">saveLockedEventTriggerEvents :: SourceName
-&gt; [EventId] -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier hs-var hs-var">saveLockedEventTriggerEvents</span></a></span></span><span> </span><span id="local-6989586621688874961"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874961"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621688874960"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621688874960"><span class="hs-identifier hs-var">eventIds</span></a></span></span><span> </span><span id="local-6989586621688874959"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621688874959"><span class="hs-identifier hs-var">lockedEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-185"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>      </span><span id="local-6989586621688874956"><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621688874956"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
-&gt; STM (HashMap SourceName (Set EventId))
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621688874959"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; HashMap SourceName (Set EventId) -&gt; Maybe (Set EventId)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874961"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621688874956"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-189"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Set EventId)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621688874959"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName (Set EventId) -&gt; STM ())
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Set EventId -&gt; HashMap SourceName (Set EventId)
forall k v. Hashable k =&gt; k -&gt; v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874961"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EventId] -&gt; Set EventId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621688874960"><span class="hs-identifier hs-var">eventIds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Set EventId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621688874959"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName (Set EventId) -&gt; STM ())
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">(Set EventId -&gt; Set EventId -&gt; Set EventId)
-&gt; SourceName
-&gt; Set EventId
-&gt; HashMap SourceName (Set EventId)
-&gt; HashMap SourceName (Set EventId)
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.insertWith</span></span><span> </span><span class="annot"><span class="annottext">Set EventId -&gt; Set EventId -&gt; Set EventId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.union</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874961"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EventId] -&gt; Set EventId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621688874960"><span class="hs-identifier hs-var">eventIds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621688874956"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span id="local-6989586621688875142"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier hs-type">removeEventTriggerEventFromLockedEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688875142"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688875142"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-194"></span><span id="removeEventTriggerEventFromLockedEvents"><span class="annot"><span class="annottext">removeEventTriggerEventFromLockedEvents :: SourceName
-&gt; EventId -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier hs-var hs-var">removeEventTriggerEventFromLockedEvents</span></a></span></span><span> </span><span id="local-6989586621688874947"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874947"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621688874946"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621688874946"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span id="local-6989586621688874945"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621688874945"><span class="hs-identifier hs-var">lockedEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-195"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-197"></span><span>      </span><span id="local-6989586621688874944"><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621688874944"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
-&gt; STM (HashMap SourceName (Set EventId))
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621688874945"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621688874945"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName (Set EventId) -&gt; STM ())
-&gt; HashMap SourceName (Set EventId) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">(Set EventId -&gt; Set EventId)
-&gt; SourceName
-&gt; HashMap SourceName (Set EventId)
-&gt; HashMap SourceName (Set EventId)
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v) -&gt; k -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.adjust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventId -&gt; Set EventId -&gt; Set EventId
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.delete</span></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621688874946"><span class="hs-identifier hs-var">eventId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874947"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621688874944"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-keyword">type</span><span> </span><span id="BackendEventWithSource"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#BackendEventWithSource"><span class="hs-identifier hs-var">BackendEventWithSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html#AnyBackend"><span class="hs-identifier hs-type">AB.AnyBackend</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-keyword">type</span><span> </span><span id="FetchEventArguments"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchEventArguments"><span class="hs-identifier hs-var">FetchEventArguments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#BackendEventWithSource"><span class="hs-identifier hs-type">BackendEventWithSource</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span class="hs-comment">-- | Service events from our in-DB queue.</span><span>
</span><span id="line-205"></span><span class="hs-comment">--</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- There are a few competing concerns and constraints here; we want to...</span><span>
</span><span id="line-207"></span><span class="hs-comment">--   - fetch events in batches for lower DB pressure</span><span>
</span><span id="line-208"></span><span class="hs-comment">--   - don't fetch more than N at a time (since that can mean: space leak, less</span><span>
</span><span id="line-209"></span><span class="hs-comment">--     effective scale out, possible double sends for events we've checked out</span><span>
</span><span id="line-210"></span><span class="hs-comment">--     on exit (TODO clean shutdown procedure))</span><span>
</span><span id="line-211"></span><span class="hs-comment">--   - try not to cause webhook workers to stall waiting on DB fetch</span><span>
</span><span id="line-212"></span><span class="hs-comment">--   - limit webhook HTTP concurrency per HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE</span><span>
</span><span id="line-213"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier hs-type">processEventQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688874940"><span class="annot"><a href="#local-6989586621688874940"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688874940"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><a href="Hasura.Tracing.html#HasReporter"><span class="hs-identifier hs-type">Tracing.HasReporter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688874940"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688874940"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">LA.Forall</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LA.Pure</span></span><span> </span><span class="annot"><a href="#local-6989586621688874940"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621688874940"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#LogBehavior"><span class="hs-identifier hs-type">LogBehavior</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">HTTP.Manager</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#SchemaCache"><span class="hs-identifier hs-type">SchemaCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-226"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-227"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-229"></span><span>  </span><span class="annot"><a href="#local-6989586621688874940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier hs-type">Forever</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688874940"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span id="processEventQueue"><span class="annot"><span class="annottext">processEventQueue :: Logger Hasura
-&gt; LogBehavior
-&gt; Manager
-&gt; IO SchemaCache
-&gt; EventEngineCtx
-&gt; LockedEventsCtx
-&gt; ServerMetrics
-&gt; MaintenanceMode ()
-&gt; m (Forever m)
</span><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier hs-var hs-var">processEventQueue</span></a></span></span><span> </span><span id="local-6989586621688874939"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688874939"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688874938"><span class="annot"><span class="annottext">LogBehavior
</span><a href="#local-6989586621688874938"><span class="hs-identifier hs-var">logBehavior</span></a></span></span><span> </span><span id="local-6989586621688874937"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688874937"><span class="hs-identifier hs-var">httpMgr</span></a></span></span><span> </span><span id="local-6989586621688874936"><span class="annot"><span class="annottext">IO SchemaCache
</span><a href="#local-6989586621688874936"><span class="hs-identifier hs-var">getSchemaCache</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688874933"><span id="local-6989586621688874934"><span id="local-6989586621688874935"><span class="annot"><span class="annottext">TVar Int
DiffTime
NonNegativeInt
_eeCtxFetchSize :: NonNegativeInt
_eeCtxFetchInterval :: DiffTime
_eeCtxEventThreadsCapacity :: TVar Int
_eeCtxFetchSize :: EventEngineCtx -&gt; NonNegativeInt
_eeCtxFetchInterval :: EventEngineCtx -&gt; DiffTime
_eeCtxEventThreadsCapacity :: EventEngineCtx -&gt; TVar Int
</span><a href="#local-6989586621688874933"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688874931"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
leEvents :: LockedEventsCtx -&gt; TVar (HashMap SourceName (Set EventId))
leEvents :: TVar (HashMap SourceName (Set EventId))
</span><a href="Hasura.Eventing.Common.html#leEvents"><span class="hs-identifier hs-var hs-var">leEvents</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621688874929"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688874929"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span> </span><span id="local-6989586621688874928"><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621688874928"><span class="hs-identifier hs-var">maintenanceMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-231"></span><span>  </span><span id="local-6989586621688874927"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621688874927"><span class="hs-identifier hs-var">events0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [BackendEventWithSource]
</span><a href="#local-6989586621688874926"><span class="hs-identifier hs-var">popEventsBatch</span></a></span><span>
</span><span id="line-232"></span><span>  </span><span class="annot"><span class="annottext">Forever m -&gt; m (Forever m)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Forever m -&gt; m (Forever m)) -&gt; Forever m -&gt; m (Forever m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([BackendEventWithSource], Int, Bool)
-&gt; (([BackendEventWithSource], Int, Bool)
    -&gt; m ([BackendEventWithSource], Int, Bool))
-&gt; Forever m
forall (m :: * -&gt; *) a. a -&gt; (a -&gt; m a) -&gt; Forever m
</span><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier hs-var">Forever</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621688874927"><span class="hs-identifier hs-var">events0</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([BackendEventWithSource], Int, Bool)
-&gt; m ([BackendEventWithSource], Int, Bool)
</span><a href="#local-6989586621688874924"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-234"></span><span>    </span><span id="local-6989586621688874923"><span class="annot"><span class="annottext">fetchBatchSize :: Int
</span><a href="#local-6989586621688874923"><span class="hs-identifier hs-var hs-var">fetchBatchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonNegativeInt -&gt; Int
</span><a href="Hasura.RQL.Types.Common.html#getNonNegativeInt"><span class="hs-identifier hs-var hs-var">getNonNegativeInt</span></a></span><span> </span><span class="annot"><span class="annottext">NonNegativeInt
</span><a href="#local-6989586621688874933"><span class="hs-identifier hs-var">_eeCtxFetchSize</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><a href="#local-6989586621688874926"><span class="hs-identifier hs-type">popEventsBatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621688874940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#BackendEventWithSource"><span class="hs-identifier hs-type">BackendEventWithSource</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-237"></span><span>    </span><span id="local-6989586621688874926"><span class="annot"><span class="annottext">popEventsBatch :: m [BackendEventWithSource]
</span><a href="#local-6989586621688874926"><span class="hs-identifier hs-var hs-var">popEventsBatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>      </span><span class="hs-comment">{-
        SELECT FOR UPDATE .. SKIP LOCKED can throw serialization errors in RepeatableRead: https://stackoverflow.com/a/53289263/1911889
        We can avoid this safely by running it in ReadCommitted as Postgres will recheck the
        predicate condition if a row is updated concurrently: https://www.postgresql.org/docs/9.5/transaction-iso.html#XACT-READ-COMMITTED

        Every other action on an event_log row (like post-processing, archival, etc) are single writes (no R-W or W-R)
        so it is safe to perform them in ReadCommitted as well (the writes will then acquire some serial order).
        Any serial order of updates to a row will lead to an eventually consistent state as the row will have
        (delivered=t or error=t or archived=t) after a fixed number of tries (assuming it begins with locked='f').
      -}</span><span>
</span><span id="line-248"></span><span>      </span><span id="local-6989586621688874921"><span class="annot"><span class="annottext">SourceCache
</span><a href="#local-6989586621688874921"><span class="hs-identifier hs-var">allSources</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; SourceCache) -&gt; m SchemaCache -&gt; m SourceCache
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO SchemaCache -&gt; m SchemaCache
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO SchemaCache
</span><a href="#local-6989586621688874936"><span class="hs-identifier hs-var">getSchemaCache</span></a></span><span>
</span><span id="line-249"></span><span>      </span><span class="annot"><span class="annottext">IO [BackendEventWithSource] -&gt; m [BackendEventWithSource]
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO [BackendEventWithSource] -&gt; m [BackendEventWithSource])
-&gt; (IO [[BackendEventWithSource]] -&gt; IO [BackendEventWithSource])
-&gt; IO [[BackendEventWithSource]]
-&gt; m [BackendEventWithSource]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([[BackendEventWithSource]] -&gt; [BackendEventWithSource])
-&gt; IO [[BackendEventWithSource]] -&gt; IO [BackendEventWithSource]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[[BackendEventWithSource]] -&gt; [BackendEventWithSource]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">(IO [[BackendEventWithSource]] -&gt; m [BackendEventWithSource])
-&gt; IO [[BackendEventWithSource]] -&gt; m [BackendEventWithSource]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-250"></span><span>        </span><span class="hs-comment">-- fetch pending events across all the sources asynchronously</span><span>
</span><span id="line-251"></span><span>        </span><span class="annot"><span class="annottext">[(SourceName, BackendSourceInfo)]
-&gt; ((SourceName, BackendSourceInfo) -&gt; IO [BackendEventWithSource])
-&gt; IO [[BackendEventWithSource]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, MonadBaseControl IO m, Forall (Pure m)) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">LA.forConcurrently</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceCache -&gt; [(SourceName, BackendSourceInfo)]
forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">SourceCache
</span><a href="#local-6989586621688874921"><span class="hs-identifier hs-var">allSources</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688874914"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874914"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688874913"><span class="annot"><span class="annottext">BackendSourceInfo
</span><a href="#local-6989586621688874913"><span class="hs-identifier hs-var">sourceCache</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-252"></span><span>          </span><span class="annot"><span class="annottext">BackendSourceInfo
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceInfo b -&gt; IO [BackendEventWithSource])
-&gt; IO [BackendEventWithSource]
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceInfo
</span><a href="#local-6989586621688874913"><span class="hs-identifier hs-var">sourceCache</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688874911"><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span id="local-6989586621688874909"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874909"><span class="hs-identifier hs-var">_sourceName</span></a></span></span><span> </span><span id="local-6989586621688874908"><span class="annot"><span class="annottext">TableCache b
</span><a href="#local-6989586621688874908"><span class="hs-identifier hs-var">tableCache</span></a></span></span><span> </span><span id="local-6989586621688874907"><span class="annot"><span class="annottext">FunctionCache b
</span><a href="#local-6989586621688874907"><span class="hs-identifier hs-var">_functionCache</span></a></span></span><span> </span><span id="local-6989586621688874906"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874906"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621688874905"><span class="annot"><span class="annottext">Maybe QueryTagsConfig
</span><a href="#local-6989586621688874905"><span class="hs-identifier hs-var">_queryTagsConfig</span></a></span></span><span> </span><span id="local-6989586621688874904"><span class="annot"><span class="annottext">SourceCustomization
</span><a href="#local-6989586621688874904"><span class="hs-identifier hs-var">_sourceCustomization</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688874911"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-253"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874903"><span class="annot"><span class="annottext">tables :: [TableInfo b]
</span><a href="#local-6989586621688874903"><span class="hs-identifier hs-var hs-var">tables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableCache b -&gt; [TableInfo b]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">TableCache b
</span><a href="#local-6989586621688874908"><span class="hs-identifier hs-var">tableCache</span></a></span><span>
</span><span id="line-254"></span><span>                </span><span id="local-6989586621688874901"><span class="annot"><span class="annottext">triggerMap :: [EventTriggerInfoMap b]
</span><a href="#local-6989586621688874901"><span class="hs-identifier hs-var hs-var">triggerMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableInfo b -&gt; EventTriggerInfoMap b
forall (b :: BackendType). TableInfo b -&gt; EventTriggerInfoMap b
</span><a href="Hasura.RQL.Types.Table.html#_tiEventTriggerInfoMap"><span class="hs-identifier hs-var hs-var">_tiEventTriggerInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">(TableInfo b -&gt; EventTriggerInfoMap b)
-&gt; [TableInfo b] -&gt; [EventTriggerInfoMap b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[TableInfo b]
</span><a href="#local-6989586621688874903"><span class="hs-identifier hs-var">tables</span></a></span><span>
</span><span id="line-255"></span><span>                </span><span id="local-6989586621688874899"><span class="annot"><span class="annottext">eventTriggerCount :: Int
</span><a href="#local-6989586621688874899"><span class="hs-identifier hs-var hs-var">eventTriggerCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfoMap b -&gt; Int
forall k v. HashMap k v -&gt; Int
</span><span class="hs-identifier hs-var">M.size</span></span><span> </span><span class="annot"><span class="annottext">(EventTriggerInfoMap b -&gt; Int) -&gt; [EventTriggerInfoMap b] -&gt; [Int]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[EventTriggerInfoMap b]
</span><a href="#local-6989586621688874901"><span class="hs-identifier hs-var">triggerMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>                </span><span id="local-6989586621688874896"><span class="annot"><span class="annottext">triggerNames :: [TriggerName]
</span><a href="#local-6989586621688874896"><span class="hs-identifier hs-var hs-var">triggerNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[TriggerName]] -&gt; [TriggerName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[TriggerName]] -&gt; [TriggerName])
-&gt; [[TriggerName]] -&gt; [TriggerName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfoMap b -&gt; [TriggerName]
forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">(EventTriggerInfoMap b -&gt; [TriggerName])
-&gt; [EventTriggerInfoMap b] -&gt; [[TriggerName]]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[EventTriggerInfoMap b]
</span><a href="#local-6989586621688874901"><span class="hs-identifier hs-var">triggerMap</span></a></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>            </span><span class="hs-comment">-- only process events for this source if at least one event trigger exists</span><span>
</span><span id="line-259"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874899"><span class="hs-identifier hs-var">eventTriggerCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-260"></span><span>              </span><span class="hs-keyword">then</span><span>
</span><span id="line-261"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr IO [Event b] -&gt; IO (Either QErr [Event b])
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceConfig b
-&gt; SourceName
-&gt; [TriggerName]
-&gt; MaintenanceMode ()
-&gt; FetchBatchSize
-&gt; ExceptT QErr IO [Event b]
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b
-&gt; SourceName
-&gt; [TriggerName]
-&gt; MaintenanceMode ()
-&gt; FetchBatchSize
-&gt; m [Event b]
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#fetchUndeliveredEvents"><span class="hs-identifier hs-var">fetchUndeliveredEvents</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688874911"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874906"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874914"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621688874896"><span class="hs-identifier hs-var">triggerNames</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621688874928"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; FetchBatchSize
</span><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-var">FetchBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874923"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO (Either QErr [Event b])
-&gt; (Either QErr [Event b] -&gt; IO [BackendEventWithSource])
-&gt; IO [BackendEventWithSource]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-262"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621688874890"><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621688874890"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>                      </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Distribution.add</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smNumEventsFetchedPerBatch"><span class="hs-identifier hs-var hs-var">smNumEventsFetchedPerBatch</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688874929"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Double) -&gt; Int -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Event b] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621688874890"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>                      </span><span id="local-6989586621688874886"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874886"><span class="hs-identifier hs-var">eventsFetchedTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; IO UTCTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-265"></span><span>                      </span><span class="annot"><span class="annottext">SourceName
-&gt; [EventId] -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
SourceName
-&gt; [EventId] -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier hs-var">saveLockedEventTriggerEvents</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874914"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">(Event b -&gt; EventId) -&gt; [Event b] -&gt; [EventId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621688874890"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621688874931"><span class="hs-identifier hs-var">leEvents</span></a></span><span>
</span><span id="line-266"></span><span>                      </span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; IO [BackendEventWithSource]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([BackendEventWithSource] -&gt; IO [BackendEventWithSource])
-&gt; [BackendEventWithSource] -&gt; IO [BackendEventWithSource]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Event b -&gt; BackendEventWithSource)
-&gt; [Event b] -&gt; [BackendEventWithSource]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688874883"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874883"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
forall (i :: BackendType -&gt; *). HasTag b =&gt; i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688874911"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">(EventWithSource b -&gt; BackendEventWithSource)
-&gt; EventWithSource b -&gt; BackendEventWithSource
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event b
-&gt; SourceConfig b -&gt; SourceName -&gt; UTCTime -&gt; EventWithSource b
forall (b :: BackendType).
Event b
-&gt; SourceConfig b -&gt; SourceName -&gt; UTCTime -&gt; EventWithSource b
</span><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-var">EventWithSource</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874883"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874906"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874914"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874886"><span class="hs-identifier hs-var">eventsFetchedTime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621688874890"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-267"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688874880"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688874880"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>                      </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688874939"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(EventInternalErr -&gt; IO ()) -&gt; EventInternalErr -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; EventInternalErr
</span><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688874880"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-269"></span><span>                      </span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; IO [BackendEventWithSource]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-270"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; IO [BackendEventWithSource]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-comment">-- !!! CAREFUL !!!</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-comment">--     The logic here in particular is subtle and has been fixed, broken,</span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-comment">--     and fixed again in several different ways, several times.</span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-comment">-- !!! CAREFUL !!!</span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-comment">-- work on this batch of events while prefetching the next. Recurse after we've forked workers</span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-comment">-- for each in the batch, minding the requested pool size.</span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><a href="#local-6989586621688874924"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchEventArguments"><span class="hs-identifier hs-type">FetchEventArguments</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688874940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchEventArguments"><span class="hs-identifier hs-type">FetchEventArguments</span></a></span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621688874924"><span class="annot"><span class="annottext">go :: ([BackendEventWithSource], Int, Bool)
-&gt; m ([BackendEventWithSource], Int, Bool)
</span><a href="#local-6989586621688874924"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688874878"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621688874878"><span class="hs-identifier hs-var">events</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688874877"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874877"><span class="hs-identifier hs-var">fullFetchCount</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688874876"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688874876"><span class="hs-identifier hs-var">alreadyWarned</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>      </span><span class="hs-comment">-- process events ASAP until we've caught up; only then can we sleep</span><span>
</span><span id="line-283"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621688874878"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; (IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">sleep</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688874934"><span class="hs-identifier hs-var">_eeCtxFetchInterval</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>      </span><span class="hs-comment">-- Prefetch next events payload while concurrently working through our current batch.</span><span>
</span><span id="line-286"></span><span>      </span><span class="hs-comment">-- NOTE: we probably don't need to prefetch so early, but probably not</span><span>
</span><span id="line-287"></span><span>      </span><span class="hs-comment">-- worth the effort for something more fine-tuned</span><span>
</span><span id="line-288"></span><span>      </span><span id="local-6989586621688874873"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621688874873"><span class="hs-identifier hs-var">eventsNext</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [BackendEventWithSource]
-&gt; (Async [BackendEventWithSource] -&gt; m [BackendEventWithSource])
-&gt; m [BackendEventWithSource]
forall (m :: * -&gt; *) a b.
(MonadBaseControl IO m, Forall (Pure m)) =&gt;
m a -&gt; (Async a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">LA.withAsync</span></span><span> </span><span class="annot"><span class="annottext">m [BackendEventWithSource]
</span><a href="#local-6989586621688874926"><span class="hs-identifier hs-var">popEventsBatch</span></a></span><span> </span><span class="annot"><span class="annottext">((Async [BackendEventWithSource] -&gt; m [BackendEventWithSource])
 -&gt; m [BackendEventWithSource])
-&gt; (Async [BackendEventWithSource] -&gt; m [BackendEventWithSource])
-&gt; m [BackendEventWithSource]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688874871"><span class="annot"><span class="annottext">Async [BackendEventWithSource]
</span><a href="#local-6989586621688874871"><span class="hs-identifier hs-var">eventsNextA</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-289"></span><span>        </span><span class="hs-comment">-- process approximately in order, minding HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE:</span><span>
</span><span id="line-290"></span><span>        </span><span class="annot"><span class="annottext">[BackendEventWithSource]
-&gt; (BackendEventWithSource -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621688874878"><span class="hs-identifier hs-var">events</span></a></span><span> </span><span class="annot"><span class="annottext">((BackendEventWithSource -&gt; m ()) -&gt; m ())
-&gt; (BackendEventWithSource -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688874869"><span class="annot"><span class="annottext">BackendEventWithSource
</span><a href="#local-6989586621688874869"><span class="hs-identifier hs-var">eventWithSource</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-291"></span><span>          </span><span class="hs-comment">-- NOTE: we implement a logical bracket pattern here with the</span><span>
</span><span id="line-292"></span><span>          </span><span class="hs-comment">-- increment and decrement of _eeCtxEventThreadsCapacity which</span><span>
</span><span id="line-293"></span><span>          </span><span class="hs-comment">-- depends on not putting anything that can throw in the body here:</span><span>
</span><span id="line-294"></span><span>          </span><span class="annot"><span class="annottext">BackendEventWithSource
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    EventWithSource b -&gt; m ())
-&gt; m ()
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">BackendEventWithSource
</span><a href="#local-6989586621688874869"><span class="hs-identifier hs-var">eventWithSource</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688874868"><span id="local-6989586621688874867"><span class="annot"><span class="annottext">EventWithSource b
</span><a href="#local-6989586621688874867"><span class="hs-identifier hs-var">eventWithSource'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688874868"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-295"></span><span>            </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-296"></span><span>              </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-297"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>                  </span><span class="hs-comment">-- block until &lt; HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE threads:</span><span>
</span><span id="line-299"></span><span>                  </span><span id="local-6989586621688874866"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874866"><span class="hs-identifier hs-var">capacity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Int -&gt; STM Int
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621688874935"><span class="hs-identifier hs-var">_eeCtxEventThreadsCapacity</span></a></span><span>
</span><span id="line-300"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; STM ()
</span><span class="hs-identifier hs-var">check</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM ()) -&gt; Bool -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874866"><span class="hs-identifier hs-var">capacity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-301"></span><span>                  </span><span class="annot"><span class="annottext">TVar Int -&gt; Int -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621688874935"><span class="hs-identifier hs-var">_eeCtxEventThreadsCapacity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874866"><span class="hs-identifier hs-var">capacity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>              </span><span class="hs-comment">-- since there is some capacity in our worker threads, we can launch another:</span><span>
</span><span id="line-303"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874864"><span class="annot"><span class="annottext">restoreCapacity :: ReaderT (Logger Hasura, Manager) m ()
</span><a href="#local-6989586621688874864"><span class="hs-identifier hs-var hs-var">restoreCapacity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-304"></span><span>                    </span><span class="annot"><span class="annottext">IO () -&gt; ReaderT (Logger Hasura, Manager) m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ReaderT (Logger Hasura, Manager) m ())
-&gt; IO () -&gt; ReaderT (Logger Hasura, Manager) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-305"></span><span>                      </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-306"></span><span>                        </span><span class="annot"><span class="annottext">TVar Int -&gt; (Int -&gt; Int) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621688874935"><span class="hs-identifier hs-var">_eeCtxEventThreadsCapacity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>              </span><span id="local-6989586621688874861"><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621688874861"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-308"></span><span>                </span><span class="annot"><span class="annottext">m () -&gt; m (Async ())
forall (m :: * -&gt; *) a.
(MonadBaseControl IO m, Forall (Pure m)) =&gt;
m a -&gt; m (Async a)
</span><span class="hs-identifier hs-var">LA.async</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m (Async ())) -&gt; m () -&gt; m (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-309"></span><span>                  </span><span class="annot"><span class="annottext">(ReaderT (Logger Hasura, Manager) m ()
 -&gt; (Logger Hasura, Manager) -&gt; m ())
-&gt; (Logger Hasura, Manager)
-&gt; ReaderT (Logger Hasura, Manager) m ()
-&gt; m ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Logger Hasura, Manager) m ()
-&gt; (Logger Hasura, Manager) -&gt; m ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688874939"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688874937"><span class="hs-identifier hs-var">httpMgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ReaderT (Logger Hasura, Manager) m () -&gt; m ())
-&gt; ReaderT (Logger Hasura, Manager) m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-310"></span><span>                    </span><span class="annot"><span class="annottext">EventWithSource b -&gt; ReaderT (Logger Hasura, Manager) m ()
forall (io :: * -&gt; *) r (b :: BackendType).
(MonadIO io, MonadReader r io, Has Manager r,
 Has (Logger Hasura) r, HasReporter io, MonadMask io,
 BackendEventTrigger b) =&gt;
EventWithSource b -&gt; io ()
</span><a href="#local-6989586621688874857"><span class="hs-identifier hs-var">processEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventWithSource b
</span><a href="#local-6989586621688874867"><span class="hs-identifier hs-var">eventWithSource'</span></a></span><span>
</span><span id="line-311"></span><span>                      </span><span class="annot"><span class="annottext">ReaderT (Logger Hasura, Manager) m ()
-&gt; ReaderT (Logger Hasura, Manager) m ()
-&gt; ReaderT (Logger Hasura, Manager) m ()
forall (m :: * -&gt; *) a b. MonadMask m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span>
</span><span id="line-312"></span><span>                      </span><span class="hs-comment">-- NOTE!: this needs to happen IN THE FORKED THREAD:</span><span>
</span><span id="line-313"></span><span>                      </span><span class="annot"><span class="annottext">ReaderT (Logger Hasura, Manager) m ()
</span><a href="#local-6989586621688874864"><span class="hs-identifier hs-var">restoreCapacity</span></a></span><span>
</span><span id="line-314"></span><span>              </span><span class="annot"><span class="annottext">Async () -&gt; m ()
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; Async a -&gt; m ()
</span><span class="hs-identifier hs-var">LA.link</span></span><span> </span><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621688874861"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-comment">-- return when next batch ready; some 'processEvent' threads may be running.</span><span>
</span><span id="line-317"></span><span>        </span><span class="annot"><span class="annottext">Async [BackendEventWithSource] -&gt; m [BackendEventWithSource]
forall (m :: * -&gt; *) a.
(MonadBase IO m, Forall (Pure m)) =&gt;
Async a -&gt; m a
</span><span class="hs-identifier hs-var">LA.wait</span></span><span> </span><span class="annot"><span class="annottext">Async [BackendEventWithSource]
</span><a href="#local-6989586621688874871"><span class="hs-identifier hs-var">eventsNextA</span></a></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874854"><span class="annot"><span class="annottext">lenEvents :: Int
</span><a href="#local-6989586621688874854"><span class="hs-identifier hs-var hs-var">lenEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621688874878"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-320"></span><span>      </span><span class="hs-keyword">if</span><span>
</span><span id="line-321"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874854"><span class="hs-identifier hs-var">lenEvents</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874923"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-322"></span><span>            </span><span class="hs-comment">-- If we've seen N fetches in a row from the DB come back full (i.e. only limited</span><span>
</span><span id="line-323"></span><span>            </span><span class="hs-comment">-- by our LIMIT clause), then we say we're clearly falling behind:</span><span>
</span><span id="line-324"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874853"><span class="annot"><span class="annottext">clearlyBehind :: Bool
</span><a href="#local-6989586621688874853"><span class="hs-identifier hs-var hs-var">clearlyBehind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874877"><span class="hs-identifier hs-var">fullFetchCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span>
</span><span id="line-325"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688874876"><span class="hs-identifier hs-var">alreadyWarned</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-326"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688874853"><span class="hs-identifier hs-var">clearlyBehind</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-327"></span><span>                </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688874939"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(UnstructuredLog -&gt; m ()) -&gt; UnstructuredLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-328"></span><span>                  </span><span class="annot"><span class="annottext">LogLevel -&gt; TByteString -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">L.LevelWarn</span></a></span><span> </span><span class="annot"><span class="annottext">(TByteString -&gt; UnstructuredLog) -&gt; TByteString -&gt; UnstructuredLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-329"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; TByteString
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; TByteString) -&gt; String -&gt; TByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-330"></span><span>                      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Events processor may not be keeping up with events generated in postgres, &quot;</span></span><span>
</span><span id="line-331"></span><span>                        </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;or we're working on a backlog of events. Consider increasing &quot;</span></span><span>
</span><span id="line-332"></span><span>                        </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE&quot;</span></span><span>
</span><span id="line-333"></span><span>            </span><span class="annot"><span class="annottext">([BackendEventWithSource], Int, Bool)
-&gt; m ([BackendEventWithSource], Int, Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621688874873"><span class="hs-identifier hs-var">eventsNext</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874877"><span class="hs-identifier hs-var">fullFetchCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688874876"><span class="hs-identifier hs-var">alreadyWarned</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688874853"><span class="hs-identifier hs-var">clearlyBehind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874854"><span class="hs-identifier hs-var">lenEvents</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874923"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688874876"><span class="hs-identifier hs-var">alreadyWarned</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-336"></span><span>              </span><span class="hs-comment">-- emit as warning in case users are only logging warning severity and saw above</span><span>
</span><span id="line-337"></span><span>              </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688874939"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(UnstructuredLog -&gt; m ()) -&gt; UnstructuredLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-338"></span><span>                </span><span class="annot"><span class="annottext">LogLevel -&gt; TByteString -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">L.LevelWarn</span></a></span><span> </span><span class="annot"><span class="annottext">(TByteString -&gt; UnstructuredLog) -&gt; TByteString -&gt; UnstructuredLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-339"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; TByteString
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; TByteString) -&gt; String -&gt; TByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-340"></span><span>                    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;It looks like the events processor is keeping up again.&quot;</span></span><span>
</span><span id="line-341"></span><span>            </span><span class="annot"><span class="annottext">([BackendEventWithSource], Int, Bool)
-&gt; m ([BackendEventWithSource], Int, Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621688874873"><span class="hs-identifier hs-var">eventsNext</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><a href="#local-6989586621688874857"><span class="hs-identifier hs-type">processEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-344"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688875246"><span class="annot"><a href="#local-6989586621688875246"><span class="hs-identifier hs-type">io</span></a></span></span><span> </span><span id="local-6989586621688875245"><span class="annot"><a href="#local-6989586621688875245"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621688875241"><span class="annot"><a href="#local-6989586621688875241"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688875246"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-346"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621688875245"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875246"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-347"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Has</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HTTP.Manager</span></span><span> </span><span class="annot"><a href="#local-6989586621688875245"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-348"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Has</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688875245"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-349"></span><span>        </span><span class="annot"><a href="Hasura.Tracing.html#HasReporter"><span class="hs-identifier hs-type">Tracing.HasReporter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875246"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621688875246"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875241"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-352"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-353"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875241"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-354"></span><span>      </span><span class="annot"><a href="#local-6989586621688875246"><span class="hs-identifier hs-type">io</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>    </span><span id="local-6989586621688874857"><span class="annot"><span class="annottext">processEvent :: EventWithSource b -&gt; io ()
</span><a href="#local-6989586621688874857"><span class="hs-identifier hs-var hs-var">processEvent</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span> </span><span id="local-6989586621688874846"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874846"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621688874845"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874845"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621688874844"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874844"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621688874843"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874843"><span class="hs-identifier hs-var">eventFetchedTime</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-356"></span><span>      </span><span class="hs-comment">-- Track Queue Time of Event (in seconds). See `smEventQueueTime`</span><span>
</span><span id="line-357"></span><span>      </span><span class="hs-comment">-- Queue Time = Time when the event was fetched from DB - Time when the event is being processed</span><span>
</span><span id="line-358"></span><span>      </span><span id="local-6989586621688874842"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874842"><span class="hs-identifier hs-var">eventProcessTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; io UTCTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-359"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874841"><span class="annot"><span class="annottext">eventQueueTime :: Double
</span><a href="#local-6989586621688874841"><span class="hs-identifier hs-var hs-var">eventQueueTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; Double
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; Double) -&gt; NominalDiffTime -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">diffUTCTime</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874842"><span class="hs-identifier hs-var">eventProcessTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874843"><span class="hs-identifier hs-var">eventFetchedTime</span></a></span><span>
</span><span id="line-360"></span><span>      </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; io ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; io ()) -&gt; IO () -&gt; io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Distribution.add</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smEventQueueTime"><span class="hs-identifier hs-var hs-var">smEventQueueTime</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688874929"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621688874841"><span class="hs-identifier hs-var">eventQueueTime</span></a></span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span>      </span><span id="local-6989586621688874838"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688874838"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO SchemaCache -&gt; io SchemaCache
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO SchemaCache
</span><a href="#local-6989586621688874936"><span class="hs-identifier hs-var">getSchemaCache</span></a></span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span>      </span><span id="local-6989586621688874837"><span class="annot"><span class="annottext">Maybe TraceContext
</span><a href="#local-6989586621688874837"><span class="hs-identifier hs-var">tracingCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe TraceContext) -&gt; io (Maybe TraceContext)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; IO (Maybe TraceContext)
</span><a href="Hasura.Tracing.html#extractEventContext"><span class="hs-identifier hs-var">Tracing.extractEventContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; Value
forall (b :: BackendType). Event b -&gt; Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eEvent"><span class="hs-identifier hs-var hs-var">eEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874846"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-365"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874834"><span class="annot"><span class="annottext">spanName :: EventTriggerInfo b -&gt; Text
</span><a href="#local-6989586621688874834"><span class="hs-identifier hs-var hs-var">spanName</span></a></span></span><span> </span><span id="local-6989586621688874833"><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688874833"><span class="hs-identifier hs-var">eti</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Event trigger: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">NonEmptyText -&gt; Text
</span><a href="Data.Text.NonEmpty.html#unNonEmptyText"><span class="hs-identifier hs-var hs-var">unNonEmptyText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; NonEmptyText
</span><a href="Hasura.RQL.Types.EventTrigger.html#unTriggerName"><span class="hs-identifier hs-var hs-var">unTriggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; TriggerName
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688874833"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>          </span><span id="local-6989586621688874829"><span class="annot"><span class="annottext">runTraceT :: Text -&gt; TraceT io () -&gt; io ()
</span><a href="#local-6989586621688874829"><span class="hs-identifier hs-var hs-var">runTraceT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-367"></span><span>            </span><span class="annot"><span class="annottext">(Text -&gt; TraceT io () -&gt; io ())
-&gt; (TraceContext -&gt; Text -&gt; TraceT io () -&gt; io ())
-&gt; Maybe TraceContext
-&gt; Text
-&gt; TraceT io ()
-&gt; io ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span>
</span><span id="line-368"></span><span>              </span><span class="annot"><span class="annottext">Text -&gt; TraceT io () -&gt; io ()
forall (m :: * -&gt; *) a.
(HasReporter m, MonadIO m) =&gt;
Text -&gt; TraceT m a -&gt; m a
</span><a href="Hasura.Tracing.html#runTraceT"><span class="hs-identifier hs-var">Tracing.runTraceT</span></a></span><span>
</span><span id="line-369"></span><span>              </span><span class="annot"><span class="annottext">TraceContext -&gt; Text -&gt; TraceT io () -&gt; io ()
forall (m :: * -&gt; *) a.
(MonadIO m, HasReporter m) =&gt;
TraceContext -&gt; Text -&gt; TraceT m a -&gt; m a
</span><a href="Hasura.Tracing.html#runTraceTInContext"><span class="hs-identifier hs-var">Tracing.runTraceTInContext</span></a></span><span>
</span><span id="line-370"></span><span>              </span><span class="annot"><span class="annottext">Maybe TraceContext
</span><a href="#local-6989586621688874837"><span class="hs-identifier hs-var">tracingCtx</span></a></span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span>      </span><span id="local-6989586621688874825"><span class="annot"><span class="annottext">Either QErr (MaintenanceMode MaintenanceModeVersion)
</span><a href="#local-6989586621688874825"><span class="hs-identifier hs-var">maintenanceModeVersionEither</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-373"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621688874928"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-374"></span><span>          </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-375"></span><span>            </span><span class="annot"><span class="annottext">ExceptT QErr io MaintenanceModeVersion
-&gt; io (Either QErr MaintenanceModeVersion)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceConfig b -&gt; ExceptT QErr io MaintenanceModeVersion
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b -&gt; m MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#getMaintenanceModeVersion"><span class="hs-identifier hs-var">getMaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688875241"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874845"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">io (Either QErr MaintenanceModeVersion)
-&gt; (Either QErr MaintenanceModeVersion
    -&gt; Either QErr (MaintenanceMode MaintenanceModeVersion))
-&gt; io (Either QErr (MaintenanceMode MaintenanceModeVersion))
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-376"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688874821"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688874821"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Either QErr (MaintenanceMode MaintenanceModeVersion)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688874821"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-377"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621688874820"><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="#local-6989586621688874820"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
-&gt; Either QErr (MaintenanceMode MaintenanceModeVersion)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(MaintenanceMode MaintenanceModeVersion
 -&gt; Either QErr (MaintenanceMode MaintenanceModeVersion))
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; Either QErr (MaintenanceMode MaintenanceModeVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaintenanceModeVersion -&gt; MaintenanceMode MaintenanceModeVersion
forall a. a -&gt; MaintenanceMode a
</span><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-var">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="#local-6989586621688874820"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>          </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either QErr (MaintenanceMode MaintenanceModeVersion)
-&gt; io (Either QErr (MaintenanceMode MaintenanceModeVersion))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr (MaintenanceMode MaintenanceModeVersion)
 -&gt; io (Either QErr (MaintenanceMode MaintenanceModeVersion)))
-&gt; Either QErr (MaintenanceMode MaintenanceModeVersion)
-&gt; io (Either QErr (MaintenanceMode MaintenanceModeVersion))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
-&gt; Either QErr (MaintenanceMode MaintenanceModeVersion)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
forall a. MaintenanceMode a
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr (MaintenanceMode MaintenanceModeVersion)
</span><a href="#local-6989586621688874825"><span class="hs-identifier hs-var">maintenanceModeVersionEither</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-381"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688874818"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688874818"><span class="hs-identifier hs-var">maintenanceModeVersionErr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688874818"><span class="hs-identifier hs-var">maintenanceModeVersionErr</span></a></span><span>
</span><span id="line-382"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621688874816"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621688874816"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-383"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; Event b -&gt; Either Text (EventTriggerInfo b)
forall (b :: BackendType).
Backend b =&gt;
SchemaCache -&gt; Event b -&gt; Either Text (EventTriggerInfo b)
</span><a href="Hasura.Eventing.EventTrigger.html#getEventTriggerInfoFromEvent"><span class="hs-identifier hs-var">getEventTriggerInfoFromEvent</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688874838"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874846"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-384"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688874814"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688874814"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-385"></span><span>              </span><span class="hs-comment">--  This rare error can happen in the following known cases:</span><span>
</span><span id="line-386"></span><span>              </span><span class="hs-comment">--  i) schema cache is not up-to-date (due to some bug, say during schema syncing across multiple instances)</span><span>
</span><span id="line-387"></span><span>              </span><span class="hs-comment">--  ii) the event trigger is dropped when this event was just fetched</span><span>
</span><span id="line-388"></span><span>              </span><span class="annot"><span class="annottext">QErr -&gt; io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span> </span><span class="annot"><span class="annottext">(QErr -&gt; io ()) -&gt; QErr -&gt; io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="Hasura.Base.Error.html#err500"><span class="hs-identifier hs-var">err500</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#Unexpected"><span class="hs-identifier hs-var">Unexpected</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688874814"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-389"></span><span>              </span><span id="local-6989586621688874811"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874811"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; io UTCTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-390"></span><span>              </span><span class="hs-comment">-- For such an event, we unlock the event and retry after a minute</span><span>
</span><span id="line-391"></span><span>              </span><span class="annot"><span class="annottext">ExceptT QErr io () -&gt; io (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceConfig b
-&gt; Event b
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; ExceptT QErr io ()
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m ()
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#setRetry"><span class="hs-identifier hs-var">setRetry</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874845"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874846"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NominalDiffTime -&gt; UTCTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">addUTCTime</span></span><span> </span><span class="annot"><span class="annottext">NominalDiffTime
</span><span class="hs-number">60</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874811"><span class="hs-identifier hs-var">currentTime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621688874816"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>                </span><span class="annot"><span class="annottext">io (Either QErr ()) -&gt; (Either QErr () -&gt; io ()) -&gt; io ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ())
-&gt; (QErr -&gt; io ()) -&gt; Either QErr () -&gt; io ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; io ()) -&gt; io ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-393"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621688874807"><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688874807"><span class="hs-identifier hs-var">eti</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TraceT io () -&gt; io ()
</span><a href="#local-6989586621688874829"><span class="hs-identifier hs-var">runTraceT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; Text
forall (b :: BackendType). EventTriggerInfo b -&gt; Text
</span><a href="#local-6989586621688874834"><span class="hs-identifier hs-var">spanName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688874807"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-394"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874806"><span class="annot"><span class="annottext">webhook :: ResolvedWebhook
</span><a href="#local-6989586621688874806"><span class="hs-identifier hs-var hs-var">webhook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WebhookConfInfo -&gt; ResolvedWebhook
</span><a href="Hasura.RQL.Types.EventTrigger.html#wciCachedValue"><span class="hs-identifier hs-var hs-var">wciCachedValue</span></a></span><span> </span><span class="annot"><span class="annottext">(WebhookConfInfo -&gt; ResolvedWebhook)
-&gt; WebhookConfInfo -&gt; ResolvedWebhook
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; WebhookConfInfo
forall (b :: BackendType). EventTriggerInfo b -&gt; WebhookConfInfo
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiWebhookInfo"><span class="hs-identifier hs-var hs-var">etiWebhookInfo</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688874807"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-395"></span><span>                  </span><span id="local-6989586621688874803"><span class="annot"><span class="annottext">retryConf :: RetryConf
</span><a href="#local-6989586621688874803"><span class="hs-identifier hs-var hs-var">retryConf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; RetryConf
forall (b :: BackendType). EventTriggerInfo b -&gt; RetryConf
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiRetryConf"><span class="hs-identifier hs-var hs-var">etiRetryConf</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688874807"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-396"></span><span>                  </span><span id="local-6989586621688874801"><span class="annot"><span class="annottext">timeoutSeconds :: Int
</span><a href="#local-6989586621688874801"><span class="hs-identifier hs-var hs-var">timeoutSeconds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#defaultTimeoutSeconds"><span class="hs-identifier hs-var">defaultTimeoutSeconds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RetryConf -&gt; Maybe Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcTimeoutSec"><span class="hs-identifier hs-var hs-var">rcTimeoutSec</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621688874803"><span class="hs-identifier hs-var">retryConf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>                  </span><span id="local-6989586621688874797"><span class="annot"><span class="annottext">httpTimeout :: ResponseTimeout
</span><a href="#local-6989586621688874797"><span class="hs-identifier hs-var hs-var">httpTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ResponseTimeout
</span><span class="hs-identifier hs-var">HTTP.responseTimeoutMicro</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874801"><span class="hs-identifier hs-var">timeoutSeconds</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000000</span></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621688874794"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688874794"><span class="hs-identifier hs-var">headers</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688874793"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874793"><span class="hs-identifier hs-var">logHeaders</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LogBehavior -&gt; [EventHeaderInfo] -&gt; ([Header], [HeaderConf])
</span><a href="Hasura.Eventing.HTTP.html#prepareHeaders"><span class="hs-identifier hs-var">prepareHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">LogBehavior
</span><a href="#local-6989586621688874938"><span class="hs-identifier hs-var">logBehavior</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; [EventHeaderInfo]
forall (b :: BackendType). EventTriggerInfo b -&gt; [EventHeaderInfo]
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiHeaders"><span class="hs-identifier hs-var hs-var">etiHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688874807"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>                  </span><span id="local-6989586621688874790"><span class="annot"><span class="annottext">ep :: EventPayload b
</span><a href="#local-6989586621688874790"><span class="hs-identifier hs-var hs-var">ep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetryConf -&gt; Event b -&gt; EventPayload b
forall (b :: BackendType). RetryConf -&gt; Event b -&gt; EventPayload b
</span><a href="Hasura.Eventing.EventTrigger.html#createEventPayload"><span class="hs-identifier hs-var">createEventPayload</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621688874803"><span class="hs-identifier hs-var">retryConf</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874846"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-400"></span><span>                  </span><span id="local-6989586621688874788"><span class="annot"><span class="annottext">payload :: ByteString
</span><a href="#local-6989586621688874788"><span class="hs-identifier hs-var hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; ByteString) -&gt; Value -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventPayload b -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">EventPayload b
</span><a href="#local-6989586621688874790"><span class="hs-identifier hs-var">ep</span></a></span><span>
</span><span id="line-401"></span><span>                  </span><span id="local-6989586621688874786"><span class="annot"><span class="annottext">extraLogCtx :: ExtraLogContext
</span><a href="#local-6989586621688874786"><span class="hs-identifier hs-var hs-var">extraLogCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Maybe TriggerName -&gt; ExtraLogContext
</span><a href="Hasura.Eventing.HTTP.html#ExtraLogContext"><span class="hs-identifier hs-var">ExtraLogContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventPayload b -&gt; EventId
forall (b :: BackendType). EventPayload b -&gt; EventId
</span><a href="Hasura.Eventing.EventTrigger.html#epId"><span class="hs-identifier hs-var hs-var">epId</span></a></span><span> </span><span class="annot"><span class="annottext">EventPayload b
</span><a href="#local-6989586621688874790"><span class="hs-identifier hs-var">ep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; Maybe TriggerName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TriggerName -&gt; Maybe TriggerName)
-&gt; TriggerName -&gt; Maybe TriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; TriggerName
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688874807"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>                  </span><span id="local-6989586621688874784"><span class="annot"><span class="annottext">requestTransform :: Maybe RequestTransform
</span><a href="#local-6989586621688874784"><span class="hs-identifier hs-var hs-var">requestTransform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; Maybe RequestTransform
forall (b :: BackendType).
EventTriggerInfo b -&gt; Maybe RequestTransform
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiRequestTransform"><span class="hs-identifier hs-var hs-var">etiRequestTransform</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688874807"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-403"></span><span>                  </span><span id="local-6989586621688874782"><span class="annot"><span class="annottext">responseTransform :: Maybe ResponseTransform
</span><a href="#local-6989586621688874782"><span class="hs-identifier hs-var hs-var">responseTransform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataResponseTransform -&gt; ResponseTransform
</span><a href="Hasura.RQL.DDL.Webhook.Transform.html#mkResponseTransform"><span class="hs-identifier hs-var">mkResponseTransform</span></a></span><span> </span><span class="annot"><span class="annottext">(MetadataResponseTransform -&gt; ResponseTransform)
-&gt; Maybe MetadataResponseTransform -&gt; Maybe ResponseTransform
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b -&gt; Maybe MetadataResponseTransform
forall (b :: BackendType).
EventTriggerInfo b -&gt; Maybe MetadataResponseTransform
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiResponseTransform"><span class="hs-identifier hs-var hs-var">etiResponseTransform</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621688874807"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-404"></span><span>              </span><span id="local-6989586621688874779"><span class="annot"><span class="annottext">Either
  (TransformableRequestError 'EventType)
  (Request, HTTPResp 'EventType)
</span><a href="#local-6989586621688874779"><span class="hs-identifier hs-var">eitherReqRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-405"></span><span>                </span><span class="annot"><span class="annottext">ExceptT
  (TransformableRequestError 'EventType)
  (TraceT io)
  (Request, HTTPResp 'EventType)
-&gt; TraceT
     io
     (Either
        (TransformableRequestError 'EventType)
        (Request, HTTPResp 'EventType))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TransformableRequestError 'EventType)
   (TraceT io)
   (Request, HTTPResp 'EventType)
 -&gt; TraceT
      io
      (Either
         (TransformableRequestError 'EventType)
         (Request, HTTPResp 'EventType)))
-&gt; ExceptT
     (TransformableRequestError 'EventType)
     (TraceT io)
     (Request, HTTPResp 'EventType)
-&gt; TraceT
     io
     (Either
        (TransformableRequestError 'EventType)
        (Request, HTTPResp 'EventType))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-406"></span><span>                  </span><span class="annot"><span class="annottext">[Header]
-&gt; ResponseTimeout
-&gt; ByteString
-&gt; Maybe RequestTransform
-&gt; ResolvedWebhook
-&gt; ExceptT
     (TransformableRequestError 'EventType) (TraceT io) RequestDetails
forall (a :: TriggerTypes) (m :: * -&gt; *).
MonadError (TransformableRequestError a) m =&gt;
[Header]
-&gt; ResponseTimeout
-&gt; ByteString
-&gt; Maybe RequestTransform
-&gt; ResolvedWebhook
-&gt; m RequestDetails
</span><a href="Hasura.Eventing.HTTP.html#mkRequest"><span class="hs-identifier hs-var">mkRequest</span></a></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688874794"><span class="hs-identifier hs-var">headers</span></a></span><span> </span><span class="annot"><span class="annottext">ResponseTimeout
</span><a href="#local-6989586621688874797"><span class="hs-identifier hs-var">httpTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688874788"><span class="hs-identifier hs-var">payload</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe RequestTransform
</span><a href="#local-6989586621688874784"><span class="hs-identifier hs-var">requestTransform</span></a></span><span> </span><span class="annot"><span class="annottext">ResolvedWebhook
</span><a href="#local-6989586621688874806"><span class="hs-identifier hs-var">webhook</span></a></span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TransformableRequestError 'EventType) (TraceT io) RequestDetails
-&gt; (RequestDetails
    -&gt; ExceptT
         (TransformableRequestError 'EventType)
         (TraceT io)
         (Request, HTTPResp 'EventType))
-&gt; ExceptT
     (TransformableRequestError 'EventType)
     (TraceT io)
     (Request, HTTPResp 'EventType)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688874777"><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621688874777"><span class="hs-identifier hs-var">reqDetails</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-407"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874776"><span class="annot"><span class="annottext">request :: Request
</span><a href="#local-6989586621688874776"><span class="hs-identifier hs-var hs-var">request</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RequestDetails -&gt; Request
</span><a href="Hasura.Eventing.HTTP.html#extractRequest"><span class="hs-identifier hs-var">extractRequest</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621688874777"><span class="hs-identifier hs-var">reqDetails</span></a></span><span>
</span><span id="line-408"></span><span>                        </span><span id="local-6989586621688874774"><span class="annot"><span class="annottext">logger' :: Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; RequestDetails
-&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
</span><a href="#local-6989586621688874774"><span class="hs-identifier hs-var hs-var">logger'</span></a></span></span><span> </span><span id="local-6989586621688874773"><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
</span><a href="#local-6989586621688874773"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span id="local-6989586621688874772"><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621688874772"><span class="hs-identifier hs-var">details</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; ExtraLogContext
-&gt; RequestDetails
-&gt; LogBehavior
-&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; ExtraLogContext -&gt; RequestDetails -&gt; LogBehavior -&gt; m ()
</span><a href="Hasura.Eventing.HTTP.html#logHTTPForET"><span class="hs-identifier hs-var">logHTTPForET</span></a></span><span> </span><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
</span><a href="#local-6989586621688874773"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">ExtraLogContext
</span><a href="#local-6989586621688874786"><span class="hs-identifier hs-var">extraLogCtx</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621688874772"><span class="hs-identifier hs-var">details</span></a></span><span> </span><span class="annot"><span class="annottext">LogBehavior
</span><a href="#local-6989586621688874938"><span class="hs-identifier hs-var">logBehavior</span></a></span><span>
</span><span id="line-409"></span><span>                    </span><span class="hs-comment">-- Event Triggers have a configuration parameter called</span><span>
</span><span id="line-410"></span><span>                    </span><span class="hs-comment">-- HASURA_GRAPHQL_EVENTS_HTTP_WORKERS, which is used</span><span>
</span><span id="line-411"></span><span>                    </span><span class="hs-comment">-- to control the concurrency of http delivery.</span><span>
</span><span id="line-412"></span><span>                    </span><span class="hs-comment">-- This bracket is used to increment and decrement an</span><span>
</span><span id="line-413"></span><span>                    </span><span class="hs-comment">-- HTTP Worker EKG Gauge for the duration of the</span><span>
</span><span id="line-414"></span><span>                    </span><span class="hs-comment">-- request invocation</span><span>
</span><span id="line-415"></span><span>                    </span><span id="local-6989586621688874770"><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621688874770"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-416"></span><span>                      </span><span class="annot"><span class="annottext">ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
-&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
-&gt; ExceptT
     (TransformableRequestError 'EventType)
     (TraceT io)
     (HTTPResp 'EventType)
-&gt; ExceptT
     (TransformableRequestError 'EventType)
     (TraceT io)
     (HTTPResp 'EventType)
forall (m :: * -&gt; *) a c b. MonadMask m =&gt; m a -&gt; m c -&gt; m b -&gt; m b
</span><span class="hs-identifier hs-var">bracket_</span></span><span>
</span><span id="line-417"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO ()
-&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ()
 -&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ())
-&gt; IO ()
-&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Gauge.inc</span></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smNumEventHTTPWorkers"><span class="hs-identifier hs-var hs-var">smNumEventHTTPWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688874929"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO ()
-&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ()
 -&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ())
-&gt; IO ()
-&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Gauge.dec</span></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smNumEventHTTPWorkers"><span class="hs-identifier hs-var hs-var">smNumEventHTTPWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688874929"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestDetails
-&gt; Maybe ResponseTransform
-&gt; Maybe SessionVariables
-&gt; (Either (HTTPErr 'EventType) (HTTPResp 'EventType)
    -&gt; RequestDetails
    -&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ())
-&gt; ExceptT
     (TransformableRequestError 'EventType)
     (TraceT io)
     (HTTPResp 'EventType)
forall r (m :: * -&gt; *) (a :: TriggerTypes).
(MonadReader r m, MonadError (TransformableRequestError a) m,
 Has Manager r, Has (Logger Hasura) r, MonadIO m, MonadTrace m) =&gt;
RequestDetails
-&gt; Maybe ResponseTransform
-&gt; Maybe SessionVariables
-&gt; (Either (HTTPErr a) (HTTPResp a) -&gt; RequestDetails -&gt; m ())
-&gt; m (HTTPResp a)
</span><a href="Hasura.Eventing.HTTP.html#invokeRequest"><span class="hs-identifier hs-var">invokeRequest</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621688874777"><span class="hs-identifier hs-var">reqDetails</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseTransform
</span><a href="#local-6989586621688874782"><span class="hs-identifier hs-var">responseTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestDetails -&gt; Maybe SessionVariables
</span><a href="Hasura.Eventing.HTTP.html#_rdSessionVars"><span class="hs-identifier hs-var hs-var">_rdSessionVars</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621688874777"><span class="hs-identifier hs-var">reqDetails</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; RequestDetails
-&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
</span><a href="#local-6989586621688874774"><span class="hs-identifier hs-var">logger'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span>                    </span><span class="annot"><span class="annottext">(Request, HTTPResp 'EventType)
-&gt; ExceptT
     (TransformableRequestError 'EventType)
     (TraceT io)
     (Request, HTTPResp 'EventType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688874776"><span class="hs-identifier hs-var">request</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621688874770"><span class="hs-identifier hs-var">resp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (TransformableRequestError 'EventType)
  (Request, HTTPResp 'EventType)
</span><a href="#local-6989586621688874779"><span class="hs-identifier hs-var">eitherReqRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-422"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688874764"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688874764"><span class="hs-identifier hs-var">req</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688874763"><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621688874763"><span class="hs-identifier hs-var">resp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-423"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874762"><span class="annot"><span class="annottext">reqBody :: Value
</span><a href="#local-6989586621688874762"><span class="hs-identifier hs-var hs-var">reqBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value -&gt; Value
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier hs-var">J.Null</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Value -&gt; Value) -&gt; Maybe Value -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Getting (Maybe ByteString) Request (Maybe ByteString)
-&gt; Request -&gt; Maybe ByteString
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting (Maybe ByteString) Request (Maybe ByteString)
Lens' Request (Maybe ByteString)
</span><a href="Network.HTTP.Client.Transformable.html#body"><span class="hs-identifier hs-var">HTTP.body</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688874764"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; (ByteString -&gt; Maybe Value) -&gt; Maybe Value
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">FromJSON Value =&gt; ByteString -&gt; Maybe Value
forall a. FromJSON a =&gt; ByteString -&gt; Maybe a
</span><span class="hs-identifier hs-var">J.decode</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-424"></span><span>                   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">SourceConfig b
-&gt; Event b
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPResp 'EventType
-&gt; TraceT io (Either QErr ())
forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b) =&gt;
SourceConfig b
-&gt; Event b
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPResp a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processSuccess"><span class="hs-identifier hs-var">processSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874845"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874846"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874793"><span class="hs-identifier hs-var">logHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874762"><span class="hs-identifier hs-var">reqBody</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621688874816"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621688874763"><span class="hs-identifier hs-var">resp</span></a></span><span> </span><span class="annot"><span class="annottext">TraceT io (Either QErr ())
-&gt; (Either QErr () -&gt; TraceT io ()) -&gt; TraceT io ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; (QErr -&gt; TraceT io ()) -&gt; TraceT io ())
-&gt; (QErr -&gt; TraceT io ()) -&gt; Either QErr () -&gt; TraceT io ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; TraceT io ()) -&gt; TraceT io ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; TraceT io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-425"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPError"><span class="hs-identifier hs-type">HTTPError</span></a></span><span> </span><span id="local-6989586621688874755"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874755"><span class="hs-identifier hs-var">reqBody</span></a></span></span><span> </span><span id="local-6989586621688874754"><span class="annot"><span class="annottext">HTTPErr 'EventType
</span><a href="#local-6989586621688874754"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-426"></span><span>                  </span><span class="annot"><span class="annottext">SourceConfig b
-&gt; Event b
-&gt; RetryConf
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPErr 'EventType
-&gt; TraceT io (Either QErr ())
forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b) =&gt;
SourceConfig b
-&gt; Event b
-&gt; RetryConf
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPErr a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processError"><span class="hs-identifier hs-var">processError</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688875241"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874845"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874846"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621688874803"><span class="hs-identifier hs-var">retryConf</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874793"><span class="hs-identifier hs-var">logHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874755"><span class="hs-identifier hs-var">reqBody</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621688874816"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr 'EventType
</span><a href="#local-6989586621688874754"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">TraceT io (Either QErr ())
-&gt; (Either QErr () -&gt; TraceT io ()) -&gt; TraceT io ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; (QErr -&gt; TraceT io ()) -&gt; TraceT io ())
-&gt; (QErr -&gt; TraceT io ()) -&gt; Either QErr () -&gt; TraceT io ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; TraceT io ()) -&gt; TraceT io ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; TraceT io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-427"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.HTTP.html#TransformationError"><span class="hs-identifier hs-type">TransformationError</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688874751"><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621688874751"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-428"></span><span>                  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688874939"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(UnstructuredLog -&gt; TraceT io ())
-&gt; UnstructuredLog -&gt; TraceT io ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; TByteString -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">L.LevelError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; TByteString
</span><a href="Data.TByteString.html#fromLBS"><span class="hs-identifier hs-var">TBS.fromLBS</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; TByteString) -&gt; ByteString -&gt; TByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TransformErrorBundle -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621688874751"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span>                  </span><span class="hs-comment">-- Record an Event Error</span><span>
</span><span id="line-431"></span><span>                  </span><span class="annot"><span class="annottext">SourceConfig b
-&gt; Event b
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; TraceT io (Either QErr ())
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#recordError%27"><span class="hs-identifier hs-var">recordError'</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688875241"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874845"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874846"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetError"><span class="hs-identifier hs-var">PESetError</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621688874816"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">TraceT io (Either QErr ())
-&gt; (Either QErr () -&gt; TraceT io ()) -&gt; TraceT io ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; (QErr -&gt; TraceT io ()) -&gt; TraceT io ())
-&gt; (QErr -&gt; TraceT io ()) -&gt; Either QErr () -&gt; TraceT io ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; TraceT io ()) -&gt; TraceT io ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; TraceT io ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-432"></span><span>      </span><span class="hs-comment">-- removing an event from the _eeCtxLockedEvents after the event has been processed:</span><span>
</span><span id="line-433"></span><span>      </span><span class="annot"><span class="annottext">SourceName
-&gt; EventId -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; io ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
SourceName
-&gt; EventId -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier hs-var">removeEventTriggerEventFromLockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688874844"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874846"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621688874931"><span class="hs-identifier hs-var">leEvents</span></a></span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span id="local-6989586621688875187"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#createEventPayload"><span class="hs-identifier hs-type">createEventPayload</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RetryConf"><span class="hs-identifier hs-type">RetryConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875187"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875187"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-436"></span><span id="createEventPayload"><span class="annot"><span class="annottext">createEventPayload :: RetryConf -&gt; Event b -&gt; EventPayload b
</span><a href="Hasura.Eventing.EventTrigger.html#createEventPayload"><span class="hs-identifier hs-var hs-var">createEventPayload</span></a></span></span><span> </span><span id="local-6989586621688874747"><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621688874747"><span class="hs-identifier hs-var">retryConf</span></a></span></span><span> </span><span id="local-6989586621688874746"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874746"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-437"></span><span>  </span><span class="annot"><span class="annottext">EventPayload :: forall (b :: BackendType).
EventId
-&gt; TableName b
-&gt; TriggerMetadata
-&gt; Value
-&gt; DeliveryInfo
-&gt; UTCTime
-&gt; EventPayload b
</span><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span>
</span><span id="line-438"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">epId :: EventId
</span><a href="Hasura.Eventing.EventTrigger.html#epId"><span class="hs-identifier hs-var">epId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874746"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-439"></span><span>      </span><span class="annot"><span class="annottext">epTable :: TableName b
</span><a href="Hasura.Eventing.EventTrigger.html#epTable"><span class="hs-identifier hs-var">epTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; TableName b
forall (b :: BackendType). Event b -&gt; TableName b
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTable"><span class="hs-identifier hs-var hs-var">eTable</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874746"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-440"></span><span>      </span><span class="annot"><span class="annottext">epTrigger :: TriggerMetadata
</span><a href="Hasura.Eventing.EventTrigger.html#epTrigger"><span class="hs-identifier hs-var">epTrigger</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; TriggerMetadata
forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874746"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-441"></span><span>      </span><span class="annot"><span class="annottext">epEvent :: Value
</span><a href="Hasura.Eventing.EventTrigger.html#epEvent"><span class="hs-identifier hs-var">epEvent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; Value
forall (b :: BackendType). Event b -&gt; Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eEvent"><span class="hs-identifier hs-var hs-var">eEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874746"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-442"></span><span>      </span><span class="annot"><span class="annottext">epDeliveryInfo :: DeliveryInfo
</span><a href="Hasura.Eventing.EventTrigger.html#epDeliveryInfo"><span class="hs-identifier hs-var">epDeliveryInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-443"></span><span>        </span><span class="annot"><span class="annottext">DeliveryInfo :: Int -&gt; Int -&gt; DeliveryInfo
</span><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-type">DeliveryInfo</span></a></span><span>
</span><span id="line-444"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">diCurrentRetry :: Int
</span><a href="Hasura.Eventing.EventTrigger.html#diCurrentRetry"><span class="hs-identifier hs-var">diCurrentRetry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; Int
forall (b :: BackendType). Event b -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTries"><span class="hs-identifier hs-var hs-var">eTries</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874746"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-445"></span><span>            </span><span class="annot"><span class="annottext">diMaxRetries :: Int
</span><a href="Hasura.Eventing.EventTrigger.html#diMaxRetries"><span class="hs-identifier hs-var">diMaxRetries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetryConf -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcNumRetries"><span class="hs-identifier hs-var hs-var">rcNumRetries</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621688874747"><span class="hs-identifier hs-var">retryConf</span></a></span><span>
</span><span id="line-446"></span><span>          </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-447"></span><span>      </span><span class="annot"><span class="annottext">epCreatedAt :: UTCTime
</span><a href="Hasura.Eventing.EventTrigger.html#epCreatedAt"><span class="hs-identifier hs-var">epCreatedAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; UTCTime
forall (b :: BackendType). Event b -&gt; UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eCreatedAt"><span class="hs-identifier hs-var hs-var">eCreatedAt</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874746"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processSuccess"><span class="hs-identifier hs-type">processSuccess</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688875151"><span class="annot"><a href="#local-6989586621688875151"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688875152"><span class="annot"><a href="#local-6989586621688875152"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688875150"><span class="annot"><a href="#local-6989586621688875150"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-452"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688875152"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875151"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-453"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875151"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-454"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875151"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-455"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-456"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-457"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-458"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPResp"><span class="hs-identifier hs-type">HTTPResp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875150"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-459"></span><span>  </span><span class="annot"><a href="#local-6989586621688875152"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span id="processSuccess"><span class="annot"><span class="annottext">processSuccess :: SourceConfig b
-&gt; Event b
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPResp a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processSuccess"><span class="hs-identifier hs-var hs-var">processSuccess</span></a></span></span><span> </span><span id="local-6989586621688874740"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874740"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621688874739"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874739"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621688874738"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874738"><span class="hs-identifier hs-var">reqHeaders</span></a></span></span><span> </span><span id="local-6989586621688874737"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874737"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span id="local-6989586621688874736"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621688874736"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span id="local-6989586621688874735"><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621688874735"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-461"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874734"><span class="annot"><span class="annottext">respBody :: TByteString
</span><a href="#local-6989586621688874734"><span class="hs-identifier hs-var hs-var">respBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; TByteString
forall (a :: TriggerTypes). HTTPResp a -&gt; TByteString
</span><a href="Hasura.Eventing.HTTP.html#hrsBody"><span class="hs-identifier hs-var hs-var">hrsBody</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621688874735"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-462"></span><span>      </span><span id="local-6989586621688874732"><span class="annot"><span class="annottext">respHeaders :: [HeaderConf]
</span><a href="#local-6989586621688874732"><span class="hs-identifier hs-var hs-var">respHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; [HeaderConf]
forall (a :: TriggerTypes). HTTPResp a -&gt; [HeaderConf]
</span><a href="Hasura.Eventing.HTTP.html#hrsHeaders"><span class="hs-identifier hs-var hs-var">hrsHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621688874735"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-463"></span><span>      </span><span id="local-6989586621688874730"><span class="annot"><span class="annottext">respStatus :: Int
</span><a href="#local-6989586621688874730"><span class="hs-identifier hs-var hs-var">respStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; Int
forall (a :: TriggerTypes). HTTPResp a -&gt; Int
</span><a href="Hasura.Eventing.HTTP.html#hrsStatus"><span class="hs-identifier hs-var hs-var">hrsStatus</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621688874735"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-464"></span><span>      </span><span id="local-6989586621688874728"><span class="annot"><span class="annottext">eid :: EventId
</span><a href="#local-6989586621688874728"><span class="hs-identifier hs-var hs-var">eid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874739"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-465"></span><span>      </span><span id="local-6989586621688874727"><span class="annot"><span class="annottext">invocation :: Invocation 'EventType
</span><a href="#local-6989586621688874727"><span class="hs-identifier hs-var hs-var">invocation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; TByteString
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621688874728"><span class="hs-identifier hs-var">eid</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874737"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874730"><span class="hs-identifier hs-var">respStatus</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874738"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">TByteString
</span><a href="#local-6989586621688874734"><span class="hs-identifier hs-var">respBody</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874732"><span class="hs-identifier hs-var">respHeaders</span></a></span><span>
</span><span id="line-466"></span><span>  </span><span class="annot"><span class="annottext">SourceConfig b
-&gt; Event b
-&gt; Invocation 'EventType
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; Invocation 'EventType
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#recordSuccess"><span class="hs-identifier hs-var">recordSuccess</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688875151"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874740"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874739"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621688874727"><span class="hs-identifier hs-var">invocation</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621688874736"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processError"><span class="hs-identifier hs-type">processError</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688875148"><span class="annot"><a href="#local-6989586621688875148"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688875149"><span class="annot"><a href="#local-6989586621688875149"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688875147"><span class="annot"><a href="#local-6989586621688875147"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-470"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688875149"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-471"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875148"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-472"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-473"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875148"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-474"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875148"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-475"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RetryConf"><span class="hs-identifier hs-type">RetryConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-476"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-477"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-478"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-479"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPErr"><span class="hs-identifier hs-type">HTTPErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875147"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-480"></span><span>  </span><span class="annot"><a href="#local-6989586621688875149"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span id="processError"><span class="annot"><span class="annottext">processError :: SourceConfig b
-&gt; Event b
-&gt; RetryConf
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPErr a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processError"><span class="hs-identifier hs-var hs-var">processError</span></a></span></span><span> </span><span id="local-6989586621688874724"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874724"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621688874723"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874723"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621688874722"><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621688874722"><span class="hs-identifier hs-var">retryConf</span></a></span></span><span> </span><span id="local-6989586621688874721"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874721"><span class="hs-identifier hs-var">reqHeaders</span></a></span></span><span> </span><span id="local-6989586621688874720"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874720"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span id="local-6989586621688874719"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621688874719"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span id="local-6989586621688874718"><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621688874718"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-482"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874717"><span class="annot"><span class="annottext">invocation :: Invocation 'EventType
</span><a href="#local-6989586621688874717"><span class="hs-identifier hs-var hs-var">invocation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621688874718"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-483"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HClient"><span class="hs-identifier hs-type">HClient</span></a></span><span> </span><span id="local-6989586621688874715"><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621688874715"><span class="hs-identifier hs-var">httpException</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-484"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874714"><span class="annot"><span class="annottext">statusMaybe :: Maybe Int
</span><a href="#local-6989586621688874714"><span class="hs-identifier hs-var hs-var">statusMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HttpException -&gt; Maybe Int
</span><a href="Hasura.HTTP.html#getHTTPExceptionStatus"><span class="hs-identifier hs-var">getHTTPExceptionStatus</span></a></span><span> </span><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621688874715"><span class="hs-identifier hs-var">httpException</span></a></span><span>
</span><span id="line-485"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; TByteString
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874723"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874720"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688874714"><span class="hs-identifier hs-var">statusMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874721"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; TByteString
</span><a href="Data.TByteString.html#fromLBS"><span class="hs-identifier hs-var">TBS.fromLBS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HttpException -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621688874715"><span class="hs-identifier hs-var">httpException</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HStatus"><span class="hs-identifier hs-type">HStatus</span></a></span><span> </span><span id="local-6989586621688874712"><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621688874712"><span class="hs-identifier hs-var">errResp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-487"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874711"><span class="annot"><span class="annottext">respPayload :: TByteString
</span><a href="#local-6989586621688874711"><span class="hs-identifier hs-var hs-var">respPayload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; TByteString
forall (a :: TriggerTypes). HTTPResp a -&gt; TByteString
</span><a href="Hasura.Eventing.HTTP.html#hrsBody"><span class="hs-identifier hs-var hs-var">hrsBody</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621688874712"><span class="hs-identifier hs-var">errResp</span></a></span><span>
</span><span id="line-488"></span><span>              </span><span id="local-6989586621688874710"><span class="annot"><span class="annottext">respHeaders :: [HeaderConf]
</span><a href="#local-6989586621688874710"><span class="hs-identifier hs-var hs-var">respHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; [HeaderConf]
forall (a :: TriggerTypes). HTTPResp a -&gt; [HeaderConf]
</span><a href="Hasura.Eventing.HTTP.html#hrsHeaders"><span class="hs-identifier hs-var hs-var">hrsHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621688874712"><span class="hs-identifier hs-var">errResp</span></a></span><span>
</span><span id="line-489"></span><span>              </span><span id="local-6989586621688874709"><span class="annot"><span class="annottext">respStatus :: Int
</span><a href="#local-6989586621688874709"><span class="hs-identifier hs-var hs-var">respStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; Int
forall (a :: TriggerTypes). HTTPResp a -&gt; Int
</span><a href="Hasura.Eventing.HTTP.html#hrsStatus"><span class="hs-identifier hs-var hs-var">hrsStatus</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621688874712"><span class="hs-identifier hs-var">errResp</span></a></span><span>
</span><span id="line-490"></span><span>          </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; TByteString
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874723"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874720"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874709"><span class="hs-identifier hs-var">respStatus</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874721"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">TByteString
</span><a href="#local-6989586621688874711"><span class="hs-identifier hs-var">respPayload</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874710"><span class="hs-identifier hs-var">respHeaders</span></a></span><span>
</span><span id="line-491"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HOther"><span class="hs-identifier hs-type">HOther</span></a></span><span> </span><span id="local-6989586621688874707"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688874707"><span class="hs-identifier hs-var">detail</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-492"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874706"><span class="annot"><span class="annottext">errMsg :: TByteString
</span><a href="#local-6989586621688874706"><span class="hs-identifier hs-var hs-var">errMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; TByteString
</span><a href="Data.TByteString.html#fromLBS"><span class="hs-identifier hs-var">TBS.fromLBS</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; TByteString) -&gt; ByteString -&gt; TByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688874707"><span class="hs-identifier hs-var">detail</span></a></span><span>
</span><span id="line-493"></span><span>          </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; TByteString
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874723"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874720"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">500</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874721"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">TByteString
</span><a href="#local-6989586621688874706"><span class="hs-identifier hs-var">errMsg</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-494"></span><span>  </span><span id="local-6989586621688874705"><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621688874705"><span class="hs-identifier hs-var">retryOrError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; RetryConf -&gt; HTTPErr a -&gt; m ProcessEventError
forall (m :: * -&gt; *) (b :: BackendType) (a :: TriggerTypes).
MonadIO m =&gt;
Event b -&gt; RetryConf -&gt; HTTPErr a -&gt; m ProcessEventError
</span><a href="Hasura.Eventing.EventTrigger.html#retryOrSetError"><span class="hs-identifier hs-var">retryOrSetError</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874723"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621688874722"><span class="hs-identifier hs-var">retryConf</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621688874718"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-495"></span><span>  </span><span class="annot"><span class="annottext">SourceConfig b
-&gt; Event b
-&gt; Invocation 'EventType
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; Invocation 'EventType
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#recordError"><span class="hs-identifier hs-var">recordError</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688875148"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688874724"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874723"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621688874717"><span class="hs-identifier hs-var">invocation</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621688874705"><span class="hs-identifier hs-var">retryOrError</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621688874719"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span id="local-6989586621688875129"><span id="local-6989586621688875130"><span id="local-6989586621688875131"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#retryOrSetError"><span class="hs-identifier hs-type">retryOrSetError</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-498"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688875131"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-499"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875130"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-500"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RetryConf"><span class="hs-identifier hs-type">RetryConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-501"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPErr"><span class="hs-identifier hs-type">HTTPErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875129"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-502"></span><span>  </span><span class="annot"><a href="#local-6989586621688875131"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#ProcessEventError"><span class="hs-identifier hs-type">ProcessEventError</span></a></span></span></span></span><span>
</span><span id="line-503"></span><span id="retryOrSetError"><span class="annot"><span class="annottext">retryOrSetError :: Event b -&gt; RetryConf -&gt; HTTPErr a -&gt; m ProcessEventError
</span><a href="Hasura.Eventing.EventTrigger.html#retryOrSetError"><span class="hs-identifier hs-var hs-var">retryOrSetError</span></a></span></span><span> </span><span id="local-6989586621688874702"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874702"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621688874701"><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621688874701"><span class="hs-identifier hs-var">retryConf</span></a></span></span><span> </span><span id="local-6989586621688874700"><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621688874700"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-504"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874699"><span class="annot"><span class="annottext">mretryHeader :: Maybe Text
</span><a href="#local-6989586621688874699"><span class="hs-identifier hs-var hs-var">mretryHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPErr a -&gt; Maybe Text
forall (a :: TriggerTypes). HTTPErr a -&gt; Maybe Text
</span><a href="#local-6989586621688874698"><span class="hs-identifier hs-var">getRetryAfterHeaderFromError</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621688874700"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-505"></span><span>      </span><span id="local-6989586621688874697"><span class="annot"><span class="annottext">tries :: Int
</span><a href="#local-6989586621688874697"><span class="hs-identifier hs-var hs-var">tries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; Int
forall (b :: BackendType). Event b -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTries"><span class="hs-identifier hs-var hs-var">eTries</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874702"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-506"></span><span>      </span><span id="local-6989586621688874696"><span class="annot"><span class="annottext">mretryHeaderSeconds :: Maybe Int
</span><a href="#local-6989586621688874696"><span class="hs-identifier hs-var hs-var">mretryHeaderSeconds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688874699"><span class="hs-identifier hs-var">mretryHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text -&gt; (Text -&gt; Maybe Int) -&gt; Maybe Int
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Int
</span><a href="#local-6989586621688874695"><span class="hs-identifier hs-var">parseRetryHeader</span></a></span><span>
</span><span id="line-507"></span><span>      </span><span id="local-6989586621688874694"><span class="annot"><span class="annottext">triesExhausted :: Bool
</span><a href="#local-6989586621688874694"><span class="hs-identifier hs-var hs-var">triesExhausted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874697"><span class="hs-identifier hs-var">tries</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">RetryConf -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcNumRetries"><span class="hs-identifier hs-var hs-var">rcNumRetries</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621688874701"><span class="hs-identifier hs-var">retryConf</span></a></span><span>
</span><span id="line-508"></span><span>      </span><span id="local-6989586621688874693"><span class="annot"><span class="annottext">noRetryHeader :: Bool
</span><a href="#local-6989586621688874693"><span class="hs-identifier hs-var hs-var">noRetryHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688874696"><span class="hs-identifier hs-var">mretryHeaderSeconds</span></a></span><span>
</span><span id="line-509"></span><span>  </span><span class="hs-comment">-- current_try = tries + 1 , allowed_total_tries = rcNumRetries retryConf + 1</span><span>
</span><span id="line-510"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688874694"><span class="hs-identifier hs-var">triesExhausted</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688874693"><span class="hs-identifier hs-var">noRetryHeader</span></a></span><span>
</span><span id="line-511"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ProcessEventError -&gt; m ProcessEventError
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetError"><span class="hs-identifier hs-var">PESetError</span></a></span><span>
</span><span id="line-512"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-513"></span><span>      </span><span id="local-6989586621688874691"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874691"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; m UTCTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-514"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874690"><span class="annot"><span class="annottext">delay :: Int
</span><a href="#local-6989586621688874690"><span class="hs-identifier hs-var hs-var">delay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RetryConf -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcIntervalSec"><span class="hs-identifier hs-var hs-var">rcIntervalSec</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621688874701"><span class="hs-identifier hs-var">retryConf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688874696"><span class="hs-identifier hs-var">mretryHeaderSeconds</span></a></span><span>
</span><span id="line-515"></span><span>          </span><span id="local-6989586621688874688"><span class="annot"><span class="annottext">diff :: NominalDiffTime
</span><a href="#local-6989586621688874688"><span class="hs-identifier hs-var hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; NominalDiffTime
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874690"><span class="hs-identifier hs-var">delay</span></a></span><span>
</span><span id="line-516"></span><span>          </span><span id="local-6989586621688874687"><span class="annot"><span class="annottext">retryTime :: UTCTime
</span><a href="#local-6989586621688874687"><span class="hs-identifier hs-var hs-var">retryTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; UTCTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">addUTCTime</span></span><span> </span><span class="annot"><span class="annottext">NominalDiffTime
</span><a href="#local-6989586621688874688"><span class="hs-identifier hs-var">diff</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874691"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-517"></span><span>      </span><span class="annot"><span class="annottext">ProcessEventError -&gt; m ProcessEventError
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ProcessEventError -&gt; m ProcessEventError)
-&gt; ProcessEventError -&gt; m ProcessEventError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetRetry"><span class="hs-identifier hs-var">PESetRetry</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688874687"><span class="hs-identifier hs-var">retryTime</span></a></span><span>
</span><span id="line-518"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-519"></span><span>    </span><span id="local-6989586621688874698"><span class="annot"><span class="annottext">getRetryAfterHeaderFromError :: HTTPErr a -&gt; Maybe Text
</span><a href="#local-6989586621688874698"><span class="hs-identifier hs-var hs-var">getRetryAfterHeaderFromError</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HStatus"><span class="hs-identifier hs-type">HStatus</span></a></span><span> </span><span id="local-6989586621688874685"><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621688874685"><span class="hs-identifier hs-var">resp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTPResp a -&gt; Maybe Text
forall (a :: TriggerTypes). HTTPResp a -&gt; Maybe Text
</span><a href="Hasura.Eventing.HTTP.html#getRetryAfterHeaderFromResp"><span class="hs-identifier hs-var">getRetryAfterHeaderFromResp</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621688874685"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><a href="#local-6989586621688874698"><span class="hs-identifier hs-var">getRetryAfterHeaderFromError</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span>    </span><span id="local-6989586621688874695"><span class="annot"><span class="annottext">parseRetryHeader :: Text -&gt; Maybe Int
</span><a href="#local-6989586621688874695"><span class="hs-identifier hs-var hs-var">parseRetryHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Bool) -&gt; Maybe Int -&gt; Maybe Int
forall (m :: * -&gt; *) a. MonadPlus m =&gt; (a -&gt; Bool) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mfilter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Maybe Int)
-&gt; (Text -&gt; Maybe Int) -&gt; Text -&gt; Maybe Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Int
forall a. Read a =&gt; String -&gt; Maybe a
</span><span class="hs-identifier hs-var">readMaybe</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Maybe Int) -&gt; (Text -&gt; String) -&gt; Text -&gt; Maybe Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span>
</span><span id="line-523"></span><span>
</span><span id="line-524"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-type">mkInvocation</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-525"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-526"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-527"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-528"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-529"></span><span>  </span><span class="annot"><a href="Data.TByteString.html#TByteString"><span class="hs-identifier hs-type">TBS.TByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-531"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span>
</span><span id="line-532"></span><span id="mkInvocation"><span class="annot"><span class="annottext">mkInvocation :: EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; TByteString
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var hs-var">mkInvocation</span></a></span></span><span> </span><span id="local-6989586621688874680"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621688874680"><span class="hs-identifier hs-var">eid</span></a></span></span><span> </span><span id="local-6989586621688874679"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874679"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span id="local-6989586621688874678"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688874678"><span class="hs-identifier hs-var">statusMaybe</span></a></span></span><span> </span><span id="local-6989586621688874677"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874677"><span class="hs-identifier hs-var">reqHeaders</span></a></span></span><span> </span><span id="local-6989586621688874676"><span class="annot"><span class="annottext">TByteString
</span><a href="#local-6989586621688874676"><span class="hs-identifier hs-var">respBody</span></a></span></span><span> </span><span id="local-6989586621688874675"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874675"><span class="hs-identifier hs-var">respHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-533"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874674"><span class="annot"><span class="annottext">resp :: Response 'EventType
</span><a href="#local-6989586621688874674"><span class="hs-identifier hs-var hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-534"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688874678"><span class="hs-identifier hs-var">statusMaybe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-535"></span><span>          </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TByteString -&gt; Response 'EventType
forall (a :: TriggerTypes). TByteString -&gt; Response a
</span><a href="Hasura.Eventing.HTTP.html#mkClientErr"><span class="hs-identifier hs-var">mkClientErr</span></a></span><span> </span><span class="annot"><span class="annottext">TByteString
</span><a href="#local-6989586621688874676"><span class="hs-identifier hs-var">respBody</span></a></span><span>
</span><span id="line-536"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688874672"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874672"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-537"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874672"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874672"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">300</span></span><span>
</span><span id="line-538"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TByteString -&gt; [HeaderConf] -&gt; Response 'EventType
forall (a :: TriggerTypes).
Int -&gt; TByteString -&gt; [HeaderConf] -&gt; Response a
</span><a href="Hasura.Eventing.HTTP.html#mkResp"><span class="hs-identifier hs-var">mkResp</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688874672"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">TByteString
</span><a href="#local-6989586621688874676"><span class="hs-identifier hs-var">respBody</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874675"><span class="hs-identifier hs-var">respHeaders</span></a></span><span>
</span><span id="line-539"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TByteString -&gt; Response 'EventType
forall (a :: TriggerTypes). TByteString -&gt; Response a
</span><a href="Hasura.Eventing.HTTP.html#mkClientErr"><span class="hs-identifier hs-var">mkClientErr</span></a></span><span> </span><span class="annot"><span class="annottext">TByteString
</span><a href="#local-6989586621688874676"><span class="hs-identifier hs-var">respBody</span></a></span><span>
</span><span id="line-540"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EventId
-&gt; Maybe Int
-&gt; WebhookRequest
-&gt; Response 'EventType
-&gt; Invocation 'EventType
forall (a :: TriggerTypes).
EventId
-&gt; Maybe Int -&gt; WebhookRequest -&gt; Response a -&gt; Invocation a
</span><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-var">Invocation</span></a></span><span>
</span><span id="line-541"></span><span>        </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621688874680"><span class="hs-identifier hs-var">eid</span></a></span><span>
</span><span id="line-542"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688874678"><span class="hs-identifier hs-var">statusMaybe</span></a></span><span>
</span><span id="line-543"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; [HeaderConf] -&gt; Text -&gt; WebhookRequest
</span><a href="Hasura.Eventing.HTTP.html#mkWebhookReq"><span class="hs-identifier hs-var">mkWebhookReq</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688874679"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621688874677"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.RQL.Types.Eventing.html#invocationVersionET"><span class="hs-identifier hs-var">invocationVersionET</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>        </span><span class="annot"><span class="annottext">Response 'EventType
</span><a href="#local-6989586621688874674"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span id="local-6989586621688875202"><span id="local-6989586621688875203"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-type">logQErr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621688875203"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875202"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Has</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688875203"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688875202"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688875202"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-547"></span><span id="logQErr"><span class="annot"><span class="annottext">logQErr :: QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var hs-var">logQErr</span></a></span></span><span> </span><span id="local-6989586621688874666"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688874666"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>  </span><span id="local-6989586621688874665"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688874665"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(r -&gt; Logger Hasura) -&gt; m (Logger Hasura)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">r -&gt; Logger Hasura
forall a t. Has a t =&gt; t -&gt; a
</span><span class="hs-identifier hs-var">getter</span></span><span>
</span><span id="line-549"></span><span>  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688874665"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(EventInternalErr -&gt; m ()) -&gt; EventInternalErr -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; EventInternalErr
</span><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688874666"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#getEventTriggerInfoFromEvent"><span class="hs-identifier hs-type">getEventTriggerInfoFromEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-552"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688875201"><span class="annot"><a href="#local-6989586621688875201"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875201"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#SchemaCache"><span class="hs-identifier hs-type">SchemaCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875201"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventTriggerInfo"><span class="hs-identifier hs-type">EventTriggerInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688875201"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span id="getEventTriggerInfoFromEvent"><span class="annot"><span class="annottext">getEventTriggerInfoFromEvent :: SchemaCache -&gt; Event b -&gt; Either Text (EventTriggerInfo b)
</span><a href="Hasura.Eventing.EventTrigger.html#getEventTriggerInfoFromEvent"><span class="hs-identifier hs-var hs-var">getEventTriggerInfoFromEvent</span></a></span></span><span> </span><span id="local-6989586621688874662"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688874662"><span class="hs-identifier hs-var">sc</span></a></span></span><span> </span><span id="local-6989586621688874661"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874661"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-554"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874660"><span class="annot"><span class="annottext">table :: TableName b
</span><a href="#local-6989586621688874660"><span class="hs-identifier hs-var hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event b -&gt; TableName b
forall (b :: BackendType). Event b -&gt; TableName b
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTable"><span class="hs-identifier hs-var hs-var">eTable</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874661"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-555"></span><span>      </span><span id="local-6989586621688874659"><span class="annot"><span class="annottext">mTableInfo :: Maybe (TableInfo b)
</span><a href="#local-6989586621688874659"><span class="hs-identifier hs-var hs-var">mTableInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; TableName b -&gt; SourceCache -&gt; Maybe (TableInfo b)
forall (b :: BackendType).
Backend b =&gt;
SourceName -&gt; TableName b -&gt; SourceCache -&gt; Maybe (TableInfo b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#unsafeTableInfo"><span class="hs-identifier hs-var">unsafeTableInfo</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688875201"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event b -&gt; SourceName
forall (b :: BackendType). Event b -&gt; SourceName
</span><a href="Hasura.RQL.Types.EventTrigger.html#eSource"><span class="hs-identifier hs-var hs-var">eSource</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874661"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688874660"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceCache -&gt; Maybe (TableInfo b))
-&gt; SourceCache -&gt; Maybe (TableInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688874662"><span class="hs-identifier hs-var">sc</span></a></span><span>
</span><span id="line-556"></span><span>  </span><span id="local-6989586621688874656"><span class="annot"><span class="annottext">TableInfo b
</span><a href="#local-6989586621688874656"><span class="hs-identifier hs-var">tableInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TableInfo b)
-&gt; Either Text (TableInfo b) -&gt; Either Text (TableInfo b)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TableInfo b)
</span><a href="#local-6989586621688874659"><span class="hs-identifier hs-var">mTableInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Text (TableInfo b) -&gt; Either Text (TableInfo b))
-&gt; Either Text (TableInfo b) -&gt; Either Text (TableInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text (TableInfo b)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;table '&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688874660"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;' not found&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688874653"><span class="annot"><span class="annottext">triggerName :: TriggerName
</span><a href="#local-6989586621688874653"><span class="hs-identifier hs-var hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#tmName"><span class="hs-identifier hs-var hs-var">tmName</span></a></span><span> </span><span class="annot"><span class="annottext">(TriggerMetadata -&gt; TriggerName) -&gt; TriggerMetadata -&gt; TriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event b -&gt; TriggerMetadata
forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621688874661"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-558"></span><span>      </span><span id="local-6989586621688874651"><span class="annot"><span class="annottext">mEventTriggerInfo :: Maybe (EventTriggerInfo b)
</span><a href="#local-6989586621688874651"><span class="hs-identifier hs-var hs-var">mEventTriggerInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; HashMap TriggerName (EventTriggerInfo b)
-&gt; Maybe (EventTriggerInfo b)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688874653"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableInfo b -&gt; HashMap TriggerName (EventTriggerInfo b)
forall (b :: BackendType). TableInfo b -&gt; EventTriggerInfoMap b
</span><a href="Hasura.RQL.Types.Table.html#_tiEventTriggerInfoMap"><span class="hs-identifier hs-var hs-var">_tiEventTriggerInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">TableInfo b
</span><a href="#local-6989586621688874656"><span class="hs-identifier hs-var">tableInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>  </span><span class="annot"><span class="annottext">Maybe (EventTriggerInfo b)
-&gt; Either Text (EventTriggerInfo b)
-&gt; Either Text (EventTriggerInfo b)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (EventTriggerInfo b)
</span><a href="#local-6989586621688874651"><span class="hs-identifier hs-var">mEventTriggerInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Text (EventTriggerInfo b)
 -&gt; Either Text (EventTriggerInfo b))
-&gt; Either Text (EventTriggerInfo b)
-&gt; Either Text (EventTriggerInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-560"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Either Text (EventTriggerInfo b)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span>
</span><span id="line-561"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event trigger '&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688874653"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-562"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;' on table '&quot;</span></span><span>
</span><span id="line-563"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688874660"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;' not found&quot;</span></span><span>
</span><span id="line-564"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-565"></span></pre></body></html>