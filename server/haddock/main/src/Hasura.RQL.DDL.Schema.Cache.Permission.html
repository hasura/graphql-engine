<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Arrows #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Permission</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildTablePermissions"><span class="hs-identifier">buildTablePermissions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkPermissionMetadataObject"><span class="hs-identifier">mkPermissionMetadataObject</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkRemoteSchemaPermissionMetadataObject"><span class="hs-identifier">mkRemoteSchemaPermissionMetadataObject</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#orderRoles"><span class="hs-identifier">orderRoles</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier">OrderedRoles</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier">_unOrderedRoles</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkBooleanPermissionMap"><span class="hs-identifier">mkBooleanPermissionMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier">resolveCheckPermission</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">where</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Arrow.Extended.html"><span class="hs-identifier">Control.Arrow.Extended</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Graph</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Proxy</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Sequence</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Seq</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Incremental.html"><span class="hs-identifier">Hasura.Incremental</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Inc</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html"><span class="hs-identifier">Hasura.RQL.DDL.Permission</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Common</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.html"><span class="hs-identifier">Hasura.RQL.Types</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html"><span class="hs-identifier">Hasura.RQL.Types.Roles.Internal</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CheckPermission"><span class="hs-identifier">CheckPermission</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CombineRolePermInfo"><span class="hs-identifier">CombineRolePermInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#rolePermInfoToCombineRolePermInfo"><span class="hs-identifier">rolePermInfoToCombineRolePermInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-comment">{- Note: [Inherited roles architecture for read queries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. Schema generation
--------------------

Schema generation for inherited roles is similar to the schema
generation of non-inherited roles. In the case of inherited roles,
we combine the `SelectPermInfo`s of the
inherited role's role set and a new `SelectPermInfo` will be generated
which will be the select permission of the inherited role.

Two `SelPermInfo`s will be combined in the following manner:

1. Columns - The `SelPermInfo` contains a hashset of the columns that are
   accessible to the role. To combine two `SelPermInfo`s, every column of the
   hashset is coupled with the boolean expression (filter) of the `SelPermInfo`
   and a hash map of all the columns is created out of it, this hashmap is
   generated for the `SelPermInfo`s that are going to be combined. These hashmaps
   are then unioned and the values of these hashmaps are `OR`ed. When a column
   is accessible to all the select permissions then the nullability of the column
   is inferred from the DB column otherwise the column is explicitly marked as
   nullable to accomodate cell-value nullification.
2. Scalar computed fields - Scalar computed fields work the same as Columns (#1)
3. Filter / Boolean expression - The filters are combined using a `BoolOr`
4. Limit - Limits are combined by taking the maximum of the two limits
5. Allow Aggregation - Aggregation is allowed, if any of the permissions allow it.
6. Request Headers - Request headers are concatenated

2. SQL generation
-----------------

See note [SQL generation for inherited roles]

3. Introspection
----------------

The columns accessible to an inherited role are explicitly set to
nullable irrespective of the nullability of the DB column to accomodate
cell value nullification.
-}</span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span id="local-6989586621688136727"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkBooleanPermissionMap"><span class="hs-identifier hs-type">mkBooleanPermissionMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688136727"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136727"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136727"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-79"></span><span id="mkBooleanPermissionMap"><span class="annot"><span class="annottext">mkBooleanPermissionMap :: (RoleName -&gt; a)
-&gt; HashMap RoleName a -&gt; OrderedRoles -&gt; HashMap RoleName a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkBooleanPermissionMap"><span class="hs-identifier hs-var hs-var">mkBooleanPermissionMap</span></a></span></span><span> </span><span id="local-6989586621688136726"><span class="annot"><span class="annottext">RoleName -&gt; a
</span><a href="#local-6989586621688136726"><span class="hs-identifier hs-var">constructorFn</span></a></span></span><span> </span><span id="local-6989586621688136725"><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621688136725"><span class="hs-identifier hs-var">metadataPermissions</span></a></span></span><span> </span><span id="local-6989586621688136724"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688136724"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><span class="annottext">(HashMap RoleName a -&gt; Role -&gt; HashMap RoleName a)
-&gt; HashMap RoleName a -&gt; [Role] -&gt; HashMap RoleName a
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a -&gt; Role -&gt; HashMap RoleName a
</span><a href="#local-6989586621688136722"><span class="hs-identifier hs-var">combineBooleanPermission</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621688136725"><span class="hs-identifier hs-var">metadataPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">([Role] -&gt; HashMap RoleName a) -&gt; [Role] -&gt; HashMap RoleName a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var hs-var">_unOrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688136724"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-82"></span><span>    </span><span id="local-6989586621688136722"><span class="annot"><span class="annottext">combineBooleanPermission :: HashMap RoleName a -&gt; Role -&gt; HashMap RoleName a
</span><a href="#local-6989586621688136722"><span class="hs-identifier hs-var hs-var">combineBooleanPermission</span></a></span></span><span> </span><span id="local-6989586621688136721"><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621688136721"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span id="local-6989586621688136719"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136719"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#ParentRoles"><span class="hs-identifier hs-type">ParentRoles</span></a></span><span> </span><span id="local-6989586621688136717"><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688136717"><span class="hs-identifier hs-var">parentRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-83"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; HashMap RoleName a -&gt; Maybe a
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136719"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621688136721"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-84"></span><span>        </span><span class="hs-comment">-- We check if a permission for the given role exists in the metadata, if it</span><span>
</span><span id="line-85"></span><span>        </span><span class="hs-comment">-- exists, we use that</span><span>
</span><span id="line-86"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621688136721"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span><span>
</span><span id="line-87"></span><span>        </span><span class="hs-comment">-- 2. When the permission doesn't exist, we try to inherit the permission from its parent roles</span><span>
</span><span id="line-88"></span><span>        </span><span class="hs-comment">-- For boolean permissions, if any of the parent roles have a permission to access an entity,</span><span>
</span><span id="line-89"></span><span>        </span><span class="hs-comment">-- then the inherited role will also be able to access the entity.</span><span>
</span><span id="line-90"></span><span>        </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-91"></span><span>          </span><span class="hs-comment">-- see Note [Roles Inheritance]</span><span>
</span><span id="line-92"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136715"><span class="annot"><span class="annottext">canInheritPermission :: Bool
</span><a href="#local-6989586621688136715"><span class="hs-identifier hs-var hs-var">canInheritPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RoleName -&gt; Bool) -&gt; [RoleName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; HashMap RoleName a -&gt; Bool
forall k a. (Eq k, Hashable k) =&gt; k -&gt; HashMap k a -&gt; Bool
</span><span class="hs-operator hs-var">`M.member`</span></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621688136721"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688136717"><span class="hs-identifier hs-var">parentRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688136715"><span class="hs-identifier hs-var">canInheritPermission</span></a></span><span>
</span><span id="line-94"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; a -&gt; HashMap RoleName a -&gt; HashMap RoleName a
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136719"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; a
</span><a href="#local-6989586621688136726"><span class="hs-identifier hs-var">constructorFn</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136719"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621688136721"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span><span>
</span><span id="line-95"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621688136721"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">-- | `OrderedRoles` is a data type to hold topologically sorted roles</span><span>
</span><span id="line-98"></span><span class="hs-comment">--   according to each role's parent roles, see `orderRoles` for more details.</span><span>
</span><span id="line-99"></span><span id="local-6989586621688136709"><span id="local-6989586621688136710"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="OrderedRoles"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-var">OrderedRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="OrderedRoles"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-var">OrderedRoles</span></a></span></span><span> </span><span class="hs-special">{</span><span id="_unOrderedRoles"><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var hs-var">_unOrderedRoles</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688136704"><span id="local-6989586621688136706"><span class="annot"><span class="annottext">OrderedRoles -&gt; OrderedRoles -&gt; Bool
(OrderedRoles -&gt; OrderedRoles -&gt; Bool)
-&gt; (OrderedRoles -&gt; OrderedRoles -&gt; Bool) -&gt; Eq OrderedRoles
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: OrderedRoles -&gt; OrderedRoles -&gt; Bool
$c/= :: OrderedRoles -&gt; OrderedRoles -&gt; Bool
== :: OrderedRoles -&gt; OrderedRoles -&gt; Bool
$c== :: OrderedRoles -&gt; OrderedRoles -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. OrderedRoles -&gt; Rep OrderedRoles x)
-&gt; (forall x. Rep OrderedRoles x -&gt; OrderedRoles)
-&gt; Generic OrderedRoles
forall x. Rep OrderedRoles x -&gt; OrderedRoles
forall x. OrderedRoles -&gt; Rep OrderedRoles x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep OrderedRoles x -&gt; OrderedRoles
$cfrom :: forall x. OrderedRoles -&gt; Rep OrderedRoles x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688136697"><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Cacheable"><span class="hs-identifier hs-type">Inc.Cacheable</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">-- | 'orderRoles' is used to order the roles, in such a way that given</span><span>
</span><span id="line-105"></span><span class="hs-comment">--   a role R with n parent roles - PR1, PR2 .. PRn, then the 'orderRoles'</span><span>
</span><span id="line-106"></span><span class="hs-comment">--   function will order the roles in such a way that all the parent roles</span><span>
</span><span id="line-107"></span><span class="hs-comment">--   precede the role R. Note that the order of the parent roles itself doesn't</span><span>
</span><span id="line-108"></span><span class="hs-comment">--   matter as long as they precede the roles on which they are dependent on.</span><span>
</span><span id="line-109"></span><span class="hs-comment">--</span><span>
</span><span id="line-110"></span><span class="hs-comment">--   For example, the orderRoles may return `[PR1, PR3, PR2, ... PRn, R]`</span><span>
</span><span id="line-111"></span><span class="hs-comment">--   or `[PR5, PR3, PR1 ... R]`, both of them are correct because all</span><span>
</span><span id="line-112"></span><span class="hs-comment">--   the parent roles precede the inherited role R, assuming the parent roles</span><span>
</span><span id="line-113"></span><span class="hs-comment">--   themselves don't have any parents for the sake of this example.</span><span>
</span><span id="line-114"></span><span id="local-6989586621688136695"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#orderRoles"><span class="hs-identifier hs-type">orderRoles</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><a href="#local-6989586621688136695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span></span><span>
</span><span id="line-118"></span><span id="orderRoles"><span class="annot"><span class="annottext">orderRoles :: [Role] -&gt; m OrderedRoles
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#orderRoles"><span class="hs-identifier hs-var hs-var">orderRoles</span></a></span></span><span> </span><span id="local-6989586621688136694"><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621688136694"><span class="hs-identifier hs-var">allRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-comment">-- inherited roles can be created from other inherited and non-inherited roles</span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-comment">-- So, roles can be thought of as a graph where non-inherited roles don't have</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-comment">-- any outgoing edges and inherited roles as nodes with edges to its parent roles</span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-comment">-- However, we can't allow cyclic roles since permissions built by a role is used</span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-comment">-- by the dependent roles to build their permissions and if cyclic roles were to be</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-comment">-- allowed, the permissions building will be stuck in an infinite loop</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136693"><span class="annot"><span class="annottext">graphNodesList :: [(Role, RoleName, [RoleName])]
</span><a href="#local-6989586621688136693"><span class="hs-identifier hs-var hs-var">graphNodesList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688136692"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role -&gt; RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_rRoleName"><span class="hs-identifier hs-var hs-var">_rRoleName</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688136692"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ParentRoles -&gt; HashSet RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_unParentRoles"><span class="hs-identifier hs-var hs-var">_unParentRoles</span></a></span><span> </span><span class="annot"><span class="annottext">(ParentRoles -&gt; HashSet RoleName)
-&gt; (Role -&gt; ParentRoles) -&gt; Role -&gt; HashSet RoleName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; ParentRoles
</span><a href="Hasura.RQL.Types.Roles.html#_rParentRoles"><span class="hs-identifier hs-var hs-var">_rParentRoles</span></a></span><span> </span><span class="annot"><span class="annottext">(Role -&gt; HashSet RoleName) -&gt; Role -&gt; HashSet RoleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688136692"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621688136692"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621688136692"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621688136694"><span class="hs-identifier hs-var">allRoles</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136687"><span class="annot"><span class="annottext">orderedGraphNodes :: [SCC Role]
</span><a href="#local-6989586621688136687"><span class="hs-identifier hs-var hs-var">orderedGraphNodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Role, RoleName, [RoleName])] -&gt; [SCC Role]
forall key node. Ord key =&gt; [(node, key, [key])] -&gt; [SCC node]
</span><span class="hs-identifier hs-var">G.stronglyConnComp</span></span><span> </span><span class="annot"><span class="annottext">[(Role, RoleName, [RoleName])]
</span><a href="#local-6989586621688136693"><span class="hs-identifier hs-var">graphNodesList</span></a></span><span> </span><span class="hs-comment">-- topologically sort the nodes of the graph</span><span>
</span><span id="line-127"></span><span>      </span><span id="local-6989586621688136685"><span class="annot"><span class="annottext">cyclicRoles :: [SCC Role]
</span><a href="#local-6989586621688136685"><span class="hs-identifier hs-var hs-var">cyclicRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SCC Role -&gt; Bool) -&gt; [SCC Role] -&gt; [SCC Role]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">SCC Role -&gt; Bool
forall vertex. SCC vertex -&gt; Bool
</span><a href="#local-6989586621688136684"><span class="hs-identifier hs-var">checkCycle</span></a></span><span> </span><span class="annot"><span class="annottext">[SCC Role]
</span><a href="#local-6989586621688136687"><span class="hs-identifier hs-var">orderedGraphNodes</span></a></span><span>
</span><span id="line-128"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SCC Role] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[SCC Role]
</span><a href="#local-6989586621688136685"><span class="hs-identifier hs-var">cyclicRoles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-comment">-- we're appending the first element of the list at the end, so that the error message will</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-comment">-- contain the complete cycle of the roles</span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136681"><span class="annot"><span class="annottext">roleCycles :: [Text]
</span><a href="#local-6989586621688136681"><span class="hs-identifier hs-var hs-var">roleCycles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SCC Role -&gt; Text) -&gt; [SCC Role] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; (SCC Role -&gt; [Text]) -&gt; SCC Role -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Role -&gt; Text) -&gt; [Role] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; Text
</span><a href="Hasura.Session.html#roleNameToTxt"><span class="hs-identifier hs-var">roleNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">(RoleName -&gt; Text) -&gt; (Role -&gt; RoleName) -&gt; Role -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_rRoleName"><span class="hs-identifier hs-var hs-var">_rRoleName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Role] -&gt; [Text]) -&gt; (SCC Role -&gt; [Role]) -&gt; SCC Role -&gt; [Text]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Role] -&gt; [Role]
forall a. [a] -&gt; [a]
</span><a href="#local-6989586621688136678"><span class="hs-identifier hs-var">appendFirstElementAtEnd</span></a></span><span> </span><span class="annot"><span class="annottext">([Role] -&gt; [Role]) -&gt; (SCC Role -&gt; [Role]) -&gt; SCC Role -&gt; [Role]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SCC Role -&gt; [Role]
forall vertex. SCC vertex -&gt; [vertex]
</span><span class="hs-identifier hs-var">G.flattenSCC</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SCC Role]
</span><a href="#local-6989586621688136685"><span class="hs-identifier hs-var">cyclicRoles</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#CyclicDependency"><span class="hs-identifier hs-var">CyclicDependency</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;found cycle(s) in roles: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621688136681"><span class="hs-identifier hs-var">roleCycles</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136673"><span class="annot"><span class="annottext">allOrderedRoles :: [Role]
</span><a href="#local-6989586621688136673"><span class="hs-identifier hs-var hs-var">allOrderedRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SCC Role] -&gt; [Role]
forall a. [SCC a] -&gt; [a]
</span><span class="hs-identifier hs-var">G.flattenSCCs</span></span><span> </span><span class="annot"><span class="annottext">[SCC Role]
</span><a href="#local-6989586621688136687"><span class="hs-identifier hs-var">orderedGraphNodes</span></a></span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><span class="annottext">OrderedRoles -&gt; m OrderedRoles
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(OrderedRoles -&gt; m OrderedRoles) -&gt; OrderedRoles -&gt; m OrderedRoles
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Role] -&gt; OrderedRoles
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-var">OrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621688136673"><span class="hs-identifier hs-var">allOrderedRoles</span></a></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-136"></span><span>    </span><span id="local-6989586621688136684"><span class="annot"><span class="annottext">checkCycle :: SCC vertex -&gt; Bool
</span><a href="#local-6989586621688136684"><span class="hs-identifier hs-var hs-var">checkCycle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-137"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">G.AcyclicSCC</span></span><span> </span><span class="annot"><span class="annottext">vertex
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-138"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">G.CyclicSCC</span></span><span> </span><span class="annot"><span class="annottext">[vertex]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span>    </span><span id="local-6989586621688136678"><span class="annot"><span class="annottext">appendFirstElementAtEnd :: [a] -&gt; [a]
</span><a href="#local-6989586621688136678"><span class="hs-identifier hs-var hs-var">appendFirstElementAtEnd</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-141"></span><span>    </span><span class="annot"><a href="#local-6989586621688136678"><span class="hs-identifier hs-var">appendFirstElementAtEnd</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688136669"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688136669"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621688136668"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621688136668"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688136669"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621688136668"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688136669"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="hs-comment">-- | `resolveCheckPermission` is a helper arrow function which will convert the indermediate</span><span>
</span><span id="line-144"></span><span class="hs-comment">--    type `CheckPermission` to its original type. It will record any metadata inconsistencies, if exists.</span><span>
</span><span id="line-145"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier hs-type">resolveCheckPermission</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688136956"><span class="annot"><a href="#local-6989586621688136956"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688136954"><span class="annot"><a href="#local-6989586621688136954"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688136952"><span class="annot"><a href="#local-6989586621688136952"><span class="hs-identifier hs-type">p</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688136956"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136954"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136956"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688136956"><span class="hs-identifier hs-type">arr</span></a></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CheckPermission"><span class="hs-identifier hs-type">CheckPermission</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136952"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-153"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#InconsistentRoleEntity"><span class="hs-identifier hs-type">InconsistentRoleEntity</span></a></span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>    </span><span class="annot"><a href="#local-6989586621688136956"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621688136952"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span id="resolveCheckPermission"><span class="annot"><span class="annottext">resolveCheckPermission :: arr (CheckPermission p, RoleName, InconsistentRoleEntity) (Maybe p)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier hs-var hs-var">resolveCheckPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688136667"><span class="annot"><span class="annottext">CheckPermission p
</span><a href="#local-6989586621688136667"><span class="hs-identifier hs-var">checkPermission</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136666"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136666"><span class="hs-identifier hs-var">roleName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136665"><span class="annot"><span class="annottext">InconsistentRoleEntity
</span><a href="#local-6989586621688136665"><span class="hs-identifier hs-var">inconsistentEntity</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CheckPermission p
</span><a href="#local-6989586621688136667"><span class="hs-identifier hs-var">checkPermission</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><span class="annottext">CheckPermission p
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPInconsistent"><span class="hs-identifier hs-var">CPInconsistent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136663"><span class="annot"><span class="annottext">inconsistentObj :: CollectedInfo
</span><a href="#local-6989586621688136663"><span class="hs-identifier hs-var hs-var">inconsistentObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-160"></span><span>            </span><span class="hs-comment">-- check `Conflicts while inheriting permissions` in `rfcs/inherited-roles-improvements.md`</span><span>
</span><span id="line-161"></span><span>            </span><span class="annot"><span class="annottext">InconsistentMetadata -&gt; CollectedInfo
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CIInconsistency"><span class="hs-identifier hs-var">CIInconsistency</span></a></span><span> </span><span class="annot"><span class="annottext">(InconsistentMetadata -&gt; CollectedInfo)
-&gt; InconsistentMetadata -&gt; CollectedInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-162"></span><span>              </span><span class="annot"><span class="annottext">RoleName -&gt; InconsistentRoleEntity -&gt; InconsistentMetadata
</span><a href="Hasura.RQL.Types.Metadata.Object.html#ConflictingInheritedPermission"><span class="hs-identifier hs-var">ConflictingInheritedPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136666"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">InconsistentRoleEntity
</span><a href="#local-6989586621688136665"><span class="hs-identifier hs-var">inconsistentEntity</span></a></span><span>
</span><span id="line-163"></span><span>      </span><span class="annot"><span class="annottext">arr (Seq CollectedInfo) ()
forall w (arr :: * -&gt; * -&gt; *). ArrowWriter w arr =&gt; arr w ()
</span><a href="Control.Arrow.Trans.html#tellA"><span class="hs-identifier hs-var">tellA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">CollectedInfo -&gt; Seq CollectedInfo
forall a. a -&gt; Seq a
</span><span class="hs-identifier hs-var">Seq.singleton</span></span><span> </span><span class="annot"><span class="annottext">CollectedInfo
</span><a href="#local-6989586621688136663"><span class="hs-identifier hs-var">inconsistentObj</span></a></span><span>
</span><span id="line-164"></span><span>      </span><span class="annot"><span class="annottext">arr (m (Maybe p)) (Maybe p)
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Maybe p -&gt; m (Maybe p)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe p
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-165"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CPDefined"><span class="hs-identifier hs-type">CPDefined</span></a></span><span> </span><span id="local-6989586621688136656"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621688136656"><span class="hs-identifier hs-var">permissionDefn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">arr (m (Maybe p)) (Maybe p)
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Maybe p -&gt; m (Maybe p)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe p -&gt; m (Maybe p)) -&gt; Maybe p -&gt; m (Maybe p)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">p -&gt; Maybe p
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621688136656"><span class="hs-identifier hs-var">permissionDefn</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><span class="annottext">CheckPermission p
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPUndefined"><span class="hs-identifier hs-var">CPUndefined</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">arr (m (Maybe p)) (Maybe p)
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Maybe p -&gt; m (Maybe p)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe p
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckTablePermission"><span class="hs-identifier hs-type">resolveCheckTablePermission</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688136864"><span class="annot"><a href="#local-6989586621688136864"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688136863"><span class="annot"><a href="#local-6989586621688136863"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621688136866"><span class="annot"><a href="#local-6989586621688136866"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688136865"><span class="annot"><a href="#local-6989586621688136865"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688136866"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136865"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136866"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-172"></span><span>    </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688136866"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136864"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CheckPermission"><span class="hs-identifier hs-type">CheckPermission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html#PermInfo"><span class="hs-identifier hs-type">PermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136863"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136864"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-176"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#RolePermInfo"><span class="hs-identifier hs-type">RolePermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136864"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#RolePermInfo"><span class="hs-identifier hs-type">RolePermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136864"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html#PermInfo"><span class="hs-identifier hs-type">PermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136863"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136864"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136864"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermType"><span class="hs-identifier hs-type">PermType</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><a href="#local-6989586621688136866"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html#PermInfo"><span class="hs-identifier hs-type">PermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136863"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136864"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span id="resolveCheckTablePermission"><span class="annot"><span class="annottext">resolveCheckTablePermission :: arr
  (CheckPermission (PermInfo a b), Maybe (RolePermInfo b),
   RolePermInfo b -&gt; Maybe (PermInfo a b), RoleName, SourceName,
   TableName b, PermType)
  (Maybe (PermInfo a b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckTablePermission"><span class="hs-identifier hs-var hs-var">resolveCheckTablePermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688136653"><span class="annot"><span class="annottext">CheckPermission (PermInfo a b)
</span><a href="#local-6989586621688136653"><span class="hs-identifier hs-var">inheritedPermission</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136652"><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621688136652"><span class="hs-identifier hs-var">accumulatedRolePermInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136651"><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (PermInfo a b)
</span><a href="#local-6989586621688136651"><span class="hs-identifier hs-var">permAcc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136650"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136650"><span class="hs-identifier hs-var">roleName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136649"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136649"><span class="hs-identifier hs-var">source</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136648"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136648"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136647"><span class="annot"><span class="annottext">PermType
</span><a href="#local-6989586621688136647"><span class="hs-identifier hs-var">permType</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-comment">-- when for a given entity and role, a permission exists in the metadata, we override the metadata permission</span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-comment">-- over the inherited permission</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136646"><span class="annot"><span class="annottext">checkPermission :: CheckPermission (PermInfo a b)
</span><a href="#local-6989586621688136646"><span class="hs-identifier hs-var hs-var">checkPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
-&gt; CheckPermission (PermInfo a b)
-&gt; (RolePermInfo b -&gt; Maybe (PermInfo a b))
-&gt; CheckPermission (PermInfo a b)
forall a permissionType.
Maybe a
-&gt; CheckPermission permissionType
-&gt; (a -&gt; Maybe permissionType)
-&gt; CheckPermission permissionType
</span><a href="#local-6989586621688136645"><span class="hs-identifier hs-var">maybeOverrideInheritedPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621688136652"><span class="hs-identifier hs-var">accumulatedRolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CheckPermission (PermInfo a b)
</span><a href="#local-6989586621688136653"><span class="hs-identifier hs-var">inheritedPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (PermInfo a b)
</span><a href="#local-6989586621688136651"><span class="hs-identifier hs-var">permAcc</span></a></span><span>
</span><span id="line-188"></span><span>      </span><span id="local-6989586621688136644"><span class="annot"><span class="annottext">inconsistentRoleEntity :: InconsistentRoleEntity
</span><a href="#local-6989586621688136644"><span class="hs-identifier hs-var hs-var">inconsistentRoleEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Text -&gt; PermType -&gt; InconsistentRoleEntity
</span><a href="Hasura.RQL.Types.Metadata.Object.html#InconsistentTablePermission"><span class="hs-identifier hs-var">InconsistentTablePermission</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136649"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName b -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136648"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="#local-6989586621688136647"><span class="hs-identifier hs-var">permType</span></a></span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="annottext">arr
  (CheckPermission (PermInfo a b), RoleName, InconsistentRoleEntity)
  (Maybe (PermInfo a b))
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) p.
(ArrowChoice arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr) =&gt;
arr (CheckPermission p, RoleName, InconsistentRoleEntity) (Maybe p)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier hs-var">resolveCheckPermission</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CheckPermission (PermInfo a b)
</span><a href="#local-6989586621688136646"><span class="hs-identifier hs-var">checkPermission</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136650"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InconsistentRoleEntity
</span><a href="#local-6989586621688136644"><span class="hs-identifier hs-var">inconsistentRoleEntity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621688136645"><span class="annot"><span class="annottext">maybeOverrideInheritedPermission :: Maybe a
-&gt; CheckPermission permissionType
-&gt; (a -&gt; Maybe permissionType)
-&gt; CheckPermission permissionType
</span><a href="#local-6989586621688136645"><span class="hs-identifier hs-var hs-var">maybeOverrideInheritedPermission</span></a></span></span><span> </span><span id="local-6989586621688136641"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621688136641"><span class="hs-identifier hs-var">accumulatedRolePermInfo</span></a></span></span><span> </span><span id="local-6989586621688136640"><span class="annot"><span class="annottext">CheckPermission permissionType
</span><a href="#local-6989586621688136640"><span class="hs-identifier hs-var">inheritedRolePermission</span></a></span></span><span> </span><span id="local-6989586621688136639"><span class="annot"><span class="annottext">a -&gt; Maybe permissionType
</span><a href="#local-6989586621688136639"><span class="hs-identifier hs-var">permAcc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-192"></span><span>      </span><span class="annot"><span class="annottext">CheckPermission permissionType
-&gt; (permissionType -&gt; CheckPermission permissionType)
-&gt; Maybe permissionType
-&gt; CheckPermission permissionType
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">CheckPermission permissionType
</span><a href="#local-6989586621688136640"><span class="hs-identifier hs-var">inheritedRolePermission</span></a></span><span> </span><span class="annot"><span class="annottext">permissionType -&gt; CheckPermission permissionType
forall permissionType.
permissionType -&gt; CheckPermission permissionType
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPDefined"><span class="hs-identifier hs-var">CPDefined</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe permissionType
</span><a href="#local-6989586621688136639"><span class="hs-identifier hs-var">permAcc</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Maybe permissionType) -&gt; Maybe a -&gt; Maybe permissionType
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621688136641"><span class="hs-identifier hs-var">accumulatedRolePermInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildTablePermissions"><span class="hs-identifier hs-type">buildTablePermissions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688136636"><span class="annot"><a href="#local-6989586621688136636"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688136635"><span class="annot"><a href="#local-6989586621688136635"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688136634"><span class="annot"><a href="#local-6989586621688136634"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688136635"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136635"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136634"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136635"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136634"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688136635"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136636"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Cacheable"><span class="hs-identifier hs-type">Inc.Cacheable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621688136636"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621688136636"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Dependency"><span class="hs-identifier hs-type">Inc.Dependency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#TableCoreCache"><span class="hs-identifier hs-type">TableCoreCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136636"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#FieldInfoMap"><span class="hs-identifier hs-type">FieldInfoMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#FieldInfo"><span class="hs-identifier hs-type">FieldInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136636"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-208"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#TablePermissionInputs"><span class="hs-identifier hs-type">TablePermissionInputs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136636"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><a href="#local-6989586621688136635"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#RolePermInfoMap"><span class="hs-identifier hs-type">RolePermInfoMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136636"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span id="buildTablePermissions"><span class="annot"><span class="annottext">buildTablePermissions :: arr
  (Proxy b, SourceName, Dependency (TableCoreCache b),
   FieldInfoMap (FieldInfo b), TablePermissionInputs b, OrderedRoles)
  (RolePermInfoMap b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildTablePermissions"><span class="hs-identifier hs-var hs-var">buildTablePermissions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">arr
  (Proxy b, SourceName, Dependency (TableCoreCache b),
   FieldInfoMap (FieldInfo b), TablePermissionInputs b, OrderedRoles)
  (RolePermInfoMap b)
-&gt; arr
     (Proxy b, SourceName, Dependency (TableCoreCache b),
      FieldInfoMap (FieldInfo b), TablePermissionInputs b, OrderedRoles)
     (RolePermInfoMap b)
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a b.
(ArrowCache m arr, Cacheable a) =&gt;
arr a b -&gt; arr a b
</span><a href="Hasura.Incremental.Internal.Cache.html#cache"><span class="hs-identifier hs-var">Inc.cache</span></a></span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688136632"><span class="annot"><span class="annottext">Proxy b
</span><a href="#local-6989586621688136632"><span class="hs-identifier hs-var">proxy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136631"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136631"><span class="hs-identifier hs-var">source</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136630"><span class="annot"><span class="annottext">Dependency (TableCoreCache b)
</span><a href="#local-6989586621688136630"><span class="hs-identifier hs-var">tableCache</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136629"><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688136629"><span class="hs-identifier hs-var">tableFields</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136628"><span class="annot"><span class="annottext">TablePermissionInputs b
</span><a href="#local-6989586621688136628"><span class="hs-identifier hs-var">tablePermissions</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136627"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688136627"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136626"><span class="annot"><span class="annottext">alignedPermissions :: HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136626"><span class="hs-identifier hs-var hs-var">alignedPermissions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TablePermissionInputs b
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
forall (b :: BackendType).
TablePermissionInputs b
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136625"><span class="hs-identifier hs-var">alignPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">TablePermissionInputs b
</span><a href="#local-6989586621688136628"><span class="hs-identifier hs-var">tablePermissions</span></a></span><span>
</span><span id="line-214"></span><span>      </span><span id="local-6989586621688136624"><span class="annot"><span class="annottext">table :: TableName b
</span><a href="#local-6989586621688136624"><span class="hs-identifier hs-var hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TablePermissionInputs b -&gt; TableName b
forall (b :: BackendType). TablePermissionInputs b -&gt; TableName b
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_tpiTable"><span class="hs-identifier hs-var hs-var">_tpiTable</span></a></span><span> </span><span class="annot"><span class="annottext">TablePermissionInputs b
</span><a href="#local-6989586621688136628"><span class="hs-identifier hs-var">tablePermissions</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span id="local-6989586621688136622"><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621688136622"><span class="hs-identifier hs-var">metadataRolePermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-216"></span><span>    </span><span class="hs-glyph">(|</span><span>
</span><span id="line-217"></span><span>      </span><span class="annot"><span class="annottext">forall a.
arr
  (a,
   (RoleName,
    (([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)]),
     ())))
  (RolePermInfo b)
-&gt; arr
     (a,
      (HashMap
         RoleName
         ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
          [PermDef (UpdPerm b)], [PermDef (DelPerm b)]),
       ()))
     (RolePermInfoMap b)
forall (arr :: * -&gt; * -&gt; *) k e a s b.
(ArrowDistribute arr, Eq k, Hashable k) =&gt;
arr (e, (k, (a, s))) b -&gt; arr (e, (HashMap k a, s)) (HashMap k b)
</span><a href="Hasura.Incremental.Internal.Rule.html#keyed"><span class="hs-identifier hs-var">Inc.keyed</span></a></span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">RoleName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688136620"><span class="annot"><span class="annottext">[PermDef (InsPerm b)]
</span><a href="#local-6989586621688136620"><span class="hs-identifier hs-var">insertPermission</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136619"><span class="annot"><span class="annottext">[PermDef (SelPerm b)]
</span><a href="#local-6989586621688136619"><span class="hs-identifier hs-var">selectPermission</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136618"><span class="annot"><span class="annottext">[PermDef (UpdPerm b)]
</span><a href="#local-6989586621688136618"><span class="hs-identifier hs-var">updatePermission</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136617"><span class="annot"><span class="annottext">[PermDef (DelPerm b)]
</span><a href="#local-6989586621688136617"><span class="hs-identifier hs-var">deletePermission</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-219"></span><span>            </span><span id="local-6989586621688136616"><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
</span><a href="#local-6989586621688136616"><span class="hs-identifier hs-var">insert</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
   FieldInfoMap (FieldInfo b), Maybe (PermDef (InsPerm b)))
  (Maybe (InsPermInfo b))
forall (b :: BackendType) (a :: BackendType -&gt; *)
       (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowWriter (Seq CollectedInfo) arr,
 ArrowCache m arr, Cacheable (a b), Cacheable (Proxy b),
 MonadError QErr m, BackendMetadata b, ToJSON (a b), IsPerm a) =&gt;
arr
  (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
   FieldInfoMap (FieldInfo b), Maybe (PermDef (a b)))
  (Maybe (PermInfo a b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildPermission"><span class="hs-identifier hs-var">buildPermission</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy b
</span><a href="#local-6989586621688136632"><span class="hs-identifier hs-var">proxy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependency (TableCoreCache b)
</span><a href="#local-6989586621688136630"><span class="hs-identifier hs-var">tableCache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136631"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136624"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688136629"><span class="hs-identifier hs-var">tableFields</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PermDef (InsPerm b)] -&gt; Maybe (PermDef (InsPerm b))
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="annot"><span class="annottext">[PermDef (InsPerm b)]
</span><a href="#local-6989586621688136620"><span class="hs-identifier hs-var">insertPermission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>            </span><span id="local-6989586621688136613"><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621688136613"><span class="hs-identifier hs-var">select</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
   FieldInfoMap (FieldInfo b), Maybe (PermDef (SelPerm b)))
  (Maybe (SelPermInfo b))
forall (b :: BackendType) (a :: BackendType -&gt; *)
       (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowWriter (Seq CollectedInfo) arr,
 ArrowCache m arr, Cacheable (a b), Cacheable (Proxy b),
 MonadError QErr m, BackendMetadata b, ToJSON (a b), IsPerm a) =&gt;
arr
  (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
   FieldInfoMap (FieldInfo b), Maybe (PermDef (a b)))
  (Maybe (PermInfo a b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildPermission"><span class="hs-identifier hs-var">buildPermission</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy b
</span><a href="#local-6989586621688136632"><span class="hs-identifier hs-var">proxy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependency (TableCoreCache b)
</span><a href="#local-6989586621688136630"><span class="hs-identifier hs-var">tableCache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136631"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136624"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688136629"><span class="hs-identifier hs-var">tableFields</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PermDef (SelPerm b)] -&gt; Maybe (PermDef (SelPerm b))
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="annot"><span class="annottext">[PermDef (SelPerm b)]
</span><a href="#local-6989586621688136619"><span class="hs-identifier hs-var">selectPermission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>            </span><span id="local-6989586621688136612"><span class="annot"><span class="annottext">Maybe (UpdPermInfo b)
</span><a href="#local-6989586621688136612"><span class="hs-identifier hs-var">update</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
   FieldInfoMap (FieldInfo b), Maybe (PermDef (UpdPerm b)))
  (Maybe (UpdPermInfo b))
forall (b :: BackendType) (a :: BackendType -&gt; *)
       (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowWriter (Seq CollectedInfo) arr,
 ArrowCache m arr, Cacheable (a b), Cacheable (Proxy b),
 MonadError QErr m, BackendMetadata b, ToJSON (a b), IsPerm a) =&gt;
arr
  (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
   FieldInfoMap (FieldInfo b), Maybe (PermDef (a b)))
  (Maybe (PermInfo a b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildPermission"><span class="hs-identifier hs-var">buildPermission</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy b
</span><a href="#local-6989586621688136632"><span class="hs-identifier hs-var">proxy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependency (TableCoreCache b)
</span><a href="#local-6989586621688136630"><span class="hs-identifier hs-var">tableCache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136631"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136624"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688136629"><span class="hs-identifier hs-var">tableFields</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PermDef (UpdPerm b)] -&gt; Maybe (PermDef (UpdPerm b))
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="annot"><span class="annottext">[PermDef (UpdPerm b)]
</span><a href="#local-6989586621688136618"><span class="hs-identifier hs-var">updatePermission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>            </span><span id="local-6989586621688136611"><span class="annot"><span class="annottext">Maybe (DelPermInfo b)
</span><a href="#local-6989586621688136611"><span class="hs-identifier hs-var">delete</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
   FieldInfoMap (FieldInfo b), Maybe (PermDef (DelPerm b)))
  (Maybe (DelPermInfo b))
forall (b :: BackendType) (a :: BackendType -&gt; *)
       (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowWriter (Seq CollectedInfo) arr,
 ArrowCache m arr, Cacheable (a b), Cacheable (Proxy b),
 MonadError QErr m, BackendMetadata b, ToJSON (a b), IsPerm a) =&gt;
arr
  (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
   FieldInfoMap (FieldInfo b), Maybe (PermDef (a b)))
  (Maybe (PermInfo a b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildPermission"><span class="hs-identifier hs-var">buildPermission</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy b
</span><a href="#local-6989586621688136632"><span class="hs-identifier hs-var">proxy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependency (TableCoreCache b)
</span><a href="#local-6989586621688136630"><span class="hs-identifier hs-var">tableCache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136631"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136624"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688136629"><span class="hs-identifier hs-var">tableFields</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PermDef (DelPerm b)] -&gt; Maybe (PermDef (DelPerm b))
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="annot"><span class="annottext">[PermDef (DelPerm b)]
</span><a href="#local-6989586621688136617"><span class="hs-identifier hs-var">deletePermission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>            </span><span class="annot"><span class="annottext">arr (RolePermInfo b) (RolePermInfo b)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
forall (b :: BackendType).
Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
</span><a href="Hasura.RQL.Types.Table.html#RolePermInfo"><span class="hs-identifier hs-var">RolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
</span><a href="#local-6989586621688136616"><span class="hs-identifier hs-var">insert</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621688136613"><span class="hs-identifier hs-var">select</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UpdPermInfo b)
</span><a href="#local-6989586621688136612"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DelPermInfo b)
</span><a href="#local-6989586621688136611"><span class="hs-identifier hs-var">delete</span></a></span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>      </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136626"><span class="hs-identifier hs-var">alignedPermissions</span></a></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-glyph">(|</span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><span class="annottext">forall a.
arr (a, (RolePermInfoMap b, (Role, ()))) (RolePermInfoMap b)
-&gt; arr (a, (RolePermInfoMap b, ([Role], ()))) (RolePermInfoMap b)
forall (arr :: * -&gt; * -&gt; *) (t :: * -&gt; *) e b a s.
(ArrowChoice arr, Foldable t) =&gt;
arr (e, (b, (a, s))) b -&gt; arr (e, (b, (t a, s))) b
</span><a href="Control.Arrow.Extended.html#foldlA%27"><span class="hs-identifier hs-var">foldlA'</span></a></span><span>
</span><span id="line-228"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688136607"><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621688136607"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span id="local-6989586621688136606"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136606"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#ParentRoles"><span class="hs-identifier hs-type">ParentRoles</span></a></span><span> </span><span id="local-6989586621688136605"><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688136605"><span class="hs-identifier hs-var">parentRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-229"></span><span>          </span><span id="local-6989586621688136604"><span class="annot"><span class="annottext">[RolePermInfo b]
</span><a href="#local-6989586621688136604"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-230"></span><span>            </span><span class="annot"><span class="annottext">arr (m [RolePermInfo b]) [RolePermInfo b]
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-231"></span><span>              </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">[RoleName]
-&gt; (RoleName -&gt; m (RolePermInfo b)) -&gt; m [RolePermInfo b]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621688136605"><span class="hs-identifier hs-var">parentRoles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RoleName -&gt; m (RolePermInfo b)) -&gt; m [RolePermInfo b])
-&gt; (RoleName -&gt; m (RolePermInfo b)) -&gt; m [RolePermInfo b]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688136602"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136602"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>                </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b) -&gt; m (RolePermInfo b) -&gt; m (RolePermInfo b)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; RolePermInfoMap b -&gt; Maybe (RolePermInfo b)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136602"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621688136607"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (RolePermInfo b) -&gt; m (RolePermInfo b))
-&gt; m (RolePermInfo b) -&gt; m (RolePermInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-233"></span><span>                  </span><span class="annot"><span class="annottext">Text -&gt; m (RolePermInfo b)
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m (RolePermInfo b)) -&gt; Text -&gt; m (RolePermInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-234"></span><span>                    </span><span class="hs-comment">-- this error will ideally never be thrown, but if it's thrown then</span><span>
</span><span id="line-235"></span><span>                    </span><span class="hs-comment">-- it's possible that the permissions for the role do exist, but it's</span><span>
</span><span id="line-236"></span><span>                    </span><span class="hs-comment">-- not yet built due to wrong ordering of the roles, check `orderRoles`</span><span>
</span><span id="line-237"></span><span>                    </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;buildTablePermissions: table role permissions for role: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136602"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; not found&quot;</span></span><span>
</span><span id="line-238"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136598"><span class="annot"><span class="annottext">combinedParentRolePermInfo :: CombineRolePermInfo b
</span><a href="#local-6989586621688136598"><span class="hs-identifier hs-var hs-var">combinedParentRolePermInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CombineRolePermInfo b] -&gt; CombineRolePermInfo b
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([CombineRolePermInfo b] -&gt; CombineRolePermInfo b)
-&gt; [CombineRolePermInfo b] -&gt; CombineRolePermInfo b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; CombineRolePermInfo b)
-&gt; [RolePermInfo b] -&gt; [CombineRolePermInfo b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; CombineRolePermInfo b
forall (b :: BackendType). RolePermInfo b -&gt; CombineRolePermInfo b
</span><a href="Hasura.RQL.Types.Roles.Internal.html#rolePermInfoToCombineRolePermInfo"><span class="hs-identifier hs-var">rolePermInfoToCombineRolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[RolePermInfo b]
</span><a href="#local-6989586621688136604"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span><span>
</span><span id="line-239"></span><span>              </span><span id="local-6989586621688136597"><span class="annot"><span class="annottext">selectPermissionsCount :: Int
</span><a href="#local-6989586621688136597"><span class="hs-identifier hs-var hs-var">selectPermissionsCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RolePermInfo b] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([RolePermInfo b] -&gt; Int) -&gt; [RolePermInfo b] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; Bool) -&gt; [RolePermInfo b] -&gt; [RolePermInfo b]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (SelPermInfo b) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (SelPermInfo b) -&gt; Bool)
-&gt; (RolePermInfo b -&gt; Maybe (SelPermInfo b))
-&gt; RolePermInfo b
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (SelPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (SelPermInfo b)
</span><a href="Hasura.RQL.Types.Table.html#_permSel"><span class="hs-identifier hs-var hs-var">_permSel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[RolePermInfo b]
</span><a href="#local-6989586621688136604"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span><span>
</span><span id="line-240"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136593"><span class="annot"><span class="annottext">accumulatedRolePermission :: Maybe (RolePermInfo b)
</span><a href="#local-6989586621688136593"><span class="hs-identifier hs-var hs-var">accumulatedRolePermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RolePermInfoMap b -&gt; Maybe (RolePermInfo b)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136606"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621688136607"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span>
</span><span id="line-241"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136592"><span class="annot"><span class="annottext">roleSelectPermission :: Maybe (SelPermInfo b)
</span><a href="#local-6989586621688136592"><span class="hs-identifier hs-var hs-var">roleSelectPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-242"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (SelPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (SelPermInfo b)
</span><a href="Hasura.RQL.Types.Table.html#_permSel"><span class="hs-identifier hs-var hs-var">_permSel</span></a></span><span> </span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; Maybe (SelPermInfo b))
-&gt; Maybe (RolePermInfo b) -&gt; Maybe (SelPermInfo b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621688136593"><span class="hs-identifier hs-var">accumulatedRolePermission</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-243"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688136591"><span class="annot"><span class="annottext">SelPermInfo b
</span><a href="#local-6989586621688136591"><span class="hs-identifier hs-var">metadataSelectPerm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SelPermInfo b -&gt; Maybe (SelPermInfo b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SelPermInfo b
</span><a href="#local-6989586621688136591"><span class="hs-identifier hs-var">metadataSelectPerm</span></a></span><span>
</span><span id="line-244"></span><span>                  </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CombinedSelPermInfo b -&gt; SelPermInfo b
forall (b :: BackendType).
Backend b =&gt;
Int -&gt; CombinedSelPermInfo b -&gt; SelPermInfo b
</span><a href="Hasura.RQL.Types.Table.html#combinedSelPermInfoToSelPermInfo"><span class="hs-identifier hs-var">combinedSelPermInfoToSelPermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688136597"><span class="hs-identifier hs-var">selectPermissionsCount</span></a></span><span> </span><span class="annot"><span class="annottext">(CombinedSelPermInfo b -&gt; SelPermInfo b)
-&gt; Maybe (CombinedSelPermInfo b) -&gt; Maybe (SelPermInfo b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CombineRolePermInfo b -&gt; Maybe (CombinedSelPermInfo b)
forall (b :: BackendType).
CombineRolePermInfo b -&gt; Maybe (CombinedSelPermInfo b)
</span><a href="Hasura.RQL.Types.Roles.Internal.html#crpiSelPerm"><span class="hs-identifier hs-var hs-var">crpiSelPerm</span></a></span><span> </span><span class="annot"><span class="annottext">CombineRolePermInfo b
</span><a href="#local-6989586621688136598"><span class="hs-identifier hs-var">combinedParentRolePermInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>          </span><span id="local-6989586621688136587"><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
</span><a href="#local-6989586621688136587"><span class="hs-identifier hs-var">roleInsertPermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (CheckPermission (InsPermInfo b), Maybe (RolePermInfo b),
   RolePermInfo b -&gt; Maybe (InsPermInfo b), RoleName, SourceName,
   TableName b, PermType)
  (Maybe (InsPermInfo b))
forall (b :: BackendType) (a :: BackendType -&gt; *)
       (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr, BackendMetadata b) =&gt;
arr
  (CheckPermission (PermInfo a b), Maybe (RolePermInfo b),
   RolePermInfo b -&gt; Maybe (PermInfo a b), RoleName, SourceName,
   TableName b, PermType)
  (Maybe (PermInfo a b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckTablePermission"><span class="hs-identifier hs-var">resolveCheckTablePermission</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CombineRolePermInfo b -&gt; CheckPermission (InsPermInfo b)
forall (b :: BackendType).
CombineRolePermInfo b -&gt; CheckPermission (InsPermInfo b)
</span><a href="Hasura.RQL.Types.Roles.Internal.html#crpiInsPerm"><span class="hs-identifier hs-var hs-var">crpiInsPerm</span></a></span><span> </span><span class="annot"><span class="annottext">CombineRolePermInfo b
</span><a href="#local-6989586621688136598"><span class="hs-identifier hs-var">combinedParentRolePermInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621688136593"><span class="hs-identifier hs-var">accumulatedRolePermission</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (InsPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (InsPermInfo b)
</span><a href="Hasura.RQL.Types.Table.html#_permIns"><span class="hs-identifier hs-var hs-var">_permIns</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136606"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136631"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136624"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="Hasura.RQL.Types.Permission.html#PTInsert"><span class="hs-identifier hs-var">PTInsert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>          </span><span id="local-6989586621688136583"><span class="annot"><span class="annottext">Maybe (UpdPermInfo b)
</span><a href="#local-6989586621688136583"><span class="hs-identifier hs-var">roleUpdatePermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (CheckPermission (UpdPermInfo b), Maybe (RolePermInfo b),
   RolePermInfo b -&gt; Maybe (UpdPermInfo b), RoleName, SourceName,
   TableName b, PermType)
  (Maybe (UpdPermInfo b))
forall (b :: BackendType) (a :: BackendType -&gt; *)
       (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr, BackendMetadata b) =&gt;
arr
  (CheckPermission (PermInfo a b), Maybe (RolePermInfo b),
   RolePermInfo b -&gt; Maybe (PermInfo a b), RoleName, SourceName,
   TableName b, PermType)
  (Maybe (PermInfo a b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckTablePermission"><span class="hs-identifier hs-var">resolveCheckTablePermission</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CombineRolePermInfo b -&gt; CheckPermission (UpdPermInfo b)
forall (b :: BackendType).
CombineRolePermInfo b -&gt; CheckPermission (UpdPermInfo b)
</span><a href="Hasura.RQL.Types.Roles.Internal.html#crpiUpdPerm"><span class="hs-identifier hs-var hs-var">crpiUpdPerm</span></a></span><span> </span><span class="annot"><span class="annottext">CombineRolePermInfo b
</span><a href="#local-6989586621688136598"><span class="hs-identifier hs-var">combinedParentRolePermInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621688136593"><span class="hs-identifier hs-var">accumulatedRolePermission</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (UpdPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (UpdPermInfo b)
</span><a href="Hasura.RQL.Types.Table.html#_permUpd"><span class="hs-identifier hs-var hs-var">_permUpd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136606"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136631"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136624"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="Hasura.RQL.Types.Permission.html#PTUpdate"><span class="hs-identifier hs-var">PTUpdate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>          </span><span id="local-6989586621688136579"><span class="annot"><span class="annottext">Maybe (DelPermInfo b)
</span><a href="#local-6989586621688136579"><span class="hs-identifier hs-var">roleDeletePermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (CheckPermission (DelPermInfo b), Maybe (RolePermInfo b),
   RolePermInfo b -&gt; Maybe (DelPermInfo b), RoleName, SourceName,
   TableName b, PermType)
  (Maybe (DelPermInfo b))
forall (b :: BackendType) (a :: BackendType -&gt; *)
       (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowCache m arr,
 ArrowWriter (Seq CollectedInfo) arr, BackendMetadata b) =&gt;
arr
  (CheckPermission (PermInfo a b), Maybe (RolePermInfo b),
   RolePermInfo b -&gt; Maybe (PermInfo a b), RoleName, SourceName,
   TableName b, PermType)
  (Maybe (PermInfo a b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckTablePermission"><span class="hs-identifier hs-var">resolveCheckTablePermission</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CombineRolePermInfo b -&gt; CheckPermission (DelPermInfo b)
forall (b :: BackendType).
CombineRolePermInfo b -&gt; CheckPermission (DelPermInfo b)
</span><a href="Hasura.RQL.Types.Roles.Internal.html#crpiDelPerm"><span class="hs-identifier hs-var hs-var">crpiDelPerm</span></a></span><span> </span><span class="annot"><span class="annottext">CombineRolePermInfo b
</span><a href="#local-6989586621688136598"><span class="hs-identifier hs-var">combinedParentRolePermInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621688136593"><span class="hs-identifier hs-var">accumulatedRolePermission</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (DelPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (DelPermInfo b)
</span><a href="Hasura.RQL.Types.Table.html#_permDel"><span class="hs-identifier hs-var hs-var">_permDel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136606"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136631"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136624"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="Hasura.RQL.Types.Permission.html#PTDelete"><span class="hs-identifier hs-var">PTDelete</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136575"><span class="annot"><span class="annottext">rolePermInfo :: RolePermInfo b
</span><a href="#local-6989586621688136575"><span class="hs-identifier hs-var hs-var">rolePermInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
forall (b :: BackendType).
Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
</span><a href="Hasura.RQL.Types.Table.html#RolePermInfo"><span class="hs-identifier hs-var">RolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
</span><a href="#local-6989586621688136587"><span class="hs-identifier hs-var">roleInsertPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621688136592"><span class="hs-identifier hs-var">roleSelectPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UpdPermInfo b)
</span><a href="#local-6989586621688136583"><span class="hs-identifier hs-var">roleUpdatePermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DelPermInfo b)
</span><a href="#local-6989586621688136579"><span class="hs-identifier hs-var">roleDeletePermission</span></a></span><span>
</span><span id="line-249"></span><span>          </span><span class="annot"><span class="annottext">arr (RolePermInfoMap b) (RolePermInfoMap b)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">RoleName
-&gt; RolePermInfo b -&gt; RolePermInfoMap b -&gt; RolePermInfoMap b
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136606"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b
</span><a href="#local-6989586621688136575"><span class="hs-identifier hs-var">rolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621688136607"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span>
</span><span id="line-250"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621688136622"><span class="hs-identifier hs-var">metadataRolePermissions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var hs-var">_unOrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621688136627"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-253"></span><span>    </span><span id="local-6989586621688136851"><span class="annot"><a href="#local-6989586621688136574"><span class="hs-identifier hs-type">mkMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermDef"><span class="hs-identifier hs-type">PermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136851"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermDef"><span class="hs-identifier hs-type">PermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136851"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-254"></span><span>    </span><span id="local-6989586621688136574"><span class="annot"><span class="annottext">mkMap :: [PermDef e] -&gt; HashMap RoleName (PermDef e)
</span><a href="#local-6989586621688136574"><span class="hs-identifier hs-var hs-var">mkMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PermDef e -&gt; RoleName)
-&gt; [PermDef e] -&gt; HashMap RoleName (PermDef e)
forall k a. (Eq k, Hashable k) =&gt; (a -&gt; k) -&gt; [a] -&gt; HashMap k a
</span><a href="Hasura.Prelude.html#mapFromL"><span class="hs-identifier hs-var">mapFromL</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef e -&gt; RoleName
forall a. PermDef a -&gt; RoleName
</span><a href="Hasura.RQL.Types.Permission.html#_pdRole"><span class="hs-identifier hs-var hs-var">_pdRole</span></a></span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621688136625"><span class="annot"><span class="annottext">alignPermissions :: TablePermissionInputs b
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136625"><span class="hs-identifier hs-var hs-var">alignPermissions</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#TablePermissionInputs"><span class="hs-identifier hs-type">TablePermissionInputs</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688136566"><span id="local-6989586621688136567"><span id="local-6989586621688136568"><span id="local-6989586621688136569"><span id="local-6989586621688136570"><span class="annot"><span class="annottext">[PermDef (UpdPerm b)]
[PermDef (DelPerm b)]
[PermDef (SelPerm b)]
[PermDef (InsPerm b)]
TableName b
_tpiDelete :: forall (b :: BackendType).
TablePermissionInputs b -&gt; [DelPermDef b]
_tpiUpdate :: forall (b :: BackendType).
TablePermissionInputs b -&gt; [UpdPermDef b]
_tpiSelect :: forall (b :: BackendType).
TablePermissionInputs b -&gt; [SelPermDef b]
_tpiInsert :: forall (b :: BackendType).
TablePermissionInputs b -&gt; [InsPermDef b]
_tpiDelete :: [PermDef (DelPerm b)]
_tpiUpdate :: [PermDef (UpdPerm b)]
_tpiSelect :: [PermDef (SelPerm b)]
_tpiInsert :: [PermDef (InsPerm b)]
_tpiTable :: TableName b
_tpiTable :: forall (b :: BackendType). TablePermissionInputs b -&gt; TableName b
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_tpiDelete"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-257"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136561"><span class="annot"><span class="annottext">insertsMap :: HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136561"><span class="hs-identifier hs-var hs-var">insertsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PermDef (InsPerm b)
 -&gt; ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
     [PermDef (UpdPerm b)], [PermDef (DelPerm b)]))
-&gt; HashMap RoleName (PermDef (InsPerm b))
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
forall v1 v2 k. (v1 -&gt; v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688136559"><span class="annot"><span class="annottext">PermDef (InsPerm b)
</span><a href="#local-6989586621688136559"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">PermDef (InsPerm b)
</span><a href="#local-6989586621688136559"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PermDef (InsPerm b)] -&gt; HashMap RoleName (PermDef (InsPerm b))
forall e. [PermDef e] -&gt; HashMap RoleName (PermDef e)
</span><a href="#local-6989586621688136574"><span class="hs-identifier hs-var">mkMap</span></a></span><span> </span><span class="annot"><span class="annottext">[PermDef (InsPerm b)]
</span><a href="#local-6989586621688136569"><span class="hs-identifier hs-var">_tpiInsert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>          </span><span id="local-6989586621688136558"><span class="annot"><span class="annottext">selectsMap :: HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136558"><span class="hs-identifier hs-var hs-var">selectsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PermDef (SelPerm b)
 -&gt; ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
     [PermDef (UpdPerm b)], [PermDef (DelPerm b)]))
-&gt; HashMap RoleName (PermDef (SelPerm b))
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
forall v1 v2 k. (v1 -&gt; v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688136557"><span class="annot"><span class="annottext">PermDef (SelPerm b)
</span><a href="#local-6989586621688136557"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PermDef (SelPerm b)
</span><a href="#local-6989586621688136557"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PermDef (SelPerm b)] -&gt; HashMap RoleName (PermDef (SelPerm b))
forall e. [PermDef e] -&gt; HashMap RoleName (PermDef e)
</span><a href="#local-6989586621688136574"><span class="hs-identifier hs-var">mkMap</span></a></span><span> </span><span class="annot"><span class="annottext">[PermDef (SelPerm b)]
</span><a href="#local-6989586621688136568"><span class="hs-identifier hs-var">_tpiSelect</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>          </span><span id="local-6989586621688136556"><span class="annot"><span class="annottext">updatesMap :: HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136556"><span class="hs-identifier hs-var hs-var">updatesMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PermDef (UpdPerm b)
 -&gt; ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
     [PermDef (UpdPerm b)], [PermDef (DelPerm b)]))
-&gt; HashMap RoleName (PermDef (UpdPerm b))
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
forall v1 v2 k. (v1 -&gt; v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688136555"><span class="annot"><span class="annottext">PermDef (UpdPerm b)
</span><a href="#local-6989586621688136555"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PermDef (UpdPerm b)
</span><a href="#local-6989586621688136555"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PermDef (UpdPerm b)] -&gt; HashMap RoleName (PermDef (UpdPerm b))
forall e. [PermDef e] -&gt; HashMap RoleName (PermDef e)
</span><a href="#local-6989586621688136574"><span class="hs-identifier hs-var">mkMap</span></a></span><span> </span><span class="annot"><span class="annottext">[PermDef (UpdPerm b)]
</span><a href="#local-6989586621688136567"><span class="hs-identifier hs-var">_tpiUpdate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>          </span><span id="local-6989586621688136554"><span class="annot"><span class="annottext">deletesMap :: HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136554"><span class="hs-identifier hs-var hs-var">deletesMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PermDef (DelPerm b)
 -&gt; ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
     [PermDef (UpdPerm b)], [PermDef (DelPerm b)]))
-&gt; HashMap RoleName (PermDef (DelPerm b))
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
forall v1 v2 k. (v1 -&gt; v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688136553"><span class="annot"><span class="annottext">PermDef (DelPerm b)
</span><a href="#local-6989586621688136553"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PermDef (DelPerm b)
</span><a href="#local-6989586621688136553"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PermDef (DelPerm b)] -&gt; HashMap RoleName (PermDef (DelPerm b))
forall e. [PermDef e] -&gt; HashMap RoleName (PermDef e)
</span><a href="#local-6989586621688136574"><span class="hs-identifier hs-var">mkMap</span></a></span><span> </span><span class="annot"><span class="annottext">[PermDef (DelPerm b)]
</span><a href="#local-6989586621688136566"><span class="hs-identifier hs-var">_tpiDelete</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>          </span><span id="local-6989586621688136552"><span class="annot"><span class="annottext">unionMap :: HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136552"><span class="hs-identifier hs-var hs-var">unionMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([PermDef (InsPerm b)], [PermDef (SelPerm b)],
  [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
 -&gt; ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
     [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
 -&gt; ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
     [PermDef (UpdPerm b)], [PermDef (DelPerm b)]))
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; HashMap k v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.unionWith</span></span><span> </span><span class="annot"><span class="annottext">([PermDef (InsPerm b)], [PermDef (SelPerm b)],
 [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
    [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
    [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(&lt;&gt;)</span></span><span>
</span><span id="line-262"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136561"><span class="hs-identifier hs-var">insertsMap</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136552"><span class="hs-operator hs-var">`unionMap`</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136558"><span class="hs-identifier hs-var">selectsMap</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136552"><span class="hs-operator hs-var">`unionMap`</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136556"><span class="hs-identifier hs-var">updatesMap</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
-&gt; HashMap
     RoleName
     ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
      [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136552"><span class="hs-operator hs-var">`unionMap`</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  ([PermDef (InsPerm b)], [PermDef (SelPerm b)],
   [PermDef (UpdPerm b)], [PermDef (DelPerm b)])
</span><a href="#local-6989586621688136554"><span class="hs-identifier hs-var">deletesMap</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkPermissionMetadataObject"><span class="hs-identifier hs-type">mkPermissionMetadataObject</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688136814"><span class="annot"><a href="#local-6989586621688136814"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688136815"><span class="annot"><a href="#local-6989586621688136815"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688136815"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136814"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136814"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html#IsPerm"><span class="hs-identifier hs-type">IsPerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136815"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-268"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136814"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermDef"><span class="hs-identifier hs-type">PermDef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688136815"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136814"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span>
</span><span id="line-271"></span><span id="mkPermissionMetadataObject"><span class="annot"><span class="annottext">mkPermissionMetadataObject :: SourceName -&gt; TableName b -&gt; PermDef (a b) -&gt; MetadataObject
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkPermissionMetadataObject"><span class="hs-identifier hs-var hs-var">mkPermissionMetadataObject</span></a></span></span><span> </span><span id="local-6989586621688136550"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136550"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621688136549"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136549"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621688136548"><span class="annot"><span class="annottext">PermDef (a b)
</span><a href="#local-6989586621688136548"><span class="hs-identifier hs-var">permDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136547"><span class="annot"><span class="annottext">permType :: PermType
</span><a href="#local-6989586621688136547"><span class="hs-identifier hs-var hs-var">permType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PermAccessor b (PermInfo a b) -&gt; PermType
forall (b :: BackendType) a. PermAccessor b a -&gt; PermType
</span><a href="Hasura.RQL.Types.Table.html#permAccToType"><span class="hs-identifier hs-var">permAccToType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermAccessor b (PermInfo a b)
forall (a :: BackendType -&gt; *) (b :: BackendType).
(IsPerm a, ToJSON (a b), BackendMetadata b) =&gt;
PermAccessor b (PermInfo a b)
</span><a href="Hasura.RQL.DDL.Permission.html#permAccessor"><span class="hs-identifier hs-var">permAccessor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PermAccessor"><span class="hs-identifier hs-type">PermAccessor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136814"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html#PermInfo"><span class="hs-identifier hs-type">PermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136815"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136814"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>      </span><span id="local-6989586621688136544"><span class="annot"><span class="annottext">objectId :: MetadataObjId
</span><a href="#local-6989586621688136544"><span class="hs-identifier hs-var hs-var">objectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-274"></span><span>        </span><span class="annot"><span class="annottext">SourceName -&gt; AnyBackend SourceMetadataObjId -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOSourceObjId"><span class="hs-identifier hs-var">MOSourceObjId</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136550"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">(AnyBackend SourceMetadataObjId -&gt; MetadataObjId)
-&gt; AnyBackend SourceMetadataObjId -&gt; MetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-275"></span><span>          </span><span class="annot"><span class="annottext">SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId)
-&gt; SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-276"></span><span>            </span><span class="annot"><span class="annottext">TableName b -&gt; TableMetadataObjId -&gt; SourceMetadataObjId b
forall (b :: BackendType).
TableName b -&gt; TableMetadataObjId -&gt; SourceMetadataObjId b
</span><a href="Hasura.RQL.Types.Metadata.Object.html#SMOTableObj"><span class="hs-identifier hs-var">SMOTableObj</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688136814"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136549"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">(TableMetadataObjId -&gt; SourceMetadataObjId b)
-&gt; TableMetadataObjId -&gt; SourceMetadataObjId b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-277"></span><span>              </span><span class="annot"><span class="annottext">RoleName -&gt; PermType -&gt; TableMetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MTOPerm"><span class="hs-identifier hs-var">MTOPerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermDef (a b) -&gt; RoleName
forall a. PermDef a -&gt; RoleName
</span><a href="Hasura.RQL.Types.Permission.html#_pdRole"><span class="hs-identifier hs-var hs-var">_pdRole</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef (a b)
</span><a href="#local-6989586621688136548"><span class="hs-identifier hs-var">permDef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="#local-6989586621688136547"><span class="hs-identifier hs-var">permType</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span id="local-6989586621688136539"><span class="annot"><span class="annottext">definition :: Value
</span><a href="#local-6989586621688136539"><span class="hs-identifier hs-var hs-var">definition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithTable b (PermDef (a b)) -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">(WithTable b (PermDef (a b)) -&gt; Value)
-&gt; WithTable b (PermDef (a b)) -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; TableName b -&gt; PermDef (a b) -&gt; WithTable b (PermDef (a b))
forall (b :: BackendType) a.
SourceName -&gt; TableName b -&gt; a -&gt; WithTable b a
</span><a href="Hasura.RQL.Types.Relationships.Local.html#WithTable"><span class="hs-identifier hs-var">WithTable</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688136814"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136550"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136549"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef (a b)
</span><a href="#local-6989586621688136548"><span class="hs-identifier hs-var">permDef</span></a></span><span>
</span><span id="line-279"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="#local-6989586621688136544"><span class="hs-identifier hs-var">objectId</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688136539"><span class="hs-identifier hs-var">definition</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkRemoteSchemaPermissionMetadataObject"><span class="hs-identifier hs-type">mkRemoteSchemaPermissionMetadataObject</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#AddRemoteSchemaPermission"><span class="hs-identifier hs-type">AddRemoteSchemaPermission</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-283"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span>
</span><span id="line-284"></span><span id="mkRemoteSchemaPermissionMetadataObject"><span class="annot"><span class="annottext">mkRemoteSchemaPermissionMetadataObject :: AddRemoteSchemaPermission -&gt; MetadataObject
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkRemoteSchemaPermissionMetadataObject"><span class="hs-identifier hs-var hs-var">mkRemoteSchemaPermissionMetadataObject</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.RemoteSchema.html#AddRemoteSchemaPermission"><span class="hs-identifier hs-type">AddRemoteSchemaPermission</span></a></span><span> </span><span id="local-6989586621688136534"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688136534"><span class="hs-identifier hs-var">rsName</span></a></span></span><span> </span><span id="local-6989586621688136533"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136533"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621688136532"><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621688136532"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136531"><span class="annot"><span class="annottext">objectId :: MetadataObjId
</span><a href="#local-6989586621688136531"><span class="hs-identifier hs-var hs-var">objectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; RoleName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MORemoteSchemaPermissions"><span class="hs-identifier hs-var">MORemoteSchemaPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621688136534"><span class="hs-identifier hs-var">rsName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136533"><span class="hs-identifier hs-var">roleName</span></a></span><span>
</span><span id="line-286"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="#local-6989586621688136531"><span class="hs-identifier hs-var">objectId</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; MetadataObject) -&gt; Value -&gt; MetadataObject
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621688136532"><span class="hs-identifier hs-var">defn</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#withPermission"><span class="hs-identifier hs-type">withPermission</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688136777"><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span></span><span> </span><span id="local-6989586621688136775"><span class="annot"><a href="#local-6989586621688136775"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621688136773"><span class="annot"><a href="#local-6989586621688136773"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688136776"><span class="annot"><a href="#local-6989586621688136776"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span id="local-6989586621688136774"><span class="annot"><a href="#local-6989586621688136774"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621688136778"><span class="annot"><a href="#local-6989586621688136778"><span class="hs-identifier hs-type">arr</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688136778"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688136778"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688136776"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html#IsPerm"><span class="hs-identifier hs-type">IsPerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136776"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-291"></span><span>  </span><span class="annot"><a href="Control.Arrow.Trans.html#WriterA"><span class="hs-identifier hs-type">WriterA</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SchemaDependency"><span class="hs-identifier hs-type">SchemaDependency</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Arrow.Trans.html#ErrorA"><span class="hs-identifier hs-type">ErrorA</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136778"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688136775"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688136774"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688136773"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621688136775"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermDef"><span class="hs-identifier hs-type">PermDef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688136776"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688136774"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>    </span><span class="annot"><a href="#local-6989586621688136778"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621688136773"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span id="withPermission"><span class="annot"><span class="annottext">withPermission :: WriterA (Seq SchemaDependency) (ErrorA QErr arr) (a, s) b
-&gt; arr
     (a,
      ((SourceName, TableName bknd, PermDef (c bknd), Proxy bknd), s))
     (Maybe b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#withPermission"><span class="hs-identifier hs-var hs-var">withPermission</span></a></span></span><span> </span><span id="local-6989586621688136528"><span class="annot"><span class="annottext">WriterA (Seq SchemaDependency) (ErrorA QErr arr) (a, s) b
</span><a href="#local-6989586621688136528"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688136527"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688136527"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621688136526"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136526"><span class="hs-identifier hs-var">source</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136525"><span class="annot"><span class="annottext">TableName bknd
</span><a href="#local-6989586621688136525"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136524"><span class="annot"><span class="annottext">PermDef (c bknd)
</span><a href="#local-6989586621688136524"><span class="hs-identifier hs-var">permission</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136523"><span class="annot"><span class="annottext">Proxy bknd
</span><a href="#local-6989586621688136523"><span class="hs-identifier hs-var">_proxy</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136522"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621688136522"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688136521"><span class="annot"><span class="annottext">metadataObject :: MetadataObject
</span><a href="#local-6989586621688136521"><span class="hs-identifier hs-var hs-var">metadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; TableName bknd -&gt; PermDef (c bknd) -&gt; MetadataObject
forall (b :: BackendType) (a :: BackendType -&gt; *).
(ToJSON (a b), BackendMetadata b, IsPerm a) =&gt;
SourceName -&gt; TableName b -&gt; PermDef (a b) -&gt; MetadataObject
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkPermissionMetadataObject"><span class="hs-identifier hs-var">mkPermissionMetadataObject</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136526"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableName bknd
</span><a href="#local-6989586621688136525"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef (c bknd)
</span><a href="#local-6989586621688136524"><span class="hs-identifier hs-var">permission</span></a></span><span>
</span><span id="line-298"></span><span>      </span><span id="local-6989586621688136520"><span class="annot"><span class="annottext">permType :: PermType
</span><a href="#local-6989586621688136520"><span class="hs-identifier hs-var hs-var">permType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PermAccessor bknd (PermInfo c bknd) -&gt; PermType
forall (b :: BackendType) a. PermAccessor b a -&gt; PermType
</span><a href="Hasura.RQL.Types.Table.html#permAccToType"><span class="hs-identifier hs-var">permAccToType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermAccessor bknd (PermInfo c bknd)
forall (a :: BackendType -&gt; *) (b :: BackendType).
(IsPerm a, ToJSON (a b), BackendMetadata b) =&gt;
PermAccessor b (PermInfo a b)
</span><a href="Hasura.RQL.DDL.Permission.html#permAccessor"><span class="hs-identifier hs-var">permAccessor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PermAccessor"><span class="hs-identifier hs-type">PermAccessor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html#PermInfo"><span class="hs-identifier hs-type">PermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136776"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>      </span><span id="local-6989586621688136519"><span class="annot"><span class="annottext">roleName :: RoleName
</span><a href="#local-6989586621688136519"><span class="hs-identifier hs-var hs-var">roleName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PermDef (c bknd) -&gt; RoleName
forall a. PermDef a -&gt; RoleName
</span><a href="Hasura.RQL.Types.Permission.html#_pdRole"><span class="hs-identifier hs-var hs-var">_pdRole</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef (c bknd)
</span><a href="#local-6989586621688136524"><span class="hs-identifier hs-var">permission</span></a></span><span>
</span><span id="line-300"></span><span>      </span><span id="local-6989586621688136518"><span class="annot"><span class="annottext">schemaObject :: SchemaObjId
</span><a href="#local-6989586621688136518"><span class="hs-identifier hs-var hs-var">schemaObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><span class="annottext">SourceName -&gt; AnyBackend SourceObjId -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOSourceObj"><span class="hs-identifier hs-var">SOSourceObj</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136526"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">(AnyBackend SourceObjId -&gt; SchemaObjId)
-&gt; AnyBackend SourceObjId -&gt; SchemaObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-302"></span><span>          </span><span class="annot"><span class="annottext">SourceObjId bknd -&gt; AnyBackend SourceObjId
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceObjId bknd -&gt; AnyBackend SourceObjId)
-&gt; SourceObjId bknd -&gt; AnyBackend SourceObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-303"></span><span>            </span><span class="annot"><span class="annottext">TableName bknd -&gt; TableObjId bknd -&gt; SourceObjId bknd
forall (b :: BackendType).
TableName b -&gt; TableObjId b -&gt; SourceObjId b
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOITableObj"><span class="hs-identifier hs-var">SOITableObj</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span><span> </span><span class="annot"><span class="annottext">TableName bknd
</span><a href="#local-6989586621688136525"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">(TableObjId bknd -&gt; SourceObjId bknd)
-&gt; TableObjId bknd -&gt; SourceObjId bknd
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-304"></span><span>              </span><span class="annot"><span class="annottext">RoleName -&gt; PermType -&gt; TableObjId bknd
forall (b :: BackendType). RoleName -&gt; PermType -&gt; TableObjId b
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#TOPerm"><span class="hs-identifier hs-var">TOPerm</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136519"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="#local-6989586621688136520"><span class="hs-identifier hs-var">permType</span></a></span><span>
</span><span id="line-305"></span><span>      </span><span id="local-6989586621688136514"><span class="annot"><span class="annottext">addPermContext :: Text -&gt; Text
</span><a href="#local-6989586621688136514"><span class="hs-identifier hs-var hs-var">addPermContext</span></a></span></span><span> </span><span id="local-6989586621688136513"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688136513"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in permission for role &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688136519"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688136513"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-glyph">(|</span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><span class="annottext">forall a.
ErrorA QErr arr (a, ()) b
-&gt; arr (a, (MetadataObject, ())) (Maybe b)
forall (arr :: * -&gt; * -&gt; *) w e s a.
(ArrowChoice arr, ArrowWriter (Seq w) arr,
 AsInconsistentMetadata w) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-308"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-309"></span><span>          </span><span class="annot"><span class="annottext">forall a.
WriterA (Seq SchemaDependency) (ErrorA QErr arr) (a, ()) b
-&gt; ErrorA QErr arr (a, (MetadataObject, (SchemaObjId, ()))) b
forall (arr :: * -&gt; * -&gt; *) e s a.
ArrowWriter (Seq CollectedInfo) arr =&gt;
WriterA (Seq SchemaDependency) arr (e, s) a
-&gt; arr (e, (MetadataObject, (SchemaObjId, s))) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#withRecordDependencies"><span class="hs-identifier hs-var">withRecordDependencies</span></a></span><span>
</span><span id="line-310"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">(|</span><span>
</span><span id="line-311"></span><span>                </span><span class="annot"><span class="annottext">forall a.
WriterA (Seq SchemaDependency) (ErrorA QErr arr) (a, ()) b
-&gt; WriterA
     (Seq SchemaDependency) (ErrorA QErr arr) (a, (Text -&gt; Text, ())) b
forall (arr :: * -&gt; * -&gt; *) e s a.
ArrowError QErr arr =&gt;
arr (e, s) a -&gt; arr (e, (Text -&gt; Text, s)) a
</span><a href="Hasura.Base.Error.html#modifyErrA"><span class="hs-identifier hs-var">modifyErrA</span></a></span><span>
</span><span id="line-312"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WriterA (Seq SchemaDependency) (ErrorA QErr arr) (a, s) b
</span><a href="#local-6989586621688136528"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688136527"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621688136522"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>              </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName bknd -&gt; Text -&gt; Text
forall (b :: BackendType). Backend b =&gt; TableName b -&gt; Text -&gt; Text
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#addTableContext"><span class="hs-identifier hs-var">addTableContext</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688136777"><span class="hs-identifier hs-type">bknd</span></a></span><span> </span><span class="annot"><span class="annottext">TableName bknd
</span><a href="#local-6989586621688136525"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621688136514"><span class="hs-identifier hs-var">addPermContext</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>        </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688136521"><span class="hs-identifier hs-var">metadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaObjId
</span><a href="#local-6989586621688136518"><span class="hs-identifier hs-var">schemaObject</span></a></span><span>
</span><span id="line-316"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621688136521"><span class="hs-identifier hs-var">metadataObject</span></a></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildPermission"><span class="hs-identifier hs-type">buildPermission</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-320"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688136912"><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621688136913"><span class="annot"><a href="#local-6989586621688136913"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621688136915"><span class="annot"><a href="#local-6989586621688136915"><span class="hs-identifier hs-type">arr</span></a></span></span><span> </span><span id="local-6989586621688136914"><span class="annot"><a href="#local-6989586621688136914"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621688136915"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-322"></span><span>    </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectedInfo"><span class="hs-identifier hs-type">CollectedInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688136915"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-323"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136914"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136915"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-324"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Cacheable"><span class="hs-identifier hs-type">Inc.Cacheable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688136913"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Cacheable"><span class="hs-identifier hs-type">Inc.Cacheable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136914"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-328"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688136913"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-329"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html#IsPerm"><span class="hs-identifier hs-type">IsPerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136913"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-330"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-332"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Dependency"><span class="hs-identifier hs-type">Inc.Dependency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#TableCoreCache"><span class="hs-identifier hs-type">TableCoreCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-333"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-334"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-335"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#FieldInfoMap"><span class="hs-identifier hs-type">FieldInfoMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#FieldInfo"><span class="hs-identifier hs-type">FieldInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-336"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermDef"><span class="hs-identifier hs-type">PermDef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688136913"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>    </span><span class="annot"><a href="#local-6989586621688136915"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html#PermInfo"><span class="hs-identifier hs-type">PermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136913"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688136912"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span id="buildPermission"><span class="annot"><span class="annottext">buildPermission :: arr
  (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
   FieldInfoMap (FieldInfo b), Maybe (PermDef (a b)))
  (Maybe (PermInfo a b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildPermission"><span class="hs-identifier hs-var hs-var">buildPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">arr
  (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
   FieldInfoMap (FieldInfo b), Maybe (PermDef (a b)))
  (Maybe (PermInfo a b))
-&gt; arr
     (Proxy b, Dependency (TableCoreCache b), SourceName, TableName b,
      FieldInfoMap (FieldInfo b), Maybe (PermDef (a b)))
     (Maybe (PermInfo a b))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a b.
(ArrowCache m arr, Cacheable a) =&gt;
arr a b -&gt; arr a b
</span><a href="Hasura.Incremental.Internal.Cache.html#cache"><span class="hs-identifier hs-var">Inc.cache</span></a></span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688136508"><span class="annot"><span class="annottext">Proxy b
</span><a href="#local-6989586621688136508"><span class="hs-identifier hs-var">proxy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136507"><span class="annot"><span class="annottext">Dependency (TableCoreCache b)
</span><a href="#local-6989586621688136507"><span class="hs-identifier hs-var">tableCache</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136506"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136506"><span class="hs-identifier hs-var">source</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136505"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136505"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136504"><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688136504"><span class="hs-identifier hs-var">tableFields</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136503"><span class="annot"><span class="annottext">Maybe (PermDef (a b))
</span><a href="#local-6989586621688136503"><span class="hs-identifier hs-var">maybePermission</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>    </span><span class="hs-glyph">(|</span><span>
</span><span id="line-342"></span><span>      </span><span class="annot"><span class="annottext">forall a.
arr (a, (PermDef (a b), ())) (Maybe (PermInfo a b))
-&gt; arr
     (a, (Maybe (PermDef (a b)), ())) (Maybe (Maybe (PermInfo a b)))
forall (arr :: * -&gt; * -&gt; *) (t :: * -&gt; *) e a s b.
(ArrowChoice arr, Traversable t) =&gt;
arr (e, (a, s)) b -&gt; arr (e, (t a, s)) (t b)
</span><a href="Control.Arrow.Extended.html#traverseA"><span class="hs-identifier hs-var">traverseA</span></a></span><span>
</span><span id="line-343"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688136501"><span class="annot"><span class="annottext">PermDef (a b)
</span><a href="#local-6989586621688136501"><span class="hs-identifier hs-var">permission</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-344"></span><span>            </span><span class="hs-glyph">(|</span><span>
</span><span id="line-345"></span><span>              </span><span class="annot"><span class="annottext">forall a.
WriterA
  (Seq SchemaDependency) (ErrorA QErr arr) (a, ()) (PermInfo a b)
-&gt; arr
     (a, ((SourceName, TableName b, PermDef (a b), Proxy b), ()))
     (Maybe (PermInfo a b))
forall (bknd :: BackendType) a b (c :: BackendType -&gt; *) s
       (arr :: * -&gt; * -&gt; *).
(ArrowChoice arr, ArrowWriter (Seq CollectedInfo) arr,
 BackendMetadata bknd, ToJSON (c bknd), IsPerm c) =&gt;
WriterA (Seq SchemaDependency) (ErrorA QErr arr) (a, s) b
-&gt; arr
     (a,
      ((SourceName, TableName bknd, PermDef (c bknd), Proxy bknd), s))
     (Maybe b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#withPermission"><span class="hs-identifier hs-var">withPermission</span></a></span><span>
</span><span id="line-346"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-347"></span><span>                    </span><span class="annot"><span class="annottext">WriterA (Seq SchemaDependency) (ErrorA QErr arr) (m ()) ()
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr,
 MonadError e m) =&gt;
arr (m a) a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span>
</span><span id="line-348"></span><span>                      </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-349"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermDef (a b) -&gt; RoleName
forall a. PermDef a -&gt; RoleName
</span><a href="Hasura.RQL.Types.Permission.html#_pdRole"><span class="hs-identifier hs-var hs-var">_pdRole</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef (a b)
</span><a href="#local-6989586621688136501"><span class="hs-identifier hs-var">permission</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RoleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="Hasura.Session.html#adminRoleName"><span class="hs-identifier hs-var">adminRoleName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-350"></span><span>                          </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#ConstraintViolation"><span class="hs-identifier hs-var">ConstraintViolation</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cannot define permission for admin role&quot;</span></span><span>
</span><span id="line-351"></span><span>                    </span><span class="hs-special">(</span><span id="local-6989586621688136496"><span class="annot"><span class="annottext">PermInfo a b
</span><a href="#local-6989586621688136496"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688136495"><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688136495"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-352"></span><span>                      </span><span class="annot"><span class="annottext">WriterA
  (Seq SchemaDependency)
  (ErrorA QErr arr)
  (Either QErr (PermInfo a b, [SchemaDependency]))
  (PermInfo a b, [SchemaDependency])
forall (arr :: * -&gt; * -&gt; *) e a.
(ArrowChoice arr, ArrowError e arr) =&gt;
arr (Either e a) a
</span><a href="Control.Arrow.Trans.html#liftEitherA"><span class="hs-identifier hs-var">liftEitherA</span></a></span><span> </span><span class="annot"><span class="annottext">WriterA
  (Seq SchemaDependency)
  (ErrorA QErr arr)
  (Either QErr (PermInfo a b, [SchemaDependency]))
  (PermInfo a b, [SchemaDependency])
-&gt; WriterA
     (Seq SchemaDependency)
     (ErrorA QErr arr)
     (DependT m (Either QErr (PermInfo a b, [SchemaDependency])))
     (Either QErr (PermInfo a b, [SchemaDependency]))
-&gt; WriterA
     (Seq SchemaDependency)
     (ErrorA QErr arr)
     (DependT m (Either QErr (PermInfo a b, [SchemaDependency])))
     (PermInfo a b, [SchemaDependency])
forall k (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">&lt;&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">WriterA
  (Seq SchemaDependency)
  (ErrorA QErr arr)
  (DependT m (Either QErr (PermInfo a b, [SchemaDependency])))
  (Either QErr (PermInfo a b, [SchemaDependency]))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowCache m arr =&gt;
arr (DependT m a) a
</span><a href="Hasura.Incremental.Internal.Cache.html#bindDepend"><span class="hs-identifier hs-var">Inc.bindDepend</span></a></span><span>
</span><span id="line-353"></span><span>                        </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-354"></span><span>                          </span><span class="annot"><span class="annottext">ExceptT QErr (DependT m) (PermInfo a b, [SchemaDependency])
-&gt; DependT m (Either QErr (PermInfo a b, [SchemaDependency]))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr (DependT m) (PermInfo a b, [SchemaDependency])
 -&gt; DependT m (Either QErr (PermInfo a b, [SchemaDependency])))
-&gt; ExceptT QErr (DependT m) (PermInfo a b, [SchemaDependency])
-&gt; DependT m (Either QErr (PermInfo a b, [SchemaDependency]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-355"></span><span>                            </span><span class="annot"><span class="annottext">TableCoreCacheRT
  b (ExceptT QErr (DependT m)) (PermInfo a b, [SchemaDependency])
-&gt; (SourceName, Dependency (TableCoreCache b))
-&gt; ExceptT QErr (DependT m) (PermInfo a b, [SchemaDependency])
forall (b :: BackendType) (m :: * -&gt; *) a.
TableCoreCacheRT b m a
-&gt; (SourceName, Dependency (TableCoreCache b)) -&gt; m a
</span><a href="Hasura.RQL.Types.SchemaCache.html#runTableCoreCacheRT"><span class="hs-identifier hs-var hs-var">runTableCoreCacheRT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
-&gt; TableName b
-&gt; FieldInfoMap (FieldInfo b)
-&gt; PermDef (a b)
-&gt; TableCoreCacheRT
     b (ExceptT QErr (DependT m)) (PermInfo a b, [SchemaDependency])
forall (a :: BackendType -&gt; *) (b :: BackendType) (m :: * -&gt; *).
(IsPerm a, ToJSON (a b), BackendMetadata b, QErrM m,
 TableCoreInfoRM b m) =&gt;
SourceName
-&gt; TableName b
-&gt; FieldInfoMap (FieldInfo b)
-&gt; PermDef (a b)
-&gt; m (WithDeps (PermInfo a b))
</span><a href="Hasura.RQL.DDL.Permission.html#buildPermInfo"><span class="hs-identifier hs-var">buildPermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136506"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136505"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621688136504"><span class="hs-identifier hs-var">tableFields</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef (a b)
</span><a href="#local-6989586621688136501"><span class="hs-identifier hs-var">permission</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136506"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependency (TableCoreCache b)
</span><a href="#local-6989586621688136507"><span class="hs-identifier hs-var">tableCache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>                    </span><span class="annot"><span class="annottext">WriterA
  (Seq SchemaDependency) (ErrorA QErr arr) (Seq SchemaDependency) ()
forall w (arr :: * -&gt; * -&gt; *). ArrowWriter w arr =&gt; arr w ()
</span><a href="Control.Arrow.Trans.html#tellA"><span class="hs-identifier hs-var">tellA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">[SchemaDependency] -&gt; Seq SchemaDependency
forall a. [a] -&gt; Seq a
</span><span class="hs-identifier hs-var">Seq.fromList</span></span><span> </span><span class="annot"><span class="annottext">[SchemaDependency]
</span><a href="#local-6989586621688136495"><span class="hs-identifier hs-var">dependencies</span></a></span><span>
</span><span id="line-357"></span><span>                    </span><span class="annot"><span class="annottext">WriterA
  (Seq SchemaDependency)
  (ErrorA QErr arr)
  (PermInfo a b)
  (PermInfo a b)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">PermInfo a b
</span><a href="#local-6989586621688136496"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-358"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>            </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688136506"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621688136505"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PermDef (a b)
</span><a href="#local-6989586621688136501"><span class="hs-identifier hs-var">permission</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Proxy b
</span><a href="#local-6989586621688136508"><span class="hs-identifier hs-var">proxy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef (a b))
</span><a href="#local-6989586621688136503"><span class="hs-identifier hs-var">maybePermission</span></a></span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><span class="annottext">forall a.
arr (a, ()) (Maybe (Maybe (PermInfo a b)))
-&gt; arr
     (a, (Maybe (Maybe (PermInfo a b)), ())) (Maybe (PermInfo a b))
-&gt; arr (a, ()) (Maybe (PermInfo a b))
forall (arr :: * -&gt; * -&gt; *) e s a b.
Arrow arr =&gt;
arr (e, s) a -&gt; arr (e, (a, s)) b -&gt; arr (e, s) b
</span><a href="Control.Arrow.Extended.html#%3E-%3E"><span class="hs-operator hs-var">&gt;-&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688136486"><span class="annot"><span class="annottext">Maybe (Maybe (PermInfo a b))
</span><a href="#local-6989586621688136486"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe (PermInfo a b)) -&gt; Maybe (PermInfo a b)
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe (PermInfo a b))
</span><a href="#local-6989586621688136486"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-glyph">&gt;-</span><span> </span><span class="annot"><span class="annottext">arr (Maybe (PermInfo a b)) (Maybe (PermInfo a b))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span></pre></body></html>