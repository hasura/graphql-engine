<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Server.Limits</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier">HasResourceLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier">ResourceLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-5"></span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html"><span class="hs-identifier">Hasura.Metadata.Class</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.ApiLimit.html"><span class="hs-identifier">Hasura.RQL.Types.ApiLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.ApiLimit.html#ApiLimit"><span class="hs-identifier">ApiLimit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Session.html#UserInfo"><span class="hs-identifier">UserInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-comment">-- | Resource limits, represented by a function which modifies IO actions to</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- enforce those limits by throwing errors using 'MonadError' in the case</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- where they are exceeded.</span><span>
</span><span id="line-18"></span><span class="hs-keyword">data</span><span> </span><span id="ResourceLimits"><span class="annot"><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier hs-var">ResourceLimits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ResourceLimits"><span class="annot"><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier hs-var">ResourceLimits</span></a></span></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="runResourceLimits"><span class="annot"><span class="annottext">ResourceLimits
-&gt; forall (m :: * -&gt; *) a.
   (MonadBaseControl IO m, MonadError QErr m) =&gt;
   m a -&gt; m a
</span><a href="Hasura.Server.Limits.html#runResourceLimits"><span class="hs-identifier hs-var hs-var">runResourceLimits</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-20"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688178641"><span class="annot"><a href="#local-6989586621688178641"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688178637"><span class="annot"><a href="#local-6989586621688178637"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-21"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688178641"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178641"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-22"></span><span>      </span><span class="annot"><a href="#local-6989586621688178641"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178637"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-23"></span><span>      </span><span class="annot"><a href="#local-6989586621688178641"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178637"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-comment">-- | Monads which support resource (memory, CPU time, etc.) limiting</span><span>
</span><span id="line-27"></span><span class="hs-keyword">class</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688178636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="HasResourceLimits"><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-var">HasResourceLimits</span></a></span></span><span> </span><span id="local-6989586621688178636"><span class="annot"><a href="#local-6989586621688178636"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-28"></span><span>  </span><span id="askHTTPHandlerLimit"><span class="annot"><a href="Hasura.Server.Limits.html#askHTTPHandlerLimit"><span class="hs-identifier hs-type">askHTTPHandlerLimit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621688178636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier hs-type">ResourceLimits</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span id="askGraphqlOperationLimit"><span class="annot"><a href="Hasura.Server.Limits.html#askGraphqlOperationLimit"><span class="hs-identifier hs-type">askGraphqlOperationLimit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621688178636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Session.html#UserInfo"><span class="hs-identifier hs-type">UserInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.ApiLimit.html#ApiLimit"><span class="hs-identifier hs-type">ApiLimit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier hs-type">ResourceLimits</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-comment">-- A default for monad transformer instances</span><span>
</span><span id="line-32"></span><span>  </span><span id="local-6989586621688178609"><span id="local-6989586621688178610"><span class="hs-keyword">default</span><span> </span><span id="askHTTPHandlerLimit"><span class="annot"><a href="Hasura.Server.Limits.html#askHTTPHandlerLimit"><span class="hs-identifier hs-type">askHTTPHandlerLimit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688178636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="annot"><a href="#local-6989586621688178610"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178609"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTrans</span></span><span> </span><span class="annot"><a href="#local-6989586621688178610"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178609"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="#local-6989586621688178636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier hs-type">ResourceLimits</span></a></span></span></span><span>
</span><span id="line-35"></span><span>  </span><span id="local-6989586621688178608"><span class="annot"><a href="Hasura.Server.Limits.html#askHTTPHandlerLimit"><span class="hs-identifier hs-var hs-var">askHTTPHandlerLimit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">n ResourceLimits -&gt; t n ResourceLimits
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">n ResourceLimits
forall (m :: * -&gt; *). HasResourceLimits m =&gt; m ResourceLimits
</span><a href="Hasura.Server.Limits.html#askHTTPHandlerLimit"><span class="hs-identifier hs-var">askHTTPHandlerLimit</span></a></span></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span>  </span><span id="local-6989586621688178605"><span id="local-6989586621688178606"><span class="hs-keyword">default</span><span> </span><span id="askGraphqlOperationLimit"><span class="annot"><a href="Hasura.Server.Limits.html#askGraphqlOperationLimit"><span class="hs-identifier hs-type">askGraphqlOperationLimit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688178636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="annot"><a href="#local-6989586621688178606"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178605"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTrans</span></span><span> </span><span class="annot"><a href="#local-6989586621688178606"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178605"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="#local-6989586621688178636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Session.html#UserInfo"><span class="hs-identifier hs-type">UserInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.ApiLimit.html#ApiLimit"><span class="hs-identifier hs-type">ApiLimit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier hs-type">ResourceLimits</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-40"></span><span>  </span><span id="local-6989586621688178604"><span class="annot"><a href="Hasura.Server.Limits.html#askGraphqlOperationLimit"><span class="hs-identifier hs-var hs-var">askGraphqlOperationLimit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">n (UserInfo -&gt; ApiLimit -&gt; ResourceLimits)
-&gt; t n (UserInfo -&gt; ApiLimit -&gt; ResourceLimits)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">n (UserInfo -&gt; ApiLimit -&gt; ResourceLimits)
forall (m :: * -&gt; *).
HasResourceLimits m =&gt;
m (UserInfo -&gt; ApiLimit -&gt; ResourceLimits)
</span><a href="Hasura.Server.Limits.html#askGraphqlOperationLimit"><span class="hs-identifier hs-var">askGraphqlOperationLimit</span></a></span></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span id="local-6989586621688178602"><span id="local-6989586621688178603"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688178597"><span id="local-6989586621688178599"><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178603"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="#local-6989586621688178602"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178603"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span id="local-6989586621688178594"><span id="local-6989586621688178595"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688178589"><span id="local-6989586621688178591"><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178595"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="#local-6989586621688178594"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178595"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span id="local-6989586621688178588"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688178583"><span id="local-6989586621688178585"><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178588"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Tracing.html#TraceT"><span class="hs-identifier hs-type">Tracing.TraceT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178588"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span id="local-6989586621688178582"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688178577"><span id="local-6989586621688178579"><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178582"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Metadata.Class.html#MetadataStorageT"><span class="hs-identifier hs-type">MetadataStorageT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688178582"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-49"></span></pre></body></html>