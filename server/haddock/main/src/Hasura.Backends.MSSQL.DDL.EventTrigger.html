<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Backends.MSSQL.DDL.EventTrigger</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createTableEventTrigger"><span class="hs-identifier">createTableEventTrigger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchUndeliveredEvents"><span class="hs-identifier">fetchUndeliveredEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetry"><span class="hs-identifier">setRetry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordSuccess"><span class="hs-identifier">recordSuccess</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError"><span class="hs-identifier">recordError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier">recordError'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier">dropTriggerQ</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerAndArchiveEvents"><span class="hs-identifier">dropTriggerAndArchiveEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropDanglingSQLTrigger"><span class="hs-identifier">dropDanglingSQLTrigger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#redeliverEvent"><span class="hs-identifier">redeliverEvent</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertManualEvent"><span class="hs-identifier">insertManualEvent</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsInSource"><span class="hs-identifier">unlockEventsInSource</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersion"><span class="hs-identifier">getMaintenanceModeVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier">qualifyTableName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createMissingSQLTriggers"><span class="hs-identifier">createMissingSQLTriggers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExists"><span class="hs-identifier">checkIfTriggerExists</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#addCleanupLog"><span class="hs-identifier">addCleanupLog</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletion"><span class="hs-identifier">getCleanupEventsForDeletion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToDead"><span class="hs-identifier">updateCleanupEventStatusToDead</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPaused"><span class="hs-identifier">updateCleanupEventStatusToPaused</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompleted"><span class="hs-identifier">updateCleanupEventStatusToCompleted</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogs"><span class="hs-identifier">deleteEventTriggerLogs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">where</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BL</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.FileEmbed</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">makeRelativeToProject</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashSet</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set.NonEmpty</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Extended.html#ToTxt"><span class="hs-identifier">ToTxt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier">commaSeparated</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier">toTxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LT</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.NonEmpty.html"><span class="hs-identifier">Data.Text.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier">mkNonEmptyTextUnsafe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Format.ISO8601</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">iso8601Show</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html"><span class="hs-identifier">Database.MSSQL.Transaction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier">TxE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxET"><span class="hs-identifier">TxET</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier">multiRowQueryE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier">singleRowQueryE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier">unitQueryE</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Database.ODBC.SQLServer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Datetime2</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Datetimeoffset</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rawUnescapedText</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">toSql</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Database.ODBC.TH</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ODBC</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Connection</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html"><span class="hs-identifier">Hasura.Backends.MSSQL.DDL.Source.Version</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.SQL.Error.html"><span class="hs-identifier">Hasura.Backends.MSSQL.SQL.Error</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HGE</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.ToQuery.html"><span class="hs-identifier">Hasura.Backends.MSSQL.ToQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.ToQuery.html#fromTableName"><span class="hs-identifier">fromTableName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.ToQuery.html#toQueryFlat"><span class="hs-identifier">toQueryFlat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier">SchemaName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier">TableName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Types.Internal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier">columnNameText</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#geoTypes"><span class="hs-identifier">geoTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html"><span class="hs-identifier">Hasura.Eventing.Common</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Column.html"><span class="hs-identifier">Hasura.RQL.Types.Column</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.Types.EventTrigger</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html"><span class="hs-identifier">Hasura.RQL.Types.Eventing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#OpVar"><span class="hs-identifier">OpVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Table.html"><span class="hs-identifier">Hasura.RQL.Types.Table</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier">PrimaryKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.Backend.html"><span class="hs-identifier">Hasura.SQL.Backend</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Shakespeare.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">-- | creates a SQL Values list from haskell list  (('123-abc'), ('456-vgh'), ('234-asd'))</span><span>
</span><span id="line-69"></span><span id="local-6989586621689794507"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-type">generateSQLValuesFromList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Extended.html#ToTxt"><span class="hs-identifier hs-type">ToTxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794507"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621689794507"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span></span><span>
</span><span id="line-70"></span><span id="generateSQLValuesFromList"><span class="annot"><span class="annottext">generateSQLValuesFromList :: [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-var hs-var">generateSQLValuesFromList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Text) -&gt; [a] -&gt; Text
forall a. (a -&gt; Text) -&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromListWith"><span class="hs-identifier hs-var">generateSQLValuesFromListWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621689794454"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689794454"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689794454"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span id="local-6989586621689794734"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromListWith"><span class="hs-identifier hs-type">generateSQLValuesFromListWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621689794734"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621689794734"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span></span><span>
</span><span id="line-73"></span><span id="generateSQLValuesFromListWith"><span class="annot"><span class="annottext">generateSQLValuesFromListWith :: (a -&gt; Text) -&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromListWith"><span class="hs-identifier hs-var hs-var">generateSQLValuesFromListWith</span></a></span></span><span> </span><span id="local-6989586621689794453"><span class="annot"><span class="annottext">a -&gt; Text
</span><a href="#local-6989586621689794453"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621689794452"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621689794452"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794451"><span class="hs-identifier hs-var">values</span></a></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621689794451"><span class="annot"><span class="annottext">values :: [Text]
</span><a href="#local-6989586621689794451"><span class="hs-identifier hs-var hs-var">values</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Text) -&gt; [a] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621689794450"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689794450"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;(&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Text
</span><a href="#local-6989586621689794453"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689794450"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;)&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621689794452"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span id="local-6989586621689794449"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchUndeliveredEvents"><span class="hs-identifier hs-type">fetchUndeliveredEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794449"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794449"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-82"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-type">FetchBatchSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><a href="#local-6989586621689794449"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-85"></span><span id="fetchUndeliveredEvents"><span class="annot"><span class="annottext">fetchUndeliveredEvents :: MSSQLSourceConfig
-&gt; SourceName
-&gt; [TriggerName]
-&gt; MaintenanceMode ()
-&gt; FetchBatchSize
-&gt; m [Event 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchUndeliveredEvents"><span class="hs-identifier hs-var hs-var">fetchUndeliveredEvents</span></a></span></span><span> </span><span id="local-6989586621689794448"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794448"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794447"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689794447"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621689794446"><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689794446"><span class="hs-identifier hs-var">triggerNames</span></a></span></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621689794445"><span class="annot"><span class="annottext">FetchBatchSize
</span><a href="#local-6989586621689794445"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr [Event 'MSSQL]) -&gt; m [Event 'MSSQL]
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr [Event 'MSSQL]) -&gt; m [Event 'MSSQL])
-&gt; m (Either QErr [Event 'MSSQL]) -&gt; m [Event 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr [Event 'MSSQL]) -&gt; m (Either QErr [Event 'MSSQL])
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr [Event 'MSSQL]) -&gt; m (Either QErr [Event 'MSSQL]))
-&gt; IO (Either QErr [Event 'MSSQL])
-&gt; m (Either QErr [Event 'MSSQL])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-88"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO [Event 'MSSQL] -&gt; IO (Either QErr [Event 'MSSQL])
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794448"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO [Event 'MSSQL] -&gt; IO (Either QErr [Event 'MSSQL]))
-&gt; TxET QErr IO [Event 'MSSQL] -&gt; IO (Either QErr [Event 'MSSQL])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-89"></span><span>        </span><span class="annot"><span class="annottext">SourceName
-&gt; [TriggerName] -&gt; FetchBatchSize -&gt; TxET QErr IO [Event 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEvents"><span class="hs-identifier hs-var">fetchEvents</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689794447"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689794446"><span class="hs-identifier hs-var">triggerNames</span></a></span><span> </span><span class="annot"><span class="annottext">FetchBatchSize
</span><a href="#local-6989586621689794445"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span id="local-6989586621689794440"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetry"><span class="hs-identifier hs-type">setRetry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794440"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794440"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><a href="#local-6989586621689794440"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-98"></span><span id="setRetry"><span class="annot"><span class="annottext">setRetry :: MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetry"><span class="hs-identifier hs-var hs-var">setRetry</span></a></span></span><span> </span><span id="local-6989586621689794439"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794439"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794438"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794438"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621689794437"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794437"><span class="hs-identifier hs-var">retryTime</span></a></span></span><span> </span><span id="local-6989586621689794436"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794436"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-100"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-101"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794439"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-102"></span><span>        </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-var">setRetryTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794438"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794437"><span class="hs-identifier hs-var">retryTime</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794436"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span id="local-6989586621689794434"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertManualEvent"><span class="hs-identifier hs-type">insertManualEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794434"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794434"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><a href="Hasura.Session.html#UserInfo"><span class="hs-identifier hs-type">UserInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><a href="Hasura.Tracing.html#TraceContext"><span class="hs-identifier hs-type">Tracing.TraceContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-112"></span><span>  </span><span class="annot"><a href="#local-6989586621689794434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span></span><span>
</span><span id="line-113"></span><span id="insertManualEvent"><span class="annot"><span class="annottext">insertManualEvent :: MSSQLSourceConfig
-&gt; TableName
-&gt; TriggerName
-&gt; Value
-&gt; UserInfo
-&gt; TraceContext
-&gt; m EventId
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertManualEvent"><span class="hs-identifier hs-var hs-var">insertManualEvent</span></a></span></span><span> </span><span id="local-6989586621689794433"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794433"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794432"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794432"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621689794431"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794431"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794430"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689794430"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span id="local-6989586621689794429"><span class="annot"><span class="annottext">UserInfo
</span><a href="#local-6989586621689794429"><span class="hs-identifier hs-var">_userInfo</span></a></span></span><span> </span><span id="local-6989586621689794428"><span class="annot"><span class="annottext">TraceContext
</span><a href="#local-6989586621689794428"><span class="hs-identifier hs-var">_traceCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr EventId) -&gt; m EventId
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr EventId) -&gt; m EventId)
-&gt; m (Either QErr EventId) -&gt; m EventId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr EventId) -&gt; m (Either QErr EventId)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr EventId) -&gt; m (Either QErr EventId))
-&gt; IO (Either QErr EventId) -&gt; m (Either QErr EventId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-116"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO EventId -&gt; IO (Either QErr EventId)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794433"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO EventId -&gt; IO (Either QErr EventId))
-&gt; TxET QErr IO EventId -&gt; IO (Either QErr EventId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-117"></span><span>        </span><span class="hs-comment">-- TODO: Include TraceContext in payload</span><span>
</span><span id="line-118"></span><span>        </span><span class="annot"><span class="annottext">TableName -&gt; TriggerName -&gt; Value -&gt; TxET QErr IO EventId
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertMSSQLManualEventTx"><span class="hs-identifier hs-var">insertMSSQLManualEventTx</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794432"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794431"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689794430"><span class="hs-identifier hs-var">payload</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span id="local-6989586621689794426"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersion"><span class="hs-identifier hs-type">getMaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794426"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794426"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><a href="#local-6989586621689794426"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span></span><span>
</span><span id="line-126"></span><span id="getMaintenanceModeVersion"><span class="annot"><span class="annottext">getMaintenanceModeVersion :: MSSQLSourceConfig -&gt; m MaintenanceModeVersion
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersion"><span class="hs-identifier hs-var hs-var">getMaintenanceModeVersion</span></a></span></span><span> </span><span id="local-6989586621689794425"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794425"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-127"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr MaintenanceModeVersion) -&gt; m MaintenanceModeVersion
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr MaintenanceModeVersion)
 -&gt; m MaintenanceModeVersion)
-&gt; m (Either QErr MaintenanceModeVersion)
-&gt; m MaintenanceModeVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr MaintenanceModeVersion)
-&gt; m (Either QErr MaintenanceModeVersion)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr MaintenanceModeVersion)
 -&gt; m (Either QErr MaintenanceModeVersion))
-&gt; IO (Either QErr MaintenanceModeVersion)
-&gt; m (Either QErr MaintenanceModeVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO MaintenanceModeVersion
-&gt; IO (Either QErr MaintenanceModeVersion)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceReadTx"><span class="hs-identifier hs-var">runMSSQLSourceReadTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794425"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO MaintenanceModeVersion
 -&gt; IO (Either QErr MaintenanceModeVersion))
-&gt; TxET QErr IO MaintenanceModeVersion
-&gt; IO (Either QErr MaintenanceModeVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TxET QErr IO MaintenanceModeVersion
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersionTx"><span class="hs-identifier hs-var">getMaintenanceModeVersionTx</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span id="local-6989586621689794422"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordSuccess"><span class="hs-identifier hs-type">recordSuccess</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794422"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-137"></span><span>  </span><span class="annot"><a href="#local-6989586621689794422"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-138"></span><span id="recordSuccess"><span class="annot"><span class="annottext">recordSuccess :: MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Invocation 'EventType
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordSuccess"><span class="hs-identifier hs-var hs-var">recordSuccess</span></a></span></span><span> </span><span id="local-6989586621689794421"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794421"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794420"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794420"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621689794419"><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689794419"><span class="hs-identifier hs-var">invocation</span></a></span></span><span> </span><span id="local-6989586621689794418"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794418"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-139"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794421"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>      </span><span class="annot"><span class="annottext">TriggerName -&gt; Invocation 'EventType -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-var">insertInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#tmName"><span class="hs-identifier hs-var hs-var">tmName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; TriggerMetadata
forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794420"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689794419"><span class="hs-identifier hs-var">invocation</span></a></span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setSuccessTx"><span class="hs-identifier hs-var">setSuccessTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794420"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794418"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span id="local-6989586621689794413"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError"><span class="hs-identifier hs-type">recordError</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794413"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-147"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#ProcessEventError"><span class="hs-identifier hs-type">ProcessEventError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-150"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-151"></span><span>  </span><span class="annot"><a href="#local-6989586621689794413"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-152"></span><span id="recordError"><span class="annot"><span class="annottext">recordError :: MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Invocation 'EventType
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError"><span class="hs-identifier hs-var hs-var">recordError</span></a></span></span><span> </span><span id="local-6989586621689794412"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794412"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794411"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794411"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621689794410"><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689794410"><span class="hs-identifier hs-var">invocation</span></a></span></span><span> </span><span id="local-6989586621689794409"><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621689794409"><span class="hs-identifier hs-var">processEventError</span></a></span></span><span> </span><span id="local-6989586621689794408"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794408"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-153"></span><span>  </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
forall (m :: * -&gt; *).
MonadIO m =&gt;
MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier hs-var">recordError'</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794412"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794411"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; Maybe (Invocation 'EventType)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689794410"><span class="hs-identifier hs-var">invocation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621689794409"><span class="hs-identifier hs-var">processEventError</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794408"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span id="local-6989586621689794684"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier hs-type">recordError'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794684"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#ProcessEventError"><span class="hs-identifier hs-type">ProcessEventError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-162"></span><span>  </span><span class="annot"><a href="#local-6989586621689794684"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-163"></span><span id="recordError%27"><span class="annot"><span class="annottext">recordError' :: MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier hs-var hs-var">recordError'</span></a></span></span><span> </span><span id="local-6989586621689794407"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794407"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794406"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794406"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621689794405"><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
</span><a href="#local-6989586621689794405"><span class="hs-identifier hs-var">invocation</span></a></span></span><span> </span><span id="local-6989586621689794404"><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621689794404"><span class="hs-identifier hs-var">processEventError</span></a></span></span><span> </span><span id="local-6989586621689794403"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794403"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-164"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-165"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794407"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-166"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
-&gt; (Invocation 'EventType -&gt; TxET QErr IO ()) -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
</span><a href="#local-6989586621689794405"><span class="hs-identifier hs-var">invocation</span></a></span><span> </span><span class="annot"><span class="annottext">((Invocation 'EventType -&gt; TxET QErr IO ()) -&gt; TxET QErr IO ())
-&gt; (Invocation 'EventType -&gt; TxET QErr IO ()) -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Invocation 'EventType -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-var">insertInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#tmName"><span class="hs-identifier hs-var hs-var">tmName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; TriggerMetadata
forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794406"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621689794404"><span class="hs-identifier hs-var">processEventError</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-168"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#PESetRetry"><span class="hs-identifier hs-type">PESetRetry</span></a></span><span> </span><span id="local-6989586621689794400"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794400"><span class="hs-identifier hs-var">retryTime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-169"></span><span>          </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-var">setRetryTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794406"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794400"><span class="hs-identifier hs-var">retryTime</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794403"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-170"></span><span>        </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetError"><span class="hs-identifier hs-var">PESetError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setErrorTx"><span class="hs-identifier hs-var">setErrorTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794406"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794403"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span id="local-6989586621689794397"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#redeliverEvent"><span class="hs-identifier hs-type">redeliverEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794397"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794397"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><a href="#local-6989586621689794397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-177"></span><span id="redeliverEvent"><span class="annot"><span class="annottext">redeliverEvent :: MSSQLSourceConfig -&gt; EventId -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#redeliverEvent"><span class="hs-identifier hs-var hs-var">redeliverEvent</span></a></span></span><span> </span><span id="local-6989586621689794396"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794396"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794395"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689794395"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-180"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794396"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>        </span><span class="annot"><span class="annottext">EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkEventTx"><span class="hs-identifier hs-var">checkEventTx</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689794395"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><span class="annottext">EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markForDeliveryTx"><span class="hs-identifier hs-var">markForDeliveryTx</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689794395"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span id="local-6989586621689794392"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerAndArchiveEvents"><span class="hs-identifier hs-type">dropTriggerAndArchiveEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794392"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794392"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><a href="#local-6989586621689794392"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-190"></span><span id="dropTriggerAndArchiveEvents"><span class="annot"><span class="annottext">dropTriggerAndArchiveEvents :: MSSQLSourceConfig -&gt; TriggerName -&gt; TableName -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerAndArchiveEvents"><span class="hs-identifier hs-var hs-var">dropTriggerAndArchiveEvents</span></a></span></span><span> </span><span id="local-6989586621689794391"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794391"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794390"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794390"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794389"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794389"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-191"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794391"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>        </span><span class="annot"><span class="annottext">TriggerName -&gt; SchemaName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier hs-var">dropTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794390"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName -&gt; SchemaName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AtableSchema%3ATableName"><span class="hs-identifier hs-var hs-var">tableSchema</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794389"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>        </span><span class="annot"><span class="annottext">TriggerName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#archiveEvents"><span class="hs-identifier hs-var">archiveEvents</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794390"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span id="local-6989586621689794386"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropDanglingSQLTrigger"><span class="hs-identifier hs-type">dropDanglingSQLTrigger</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794386"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794386"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-202"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">HashSet</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-203"></span><span>  </span><span class="annot"><a href="#local-6989586621689794386"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-204"></span><span id="dropDanglingSQLTrigger"><span class="annot"><span class="annottext">dropDanglingSQLTrigger :: MSSQLSourceConfig
-&gt; TriggerName -&gt; TableName -&gt; HashSet Ops -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropDanglingSQLTrigger"><span class="hs-identifier hs-var hs-var">dropDanglingSQLTrigger</span></a></span></span><span> </span><span id="local-6989586621689794385"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794385"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794384"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794384"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794383"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794383"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621689794382"><span class="annot"><span class="annottext">HashSet Ops
</span><a href="#local-6989586621689794382"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-205"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-207"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794385"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>        </span><span class="annot"><span class="annottext">(Ops -&gt; TxET QErr IO ()) -&gt; HashSet Ops -&gt; TxET QErr IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SchemaName -&gt; Ops -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-var">dropTriggerOp</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794384"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName -&gt; SchemaName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AtableSchema%3ATableName"><span class="hs-identifier hs-var hs-var">tableSchema</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794383"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet Ops
</span><a href="#local-6989586621689794382"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span id="local-6989586621689794379"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createTableEventTrigger"><span class="hs-identifier hs-type">createTableEventTrigger</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-211"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#ServerConfigCtx"><span class="hs-identifier hs-type">ServerConfigCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerOpsDef"><span class="hs-identifier hs-type">TriggerOpsDef</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-219"></span><span>  </span><span class="annot"><a href="#local-6989586621689794379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-220"></span><span id="createTableEventTrigger"><span class="annot"><span class="annottext">createTableEventTrigger :: ServerConfigCtx
-&gt; MSSQLSourceConfig
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerName
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createTableEventTrigger"><span class="hs-identifier hs-var hs-var">createTableEventTrigger</span></a></span></span><span> </span><span id="local-6989586621689794378"><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621689794378"><span class="hs-identifier hs-var">_serverConfigCtx</span></a></span></span><span> </span><span id="local-6989586621689794377"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794377"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794376"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794376"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621689794375"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794375"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span id="local-6989586621689794374"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794374"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794373"><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689794373"><span class="hs-identifier hs-var">opsDefinition</span></a></span></span><span> </span><span id="local-6989586621689794372"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689794372"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-222"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794377"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-223"></span><span>      </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; TxET QErr IO ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-var">mkAllTriggersQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794374"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794376"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794375"><span class="hs-identifier hs-var">columns</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689794373"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689794372"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span id="local-6989586621689794370"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createMissingSQLTriggers"><span class="hs-identifier hs-type">createMissingSQLTriggers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794370"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794370"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794370"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-233"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerOpsDef"><span class="hs-identifier hs-type">TriggerOpsDef</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><a href="#local-6989586621689794370"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-236"></span><span id="createMissingSQLTriggers"><span class="annot"><span class="annottext">createMissingSQLTriggers :: MSSQLSourceConfig
-&gt; TableName
-&gt; ([ColumnInfo 'MSSQL],
    Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)))
-&gt; TriggerName
-&gt; TriggerOpsDef 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createMissingSQLTriggers"><span class="hs-identifier hs-var hs-var">createMissingSQLTriggers</span></a></span></span><span> </span><span id="local-6989586621689794369"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794369"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794368"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621689794368"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621689794366"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794366"><span class="hs-identifier hs-var">tableNameText</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689794364"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794364"><span class="hs-identifier hs-var">schemaText</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689794363"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794363"><span class="hs-identifier hs-var">allCols</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794362"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689794362"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689794361"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794361"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794360"><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689794360"><span class="hs-identifier hs-var">opsDefinition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-238"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr m () -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794369"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m () -&gt; m (Either QErr ()))
-&gt; TxET QErr m () -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-239"></span><span>      </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()) -&gt; TxET QErr m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdInsert"><span class="hs-identifier hs-var hs-var">tdInsert</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689794360"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621689794358"><span class="hs-identifier hs-var">doesSQLTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>      </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()) -&gt; TxET QErr m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdUpdate"><span class="hs-identifier hs-var hs-var">tdUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689794360"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621689794358"><span class="hs-identifier hs-var">doesSQLTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>      </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()) -&gt; TxET QErr m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdDelete"><span class="hs-identifier hs-var hs-var">tdDelete</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689794360"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621689794358"><span class="hs-identifier hs-var">doesSQLTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-243"></span><span>    </span><span id="local-6989586621689794358"><span class="annot"><span class="annottext">doesSQLTriggerExist :: Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621689794358"><span class="hs-identifier hs-var hs-var">doesSQLTriggerExist</span></a></span></span><span> </span><span id="local-6989586621689794352"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794352"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621689794351"><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689794351"><span class="hs-identifier hs-var">opSpec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794350"><span class="annot"><span class="annottext">triggerNameWithOp :: Text
</span><a href="#local-6989586621689794350"><span class="hs-identifier hs-var hs-var">triggerNameWithOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;notify_hasura_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794361"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794352"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-245"></span><span>      </span><span id="local-6989586621689794347"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689794347"><span class="hs-identifier hs-var">doesOpTriggerExist</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-246"></span><span>        </span><span class="annot"><span class="annottext">TxE QErr Bool -&gt; TxET QErr m Bool
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr Bool -&gt; TxET QErr m Bool)
-&gt; TxE QErr Bool -&gt; TxET QErr m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-247"></span><span>          </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxE QErr Bool
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span>
</span><span id="line-248"></span><span>            </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-249"></span><span>            </span><span class="annot"><span class="">[ODBC.sql|
               SELECT CASE WHEN EXISTS
                 ( SELECT 1
                   FROM sys.triggers tr
                   INNER join sys.tables tb on tr.parent_id = tb.object_id
                   INNER join sys.schemas s on tb.schema_id = s.schema_id
                   WHERE tb.name = $tableNameText AND tr.name = $triggerNameWithOp AND s.name = $schemaText
                 )
               THEN CAST(1 AS BIT)
               ELSE CAST(0 AS BIT)
               END;
             |]</span></span><span>
</span><span id="line-261"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr m () -&gt; TxET QErr m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689794347"><span class="hs-identifier hs-var">doesOpTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m () -&gt; TxET QErr m ())
-&gt; TxET QErr m () -&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794352"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-263"></span><span>          </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; TxET QErr m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-var">mkInsertTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794361"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794368"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794363"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689794351"><span class="hs-identifier hs-var">opSpec</span></a></span><span>
</span><span id="line-264"></span><span>          </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; TxET QErr m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-var">mkUpdateTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794361"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794368"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794363"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689794362"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689794351"><span class="hs-identifier hs-var">opSpec</span></a></span><span>
</span><span id="line-265"></span><span>          </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; TxET QErr m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-var">mkDeleteTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794361"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794368"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794363"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689794351"><span class="hs-identifier hs-var">opSpec</span></a></span><span>
</span><span id="line-266"></span><span>          </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#MANUAL"><span class="hs-identifier hs-var">MANUAL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TxET QErr m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span id="local-6989586621689794339"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsInSource"><span class="hs-identifier hs-type">unlockEventsInSource</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-271"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">NE.NESet</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-272"></span><span>  </span><span class="annot"><a href="#local-6989586621689794339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-273"></span><span id="unlockEventsInSource"><span class="annot"><span class="annottext">unlockEventsInSource :: MSSQLSourceConfig -&gt; NESet EventId -&gt; m (Either QErr Int)
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsInSource"><span class="hs-identifier hs-var hs-var">unlockEventsInSource</span></a></span></span><span> </span><span id="local-6989586621689794338"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794338"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794337"><span class="annot"><span class="annottext">NESet EventId
</span><a href="#local-6989586621689794337"><span class="hs-identifier hs-var">eventIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr Int) -&gt; m (Either QErr Int)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr Int) -&gt; m (Either QErr Int))
-&gt; IO (Either QErr Int) -&gt; m (Either QErr Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-275"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO Int -&gt; IO (Either QErr Int)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794338"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO Int -&gt; IO (Either QErr Int))
-&gt; TxET QErr IO Int -&gt; IO (Either QErr Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="annottext">[EventId] -&gt; TxET QErr IO Int
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsTx"><span class="hs-identifier hs-var">unlockEventsTx</span></a></span><span> </span><span class="annot"><span class="annottext">([EventId] -&gt; TxET QErr IO Int) -&gt; [EventId] -&gt; TxET QErr IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NESet EventId -&gt; [EventId]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">NESet EventId
</span><a href="#local-6989586621689794337"><span class="hs-identifier hs-var">eventIds</span></a></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="hs-comment">-- Check if any trigger for any of the operation exists with the 'triggerName'</span><span>
</span><span id="line-279"></span><span id="local-6989586621689794334"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExists"><span class="hs-identifier hs-type">checkIfTriggerExists</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-280"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794334"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794334"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-281"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-283"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">HashSet</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-284"></span><span>  </span><span class="annot"><a href="#local-6989586621689794334"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-285"></span><span id="checkIfTriggerExists"><span class="annot"><span class="annottext">checkIfTriggerExists :: MSSQLSourceConfig -&gt; TriggerName -&gt; HashSet Ops -&gt; m Bool
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExists"><span class="hs-identifier hs-var hs-var">checkIfTriggerExists</span></a></span></span><span> </span><span id="local-6989586621689794333"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794333"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794332"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794332"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794331"><span class="annot"><span class="annottext">HashSet Ops
</span><a href="#local-6989586621689794331"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-286"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr Bool) -&gt; m Bool
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr Bool) -&gt; m Bool) -&gt; m (Either QErr Bool) -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-287"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr Bool) -&gt; m (Either QErr Bool)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr Bool) -&gt; m (Either QErr Bool))
-&gt; IO (Either QErr Bool) -&gt; m (Either QErr Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-288"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxE QErr Bool -&gt; IO (Either QErr Bool)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794333"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr Bool -&gt; IO (Either QErr Bool))
-&gt; TxE QErr Bool -&gt; IO (Either QErr Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><span class="annottext">([Bool] -&gt; Bool) -&gt; TxET QErr IO [Bool] -&gt; TxE QErr Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">or</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ops -&gt; TxE QErr Bool) -&gt; [Ops] -&gt; TxET QErr IO [Bool]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; Ops -&gt; TxE QErr Bool
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExistsQ"><span class="hs-identifier hs-var">checkIfTriggerExistsQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794332"><span class="hs-identifier hs-var">triggerName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet Ops -&gt; [Ops]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">HashSet.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet Ops
</span><a href="#local-6989586621689794331"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">---- DATABASE QUERIES ---------------------</span><span>
</span><span id="line-292"></span><span class="hs-comment">--</span><span>
</span><span id="line-293"></span><span class="hs-comment">--   The API for our in-database work queue:</span><span>
</span><span id="line-294"></span><span class="hs-comment">-------------------------------------------</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-type">insertInvocation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span id="insertInvocation"><span class="annot"><span class="annottext">insertInvocation :: TriggerName -&gt; Invocation 'EventType -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-var hs-var">insertInvocation</span></a></span></span><span> </span><span id="local-6989586621689794326"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794326"><span class="hs-identifier hs-var">tName</span></a></span></span><span> </span><span id="local-6989586621689794325"><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689794325"><span class="hs-identifier hs-var">invo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-299"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      INSERT INTO hdb_catalog.event_invocation_logs (event_id, trigger_name, status, request, response)
          VALUES ($invoEventId, $invoTriggerName, $invoStatus, $invoRequest, $invoResponse)
    |]</span></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      UPDATE hdb_catalog.event_log

      SET tries = tries + 1
      WHERE id = $invoEventId
    |]</span></span><span>
</span><span id="line-313"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621689794324"><span class="annot"><span class="annottext">invoEventId :: Text
</span><a href="#local-6989586621689794324"><span class="hs-identifier hs-var hs-var">invoEventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; EventId
forall (a :: TriggerTypes). Invocation a -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#iEventId"><span class="hs-identifier hs-var hs-var">iEventId</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689794325"><span class="hs-identifier hs-var">invo</span></a></span><span>
</span><span id="line-315"></span><span>    </span><span id="local-6989586621689794323"><span class="annot"><span class="annottext">invoStatus :: Maybe Int
</span><a href="#local-6989586621689794323"><span class="hs-identifier hs-var hs-var">invoStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; Maybe Int -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; Maybe Int
forall (a :: TriggerTypes). Invocation a -&gt; Maybe Int
</span><a href="Hasura.RQL.Types.Eventing.html#iStatus"><span class="hs-identifier hs-var hs-var">iStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689794325"><span class="hs-identifier hs-var">invo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-316"></span><span>    </span><span id="local-6989586621689794322"><span class="annot"><span class="annottext">invoRequest :: ByteString
</span><a href="#local-6989586621689794322"><span class="hs-identifier hs-var hs-var">invoRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; ByteString) -&gt; Value -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WebhookRequest -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">(WebhookRequest -&gt; Value) -&gt; WebhookRequest -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; WebhookRequest
forall (a :: TriggerTypes). Invocation a -&gt; WebhookRequest
</span><a href="Hasura.RQL.Types.Eventing.html#iRequest"><span class="hs-identifier hs-var hs-var">iRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689794325"><span class="hs-identifier hs-var">invo</span></a></span><span>
</span><span id="line-317"></span><span>    </span><span id="local-6989586621689794321"><span class="annot"><span class="annottext">invoResponse :: ByteString
</span><a href="#local-6989586621689794321"><span class="hs-identifier hs-var hs-var">invoResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; ByteString) -&gt; Value -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Response 'EventType -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">(Response 'EventType -&gt; Value) -&gt; Response 'EventType -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; Response 'EventType
forall (a :: TriggerTypes). Invocation a -&gt; Response a
</span><a href="Hasura.RQL.Types.Eventing.html#iResponse"><span class="hs-identifier hs-var hs-var">iResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689794325"><span class="hs-identifier hs-var">invo</span></a></span><span>
</span><span id="line-318"></span><span>    </span><span id="local-6989586621689794320"><span class="annot"><span class="annottext">invoTriggerName :: Text
</span><a href="#local-6989586621689794320"><span class="hs-identifier hs-var hs-var">invoTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794326"><span class="hs-identifier hs-var">tName</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertMSSQLManualEventTx"><span class="hs-identifier hs-type">insertMSSQLManualEventTx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-321"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-322"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-323"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-324"></span><span>  </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span>
</span><span id="line-325"></span><span id="insertMSSQLManualEventTx"><span class="annot"><span class="annottext">insertMSSQLManualEventTx :: TableName -&gt; TriggerName -&gt; Value -&gt; TxET QErr IO EventId
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertMSSQLManualEventTx"><span class="hs-identifier hs-var hs-var">insertMSSQLManualEventTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621689794311"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794311"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689794310"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794310"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621689794309"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794309"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794308"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689794308"><span class="hs-identifier hs-var">rowData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-326"></span><span>  </span><span id="local-6989586621689794307"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794307"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ByteString
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><span class="">[ODBC.sql|
          INSERT INTO hdb_catalog.event_log (schema_name, table_name, trigger_name, payload)
          OUTPUT CONVERT(varchar(MAX), inserted.id)
          VALUES
          ($schemaName, $tableName, $triggerNameTxt, $payload)
        |]</span></span><span>
</span><span id="line-335"></span><span>  </span><span class="annot"><span class="annottext">EventId -&gt; TxET QErr IO EventId
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-var">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794307"><span class="hs-identifier hs-var">eventId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-337"></span><span>    </span><span id="local-6989586621689794306"><span class="annot"><span class="annottext">triggerNameTxt :: Text
</span><a href="#local-6989586621689794306"><span class="hs-identifier hs-var hs-var">triggerNameTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794309"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621689794305"><span class="annot"><span class="annottext">payload :: ByteString
</span><a href="#local-6989586621689794305"><span class="hs-identifier hs-var hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689794308"><span class="hs-identifier hs-var">rowData</span></a></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setSuccessTx"><span class="hs-identifier hs-type">setSuccessTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span id="setSuccessTx"><span class="annot"><span class="annottext">setSuccessTx :: Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setSuccessTx"><span class="hs-identifier hs-var hs-var">setSuccessTx</span></a></span></span><span> </span><span id="local-6989586621689794302"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794302"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#PreviousMMVersion"><span class="hs-identifier hs-var">PreviousMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected: no previous maintenance mode version found for MSSQL source&quot;</span></span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621689794297"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-344"></span><span>  </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621689794297"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-346"></span><span>    </span><span id="local-6989586621689794295"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621689794295"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794302"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span>    </span><span id="local-6989586621689794297"><span class="annot"><span class="annottext">latestVersionSetSuccess :: TxET QErr IO ()
</span><a href="#local-6989586621689794297"><span class="hs-identifier hs-var hs-var">latestVersionSetSuccess</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-349"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.event_log
          SET delivered = 1 , next_retry_at = NULL, locked = NULL
          WHERE id = $eventId
        |]</span></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setErrorTx"><span class="hs-identifier hs-type">setErrorTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span id="setErrorTx"><span class="annot"><span class="annottext">setErrorTx :: Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setErrorTx"><span class="hs-identifier hs-var hs-var">setErrorTx</span></a></span></span><span> </span><span id="local-6989586621689794293"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794293"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#PreviousMMVersion"><span class="hs-identifier hs-var">PreviousMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected: there is no previous maintenance mode version supported for MSSQL event triggers&quot;</span></span><span>
</span><span id="line-360"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621689794292"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-361"></span><span>  </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621689794292"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-362"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-363"></span><span>    </span><span id="local-6989586621689794291"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621689794291"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794293"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span>    </span><span id="local-6989586621689794292"><span class="annot"><span class="annottext">latestVersionSetSuccess :: TxET QErr IO ()
</span><a href="#local-6989586621689794292"><span class="hs-identifier hs-var hs-var">latestVersionSetSuccess</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-366"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-367"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-368"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.event_log
          SET error = 1 , next_retry_at = NULL, locked = NULL
          WHERE id = $eventId
        |]</span></span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span class="hs-comment">-- See Note [UTCTIME not supported in SQL Server]</span><span>
</span><span id="line-375"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-type">setRetryTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span id="setRetryTx"><span class="annot"><span class="annottext">setRetryTx :: Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-var hs-var">setRetryTx</span></a></span></span><span> </span><span id="local-6989586621689794290"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794290"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621689794289"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794289"><span class="hs-identifier hs-var">utcTime</span></a></span></span><span> </span><span id="local-6989586621689794288"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794288"><span class="hs-identifier hs-var">maintenanceMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-377"></span><span>  </span><span id="local-6989586621689794287"><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621689794287"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; TxET QErr IO Datetime2
forall (m :: * -&gt; *). MonadIO m =&gt; UTCTime -&gt; m Datetime2
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#convertUTCToDatetime2"><span class="hs-identifier hs-var">convertUTCToDatetime2</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794289"><span class="hs-identifier hs-var">utcTime</span></a></span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689794288"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-379"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#PreviousMMVersion"><span class="hs-identifier hs-var">PreviousMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected: there is no previous maintenance mode version supported for MSSQL event triggers&quot;</span></span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Datetime2 -&gt; TxET QErr IO ()
</span><a href="#local-6989586621689794285"><span class="hs-identifier hs-var">latestVersionSetRetry</span></a></span><span> </span><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621689794287"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-381"></span><span>    </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Datetime2 -&gt; TxET QErr IO ()
</span><a href="#local-6989586621689794285"><span class="hs-identifier hs-var">latestVersionSetRetry</span></a></span><span> </span><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621689794287"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-382"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-383"></span><span>    </span><span id="local-6989586621689794284"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621689794284"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689794290"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-comment">-- NOTE: Naveen: The following method to convert from Datetime to Datetimeoffset  was</span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-comment">-- taken from https://stackoverflow.com/questions/17866311/how-to-cast-datetime-to-datetimeoffset</span><span>
</span><span id="line-386"></span><span>    </span><span id="local-6989586621689794285"><span class="annot"><span class="annottext">latestVersionSetRetry :: Datetime2 -&gt; TxET QErr IO ()
</span><a href="#local-6989586621689794285"><span class="hs-identifier hs-var hs-var">latestVersionSetRetry</span></a></span></span><span> </span><span id="local-6989586621689794283"><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621689794283"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-387"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-389"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.event_log
          SET next_retry_at = TODATETIMEOFFSET ($time, DATEPART(TZOFFSET, SYSDATETIMEOFFSET())), locked = NULL
          WHERE id = $eventId
        |]</span></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span class="hs-comment">-- | Lock and return events not yet being processed or completed, up to some</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- limit. Process events approximately in created_at order, but we make no</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- ordering guarentees; events can and will race. Nevertheless we want to</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- ensure newer change events don't starve older ones.</span><span>
</span><span id="line-399"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEvents"><span class="hs-identifier hs-type">fetchEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-type">FetchBatchSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-400"></span><span id="fetchEvents"><span class="annot"><span class="annottext">fetchEvents :: SourceName
-&gt; [TriggerName] -&gt; FetchBatchSize -&gt; TxET QErr IO [Event 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEvents"><span class="hs-identifier hs-var hs-var">fetchEvents</span></a></span></span><span> </span><span id="local-6989586621689794282"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689794282"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621689794281"><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689794281"><span class="hs-identifier hs-var">triggerNames</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-type">FetchBatchSize</span></a></span><span> </span><span id="local-6989586621689794279"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689794279"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-401"></span><span>  </span><span class="hs-comment">-- The reason we do not inline the SQL but rather  create a template string is due</span><span>
</span><span id="line-402"></span><span>  </span><span class="hs-comment">-- to the problem with `ODBC.sql` variable substitution. When you use a variable</span><span>
</span><span id="line-403"></span><span>  </span><span class="hs-comment">-- whose value is a text and it contains a single quote `'`, the `ODBC.sql`</span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-comment">-- function escapes that single quote. i.e it converts `'` to `''`</span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-406"></span><span>  </span><span class="hs-comment">-- Note: A single quote in MSSQL is escaped by doubling it up (`''`)</span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-408"></span><span>  </span><span class="hs-comment">-- This is problematic, since we use a list of list of trigger names to fetch and</span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-comment">-- lock the events. A list of trigger names in MSSQL looks like Eg:</span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-comment">-- ('insert_test_books', 'et_test_bigint')</span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-comment">-- We use this list of trigger names in the `IN` operator to fetch only those</span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-comment">-- events.</span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-415"></span><span>  </span><span class="hs-comment">-- If we were to use the `ODBC.sql` function it would convert the list into</span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-comment">-- something which is not a valid list.</span><span>
</span><span id="line-417"></span><span>  </span><span class="hs-comment">-- Eg: ('insert_test_books', 'et_test_bigint') -&gt; (''insert_test_books'', ''et_test_bigint'')</span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-comment">-- Due to the problematic variable substitution of `ODBC.sql` it is imperative that</span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-comment">-- we resort to template strings, since that does not do any changes to the string.</span><span>
</span><span id="line-421"></span><span>  </span><span id="local-6989586621689794278"><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, ByteString, Int, ByteString)]
</span><a href="#local-6989586621689794278"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, Text, Text, ByteString, Int, ByteString)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query
 -&gt; TxET
      QErr
      IO
      [(ByteString, Text, Text, Text, ByteString, Int, ByteString)])
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, Text, Text, ByteString, Int, ByteString)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-423"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-424"></span><span>        </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_fetch_events.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>  </span><span class="annot"><span class="annottext">((ByteString, Text, Text, Text, ByteString, Int, ByteString)
 -&gt; TxET QErr IO (Event 'MSSQL))
-&gt; [(ByteString, Text, Text, Text, ByteString, Int, ByteString)]
-&gt; TxET QErr IO [Event 'MSSQL]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(ByteString, Text, Text, Text, ByteString, Int, ByteString)
-&gt; TxET QErr IO (Event 'MSSQL)
</span><a href="#local-6989586621689794268"><span class="hs-identifier hs-var">uncurryEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, ByteString, Int, ByteString)]
</span><a href="#local-6989586621689794278"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-427"></span><span>    </span><span class="hs-comment">-- Creates a list of trigger names to be used for 'IN' operator</span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-comment">-- Eg: ('insert_test_books', 'et_test_bigint')</span><span>
</span><span id="line-429"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-comment">-- We cannot use 'commaseperated()' because it creates the Text as</span><span>
</span><span id="line-431"></span><span>    </span><span class="hs-comment">-- 'insert_test_books, et_test_bigint' which is not useful to compare values in</span><span>
</span><span id="line-432"></span><span>    </span><span class="hs-comment">-- 'IN' MSSQL operator.</span><span>
</span><span id="line-433"></span><span>    </span><span id="local-6989586621689794275"><span class="annot"><span class="annottext">triggerNamesTxt :: Text
</span><a href="#local-6989586621689794275"><span class="hs-identifier hs-var hs-var">triggerNamesTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;(&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TriggerName -&gt; Text) -&gt; [TriggerName] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621689794267"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794267"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794267"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689794281"><span class="hs-identifier hs-var">triggerNames</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span>    </span><span id="local-6989586621689794268"><span class="annot"><span class="annottext">uncurryEvent :: (ByteString, Text, Text, Text, ByteString, Int, ByteString)
-&gt; TxET QErr IO (Event 'MSSQL)
</span><a href="#local-6989586621689794268"><span class="hs-identifier hs-var hs-var">uncurryEvent</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689794266"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794266"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794265"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794265"><span class="hs-identifier hs-var">sn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794264"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794264"><span class="hs-identifier hs-var">tn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794263"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794263"><span class="hs-identifier hs-var">trn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794262"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794262"><span class="hs-identifier hs-var">payload'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794261"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689794261"><span class="hs-identifier hs-var">tries</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794260"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794260"><span class="hs-identifier hs-var">created_at</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>      </span><span id="local-6989586621689794259"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689794259"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; TxET QErr IO Value
forall a (m :: * -&gt; *). (FromJSON a, QErrM m) =&gt; ByteString -&gt; m a
</span><a href="#local-6989586621689794258"><span class="hs-identifier hs-var">encodePayload</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794262"><span class="hs-identifier hs-var">payload'</span></a></span><span>
</span><span id="line-437"></span><span>      </span><span id="local-6989586621689794257"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794257"><span class="hs-identifier hs-var">createdAt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; TxET QErr IO UTCTime
forall (m :: * -&gt; *). QErrM m =&gt; ByteString -&gt; m UTCTime
</span><a href="#local-6989586621689794256"><span class="hs-identifier hs-var">convertTime</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794260"><span class="hs-identifier hs-var">created_at</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span>      </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; TxET QErr IO (Event 'MSSQL)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Event 'MSSQL -&gt; TxET QErr IO (Event 'MSSQL))
-&gt; Event 'MSSQL -&gt; TxET QErr IO (Event 'MSSQL)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-440"></span><span>        </span><span class="annot"><span class="annottext">Event :: forall (b :: BackendType).
EventId
-&gt; SourceName
-&gt; TableName b
-&gt; TriggerMetadata
-&gt; Value
-&gt; Int
-&gt; UTCTime
-&gt; Event b
</span><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span>
</span><span id="line-441"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eId :: EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-var">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794266"><span class="hs-identifier hs-var">id'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-442"></span><span>            </span><span class="annot"><span class="annottext">eSource :: SourceName
</span><a href="Hasura.RQL.Types.EventTrigger.html#eSource"><span class="hs-identifier hs-var">eSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689794282"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-443"></span><span>            </span><span class="annot"><span class="annottext">eTable :: TableName 'MSSQL
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTable"><span class="hs-identifier hs-var">eTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; SchemaName -&gt; TableName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-var">TableName</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794264"><span class="hs-identifier hs-var">tn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; SchemaName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-var">SchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794265"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-444"></span><span>            </span><span class="annot"><span class="annottext">eTrigger :: TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerMetadata"><span class="hs-identifier hs-var">TriggerMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmptyText -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-var">TriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmptyText -&gt; TriggerName) -&gt; NonEmptyText -&gt; TriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; NonEmptyText
</span><a href="Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier hs-var">mkNonEmptyTextUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794263"><span class="hs-identifier hs-var">trn</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-445"></span><span>            </span><span class="annot"><span class="annottext">eEvent :: Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eEvent"><span class="hs-identifier hs-var">eEvent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689794259"><span class="hs-identifier hs-var">payload</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-446"></span><span>            </span><span class="annot"><span class="annottext">eTries :: Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTries"><span class="hs-identifier hs-var">eTries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689794261"><span class="hs-identifier hs-var">tries</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-447"></span><span>            </span><span class="annot"><span class="annottext">eCreatedAt :: UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eCreatedAt"><span class="hs-identifier hs-var">eCreatedAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794257"><span class="hs-identifier hs-var">createdAt</span></a></span><span>
</span><span id="line-448"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-comment">-- Note: We do not have JSON datatype in SQL Server. But since in</span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-comment">-- 'mkAllTriggersQ' we ensure that all the values in the payload column of</span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-comment">-- hdb_catalog.event_log is always a JSON. We can directly decode the payload</span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-comment">-- value and not worry that the decoding will fail.</span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-comment">-- We ensure that the values in 'hd_catalog.event_log' is always a JSON is by</span><span>
</span><span id="line-456"></span><span>    </span><span class="hs-comment">-- using the 'FOR JSON PATH' MSSQL operand when inserting value into the</span><span>
</span><span id="line-457"></span><span>    </span><span class="hs-comment">-- 'hdb_catalog.event_log' table.</span><span>
</span><span id="line-458"></span><span>    </span><span id="local-6989586621689794587"><span id="local-6989586621689794589"><span class="annot"><a href="#local-6989586621689794258"><span class="hs-identifier hs-type">encodePayload</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621689794589"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794587"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689794587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794589"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-459"></span><span>    </span><span id="local-6989586621689794258"><span class="annot"><span class="annottext">encodePayload :: ByteString -&gt; m a
</span><a href="#local-6989586621689794258"><span class="hs-identifier hs-var hs-var">encodePayload</span></a></span></span><span> </span><span id="local-6989586621689794247"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794247"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-460"></span><span>      </span><span class="annot"><span class="annottext">Either String a -&gt; (String -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onLeft</span></a></span><span>
</span><span id="line-461"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Either String a
forall a. FromJSON a =&gt; ByteString -&gt; Either String a
</span><span class="hs-identifier hs-var">J.eitherDecode</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794247"><span class="hs-identifier hs-var">payload</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m a
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m a) -&gt; Text -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;payload decode failed while fetching MSSQL events&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-comment">-- Note: The ODBC server does not have a FromJSON instance of UTCTime and only</span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-comment">-- supports DateTime2  and SmallDateTime. But the above two data types do not</span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-comment">-- have time offsets and 'Event' stores the time as UTCTime. But during</span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-comment">-- 'mkAllTriggersQ' we do save them as UTC Time format. So we can directly decode</span><span>
</span><span id="line-468"></span><span>    </span><span class="hs-comment">-- the time we get from the DB as UTCTime and not worry about exception being</span><span>
</span><span id="line-469"></span><span>    </span><span class="hs-comment">-- thrown during decoding.</span><span>
</span><span id="line-470"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-471"></span><span>    </span><span class="hs-comment">-- We ensure that the time stored in 'create_at' column is a UTCTime, by</span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-comment">-- defaulting the 'created_at' column to use 'SYSDATETIMEOFFSET()' MSSQL function</span><span>
</span><span id="line-473"></span><span>    </span><span class="hs-comment">-- in 'init_mssql_source.sql' file. The 'SYSDATETIMEOFFSET()' function returns</span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-comment">-- value that contains the date and time of the computer on which the instance of</span><span>
</span><span id="line-475"></span><span>    </span><span class="hs-comment">-- SQL Server is running. The time zone offset is included.</span><span>
</span><span id="line-476"></span><span>    </span><span id="local-6989586621689794586"><span class="annot"><a href="#local-6989586621689794256"><span class="hs-identifier hs-type">convertTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794586"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689794586"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span></span><span>
</span><span id="line-477"></span><span>    </span><span id="local-6989586621689794256"><span class="annot"><span class="annottext">convertTime :: ByteString -&gt; m UTCTime
</span><a href="#local-6989586621689794256"><span class="hs-identifier hs-var hs-var">convertTime</span></a></span></span><span> </span><span id="local-6989586621689794243"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794243"><span class="hs-identifier hs-var">createdAt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-478"></span><span>      </span><span class="annot"><span class="annottext">Either String UTCTime -&gt; (String -&gt; m UTCTime) -&gt; m UTCTime
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onLeft</span></a></span><span>
</span><span id="line-479"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Either String UTCTime
forall a. Read a =&gt; String -&gt; Either String a
</span><span class="hs-identifier hs-var">readEither</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; Text -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689794243"><span class="hs-identifier hs-var">createdAt</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m UTCTime
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m UTCTime) -&gt; Text -&gt; m UTCTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;conversion to UTCTime failed while fetching MSSQL events&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier hs-type">dropTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span id="dropTriggerQ"><span class="annot"><span class="annottext">dropTriggerQ :: TriggerName -&gt; SchemaName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier hs-var hs-var">dropTriggerQ</span></a></span></span><span> </span><span id="local-6989586621689794240"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794240"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794239"><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689794239"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-484"></span><span>  </span><span class="annot"><span class="annottext">(Ops -&gt; TxET QErr IO ()) -&gt; [Ops] -&gt; TxET QErr IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SchemaName -&gt; Ops -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-var">dropTriggerOp</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794240"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689794239"><span class="hs-identifier hs-var">schemaName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-485"></span><span>
</span><span id="line-486"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-type">dropTriggerOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span id="dropTriggerOp"><span class="annot"><span class="annottext">dropTriggerOp :: TriggerName -&gt; SchemaName -&gt; Ops -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-var hs-var">dropTriggerOp</span></a></span></span><span> </span><span id="local-6989586621689794237"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794237"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794236"><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689794236"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span> </span><span id="local-6989586621689794235"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794235"><span class="hs-identifier hs-var">triggerOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-488"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
</span><a href="#local-6989586621689794234"><span class="hs-identifier hs-var">getDropTriggerSQL</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794235"><span class="hs-identifier hs-var">triggerOp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-491"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-492"></span><span>    </span><span class="annot"><a href="#local-6989586621689794234"><span class="hs-identifier hs-type">getDropTriggerSQL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-493"></span><span>    </span><span id="local-6989586621689794234"><span class="annot"><span class="annottext">getDropTriggerSQL :: Ops -&gt; Text
</span><a href="#local-6989586621689794234"><span class="hs-identifier hs-var hs-var">getDropTriggerSQL</span></a></span></span><span> </span><span id="local-6989586621689794233"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794233"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-494"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DROP TRIGGER IF EXISTS &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unQualifiedTriggerName"><span class="hs-identifier hs-var hs-var">unQualifiedTriggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SchemaName -&gt; TriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-var">msssqlIdenTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794233"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689794236"><span class="hs-identifier hs-var">schemaName</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794237"><span class="hs-identifier hs-var">triggerName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#archiveEvents"><span class="hs-identifier hs-type">archiveEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span id="archiveEvents"><span class="annot"><span class="annottext">archiveEvents :: TriggerName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#archiveEvents"><span class="hs-identifier hs-var hs-var">archiveEvents</span></a></span></span><span> </span><span id="local-6989586621689794230"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794230"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-498"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-499"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-500"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      UPDATE hdb_catalog.event_log
      SET archived = 1
      WHERE trigger_name = $triggerNameTxt
    |]</span></span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-506"></span><span>    </span><span id="local-6989586621689794229"><span class="annot"><span class="annottext">triggerNameTxt :: Text
</span><a href="#local-6989586621689794229"><span class="hs-identifier hs-var hs-var">triggerNameTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794230"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkEventTx"><span class="hs-identifier hs-type">checkEventTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span id="checkEventTx"><span class="annot"><span class="annottext">checkEventTx :: EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkEventTx"><span class="hs-identifier hs-var hs-var">checkEventTx</span></a></span></span><span> </span><span id="local-6989586621689794228"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689794228"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-510"></span><span>  </span><span class="hs-comment">-- If an event got locked within the last 30 minutes then it means that the event</span><span>
</span><span id="line-511"></span><span>  </span><span class="hs-comment">-- got picked up by during the last fetch-event poll and is being processed. Hence</span><span>
</span><span id="line-512"></span><span>  </span><span class="hs-comment">-- we do not allow the redelivery of such an event.</span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621689794227"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621689794227"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-514"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Bool]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-515"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-516"></span><span>      </span><span class="annot"><span class="">[ODBC.sql|
        SELECT
          CAST(CASE 
                  WHEN (l.locked IS NOT NULL AND l.locked &gt;= DATEADD(MINUTE, -30, SYSDATETIMEOFFSET())) THEN 1 ELSE 0
              END 
          AS bit)
        FROM hdb_catalog.event_log l
        WHERE l.id = $eId
      |]</span></span><span>
</span><span id="line-525"></span><span>
</span><span id="line-526"></span><span>  </span><span id="local-6989586621689794225"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689794225"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; TxE QErr Bool
forall (m :: * -&gt; *) a. MonadError QErr m =&gt; [a] -&gt; m a
</span><a href="#local-6989586621689794224"><span class="hs-identifier hs-var">getEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621689794227"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-527"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr IO ()
forall (f :: * -&gt; *). MonadError QErr f =&gt; Bool -&gt; f ()
</span><a href="#local-6989586621689794223"><span class="hs-identifier hs-var">assertEventUnlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689794225"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-528"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-529"></span><span>    </span><span id="local-6989586621689794226"><span class="annot"><span class="annottext">eId :: Text
</span><a href="#local-6989586621689794226"><span class="hs-identifier hs-var hs-var">eId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689794228"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-530"></span><span>
</span><span id="line-531"></span><span>    </span><span id="local-6989586621689794224"><span class="annot"><span class="annottext">getEvent :: [a] -&gt; m a
</span><a href="#local-6989586621689794224"><span class="hs-identifier hs-var hs-var">getEvent</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m a
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotExists"><span class="hs-identifier hs-var">NotExists</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event not found&quot;</span></span><span>
</span><span id="line-532"></span><span>    </span><span class="annot"><a href="#local-6989586621689794224"><span class="hs-identifier hs-var">getEvent</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689794220"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689794220"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689794220"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span>    </span><span id="local-6989586621689794223"><span class="annot"><span class="annottext">assertEventUnlocked :: Bool -&gt; f ()
</span><a href="#local-6989586621689794223"><span class="hs-identifier hs-var hs-var">assertEventUnlocked</span></a></span></span><span> </span><span id="local-6989586621689794219"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689794219"><span class="hs-identifier hs-var">locked</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-535"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; f () -&gt; f ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689794219"><span class="hs-identifier hs-var">locked</span></a></span><span> </span><span class="annot"><span class="annottext">(f () -&gt; f ()) -&gt; f () -&gt; f ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-536"></span><span>        </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; f ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#Busy"><span class="hs-identifier hs-var">Busy</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event is already being processed&quot;</span></span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markForDeliveryTx"><span class="hs-identifier hs-type">markForDeliveryTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span id="markForDeliveryTx"><span class="annot"><span class="annottext">markForDeliveryTx :: EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markForDeliveryTx"><span class="hs-identifier hs-var hs-var">markForDeliveryTx</span></a></span></span><span> </span><span id="local-6989586621689794216"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689794216"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-540"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-541"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-542"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      UPDATE hdb_catalog.event_log
      SET delivered = 0, error = 0, tries = 0
      WHERE id = $eId
    |]</span></span><span>
</span><span id="line-547"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-548"></span><span>    </span><span id="local-6989586621689794215"><span class="annot"><span class="annottext">eId :: Text
</span><a href="#local-6989586621689794215"><span class="hs-identifier hs-var hs-var">eId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689794216"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsTx"><span class="hs-identifier hs-type">unlockEventsTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-551"></span><span id="unlockEventsTx"><span class="annot"><span class="annottext">unlockEventsTx :: [EventId] -&gt; TxET QErr IO Int
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsTx"><span class="hs-identifier hs-var hs-var">unlockEventsTx</span></a></span></span><span> </span><span id="local-6989586621689794214"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689794214"><span class="hs-identifier hs-var">eventIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-552"></span><span>  </span><span id="local-6989586621689794213"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689794213"><span class="hs-identifier hs-var">numEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-553"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO Int
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO Int) -&gt; Query -&gt; TxET QErr IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-554"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-555"></span><span>        </span><span class="hs-comment">-- EventIds as list of VALUES (Eg: ('123-abc'), ('456-vgh'), ('234-asd'))</span><span>
</span><span id="line-556"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794212"><span class="annot"><span class="annottext">eventIdsValues :: Text
</span><a href="#local-6989586621689794212"><span class="hs-identifier hs-var hs-var">eventIdsValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EventId] -&gt; Text
</span><a href="#local-6989586621689794211"><span class="hs-identifier hs-var">generateValuesFromEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689794214"><span class="hs-identifier hs-var">eventIds</span></a></span><span>
</span><span id="line-557"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_unlock_events.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-558"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; TxET QErr IO Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689794213"><span class="hs-identifier hs-var">numEvents</span></a></span><span>
</span><span id="line-559"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-560"></span><span>    </span><span class="annot"><a href="#local-6989586621689794211"><span class="hs-identifier hs-type">generateValuesFromEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-561"></span><span>    </span><span class="hs-comment">-- creates a list of event id's  (('123-abc'), ('456-vgh'), ('234-asd'))</span><span>
</span><span id="line-562"></span><span>    </span><span id="local-6989586621689794211"><span class="annot"><span class="annottext">generateValuesFromEvents :: [EventId] -&gt; Text
</span><a href="#local-6989586621689794211"><span class="hs-identifier hs-var hs-var">generateValuesFromEvents</span></a></span></span><span> </span><span id="local-6989586621689794210"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689794210"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794209"><span class="hs-identifier hs-var">values</span></a></span><span>
</span><span id="line-563"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-564"></span><span>        </span><span id="local-6989586621689794209"><span class="annot"><span class="annottext">values :: [Text]
</span><a href="#local-6989586621689794209"><span class="hs-identifier hs-var hs-var">values</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; [EventId] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621689794208"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689794208"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;(&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689794208"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;)&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689794210"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersionTx"><span class="hs-identifier hs-type">getMaintenanceModeVersionTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span>
</span><span id="line-567"></span><span id="getMaintenanceModeVersionTx"><span class="annot"><span class="annottext">getMaintenanceModeVersionTx :: TxET QErr IO MaintenanceModeVersion
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersionTx"><span class="hs-identifier hs-var hs-var">getMaintenanceModeVersionTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-568"></span><span>  </span><span id="local-6989586621689794207"><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="#local-6989586621689794207"><span class="hs-identifier hs-var">catalogVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO SourceCatalogVersion
forall (m :: * -&gt; *). MonadMSSQLTx m =&gt; m SourceCatalogVersion
</span><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html#getSourceCatalogVersion"><span class="hs-identifier hs-var">getSourceCatalogVersion</span></a></span><span>
</span><span id="line-569"></span><span>  </span><span class="hs-keyword">if</span><span>
</span><span id="line-570"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="#local-6989586621689794207"><span class="hs-identifier hs-var">catalogVersion</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion -&gt; SourceCatalogVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html#latestSourceCatalogVersion"><span class="hs-identifier hs-var">latestSourceCatalogVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion -&gt; TxET QErr IO MaintenanceModeVersion
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span>
</span><span id="line-571"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-572"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO MaintenanceModeVersion
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; TxET QErr IO MaintenanceModeVersion)
-&gt; Text -&gt; TxET QErr IO MaintenanceModeVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-573"></span><span>          </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Maintenance mode is only supported with catalog versions: &quot;</span></span><span>
</span><span id="line-574"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html#latestSourceCatalogVersion"><span class="hs-identifier hs-var">latestSourceCatalogVersion</span></a></span><span>
</span><span id="line-575"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; but received &quot;</span></span><span>
</span><span id="line-576"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="#local-6989586621689794207"><span class="hs-identifier hs-var">catalogVersion</span></a></span><span>
</span><span id="line-577"></span><span>
</span><span id="line-578"></span><span class="hs-comment">-- | Note: UTCTIME not supported in SQL Server</span><span>
</span><span id="line-579"></span><span class="hs-comment">--</span><span>
</span><span id="line-580"></span><span class="hs-comment">-- Refer 'ToSql UTCTIME' instance of odbc package:</span><span>
</span><span id="line-581"></span><span class="hs-comment">-- https://github.com/fpco/odbc/blob/f4f04ea15d14e9a3ed455f7c728dc08734eef8ae/src/Database/ODBC/SQLServer.hs#L377</span><span>
</span><span id="line-582"></span><span class="hs-comment">--</span><span>
</span><span id="line-583"></span><span class="hs-comment">-- We use SYSDATETIMEOFFSET() to store time values along with it's time</span><span>
</span><span id="line-584"></span><span class="hs-comment">-- zone offset in event_log table. Since ODBC server does not support time zones,</span><span>
</span><span id="line-585"></span><span class="hs-comment">-- we use a workaround.</span><span>
</span><span id="line-586"></span><span class="hs-comment">--</span><span>
</span><span id="line-587"></span><span class="hs-comment">-- We wrap the time value in Datetime2, but before we insert it into the</span><span>
</span><span id="line-588"></span><span class="hs-comment">-- event_log table we convert it into UTCTIME using the 'TODATETIMEOFFSET()'</span><span>
</span><span id="line-589"></span><span class="hs-comment">-- sql function.</span><span>
</span><span id="line-590"></span><span id="local-6989586621689794606"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#convertUTCToDatetime2"><span class="hs-identifier hs-type">convertUTCToDatetime2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794606"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689794606"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Datetime2</span></span></span><span>
</span><span id="line-591"></span><span id="convertUTCToDatetime2"><span class="annot"><span class="annottext">convertUTCToDatetime2 :: UTCTime -&gt; m Datetime2
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#convertUTCToDatetime2"><span class="hs-identifier hs-var hs-var">convertUTCToDatetime2</span></a></span></span><span> </span><span id="local-6989586621689794204"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794204"><span class="hs-identifier hs-var">utcTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-592"></span><span>  </span><span id="local-6989586621689794203"><span class="annot"><span class="annottext">TimeZone
</span><a href="#local-6989586621689794203"><span class="hs-identifier hs-var">timezone</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TimeZone -&gt; m TimeZone
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO TimeZone -&gt; m TimeZone) -&gt; IO TimeZone -&gt; m TimeZone
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; IO TimeZone
</span><span class="hs-identifier hs-var">getTimeZone</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794204"><span class="hs-identifier hs-var">utcTime</span></a></span><span>
</span><span id="line-593"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794201"><span class="annot"><span class="annottext">localTime :: LocalTime
</span><a href="#local-6989586621689794201"><span class="hs-identifier hs-var hs-var">localTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeZone -&gt; UTCTime -&gt; LocalTime
</span><span class="hs-identifier hs-var">utcToLocalTime</span></span><span> </span><span class="annot"><span class="annottext">TimeZone
</span><a href="#local-6989586621689794203"><span class="hs-identifier hs-var">timezone</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794204"><span class="hs-identifier hs-var">utcTime</span></a></span><span>
</span><span id="line-594"></span><span>  </span><span class="annot"><span class="annottext">Datetime2 -&gt; m Datetime2
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Datetime2 -&gt; m Datetime2) -&gt; Datetime2 -&gt; m Datetime2
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LocalTime -&gt; Datetime2
</span><span class="hs-identifier hs-var">Datetime2</span></span><span> </span><span class="annot"><span class="annottext">LocalTime
</span><a href="#local-6989586621689794201"><span class="hs-identifier hs-var">localTime</span></a></span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExistsQ"><span class="hs-identifier hs-type">checkIfTriggerExistsQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-597"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-598"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-599"></span><span>  </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-600"></span><span id="checkIfTriggerExistsQ"><span class="annot"><span class="annottext">checkIfTriggerExistsQ :: TriggerName -&gt; Ops -&gt; TxE QErr Bool
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExistsQ"><span class="hs-identifier hs-var hs-var">checkIfTriggerExistsQ</span></a></span></span><span> </span><span id="local-6989586621689794198"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794198"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794197"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794197"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-601"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794196"><span class="annot"><span class="annottext">triggerNameWithOp :: Text
</span><a href="#local-6989586621689794196"><span class="hs-identifier hs-var hs-var">triggerNameWithOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;notify_hasura_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794198"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794197"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-602"></span><span>  </span><span class="annot"><span class="annottext">TxE QErr Bool -&gt; TxE QErr Bool
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr Bool -&gt; TxE QErr Bool) -&gt; TxE QErr Bool -&gt; TxE QErr Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-603"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxE QErr Bool
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span>
</span><span id="line-604"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-605"></span><span>      </span><span class="hs-comment">-- We check the existence of trigger across the entire database irrespective of</span><span>
</span><span id="line-606"></span><span>      </span><span class="hs-comment">-- the schema of the table</span><span>
</span><span id="line-607"></span><span>      </span><span class="annot"><span class="">[ODBC.sql|
          SELECT CASE WHEN EXISTS
            ( SELECT 1
              FROM sys.triggers WHERE name = $triggerNameWithOp
            )
          THEN CAST(1 AS BIT)
          ELSE CAST(0 AS BIT)
          END;
        |]</span></span><span>
</span><span id="line-616"></span><span>
</span><span id="line-617"></span><span class="hs-comment">---- MSSQL event trigger utility functions -----------------</span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span class="hs-keyword">newtype</span><span> </span><span id="QualifiedTriggerName"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="QualifiedTriggerName"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unQualifiedTriggerName"><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unQualifiedTriggerName"><span class="hs-identifier hs-var hs-var">unQualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">}</span><span>
</span><span id="line-620"></span><span>
</span><span id="line-621"></span><span class="hs-comment">-- | Store a fragment of SQL expression</span><span>
</span><span id="line-622"></span><span class="hs-keyword">newtype</span><span> </span><span id="SQLFragment"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SQLFragment"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unSQLFragment"><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">}</span><span>
</span><span id="line-623"></span><span>
</span><span id="line-624"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-type">msssqlIdenTrigger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span>
</span><span id="line-625"></span><span id="msssqlIdenTrigger"><span class="annot"><span class="annottext">msssqlIdenTrigger :: Ops -&gt; SchemaName -&gt; TriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-var hs-var">msssqlIdenTrigger</span></a></span></span><span> </span><span id="local-6989586621689794192"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794192"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689794191"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794191"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689794190"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794190"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-626"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; QualifiedTriggerName) -&gt; Text -&gt; QualifiedTriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text -&gt; Text
</span><a href="#local-6989586621689794189"><span class="hs-identifier hs-var">qualifyHasuraTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794192"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794190"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-627"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-628"></span><span>    </span><span id="local-6989586621689794189"><span class="annot"><span class="annottext">qualifyHasuraTriggerName :: Ops -&gt; Text -&gt; Text
</span><a href="#local-6989586621689794189"><span class="hs-identifier hs-var hs-var">qualifyHasuraTriggerName</span></a></span></span><span> </span><span id="local-6989586621689794188"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794188"><span class="hs-identifier hs-var">op'</span></a></span></span><span> </span><span id="local-6989586621689794187"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794187"><span class="hs-identifier hs-var">triggerName'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794191"><span class="hs-identifier hs-var">schemaName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;notify_hasura_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794187"><span class="hs-identifier hs-var">triggerName'</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689794188"><span class="hs-identifier hs-var">op'</span></a></span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span id="local-6989586621689794664"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-type">mkAllTriggersQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-631"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794664"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-632"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-633"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-634"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-635"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerOpsDef"><span class="hs-identifier hs-type">TriggerOpsDef</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-636"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-637"></span><span>  </span><span class="annot"><a href="#local-6989586621689794664"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-638"></span><span id="mkAllTriggersQ"><span class="annot"><span class="annottext">mkAllTriggersQ :: TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-var hs-var">mkAllTriggersQ</span></a></span></span><span> </span><span id="local-6989586621689794186"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794186"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794185"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794185"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621689794184"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794184"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621689794183"><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689794183"><span class="hs-identifier hs-var">fullSpec</span></a></span></span><span> </span><span id="local-6989586621689794182"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689794182"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-639"></span><span>  </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdInsert"><span class="hs-identifier hs-var hs-var">tdInsert</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689794183"><span class="hs-identifier hs-var">fullSpec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-var">mkInsertTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794186"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794185"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794184"><span class="hs-identifier hs-var">allCols</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span>  </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdDelete"><span class="hs-identifier hs-var hs-var">tdDelete</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689794183"><span class="hs-identifier hs-var">fullSpec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-var">mkDeleteTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794186"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794185"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794184"><span class="hs-identifier hs-var">allCols</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-641"></span><span>  </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdUpdate"><span class="hs-identifier hs-var hs-var">tdUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689794183"><span class="hs-identifier hs-var">fullSpec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-var">mkUpdateTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794186"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794185"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794184"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689794182"><span class="hs-identifier hs-var">primaryKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-type">getApplicableColumns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeColumns"><span class="hs-identifier hs-type">SubscribeColumns</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-644"></span><span id="getApplicableColumns"><span class="annot"><span class="annottext">getApplicableColumns :: [ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var hs-var">getApplicableColumns</span></a></span></span><span> </span><span id="local-6989586621689794180"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794180"><span class="hs-identifier hs-var">allColumnInfos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-645"></span><span>  </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794180"><span class="hs-identifier hs-var">allColumnInfos</span></a></span><span>
</span><span id="line-646"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubCArray"><span class="hs-identifier hs-type">SubCArray</span></a></span><span> </span><span id="local-6989586621689794177"><span class="annot"><span class="annottext">[Column 'MSSQL]
</span><a href="#local-6989586621689794177"><span class="hs-identifier hs-var">cols</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Column 'MSSQL] -&gt; [ColumnInfo 'MSSQL] -&gt; [ColumnInfo 'MSSQL]
forall (b :: BackendType).
Backend b =&gt;
[Column b] -&gt; [ColumnInfo b] -&gt; [ColumnInfo b]
</span><a href="Hasura.RQL.Types.Column.html#getColInfos"><span class="hs-identifier hs-var">getColInfos</span></a></span><span> </span><span class="annot"><span class="annottext">[Column 'MSSQL]
</span><a href="#local-6989586621689794177"><span class="hs-identifier hs-var">cols</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794180"><span class="hs-identifier hs-var">allColumnInfos</span></a></span><span>
</span><span id="line-647"></span><span>
</span><span id="line-648"></span><span class="hs-comment">-- | Currently we do not support Event Triggers on columns of Spatial data types.</span><span>
</span><span id="line-649"></span><span class="hs-comment">-- We do this because, currently the graphQL API for these types is broken</span><span>
</span><span id="line-650"></span><span class="hs-comment">-- for MSSQL sources. Ref: https://github.com/hasura/graphql-engine-mono/issues/787</span><span>
</span><span id="line-651"></span><span id="local-6989586621689794540"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-type">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-652"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794540"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-653"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-654"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-655"></span><span>  </span><span class="annot"><a href="#local-6989586621689794540"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-656"></span><span id="checkSpatialDataTypeColumns"><span class="annot"><span class="annottext">checkSpatialDataTypeColumns :: [ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var hs-var">checkSpatialDataTypeColumns</span></a></span></span><span> </span><span id="local-6989586621689794174"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794174"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621689794172"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689794172"><span class="hs-identifier hs-var">listenCols</span></a></span></span><span> </span><span id="local-6989586621689794171"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689794171"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-657"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794170"><span class="annot"><span class="annottext">listenColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794170"><span class="hs-identifier hs-var hs-var">listenColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794174"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689794172"><span class="hs-identifier hs-var">listenCols</span></a></span><span>
</span><span id="line-658"></span><span>      </span><span id="local-6989586621689794169"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794169"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794174"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689794171"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-659"></span><span>      </span><span id="local-6989586621689794167"><span class="annot"><span class="annottext">isGeoTypesInListenCols :: Bool
</span><a href="#local-6989586621689794167"><span class="hs-identifier hs-var hs-var">isGeoTypesInListenCols</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Bool) -&gt; [ColumnInfo 'MSSQL] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ScalarType 'MSSQL -&gt; Bool) -&gt; ColumnType 'MSSQL -&gt; Bool
forall (b :: BackendType).
(ScalarType b -&gt; Bool) -&gt; ColumnType b -&gt; Bool
</span><a href="Hasura.RQL.Types.Column.html#isScalarColumnWhere"><span class="hs-identifier hs-var">isScalarColumnWhere</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarType 'MSSQL -&gt; Bool
ScalarType -&gt; Bool
</span><a href="#local-6989586621689794164"><span class="hs-identifier hs-var">isGeoType</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnType 'MSSQL -&gt; Bool)
-&gt; (ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL)
-&gt; ColumnInfo 'MSSQL
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; ColumnType b
</span><a href="Hasura.RQL.Types.Column.html#ciType"><span class="hs-identifier hs-var hs-var">ciType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794170"><span class="hs-identifier hs-var">listenColumns</span></a></span><span>
</span><span id="line-660"></span><span>      </span><span id="local-6989586621689794162"><span class="annot"><span class="annottext">isGeoTypesInDeliversCols :: Bool
</span><a href="#local-6989586621689794162"><span class="hs-identifier hs-var hs-var">isGeoTypesInDeliversCols</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Bool) -&gt; [ColumnInfo 'MSSQL] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ScalarType 'MSSQL -&gt; Bool) -&gt; ColumnType 'MSSQL -&gt; Bool
forall (b :: BackendType).
(ScalarType b -&gt; Bool) -&gt; ColumnType b -&gt; Bool
</span><a href="Hasura.RQL.Types.Column.html#isScalarColumnWhere"><span class="hs-identifier hs-var">isScalarColumnWhere</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarType 'MSSQL -&gt; Bool
ScalarType -&gt; Bool
</span><a href="#local-6989586621689794164"><span class="hs-identifier hs-var">isGeoType</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnType 'MSSQL -&gt; Bool)
-&gt; (ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL)
-&gt; ColumnInfo 'MSSQL
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; ColumnType b
</span><a href="Hasura.RQL.Types.Column.html#ciType"><span class="hs-identifier hs-var hs-var">ciType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794169"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-661"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689794167"><span class="hs-identifier hs-var">isGeoTypesInListenCols</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689794162"><span class="hs-identifier hs-var">isGeoTypesInDeliversCols</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-662"></span><span>    </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Event triggers for MS-SQL sources are not supported on tables having Geometry or Geography column types&quot;</span></span><span>
</span><span id="line-663"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-664"></span><span>    </span><span id="local-6989586621689794164"><span class="annot"><span class="annottext">isGeoType :: ScalarType -&gt; Bool
</span><a href="#local-6989586621689794164"><span class="hs-identifier hs-var hs-var">isGeoType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScalarType -&gt; [ScalarType] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[ScalarType]
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#geoTypes"><span class="hs-identifier hs-var">geoTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span id="local-6989586621689794646"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-type">mkInsertTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-667"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794646"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-668"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-669"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-670"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-671"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-672"></span><span>  </span><span class="annot"><a href="#local-6989586621689794646"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-673"></span><span id="mkInsertTriggerQ"><span class="annot"><span class="annottext">mkInsertTriggerQ :: TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-var hs-var">mkInsertTriggerQ</span></a></span></span><span> </span><span id="local-6989586621689794158"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794158"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794157"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794157"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621689794156"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794156"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621689794155"><span class="annot"><span class="annottext">subOpSpec :: SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689794155"><span class="hs-identifier hs-var">subOpSpec</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621689794154"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689794154"><span class="hs-identifier hs-var">_listenCols</span></a></span></span><span> </span><span id="local-6989586621689794153"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689794153"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-674"></span><span>  </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794156"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689794155"><span class="hs-identifier hs-var">subOpSpec</span></a></span><span>
</span><span id="line-675"></span><span>  </span><span class="annot"><span class="annottext">TxET QErr IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; m ()) -&gt; TxET QErr IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-676"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-677"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-678"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794152"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794152"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794156"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689794153"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-679"></span><span>        </span><span class="annot"><span class="annottext">TableName -&gt; TriggerName -&gt; [ColumnInfo 'MSSQL] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQuery"><span class="hs-identifier hs-var">mkInsertTriggerQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794157"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794158"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794152"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span id="local-6989586621689794150"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-type">mkDeleteTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-682"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794150"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-683"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-684"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-685"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-686"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-687"></span><span>  </span><span class="annot"><a href="#local-6989586621689794150"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-688"></span><span id="mkDeleteTriggerQ"><span class="annot"><span class="annottext">mkDeleteTriggerQ :: TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-var hs-var">mkDeleteTriggerQ</span></a></span></span><span> </span><span id="local-6989586621689794149"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794149"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794148"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794148"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621689794147"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794147"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621689794146"><span class="annot"><span class="annottext">subOpSpec :: SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689794146"><span class="hs-identifier hs-var">subOpSpec</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621689794145"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689794145"><span class="hs-identifier hs-var">_listenCols</span></a></span></span><span> </span><span id="local-6989586621689794144"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689794144"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-689"></span><span>  </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794147"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689794146"><span class="hs-identifier hs-var">subOpSpec</span></a></span><span>
</span><span id="line-690"></span><span>  </span><span class="annot"><span class="annottext">TxET QErr IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; m ()) -&gt; TxET QErr IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-691"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-692"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-693"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794143"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794143"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794147"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689794144"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-694"></span><span>        </span><span class="annot"><span class="annottext">TableName -&gt; TriggerName -&gt; [ColumnInfo 'MSSQL] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQuery"><span class="hs-identifier hs-var">mkDeleteTriggerQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794148"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794149"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794143"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span id="local-6989586621689794645"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-type">mkUpdateTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-697"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794645"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-698"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-699"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-700"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-701"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-702"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-703"></span><span>  </span><span class="annot"><a href="#local-6989586621689794645"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-704"></span><span id="mkUpdateTriggerQ"><span class="annot"><span class="annottext">mkUpdateTriggerQ :: TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-var hs-var">mkUpdateTriggerQ</span></a></span></span><span> </span><span id="local-6989586621689794141"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794141"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794140"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794140"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621689794139"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794139"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621689794138"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689794138"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span></span><span> </span><span id="local-6989586621689794137"><span class="annot"><span class="annottext">subOpSpec :: SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689794137"><span class="hs-identifier hs-var">subOpSpec</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621689794136"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689794136"><span class="hs-identifier hs-var">listenCols</span></a></span></span><span> </span><span id="local-6989586621689794135"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689794135"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-705"></span><span>  </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794139"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689794137"><span class="hs-identifier hs-var">subOpSpec</span></a></span><span>
</span><span id="line-706"></span><span>  </span><span class="annot"><span class="annottext">TxET QErr IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; m ()) -&gt; TxET QErr IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-707"></span><span>    </span><span id="local-6989586621689794134"><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689794134"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; TxET QErr IO (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; TxET QErr IO (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689794138"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
-&gt; Text -&gt; TxET QErr IO (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Update event triggers for MS-SQL sources are only supported on tables with primary keys&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-708"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794132"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794132"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794139"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689794135"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-709"></span><span>        </span><span id="local-6989586621689794131"><span class="annot"><span class="annottext">listenColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794131"><span class="hs-identifier hs-var hs-var">listenColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794139"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689794136"><span class="hs-identifier hs-var">listenCols</span></a></span><span>
</span><span id="line-710"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-711"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-712"></span><span>        </span><span class="annot"><span class="annottext">TableName
-&gt; TriggerName
-&gt; [ColumnInfo 'MSSQL]
-&gt; [ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
-&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQuery"><span class="hs-identifier hs-var">mkUpdateTriggerQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794140"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794141"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794131"><span class="hs-identifier hs-var">listenColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794132"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689794134"><span class="hs-identifier hs-var">primaryKey</span></a></span><span>
</span><span id="line-713"></span><span>
</span><span id="line-714"></span><span class="hs-comment">-- Create alias for columns</span><span>
</span><span id="line-715"></span><span class="hs-comment">-- eg: If colPrefixMaybe is defined then 'inserted.id as payload.data.old.id'</span><span>
</span><span id="line-716"></span><span class="hs-comment">--     else 'id as payload.data.old.id'</span><span>
</span><span id="line-717"></span><span class="hs-comment">-- We create such an alias for the columns of the table because it helps in</span><span>
</span><span id="line-718"></span><span class="hs-comment">-- structuring the JSON payload.</span><span>
</span><span id="line-719"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-type">generateColumnTriggerAlias</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#OpVar"><span class="hs-identifier hs-type">OpVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-720"></span><span id="generateColumnTriggerAlias"><span class="annot"><span class="annottext">generateColumnTriggerAlias :: OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var hs-var">generateColumnTriggerAlias</span></a></span></span><span> </span><span id="local-6989586621689794128"><span class="annot"><span class="annottext">OpVar
</span><a href="#local-6989586621689794128"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621689794127"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621689794127"><span class="hs-identifier hs-var">colPrefixMaybe</span></a></span></span><span> </span><span id="local-6989586621689794126"><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689794126"><span class="hs-identifier hs-var">colInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-721"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794125"><span class="annot"><span class="annottext">opText :: Text
</span><a href="#local-6989586621689794125"><span class="hs-identifier hs-var hs-var">opText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-722"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="#local-6989586621689794128"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-723"></span><span>          </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#OLD"><span class="hs-identifier hs-var">OLD</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;old&quot;</span></span><span>
</span><span id="line-724"></span><span>          </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;new&quot;</span></span><span>
</span><span id="line-725"></span><span>      </span><span class="hs-comment">-- Let's say we have a column 'id', dbColNameText returns the column name as</span><span>
</span><span id="line-726"></span><span>      </span><span class="hs-comment">-- text. i.e 'id'</span><span>
</span><span id="line-727"></span><span>      </span><span id="local-6989586621689794122"><span class="annot"><span class="annottext">dbColNameText :: Text
</span><a href="#local-6989586621689794122"><span class="hs-identifier hs-var hs-var">dbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ColumnName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier hs-var hs-var">columnNameText</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnName -&gt; Text) -&gt; ColumnName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Column 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; Column b
</span><a href="Hasura.RQL.Types.Column.html#ciColumn"><span class="hs-identifier hs-var hs-var">ciColumn</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689794126"><span class="hs-identifier hs-var">colInfo</span></a></span><span>
</span><span id="line-728"></span><span>      </span><span id="local-6989586621689794120"><span class="annot"><span class="annottext">joinPrefixedDbColNameText :: Text
</span><a href="#local-6989586621689794120"><span class="hs-identifier hs-var hs-var">joinPrefixedDbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-729"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621689794127"><span class="hs-identifier hs-var">colPrefixMaybe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-730"></span><span>          </span><span class="hs-comment">-- prefix with the joining table's name</span><span>
</span><span id="line-731"></span><span>          </span><span class="hs-comment">-- `id` -&gt; `inserted.id` (prefix = 'inserted')</span><span>
</span><span id="line-732"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621689794119"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794119"><span class="hs-identifier hs-var">colPrefix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794119"><span class="hs-identifier hs-var">colPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794122"><span class="hs-identifier hs-var">dbColNameText</span></a></span><span>
</span><span id="line-733"></span><span>          </span><span class="hs-comment">-- do not prefix anthing to the column name</span><span>
</span><span id="line-734"></span><span>          </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794122"><span class="hs-identifier hs-var">dbColNameText</span></a></span><span>
</span><span id="line-735"></span><span>      </span><span class="hs-comment">-- create the alias for the column</span><span>
</span><span id="line-736"></span><span>      </span><span class="hs-comment">-- `payload.data.old.id` (opText = old) (dbColNameText = id)</span><span>
</span><span id="line-737"></span><span>      </span><span id="local-6989586621689794118"><span class="annot"><span class="annottext">dbColAlias :: Text
</span><a href="#local-6989586621689794118"><span class="hs-identifier hs-var hs-var">dbColAlias</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;payload.data&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794125"><span class="hs-identifier hs-var">opText</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794122"><span class="hs-identifier hs-var">dbColNameText</span></a></span><span>
</span><span id="line-738"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- create the SQL alias using the `as` keyword</span><span>
</span><span id="line-739"></span><span>      </span><span class="hs-comment">-- If colPrefixMaybe existed then alias will be `inserted.id as payload.data.old.id`</span><span>
</span><span id="line-740"></span><span>      </span><span class="hs-comment">-- If no colPrefixMaybe was Nothing then alias will be 'id as payload.data.old.id`</span><span>
</span><span id="line-741"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.stext| #{joinPrefixedDbColNameText} as [#{dbColAlias}]|]</span></span><span>
</span><span id="line-742"></span><span>
</span><span id="line-743"></span><span class="hs-comment">-- Converts tables name to the format [SCHEMA].[TABLENAME]</span><span>
</span><span id="line-744"></span><span class="hs-comment">-- eg: [dbo].[author], [hge].[books]</span><span>
</span><span id="line-745"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-type">qualifyTableName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-746"></span><span id="qualifyTableName"><span class="annot"><span class="annottext">qualifyTableName :: TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var hs-var">qualifyTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Query -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; Text) -&gt; (TableName -&gt; Query) -&gt; TableName -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Printer -&gt; Query
</span><a href="Hasura.Backends.MSSQL.ToQuery.html#toQueryFlat"><span class="hs-identifier hs-var">toQueryFlat</span></a></span><span> </span><span class="annot"><span class="annottext">(Printer -&gt; Query) -&gt; (TableName -&gt; Printer) -&gt; TableName -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Printer
</span><a href="Hasura.Backends.MSSQL.ToQuery.html#fromTableName"><span class="hs-identifier hs-var">fromTableName</span></a></span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQuery"><span class="hs-identifier hs-type">mkInsertTriggerQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LT.Text</span></span><span>
</span><span id="line-749"></span><span id="mkInsertTriggerQuery"><span class="annot"><span class="annottext">mkInsertTriggerQuery :: TableName -&gt; TriggerName -&gt; [ColumnInfo 'MSSQL] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQuery"><span class="hs-identifier hs-var hs-var">mkInsertTriggerQuery</span></a></span></span><span> </span><span id="local-6989586621689794117"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621689794117"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621689794116"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794116"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621689794115"><span class="annot"><span class="annottext">schema :: SchemaName
</span><a href="#local-6989586621689794115"><span class="hs-identifier hs-var">schema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689794114"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794114"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621689794113"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794113"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794112"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794112"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-750"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span> </span><span id="local-6989586621689794111"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794111"><span class="hs-identifier hs-var">qualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; SchemaName -&gt; TriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-var">msssqlIdenTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689794115"><span class="hs-identifier hs-var">schema</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794113"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-751"></span><span>      </span><span id="local-6989586621689794110"><span class="annot"><span class="annottext">triggerNameText :: Text
</span><a href="#local-6989586621689794110"><span class="hs-identifier hs-var hs-var">triggerNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794113"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-752"></span><span>      </span><span id="local-6989586621689794109"><span class="annot"><span class="annottext">qualifiedTableName :: Text
</span><a href="#local-6989586621689794109"><span class="hs-identifier hs-var hs-var">qualifiedTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var">qualifyTableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794117"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-753"></span><span>      </span><span id="local-6989586621689794108"><span class="annot"><span class="annottext">operation :: Text
</span><a href="#local-6989586621689794108"><span class="hs-identifier hs-var hs-var">operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span>
</span><span id="line-754"></span><span>      </span><span id="local-6989586621689794107"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794107"><span class="hs-identifier hs-var">deliveryColsSQLExpression</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-755"></span><span>        </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794112"><span class="hs-identifier hs-var">columns</span></a></span><span>
</span><span id="line-756"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_insert_trigger.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span>
</span><span id="line-758"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQuery"><span class="hs-identifier hs-type">mkDeleteTriggerQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LT.Text</span></span><span>
</span><span id="line-759"></span><span id="mkDeleteTriggerQuery"><span class="annot"><span class="annottext">mkDeleteTriggerQuery :: TableName -&gt; TriggerName -&gt; [ColumnInfo 'MSSQL] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQuery"><span class="hs-identifier hs-var hs-var">mkDeleteTriggerQuery</span></a></span></span><span> </span><span id="local-6989586621689794106"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621689794106"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621689794105"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794105"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621689794104"><span class="annot"><span class="annottext">schema :: SchemaName
</span><a href="#local-6989586621689794104"><span class="hs-identifier hs-var">schema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689794103"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794103"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621689794102"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794102"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689794101"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794101"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-760"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span> </span><span id="local-6989586621689794100"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794100"><span class="hs-identifier hs-var">qualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; SchemaName -&gt; TriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-var">msssqlIdenTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689794104"><span class="hs-identifier hs-var">schema</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794102"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-761"></span><span>      </span><span id="local-6989586621689794099"><span class="annot"><span class="annottext">triggerNameText :: Text
</span><a href="#local-6989586621689794099"><span class="hs-identifier hs-var hs-var">triggerNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794102"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-762"></span><span>      </span><span id="local-6989586621689794098"><span class="annot"><span class="annottext">qualifiedTableName :: Text
</span><a href="#local-6989586621689794098"><span class="hs-identifier hs-var hs-var">qualifiedTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var">qualifyTableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794106"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-763"></span><span>      </span><span id="local-6989586621689794097"><span class="annot"><span class="annottext">operation :: Text
</span><a href="#local-6989586621689794097"><span class="hs-identifier hs-var hs-var">operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span>
</span><span id="line-764"></span><span>      </span><span id="local-6989586621689794096"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794096"><span class="hs-identifier hs-var">deliveryColsSQLExpression</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#OLD"><span class="hs-identifier hs-var">OLD</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794101"><span class="hs-identifier hs-var">columns</span></a></span><span>
</span><span id="line-765"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_delete_trigger.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span>
</span><span id="line-767"></span><span class="hs-comment">-- Creates Primary Join key expression for UPDATE SQL Trigger</span><span>
</span><span id="line-768"></span><span class="hs-comment">-- eg: 'INSERTED.id = DELETED.id AND INSERTED.emp_code = DELETED.emp_code'</span><span>
</span><span id="line-769"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkPrimaryKeyJoinExp"><span class="hs-identifier hs-type">mkPrimaryKeyJoinExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-770"></span><span id="mkPrimaryKeyJoinExp"><span class="annot"><span class="annottext">mkPrimaryKeyJoinExp :: Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkPrimaryKeyJoinExp"><span class="hs-identifier hs-var hs-var">mkPrimaryKeyJoinExp</span></a></span></span><span> </span><span id="local-6989586621689794094"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794094"><span class="hs-identifier hs-var">lhsPrefix</span></a></span></span><span> </span><span id="local-6989586621689794093"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794093"><span class="hs-identifier hs-var">rhsPrefix</span></a></span></span><span> </span><span id="local-6989586621689794092"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794092"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-771"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.intercalate</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; AND &quot;</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621689794090"><span class="hs-identifier hs-var">singleColExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794092"><span class="hs-identifier hs-var">columns</span></a></span><span>
</span><span id="line-772"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-773"></span><span>    </span><span id="local-6989586621689794090"><span class="annot"><span class="annottext">singleColExp :: ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621689794090"><span class="hs-identifier hs-var hs-var">singleColExp</span></a></span></span><span> </span><span id="local-6989586621689794089"><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689794089"><span class="hs-identifier hs-var">colInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-774"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794088"><span class="annot"><span class="annottext">dbColNameText :: Text
</span><a href="#local-6989586621689794088"><span class="hs-identifier hs-var hs-var">dbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ColumnName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier hs-var hs-var">columnNameText</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnName -&gt; Text) -&gt; ColumnName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Column 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; Column b
</span><a href="Hasura.RQL.Types.Column.html#ciColumn"><span class="hs-identifier hs-var hs-var">ciColumn</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689794089"><span class="hs-identifier hs-var">colInfo</span></a></span><span>
</span><span id="line-775"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.stext| #{lhsPrefix}.#{dbColNameText} = #{rhsPrefix}.#{dbColNameText} |]</span></span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span class="hs-comment">-- Creates the WHERE clause for UPDATE SQL Trigger</span><span>
</span><span id="line-778"></span><span class="hs-comment">-- eg: If no listenColumns are defined then the where clause is an empty text</span><span>
</span><span id="line-779"></span><span class="hs-comment">--     else, 'WHERE INSERTED.id != DELETED.id OR INSERTED.name != DELTED.name'</span><span>
</span><span id="line-780"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-type">mkListenColumnsExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-781"></span><span id="mkListenColumnsExp"><span class="annot"><span class="annottext">mkListenColumnsExp :: Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-var hs-var">mkListenColumnsExp</span></a></span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-782"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-var">mkListenColumnsExp</span></a></span><span> </span><span id="local-6989586621689794086"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794086"><span class="hs-identifier hs-var">lhsPrefix</span></a></span></span><span> </span><span id="local-6989586621689794085"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794085"><span class="hs-identifier hs-var">rhsPrefix</span></a></span></span><span> </span><span id="local-6989586621689794084"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794084"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-783"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;where &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.intercalate</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; OR &quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621689794083"><span class="hs-identifier hs-var">singleColExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794084"><span class="hs-identifier hs-var">columns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-784"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-785"></span><span>    </span><span id="local-6989586621689794083"><span class="annot"><span class="annottext">singleColExp :: ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621689794083"><span class="hs-identifier hs-var hs-var">singleColExp</span></a></span></span><span> </span><span id="local-6989586621689794082"><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689794082"><span class="hs-identifier hs-var">colInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-786"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794081"><span class="annot"><span class="annottext">dbColNameText :: Text
</span><a href="#local-6989586621689794081"><span class="hs-identifier hs-var hs-var">dbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ColumnName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier hs-var hs-var">columnNameText</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnName -&gt; Text) -&gt; ColumnName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Column 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; Column b
</span><a href="Hasura.RQL.Types.Column.html#ciColumn"><span class="hs-identifier hs-var hs-var">ciColumn</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689794082"><span class="hs-identifier hs-var">colInfo</span></a></span><span>
</span><span id="line-787"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.stext| #{lhsPrefix}.#{dbColNameText} != #{rhsPrefix}.#{dbColNameText} |]</span></span><span>
</span><span id="line-788"></span><span>
</span><span id="line-789"></span><span class="hs-comment">-- | Check if primary key is present in listen columns</span><span>
</span><span id="line-790"></span><span class="hs-comment">-- We use this in update event trigger, to check if the primary key has been updated</span><span>
</span><span id="line-791"></span><span class="hs-comment">-- and construct the payload accordingly.</span><span>
</span><span id="line-792"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#isPrimaryKeyInListenColumns"><span class="hs-identifier hs-type">isPrimaryKeyInListenColumns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-793"></span><span id="isPrimaryKeyInListenColumns"><span class="annot"><span class="annottext">isPrimaryKeyInListenColumns :: [ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#isPrimaryKeyInListenColumns"><span class="hs-identifier hs-var hs-var">isPrimaryKeyInListenColumns</span></a></span></span><span> </span><span id="local-6989586621689794079"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794079"><span class="hs-identifier hs-var">listenCols</span></a></span></span><span> </span><span id="local-6989586621689794078"><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689794078"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-794"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NESeq (ColumnInfo 'MSSQL) -&gt; [ColumnInfo 'MSSQL]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; NESeq (ColumnInfo 'MSSQL)
forall (b :: BackendType) a. PrimaryKey b a -&gt; NESeq a
</span><a href="Hasura.RQL.Types.Table.html#_pkColumns"><span class="hs-identifier hs-var hs-var">_pkColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689794078"><span class="hs-identifier hs-var">primaryKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; [ColumnInfo 'MSSQL] -&gt; [ColumnInfo 'MSSQL]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794079"><span class="hs-identifier hs-var">listenCols</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-795"></span><span>    </span><span class="hs-comment">-- Do not fire Event Trigger if primary key not in listen column</span><span>
</span><span id="line-796"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;1 != 1&quot;</span></span><span>
</span><span id="line-797"></span><span>    </span><span class="hs-comment">-- Fire Event Trigger, since primary key is in listen column</span><span>
</span><span id="line-798"></span><span>    </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;1 = 1&quot;</span></span><span>
</span><span id="line-799"></span><span>
</span><span id="line-800"></span><span class="hs-comment">{- Note [Update Event Trigger MSSQL Spec]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An MS-SQL trigger is different from a postgres trigger in some ways
  * MS-SQL doesn't support triggers which trigger for each row, so in case of
    mutations which affect multiple rows, there'll only be a single trigger
    fired which will contain the data of all the rows that were affected.
  * MS-SQL maintains two logical tables, namely, [`inserted` and `deleted`](https://docs.microsoft.com/en-us/sql/relational-databases/triggers/use-the-inserted-and-deleted-tables?view=sql-server-ver15).
    The rows in the `inserted` table are copies of the new rows in the trigger
    table and similarly the `deleted` table contains the copies of the rows
    that were deleted from the trigger table.
  * When there's an update transaction, the old data (before the update) will
    be copied to the `deleted` table and the new data will be copied to the
    `inserted` table.

Since we deliver the 'old' and 'new' data in the event trigger payload, we would need
a way to correlate the values from `inserted` and `deleted` tables. And this is why,
It is mandatory for a MSSQL Update trigger table to have a primary key. We use this
primary key to correlate between `inserted` and `deleted`

MSSQL UPDATE trigger's join clause depends on the fact that the primary key is never
updated. But when the primary key is updated, you cannot join the 'INSERTED' and
the 'DELETED' tables. Hence for those cases, we consider the old payload as NULL and
the new payload will contain the updated row changes.

To figure out if a primary key has been updated, we do the following:
For each row present in the INSERTED table, we check if there are any rows in DELETED
tabled that has the same primary key as that of the row in INSERTED table. If such a
row does not exists, then it means that the primary key has been updated. The sample
SQL which does this looks like:
  SELECT * FROM INSERTED
  WHERE NOT EXISTS (SELECT * FROM DELETED WHERE  INSERTED.id = DELETED.id )

The spec for MSSQL UPDATE Event Trigger is as follows:
1. UPDATE Event Trigger can only be created on tables with a primary key.
2. When Primary Key is not updated during a UPDATE transaction then both 'data.new'
   and 'data.old' fields in payload will be constructed.
3. When Primary Key is updated during a UPDATE transaction then there are two cases:
    a. If the updated Primary key is equal to one of the already present primary key in
       the table then, we construct both the 'data.old' and 'data.new'
    b. If the updated primary key is not equal to any of the already present primary key
       in the table then, 'data.old' is NULL and only 'data.new' is constructed.
-}</span><span>
</span><span id="line-842"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQuery"><span class="hs-identifier hs-type">mkUpdateTriggerQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LT.Text</span></span><span>
</span><span id="line-843"></span><span id="mkUpdateTriggerQuery"><span class="annot"><span class="annottext">mkUpdateTriggerQuery :: TableName
-&gt; TriggerName
-&gt; [ColumnInfo 'MSSQL]
-&gt; [ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
-&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQuery"><span class="hs-identifier hs-var hs-var">mkUpdateTriggerQuery</span></a></span></span><span>
</span><span id="line-844"></span><span>  </span><span id="local-6989586621689794075"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621689794075"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621689794074"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794074"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621689794073"><span class="annot"><span class="annottext">schema :: SchemaName
</span><a href="#local-6989586621689794073"><span class="hs-identifier hs-var">schema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689794072"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794072"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-845"></span><span>  </span><span id="local-6989586621689794071"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794071"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span>
</span><span id="line-846"></span><span>  </span><span id="local-6989586621689794070"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794070"><span class="hs-identifier hs-var">listenColumns</span></a></span></span><span>
</span><span id="line-847"></span><span>  </span><span id="local-6989586621689794069"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794069"><span class="hs-identifier hs-var">deliveryColumns</span></a></span></span><span>
</span><span id="line-848"></span><span>  </span><span id="local-6989586621689794068"><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689794068"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-849"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span> </span><span id="local-6989586621689794067"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794067"><span class="hs-identifier hs-var">qualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; SchemaName -&gt; TriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-var">msssqlIdenTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689794073"><span class="hs-identifier hs-var">schema</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794071"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-850"></span><span>        </span><span id="local-6989586621689794066"><span class="annot"><span class="annottext">triggerNameText :: Text
</span><a href="#local-6989586621689794066"><span class="hs-identifier hs-var hs-var">triggerNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794071"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-851"></span><span>        </span><span id="local-6989586621689794065"><span class="annot"><span class="annottext">qualifiedTableName :: Text
</span><a href="#local-6989586621689794065"><span class="hs-identifier hs-var hs-var">qualifiedTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var">qualifyTableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689794075"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-852"></span><span>        </span><span id="local-6989586621689794064"><span class="annot"><span class="annottext">operation :: Text
</span><a href="#local-6989586621689794064"><span class="hs-identifier hs-var hs-var">operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span>
</span><span id="line-853"></span><span>
</span><span id="line-854"></span><span>        </span><span id="local-6989586621689794063"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794063"><span class="hs-identifier hs-var">oldDeliveryColsSQLExp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#OLD"><span class="hs-identifier hs-var">OLD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DELETED&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794069"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-855"></span><span>        </span><span id="local-6989586621689794062"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794062"><span class="hs-identifier hs-var">newDeliveryColsSQLExp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794069"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-856"></span><span>
</span><span id="line-857"></span><span>        </span><span class="hs-comment">-- When Primary key is updated, then 'data.old' would be NULL</span><span>
</span><span id="line-858"></span><span>        </span><span class="hs-comment">-- See Note [Update Event Trigger MSSQL Spec]</span><span>
</span><span id="line-859"></span><span>        </span><span id="local-6989586621689794061"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794061"><span class="hs-identifier hs-var">oldDeliveryColsSQLExpWhenPrimaryKeyUpdated</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-860"></span><span>          </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;NULL as [payload.data.old]&quot;</span></span><span>
</span><span id="line-861"></span><span>        </span><span id="local-6989586621689794060"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794060"><span class="hs-identifier hs-var">newDeliveryColsSQLExpWhenPrimaryKeyUpdated</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-862"></span><span>          </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794069"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-863"></span><span>
</span><span id="line-864"></span><span>        </span><span id="local-6989586621689794059"><span class="annot"><span class="annottext">primaryKeyJoinExp :: Text
</span><a href="#local-6989586621689794059"><span class="hs-identifier hs-var hs-var">primaryKeyJoinExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text) -&gt; SQLFragment -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkPrimaryKeyJoinExp"><span class="hs-identifier hs-var">mkPrimaryKeyJoinExp</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DELETED&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NESeq (ColumnInfo 'MSSQL) -&gt; [ColumnInfo 'MSSQL]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; NESeq (ColumnInfo 'MSSQL)
forall (b :: BackendType) a. PrimaryKey b a -&gt; NESeq a
</span><a href="Hasura.RQL.Types.Table.html#_pkColumns"><span class="hs-identifier hs-var hs-var">_pkColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689794068"><span class="hs-identifier hs-var">primaryKey</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-865"></span><span>        </span><span id="local-6989586621689794058"><span class="annot"><span class="annottext">listenColumnExp :: Text
</span><a href="#local-6989586621689794058"><span class="hs-identifier hs-var hs-var">listenColumnExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text) -&gt; SQLFragment -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-var">mkListenColumnsExp</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DELETED&quot;</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794070"><span class="hs-identifier hs-var">listenColumns</span></a></span><span>
</span><span id="line-866"></span><span>        </span><span id="local-6989586621689794057"><span class="annot"><span class="annottext">isPrimaryKeyInListenColumnsExp :: Text
</span><a href="#local-6989586621689794057"><span class="hs-identifier hs-var hs-var">isPrimaryKeyInListenColumnsExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text) -&gt; SQLFragment -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#isPrimaryKeyInListenColumns"><span class="hs-identifier hs-var">isPrimaryKeyInListenColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689794070"><span class="hs-identifier hs-var">listenColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689794068"><span class="hs-identifier hs-var">primaryKey</span></a></span><span>
</span><span id="line-867"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_update_trigger.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-868"></span><span>
</span><span id="line-869"></span><span class="hs-comment">-- | Add cleanup logs for given trigger names and cleanup configs. This will perform the following steps:</span><span>
</span><span id="line-870"></span><span class="hs-comment">--</span><span>
</span><span id="line-871"></span><span class="hs-comment">--   1. Get last scheduled cleanup event and count.</span><span>
</span><span id="line-872"></span><span class="hs-comment">--   2. If count is less than 5, then add add more cleanup logs, else do nothing</span><span>
</span><span id="line-873"></span><span id="local-6989586621689794056"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#addCleanupLog"><span class="hs-identifier hs-type">addCleanupLog</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-874"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794056"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794056"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-875"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-876"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#AutoTriggerLogCleanupConfig"><span class="hs-identifier hs-type">AutoTriggerLogCleanupConfig</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-877"></span><span>  </span><span class="annot"><a href="#local-6989586621689794056"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-878"></span><span id="addCleanupLog"><span class="annot"><span class="annottext">addCleanupLog :: MSSQLSourceConfig
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)] -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#addCleanupLog"><span class="hs-identifier hs-var hs-var">addCleanupLog</span></a></span></span><span> </span><span id="local-6989586621689794055"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794055"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794054"><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
</span><a href="#local-6989586621689794054"><span class="hs-identifier hs-var">triggersWithcleanupConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-879"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
</span><a href="#local-6989586621689794054"><span class="hs-identifier hs-var">triggersWithcleanupConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-880"></span><span>    </span><span id="local-6989586621689794052"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794052"><span class="hs-identifier hs-var">currTimeUTC</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; m UTCTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-881"></span><span>    </span><span id="local-6989586621689794050"><span class="annot"><span class="annottext">TimeZone
</span><a href="#local-6989586621689794050"><span class="hs-identifier hs-var">timeZone</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TimeZone -&gt; m TimeZone
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO TimeZone -&gt; m TimeZone) -&gt; IO TimeZone -&gt; m TimeZone
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; IO TimeZone
</span><span class="hs-identifier hs-var">getTimeZone</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794052"><span class="hs-identifier hs-var">currTimeUTC</span></a></span><span>
</span><span id="line-882"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794049"><span class="annot"><span class="annottext">currTime :: ZonedTime
</span><a href="#local-6989586621689794049"><span class="hs-identifier hs-var hs-var">currTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeZone -&gt; UTCTime -&gt; ZonedTime
</span><span class="hs-identifier hs-var">utcToZonedTime</span></span><span> </span><span class="annot"><span class="annottext">TimeZone
</span><a href="#local-6989586621689794050"><span class="hs-identifier hs-var">timeZone</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689794052"><span class="hs-identifier hs-var">currTimeUTC</span></a></span><span>
</span><span id="line-883"></span><span>        </span><span id="local-6989586621689794047"><span class="annot"><span class="annottext">triggerNames :: [TriggerName]
</span><a href="#local-6989586621689794047"><span class="hs-identifier hs-var hs-var">triggerNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TriggerName, AutoTriggerLogCleanupConfig) -&gt; TriggerName)
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)] -&gt; [TriggerName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(TriggerName, AutoTriggerLogCleanupConfig) -&gt; TriggerName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
</span><a href="#local-6989586621689794054"><span class="hs-identifier hs-var">triggersWithcleanupConfig</span></a></span><span>
</span><span id="line-884"></span><span>    </span><span id="local-6989586621689794046"><span class="annot"><span class="annottext">[(TriggerName, (Int, ZonedTime))]
</span><a href="#local-6989586621689794046"><span class="hs-identifier hs-var">allScheduledCleanupsInDB</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Either QErr [(TriggerName, (Int, ZonedTime))])
-&gt; m [(TriggerName, (Int, ZonedTime))]
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr [(TriggerName, (Int, ZonedTime))])
 -&gt; m [(TriggerName, (Int, ZonedTime))])
-&gt; m (Either QErr [(TriggerName, (Int, ZonedTime))])
-&gt; m [(TriggerName, (Int, ZonedTime))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr [(TriggerName, (Int, ZonedTime))])
-&gt; m (Either QErr [(TriggerName, (Int, ZonedTime))])
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr [(TriggerName, (Int, ZonedTime))])
 -&gt; m (Either QErr [(TriggerName, (Int, ZonedTime))]))
-&gt; IO (Either QErr [(TriggerName, (Int, ZonedTime))])
-&gt; m (Either QErr [(TriggerName, (Int, ZonedTime))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO [(TriggerName, (Int, ZonedTime))]
-&gt; IO (Either QErr [(TriggerName, (Int, ZonedTime))])
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794055"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO [(TriggerName, (Int, ZonedTime))]
 -&gt; IO (Either QErr [(TriggerName, (Int, ZonedTime))]))
-&gt; TxET QErr IO [(TriggerName, (Int, ZonedTime))]
-&gt; IO (Either QErr [(TriggerName, (Int, ZonedTime))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TriggerName] -&gt; TxET QErr IO [(TriggerName, (Int, ZonedTime))]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#selectLastCleanupScheduledTimestamp"><span class="hs-identifier hs-var">selectLastCleanupScheduledTimestamp</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689794047"><span class="hs-identifier hs-var">triggerNames</span></a></span><span>
</span><span id="line-885"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794044"><span class="annot"><span class="annottext">triggerMap :: HashMap TriggerName (Int, ZonedTime)
</span><a href="#local-6989586621689794044"><span class="hs-identifier hs-var hs-var">triggerMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(TriggerName, (Int, ZonedTime))]
-&gt; HashMap TriggerName (Int, ZonedTime)
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(TriggerName, (Int, ZonedTime))]
 -&gt; HashMap TriggerName (Int, ZonedTime))
-&gt; [(TriggerName, (Int, ZonedTime))]
-&gt; HashMap TriggerName (Int, ZonedTime)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, (Int, ZonedTime))]
</span><a href="#local-6989586621689794046"><span class="hs-identifier hs-var">allScheduledCleanupsInDB</span></a></span><span>
</span><span id="line-886"></span><span>        </span><span id="local-6989586621689794042"><span class="annot"><span class="annottext">scheduledTriggersAndTimestamps :: [(TriggerName, [Datetimeoffset])]
</span><a href="#local-6989586621689794042"><span class="hs-identifier hs-var hs-var">scheduledTriggersAndTimestamps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-887"></span><span>          </span><span class="annot"><span class="annottext">((TriggerName, AutoTriggerLogCleanupConfig)
 -&gt; Maybe (TriggerName, [Datetimeoffset]))
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)]
-&gt; [(TriggerName, [Datetimeoffset])]
forall (f :: * -&gt; *) a b.
Filterable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span>
</span><span id="line-888"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689794040"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794040"><span class="hs-identifier hs-var">tName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794039"><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689794039"><span class="hs-identifier hs-var">cConfig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-889"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794038"><span class="annot"><span class="annottext">lastScheduledTime :: Maybe ZonedTime
</span><a href="#local-6989586621689794038"><span class="hs-identifier hs-var hs-var">lastScheduledTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; HashMap TriggerName (Int, ZonedTime) -&gt; Maybe (Int, ZonedTime)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794040"><span class="hs-identifier hs-var">tName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName (Int, ZonedTime)
</span><a href="#local-6989586621689794044"><span class="hs-identifier hs-var">triggerMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-890"></span><span>                      </span><span class="annot"><span class="annottext">Maybe (Int, ZonedTime)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ZonedTime -&gt; Maybe ZonedTime
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621689794049"><span class="hs-identifier hs-var">currTime</span></a></span><span>
</span><span id="line-891"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689794036"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689794036"><span class="hs-identifier hs-var">count</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794035"><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621689794035"><span class="hs-identifier hs-var">lastTime</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689794036"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">5</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ZonedTime -&gt; Maybe ZonedTime
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621689794035"><span class="hs-identifier hs-var">lastTime</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe ZonedTime
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-892"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(ZonedTime -&gt; (TriggerName, [Datetimeoffset]))
-&gt; Maybe ZonedTime -&gt; Maybe (TriggerName, [Datetimeoffset])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span>
</span><span id="line-893"></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689794033"><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621689794033"><span class="hs-identifier hs-var">lastScheduledTimestamp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-894"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794040"><span class="hs-identifier hs-var">tName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(UTCTime -&gt; Datetimeoffset) -&gt; [UTCTime] -&gt; [Datetimeoffset]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ZonedTime -&gt; Datetimeoffset
</span><span class="hs-identifier hs-var">Datetimeoffset</span></span><span> </span><span class="annot"><span class="annottext">(ZonedTime -&gt; Datetimeoffset)
-&gt; (UTCTime -&gt; ZonedTime) -&gt; UTCTime -&gt; Datetimeoffset
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TimeZone -&gt; UTCTime -&gt; ZonedTime
</span><span class="hs-identifier hs-var">utcToZonedTime</span></span><span> </span><span class="annot"><span class="annottext">TimeZone
</span><a href="#local-6989586621689794050"><span class="hs-identifier hs-var">timeZone</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([UTCTime] -&gt; [Datetimeoffset]) -&gt; [UTCTime] -&gt; [Datetimeoffset]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; Int -&gt; CronSchedule -&gt; [UTCTime]
</span><a href="Hasura.Eventing.Common.html#generateScheduleTimes"><span class="hs-identifier hs-var">generateScheduleTimes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ZonedTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">zonedTimeToUTC</span></span><span> </span><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621689794033"><span class="hs-identifier hs-var">lastScheduledTimestamp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">50</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig -&gt; CronSchedule
</span><a href="Hasura.RQL.Types.EventTrigger.html#_atlccSchedule"><span class="hs-identifier hs-var hs-var">_atlccSchedule</span></a></span><span> </span><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689794039"><span class="hs-identifier hs-var">cConfig</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-895"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-896"></span><span>                      </span><span class="annot"><span class="annottext">Maybe ZonedTime
</span><a href="#local-6989586621689794038"><span class="hs-identifier hs-var">lastScheduledTime</span></a></span><span>
</span><span id="line-897"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-898"></span><span>            </span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
</span><a href="#local-6989586621689794054"><span class="hs-identifier hs-var">triggersWithcleanupConfig</span></a></span><span>
</span><span id="line-899"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])]
</span><a href="#local-6989586621689794042"><span class="hs-identifier hs-var">scheduledTriggersAndTimestamps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-900"></span><span>      </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794055"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])] -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertEventTriggerCleanupLogsTx"><span class="hs-identifier hs-var">insertEventTriggerCleanupLogsTx</span></a></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])]
</span><a href="#local-6989586621689794042"><span class="hs-identifier hs-var">scheduledTriggersAndTimestamps</span></a></span><span>
</span><span id="line-901"></span><span>
</span><span id="line-902"></span><span class="hs-comment">-- | Insert the cleanup logs for the given trigger name and schedules</span><span>
</span><span id="line-903"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertEventTriggerCleanupLogsTx"><span class="hs-identifier hs-type">insertEventTriggerCleanupLogsTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Datetimeoffset</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxET"><span class="hs-identifier hs-type">TxET</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-904"></span><span id="insertEventTriggerCleanupLogsTx"><span class="annot"><span class="annottext">insertEventTriggerCleanupLogsTx :: [(TriggerName, [Datetimeoffset])] -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertEventTriggerCleanupLogsTx"><span class="hs-identifier hs-var hs-var">insertEventTriggerCleanupLogsTx</span></a></span></span><span> </span><span id="local-6989586621689794027"><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])]
</span><a href="#local-6989586621689794027"><span class="hs-identifier hs-var">triggerNameWithSchedules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-905"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-906"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-907"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span>
</span><span id="line-908"></span><span>        </span><span class="annot"><span class="">[ST.st|
      INSERT INTO hdb_catalog.hdb_event_log_cleanups(trigger_name, scheduled_at, status)
      VALUES #{sqlValues};
      |]</span></span><span>
</span><span id="line-912"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-914"></span><span>    </span><span id="local-6989586621689794026"><span class="annot"><span class="annottext">sqlValues :: Text
</span><a href="#local-6989586621689794026"><span class="hs-identifier hs-var hs-var">sqlValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-915"></span><span>      </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-916"></span><span>        </span><span class="annot"><span class="annottext">((TriggerName, [Datetimeoffset]) -&gt; Text)
-&gt; [(TriggerName, [Datetimeoffset])] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span>
</span><span id="line-917"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689794025"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794025"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794024"><span class="annot"><span class="annottext">[Datetimeoffset]
</span><a href="#local-6989586621689794024"><span class="hs-identifier hs-var">schedules</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-918"></span><span>              </span><span class="annot"><span class="annottext">(Datetimeoffset -&gt; Text) -&gt; [Datetimeoffset] -&gt; Text
forall a. (a -&gt; Text) -&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromListWith"><span class="hs-identifier hs-var">generateSQLValuesFromListWith</span></a></span><span>
</span><span id="line-919"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689794023"><span class="annot"><span class="annottext">Datetimeoffset
</span><a href="#local-6989586621689794023"><span class="hs-identifier hs-var">schedule</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-920"></span><span>                    </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689794025"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;', '&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text)
-&gt; (Datetimeoffset -&gt; String) -&gt; Datetimeoffset -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ZonedTime -&gt; String
forall t. ISO8601 t =&gt; t -&gt; String
</span><span class="hs-identifier hs-var">iso8601Show</span></span><span> </span><span class="annot"><span class="annottext">(ZonedTime -&gt; String)
-&gt; (Datetimeoffset -&gt; ZonedTime) -&gt; Datetimeoffset -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Datetimeoffset -&gt; ZonedTime
</span><span class="hs-identifier hs-var hs-var">unDatetimeoffset</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Datetimeoffset
</span><a href="#local-6989586621689794023"><span class="hs-identifier hs-var">schedule</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;', 'scheduled'&quot;</span></span><span>
</span><span id="line-921"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-922"></span><span>                </span><span class="annot"><span class="annottext">[Datetimeoffset]
</span><a href="#local-6989586621689794024"><span class="hs-identifier hs-var">schedules</span></a></span><span>
</span><span id="line-923"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-924"></span><span>          </span><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])]
</span><a href="#local-6989586621689794027"><span class="hs-identifier hs-var">triggerNameWithSchedules</span></a></span><span>
</span><span id="line-925"></span><span>
</span><span id="line-926"></span><span class="hs-comment">-- | Get the last scheduled timestamp for a given event trigger name</span><span>
</span><span id="line-927"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#selectLastCleanupScheduledTimestamp"><span class="hs-identifier hs-type">selectLastCleanupScheduledTimestamp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxET"><span class="hs-identifier hs-type">TxET</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ZonedTime</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-928"></span><span id="selectLastCleanupScheduledTimestamp"><span class="annot"><span class="annottext">selectLastCleanupScheduledTimestamp :: [TriggerName] -&gt; TxET QErr IO [(TriggerName, (Int, ZonedTime))]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#selectLastCleanupScheduledTimestamp"><span class="hs-identifier hs-var hs-var">selectLastCleanupScheduledTimestamp</span></a></span></span><span> </span><span id="local-6989586621689794021"><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689794021"><span class="hs-identifier hs-var">triggerNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-929"></span><span>  </span><span class="annot"><span class="annottext">((Text, Int, ZonedTime) -&gt; (TriggerName, (Int, ZonedTime)))
-&gt; [(Text, Int, ZonedTime)] -&gt; [(TriggerName, (Int, ZonedTime))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span>
</span><span id="line-930"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689794020"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794020"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794019"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689794019"><span class="hs-identifier hs-var">count</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689794018"><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621689794018"><span class="hs-identifier hs-var">lastScheduledTime</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-931"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmptyText -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-var">TriggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; NonEmptyText
</span><a href="Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier hs-var">mkNonEmptyTextUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794020"><span class="hs-identifier hs-var">triggerName</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689794019"><span class="hs-identifier hs-var">count</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621689794018"><span class="hs-identifier hs-var">lastScheduledTime</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-932"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-933"></span><span>    </span><span class="annot"><span class="annottext">([(Text, Int, ZonedTime)] -&gt; [(TriggerName, (Int, ZonedTime))])
-&gt; TxET QErr IO [(Text, Int, ZonedTime)]
-&gt; TxET QErr IO [(TriggerName, (Int, ZonedTime))]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query -&gt; TxET QErr IO [(Text, Int, ZonedTime)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-934"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-935"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span>
</span><span id="line-936"></span><span>          </span><span class="annot"><span class="">[ST.st|
          SELECT trigger_name, count(1), max(scheduled_at) 
          FROM hdb_catalog.hdb_event_log_cleanups 
          WHERE status='scheduled' AND trigger_name = 
            ANY(SELECT n from  (VALUES #{triggerNamesValues}) AS X(n))
          GROUP BY trigger_name;
        |]</span></span><span>
</span><span id="line-943"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-945"></span><span>    </span><span id="local-6989586621689794017"><span class="annot"><span class="annottext">triggerNamesValues :: Text
</span><a href="#local-6989586621689794017"><span class="hs-identifier hs-var hs-var">triggerNamesValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall a. ToTxt a =&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-var">generateSQLValuesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TriggerName -&gt; Text) -&gt; [TriggerName] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689794021"><span class="hs-identifier hs-var">triggerNames</span></a></span><span>
</span><span id="line-946"></span><span>
</span><span id="line-947"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletionTx"><span class="hs-identifier hs-type">getCleanupEventsForDeletionTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-948"></span><span id="getCleanupEventsForDeletionTx"><span class="annot"><span class="annottext">getCleanupEventsForDeletionTx :: TxE QErr [(Text, TriggerName)]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletionTx"><span class="hs-identifier hs-var hs-var">getCleanupEventsForDeletionTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-949"></span><span>  </span><span id="local-6989586621689794015"><span class="annot"><span class="annottext">[(Text, TriggerName)]
</span><a href="#local-6989586621689794015"><span class="hs-identifier hs-var">latestEvents</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-950"></span><span>    </span><span class="annot"><span class="annottext">((Text, Text) -&gt; (Text, TriggerName))
-&gt; [(Text, Text)] -&gt; [(Text, TriggerName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Text -&gt; TriggerName) -&gt; (Text, Text) -&gt; (Text, TriggerName)
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (d, b) (d, c)
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmptyText -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-var">TriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmptyText -&gt; TriggerName)
-&gt; (Text -&gt; NonEmptyText) -&gt; Text -&gt; TriggerName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; NonEmptyText
</span><a href="Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier hs-var">mkNonEmptyTextUnsafe</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-951"></span><span>      </span><span class="annot"><span class="annottext">([(Text, Text)] -&gt; [(Text, TriggerName)])
-&gt; TxET QErr IO [(Text, Text)] -&gt; TxE QErr [(Text, TriggerName)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [(Text, Text)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-952"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-953"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          select CAST(id AS nvarchar(36)), trigger_name
          from(
              SELECT id, trigger_name, ROW_NUMBER()
              OVER(PARTITION BY trigger_name ORDER BY scheduled_at DESC) AS rn
              FROM hdb_catalog.hdb_event_log_cleanups
              WHERE status = 'scheduled' AND scheduled_at &lt; CURRENT_TIMESTAMP
          ) AS a
          WHERE rn = 1
        |]</span></span><span>
</span><span id="line-963"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794013"><span class="annot"><span class="annottext">cleanupIDs :: [Text]
</span><a href="#local-6989586621689794013"><span class="hs-identifier hs-var hs-var">cleanupIDs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Text, TriggerName) -&gt; Text) -&gt; [(Text, TriggerName)] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Text, TriggerName) -&gt; Text
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Text, TriggerName)]
</span><a href="#local-6989586621689794015"><span class="hs-identifier hs-var">latestEvents</span></a></span><span>
</span><span id="line-964"></span><span>      </span><span id="local-6989586621689794012"><span class="annot"><span class="annottext">cleanupIDsSQLValue :: Text
</span><a href="#local-6989586621689794012"><span class="hs-identifier hs-var hs-var">cleanupIDsSQLValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall a. ToTxt a =&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-var">generateSQLValuesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794013"><span class="hs-identifier hs-var">cleanupIDs</span></a></span><span>
</span><span id="line-965"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr IO () -&gt; TxET QErr IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Text] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794013"><span class="hs-identifier hs-var">cleanupIDs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; TxET QErr IO ())
-&gt; TxET QErr IO () -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-966"></span><span>    </span><span id="local-6989586621689794011"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794011"><span class="hs-identifier hs-var">toDeadEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-967"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Text]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-968"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-969"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span>
</span><span id="line-970"></span><span>            </span><span class="annot"><span class="">[ST.st|
            SELECT CAST(id AS nvarchar(36)) FROM hdb_catalog.hdb_event_log_cleanups
            WHERE status = 'scheduled' AND scheduled_at &lt; CURRENT_TIMESTAMP AND id NOT IN 
              (SELECT n from  (VALUES #{cleanupIDsSQLValue}) AS X(n));
          |]</span></span><span>
</span><span id="line-975"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-976"></span><span>    </span><span class="annot"><span class="annottext">[Text] -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markCleanupEventsAsDeadTx"><span class="hs-identifier hs-var">markCleanupEventsAsDeadTx</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794011"><span class="hs-identifier hs-var">toDeadEvents</span></a></span><span>
</span><span id="line-977"></span><span>
</span><span id="line-978"></span><span>  </span><span class="annot"><span class="annottext">[(Text, TriggerName)] -&gt; TxE QErr [(Text, TriggerName)]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[(Text, TriggerName)]
</span><a href="#local-6989586621689794015"><span class="hs-identifier hs-var">latestEvents</span></a></span><span>
</span><span id="line-979"></span><span>
</span><span id="line-980"></span><span class="hs-comment">-- | @getCleanupEventsForDeletion@ returns the cleanup logs that are to be deleted.</span><span>
</span><span id="line-981"></span><span class="hs-comment">-- This will perform the following steps:</span><span>
</span><span id="line-982"></span><span class="hs-comment">--</span><span>
</span><span id="line-983"></span><span class="hs-comment">-- 1. Get the scheduled cleanup events that were scheduled before current time.</span><span>
</span><span id="line-984"></span><span class="hs-comment">-- 2. If there are multiple entries for the same trigger name with different scheduled time,</span><span>
</span><span id="line-985"></span><span class="hs-comment">--    then fetch the latest entry and mark others as dead.</span><span>
</span><span id="line-986"></span><span id="local-6989586621689794009"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletion"><span class="hs-identifier hs-type">getCleanupEventsForDeletion</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-987"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794009"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794009"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-988"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-989"></span><span>  </span><span class="annot"><a href="#local-6989586621689794009"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-990"></span><span id="getCleanupEventsForDeletion"><span class="annot"><span class="annottext">getCleanupEventsForDeletion :: MSSQLSourceConfig -&gt; m [(Text, TriggerName)]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletion"><span class="hs-identifier hs-var hs-var">getCleanupEventsForDeletion</span></a></span></span><span> </span><span id="local-6989586621689794008"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794008"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-991"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr [(Text, TriggerName)]) -&gt; m [(Text, TriggerName)]
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr [(Text, TriggerName)]) -&gt; m [(Text, TriggerName)])
-&gt; m (Either QErr [(Text, TriggerName)]) -&gt; m [(Text, TriggerName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr [(Text, TriggerName)])
-&gt; m (Either QErr [(Text, TriggerName)])
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr [(Text, TriggerName)])
 -&gt; m (Either QErr [(Text, TriggerName)]))
-&gt; IO (Either QErr [(Text, TriggerName)])
-&gt; m (Either QErr [(Text, TriggerName)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxE QErr [(Text, TriggerName)]
-&gt; IO (Either QErr [(Text, TriggerName)])
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794008"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr [(Text, TriggerName)]
 -&gt; IO (Either QErr [(Text, TriggerName)]))
-&gt; TxE QErr [(Text, TriggerName)]
-&gt; IO (Either QErr [(Text, TriggerName)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TxE QErr [(Text, TriggerName)]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletionTx"><span class="hs-identifier hs-var">getCleanupEventsForDeletionTx</span></a></span><span>
</span><span id="line-992"></span><span>
</span><span id="line-993"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markCleanupEventsAsDeadTx"><span class="hs-identifier hs-type">markCleanupEventsAsDeadTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-994"></span><span id="markCleanupEventsAsDeadTx"><span class="annot"><span class="annottext">markCleanupEventsAsDeadTx :: [Text] -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markCleanupEventsAsDeadTx"><span class="hs-identifier hs-var hs-var">markCleanupEventsAsDeadTx</span></a></span></span><span> </span><span id="local-6989586621689794007"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794007"><span class="hs-identifier hs-var">toDeadEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-995"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689794006"><span class="annot"><span class="annottext">deadEventsValues :: Text
</span><a href="#local-6989586621689794006"><span class="hs-identifier hs-var hs-var">deadEventsValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall a. ToTxt a =&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-var">generateSQLValuesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794007"><span class="hs-identifier hs-var">toDeadEvents</span></a></span><span>
</span><span id="line-996"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr IO () -&gt; TxET QErr IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Text] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794007"><span class="hs-identifier hs-var">toDeadEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; TxET QErr IO ())
-&gt; TxET QErr IO () -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-997"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-998"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-999"></span><span>        </span><span class="annot"><span class="">[ST.st|
        UPDATE hdb_catalog.hdb_event_log_cleanups
        SET status = 'dead'
        WHERE id = ANY ( SELECT id from  (VALUES #{deadEventsValues}) AS X(id));
        |]</span></span><span>
</span><span id="line-1004"></span><span>
</span><span id="line-1005"></span><span id="local-6989586621689794005"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToDead"><span class="hs-identifier hs-type">updateCleanupEventStatusToDead</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1006"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794005"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794005"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1007"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1008"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1009"></span><span>  </span><span class="annot"><a href="#local-6989586621689794005"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1010"></span><span id="updateCleanupEventStatusToDead"><span class="annot"><span class="annottext">updateCleanupEventStatusToDead :: MSSQLSourceConfig -&gt; [Text] -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToDead"><span class="hs-identifier hs-var hs-var">updateCleanupEventStatusToDead</span></a></span></span><span> </span><span id="local-6989586621689794004"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794004"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689794003"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794003"><span class="hs-identifier hs-var">toDeadEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1011"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689794004"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markCleanupEventsAsDeadTx"><span class="hs-identifier hs-var">markCleanupEventsAsDeadTx</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689794003"><span class="hs-identifier hs-var">toDeadEvents</span></a></span><span>
</span><span id="line-1012"></span><span>
</span><span id="line-1013"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPausedTx"><span class="hs-identifier hs-type">updateCleanupEventStatusToPausedTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1014"></span><span id="updateCleanupEventStatusToPausedTx"><span class="annot"><span class="annottext">updateCleanupEventStatusToPausedTx :: Text -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPausedTx"><span class="hs-identifier hs-var hs-var">updateCleanupEventStatusToPausedTx</span></a></span></span><span> </span><span id="local-6989586621689794001"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689794001"><span class="hs-identifier hs-var">cleanupLogId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1015"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-1016"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1017"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.hdb_event_log_cleanups
          SET status = 'paused'
          WHERE id = $cleanupLogId
          |]</span></span><span>
</span><span id="line-1022"></span><span>
</span><span id="line-1023"></span><span class="hs-comment">-- | @updateCleanupEventStatusToPaused@ updates the cleanup log status to `paused` if the event trigger configuration is paused.</span><span>
</span><span id="line-1024"></span><span id="local-6989586621689794000"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPaused"><span class="hs-identifier hs-type">updateCleanupEventStatusToPaused</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1025"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689794000"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689794000"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1026"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1027"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1028"></span><span>  </span><span class="annot"><a href="#local-6989586621689794000"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1029"></span><span id="updateCleanupEventStatusToPaused"><span class="annot"><span class="annottext">updateCleanupEventStatusToPaused :: MSSQLSourceConfig -&gt; Text -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPaused"><span class="hs-identifier hs-var hs-var">updateCleanupEventStatusToPaused</span></a></span></span><span> </span><span id="local-6989586621689793999"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689793999"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689793998"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689793998"><span class="hs-identifier hs-var">cleanupLogId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1030"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689793999"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPausedTx"><span class="hs-identifier hs-var">updateCleanupEventStatusToPausedTx</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689793998"><span class="hs-identifier hs-var">cleanupLogId</span></a></span><span>
</span><span id="line-1031"></span><span>
</span><span id="line-1032"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompletedTx"><span class="hs-identifier hs-type">updateCleanupEventStatusToCompletedTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-type">DeletedEventLogStats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1033"></span><span id="updateCleanupEventStatusToCompletedTx"><span class="annot"><span class="annottext">updateCleanupEventStatusToCompletedTx :: Text -&gt; DeletedEventLogStats -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompletedTx"><span class="hs-identifier hs-var hs-var">updateCleanupEventStatusToCompletedTx</span></a></span></span><span> </span><span id="local-6989586621689793996"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689793996"><span class="hs-identifier hs-var">cleanupLogId</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-type">DeletedEventLogStats</span></a></span><span> </span><span id="local-6989586621689793994"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689793994"><span class="hs-identifier hs-var">numEventLogs</span></a></span></span><span> </span><span id="local-6989586621689793993"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689793993"><span class="hs-identifier hs-var">numInvocationLogs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1034"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-1035"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1036"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.hdb_event_log_cleanups
          SET status = 'completed', deleted_event_logs = $numEventLogs, deleted_event_invocation_logs = $numInvocationLogs
          WHERE id = $cleanupLogId
          |]</span></span><span>
</span><span id="line-1041"></span><span>
</span><span id="line-1042"></span><span class="hs-comment">-- | @updateCleanupEventStatusToCompleted@ updates the cleanup log status after the event logs are deleted.</span><span>
</span><span id="line-1043"></span><span class="hs-comment">-- This will perform the following steps:</span><span>
</span><span id="line-1044"></span><span class="hs-comment">--</span><span>
</span><span id="line-1045"></span><span class="hs-comment">-- 1. Updates the cleanup config status to `completed`.</span><span>
</span><span id="line-1046"></span><span class="hs-comment">-- 2. Updates the number of event logs and event invocation logs that were deleted for a trigger name</span><span>
</span><span id="line-1047"></span><span id="local-6989586621689793992"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompleted"><span class="hs-identifier hs-type">updateCleanupEventStatusToCompleted</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1048"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689793992"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689793992"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1049"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1050"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1051"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-type">DeletedEventLogStats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1052"></span><span>  </span><span class="annot"><a href="#local-6989586621689793992"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1053"></span><span id="updateCleanupEventStatusToCompleted"><span class="annot"><span class="annottext">updateCleanupEventStatusToCompleted :: MSSQLSourceConfig -&gt; Text -&gt; DeletedEventLogStats -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompleted"><span class="hs-identifier hs-var hs-var">updateCleanupEventStatusToCompleted</span></a></span></span><span> </span><span id="local-6989586621689793991"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689793991"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689793990"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689793990"><span class="hs-identifier hs-var">cleanupLogId</span></a></span></span><span> </span><span id="local-6989586621689793989"><span class="annot"><span class="annottext">DeletedEventLogStats
</span><a href="#local-6989586621689793989"><span class="hs-identifier hs-var">delStats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1054"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689793991"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; DeletedEventLogStats -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompletedTx"><span class="hs-identifier hs-var">updateCleanupEventStatusToCompletedTx</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689793990"><span class="hs-identifier hs-var">cleanupLogId</span></a></span><span> </span><span class="annot"><span class="annottext">DeletedEventLogStats
</span><a href="#local-6989586621689793989"><span class="hs-identifier hs-var">delStats</span></a></span><span>
</span><span id="line-1055"></span><span>
</span><span id="line-1056"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogsTx"><span class="hs-identifier hs-type">deleteEventTriggerLogsTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerLogCleanupConfig"><span class="hs-identifier hs-type">TriggerLogCleanupConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-type">DeletedEventLogStats</span></a></span><span>
</span><span id="line-1057"></span><span id="deleteEventTriggerLogsTx"><span class="annot"><span class="annottext">deleteEventTriggerLogsTx :: TriggerLogCleanupConfig -&gt; TxE QErr DeletedEventLogStats
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogsTx"><span class="hs-identifier hs-var hs-var">deleteEventTriggerLogsTx</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerLogCleanupConfig"><span class="hs-identifier hs-type">TriggerLogCleanupConfig</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689793981"><span id="local-6989586621689793982"><span id="local-6989586621689793983"><span id="local-6989586621689793984"><span id="local-6989586621689793985"><span id="local-6989586621689793986"><span class="annot"><span class="annottext">Bool
Int
SourceName
TriggerName
tlccCleanInvocationLogs :: TriggerLogCleanupConfig -&gt; Bool
tlccQueryTimeout :: TriggerLogCleanupConfig -&gt; Int
tlccRetentionPeriod :: TriggerLogCleanupConfig -&gt; Int
tlccBatchSize :: TriggerLogCleanupConfig -&gt; Int
tlccSourceName :: TriggerLogCleanupConfig -&gt; SourceName
tlccEventTriggerName :: TriggerLogCleanupConfig -&gt; TriggerName
tlccCleanInvocationLogs :: Bool
tlccQueryTimeout :: Int
tlccRetentionPeriod :: Int
tlccBatchSize :: Int
tlccSourceName :: SourceName
tlccEventTriggerName :: TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#tlccCleanInvocationLogs"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1058"></span><span>  </span><span class="hs-comment">-- Setting the timeout</span><span>
</span><span id="line-1059"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-1060"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1061"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
          SET LOCK_TIMEOUT $qTimeout;
        |]</span></span><span>
</span><span id="line-1064"></span><span>  </span><span class="hs-comment">--  Select all the dead events based on criteria set in the cleanup config.</span><span>
</span><span id="line-1065"></span><span>  </span><span id="local-6989586621689793973"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689793973"><span class="hs-identifier hs-var">deadEventIDs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1066"></span><span>    </span><span class="annot"><span class="annottext">(Text -&gt; EventId) -&gt; [Text] -&gt; [EventId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-var">EventId</span></a></span><span>
</span><span id="line-1067"></span><span>      </span><span class="annot"><span class="annottext">([Text] -&gt; [EventId])
-&gt; TxET QErr IO [Text] -&gt; TxET QErr IO [EventId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Text]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-1068"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1069"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          SELECT TOP ($qBatchSize) CAST(id AS nvarchar(36)) FROM hdb_catalog.event_log WITH (UPDLOCK, READPAST)
          WHERE ((delivered = 1 OR error = 1) AND trigger_name = $qTriggerName  )
          AND created_at &lt; DATEADD(HOUR, - $qRetentionPeriod, CURRENT_TIMESTAMP)
          AND locked IS NULL
        |]</span></span><span>
</span><span id="line-1075"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[EventId] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689793973"><span class="hs-identifier hs-var">deadEventIDs</span></a></span><span>
</span><span id="line-1076"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats)
-&gt; DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; DeletedEventLogStats
</span><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-var">DeletedEventLogStats</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1077"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1078"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689793969"><span class="annot"><span class="annottext">eventIdsValues :: Text
</span><a href="#local-6989586621689793969"><span class="hs-identifier hs-var hs-var">eventIdsValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EventId] -&gt; Text
forall a. ToTxt a =&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-var">generateSQLValuesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689793973"><span class="hs-identifier hs-var">deadEventIDs</span></a></span><span>
</span><span id="line-1079"></span><span>      </span><span class="hs-comment">--  Lock the events in the database so that other HGE instances don't pick them up for deletion.</span><span>
</span><span id="line-1080"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1081"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1082"></span><span>          </span><span class="annot"><span class="">[ST.st|
          UPDATE hdb_catalog.event_log
          SET locked = CURRENT_TIMESTAMP
          WHERE id = ANY ( SELECT id from  (VALUES #{eventIdsValues}) AS X(id)) 
              AND locked IS NULL
          |]</span></span><span>
</span><span id="line-1088"></span><span>      </span><span class="hs-comment">--  Based on the config either delete the corresponding invocation logs or set trigger_name</span><span>
</span><span id="line-1089"></span><span>      </span><span class="hs-comment">--  to appropriate value. Please note that the event_id won't exist anymore in the event_log</span><span>
</span><span id="line-1090"></span><span>      </span><span class="hs-comment">--  table, but we are still retaining it for debugging purpose.</span><span>
</span><span id="line-1091"></span><span>      </span><span id="local-6989586621689793968"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621689793968"><span class="hs-identifier hs-var">deletedInvocationLogs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-comment">-- This will be an array of 1 and is only used to count the number of deleted rows.</span><span>
</span><span id="line-1092"></span><span>        </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Int]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO [Int]) -&gt; Query -&gt; TxET QErr IO [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1093"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1094"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689793981"><span class="hs-identifier hs-var">tlccCleanInvocationLogs</span></a></span><span>
</span><span id="line-1095"></span><span>              </span><span class="hs-keyword">then</span><span>
</span><span id="line-1096"></span><span>                </span><span class="annot"><span class="">[ST.st|
                DELETE FROM hdb_catalog.event_invocation_logs
                OUTPUT 1
                WHERE event_id = ANY ( SELECT id from  (VALUES #{eventIdsValues}) AS X(id));
                |]</span></span><span>
</span><span id="line-1101"></span><span>              </span><span class="hs-keyword">else</span><span>
</span><span id="line-1102"></span><span>                </span><span class="annot"><span class="">[ST.st|
                UPDATE hdb_catalog.event_invocation_logs
                SET trigger_name = '#{qTriggerName}'
                WHERE event_id = ANY ( SELECT id from  (VALUES #{eventIdsValues}) AS X(id));
                |]</span></span><span>
</span><span id="line-1107"></span><span>      </span><span class="hs-comment">--  Finally delete the event logs.</span><span>
</span><span id="line-1108"></span><span>      </span><span id="local-6989586621689793967"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621689793967"><span class="hs-identifier hs-var">deletedEventLogs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-comment">-- This will be an array of 1 and is only used to count the number of deleted rows.</span><span>
</span><span id="line-1109"></span><span>        </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Int]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO [Int]) -&gt; Query -&gt; TxET QErr IO [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1110"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1111"></span><span>            </span><span class="annot"><span class="">[ST.st|
            DELETE FROM hdb_catalog.event_log
            OUTPUT 1
            WHERE id = ANY ( SELECT id from  (VALUES #{eventIdsValues}) AS X(id));
            |]</span></span><span>
</span><span id="line-1116"></span><span>      </span><span class="hs-comment">-- Removing the timeout (-1 is the default timeout)</span><span>
</span><span id="line-1117"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-1118"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1119"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
              SET LOCK_TIMEOUT -1;
            |]</span></span><span>
</span><span id="line-1122"></span><span>      </span><span class="annot"><span class="annottext">DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats)
-&gt; DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; DeletedEventLogStats
</span><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-var">DeletedEventLogStats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621689793967"><span class="hs-identifier hs-var">deletedEventLogs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621689793968"><span class="hs-identifier hs-var">deletedInvocationLogs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1123"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1124"></span><span>    </span><span id="local-6989586621689793974"><span class="annot"><span class="annottext">qTimeout :: Int
</span><a href="#local-6989586621689793974"><span class="hs-identifier hs-var hs-var">qTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689793982"><span class="hs-identifier hs-var">tlccQueryTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000</span></span><span>
</span><span id="line-1125"></span><span>    </span><span id="local-6989586621689793972"><span class="annot"><span class="annottext">qTriggerName :: Text
</span><a href="#local-6989586621689793972"><span class="hs-identifier hs-var hs-var">qTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689793986"><span class="hs-identifier hs-var">tlccEventTriggerName</span></a></span><span>
</span><span id="line-1126"></span><span>    </span><span id="local-6989586621689793971"><span class="annot"><span class="annottext">qRetentionPeriod :: Int
</span><a href="#local-6989586621689793971"><span class="hs-identifier hs-var hs-var">qRetentionPeriod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689793983"><span class="hs-identifier hs-var">tlccRetentionPeriod</span></a></span><span>
</span><span id="line-1127"></span><span>    </span><span id="local-6989586621689793970"><span class="annot"><span class="annottext">qBatchSize :: Int
</span><a href="#local-6989586621689793970"><span class="hs-identifier hs-var hs-var">qBatchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689793984"><span class="hs-identifier hs-var">tlccBatchSize</span></a></span><span>
</span><span id="line-1128"></span><span>
</span><span id="line-1129"></span><span class="hs-comment">-- | @deleteEventTriggerLogs@ deletes the event logs (and event invocation logs) based on the cleanup configuration given</span><span>
</span><span id="line-1130"></span><span class="hs-comment">-- This will perform the following steps:</span><span>
</span><span id="line-1131"></span><span class="hs-comment">--</span><span>
</span><span id="line-1132"></span><span class="hs-comment">-- 1. Select all the dead events based on criteria set in the cleanup config.</span><span>
</span><span id="line-1133"></span><span class="hs-comment">-- 2. Lock the events in the database so that other HGE instances don't pick them up for deletion.</span><span>
</span><span id="line-1134"></span><span class="hs-comment">-- 3. Based on the config, perform the delete action.</span><span>
</span><span id="line-1135"></span><span id="local-6989586621689793964"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogs"><span class="hs-identifier hs-type">deleteEventTriggerLogs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1136"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689793964"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689793964"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1137"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1138"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerLogCleanupConfig"><span class="hs-identifier hs-type">TriggerLogCleanupConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1139"></span><span>  </span><span class="annot"><a href="#local-6989586621689793964"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-type">DeletedEventLogStats</span></a></span></span><span>
</span><span id="line-1140"></span><span id="deleteEventTriggerLogs"><span class="annot"><span class="annottext">deleteEventTriggerLogs :: MSSQLSourceConfig
-&gt; TriggerLogCleanupConfig -&gt; m DeletedEventLogStats
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogs"><span class="hs-identifier hs-var hs-var">deleteEventTriggerLogs</span></a></span></span><span> </span><span id="local-6989586621689793963"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689793963"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689793962"><span class="annot"><span class="annottext">TriggerLogCleanupConfig
</span><a href="#local-6989586621689793962"><span class="hs-identifier hs-var">cleanupConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1141"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr DeletedEventLogStats) -&gt; m DeletedEventLogStats
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr DeletedEventLogStats) -&gt; m DeletedEventLogStats)
-&gt; m (Either QErr DeletedEventLogStats) -&gt; m DeletedEventLogStats
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr DeletedEventLogStats)
-&gt; m (Either QErr DeletedEventLogStats)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr DeletedEventLogStats)
 -&gt; m (Either QErr DeletedEventLogStats))
-&gt; IO (Either QErr DeletedEventLogStats)
-&gt; m (Either QErr DeletedEventLogStats)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxE QErr DeletedEventLogStats
-&gt; IO (Either QErr DeletedEventLogStats)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689793963"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr DeletedEventLogStats
 -&gt; IO (Either QErr DeletedEventLogStats))
-&gt; TxE QErr DeletedEventLogStats
-&gt; IO (Either QErr DeletedEventLogStats)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerLogCleanupConfig -&gt; TxE QErr DeletedEventLogStats
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogsTx"><span class="hs-identifier hs-var">deleteEventTriggerLogsTx</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerLogCleanupConfig
</span><a href="#local-6989586621689793962"><span class="hs-identifier hs-var">cleanupConfig</span></a></span><span>
</span><span id="line-1142"></span></pre></body></html>