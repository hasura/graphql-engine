- description: setup a custom SQL function
  url: /v1/query
  status: 200
  query:
    type: run_sql
    args:
      sql: |
        CREATE FUNCTION get_session_var_value(hasura_session json, session_var text)
        RETURNS SETOF text_result AS $$
            SELECT q.* FROM (VALUES (hasura_session ->> session_var)) q
        $$ LANGUAGE sql STABLE;

- description: Track function v2 with invalid session variable argument
  url: /v1/query
  status: 400
  response:
    path: "$.args.session_variable_argument"
    error: function argument with name "random" not found
    code: not-found
  query:
    version: 2
    type: track_function
    args:
      function: get_session_var_value
      session_variable_argument: random

- description: Track function v2 with non json session variable argument
  url: /v1/query
  status: 400
  response:
    path: "$.args.session_variable_argument"
    error: session variable argument should be of type JSON
    code: not-supported
  query:
    version: 2
    type: track_function
    args:
      function: get_session_var_value
      session_variable_argument: session_var

- description: teardown function
  url: /v1/query
  status: 200
  query:
    type: run_sql
    args:
      sql: |
        DROP FUNCTION get_session_var_value;
      cascade: true
