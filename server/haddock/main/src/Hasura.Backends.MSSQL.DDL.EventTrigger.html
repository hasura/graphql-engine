<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Backends.MSSQL.DDL.EventTrigger</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createTableEventTrigger"><span class="hs-identifier">createTableEventTrigger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchUndeliveredEvents"><span class="hs-identifier">fetchUndeliveredEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetry"><span class="hs-identifier">setRetry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordSuccess"><span class="hs-identifier">recordSuccess</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError"><span class="hs-identifier">recordError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier">recordError'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier">dropTriggerQ</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerAndArchiveEvents"><span class="hs-identifier">dropTriggerAndArchiveEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropDanglingSQLTrigger"><span class="hs-identifier">dropDanglingSQLTrigger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#redeliverEvent"><span class="hs-identifier">redeliverEvent</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertManualEvent"><span class="hs-identifier">insertManualEvent</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsInSource"><span class="hs-identifier">unlockEventsInSource</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersion"><span class="hs-identifier">getMaintenanceModeVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier">qualifyTableName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createMissingSQLTriggers"><span class="hs-identifier">createMissingSQLTriggers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExists"><span class="hs-identifier">checkIfTriggerExists</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#addCleanupSchedules"><span class="hs-identifier">addCleanupSchedules</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteAllScheduledCleanups"><span class="hs-identifier">deleteAllScheduledCleanups</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletion"><span class="hs-identifier">getCleanupEventsForDeletion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToDead"><span class="hs-identifier">updateCleanupEventStatusToDead</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPaused"><span class="hs-identifier">updateCleanupEventStatusToPaused</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompleted"><span class="hs-identifier">updateCleanupEventStatusToCompleted</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogs"><span class="hs-identifier">deleteEventTriggerLogs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventLogs"><span class="hs-identifier">fetchEventLogs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventInvocationLogs"><span class="hs-identifier">fetchEventInvocationLogs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventById"><span class="hs-identifier">fetchEventById</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">where</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/monad-control-1.0.3.1-92f8a47f193bc8ca499a8b94581fad6cb68b7a26370b271798ac2ec617c05064/share/doc/html/src/Control.Monad.Trans.Control.html"><span class="hs-identifier">Control.Monad.Trans.Control</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/monad-control-1.0.3.1-92f8a47f193bc8ca499a8b94581fad6cb68b7a26370b271798ac2ec617c05064/share/doc/html/src/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier">MonadBaseControl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-78f82c0a41c76fc62260cf94c4b206816c9efb8c3788f4fbd6184398938cf6fb/share/doc/html/src/Data.Aeson.html"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromStrict</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/file-embed-0.0.15.0-315912327a311fbd12f54ee1ad56204b99e77d4611408550d7a8b613cc50e540/share/doc/html/src/Data.FileEmbed.html"><span class="hs-identifier">Data.FileEmbed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/file-embed-0.0.15.0-315912327a311fbd12f54ee1ad56204b99e77d4611408550d7a8b613cc50e540/share/doc/html/src/Data.FileEmbed.html#makeRelativeToProject"><span class="hs-identifier">makeRelativeToProject</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-a5b4fa803c841f948b5080a5c7a22f4e3b108a71ab10582fd155001f6f7ca093/share/doc/html/src/Data.HashMap.Strict.html"><span class="hs-identifier">Data.HashMap.Strict</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-a5b4fa803c841f948b5080a5c7a22f4e3b108a71ab10582fd155001f6f7ca093/share/doc/html/src/Data.HashSet.html"><span class="hs-identifier">Data.HashSet</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashSet</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/nonempty-containers-0.3.4.4-825e2deab592b68f6e996ee1988c522c2830c3702fdc6d9d361a95b642f27a88/share/doc/html/src/Data.Set.NonEmpty.html"><span class="hs-identifier">Data.Set.NonEmpty</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.html"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Encoding.html"><span class="hs-identifier">Data.Text.Encoding</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TE</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#ToTxt"><span class="hs-identifier">ToTxt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier">commaSeparated</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier">toTxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Lazy.html"><span class="hs-identifier">Data.Text.Lazy</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LT</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.NonEmpty.html"><span class="hs-identifier">Data.Text.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier">mkNonEmptyTextUnsafe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Format.ISO8601</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">iso8601Show</span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html"><span class="hs-identifier">Database.MSSQL.Transaction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier">TxE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxET"><span class="hs-identifier">TxET</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier">multiRowQueryE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier">singleRowQueryE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier">unitQueryE</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html"><span class="hs-identifier">Database.ODBC.SQLServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#Datetime2"><span class="hs-identifier">Datetime2</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#Datetimeoffset"><span class="hs-identifier">Datetimeoffset</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier">rawUnescapedText</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#toSql"><span class="hs-identifier">toSql</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.TH.html"><span class="hs-identifier">Database.ODBC.TH</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ODBC</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Connection</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html"><span class="hs-identifier">Hasura.Backends.MSSQL.DDL.Source.Version</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.SQL.Error.html"><span class="hs-identifier">Hasura.Backends.MSSQL.SQL.Error</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HGE</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.ToQuery.html"><span class="hs-identifier">Hasura.Backends.MSSQL.ToQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.ToQuery.html#fromTableName"><span class="hs-identifier">fromTableName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.ToQuery.html#toQueryFlat"><span class="hs-identifier">toQueryFlat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier">SchemaName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier">TableName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Types.Internal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier">columnNameText</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#geoTypes"><span class="hs-identifier">geoTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html"><span class="hs-identifier">Hasura.Eventing.Common</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html"><span class="hs-identifier">Hasura.RQL.Types.BackendType</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Column.html"><span class="hs-identifier">Hasura.RQL.Types.Column</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.Types.EventTrigger</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html"><span class="hs-identifier">Hasura.RQL.Types.Eventing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#OpVar"><span class="hs-identifier">OpVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.Types.html"><span class="hs-identifier">Hasura.SQL.Types</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Table.Cache.html"><span class="hs-identifier">Hasura.Table.Cache</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#PrimaryKey"><span class="hs-identifier">PrimaryKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-builder-0.6.7-600e88586f2b8b8ba5978e29b81dad60794b520a441bee09070d353e619b7d27/share/doc/html/src/Text.Builder.html"><span class="hs-identifier">Text.Builder</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TB</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/shakespeare-2.0.30-1f8fa5f3bbeaff16c0bdfc09e0d253b803573654101741044f943de4eb889e7a/share/doc/html/src/Text.Shakespeare.Text.html"><span class="hs-identifier">Text.Shakespeare.Text</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="annot"><span class="hs-comment">-- | creates a SQL Values list from haskell list  (('123-abc'), ('456-vgh'), ('234-asd'))</span></span><span>
</span><span id="line-76"></span><span id="local-6989586621687553816"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-type">generateSQLValuesFromList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#ToTxt"><span class="hs-identifier hs-type">ToTxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553816"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621687553816"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span></span><span>
</span><span id="line-77"></span><span id="generateSQLValuesFromList"><span class="annot"><span class="annottext">generateSQLValuesFromList :: forall a. ToTxt a =&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-var hs-var">generateSQLValuesFromList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Text) -&gt; [a] -&gt; Text
forall a. (a -&gt; Text) -&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromListWith"><span class="hs-identifier hs-var">generateSQLValuesFromListWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621687554740"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621687554740"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621687554740"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span id="local-6989586621687553818"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromListWith"><span class="hs-identifier hs-type">generateSQLValuesFromListWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621687553818"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621687553818"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span></span><span>
</span><span id="line-80"></span><span id="generateSQLValuesFromListWith"><span class="annot"><span class="annottext">generateSQLValuesFromListWith :: forall a. (a -&gt; Text) -&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromListWith"><span class="hs-identifier hs-var hs-var">generateSQLValuesFromListWith</span></a></span></span><span> </span><span id="local-6989586621687554747"><span class="annot"><span class="annottext">a -&gt; Text
</span><a href="#local-6989586621687554747"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621687554748"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621687554748"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687554749"><span class="hs-identifier hs-var">values</span></a></span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-82"></span><span>    </span><span id="local-6989586621687554749"><span class="annot"><span class="annottext">values :: [Text]
</span><a href="#local-6989586621687554749"><span class="hs-identifier hs-var hs-var">values</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Text) -&gt; [a] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621687554750"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621687554750"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;(&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Text
</span><a href="#local-6989586621687554747"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621687554750"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;)&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621687554748"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span id="local-6989586621687553826"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchUndeliveredEvents"><span class="hs-identifier hs-type">fetchUndeliveredEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553826"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553826"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-type">FetchBatchSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><a href="#local-6989586621687553826"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-92"></span><span id="fetchUndeliveredEvents"><span class="annot"><span class="annottext">fetchUndeliveredEvents :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig
-&gt; SourceName
-&gt; [TriggerName]
-&gt; MaintenanceMode ()
-&gt; FetchBatchSize
-&gt; m [Event 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchUndeliveredEvents"><span class="hs-identifier hs-var hs-var">fetchUndeliveredEvents</span></a></span></span><span> </span><span id="local-6989586621687554758"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554758"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554759"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687554759"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621687554760"><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621687554760"><span class="hs-identifier hs-var">triggerNames</span></a></span></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621687554761"><span class="annot"><span class="annottext">FetchBatchSize
</span><a href="#local-6989586621687554761"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr [Event 'MSSQL]) -&gt; m [Event 'MSSQL]
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><span class="annottext">(m (Either QErr [Event 'MSSQL]) -&gt; m [Event 'MSSQL])
-&gt; m (Either QErr [Event 'MSSQL]) -&gt; m [Event 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr [Event 'MSSQL]) -&gt; m (Either QErr [Event 'MSSQL])
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr [Event 'MSSQL]) -&gt; m (Either QErr [Event 'MSSQL]))
-&gt; IO (Either QErr [Event 'MSSQL])
-&gt; m (Either QErr [Event 'MSSQL])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO [Event 'MSSQL] -&gt; IO (Either QErr [Event 'MSSQL])
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554758"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO [Event 'MSSQL] -&gt; IO (Either QErr [Event 'MSSQL]))
-&gt; TxET QErr IO [Event 'MSSQL] -&gt; IO (Either QErr [Event 'MSSQL])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; [TriggerName] -&gt; FetchBatchSize -&gt; TxET QErr IO [Event 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEvents"><span class="hs-identifier hs-var">fetchEvents</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687554759"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621687554760"><span class="hs-identifier hs-var">triggerNames</span></a></span><span> </span><span class="annot"><span class="annottext">FetchBatchSize
</span><a href="#local-6989586621687554761"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span id="local-6989586621687553844"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetry"><span class="hs-identifier hs-type">setRetry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553844"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553844"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-100"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-101"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-102"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-104"></span><span>  </span><span class="annot"><a href="#local-6989586621687553844"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-105"></span><span id="setRetry"><span class="annot"><span class="annottext">setRetry :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetry"><span class="hs-identifier hs-var hs-var">setRetry</span></a></span></span><span> </span><span id="local-6989586621687554772"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554772"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554773"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554773"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621687554774"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687554774"><span class="hs-identifier hs-var">retryTime</span></a></span></span><span> </span><span id="local-6989586621687554775"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687554775"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554772"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-var">setRetryTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554773"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687554774"><span class="hs-identifier hs-var">retryTime</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687554775"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span id="local-6989586621687553848"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertManualEvent"><span class="hs-identifier hs-type">insertManualEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553848"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553848"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-78f82c0a41c76fc62260cf94c4b206816c9efb8c3788f4fbd6184398938cf6fb/share/doc/html/src/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Session.html#UserInfo"><span class="hs-identifier hs-type">UserInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-118"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.Tracing.Context.html#TraceContext"><span class="hs-identifier hs-type">Tracing.TraceContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><a href="#local-6989586621687553848"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span></span><span>
</span><span id="line-120"></span><span id="insertManualEvent"><span class="annot"><span class="annottext">insertManualEvent :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig
-&gt; TableName
-&gt; TriggerName
-&gt; Value
-&gt; UserInfo
-&gt; Maybe TraceContext
-&gt; m EventId
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertManualEvent"><span class="hs-identifier hs-var hs-var">insertManualEvent</span></a></span></span><span> </span><span id="local-6989586621687554783"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554783"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554784"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554784"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621687554785"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554785"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687554786"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687554786"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span id="local-6989586621687554787"><span class="annot"><span class="annottext">UserInfo
</span><a href="#local-6989586621687554787"><span class="hs-identifier hs-var">_userInfo</span></a></span></span><span> </span><span id="local-6989586621687554788"><span class="annot"><span class="annottext">Maybe TraceContext
</span><a href="#local-6989586621687554788"><span class="hs-identifier hs-var">_traceCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr EventId) -&gt; m EventId
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><span class="annottext">(m (Either QErr EventId) -&gt; m EventId)
-&gt; m (Either QErr EventId) -&gt; m EventId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr EventId) -&gt; m (Either QErr EventId)
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr EventId) -&gt; m (Either QErr EventId))
-&gt; IO (Either QErr EventId) -&gt; m (Either QErr EventId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO EventId -&gt; IO (Either QErr EventId)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554783"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO EventId -&gt; IO (Either QErr EventId))
-&gt; TxET QErr IO EventId -&gt; IO (Either QErr EventId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-comment">-- TODO: Include TraceContext in payload</span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><span class="annottext">TableName -&gt; TriggerName -&gt; Value -&gt; TxET QErr IO EventId
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertMSSQLManualEventTx"><span class="hs-identifier hs-var">insertMSSQLManualEventTx</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554784"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554785"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687554786"><span class="hs-identifier hs-var">payload</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span id="local-6989586621687553853"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersion"><span class="hs-identifier hs-type">getMaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553853"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553853"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><a href="#local-6989586621687553853"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span></span><span>
</span><span id="line-134"></span><span id="getMaintenanceModeVersion"><span class="annot"><span class="annottext">getMaintenanceModeVersion :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig -&gt; m MaintenanceModeVersion
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersion"><span class="hs-identifier hs-var hs-var">getMaintenanceModeVersion</span></a></span></span><span> </span><span id="local-6989586621687554796"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554796"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr MaintenanceModeVersion) -&gt; m MaintenanceModeVersion
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><span class="annottext">(m (Either QErr MaintenanceModeVersion)
 -&gt; m MaintenanceModeVersion)
-&gt; m (Either QErr MaintenanceModeVersion)
-&gt; m MaintenanceModeVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr MaintenanceModeVersion)
-&gt; m (Either QErr MaintenanceModeVersion)
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr MaintenanceModeVersion)
 -&gt; m (Either QErr MaintenanceModeVersion))
-&gt; IO (Either QErr MaintenanceModeVersion)
-&gt; m (Either QErr MaintenanceModeVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO MaintenanceModeVersion
-&gt; IO (Either QErr MaintenanceModeVersion)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceReadTx"><span class="hs-identifier hs-var">runMSSQLSourceReadTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554796"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO MaintenanceModeVersion
 -&gt; IO (Either QErr MaintenanceModeVersion))
-&gt; TxET QErr IO MaintenanceModeVersion
-&gt; IO (Either QErr MaintenanceModeVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TxET QErr IO MaintenanceModeVersion
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersionTx"><span class="hs-identifier hs-var">getMaintenanceModeVersionTx</span></a></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span id="local-6989586621687553855"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordSuccess"><span class="hs-identifier hs-type">recordSuccess</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553855"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><a href="#local-6989586621687553855"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-147"></span><span id="recordSuccess"><span class="annot"><span class="annottext">recordSuccess :: forall (m :: * -&gt; *).
MonadIO m =&gt;
MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Invocation 'EventType
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordSuccess"><span class="hs-identifier hs-var hs-var">recordSuccess</span></a></span></span><span> </span><span id="local-6989586621687554804"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554804"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554805"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554805"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621687554806"><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687554806"><span class="hs-identifier hs-var">invocation</span></a></span></span><span> </span><span id="local-6989586621687554807"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687554807"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554804"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">TriggerName -&gt; Invocation 'EventType -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-var">insertInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#tmName"><span class="hs-identifier hs-var">tmName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; TriggerMetadata
forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554805"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687554806"><span class="hs-identifier hs-var">invocation</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setSuccessTx"><span class="hs-identifier hs-var">setSuccessTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554805"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687554807"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span id="local-6989586621687553860"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError"><span class="hs-identifier hs-type">recordError</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553860"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#ProcessEventError"><span class="hs-identifier hs-type">ProcessEventError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><a href="#local-6989586621687553860"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-162"></span><span id="recordError"><span class="annot"><span class="annottext">recordError :: forall (m :: * -&gt; *).
MonadIO m =&gt;
MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Invocation 'EventType
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError"><span class="hs-identifier hs-var hs-var">recordError</span></a></span></span><span> </span><span id="local-6989586621687554814"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554814"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554815"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554815"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621687554816"><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687554816"><span class="hs-identifier hs-var">invocation</span></a></span></span><span> </span><span id="local-6989586621687554817"><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621687554817"><span class="hs-identifier hs-var">processEventError</span></a></span></span><span> </span><span id="local-6989586621687554818"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687554818"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-163"></span><span>  </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
forall (m :: * -&gt; *).
MonadIO m =&gt;
MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier hs-var">recordError'</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554814"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554815"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; Maybe (Invocation 'EventType)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687554816"><span class="hs-identifier hs-var">invocation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621687554817"><span class="hs-identifier hs-var">processEventError</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687554818"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span id="local-6989586621687553863"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier hs-type">recordError'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553863"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-170"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#ProcessEventError"><span class="hs-identifier hs-type">ProcessEventError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><a href="#local-6989586621687553863"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-173"></span><span id="recordError%27"><span class="annot"><span class="annottext">recordError' :: forall (m :: * -&gt; *).
MonadIO m =&gt;
MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier hs-var hs-var">recordError'</span></a></span></span><span> </span><span id="local-6989586621687554827"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554827"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554828"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554828"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621687554829"><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
</span><a href="#local-6989586621687554829"><span class="hs-identifier hs-var">invocation</span></a></span></span><span> </span><span id="local-6989586621687554830"><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621687554830"><span class="hs-identifier hs-var">processEventError</span></a></span></span><span> </span><span id="local-6989586621687554831"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687554831"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554827"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
-&gt; (Invocation 'EventType -&gt; TxET QErr IO ()) -&gt; TxET QErr IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
</span><a href="#local-6989586621687554829"><span class="hs-identifier hs-var">invocation</span></a></span><span> </span><span class="annot"><span class="annottext">((Invocation 'EventType -&gt; TxET QErr IO ()) -&gt; TxET QErr IO ())
-&gt; (Invocation 'EventType -&gt; TxET QErr IO ()) -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Invocation 'EventType -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-var">insertInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#tmName"><span class="hs-identifier hs-var">tmName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; TriggerMetadata
forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554828"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621687554830"><span class="hs-identifier hs-var">processEventError</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#PESetRetry"><span class="hs-identifier hs-type">PESetRetry</span></a></span><span> </span><span id="local-6989586621687554834"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687554834"><span class="hs-identifier hs-var">retryTime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-180"></span><span>          </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-var">setRetryTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554828"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687554834"><span class="hs-identifier hs-var">retryTime</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687554831"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-181"></span><span>        </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetError"><span class="hs-identifier hs-var">PESetError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setErrorTx"><span class="hs-identifier hs-var">setErrorTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687554828"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687554831"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span id="local-6989586621687553870"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#redeliverEvent"><span class="hs-identifier hs-type">redeliverEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553870"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553870"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-185"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><a href="#local-6989586621687553870"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-188"></span><span id="redeliverEvent"><span class="annot"><span class="annottext">redeliverEvent :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig -&gt; EventId -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#redeliverEvent"><span class="hs-identifier hs-var hs-var">redeliverEvent</span></a></span></span><span> </span><span id="local-6989586621687554844"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554844"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554845"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687554845"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554844"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkEventTx"><span class="hs-identifier hs-var">checkEventTx</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687554845"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-194"></span><span>      </span><span class="annot"><span class="annottext">EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markForDeliveryTx"><span class="hs-identifier hs-var">markForDeliveryTx</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687554845"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span id="local-6989586621687553872"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerAndArchiveEvents"><span class="hs-identifier hs-type">dropTriggerAndArchiveEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553872"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553872"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><a href="#local-6989586621687553872"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-202"></span><span id="dropTriggerAndArchiveEvents"><span class="annot"><span class="annottext">dropTriggerAndArchiveEvents :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig -&gt; TriggerName -&gt; TableName -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerAndArchiveEvents"><span class="hs-identifier hs-var hs-var">dropTriggerAndArchiveEvents</span></a></span></span><span> </span><span id="local-6989586621687554855"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554855"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554856"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554856"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687554857"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554857"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-203"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554855"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>      </span><span class="annot"><span class="annottext">TriggerName -&gt; SchemaName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier hs-var">dropTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554856"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName -&gt; SchemaName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AtableSchema%3ATableName"><span class="hs-identifier hs-var">tableSchema</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554857"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>      </span><span class="annot"><span class="annottext">TriggerName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#archiveEvents"><span class="hs-identifier hs-var">archiveEvents</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554856"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span id="local-6989586621687553875"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropDanglingSQLTrigger"><span class="hs-identifier hs-type">dropDanglingSQLTrigger</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553875"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553875"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-a5b4fa803c841f948b5080a5c7a22f4e3b108a71ab10582fd155001f6f7ca093/share/doc/html/src/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HashSet</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><a href="#local-6989586621687553875"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-217"></span><span id="dropDanglingSQLTrigger"><span class="annot"><span class="annottext">dropDanglingSQLTrigger :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig
-&gt; TriggerName -&gt; TableName -&gt; HashSet Ops -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropDanglingSQLTrigger"><span class="hs-identifier hs-var hs-var">dropDanglingSQLTrigger</span></a></span></span><span> </span><span id="local-6989586621687554869"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554869"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554870"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554870"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687554871"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554871"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621687554872"><span class="annot"><span class="annottext">HashSet Ops
</span><a href="#local-6989586621687554872"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554869"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><span class="annottext">(Ops -&gt; TxET QErr IO ()) -&gt; HashSet Ops -&gt; TxET QErr IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SchemaName -&gt; Ops -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-var">dropTriggerOp</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554870"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName -&gt; SchemaName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AtableSchema%3ATableName"><span class="hs-identifier hs-var">tableSchema</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554871"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet Ops
</span><a href="#local-6989586621687554872"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span id="local-6989586621687553882"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createTableEventTrigger"><span class="hs-identifier hs-type">createTableEventTrigger</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553882"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-226"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SQLGenCtx"><span class="hs-identifier hs-type">SQLGenCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-227"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#TriggerOnReplication"><span class="hs-identifier hs-type">TriggerOnReplication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerOpsDef"><span class="hs-identifier hs-type">TriggerOpsDef</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-233"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><a href="#local-6989586621687553882"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-235"></span><span id="createTableEventTrigger"><span class="annot"><span class="annottext">createTableEventTrigger :: forall (m :: * -&gt; *).
MonadIO m =&gt;
SQLGenCtx
-&gt; MSSQLSourceConfig
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerName
-&gt; TriggerOnReplication
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createTableEventTrigger"><span class="hs-identifier hs-var hs-var">createTableEventTrigger</span></a></span></span><span> </span><span id="local-6989586621687554880"><span class="annot"><span class="annottext">SQLGenCtx
</span><a href="#local-6989586621687554880"><span class="hs-identifier hs-var">_sqlGen</span></a></span></span><span> </span><span id="local-6989586621687554881"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554881"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554882"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554882"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621687554883"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687554883"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span id="local-6989586621687554884"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554884"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687554885"><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687554885"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span></span><span> </span><span id="local-6989586621687554886"><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621687554886"><span class="hs-identifier hs-var">opsDefinition</span></a></span></span><span> </span><span id="local-6989586621687554887"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621687554887"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-237"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554881"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-238"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-239"></span><span>      </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; TriggerOnReplication
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; TxET QErr IO ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; TriggerOnReplication
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-var">mkAllTriggersQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554884"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554882"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687554885"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687554883"><span class="hs-identifier hs-var">columns</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621687554886"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621687554887"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span id="local-6989586621687553888"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createMissingSQLTriggers"><span class="hs-identifier hs-type">createMissingSQLTriggers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553888"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553888"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/monad-control-1.0.3.1-92f8a47f193bc8ca499a8b94581fad6cb68b7a26370b271798ac2ec617c05064/share/doc/html/src/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553888"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-246"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SQLGenCtx"><span class="hs-identifier hs-type">SQLGenCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-247"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-248"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#TriggerOnReplication"><span class="hs-identifier hs-type">TriggerOnReplication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerOpsDef"><span class="hs-identifier hs-type">TriggerOpsDef</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><a href="#local-6989586621687553888"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-254"></span><span id="createMissingSQLTriggers"><span class="annot"><span class="annottext">createMissingSQLTriggers :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m, MonadBaseControl IO m) =&gt;
SQLGenCtx
-&gt; MSSQLSourceConfig
-&gt; TableName
-&gt; ([ColumnInfo 'MSSQL],
    Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)))
-&gt; TriggerName
-&gt; TriggerOnReplication
-&gt; TriggerOpsDef 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createMissingSQLTriggers"><span class="hs-identifier hs-var hs-var">createMissingSQLTriggers</span></a></span></span><span>
</span><span id="line-255"></span><span>  </span><span id="local-6989586621687554933"><span class="annot"><span class="annottext">SQLGenCtx
</span><a href="#local-6989586621687554933"><span class="hs-identifier hs-var">_serverConfigCtx</span></a></span></span><span>
</span><span id="line-256"></span><span>  </span><span id="local-6989586621687554934"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554934"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span>
</span><span id="line-257"></span><span>  </span><span id="local-6989586621687554935"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621687554935"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621687554937"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687554937"><span class="hs-identifier hs-var">tableNameText</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621687554939"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687554939"><span class="hs-identifier hs-var">schemaText</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621687554940"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687554940"><span class="hs-identifier hs-var">allCols</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687554941"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621687554941"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>  </span><span id="local-6989586621687554942"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554942"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span>
</span><span id="line-260"></span><span>  </span><span id="local-6989586621687554943"><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687554943"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span></span><span>
</span><span id="line-261"></span><span>  </span><span id="local-6989586621687554944"><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621687554944"><span class="hs-identifier hs-var">opsDefinition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-263"></span><span>      </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr m () -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554934"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-264"></span><span>      </span><span class="annot"><span class="annottext">(TxET QErr m () -&gt; m (Either QErr ()))
-&gt; TxET QErr m () -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>        </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()) -&gt; TxET QErr m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdInsert"><span class="hs-identifier hs-var">tdInsert</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621687554944"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621687554946"><span class="hs-identifier hs-var">doesSQLTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>        </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()) -&gt; TxET QErr m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdUpdate"><span class="hs-identifier hs-var">tdUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621687554944"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621687554946"><span class="hs-identifier hs-var">doesSQLTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>        </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()) -&gt; TxET QErr m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdDelete"><span class="hs-identifier hs-var">tdDelete</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621687554944"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621687554946"><span class="hs-identifier hs-var">doesSQLTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-269"></span><span>      </span><span id="local-6989586621687554946"><span class="annot"><span class="annottext">doesSQLTriggerExist :: Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621687554946"><span class="hs-identifier hs-var hs-var">doesSQLTriggerExist</span></a></span></span><span> </span><span id="local-6989586621687554952"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687554952"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621687554953"><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621687554953"><span class="hs-identifier hs-var">opSpec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-270"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687554954"><span class="annot"><span class="annottext">triggerNameWithOp :: Text
</span><a href="#local-6989586621687554954"><span class="hs-identifier hs-var hs-var">triggerNameWithOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;notify_hasura_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554942"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687554952"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-271"></span><span>        </span><span id="local-6989586621687554957"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687554957"><span class="hs-identifier hs-var">doesOpTriggerExist</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-272"></span><span>          </span><span class="annot"><span class="annottext">TxE QErr Bool -&gt; TxET QErr m Bool
forall a. TxE QErr a -&gt; TxET QErr m a
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span>
</span><span id="line-273"></span><span>            </span><span class="annot"><span class="annottext">(TxE QErr Bool -&gt; TxET QErr m Bool)
-&gt; TxE QErr Bool -&gt; TxET QErr m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxE QErr Bool
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span>
</span><span id="line-274"></span><span>              </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-275"></span><span>              </span><span class="annot"><span class="">[ODBC.sql|
               SELECT CASE WHEN EXISTS
                 ( SELECT 1
                   FROM sys.triggers tr
                   INNER join sys.tables tb on tr.parent_id = tb.object_id
                   INNER join sys.schemas s on tb.schema_id = s.schema_id
                   WHERE tb.name = $tableNameText AND tr.name = $triggerNameWithOp AND s.name = $schemaText
                 )
               THEN CAST(1 AS BIT)
               ELSE CAST(0 AS BIT)
               END;
             |]</span></span><span>
</span><span id="line-287"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr m () -&gt; TxET QErr m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687554957"><span class="hs-identifier hs-var">doesOpTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m () -&gt; TxET QErr m ())
-&gt; TxET QErr m () -&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687554952"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-289"></span><span>            </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; SubscribeOpSpec 'MSSQL
-&gt; TxET QErr m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-var">mkInsertTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554942"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554935"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687554940"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687554943"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621687554953"><span class="hs-identifier hs-var">opSpec</span></a></span><span>
</span><span id="line-290"></span><span>            </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; TxET QErr m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-var">mkUpdateTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554942"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554935"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687554940"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687554943"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621687554941"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621687554953"><span class="hs-identifier hs-var">opSpec</span></a></span><span>
</span><span id="line-291"></span><span>            </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; SubscribeOpSpec 'MSSQL
-&gt; TxET QErr m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-var">mkDeleteTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554942"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687554935"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687554940"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687554943"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621687554953"><span class="hs-identifier hs-var">opSpec</span></a></span><span>
</span><span id="line-292"></span><span>            </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#MANUAL"><span class="hs-identifier hs-var">MANUAL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TxET QErr m ()
forall a. a -&gt; TxET QErr m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span id="local-6989586621687553906"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsInSource"><span class="hs-identifier hs-type">unlockEventsInSource</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553906"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/nonempty-containers-0.3.4.4-825e2deab592b68f6e996ee1988c522c2830c3702fdc6d9d361a95b642f27a88/share/doc/html/src/Data.Set.NonEmpty.Internal.html#NESet"><span class="hs-identifier hs-type">NE.NESet</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-298"></span><span>  </span><span class="annot"><a href="#local-6989586621687553906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-299"></span><span id="unlockEventsInSource"><span class="annot"><span class="annottext">unlockEventsInSource :: forall (m :: * -&gt; *).
MonadIO m =&gt;
MSSQLSourceConfig -&gt; NESet EventId -&gt; m (Either QErr Int)
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsInSource"><span class="hs-identifier hs-var hs-var">unlockEventsInSource</span></a></span></span><span> </span><span id="local-6989586621687554971"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554971"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554972"><span class="annot"><span class="annottext">NESet EventId
</span><a href="#local-6989586621687554972"><span class="hs-identifier hs-var">eventIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr Int) -&gt; m (Either QErr Int)
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr Int) -&gt; m (Either QErr Int))
-&gt; IO (Either QErr Int) -&gt; m (Either QErr Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO Int -&gt; IO (Either QErr Int)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554971"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO Int -&gt; IO (Either QErr Int))
-&gt; TxET QErr IO Int -&gt; IO (Either QErr Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>      </span><span class="annot"><span class="annottext">[EventId] -&gt; TxET QErr IO Int
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsTx"><span class="hs-identifier hs-var">unlockEventsTx</span></a></span><span> </span><span class="annot"><span class="annottext">([EventId] -&gt; TxET QErr IO Int) -&gt; [EventId] -&gt; TxET QErr IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NESet EventId -&gt; [EventId]
forall a. NESet a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">NESet EventId
</span><a href="#local-6989586621687554972"><span class="hs-identifier hs-var">eventIds</span></a></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="hs-comment">-- Check if any trigger for any of the operation exists with the 'triggerName'</span><span>
</span><span id="line-306"></span><span id="local-6989586621687553911"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExists"><span class="hs-identifier hs-type">checkIfTriggerExists</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-307"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553911"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553911"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-a5b4fa803c841f948b5080a5c7a22f4e3b108a71ab10582fd155001f6f7ca093/share/doc/html/src/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HashSet</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><a href="#local-6989586621687553911"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-312"></span><span id="checkIfTriggerExists"><span class="annot"><span class="annottext">checkIfTriggerExists :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig -&gt; TriggerName -&gt; HashSet Ops -&gt; m Bool
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExists"><span class="hs-identifier hs-var hs-var">checkIfTriggerExists</span></a></span></span><span> </span><span id="local-6989586621687554985"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554985"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687554986"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554986"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687554987"><span class="annot"><span class="annottext">HashSet Ops
</span><a href="#local-6989586621687554987"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr Bool) -&gt; m Bool
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><span class="annottext">(m (Either QErr Bool) -&gt; m Bool) -&gt; m (Either QErr Bool) -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr Bool) -&gt; m (Either QErr Bool)
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either QErr Bool) -&gt; m (Either QErr Bool))
-&gt; IO (Either QErr Bool) -&gt; m (Either QErr Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxE QErr Bool -&gt; IO (Either QErr Bool)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687554985"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><span class="annottext">(TxE QErr Bool -&gt; IO (Either QErr Bool))
-&gt; TxE QErr Bool -&gt; IO (Either QErr Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Bool] -&gt; Bool) -&gt; TxET QErr IO [Bool] -&gt; TxE QErr Bool
forall a b. (a -&gt; b) -&gt; TxET QErr IO a -&gt; TxET QErr IO b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">or</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ops -&gt; TxE QErr Bool) -&gt; [Ops] -&gt; TxET QErr IO [Bool]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; Ops -&gt; TxE QErr Bool
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExistsQ"><span class="hs-identifier hs-var">checkIfTriggerExistsQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554986"><span class="hs-identifier hs-var">triggerName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet Ops -&gt; [Ops]
forall a. HashSet a -&gt; [a]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-a5b4fa803c841f948b5080a5c7a22f4e3b108a71ab10582fd155001f6f7ca093/share/doc/html/src/Data.HashSet.Internal.html#toList"><span class="hs-identifier hs-var">HashSet.toList</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet Ops
</span><a href="#local-6989586621687554987"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span class="hs-comment">---- DATABASE QUERIES ---------------------</span><span>
</span><span id="line-319"></span><span class="hs-comment">--</span><span>
</span><span id="line-320"></span><span class="hs-comment">--   The API for our in-database work queue:</span><span>
</span><span id="line-321"></span><span class="hs-comment">-------------------------------------------</span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-type">insertInvocation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span id="insertInvocation"><span class="annot"><span class="annottext">insertInvocation :: TriggerName -&gt; Invocation 'EventType -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-var hs-var">insertInvocation</span></a></span></span><span> </span><span id="local-6989586621687554992"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554992"><span class="hs-identifier hs-var">tName</span></a></span></span><span> </span><span id="local-6989586621687554993"><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687554993"><span class="hs-identifier hs-var">invo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      INSERT INTO hdb_catalog.event_invocation_logs (event_id, trigger_name, status, request, response)
          VALUES ($invoEventId, $invoTriggerName, $invoStatus, $invoRequest, $invoResponse)
    |]</span></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-333"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-334"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      UPDATE hdb_catalog.event_log

      SET tries = tries + 1
      WHERE id = $invoEventId
    |]</span></span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-341"></span><span>    </span><span id="local-6989586621687554994"><span class="annot"><span class="annottext">invoEventId :: Text
</span><a href="#local-6989586621687554994"><span class="hs-identifier hs-var hs-var">invoEventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; EventId
forall (a :: TriggerTypes). Invocation a -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#iEventId"><span class="hs-identifier hs-var">iEventId</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687554993"><span class="hs-identifier hs-var">invo</span></a></span><span>
</span><span id="line-342"></span><span>    </span><span id="local-6989586621687554995"><span class="annot"><span class="annottext">invoStatus :: Maybe Int
</span><a href="#local-6989586621687554995"><span class="hs-identifier hs-var hs-var">invoStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; Maybe Int -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; Maybe Int
forall (a :: TriggerTypes). Invocation a -&gt; Maybe Int
</span><a href="Hasura.RQL.Types.Eventing.html#iStatus"><span class="hs-identifier hs-var">iStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687554993"><span class="hs-identifier hs-var">invo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-343"></span><span>    </span><span id="local-6989586621687554996"><span class="annot"><span class="annottext">invoRequest :: ByteString
</span><a href="#local-6989586621687554996"><span class="hs-identifier hs-var hs-var">invoRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-78f82c0a41c76fc62260cf94c4b206816c9efb8c3788f4fbd6184398938cf6fb/share/doc/html/src/Data.Aeson.html#encode"><span class="hs-identifier hs-var">J.encode</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; ByteString) -&gt; Value -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WebhookRequest -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-78f82c0a41c76fc62260cf94c4b206816c9efb8c3788f4fbd6184398938cf6fb/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">J.toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">(WebhookRequest -&gt; Value) -&gt; WebhookRequest -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; WebhookRequest
forall (a :: TriggerTypes). Invocation a -&gt; WebhookRequest
</span><a href="Hasura.RQL.Types.Eventing.html#iRequest"><span class="hs-identifier hs-var">iRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687554993"><span class="hs-identifier hs-var">invo</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span id="local-6989586621687554997"><span class="annot"><span class="annottext">invoResponse :: ByteString
</span><a href="#local-6989586621687554997"><span class="hs-identifier hs-var hs-var">invoResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-78f82c0a41c76fc62260cf94c4b206816c9efb8c3788f4fbd6184398938cf6fb/share/doc/html/src/Data.Aeson.html#encode"><span class="hs-identifier hs-var">J.encode</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; ByteString) -&gt; Value -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Response 'EventType -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-78f82c0a41c76fc62260cf94c4b206816c9efb8c3788f4fbd6184398938cf6fb/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">J.toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">(Response 'EventType -&gt; Value) -&gt; Response 'EventType -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; Response 'EventType
forall (a :: TriggerTypes). Invocation a -&gt; Response a
</span><a href="Hasura.RQL.Types.Eventing.html#iResponse"><span class="hs-identifier hs-var">iResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621687554993"><span class="hs-identifier hs-var">invo</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span id="local-6989586621687554998"><span class="annot"><span class="annottext">invoTriggerName :: Text
</span><a href="#local-6989586621687554998"><span class="hs-identifier hs-var hs-var">invoTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687554992"><span class="hs-identifier hs-var">tName</span></a></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertMSSQLManualEventTx"><span class="hs-identifier hs-type">insertMSSQLManualEventTx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-348"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-349"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-350"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-78f82c0a41c76fc62260cf94c4b206816c9efb8c3788f4fbd6184398938cf6fb/share/doc/html/src/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-351"></span><span>  </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span>
</span><span id="line-352"></span><span id="insertMSSQLManualEventTx"><span class="annot"><span class="annottext">insertMSSQLManualEventTx :: TableName -&gt; TriggerName -&gt; Value -&gt; TxET QErr IO EventId
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertMSSQLManualEventTx"><span class="hs-identifier hs-var hs-var">insertMSSQLManualEventTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621687555007"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555007"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621687555008"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555008"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621687555009"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555009"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555010"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687555010"><span class="hs-identifier hs-var">rowData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-353"></span><span>  </span><span id="local-6989586621687555011"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555011"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-354"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ByteString
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span>
</span><span id="line-355"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-356"></span><span>      </span><span class="annot"><span class="">[ODBC.sql|
          INSERT INTO hdb_catalog.event_log (schema_name, table_name, trigger_name, payload)
          OUTPUT CONVERT(varchar(MAX), inserted.id)
          VALUES
          ($schemaName, $tableName, $triggerNameTxt, $payload)
        |]</span></span><span>
</span><span id="line-362"></span><span>  </span><span class="annot"><span class="annottext">EventId -&gt; TxET QErr IO EventId
forall a. a -&gt; TxET QErr IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-var">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#bsToTxt"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555011"><span class="hs-identifier hs-var">eventId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621687555012"><span class="annot"><span class="annottext">triggerNameTxt :: Text
</span><a href="#local-6989586621687555012"><span class="hs-identifier hs-var hs-var">triggerNameTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555009"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-365"></span><span>    </span><span id="local-6989586621687555013"><span class="annot"><span class="annottext">payload :: ByteString
</span><a href="#local-6989586621687555013"><span class="hs-identifier hs-var hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-78f82c0a41c76fc62260cf94c4b206816c9efb8c3788f4fbd6184398938cf6fb/share/doc/html/src/Data.Aeson.html#encode"><span class="hs-identifier hs-var">J.encode</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687555010"><span class="hs-identifier hs-var">rowData</span></a></span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setSuccessTx"><span class="hs-identifier hs-type">setSuccessTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span id="setSuccessTx"><span class="annot"><span class="annottext">setSuccessTx :: Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setSuccessTx"><span class="hs-identifier hs-var hs-var">setSuccessTx</span></a></span></span><span> </span><span id="local-6989586621687555016"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687555016"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#PreviousMMVersion"><span class="hs-identifier hs-var">PreviousMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected: no previous maintenance mode version found for MSSQL source&quot;</span></span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621687555021"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-371"></span><span>  </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621687555021"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-373"></span><span>    </span><span id="local-6989586621687555023"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621687555023"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687555016"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span>    </span><span id="local-6989586621687555021"><span class="annot"><span class="annottext">latestVersionSetSuccess :: TxET QErr IO ()
</span><a href="#local-6989586621687555021"><span class="hs-identifier hs-var hs-var">latestVersionSetSuccess</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-376"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-377"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-378"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.event_log
          SET delivered = 1 , next_retry_at = NULL, locked = NULL
          WHERE id = $eventId
        |]</span></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setErrorTx"><span class="hs-identifier hs-type">setErrorTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span id="setErrorTx"><span class="annot"><span class="annottext">setErrorTx :: Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setErrorTx"><span class="hs-identifier hs-var hs-var">setErrorTx</span></a></span></span><span> </span><span id="local-6989586621687555025"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687555025"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-386"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#PreviousMMVersion"><span class="hs-identifier hs-var">PreviousMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected: there is no previous maintenance mode version supported for MSSQL event triggers&quot;</span></span><span>
</span><span id="line-387"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621687555026"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-388"></span><span>  </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621687555026"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-390"></span><span>    </span><span id="local-6989586621687555027"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621687555027"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687555025"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span>    </span><span id="local-6989586621687555026"><span class="annot"><span class="annottext">latestVersionSetSuccess :: TxET QErr IO ()
</span><a href="#local-6989586621687555026"><span class="hs-identifier hs-var hs-var">latestVersionSetSuccess</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-393"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-394"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-395"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.event_log
          SET error = 1 , next_retry_at = NULL, locked = NULL
          WHERE id = $eventId
        |]</span></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-type">setRetryTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span id="setRetryTx"><span class="annot"><span class="annottext">setRetryTx :: Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-var hs-var">setRetryTx</span></a></span></span><span> </span><span id="local-6989586621687555028"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687555028"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621687555029"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555029"><span class="hs-identifier hs-var">utcTime</span></a></span></span><span> </span><span id="local-6989586621687555030"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687555030"><span class="hs-identifier hs-var">maintenanceMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-403"></span><span>  </span><span class="hs-comment">-- since `convertUTCToDatetime2` uses utc as timezone, it will not affect the value</span><span>
</span><span id="line-404"></span><span>  </span><span id="local-6989586621687555031"><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621687555031"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; TxET QErr IO Datetime2
forall (m :: * -&gt; *). MonadIO m =&gt; UTCTime -&gt; m Datetime2
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#convertUTCToDatetime2"><span class="hs-identifier hs-var">convertUTCToDatetime2</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555029"><span class="hs-identifier hs-var">utcTime</span></a></span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621687555030"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#PreviousMMVersion"><span class="hs-identifier hs-var">PreviousMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected: there is no previous maintenance mode version supported for MSSQL event triggers&quot;</span></span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Datetime2 -&gt; TxET QErr IO ()
</span><a href="#local-6989586621687555033"><span class="hs-identifier hs-var">latestVersionSetRetry</span></a></span><span> </span><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621687555031"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-408"></span><span>    </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Datetime2 -&gt; TxET QErr IO ()
</span><a href="#local-6989586621687555033"><span class="hs-identifier hs-var">latestVersionSetRetry</span></a></span><span> </span><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621687555031"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-410"></span><span>    </span><span id="local-6989586621687555034"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621687555034"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621687555028"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-comment">-- NOTE: Naveen: The following method to convert from Datetime to Datetimeoffset  was</span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-comment">-- taken from https://stackoverflow.com/questions/17866311/how-to-cast-datetime-to-datetimeoffset</span><span>
</span><span id="line-413"></span><span>    </span><span id="local-6989586621687555033"><span class="annot"><span class="annottext">latestVersionSetRetry :: Datetime2 -&gt; TxET QErr IO ()
</span><a href="#local-6989586621687555033"><span class="hs-identifier hs-var hs-var">latestVersionSetRetry</span></a></span></span><span> </span><span id="local-6989586621687555035"><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621687555035"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-comment">-- `time` is in UTC (without the timezone offset). The function TODATETIMEOFFSET adds the offset 00:00 (UTC) to</span><span>
</span><span id="line-415"></span><span>      </span><span class="hs-comment">-- `time`, which collectively represents the value present in next_retry_at</span><span>
</span><span id="line-416"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-417"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-418"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.event_log
          SET next_retry_at = TODATETIMEOFFSET ($time, 0), locked = NULL
          WHERE id = $eventId
        |]</span></span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span class="hs-comment">-- | Lock and return events not yet being processed or completed, up to some</span><span>
</span><span id="line-425"></span><span class="hs-comment">-- limit. Process events approximately in created_at order, but we make no</span><span>
</span><span id="line-426"></span><span class="hs-comment">-- ordering guarentees; events can and will race. Nevertheless we want to</span><span>
</span><span id="line-427"></span><span class="hs-comment">-- ensure newer change events don't starve older ones.</span><span>
</span><span id="line-428"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEvents"><span class="hs-identifier hs-type">fetchEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-type">FetchBatchSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-429"></span><span id="fetchEvents"><span class="annot"><span class="annottext">fetchEvents :: SourceName
-&gt; [TriggerName] -&gt; FetchBatchSize -&gt; TxET QErr IO [Event 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEvents"><span class="hs-identifier hs-var hs-var">fetchEvents</span></a></span></span><span> </span><span id="local-6989586621687555036"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687555036"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621687555037"><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621687555037"><span class="hs-identifier hs-var">triggerNames</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-type">FetchBatchSize</span></a></span><span> </span><span id="local-6989586621687555039"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555039"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-comment">-- The reason we do not inline the SQL but rather  create a template string is due</span><span>
</span><span id="line-431"></span><span>  </span><span class="hs-comment">-- to the problem with `ODBC.sql` variable substitution. When you use a variable</span><span>
</span><span id="line-432"></span><span>  </span><span class="hs-comment">-- whose value is a text and it contains a single quote `'`, the `ODBC.sql`</span><span>
</span><span id="line-433"></span><span>  </span><span class="hs-comment">-- function escapes that single quote. i.e it converts `'` to `''`</span><span>
</span><span id="line-434"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-comment">-- Note: A single quote in MSSQL is escaped by doubling it up (`''`)</span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-437"></span><span>  </span><span class="hs-comment">-- This is problematic, since we use a list of list of trigger names to fetch and</span><span>
</span><span id="line-438"></span><span>  </span><span class="hs-comment">-- lock the events. A list of trigger names in MSSQL looks like Eg:</span><span>
</span><span id="line-439"></span><span>  </span><span class="hs-comment">-- ('insert_test_books', 'et_test_bigint')</span><span>
</span><span id="line-440"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-comment">-- We use this list of trigger names in the `IN` operator to fetch only those</span><span>
</span><span id="line-442"></span><span>  </span><span class="hs-comment">-- events.</span><span>
</span><span id="line-443"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-comment">-- If we were to use the `ODBC.sql` function it would convert the list into</span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-comment">-- something which is not a valid list.</span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-comment">-- Eg: ('insert_test_books', 'et_test_bigint') -&gt; (''insert_test_books'', ''et_test_bigint'')</span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-448"></span><span>  </span><span class="hs-comment">-- Due to the problematic variable substitution of `ODBC.sql` it is imperative that</span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-comment">-- we resort to template strings, since that does not do any changes to the string.</span><span>
</span><span id="line-450"></span><span>  </span><span id="local-6989586621687555040"><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, Text, Int, ByteString,
  Maybe ByteString)]
</span><a href="#local-6989586621687555040"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-451"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, Text, Text, Text, Int, ByteString,
       Maybe ByteString)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-452"></span><span>      </span><span class="annot"><span class="annottext">(Query
 -&gt; TxET
      QErr
      IO
      [(ByteString, Text, Text, Text, Text, Int, ByteString,
        Maybe ByteString)])
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, Text, Text, Text, Int, ByteString,
       Maybe ByteString)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-453"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Lazy.html#toStrict"><span class="hs-identifier hs-var">LT.toStrict</span></a></span><span>
</span><span id="line-454"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_fetch_events.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span>  </span><span class="annot"><span class="annottext">((ByteString, Text, Text, Text, Text, Int, ByteString,
  Maybe ByteString)
 -&gt; TxET QErr IO (Event 'MSSQL))
-&gt; [(ByteString, Text, Text, Text, Text, Int, ByteString,
     Maybe ByteString)]
-&gt; TxET QErr IO [Event 'MSSQL]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(ByteString, Text, Text, Text, Text, Int, ByteString,
 Maybe ByteString)
-&gt; TxET QErr IO (Event 'MSSQL)
</span><a href="#local-6989586621687555050"><span class="hs-identifier hs-var">uncurryEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, Text, Int, ByteString,
  Maybe ByteString)]
</span><a href="#local-6989586621687555040"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-456"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-457"></span><span>    </span><span class="hs-comment">-- Creates a list of trigger names to be used for 'IN' operator</span><span>
</span><span id="line-458"></span><span>    </span><span class="hs-comment">-- Eg: ('insert_test_books', 'et_test_bigint')</span><span>
</span><span id="line-459"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-460"></span><span>    </span><span class="hs-comment">-- We cannot use 'commaseperated()' because it creates the Text as</span><span>
</span><span id="line-461"></span><span>    </span><span class="hs-comment">-- 'insert_test_books, et_test_bigint' which is not useful to compare values in</span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-comment">-- 'IN' MSSQL operator.</span><span>
</span><span id="line-463"></span><span>    </span><span id="local-6989586621687555043"><span class="annot"><span class="annottext">triggerNamesTxt :: Text
</span><a href="#local-6989586621687555043"><span class="hs-identifier hs-var hs-var">triggerNamesTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;(&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TriggerName -&gt; Text) -&gt; [TriggerName] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621687555051"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555051"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555051"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621687555037"><span class="hs-identifier hs-var">triggerNames</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-464"></span><span>
</span><span id="line-465"></span><span>    </span><span id="local-6989586621687555050"><span class="annot"><span class="annottext">uncurryEvent :: (ByteString, Text, Text, Text, Text, Int, ByteString,
 Maybe ByteString)
-&gt; TxET QErr IO (Event 'MSSQL)
</span><a href="#local-6989586621687555050"><span class="hs-identifier hs-var hs-var">uncurryEvent</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687555052"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555052"><span class="hs-identifier hs-var">eventId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555053"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555053"><span class="hs-identifier hs-var">sn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555054"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555054"><span class="hs-identifier hs-var">tn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555055"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555055"><span class="hs-identifier hs-var">trn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555056"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555056"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555057"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555057"><span class="hs-identifier hs-var">tries</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555058"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555058"><span class="hs-identifier hs-var">createdAt</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555059"><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621687555059"><span class="hs-identifier hs-var">nextRetryAt</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-466"></span><span>      </span><span class="hs-comment">-- see Note [Encode Event Trigger Payload to JSON in SQL Server]</span><span>
</span><span id="line-467"></span><span>      </span><span id="local-6989586621687555060"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687555060"><span class="hs-identifier hs-var">payload'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String -&gt; TxET QErr IO Value
forall a (m :: * -&gt; *).
(FromJSON a, QErrM m) =&gt;
Text -&gt; String -&gt; m a
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#encodeJSON"><span class="hs-identifier hs-var">encodeJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555056"><span class="hs-identifier hs-var">payload</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;payload decode failed while fetching MSSQL events&quot;</span></span><span>
</span><span id="line-468"></span><span>      </span><span id="local-6989586621687555062"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555062"><span class="hs-identifier hs-var">createdAt'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; String -&gt; TxET QErr IO UTCTime
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
ByteString -&gt; String -&gt; m UTCTime
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#bsToUTCTime"><span class="hs-identifier hs-var">bsToUTCTime</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555058"><span class="hs-identifier hs-var">createdAt</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;conversion of created_at to UTCTime failed while fetching MSSQL events&quot;</span></span><span>
</span><span id="line-469"></span><span>      </span><span id="local-6989586621687555064"><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621687555064"><span class="hs-identifier hs-var">retryAt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; TxET QErr IO UTCTime)
-&gt; Maybe ByteString -&gt; TxET QErr IO (Maybe UTCTime)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; Maybe a -&gt; f (Maybe b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; String -&gt; TxET QErr IO UTCTime
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
ByteString -&gt; String -&gt; m UTCTime
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#bsToUTCTime"><span class="hs-operator hs-var">`bsToUTCTime`</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;conversion of next_retry_at to UTCTime failed while fetching MSSQL events&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621687555059"><span class="hs-identifier hs-var">nextRetryAt</span></a></span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span>      </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; TxET QErr IO (Event 'MSSQL)
forall a. a -&gt; TxET QErr IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-472"></span><span>        </span><span class="annot"><span class="annottext">(Event 'MSSQL -&gt; TxET QErr IO (Event 'MSSQL))
-&gt; Event 'MSSQL -&gt; TxET QErr IO (Event 'MSSQL)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span>
</span><span id="line-473"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eId :: EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-var">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#bsToTxt"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555052"><span class="hs-identifier hs-var">eventId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-474"></span><span>            </span><span class="annot"><span class="annottext">eSource :: SourceName
</span><a href="Hasura.RQL.Types.EventTrigger.html#eSource"><span class="hs-identifier hs-var">eSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687555036"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-475"></span><span>            </span><span class="annot"><span class="annottext">eTable :: TableName 'MSSQL
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTable"><span class="hs-identifier hs-var">eTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; SchemaName -&gt; TableName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-var">TableName</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555054"><span class="hs-identifier hs-var">tn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; SchemaName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-var">SchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555053"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-476"></span><span>            </span><span class="annot"><span class="annottext">eTrigger :: TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerMetadata"><span class="hs-identifier hs-var">TriggerMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmptyText -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-var">TriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmptyText -&gt; TriggerName) -&gt; NonEmptyText -&gt; TriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; NonEmptyText
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier hs-var">mkNonEmptyTextUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555055"><span class="hs-identifier hs-var">trn</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-477"></span><span>            </span><span class="annot"><span class="annottext">eEvent :: Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eEvent"><span class="hs-identifier hs-var">eEvent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687555060"><span class="hs-identifier hs-var">payload'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-478"></span><span>            </span><span class="annot"><span class="annottext">eTries :: Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTries"><span class="hs-identifier hs-var">eTries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555057"><span class="hs-identifier hs-var">tries</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-479"></span><span>            </span><span class="annot"><span class="annottext">eCreatedAt :: LocalTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eCreatedAt"><span class="hs-identifier hs-var">eCreatedAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeZone -&gt; UTCTime -&gt; LocalTime
</span><span class="hs-identifier hs-var">utcToLocalTime</span></span><span> </span><span class="annot"><span class="annottext">TimeZone
</span><span class="hs-identifier hs-var">utc</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555062"><span class="hs-identifier hs-var">createdAt'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-480"></span><span>            </span><span class="annot"><span class="annottext">eRetryAt :: Maybe UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eRetryAt"><span class="hs-identifier hs-var">eRetryAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621687555064"><span class="hs-identifier hs-var">retryAt</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-481"></span><span>            </span><span class="annot"><span class="annottext">eCreatedAtUTC :: UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eCreatedAtUTC"><span class="hs-identifier hs-var">eCreatedAtUTC</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555062"><span class="hs-identifier hs-var">createdAt'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-482"></span><span>            </span><span class="annot"><span class="annottext">eRetryAtUTC :: Maybe UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eRetryAtUTC"><span class="hs-identifier hs-var">eRetryAtUTC</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621687555064"><span class="hs-identifier hs-var">retryAt</span></a></span><span>
</span><span id="line-483"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier hs-type">dropTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span id="dropTriggerQ"><span class="annot"><span class="annottext">dropTriggerQ :: TriggerName -&gt; SchemaName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier hs-var hs-var">dropTriggerQ</span></a></span></span><span> </span><span id="local-6989586621687555078"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555078"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555079"><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621687555079"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-487"></span><span>  </span><span class="annot"><span class="annottext">(Ops -&gt; TxET QErr IO ()) -&gt; [Ops] -&gt; TxET QErr IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SchemaName -&gt; Ops -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-var">dropTriggerOp</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555078"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621687555079"><span class="hs-identifier hs-var">schemaName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-type">dropTriggerOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span id="dropTriggerOp"><span class="annot"><span class="annottext">dropTriggerOp :: TriggerName -&gt; SchemaName -&gt; Ops -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-var hs-var">dropTriggerOp</span></a></span></span><span> </span><span id="local-6989586621687555081"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555081"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555082"><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621687555082"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span> </span><span id="local-6989586621687555083"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687555083"><span class="hs-identifier hs-var">triggerOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-491"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-492"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-493"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
</span><a href="#local-6989586621687555084"><span class="hs-identifier hs-var">getDropTriggerSQL</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687555083"><span class="hs-identifier hs-var">triggerOp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-495"></span><span>    </span><span class="annot"><a href="#local-6989586621687555084"><span class="hs-identifier hs-type">getDropTriggerSQL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-496"></span><span>    </span><span id="local-6989586621687555084"><span class="annot"><span class="annottext">getDropTriggerSQL :: Ops -&gt; Text
</span><a href="#local-6989586621687555084"><span class="hs-identifier hs-var hs-var">getDropTriggerSQL</span></a></span></span><span> </span><span id="local-6989586621687555085"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687555085"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-497"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DROP TRIGGER IF EXISTS &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifiedTriggerNameToText"><span class="hs-identifier hs-var">qualifiedTriggerNameToText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaName -&gt; SQLTriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621687555082"><span class="hs-identifier hs-var">schemaName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; Ops -&gt; SQLTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkSQLTriggerName"><span class="hs-identifier hs-var">mkSQLTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555081"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687555085"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#archiveEvents"><span class="hs-identifier hs-type">archiveEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span id="archiveEvents"><span class="annot"><span class="annottext">archiveEvents :: TriggerName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#archiveEvents"><span class="hs-identifier hs-var hs-var">archiveEvents</span></a></span></span><span> </span><span id="local-6989586621687555089"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555089"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-501"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-502"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-503"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      UPDATE hdb_catalog.event_log
      SET archived = 1
      WHERE trigger_name = $triggerNameTxt
    |]</span></span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-509"></span><span>    </span><span id="local-6989586621687555090"><span class="annot"><span class="annottext">triggerNameTxt :: Text
</span><a href="#local-6989586621687555090"><span class="hs-identifier hs-var hs-var">triggerNameTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555089"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkEventTx"><span class="hs-identifier hs-type">checkEventTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span id="checkEventTx"><span class="annot"><span class="annottext">checkEventTx :: EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkEventTx"><span class="hs-identifier hs-var hs-var">checkEventTx</span></a></span></span><span> </span><span id="local-6989586621687555091"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687555091"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-comment">-- If an event got locked within the last 30 minutes then it means that the event</span><span>
</span><span id="line-514"></span><span>  </span><span class="hs-comment">-- got picked up by during the last fetch-event poll and is being processed. Hence</span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-comment">-- we do not allow the redelivery of such an event.</span><span>
</span><span id="line-516"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621687555092"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621687555092"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-517"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Bool]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-518"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-519"></span><span>      </span><span class="annot"><span class="">[ODBC.sql|
        SELECT
          CAST(CASE
                  WHEN (l.locked IS NOT NULL AND l.locked &gt;= DATEADD(MINUTE, -30, SYSDATETIMEOFFSET())) THEN 1 ELSE 0
              END
          AS bit)
        FROM hdb_catalog.event_log l
        WHERE l.id = $eId
      |]</span></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span>  </span><span id="local-6989586621687555094"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555094"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; TxE QErr Bool
forall {m :: * -&gt; *} {a}. MonadError QErr m =&gt; [a] -&gt; m a
</span><a href="#local-6989586621687555095"><span class="hs-identifier hs-var">getEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621687555092"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-530"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr IO ()
forall {f :: * -&gt; *}. MonadError QErr f =&gt; Bool -&gt; f ()
</span><a href="#local-6989586621687555096"><span class="hs-identifier hs-var">assertEventUnlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555094"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-531"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-532"></span><span>    </span><span id="local-6989586621687555093"><span class="annot"><span class="annottext">eId :: Text
</span><a href="#local-6989586621687555093"><span class="hs-identifier hs-var hs-var">eId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687555091"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span>    </span><span id="local-6989586621687555095"><span class="annot"><span class="annottext">getEvent :: [a] -&gt; m a
</span><a href="#local-6989586621687555095"><span class="hs-identifier hs-var hs-var">getEvent</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m a
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#NotExists"><span class="hs-identifier hs-var">NotExists</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event not found&quot;</span></span><span>
</span><span id="line-535"></span><span>    </span><span class="annot"><a href="#local-6989586621687555095"><span class="hs-identifier hs-var">getEvent</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687555114"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621687555114"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621687555114"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span>    </span><span id="local-6989586621687555096"><span class="annot"><span class="annottext">assertEventUnlocked :: Bool -&gt; f ()
</span><a href="#local-6989586621687555096"><span class="hs-identifier hs-var hs-var">assertEventUnlocked</span></a></span></span><span> </span><span id="local-6989586621687555126"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555126"><span class="hs-identifier hs-var">locked</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-538"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; f () -&gt; f ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555126"><span class="hs-identifier hs-var">locked</span></a></span><span>
</span><span id="line-539"></span><span>        </span><span class="annot"><span class="annottext">(f () -&gt; f ()) -&gt; f () -&gt; f ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; f ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#Busy"><span class="hs-identifier hs-var">Busy</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event is already being processed&quot;</span></span><span>
</span><span id="line-540"></span><span>
</span><span id="line-541"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markForDeliveryTx"><span class="hs-identifier hs-type">markForDeliveryTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span id="markForDeliveryTx"><span class="annot"><span class="annottext">markForDeliveryTx :: EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markForDeliveryTx"><span class="hs-identifier hs-var hs-var">markForDeliveryTx</span></a></span></span><span> </span><span id="local-6989586621687555129"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687555129"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-543"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-544"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-545"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      UPDATE hdb_catalog.event_log
      SET delivered = 0, error = 0, tries = 0
      WHERE id = $eId
    |]</span></span><span>
</span><span id="line-550"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-551"></span><span>    </span><span id="local-6989586621687555130"><span class="annot"><span class="annottext">eId :: Text
</span><a href="#local-6989586621687555130"><span class="hs-identifier hs-var hs-var">eId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687555129"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-552"></span><span>
</span><span id="line-553"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsTx"><span class="hs-identifier hs-type">unlockEventsTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-554"></span><span id="unlockEventsTx"><span class="annot"><span class="annottext">unlockEventsTx :: [EventId] -&gt; TxET QErr IO Int
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsTx"><span class="hs-identifier hs-var hs-var">unlockEventsTx</span></a></span></span><span> </span><span id="local-6989586621687555131"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621687555131"><span class="hs-identifier hs-var">eventIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-555"></span><span>  </span><span id="local-6989586621687555132"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555132"><span class="hs-identifier hs-var">numEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-556"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO Int
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-557"></span><span>      </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO Int) -&gt; Query -&gt; TxET QErr IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-558"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Lazy.html#toStrict"><span class="hs-identifier hs-var">LT.toStrict</span></a></span><span>
</span><span id="line-559"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-560"></span><span>      </span><span class="hs-comment">-- EventIds as list of VALUES (Eg: ('123-abc'), ('456-vgh'), ('234-asd'))</span><span>
</span><span id="line-561"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555133"><span class="annot"><span class="annottext">eventIdsValues :: Text
</span><a href="#local-6989586621687555133"><span class="hs-identifier hs-var hs-var">eventIdsValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EventId] -&gt; Text
</span><a href="#local-6989586621687555134"><span class="hs-identifier hs-var">generateValuesFromEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621687555131"><span class="hs-identifier hs-var">eventIds</span></a></span><span>
</span><span id="line-562"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_unlock_events.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-563"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; TxET QErr IO Int
forall a. a -&gt; TxET QErr IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555132"><span class="hs-identifier hs-var">numEvents</span></a></span><span>
</span><span id="line-564"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-565"></span><span>    </span><span class="annot"><a href="#local-6989586621687555134"><span class="hs-identifier hs-type">generateValuesFromEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-comment">-- creates a list of event id's  (('123-abc'), ('456-vgh'), ('234-asd'))</span><span>
</span><span id="line-567"></span><span>    </span><span id="local-6989586621687555134"><span class="annot"><span class="annottext">generateValuesFromEvents :: [EventId] -&gt; Text
</span><a href="#local-6989586621687555134"><span class="hs-identifier hs-var hs-var">generateValuesFromEvents</span></a></span></span><span> </span><span id="local-6989586621687555135"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621687555135"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687555136"><span class="hs-identifier hs-var">values</span></a></span><span>
</span><span id="line-568"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-569"></span><span>        </span><span id="local-6989586621687555136"><span class="annot"><span class="annottext">values :: [Text]
</span><a href="#local-6989586621687555136"><span class="hs-identifier hs-var hs-var">values</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; [EventId] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621687555137"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687555137"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;(&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687555137"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;)&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621687555135"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-570"></span><span>
</span><span id="line-571"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersionTx"><span class="hs-identifier hs-type">getMaintenanceModeVersionTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span>
</span><span id="line-572"></span><span id="getMaintenanceModeVersionTx"><span class="annot"><span class="annottext">getMaintenanceModeVersionTx :: TxET QErr IO MaintenanceModeVersion
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersionTx"><span class="hs-identifier hs-var hs-var">getMaintenanceModeVersionTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-573"></span><span>  </span><span id="local-6989586621687555138"><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="#local-6989586621687555138"><span class="hs-identifier hs-var">catalogVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO SourceCatalogVersion
forall (m :: * -&gt; *). MonadMSSQLTx m =&gt; m SourceCatalogVersion
</span><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html#getSourceCatalogVersion"><span class="hs-identifier hs-var">getSourceCatalogVersion</span></a></span><span>
</span><span id="line-574"></span><span>  </span><span class="hs-keyword">if</span><span>
</span><span id="line-575"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="#local-6989586621687555138"><span class="hs-identifier hs-var">catalogVersion</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion -&gt; SourceCatalogVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html#latestSourceCatalogVersion"><span class="hs-identifier hs-var">latestSourceCatalogVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion -&gt; TxET QErr IO MaintenanceModeVersion
forall a. a -&gt; TxET QErr IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span>
</span><span id="line-576"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-577"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO MaintenanceModeVersion
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span>
</span><span id="line-578"></span><span>          </span><span class="annot"><span class="annottext">(Text -&gt; TxET QErr IO MaintenanceModeVersion)
-&gt; Text -&gt; TxET QErr IO MaintenanceModeVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Maintenance mode is only supported with catalog versions: &quot;</span></span><span>
</span><span id="line-579"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html#latestSourceCatalogVersion"><span class="hs-identifier hs-var">latestSourceCatalogVersion</span></a></span><span>
</span><span id="line-580"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; but received &quot;</span></span><span>
</span><span id="line-581"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="#local-6989586621687555138"><span class="hs-identifier hs-var">catalogVersion</span></a></span><span>
</span><span id="line-582"></span><span>
</span><span id="line-583"></span><span id="local-6989586621687553942"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#convertUTCToDatetime2"><span class="hs-identifier hs-type">convertUTCToDatetime2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687553942"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687553942"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#Datetime2"><span class="hs-identifier hs-type">Datetime2</span></a></span></span><span>
</span><span id="line-584"></span><span id="convertUTCToDatetime2"><span class="annot"><span class="annottext">convertUTCToDatetime2 :: forall (m :: * -&gt; *). MonadIO m =&gt; UTCTime -&gt; m Datetime2
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#convertUTCToDatetime2"><span class="hs-identifier hs-var hs-var">convertUTCToDatetime2</span></a></span></span><span> </span><span id="local-6989586621687555144"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555144"><span class="hs-identifier hs-var">utcTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-585"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555145"><span class="annot"><span class="annottext">localTime :: LocalTime
</span><a href="#local-6989586621687555145"><span class="hs-identifier hs-var hs-var">localTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeZone -&gt; UTCTime -&gt; LocalTime
</span><span class="hs-identifier hs-var">utcToLocalTime</span></span><span> </span><span class="annot"><span class="annottext">TimeZone
</span><span class="hs-identifier hs-var">utc</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555144"><span class="hs-identifier hs-var">utcTime</span></a></span><span>
</span><span id="line-586"></span><span>  </span><span class="annot"><span class="annottext">Datetime2 -&gt; m Datetime2
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Datetime2 -&gt; m Datetime2) -&gt; Datetime2 -&gt; m Datetime2
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LocalTime -&gt; Datetime2
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#Datetime2"><span class="hs-identifier hs-var">Datetime2</span></a></span><span> </span><span class="annot"><span class="annottext">LocalTime
</span><a href="#local-6989586621687555145"><span class="hs-identifier hs-var">localTime</span></a></span><span>
</span><span id="line-587"></span><span>
</span><span id="line-588"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExistsQ"><span class="hs-identifier hs-type">checkIfTriggerExistsQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-589"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-590"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-591"></span><span>  </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-592"></span><span id="checkIfTriggerExistsQ"><span class="annot"><span class="annottext">checkIfTriggerExistsQ :: TriggerName -&gt; Ops -&gt; TxE QErr Bool
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkIfTriggerExistsQ"><span class="hs-identifier hs-var hs-var">checkIfTriggerExistsQ</span></a></span></span><span> </span><span id="local-6989586621687555147"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555147"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555148"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687555148"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-593"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555149"><span class="annot"><span class="annottext">triggerNameWithOp :: Text
</span><a href="#local-6989586621687555149"><span class="hs-identifier hs-var hs-var">triggerNameWithOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;notify_hasura_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555147"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687555148"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-594"></span><span>  </span><span class="annot"><span class="annottext">TxE QErr Bool -&gt; TxE QErr Bool
forall a. TxE QErr a -&gt; TxE QErr a
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span>
</span><span id="line-595"></span><span>    </span><span class="annot"><span class="annottext">(TxE QErr Bool -&gt; TxE QErr Bool) -&gt; TxE QErr Bool -&gt; TxE QErr Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxE QErr Bool
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span>
</span><span id="line-596"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-597"></span><span>      </span><span class="hs-comment">-- We check the existence of trigger across the entire database irrespective of</span><span>
</span><span id="line-598"></span><span>      </span><span class="hs-comment">-- the schema of the table</span><span>
</span><span id="line-599"></span><span>      </span><span class="annot"><span class="">[ODBC.sql|
          SELECT CASE WHEN EXISTS
            ( SELECT 1
              FROM sys.triggers WHERE name = $triggerNameWithOp
            )
          THEN CAST(1 AS BIT)
          ELSE CAST(0 AS BIT)
          END;
        |]</span></span><span>
</span><span id="line-608"></span><span>
</span><span id="line-609"></span><span class="hs-comment">---- MSSQL event trigger utility functions -----------------</span><span>
</span><span id="line-610"></span><span>
</span><span id="line-611"></span><span class="hs-comment">-- | This will quote the object name (similar to the @QUOTENAME@ function in SQL</span><span>
</span><span id="line-612"></span><span class="hs-comment">-- server), i.e.</span><span>
</span><span id="line-613"></span><span class="hs-comment">--</span><span>
</span><span id="line-614"></span><span class="hs-comment">-- &gt;&gt;&gt; mssqlFmtIdentifier &quot;object_name&quot; &quot;[object_name]&quot;</span><span>
</span><span id="line-615"></span><span class="hs-comment">--</span><span>
</span><span id="line-616"></span><span class="hs-comment">-- &gt;&gt;&gt; mssqlFmtIdentifier &quot;o]bject_nam[e&quot; &quot;[o]]bject_nam[e]&quot;</span><span>
</span><span id="line-617"></span><span class="hs-comment">--</span><span>
</span><span id="line-618"></span><span class="hs-comment">-- TODO: Use some external tool for quoting, we should not quote the names by</span><span>
</span><span id="line-619"></span><span class="hs-comment">-- ourselves.</span><span>
</span><span id="line-620"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mssqlFmtIdentifier"><span class="hs-identifier hs-type">mssqlFmtIdentifier</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-621"></span><span id="mssqlFmtIdentifier"><span class="annot"><span class="annottext">mssqlFmtIdentifier :: Text -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mssqlFmtIdentifier"><span class="hs-identifier hs-var hs-var">mssqlFmtIdentifier</span></a></span></span><span> </span><span id="local-6989586621687555151"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555151"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-622"></span><span>  </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;[&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Text -&gt; Text -&gt; Text -&gt; Text
Text -&gt; Text -&gt; Text -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.html#replace"><span class="hs-identifier hs-var">T.replace</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;]&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;]]&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555151"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;]&quot;</span></span><span>
</span><span id="line-623"></span><span>
</span><span id="line-624"></span><span class="annot"><span class="hs-comment">-- | A Representation of SQL Trigger name for an event trigger in MSSQL.</span></span><span>
</span><span id="line-625"></span><span class="hs-keyword">newtype</span><span> </span><span id="SQLTriggerName"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLTriggerName"><span class="hs-identifier hs-var">SQLTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SQLTriggerName"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLTriggerName"><span class="hs-identifier hs-var">SQLTriggerName</span></a></span></span><span> </span><span class="hs-special">{</span><span id="getSQLTriggerName"><span class="annot"><span class="annottext">SQLTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getSQLTriggerName"><span class="hs-identifier hs-var hs-var">getSQLTriggerName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-626"></span><span>
</span><span id="line-627"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.SQL.Types.html#ToSQL"><span class="hs-identifier hs-type">ToSQL</span></a></span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLTriggerName"><span class="hs-identifier hs-type">SQLTriggerName</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-628"></span><span>  </span><span id="local-6989586621687555158"><span class="annot"><span class="annottext">toSQL :: SQLTriggerName -&gt; Builder
</span><a href="#local-6989586621687555158"><span class="hs-identifier hs-var hs-var hs-var hs-var">toSQL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Builder
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-builder-0.6.7-600e88586f2b8b8ba5978e29b81dad60794b520a441bee09070d353e619b7d27/share/doc/html/src/Text.Builder.html#text"><span class="hs-identifier hs-var">TB.text</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Builder)
-&gt; (SQLTriggerName -&gt; Text) -&gt; SQLTriggerName -&gt; Builder
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mssqlFmtIdentifier"><span class="hs-identifier hs-var">mssqlFmtIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text)
-&gt; (SQLTriggerName -&gt; Text) -&gt; SQLTriggerName -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SQLTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getSQLTriggerName"><span class="hs-identifier hs-var">getSQLTriggerName</span></a></span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkSQLTriggerName"><span class="hs-identifier hs-type">mkSQLTriggerName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLTriggerName"><span class="hs-identifier hs-type">SQLTriggerName</span></a></span><span>
</span><span id="line-631"></span><span id="mkSQLTriggerName"><span class="annot"><span class="annottext">mkSQLTriggerName :: TriggerName -&gt; Ops -&gt; SQLTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkSQLTriggerName"><span class="hs-identifier hs-var hs-var">mkSQLTriggerName</span></a></span></span><span> </span><span id="local-6989586621687555161"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555161"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555162"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687555162"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; SQLTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLTriggerName"><span class="hs-identifier hs-var">SQLTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLTriggerName) -&gt; Text -&gt; SQLTriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;notify_hasura_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555161"><span class="hs-identifier hs-var">triggerName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621687555162"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-632"></span><span>
</span><span id="line-633"></span><span class="annot"><span class="hs-comment">-- | A Representation of qualified SQL trigger object (`schema_name.SQL_trigger_name`).</span></span><span>
</span><span id="line-634"></span><span class="hs-keyword">data</span><span> </span><span id="QualifiedTriggerName"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="QualifiedTriggerName"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span></span><span>
</span><span id="line-635"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_qtnSchemaName"><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; SchemaName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#_qtnSchemaName"><span class="hs-identifier hs-var hs-var">_qtnSchemaName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-636"></span><span>    </span><span id="_qtnTriggerName"><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; SQLTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#_qtnTriggerName"><span class="hs-identifier hs-var hs-var">_qtnTriggerName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLTriggerName"><span class="hs-identifier hs-type">SQLTriggerName</span></a></span><span>
</span><span id="line-637"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-638"></span><span>
</span><span id="line-639"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.SQL.Types.html#ToSQL"><span class="hs-identifier hs-type">ToSQL</span></a></span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-640"></span><span>  </span><span id="local-6989586621687555172"><span class="annot"><span class="annottext">toSQL :: QualifiedTriggerName -&gt; Builder
</span><a href="Hasura.SQL.Types.html#toSQL"><span class="hs-identifier hs-var hs-var hs-var hs-var">toSQL</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621687555173"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555173"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621687555174"><span class="annot"><span class="annottext">SQLTriggerName
</span><a href="#local-6989586621687555174"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-641"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Builder
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-builder-0.6.7-600e88586f2b8b8ba5978e29b81dad60794b520a441bee09070d353e619b7d27/share/doc/html/src/Text.Builder.html#text"><span class="hs-identifier hs-var">TB.text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mssqlFmtIdentifier"><span class="hs-identifier hs-var">mssqlFmtIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555173"><span class="hs-identifier hs-var">schemaName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SQLTriggerName -&gt; Builder
forall a. ToSQL a =&gt; a -&gt; Builder
</span><a href="Hasura.SQL.Types.html#toSQL"><span class="hs-identifier hs-var">toSQL</span></a></span><span> </span><span class="annot"><span class="annottext">SQLTriggerName
</span><a href="#local-6989586621687555174"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifiedTriggerNameToText"><span class="hs-identifier hs-type">qualifiedTriggerNameToText</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-644"></span><span id="qualifiedTriggerNameToText"><span class="annot"><span class="annottext">qualifiedTriggerNameToText :: QualifiedTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifiedTriggerNameToText"><span class="hs-identifier hs-var hs-var">qualifiedTriggerNameToText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-builder-0.6.7-600e88586f2b8b8ba5978e29b81dad60794b520a441bee09070d353e619b7d27/share/doc/html/src/Text.Builder.html#run"><span class="hs-identifier hs-var">TB.run</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; Text)
-&gt; (QualifiedTriggerName -&gt; Builder)
-&gt; QualifiedTriggerName
-&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; Builder
forall a. ToSQL a =&gt; a -&gt; Builder
</span><a href="Hasura.SQL.Types.html#toSQL"><span class="hs-identifier hs-var">toSQL</span></a></span><span>
</span><span id="line-645"></span><span>
</span><span id="line-646"></span><span class="annot"><span class="hs-comment">-- | Store a fragment of SQL expression</span></span><span>
</span><span id="line-647"></span><span class="hs-keyword">newtype</span><span> </span><span id="SQLFragment"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SQLFragment"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unSQLFragment"><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-648"></span><span>
</span><span id="line-649"></span><span id="local-6989586621687553887"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-type">mkAllTriggersQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-650"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553887"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-651"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-652"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-653"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#TriggerOnReplication"><span class="hs-identifier hs-type">TriggerOnReplication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-654"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-655"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerOpsDef"><span class="hs-identifier hs-type">TriggerOpsDef</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-656"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-657"></span><span>  </span><span class="annot"><a href="#local-6989586621687553887"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-658"></span><span id="mkAllTriggersQ"><span class="annot"><span class="annottext">mkAllTriggersQ :: forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; TriggerOnReplication
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-var hs-var">mkAllTriggersQ</span></a></span></span><span> </span><span id="local-6989586621687555194"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555194"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555195"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555195"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621687555196"><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555196"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span></span><span> </span><span id="local-6989586621687555197"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555197"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621687555198"><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621687555198"><span class="hs-identifier hs-var">fullSpec</span></a></span></span><span> </span><span id="local-6989586621687555199"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621687555199"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-659"></span><span>  </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdInsert"><span class="hs-identifier hs-var">tdInsert</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621687555198"><span class="hs-identifier hs-var">fullSpec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-var">mkInsertTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555194"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555195"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555197"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555196"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-660"></span><span>  </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdDelete"><span class="hs-identifier hs-var">tdDelete</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621687555198"><span class="hs-identifier hs-var">fullSpec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-var">mkDeleteTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555194"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555195"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555197"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555196"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-661"></span><span>  </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdUpdate"><span class="hs-identifier hs-var">tdUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621687555198"><span class="hs-identifier hs-var">fullSpec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-var">mkUpdateTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555194"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555195"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555197"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555196"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621687555199"><span class="hs-identifier hs-var">primaryKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span>
</span><span id="line-663"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-type">getApplicableColumns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeColumns"><span class="hs-identifier hs-type">SubscribeColumns</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-664"></span><span id="getApplicableColumns"><span class="annot"><span class="annottext">getApplicableColumns :: [ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var hs-var">getApplicableColumns</span></a></span></span><span> </span><span id="local-6989586621687555201"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555201"><span class="hs-identifier hs-var">allColumnInfos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-665"></span><span>  </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555201"><span class="hs-identifier hs-var">allColumnInfos</span></a></span><span>
</span><span id="line-666"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubCArray"><span class="hs-identifier hs-type">SubCArray</span></a></span><span> </span><span id="local-6989586621687555204"><span class="annot"><span class="annottext">[Column 'MSSQL]
</span><a href="#local-6989586621687555204"><span class="hs-identifier hs-var">cols</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Column 'MSSQL] -&gt; [ColumnInfo 'MSSQL] -&gt; [ColumnInfo 'MSSQL]
forall (b :: BackendType).
Backend b =&gt;
[Column b] -&gt; [ColumnInfo b] -&gt; [ColumnInfo b]
</span><a href="Hasura.RQL.Types.Column.html#getColInfos"><span class="hs-identifier hs-var">getColInfos</span></a></span><span> </span><span class="annot"><span class="annottext">[Column 'MSSQL]
</span><a href="#local-6989586621687555204"><span class="hs-identifier hs-var">cols</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555201"><span class="hs-identifier hs-var">allColumnInfos</span></a></span><span>
</span><span id="line-667"></span><span>
</span><span id="line-668"></span><span class="hs-comment">-- | Currently we do not support Event Triggers on columns of Spatial data types.</span><span>
</span><span id="line-669"></span><span class="hs-comment">-- We do this because, currently the graphQL API for these types is broken</span><span>
</span><span id="line-670"></span><span class="hs-comment">-- for MSSQL sources. Ref: https://github.com/hasura/graphql-engine-mono/issues/787</span><span>
</span><span id="line-671"></span><span id="local-6989586621687553986"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-type">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-672"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553986"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-673"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-674"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-675"></span><span>  </span><span class="annot"><a href="#local-6989586621687553986"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-676"></span><span id="checkSpatialDataTypeColumns"><span class="annot"><span class="annottext">checkSpatialDataTypeColumns :: forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var hs-var">checkSpatialDataTypeColumns</span></a></span></span><span> </span><span id="local-6989586621687555216"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555216"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621687555218"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621687555218"><span class="hs-identifier hs-var">listenCols</span></a></span></span><span> </span><span id="local-6989586621687555219"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621687555219"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-677"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555220"><span class="annot"><span class="annottext">listenColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555220"><span class="hs-identifier hs-var hs-var">listenColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555216"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621687555218"><span class="hs-identifier hs-var">listenCols</span></a></span><span>
</span><span id="line-678"></span><span>      </span><span id="local-6989586621687555221"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555221"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555216"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621687555219"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-679"></span><span>      </span><span id="local-6989586621687555223"><span class="annot"><span class="annottext">isGeoTypesInListenCols :: Bool
</span><a href="#local-6989586621687555223"><span class="hs-identifier hs-var hs-var">isGeoTypesInListenCols</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Bool) -&gt; [ColumnInfo 'MSSQL] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ScalarType 'MSSQL -&gt; Bool) -&gt; ColumnType 'MSSQL -&gt; Bool
forall (b :: BackendType).
(ScalarType b -&gt; Bool) -&gt; ColumnType b -&gt; Bool
</span><a href="Hasura.RQL.Types.Column.html#isScalarColumnWhere"><span class="hs-identifier hs-var">isScalarColumnWhere</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarType 'MSSQL -&gt; Bool
ScalarType -&gt; Bool
</span><a href="#local-6989586621687555226"><span class="hs-identifier hs-var">isGeoType</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnType 'MSSQL -&gt; Bool)
-&gt; (ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL)
-&gt; ColumnInfo 'MSSQL
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; ColumnType b
</span><a href="Hasura.RQL.Types.Column.html#ciType"><span class="hs-identifier hs-var">ciType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555220"><span class="hs-identifier hs-var">listenColumns</span></a></span><span>
</span><span id="line-680"></span><span>      </span><span id="local-6989586621687555228"><span class="annot"><span class="annottext">isGeoTypesInDeliversCols :: Bool
</span><a href="#local-6989586621687555228"><span class="hs-identifier hs-var hs-var">isGeoTypesInDeliversCols</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Bool) -&gt; [ColumnInfo 'MSSQL] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ScalarType 'MSSQL -&gt; Bool) -&gt; ColumnType 'MSSQL -&gt; Bool
forall (b :: BackendType).
(ScalarType b -&gt; Bool) -&gt; ColumnType b -&gt; Bool
</span><a href="Hasura.RQL.Types.Column.html#isScalarColumnWhere"><span class="hs-identifier hs-var">isScalarColumnWhere</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarType 'MSSQL -&gt; Bool
ScalarType -&gt; Bool
</span><a href="#local-6989586621687555226"><span class="hs-identifier hs-var">isGeoType</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnType 'MSSQL -&gt; Bool)
-&gt; (ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL)
-&gt; ColumnInfo 'MSSQL
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; ColumnType b
</span><a href="Hasura.RQL.Types.Column.html#ciType"><span class="hs-identifier hs-var">ciType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555221"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-681"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555223"><span class="hs-identifier hs-var">isGeoTypesInListenCols</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555228"><span class="hs-identifier hs-var">isGeoTypesInDeliversCols</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-682"></span><span>    </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Event triggers for MS-SQL sources are not supported on tables having Geometry or Geography column types&quot;</span></span><span>
</span><span id="line-683"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-684"></span><span>    </span><span id="local-6989586621687555226"><span class="annot"><span class="annottext">isGeoType :: ScalarType -&gt; Bool
</span><a href="#local-6989586621687555226"><span class="hs-identifier hs-var hs-var">isGeoType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScalarType -&gt; [ScalarType] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[ScalarType]
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#geoTypes"><span class="hs-identifier hs-var">geoTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-685"></span><span>
</span><span id="line-686"></span><span id="local-6989586621687553902"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-type">mkInsertTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-687"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553902"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-688"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-689"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-690"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-691"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#TriggerOnReplication"><span class="hs-identifier hs-type">TriggerOnReplication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-692"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-693"></span><span>  </span><span class="annot"><a href="#local-6989586621687553902"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-694"></span><span id="mkInsertTriggerQ"><span class="annot"><span class="annottext">mkInsertTriggerQ :: forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-var hs-var">mkInsertTriggerQ</span></a></span></span><span> </span><span id="local-6989586621687555242"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555242"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555243"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555243"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621687555244"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555244"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621687555245"><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555245"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span></span><span> </span><span id="local-6989586621687555246"><span class="annot"><span class="annottext">subOpSpec :: SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621687555246"><span class="hs-identifier hs-var">subOpSpec</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621687555247"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621687555247"><span class="hs-identifier hs-var">_listenCols</span></a></span></span><span> </span><span id="local-6989586621687555248"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621687555248"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-695"></span><span>  </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555244"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621687555246"><span class="hs-identifier hs-var">subOpSpec</span></a></span><span>
</span><span id="line-696"></span><span>  </span><span class="annot"><span class="annottext">TxET QErr IO () -&gt; m ()
forall a. TxE QErr a -&gt; m a
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; m ()) -&gt; TxET QErr IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-697"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-698"></span><span>      </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-699"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Lazy.html#toStrict"><span class="hs-identifier hs-var">LT.toStrict</span></a></span><span>
</span><span id="line-700"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-701"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555249"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555249"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555244"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621687555248"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-702"></span><span>        </span><span class="annot"><span class="annottext">TableName
-&gt; TriggerName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQuery"><span class="hs-identifier hs-var">mkInsertTriggerQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555243"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555242"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555249"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555245"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span id="local-6989586621687555251"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-type">mkDeleteTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-705"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687555251"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-706"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-707"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-708"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-709"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#TriggerOnReplication"><span class="hs-identifier hs-type">TriggerOnReplication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-710"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-711"></span><span>  </span><span class="annot"><a href="#local-6989586621687555251"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-712"></span><span id="mkDeleteTriggerQ"><span class="annot"><span class="annottext">mkDeleteTriggerQ :: forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-var hs-var">mkDeleteTriggerQ</span></a></span></span><span> </span><span id="local-6989586621687555259"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555259"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555260"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555260"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621687555261"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555261"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621687555262"><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555262"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span></span><span> </span><span id="local-6989586621687555263"><span class="annot"><span class="annottext">subOpSpec :: SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621687555263"><span class="hs-identifier hs-var">subOpSpec</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621687555264"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621687555264"><span class="hs-identifier hs-var">_listenCols</span></a></span></span><span> </span><span id="local-6989586621687555265"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621687555265"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-713"></span><span>  </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555261"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621687555263"><span class="hs-identifier hs-var">subOpSpec</span></a></span><span>
</span><span id="line-714"></span><span>  </span><span class="annot"><span class="annottext">TxET QErr IO () -&gt; m ()
forall a. TxE QErr a -&gt; m a
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; m ()) -&gt; TxET QErr IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-715"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-716"></span><span>      </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-717"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Lazy.html#toStrict"><span class="hs-identifier hs-var">LT.toStrict</span></a></span><span>
</span><span id="line-718"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-719"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555266"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555266"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555261"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621687555265"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-720"></span><span>        </span><span class="annot"><span class="annottext">TableName
-&gt; TriggerName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQuery"><span class="hs-identifier hs-var">mkDeleteTriggerQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555260"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555259"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555266"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555262"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span>
</span><span id="line-721"></span><span>
</span><span id="line-722"></span><span id="local-6989586621687553903"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-type">mkUpdateTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-723"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553903"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-724"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-725"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-726"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-727"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#TriggerOnReplication"><span class="hs-identifier hs-type">TriggerOnReplication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-728"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-729"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-730"></span><span>  </span><span class="annot"><a href="#local-6989586621687553903"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-731"></span><span id="mkUpdateTriggerQ"><span class="annot"><span class="annottext">mkUpdateTriggerQ :: forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-var hs-var">mkUpdateTriggerQ</span></a></span></span><span> </span><span id="local-6989586621687555279"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555279"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555280"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555280"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621687555281"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555281"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621687555282"><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555282"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span></span><span> </span><span id="local-6989586621687555283"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621687555283"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span></span><span> </span><span id="local-6989586621687555284"><span class="annot"><span class="annottext">subOpSpec :: SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621687555284"><span class="hs-identifier hs-var">subOpSpec</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621687555285"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621687555285"><span class="hs-identifier hs-var">listenCols</span></a></span></span><span> </span><span id="local-6989586621687555286"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621687555286"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-732"></span><span>  </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555281"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621687555284"><span class="hs-identifier hs-var">subOpSpec</span></a></span><span>
</span><span id="line-733"></span><span>  </span><span class="annot"><span class="annottext">TxET QErr IO () -&gt; m ()
forall a. TxE QErr a -&gt; m a
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; m ()) -&gt; TxET QErr IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-734"></span><span>    </span><span id="local-6989586621687555287"><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621687555287"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; TxET QErr IO (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; TxET QErr IO (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621687555283"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
-&gt; Text -&gt; TxET QErr IO (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Update event triggers for MS-SQL sources are only supported on tables with primary keys&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-735"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555289"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555289"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555281"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621687555286"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-736"></span><span>        </span><span id="local-6989586621687555290"><span class="annot"><span class="annottext">listenColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555290"><span class="hs-identifier hs-var hs-var">listenColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555281"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621687555285"><span class="hs-identifier hs-var">listenCols</span></a></span><span>
</span><span id="line-737"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-738"></span><span>      </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-739"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Lazy.html#toStrict"><span class="hs-identifier hs-var">LT.toStrict</span></a></span><span>
</span><span id="line-740"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableName
-&gt; TriggerName
-&gt; [ColumnInfo 'MSSQL]
-&gt; [ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
-&gt; TriggerOnReplication
-&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQuery"><span class="hs-identifier hs-var">mkUpdateTriggerQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555280"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555279"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555290"><span class="hs-identifier hs-var">listenColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555289"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621687555287"><span class="hs-identifier hs-var">primaryKey</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555282"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span class="hs-comment">-- Create alias for columns</span><span>
</span><span id="line-743"></span><span class="hs-comment">-- eg: If colPrefixMaybe is defined then 'inserted.id as payload.data.old.id'</span><span>
</span><span id="line-744"></span><span class="hs-comment">--     else 'id as payload.data.old.id'</span><span>
</span><span id="line-745"></span><span class="hs-comment">-- We create such an alias for the columns of the table because it helps in</span><span>
</span><span id="line-746"></span><span class="hs-comment">-- structuring the JSON payload.</span><span>
</span><span id="line-747"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-type">generateColumnTriggerAlias</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#OpVar"><span class="hs-identifier hs-type">OpVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-748"></span><span id="generateColumnTriggerAlias"><span class="annot"><span class="annottext">generateColumnTriggerAlias :: OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var hs-var">generateColumnTriggerAlias</span></a></span></span><span> </span><span id="local-6989586621687555293"><span class="annot"><span class="annottext">OpVar
</span><a href="#local-6989586621687555293"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621687555294"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621687555294"><span class="hs-identifier hs-var">colPrefixMaybe</span></a></span></span><span> </span><span id="local-6989586621687555295"><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621687555295"><span class="hs-identifier hs-var">colInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-749"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555296"><span class="annot"><span class="annottext">opText :: Text
</span><a href="#local-6989586621687555296"><span class="hs-identifier hs-var hs-var">opText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-750"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="#local-6989586621687555293"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-751"></span><span>          </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#OLD"><span class="hs-identifier hs-var">OLD</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;old&quot;</span></span><span>
</span><span id="line-752"></span><span>          </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;new&quot;</span></span><span>
</span><span id="line-753"></span><span>      </span><span class="hs-comment">-- Let's say we have a column 'id', dbColNameText returns the column name as</span><span>
</span><span id="line-754"></span><span>      </span><span class="hs-comment">-- text. i.e 'id'</span><span>
</span><span id="line-755"></span><span>      </span><span id="local-6989586621687555299"><span class="annot"><span class="annottext">dbColNameText :: Text
</span><a href="#local-6989586621687555299"><span class="hs-identifier hs-var hs-var">dbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ColumnName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier hs-var">columnNameText</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnName -&gt; Text) -&gt; ColumnName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Column 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; Column b
</span><a href="Hasura.RQL.Types.Column.html#ciColumn"><span class="hs-identifier hs-var">ciColumn</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621687555295"><span class="hs-identifier hs-var">colInfo</span></a></span><span>
</span><span id="line-756"></span><span>      </span><span id="local-6989586621687555301"><span class="annot"><span class="annottext">joinPrefixedDbColNameText :: Text
</span><a href="#local-6989586621687555301"><span class="hs-identifier hs-var hs-var">joinPrefixedDbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-757"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621687555294"><span class="hs-identifier hs-var">colPrefixMaybe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-758"></span><span>          </span><span class="hs-comment">-- prefix with the joining table's name</span><span>
</span><span id="line-759"></span><span>          </span><span class="hs-comment">-- `id` -&gt; `inserted.id` (prefix = 'inserted')</span><span>
</span><span id="line-760"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621687555302"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555302"><span class="hs-identifier hs-var">colPrefix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555302"><span class="hs-identifier hs-var">colPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555299"><span class="hs-identifier hs-var">dbColNameText</span></a></span><span>
</span><span id="line-761"></span><span>          </span><span class="hs-comment">-- do not prefix anthing to the column name</span><span>
</span><span id="line-762"></span><span>          </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555299"><span class="hs-identifier hs-var">dbColNameText</span></a></span><span>
</span><span id="line-763"></span><span>      </span><span class="hs-comment">-- create the alias for the column</span><span>
</span><span id="line-764"></span><span>      </span><span class="hs-comment">-- `payload.data.old.id` (opText = old) (dbColNameText = id)</span><span>
</span><span id="line-765"></span><span>      </span><span id="local-6989586621687555303"><span class="annot"><span class="annottext">dbColAlias :: Text
</span><a href="#local-6989586621687555303"><span class="hs-identifier hs-var hs-var">dbColAlias</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;payload.data&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555296"><span class="hs-identifier hs-var">opText</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555299"><span class="hs-identifier hs-var">dbColNameText</span></a></span><span>
</span><span id="line-766"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- create the SQL alias using the `as` keyword</span><span>
</span><span id="line-767"></span><span>      </span><span class="hs-comment">-- If colPrefixMaybe existed then alias will be `inserted.id as payload.data.old.id`</span><span>
</span><span id="line-768"></span><span>      </span><span class="hs-comment">-- If no colPrefixMaybe was Nothing then alias will be 'id as payload.data.old.id`</span><span>
</span><span id="line-769"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Lazy.html#toStrict"><span class="hs-identifier hs-var">LT.toStrict</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.stext| #{joinPrefixedDbColNameText} as [#{dbColAlias}]|]</span></span><span>
</span><span id="line-770"></span><span>
</span><span id="line-771"></span><span class="hs-comment">-- Converts tables name to the format [SCHEMA].[TABLENAME]</span><span>
</span><span id="line-772"></span><span class="hs-comment">-- eg: [dbo].[author], [hge].[books]</span><span>
</span><span id="line-773"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-type">qualifyTableName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-774"></span><span id="qualifyTableName"><span class="annot"><span class="annottext">qualifyTableName :: TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var hs-var">qualifyTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Query -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; Text) -&gt; (TableName -&gt; Query) -&gt; TableName -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Printer -&gt; Query
</span><a href="Hasura.Backends.MSSQL.ToQuery.html#toQueryFlat"><span class="hs-identifier hs-var">toQueryFlat</span></a></span><span> </span><span class="annot"><span class="annottext">(Printer -&gt; Query) -&gt; (TableName -&gt; Printer) -&gt; TableName -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Printer
</span><a href="Hasura.Backends.MSSQL.ToQuery.html#fromTableName"><span class="hs-identifier hs-var">fromTableName</span></a></span><span>
</span><span id="line-775"></span><span>
</span><span id="line-776"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQuery"><span class="hs-identifier hs-type">mkInsertTriggerQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#TriggerOnReplication"><span class="hs-identifier hs-type">TriggerOnReplication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.Lazy.html#Text"><span class="hs-identifier hs-type">LT.Text</span></a></span><span>
</span><span id="line-777"></span><span id="mkInsertTriggerQuery"><span class="annot"><span class="annottext">mkInsertTriggerQuery :: TableName
-&gt; TriggerName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQuery"><span class="hs-identifier hs-var hs-var">mkInsertTriggerQuery</span></a></span></span><span> </span><span id="local-6989586621687555304"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621687555304"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621687555305"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555305"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621687555306"><span class="annot"><span class="annottext">schema :: SchemaName
</span><a href="#local-6989586621687555306"><span class="hs-identifier hs-var">schema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621687555307"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555307"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621687555308"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555308"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555309"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555309"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span id="local-6989586621687555310"><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555310"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-778"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555311"><span class="annot"><span class="annottext">qualifiedTriggerName :: Text
</span><a href="#local-6989586621687555311"><span class="hs-identifier hs-var hs-var">qualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifiedTriggerNameToText"><span class="hs-identifier hs-var">qualifiedTriggerNameToText</span></a></span><span> </span><span class="annot"><span class="annottext">(QualifiedTriggerName -&gt; Text) -&gt; QualifiedTriggerName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaName -&gt; SQLTriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621687555306"><span class="hs-identifier hs-var">schema</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLTriggerName -&gt; QualifiedTriggerName)
-&gt; SQLTriggerName -&gt; QualifiedTriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Ops -&gt; SQLTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkSQLTriggerName"><span class="hs-identifier hs-var">mkSQLTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555308"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span>
</span><span id="line-779"></span><span>      </span><span id="local-6989586621687555312"><span class="annot"><span class="annottext">triggerNameText :: Text
</span><a href="#local-6989586621687555312"><span class="hs-identifier hs-var hs-var">triggerNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555308"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-780"></span><span>      </span><span id="local-6989586621687555313"><span class="annot"><span class="annottext">qualifiedTableName :: Text
</span><a href="#local-6989586621687555313"><span class="hs-identifier hs-var hs-var">qualifiedTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var">qualifyTableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555304"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-781"></span><span>      </span><span id="local-6989586621687555315"><span class="annot"><span class="annottext">operation :: Text
</span><a href="#local-6989586621687555315"><span class="hs-identifier hs-var hs-var">operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span>
</span><span id="line-782"></span><span>      </span><span id="local-6989586621687555316"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621687555316"><span class="hs-identifier hs-var">replicationClause</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555310"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication -&gt; TriggerOnReplication -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="Hasura.RQL.Types.Common.html#TOREnableTrigger"><span class="hs-identifier hs-var">TOREnableTrigger</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;NOT FOR REPLICATION&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-783"></span><span>      </span><span id="local-6989586621687555319"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555319"><span class="hs-identifier hs-var">deliveryColsSQLExpression</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-784"></span><span>        </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555309"><span class="hs-identifier hs-var">columns</span></a></span><span>
</span><span id="line-785"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_insert_trigger.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-786"></span><span>
</span><span id="line-787"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQuery"><span class="hs-identifier hs-type">mkDeleteTriggerQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#TriggerOnReplication"><span class="hs-identifier hs-type">TriggerOnReplication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.Lazy.html#Text"><span class="hs-identifier hs-type">LT.Text</span></a></span><span>
</span><span id="line-788"></span><span id="mkDeleteTriggerQuery"><span class="annot"><span class="annottext">mkDeleteTriggerQuery :: TableName
-&gt; TriggerName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOnReplication
-&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQuery"><span class="hs-identifier hs-var hs-var">mkDeleteTriggerQuery</span></a></span></span><span> </span><span id="local-6989586621687555320"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621687555320"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621687555321"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555321"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621687555322"><span class="annot"><span class="annottext">schema :: SchemaName
</span><a href="#local-6989586621687555322"><span class="hs-identifier hs-var">schema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621687555323"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555323"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621687555324"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555324"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621687555325"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555325"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span id="local-6989586621687555326"><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555326"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-789"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555327"><span class="annot"><span class="annottext">qualifiedTriggerName :: Text
</span><a href="#local-6989586621687555327"><span class="hs-identifier hs-var hs-var">qualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifiedTriggerNameToText"><span class="hs-identifier hs-var">qualifiedTriggerNameToText</span></a></span><span> </span><span class="annot"><span class="annottext">(QualifiedTriggerName -&gt; Text) -&gt; QualifiedTriggerName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaName -&gt; SQLTriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621687555322"><span class="hs-identifier hs-var">schema</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLTriggerName -&gt; QualifiedTriggerName)
-&gt; SQLTriggerName -&gt; QualifiedTriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Ops -&gt; SQLTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkSQLTriggerName"><span class="hs-identifier hs-var">mkSQLTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555324"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span>
</span><span id="line-790"></span><span>      </span><span id="local-6989586621687555328"><span class="annot"><span class="annottext">triggerNameText :: Text
</span><a href="#local-6989586621687555328"><span class="hs-identifier hs-var hs-var">triggerNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555324"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-791"></span><span>      </span><span id="local-6989586621687555329"><span class="annot"><span class="annottext">qualifiedTableName :: Text
</span><a href="#local-6989586621687555329"><span class="hs-identifier hs-var hs-var">qualifiedTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var">qualifyTableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555320"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-792"></span><span>      </span><span id="local-6989586621687555331"><span class="annot"><span class="annottext">operation :: Text
</span><a href="#local-6989586621687555331"><span class="hs-identifier hs-var hs-var">operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span>
</span><span id="line-793"></span><span>      </span><span id="local-6989586621687555332"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621687555332"><span class="hs-identifier hs-var">replicationClause</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555326"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication -&gt; TriggerOnReplication -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="Hasura.RQL.Types.Common.html#TOREnableTrigger"><span class="hs-identifier hs-var">TOREnableTrigger</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;NOT FOR REPLICATION&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-794"></span><span>      </span><span id="local-6989586621687555333"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555333"><span class="hs-identifier hs-var">deliveryColsSQLExpression</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#OLD"><span class="hs-identifier hs-var">OLD</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555325"><span class="hs-identifier hs-var">columns</span></a></span><span>
</span><span id="line-795"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_delete_trigger.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-796"></span><span>
</span><span id="line-797"></span><span class="hs-comment">-- Creates Primary Join key expression for UPDATE SQL Trigger</span><span>
</span><span id="line-798"></span><span class="hs-comment">-- eg: 'INSERTED.id = DELETED.id AND INSERTED.emp_code = DELETED.emp_code'</span><span>
</span><span id="line-799"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkPrimaryKeyJoinExp"><span class="hs-identifier hs-type">mkPrimaryKeyJoinExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-800"></span><span id="mkPrimaryKeyJoinExp"><span class="annot"><span class="annottext">mkPrimaryKeyJoinExp :: Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkPrimaryKeyJoinExp"><span class="hs-identifier hs-var hs-var">mkPrimaryKeyJoinExp</span></a></span></span><span> </span><span id="local-6989586621687555335"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555335"><span class="hs-identifier hs-var">lhsPrefix</span></a></span></span><span> </span><span id="local-6989586621687555336"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555336"><span class="hs-identifier hs-var">rhsPrefix</span></a></span></span><span> </span><span id="local-6989586621687555337"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555337"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-801"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.html#intercalate"><span class="hs-identifier hs-var">T.intercalate</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; AND &quot;</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621687555339"><span class="hs-identifier hs-var">singleColExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555337"><span class="hs-identifier hs-var">columns</span></a></span><span>
</span><span id="line-802"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-803"></span><span>    </span><span id="local-6989586621687555339"><span class="annot"><span class="annottext">singleColExp :: ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621687555339"><span class="hs-identifier hs-var hs-var">singleColExp</span></a></span></span><span> </span><span id="local-6989586621687555340"><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621687555340"><span class="hs-identifier hs-var">colInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-804"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555341"><span class="annot"><span class="annottext">dbColNameText :: Text
</span><a href="#local-6989586621687555341"><span class="hs-identifier hs-var hs-var">dbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ColumnName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier hs-var">columnNameText</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnName -&gt; Text) -&gt; ColumnName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Column 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; Column b
</span><a href="Hasura.RQL.Types.Column.html#ciColumn"><span class="hs-identifier hs-var">ciColumn</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621687555340"><span class="hs-identifier hs-var">colInfo</span></a></span><span>
</span><span id="line-805"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Lazy.html#toStrict"><span class="hs-identifier hs-var">LT.toStrict</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.stext| #{lhsPrefix}.#{dbColNameText} = #{rhsPrefix}.#{dbColNameText} |]</span></span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span class="hs-comment">-- Creates the WHERE clause for UPDATE SQL Trigger</span><span>
</span><span id="line-808"></span><span class="hs-comment">-- eg: If no listenColumns are defined then the where clause is an empty text</span><span>
</span><span id="line-809"></span><span class="hs-comment">--     else, 'WHERE INSERTED.id != DELETED.id OR INSERTED.name != DELTED.name'</span><span>
</span><span id="line-810"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-type">mkListenColumnsExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-811"></span><span id="mkListenColumnsExp"><span class="annot"><span class="annottext">mkListenColumnsExp :: Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-var hs-var">mkListenColumnsExp</span></a></span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-812"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-var">mkListenColumnsExp</span></a></span><span> </span><span id="local-6989586621687555343"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555343"><span class="hs-identifier hs-var">lhsPrefix</span></a></span></span><span> </span><span id="local-6989586621687555344"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555344"><span class="hs-identifier hs-var">rhsPrefix</span></a></span></span><span> </span><span id="local-6989586621687555345"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555345"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-813"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;where &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.html#intercalate"><span class="hs-identifier hs-var">T.intercalate</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; OR &quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621687555346"><span class="hs-identifier hs-var">singleColExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555345"><span class="hs-identifier hs-var">columns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-814"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-815"></span><span>    </span><span id="local-6989586621687555346"><span class="annot"><span class="annottext">singleColExp :: ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621687555346"><span class="hs-identifier hs-var hs-var">singleColExp</span></a></span></span><span> </span><span id="local-6989586621687555347"><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621687555347"><span class="hs-identifier hs-var">colInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-816"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555348"><span class="annot"><span class="annottext">dbColNameText :: Text
</span><a href="#local-6989586621687555348"><span class="hs-identifier hs-var hs-var">dbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ColumnName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier hs-var">columnNameText</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnName -&gt; Text) -&gt; ColumnName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Column 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; Column b
</span><a href="Hasura.RQL.Types.Column.html#ciColumn"><span class="hs-identifier hs-var">ciColumn</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621687555347"><span class="hs-identifier hs-var">colInfo</span></a></span><span>
</span><span id="line-817"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Lazy.html#toStrict"><span class="hs-identifier hs-var">LT.toStrict</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.stext| #{lhsPrefix}.#{dbColNameText} != #{rhsPrefix}.#{dbColNameText} |]</span></span><span>
</span><span id="line-818"></span><span>
</span><span id="line-819"></span><span class="hs-comment">-- | Check if primary key is present in listen columns</span><span>
</span><span id="line-820"></span><span class="hs-comment">-- We use this in update event trigger, to check if the primary key has been updated</span><span>
</span><span id="line-821"></span><span class="hs-comment">-- and construct the payload accordingly.</span><span>
</span><span id="line-822"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#isPrimaryKeyInListenColumns"><span class="hs-identifier hs-type">isPrimaryKeyInListenColumns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Table.Cache.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-823"></span><span id="isPrimaryKeyInListenColumns"><span class="annot"><span class="annottext">isPrimaryKeyInListenColumns :: [ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#isPrimaryKeyInListenColumns"><span class="hs-identifier hs-var hs-var">isPrimaryKeyInListenColumns</span></a></span></span><span> </span><span id="local-6989586621687555350"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555350"><span class="hs-identifier hs-var">listenCols</span></a></span></span><span> </span><span id="local-6989586621687555351"><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621687555351"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-824"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NESeq (ColumnInfo 'MSSQL) -&gt; [ColumnInfo 'MSSQL]
forall a. NESeq a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; NESeq (ColumnInfo 'MSSQL)
forall (b :: BackendType) a. PrimaryKey b a -&gt; NESeq a
</span><a href="Hasura.Table.Cache.html#_pkColumns"><span class="hs-identifier hs-var">_pkColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621687555351"><span class="hs-identifier hs-var">primaryKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; [ColumnInfo 'MSSQL] -&gt; [ColumnInfo 'MSSQL]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555350"><span class="hs-identifier hs-var">listenCols</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-825"></span><span>    </span><span class="hs-comment">-- Do not fire Event Trigger if primary key not in listen column</span><span>
</span><span id="line-826"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;1 != 1&quot;</span></span><span>
</span><span id="line-827"></span><span>    </span><span class="hs-comment">-- Fire Event Trigger, since primary key is in listen column</span><span>
</span><span id="line-828"></span><span>    </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;1 = 1&quot;</span></span><span>
</span><span id="line-829"></span><span>
</span><span id="line-830"></span><span class="hs-comment">{- Note [Update Event Trigger MSSQL Spec]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An MS-SQL trigger is different from a postgres trigger in some ways
  * MS-SQL doesn't support triggers which trigger for each row, so in case of
    mutations which affect multiple rows, there'll only be a single trigger
    fired which will contain the data of all the rows that were affected.
  * MS-SQL maintains two logical tables, namely, [`inserted` and `deleted`](https://docs.microsoft.com/en-us/sql/relational-databases/triggers/use-the-inserted-and-deleted-tables?view=sql-server-ver15).
    The rows in the `inserted` table are copies of the new rows in the trigger
    table and similarly the `deleted` table contains the copies of the rows
    that were deleted from the trigger table.
  * When there's an update transaction, the old data (before the update) will
    be copied to the `deleted` table and the new data will be copied to the
    `inserted` table.

Since we deliver the 'old' and 'new' data in the event trigger payload, we would need
a way to correlate the values from `inserted` and `deleted` tables. And this is why,
It is mandatory for a MSSQL Update trigger table to have a primary key. We use this
primary key to correlate between `inserted` and `deleted`

MSSQL UPDATE trigger's join clause depends on the fact that the primary key is never
updated. But when the primary key is updated, you cannot join the 'INSERTED' and
the 'DELETED' tables. Hence for those cases, we consider the old payload as NULL and
the new payload will contain the updated row changes.

To figure out if a primary key has been updated, we do the following:
For each row present in the INSERTED table, we check if there are any rows in DELETED
tabled that has the same primary key as that of the row in INSERTED table. If such a
row does not exists, then it means that the primary key has been updated. The sample
SQL which does this looks like:
  SELECT * FROM INSERTED
  WHERE NOT EXISTS (SELECT * FROM DELETED WHERE  INSERTED.id = DELETED.id )

The spec for MSSQL UPDATE Event Trigger is as follows:
1. UPDATE Event Trigger can only be created on tables with a primary key.
2. When Primary Key is not updated during a UPDATE transaction then both 'data.new'
   and 'data.old' fields in payload will be constructed.
3. When Primary Key is updated during a UPDATE transaction then there are two cases:
    a. If the updated Primary key is equal to one of the already present primary key in
       the table then, we construct both the 'data.old' and 'data.new'
    b. If the updated primary key is not equal to any of the already present primary key
       in the table then, 'data.old' is NULL and only 'data.new' is constructed.
-}</span><span>
</span><span id="line-872"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQuery"><span class="hs-identifier hs-type">mkUpdateTriggerQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Table.Cache.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#TriggerOnReplication"><span class="hs-identifier hs-type">TriggerOnReplication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.Lazy.html#Text"><span class="hs-identifier hs-type">LT.Text</span></a></span><span>
</span><span id="line-873"></span><span id="mkUpdateTriggerQuery"><span class="annot"><span class="annottext">mkUpdateTriggerQuery :: TableName
-&gt; TriggerName
-&gt; [ColumnInfo 'MSSQL]
-&gt; [ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
-&gt; TriggerOnReplication
-&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQuery"><span class="hs-identifier hs-var hs-var">mkUpdateTriggerQuery</span></a></span></span><span>
</span><span id="line-874"></span><span>  </span><span id="local-6989586621687555354"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621687555354"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621687555355"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555355"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621687555356"><span class="annot"><span class="annottext">schema :: SchemaName
</span><a href="#local-6989586621687555356"><span class="hs-identifier hs-var">schema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621687555357"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555357"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span>  </span><span id="local-6989586621687555358"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555358"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span>
</span><span id="line-876"></span><span>  </span><span id="local-6989586621687555359"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555359"><span class="hs-identifier hs-var">listenColumns</span></a></span></span><span>
</span><span id="line-877"></span><span>  </span><span id="local-6989586621687555360"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555360"><span class="hs-identifier hs-var">deliveryColumns</span></a></span></span><span>
</span><span id="line-878"></span><span>  </span><span id="local-6989586621687555361"><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621687555361"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span>
</span><span id="line-879"></span><span>  </span><span id="local-6989586621687555362"><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555362"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-880"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555363"><span class="annot"><span class="annottext">qualifiedTriggerName :: Text
</span><a href="#local-6989586621687555363"><span class="hs-identifier hs-var hs-var">qualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifiedTriggerNameToText"><span class="hs-identifier hs-var">qualifiedTriggerNameToText</span></a></span><span> </span><span class="annot"><span class="annottext">(QualifiedTriggerName -&gt; Text) -&gt; QualifiedTriggerName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaName -&gt; SQLTriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621687555356"><span class="hs-identifier hs-var">schema</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLTriggerName -&gt; QualifiedTriggerName)
-&gt; SQLTriggerName -&gt; QualifiedTriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Ops -&gt; SQLTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkSQLTriggerName"><span class="hs-identifier hs-var">mkSQLTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555358"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span>
</span><span id="line-881"></span><span>        </span><span id="local-6989586621687555364"><span class="annot"><span class="annottext">triggerNameText :: Text
</span><a href="#local-6989586621687555364"><span class="hs-identifier hs-var hs-var">triggerNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555358"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-882"></span><span>        </span><span id="local-6989586621687555365"><span class="annot"><span class="annottext">qualifiedTableName :: Text
</span><a href="#local-6989586621687555365"><span class="hs-identifier hs-var hs-var">qualifiedTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var">qualifyTableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621687555354"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-883"></span><span>        </span><span id="local-6989586621687555367"><span class="annot"><span class="annottext">operation :: Text
</span><a href="#local-6989586621687555367"><span class="hs-identifier hs-var hs-var">operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span>
</span><span id="line-884"></span><span>        </span><span id="local-6989586621687555368"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621687555368"><span class="hs-identifier hs-var">replicationClause</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621687555362"><span class="hs-identifier hs-var">triggerOnReplication</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication -&gt; TriggerOnReplication -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="Hasura.RQL.Types.Common.html#TOREnableTrigger"><span class="hs-identifier hs-var">TOREnableTrigger</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;NOT FOR REPLICATION&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-885"></span><span>
</span><span id="line-886"></span><span>        </span><span id="local-6989586621687555369"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555369"><span class="hs-identifier hs-var">oldDeliveryColsSQLExp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#OLD"><span class="hs-identifier hs-var">OLD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DELETED&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555360"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-887"></span><span>        </span><span id="local-6989586621687555370"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555370"><span class="hs-identifier hs-var">newDeliveryColsSQLExp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555360"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-888"></span><span>
</span><span id="line-889"></span><span>        </span><span class="hs-comment">-- When Primary key is updated, then 'data.old' would be NULL</span><span>
</span><span id="line-890"></span><span>        </span><span class="hs-comment">-- See Note [Update Event Trigger MSSQL Spec]</span><span>
</span><span id="line-891"></span><span>        </span><span id="local-6989586621687555372"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555372"><span class="hs-identifier hs-var">oldDeliveryColsSQLExpWhenPrimaryKeyUpdated</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-892"></span><span>          </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;NULL as [payload.data.old]&quot;</span></span><span>
</span><span id="line-893"></span><span>        </span><span id="local-6989586621687555373"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555373"><span class="hs-identifier hs-var">newDeliveryColsSQLExpWhenPrimaryKeyUpdated</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-894"></span><span>          </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555360"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-895"></span><span>
</span><span id="line-896"></span><span>        </span><span id="local-6989586621687555374"><span class="annot"><span class="annottext">primaryKeyJoinExp :: Text
</span><a href="#local-6989586621687555374"><span class="hs-identifier hs-var hs-var">primaryKeyJoinExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text) -&gt; SQLFragment -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkPrimaryKeyJoinExp"><span class="hs-identifier hs-var">mkPrimaryKeyJoinExp</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DELETED&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NESeq (ColumnInfo 'MSSQL) -&gt; [ColumnInfo 'MSSQL]
forall a. NESeq a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; NESeq (ColumnInfo 'MSSQL)
forall (b :: BackendType) a. PrimaryKey b a -&gt; NESeq a
</span><a href="Hasura.Table.Cache.html#_pkColumns"><span class="hs-identifier hs-var">_pkColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621687555361"><span class="hs-identifier hs-var">primaryKey</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-897"></span><span>        </span><span id="local-6989586621687555375"><span class="annot"><span class="annottext">listenColumnExp :: Text
</span><a href="#local-6989586621687555375"><span class="hs-identifier hs-var hs-var">listenColumnExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text) -&gt; SQLFragment -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-var">mkListenColumnsExp</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DELETED&quot;</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555359"><span class="hs-identifier hs-var">listenColumns</span></a></span><span>
</span><span id="line-898"></span><span>        </span><span id="local-6989586621687555376"><span class="annot"><span class="annottext">isPrimaryKeyInListenColumnsExp :: Text
</span><a href="#local-6989586621687555376"><span class="hs-identifier hs-var hs-var">isPrimaryKeyInListenColumnsExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text) -&gt; SQLFragment -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#isPrimaryKeyInListenColumns"><span class="hs-identifier hs-var">isPrimaryKeyInListenColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621687555359"><span class="hs-identifier hs-var">listenColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621687555361"><span class="hs-identifier hs-var">primaryKey</span></a></span><span>
</span><span id="line-899"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_update_trigger.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-900"></span><span>
</span><span id="line-901"></span><span class="hs-comment">-- | Add cleanup logs for given trigger names and cleanup configs. This will perform the following steps:</span><span>
</span><span id="line-902"></span><span class="hs-comment">--</span><span>
</span><span id="line-903"></span><span class="hs-comment">--   1. Get last scheduled cleanup event and count.</span><span>
</span><span id="line-904"></span><span class="hs-comment">--   2. If count is less than 5, then add add more cleanup logs, else do nothing</span><span>
</span><span id="line-905"></span><span id="local-6989586621687554010"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#addCleanupSchedules"><span class="hs-identifier hs-type">addCleanupSchedules</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-906"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687554010"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554010"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-907"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-908"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#AutoTriggerLogCleanupConfig"><span class="hs-identifier hs-type">AutoTriggerLogCleanupConfig</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-909"></span><span>  </span><span class="annot"><a href="#local-6989586621687554010"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-910"></span><span id="addCleanupSchedules"><span class="annot"><span class="annottext">addCleanupSchedules :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)] -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#addCleanupSchedules"><span class="hs-identifier hs-var hs-var">addCleanupSchedules</span></a></span></span><span> </span><span id="local-6989586621687555408"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555408"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687555409"><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
</span><a href="#local-6989586621687555409"><span class="hs-identifier hs-var">triggersWithcleanupConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-911"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
</span><a href="#local-6989586621687555409"><span class="hs-identifier hs-var">triggersWithcleanupConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-912"></span><span>    </span><span id="local-6989586621687555411"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555411"><span class="hs-identifier hs-var">currTimeUTC</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; m UTCTime
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-913"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555413"><span class="annot"><span class="annottext">currTime :: ZonedTime
</span><a href="#local-6989586621687555413"><span class="hs-identifier hs-var hs-var">currTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeZone -&gt; UTCTime -&gt; ZonedTime
</span><span class="hs-identifier hs-var">utcToZonedTime</span></span><span> </span><span class="annot"><span class="annottext">TimeZone
</span><span class="hs-identifier hs-var">utc</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555411"><span class="hs-identifier hs-var">currTimeUTC</span></a></span><span>
</span><span id="line-914"></span><span>        </span><span id="local-6989586621687555415"><span class="annot"><span class="annottext">triggerNames :: [TriggerName]
</span><a href="#local-6989586621687555415"><span class="hs-identifier hs-var hs-var">triggerNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TriggerName, AutoTriggerLogCleanupConfig) -&gt; TriggerName)
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)] -&gt; [TriggerName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(TriggerName, AutoTriggerLogCleanupConfig) -&gt; TriggerName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
</span><a href="#local-6989586621687555409"><span class="hs-identifier hs-var">triggersWithcleanupConfig</span></a></span><span>
</span><span id="line-915"></span><span>    </span><span id="local-6989586621687555417"><span class="annot"><span class="annottext">[(TriggerName, (Int, ZonedTime))]
</span><a href="#local-6989586621687555417"><span class="hs-identifier hs-var">allScheduledCleanupsInDB</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Either QErr [(TriggerName, (Int, ZonedTime))])
-&gt; m [(TriggerName, (Int, ZonedTime))]
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr [(TriggerName, (Int, ZonedTime))])
 -&gt; m [(TriggerName, (Int, ZonedTime))])
-&gt; m (Either QErr [(TriggerName, (Int, ZonedTime))])
-&gt; m [(TriggerName, (Int, ZonedTime))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr [(TriggerName, (Int, ZonedTime))])
-&gt; m (Either QErr [(TriggerName, (Int, ZonedTime))])
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr [(TriggerName, (Int, ZonedTime))])
 -&gt; m (Either QErr [(TriggerName, (Int, ZonedTime))]))
-&gt; IO (Either QErr [(TriggerName, (Int, ZonedTime))])
-&gt; m (Either QErr [(TriggerName, (Int, ZonedTime))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO [(TriggerName, (Int, ZonedTime))]
-&gt; IO (Either QErr [(TriggerName, (Int, ZonedTime))])
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555408"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO [(TriggerName, (Int, ZonedTime))]
 -&gt; IO (Either QErr [(TriggerName, (Int, ZonedTime))]))
-&gt; TxET QErr IO [(TriggerName, (Int, ZonedTime))]
-&gt; IO (Either QErr [(TriggerName, (Int, ZonedTime))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TriggerName] -&gt; TxET QErr IO [(TriggerName, (Int, ZonedTime))]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#selectLastCleanupScheduledTimestamp"><span class="hs-identifier hs-var">selectLastCleanupScheduledTimestamp</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621687555415"><span class="hs-identifier hs-var">triggerNames</span></a></span><span>
</span><span id="line-916"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555419"><span class="annot"><span class="annottext">triggerMap :: HashMap TriggerName (Int, ZonedTime)
</span><a href="#local-6989586621687555419"><span class="hs-identifier hs-var hs-var">triggerMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(TriggerName, (Int, ZonedTime))]
-&gt; HashMap TriggerName (Int, ZonedTime)
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-a5b4fa803c841f948b5080a5c7a22f4e3b108a71ab10582fd155001f6f7ca093/share/doc/html/src/Data.HashMap.Internal.Strict.html#fromList"><span class="hs-identifier hs-var">HashMap.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(TriggerName, (Int, ZonedTime))]
 -&gt; HashMap TriggerName (Int, ZonedTime))
-&gt; [(TriggerName, (Int, ZonedTime))]
-&gt; HashMap TriggerName (Int, ZonedTime)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, (Int, ZonedTime))]
</span><a href="#local-6989586621687555417"><span class="hs-identifier hs-var">allScheduledCleanupsInDB</span></a></span><span>
</span><span id="line-917"></span><span>        </span><span id="local-6989586621687555421"><span class="annot"><span class="annottext">scheduledTriggersAndTimestamps :: [(TriggerName, [Datetimeoffset])]
</span><a href="#local-6989586621687555421"><span class="hs-identifier hs-var hs-var">scheduledTriggersAndTimestamps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-918"></span><span>          </span><span class="annot"><span class="annottext">((TriggerName, AutoTriggerLogCleanupConfig)
 -&gt; Maybe (TriggerName, [Datetimeoffset]))
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)]
-&gt; [(TriggerName, [Datetimeoffset])]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b.
Filterable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; f b
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/witherable-0.4.2-a40f3f0a2ed7f25145b5b00589bf4ea2486662b1e96b7d29d5e6041625ee4a09/share/doc/html/src/Witherable.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span>
</span><span id="line-919"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687555423"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555423"><span class="hs-identifier hs-var">tName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555424"><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621687555424"><span class="hs-identifier hs-var">cConfig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-920"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555425"><span class="annot"><span class="annottext">lastScheduledTime :: Maybe ZonedTime
</span><a href="#local-6989586621687555425"><span class="hs-identifier hs-var hs-var">lastScheduledTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; HashMap TriggerName (Int, ZonedTime) -&gt; Maybe (Int, ZonedTime)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-a5b4fa803c841f948b5080a5c7a22f4e3b108a71ab10582fd155001f6f7ca093/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555423"><span class="hs-identifier hs-var">tName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName (Int, ZonedTime)
</span><a href="#local-6989586621687555419"><span class="hs-identifier hs-var">triggerMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-921"></span><span>                      </span><span class="annot"><span class="annottext">Maybe (Int, ZonedTime)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ZonedTime -&gt; Maybe ZonedTime
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621687555413"><span class="hs-identifier hs-var">currTime</span></a></span><span>
</span><span id="line-922"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687555427"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555427"><span class="hs-identifier hs-var">count</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555428"><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621687555428"><span class="hs-identifier hs-var">lastTime</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555427"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">5</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ZonedTime -&gt; Maybe ZonedTime
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621687555428"><span class="hs-identifier hs-var">lastTime</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe ZonedTime
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-923"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(ZonedTime -&gt; (TriggerName, [Datetimeoffset]))
-&gt; Maybe ZonedTime -&gt; Maybe (TriggerName, [Datetimeoffset])
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span>
</span><span id="line-924"></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687555430"><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621687555430"><span class="hs-identifier hs-var">lastScheduledTimestamp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-925"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555423"><span class="hs-identifier hs-var">tName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(UTCTime -&gt; Datetimeoffset) -&gt; [UTCTime] -&gt; [Datetimeoffset]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ZonedTime -&gt; Datetimeoffset
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#Datetimeoffset"><span class="hs-identifier hs-var">Datetimeoffset</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonedTime -&gt; Datetimeoffset)
-&gt; (UTCTime -&gt; ZonedTime) -&gt; UTCTime -&gt; Datetimeoffset
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TimeZone -&gt; UTCTime -&gt; ZonedTime
</span><span class="hs-identifier hs-var">utcToZonedTime</span></span><span> </span><span class="annot"><span class="annottext">TimeZone
</span><span class="hs-identifier hs-var">utc</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([UTCTime] -&gt; [Datetimeoffset]) -&gt; [UTCTime] -&gt; [Datetimeoffset]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; Int -&gt; CronSchedule -&gt; [UTCTime]
</span><a href="Hasura.Eventing.Common.html#generateScheduleTimes"><span class="hs-identifier hs-var">generateScheduleTimes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ZonedTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">zonedTimeToUTC</span></span><span> </span><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621687555430"><span class="hs-identifier hs-var">lastScheduledTimestamp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Hasura.Eventing.Common.html#cleanupSchedulesToBeGenerated"><span class="hs-identifier hs-var">cleanupSchedulesToBeGenerated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig -&gt; CronSchedule
</span><a href="Hasura.RQL.Types.EventTrigger.html#_atlccSchedule"><span class="hs-identifier hs-var">_atlccSchedule</span></a></span><span> </span><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621687555424"><span class="hs-identifier hs-var">cConfig</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-926"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-927"></span><span>                      </span><span class="annot"><span class="annottext">Maybe ZonedTime
</span><a href="#local-6989586621687555425"><span class="hs-identifier hs-var">lastScheduledTime</span></a></span><span>
</span><span id="line-928"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-929"></span><span>            </span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
</span><a href="#local-6989586621687555409"><span class="hs-identifier hs-var">triggersWithcleanupConfig</span></a></span><span>
</span><span id="line-930"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])]
</span><a href="#local-6989586621687555421"><span class="hs-identifier hs-var">scheduledTriggersAndTimestamps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-931"></span><span>      </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-932"></span><span>      </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-933"></span><span>      </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555408"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-934"></span><span>      </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])] -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertEventTriggerCleanupLogsTx"><span class="hs-identifier hs-var">insertEventTriggerCleanupLogsTx</span></a></span><span> </span><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])]
</span><a href="#local-6989586621687555421"><span class="hs-identifier hs-var">scheduledTriggersAndTimestamps</span></a></span><span>
</span><span id="line-935"></span><span>
</span><span id="line-936"></span><span class="annot"><span class="hs-comment">-- | Insert the cleanup logs for the given trigger name and schedules</span></span><span>
</span><span id="line-937"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertEventTriggerCleanupLogsTx"><span class="hs-identifier hs-type">insertEventTriggerCleanupLogsTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#Datetimeoffset"><span class="hs-identifier hs-type">Datetimeoffset</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxET"><span class="hs-identifier hs-type">TxET</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-938"></span><span id="insertEventTriggerCleanupLogsTx"><span class="annot"><span class="annottext">insertEventTriggerCleanupLogsTx :: [(TriggerName, [Datetimeoffset])] -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertEventTriggerCleanupLogsTx"><span class="hs-identifier hs-var hs-var">insertEventTriggerCleanupLogsTx</span></a></span></span><span> </span><span id="local-6989586621687555437"><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])]
</span><a href="#local-6989586621687555437"><span class="hs-identifier hs-var">triggerNameWithSchedules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-939"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-940"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-941"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-942"></span><span>        </span><span class="annot"><span class="">[ST.st|
      INSERT INTO hdb_catalog.hdb_event_log_cleanups(trigger_name, scheduled_at, status)
      VALUES #{sqlValues};
      |]</span></span><span>
</span><span id="line-946"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-947"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-948"></span><span>    </span><span id="local-6989586621687555438"><span class="annot"><span class="annottext">sqlValues :: Text
</span><a href="#local-6989586621687555438"><span class="hs-identifier hs-var hs-var">sqlValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-949"></span><span>      </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span>
</span><span id="line-950"></span><span>        </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((TriggerName, [Datetimeoffset]) -&gt; Text)
-&gt; [(TriggerName, [Datetimeoffset])] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span>
</span><span id="line-951"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687555439"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555439"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555440"><span class="annot"><span class="annottext">[Datetimeoffset]
</span><a href="#local-6989586621687555440"><span class="hs-identifier hs-var">schedules</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-952"></span><span>              </span><span class="annot"><span class="annottext">(Datetimeoffset -&gt; Text) -&gt; [Datetimeoffset] -&gt; Text
forall a. (a -&gt; Text) -&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromListWith"><span class="hs-identifier hs-var">generateSQLValuesFromListWith</span></a></span><span>
</span><span id="line-953"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687555441"><span class="annot"><span class="annottext">Datetimeoffset
</span><a href="#local-6989586621687555441"><span class="hs-identifier hs-var">schedule</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-954"></span><span>                    </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555439"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;', '&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text)
-&gt; (Datetimeoffset -&gt; String) -&gt; Datetimeoffset -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ZonedTime -&gt; String
forall t. ISO8601 t =&gt; t -&gt; String
</span><span class="hs-identifier hs-var">iso8601Show</span></span><span> </span><span class="annot"><span class="annottext">(ZonedTime -&gt; String)
-&gt; (Datetimeoffset -&gt; ZonedTime) -&gt; Datetimeoffset -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Datetimeoffset -&gt; ZonedTime
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#unDatetimeoffset"><span class="hs-identifier hs-var">unDatetimeoffset</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Datetimeoffset
</span><a href="#local-6989586621687555441"><span class="hs-identifier hs-var">schedule</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;', 'scheduled'&quot;</span></span><span>
</span><span id="line-955"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-956"></span><span>                </span><span class="annot"><span class="annottext">[Datetimeoffset]
</span><a href="#local-6989586621687555440"><span class="hs-identifier hs-var">schedules</span></a></span><span>
</span><span id="line-957"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-958"></span><span>          </span><span class="annot"><span class="annottext">[(TriggerName, [Datetimeoffset])]
</span><a href="#local-6989586621687555437"><span class="hs-identifier hs-var">triggerNameWithSchedules</span></a></span><span>
</span><span id="line-959"></span><span>
</span><span id="line-960"></span><span class="annot"><span class="hs-comment">-- | Get the last scheduled timestamp for a given event trigger name</span></span><span>
</span><span id="line-961"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#selectLastCleanupScheduledTimestamp"><span class="hs-identifier hs-type">selectLastCleanupScheduledTimestamp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxET"><span class="hs-identifier hs-type">TxET</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ZonedTime</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-962"></span><span id="selectLastCleanupScheduledTimestamp"><span class="annot"><span class="annottext">selectLastCleanupScheduledTimestamp :: [TriggerName] -&gt; TxET QErr IO [(TriggerName, (Int, ZonedTime))]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#selectLastCleanupScheduledTimestamp"><span class="hs-identifier hs-var hs-var">selectLastCleanupScheduledTimestamp</span></a></span></span><span> </span><span id="local-6989586621687555444"><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621687555444"><span class="hs-identifier hs-var">triggerNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-963"></span><span>  </span><span class="annot"><span class="annottext">((Text, Int, ZonedTime) -&gt; (TriggerName, (Int, ZonedTime)))
-&gt; [(Text, Int, ZonedTime)] -&gt; [(TriggerName, (Int, ZonedTime))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span>
</span><span id="line-964"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687555445"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555445"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555446"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555446"><span class="hs-identifier hs-var">count</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555447"><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621687555447"><span class="hs-identifier hs-var">lastScheduledTime</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-965"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmptyText -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-var">TriggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; NonEmptyText
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier hs-var">mkNonEmptyTextUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555445"><span class="hs-identifier hs-var">triggerName</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555446"><span class="hs-identifier hs-var">count</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ZonedTime
</span><a href="#local-6989586621687555447"><span class="hs-identifier hs-var">lastScheduledTime</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-966"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-967"></span><span>    </span><span class="annot"><span class="annottext">([(Text, Int, ZonedTime)] -&gt; [(TriggerName, (Int, ZonedTime))])
-&gt; TxET QErr IO [(Text, Int, ZonedTime)]
-&gt; TxET QErr IO [(TriggerName, (Int, ZonedTime))]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query -&gt; TxET QErr IO [(Text, Int, ZonedTime)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-968"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-969"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-970"></span><span>          </span><span class="annot"><span class="">[ST.st|
          SELECT trigger_name, count(1), max(scheduled_at)
          FROM hdb_catalog.hdb_event_log_cleanups
          WHERE status='scheduled' AND trigger_name =
            ANY(SELECT n from  (VALUES #{triggerNamesValues}) AS X(n))
          GROUP BY trigger_name;
        |]</span></span><span>
</span><span id="line-977"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-978"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-979"></span><span>    </span><span id="local-6989586621687555448"><span class="annot"><span class="annottext">triggerNamesValues :: Text
</span><a href="#local-6989586621687555448"><span class="hs-identifier hs-var hs-var">triggerNamesValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall a. ToTxt a =&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-var">generateSQLValuesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TriggerName -&gt; Text) -&gt; [TriggerName] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621687555444"><span class="hs-identifier hs-var">triggerNames</span></a></span><span>
</span><span id="line-980"></span><span>
</span><span id="line-981"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteAllScheduledCleanupsTx"><span class="hs-identifier hs-type">deleteAllScheduledCleanupsTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-982"></span><span id="deleteAllScheduledCleanupsTx"><span class="annot"><span class="annottext">deleteAllScheduledCleanupsTx :: TriggerName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteAllScheduledCleanupsTx"><span class="hs-identifier hs-var hs-var">deleteAllScheduledCleanupsTx</span></a></span></span><span> </span><span id="local-6989586621687555450"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555450"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-983"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555451"><span class="annot"><span class="annottext">triggerNameText :: Text
</span><a href="#local-6989586621687555451"><span class="hs-identifier hs-var hs-var">triggerNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555450"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-984"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-985"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-986"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      DELETE from hdb_catalog.hdb_event_log_cleanups
      WHERE status = 'scheduled' AND trigger_name = $triggerNameText
    |]</span></span><span>
</span><span id="line-990"></span><span>
</span><span id="line-991"></span><span class="annot"><span class="hs-comment">-- | @deleteAllScheduledCleanups@ deletes all scheduled cleanup logs for a given event trigger</span></span><span>
</span><span id="line-992"></span><span id="local-6989586621687554030"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteAllScheduledCleanups"><span class="hs-identifier hs-type">deleteAllScheduledCleanups</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-993"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687554030"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554030"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-994"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-995"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-996"></span><span>  </span><span class="annot"><a href="#local-6989586621687554030"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-997"></span><span id="deleteAllScheduledCleanups"><span class="annot"><span class="annottext">deleteAllScheduledCleanups :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig -&gt; TriggerName -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteAllScheduledCleanups"><span class="hs-identifier hs-var hs-var">deleteAllScheduledCleanups</span></a></span></span><span> </span><span id="local-6989586621687555458"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555458"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687555459"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555459"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-998"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555458"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteAllScheduledCleanupsTx"><span class="hs-identifier hs-var">deleteAllScheduledCleanupsTx</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555459"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-999"></span><span>
</span><span id="line-1000"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletionTx"><span class="hs-identifier hs-type">getCleanupEventsForDeletionTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1001"></span><span id="getCleanupEventsForDeletionTx"><span class="annot"><span class="annottext">getCleanupEventsForDeletionTx :: TxE QErr [(Text, TriggerName)]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletionTx"><span class="hs-identifier hs-var hs-var">getCleanupEventsForDeletionTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1002"></span><span>  </span><span id="local-6989586621687555461"><span class="annot"><span class="annottext">[(Text, TriggerName)]
</span><a href="#local-6989586621687555461"><span class="hs-identifier hs-var">latestEvents</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1003"></span><span>    </span><span class="annot"><span class="annottext">((Text, Text) -&gt; (Text, TriggerName))
-&gt; [(Text, Text)] -&gt; [(Text, TriggerName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Text -&gt; TriggerName) -&gt; (Text, Text) -&gt; (Text, TriggerName)
forall b c d. (b -&gt; c) -&gt; (d, b) -&gt; (d, c)
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (d, b) (d, c)
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmptyText -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-var">TriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmptyText -&gt; TriggerName)
-&gt; (Text -&gt; NonEmptyText) -&gt; Text -&gt; TriggerName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; NonEmptyText
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier hs-var">mkNonEmptyTextUnsafe</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1004"></span><span>      </span><span class="annot"><span class="annottext">([(Text, Text)] -&gt; [(Text, TriggerName)])
-&gt; TxET QErr IO [(Text, Text)] -&gt; TxE QErr [(Text, TriggerName)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [(Text, Text)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-1005"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1006"></span><span>        </span><span class="annot"><span class="annottext">Query
</span><span class="">[ODBC.sql|
          select CAST(id AS nvarchar(36)), trigger_name
          from(
              SELECT id, trigger_name, ROW_NUMBER()
              OVER(PARTITION BY trigger_name ORDER BY scheduled_at DESC) AS rn
              FROM hdb_catalog.hdb_event_log_cleanups
              WHERE status = 'scheduled' AND scheduled_at &lt; SYSDATETIMEOFFSET() AT TIME ZONE 'UTC'
          ) AS a
          WHERE rn = 1
        |]</span></span><span>
</span><span id="line-1016"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555463"><span class="annot"><span class="annottext">cleanupIDs :: [Text]
</span><a href="#local-6989586621687555463"><span class="hs-identifier hs-var hs-var">cleanupIDs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Text, TriggerName) -&gt; Text) -&gt; [(Text, TriggerName)] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Text, TriggerName) -&gt; Text
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Text, TriggerName)]
</span><a href="#local-6989586621687555461"><span class="hs-identifier hs-var">latestEvents</span></a></span><span>
</span><span id="line-1017"></span><span>      </span><span id="local-6989586621687555464"><span class="annot"><span class="annottext">cleanupIDsSQLValue :: Text
</span><a href="#local-6989586621687555464"><span class="hs-identifier hs-var hs-var">cleanupIDsSQLValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall a. ToTxt a =&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-var">generateSQLValuesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687555463"><span class="hs-identifier hs-var">cleanupIDs</span></a></span><span>
</span><span id="line-1018"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr IO () -&gt; TxET QErr IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Text] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687555463"><span class="hs-identifier hs-var">cleanupIDs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; TxET QErr IO ())
-&gt; TxET QErr IO () -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1019"></span><span>    </span><span id="local-6989586621687555465"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687555465"><span class="hs-identifier hs-var">toDeadEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1020"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Text]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-1021"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1022"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-1023"></span><span>            </span><span class="annot"><span class="">[ST.st|
            SELECT CAST(id AS nvarchar(36)) FROM hdb_catalog.hdb_event_log_cleanups
            WHERE status = 'scheduled' AND scheduled_at &lt; SYSDATETIMEOFFSET() AT TIME ZONE 'UTC' AND id NOT IN
              (SELECT n from  (VALUES #{cleanupIDsSQLValue}) AS X(n));
          |]</span></span><span>
</span><span id="line-1028"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-1029"></span><span>    </span><span class="annot"><span class="annottext">[Text] -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markCleanupEventsAsDeadTx"><span class="hs-identifier hs-var">markCleanupEventsAsDeadTx</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687555465"><span class="hs-identifier hs-var">toDeadEvents</span></a></span><span>
</span><span id="line-1030"></span><span>
</span><span id="line-1031"></span><span>  </span><span class="annot"><span class="annottext">[(Text, TriggerName)] -&gt; TxE QErr [(Text, TriggerName)]
forall a. a -&gt; TxET QErr IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[(Text, TriggerName)]
</span><a href="#local-6989586621687555461"><span class="hs-identifier hs-var">latestEvents</span></a></span><span>
</span><span id="line-1032"></span><span>
</span><span id="line-1033"></span><span class="hs-comment">-- | @getCleanupEventsForDeletion@ returns the cleanup logs that are to be deleted.</span><span>
</span><span id="line-1034"></span><span class="hs-comment">-- This will perform the following steps:</span><span>
</span><span id="line-1035"></span><span class="hs-comment">--</span><span>
</span><span id="line-1036"></span><span class="hs-comment">-- 1. Get the scheduled cleanup events that were scheduled before current time.</span><span>
</span><span id="line-1037"></span><span class="hs-comment">-- 2. If there are multiple entries for the same trigger name with different scheduled time,</span><span>
</span><span id="line-1038"></span><span class="hs-comment">--    then fetch the latest entry and mark others as dead.</span><span>
</span><span id="line-1039"></span><span id="local-6989586621687554036"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletion"><span class="hs-identifier hs-type">getCleanupEventsForDeletion</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1040"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687554036"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554036"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1041"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1042"></span><span>  </span><span class="annot"><a href="#local-6989586621687554036"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-1043"></span><span id="getCleanupEventsForDeletion"><span class="annot"><span class="annottext">getCleanupEventsForDeletion :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig -&gt; m [(Text, TriggerName)]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletion"><span class="hs-identifier hs-var hs-var">getCleanupEventsForDeletion</span></a></span></span><span> </span><span id="local-6989586621687555473"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555473"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1044"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr [(Text, TriggerName)]) -&gt; m [(Text, TriggerName)]
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr [(Text, TriggerName)]) -&gt; m [(Text, TriggerName)])
-&gt; m (Either QErr [(Text, TriggerName)]) -&gt; m [(Text, TriggerName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr [(Text, TriggerName)])
-&gt; m (Either QErr [(Text, TriggerName)])
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr [(Text, TriggerName)])
 -&gt; m (Either QErr [(Text, TriggerName)]))
-&gt; IO (Either QErr [(Text, TriggerName)])
-&gt; m (Either QErr [(Text, TriggerName)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxE QErr [(Text, TriggerName)]
-&gt; IO (Either QErr [(Text, TriggerName)])
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555473"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr [(Text, TriggerName)]
 -&gt; IO (Either QErr [(Text, TriggerName)]))
-&gt; TxE QErr [(Text, TriggerName)]
-&gt; IO (Either QErr [(Text, TriggerName)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TxE QErr [(Text, TriggerName)]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getCleanupEventsForDeletionTx"><span class="hs-identifier hs-var">getCleanupEventsForDeletionTx</span></a></span><span>
</span><span id="line-1045"></span><span>
</span><span id="line-1046"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markCleanupEventsAsDeadTx"><span class="hs-identifier hs-type">markCleanupEventsAsDeadTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1047"></span><span id="markCleanupEventsAsDeadTx"><span class="annot"><span class="annottext">markCleanupEventsAsDeadTx :: [Text] -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markCleanupEventsAsDeadTx"><span class="hs-identifier hs-var hs-var">markCleanupEventsAsDeadTx</span></a></span></span><span> </span><span id="local-6989586621687555474"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687555474"><span class="hs-identifier hs-var">toDeadEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1048"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555475"><span class="annot"><span class="annottext">deadEventsValues :: Text
</span><a href="#local-6989586621687555475"><span class="hs-identifier hs-var hs-var">deadEventsValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall a. ToTxt a =&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-var">generateSQLValuesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687555474"><span class="hs-identifier hs-var">toDeadEvents</span></a></span><span>
</span><span id="line-1049"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr IO () -&gt; TxET QErr IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Text] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687555474"><span class="hs-identifier hs-var">toDeadEvents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1050"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; TxET QErr IO ())
-&gt; TxET QErr IO () -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1051"></span><span>    </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-1052"></span><span>    </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.st|
        UPDATE hdb_catalog.hdb_event_log_cleanups
        SET status = 'dead'
        WHERE id = ANY ( SELECT id from  (VALUES #{deadEventsValues}) AS X(id));
        |]</span></span><span>
</span><span id="line-1057"></span><span>
</span><span id="line-1058"></span><span id="local-6989586621687554038"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToDead"><span class="hs-identifier hs-type">updateCleanupEventStatusToDead</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1059"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687554038"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554038"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1060"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1061"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1062"></span><span>  </span><span class="annot"><a href="#local-6989586621687554038"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1063"></span><span id="updateCleanupEventStatusToDead"><span class="annot"><span class="annottext">updateCleanupEventStatusToDead :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig -&gt; [Text] -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToDead"><span class="hs-identifier hs-var hs-var">updateCleanupEventStatusToDead</span></a></span></span><span> </span><span id="local-6989586621687555482"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555482"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687555483"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687555483"><span class="hs-identifier hs-var">toDeadEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1064"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555482"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markCleanupEventsAsDeadTx"><span class="hs-identifier hs-var">markCleanupEventsAsDeadTx</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687555483"><span class="hs-identifier hs-var">toDeadEvents</span></a></span><span>
</span><span id="line-1065"></span><span>
</span><span id="line-1066"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPausedTx"><span class="hs-identifier hs-type">updateCleanupEventStatusToPausedTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1067"></span><span id="updateCleanupEventStatusToPausedTx"><span class="annot"><span class="annottext">updateCleanupEventStatusToPausedTx :: Text -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPausedTx"><span class="hs-identifier hs-var hs-var">updateCleanupEventStatusToPausedTx</span></a></span></span><span> </span><span id="local-6989586621687555485"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555485"><span class="hs-identifier hs-var">cleanupLogId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1068"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-1069"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1070"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.hdb_event_log_cleanups
          SET status = 'paused'
          WHERE id = $cleanupLogId
          |]</span></span><span>
</span><span id="line-1075"></span><span>
</span><span id="line-1076"></span><span class="annot"><span class="hs-comment">-- | @updateCleanupEventStatusToPaused@ updates the cleanup log status to `paused` if the event trigger configuration is paused.</span></span><span>
</span><span id="line-1077"></span><span id="local-6989586621687554040"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPaused"><span class="hs-identifier hs-type">updateCleanupEventStatusToPaused</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1078"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687554040"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554040"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1079"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1080"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1081"></span><span>  </span><span class="annot"><a href="#local-6989586621687554040"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1082"></span><span id="updateCleanupEventStatusToPaused"><span class="annot"><span class="annottext">updateCleanupEventStatusToPaused :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig -&gt; Text -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPaused"><span class="hs-identifier hs-var hs-var">updateCleanupEventStatusToPaused</span></a></span></span><span> </span><span id="local-6989586621687555492"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555492"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687555493"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555493"><span class="hs-identifier hs-var">cleanupLogId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1083"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555492"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToPausedTx"><span class="hs-identifier hs-var">updateCleanupEventStatusToPausedTx</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555493"><span class="hs-identifier hs-var">cleanupLogId</span></a></span><span>
</span><span id="line-1084"></span><span>
</span><span id="line-1085"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompletedTx"><span class="hs-identifier hs-type">updateCleanupEventStatusToCompletedTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-type">DeletedEventLogStats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1086"></span><span id="updateCleanupEventStatusToCompletedTx"><span class="annot"><span class="annottext">updateCleanupEventStatusToCompletedTx :: Text -&gt; DeletedEventLogStats -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompletedTx"><span class="hs-identifier hs-var hs-var">updateCleanupEventStatusToCompletedTx</span></a></span></span><span> </span><span id="local-6989586621687555495"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555495"><span class="hs-identifier hs-var">cleanupLogId</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-type">DeletedEventLogStats</span></a></span><span> </span><span id="local-6989586621687555497"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555497"><span class="hs-identifier hs-var">numEventLogs</span></a></span></span><span> </span><span id="local-6989586621687555498"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555498"><span class="hs-identifier hs-var">numInvocationLogs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1087"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-1088"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1089"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.hdb_event_log_cleanups
          SET status = 'completed', deleted_event_logs = $numEventLogs, deleted_event_invocation_logs = $numInvocationLogs
          WHERE id = $cleanupLogId
          |]</span></span><span>
</span><span id="line-1094"></span><span>
</span><span id="line-1095"></span><span class="hs-comment">-- | @updateCleanupEventStatusToCompleted@ updates the cleanup log status after the event logs are deleted.</span><span>
</span><span id="line-1096"></span><span class="hs-comment">-- This will perform the following steps:</span><span>
</span><span id="line-1097"></span><span class="hs-comment">--</span><span>
</span><span id="line-1098"></span><span class="hs-comment">-- 1. Updates the cleanup config status to `completed`.</span><span>
</span><span id="line-1099"></span><span class="hs-comment">-- 2. Updates the number of event logs and event invocation logs that were deleted for a trigger name</span><span>
</span><span id="line-1100"></span><span id="local-6989586621687554043"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompleted"><span class="hs-identifier hs-type">updateCleanupEventStatusToCompleted</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1101"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687554043"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554043"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1102"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1103"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1104"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-type">DeletedEventLogStats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1105"></span><span>  </span><span class="annot"><a href="#local-6989586621687554043"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1106"></span><span id="updateCleanupEventStatusToCompleted"><span class="annot"><span class="annottext">updateCleanupEventStatusToCompleted :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig -&gt; Text -&gt; DeletedEventLogStats -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompleted"><span class="hs-identifier hs-var hs-var">updateCleanupEventStatusToCompleted</span></a></span></span><span> </span><span id="local-6989586621687555505"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555505"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687555506"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555506"><span class="hs-identifier hs-var">cleanupLogId</span></a></span></span><span> </span><span id="local-6989586621687555507"><span class="annot"><span class="annottext">DeletedEventLogStats
</span><a href="#local-6989586621687555507"><span class="hs-identifier hs-var">delStats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1107"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555505"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; DeletedEventLogStats -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#updateCleanupEventStatusToCompletedTx"><span class="hs-identifier hs-var">updateCleanupEventStatusToCompletedTx</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555506"><span class="hs-identifier hs-var">cleanupLogId</span></a></span><span> </span><span class="annot"><span class="annottext">DeletedEventLogStats
</span><a href="#local-6989586621687555507"><span class="hs-identifier hs-var">delStats</span></a></span><span>
</span><span id="line-1108"></span><span>
</span><span id="line-1109"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogsTx"><span class="hs-identifier hs-type">deleteEventTriggerLogsTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerLogCleanupConfig"><span class="hs-identifier hs-type">TriggerLogCleanupConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-type">DeletedEventLogStats</span></a></span><span>
</span><span id="line-1110"></span><span id="deleteEventTriggerLogsTx"><span class="annot"><span class="annottext">deleteEventTriggerLogsTx :: TriggerLogCleanupConfig -&gt; TxE QErr DeletedEventLogStats
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogsTx"><span class="hs-identifier hs-var hs-var">deleteEventTriggerLogsTx</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerLogCleanupConfig"><span class="hs-identifier hs-type">TriggerLogCleanupConfig</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687555510"><span id="local-6989586621687555511"><span id="local-6989586621687555512"><span id="local-6989586621687555513"><span id="local-6989586621687555514"><span id="local-6989586621687555515"><span class="annot"><span class="annottext">Bool
Int
SourceName
TriggerName
tlccEventTriggerName :: TriggerName
tlccSourceName :: SourceName
tlccBatchSize :: Int
tlccClearOlderThan :: Int
tlccTimeout :: Int
tlccCleanInvocationLogs :: Bool
tlccEventTriggerName :: TriggerLogCleanupConfig -&gt; TriggerName
tlccSourceName :: TriggerLogCleanupConfig -&gt; SourceName
tlccBatchSize :: TriggerLogCleanupConfig -&gt; Int
tlccClearOlderThan :: TriggerLogCleanupConfig -&gt; Int
tlccTimeout :: TriggerLogCleanupConfig -&gt; Int
tlccCleanInvocationLogs :: TriggerLogCleanupConfig -&gt; Bool
</span><a href="#local-6989586621687555510"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1111"></span><span>  </span><span class="hs-comment">-- Setting the timeout</span><span>
</span><span id="line-1112"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-1113"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1114"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
          SET LOCK_TIMEOUT $qTimeout;
        |]</span></span><span>
</span><span id="line-1117"></span><span>  </span><span class="hs-comment">--  Select all the dead events based on criteria set in the cleanup config.</span><span>
</span><span id="line-1118"></span><span>  </span><span id="local-6989586621687555523"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621687555523"><span class="hs-identifier hs-var">deadEventIDs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1119"></span><span>    </span><span class="annot"><span class="annottext">(Text -&gt; EventId) -&gt; [Text] -&gt; [EventId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-var">EventId</span></a></span><span>
</span><span id="line-1120"></span><span>      </span><span class="annot"><span class="annottext">([Text] -&gt; [EventId])
-&gt; TxET QErr IO [Text] -&gt; TxET QErr IO [EventId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Text]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-1121"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1122"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          SELECT TOP ($qBatchSize) CAST(id AS nvarchar(36)) FROM hdb_catalog.event_log WITH (UPDLOCK, READPAST)
          WHERE ((delivered = 1 OR error = 1) AND trigger_name = $qTriggerName  )
          AND created_at &lt; DATEADD(HOUR, - $qRetentionPeriod, SYSDATETIMEOFFSET() AT TIME ZONE 'UTC')
          AND locked IS NULL
        |]</span></span><span>
</span><span id="line-1128"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[EventId] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621687555523"><span class="hs-identifier hs-var">deadEventIDs</span></a></span><span>
</span><span id="line-1129"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats
forall a. a -&gt; TxET QErr IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats)
-&gt; DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; DeletedEventLogStats
</span><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-var">DeletedEventLogStats</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1130"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1131"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687555527"><span class="annot"><span class="annottext">eventIdsValues :: Text
</span><a href="#local-6989586621687555527"><span class="hs-identifier hs-var hs-var">eventIdsValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EventId] -&gt; Text
forall a. ToTxt a =&gt; [a] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateSQLValuesFromList"><span class="hs-identifier hs-var">generateSQLValuesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621687555523"><span class="hs-identifier hs-var">deadEventIDs</span></a></span><span>
</span><span id="line-1132"></span><span>      </span><span class="hs-comment">--  Lock the events in the database so that other HGE instances don't pick them up for deletion.</span><span>
</span><span id="line-1133"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1134"></span><span>        </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-1135"></span><span>        </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.st|
          UPDATE hdb_catalog.event_log
          SET locked = SYSDATETIMEOFFSET() AT TIME ZONE 'UTC'
          WHERE id = ANY ( SELECT id from  (VALUES #{eventIdsValues}) AS X(id))
              AND locked IS NULL
          |]</span></span><span>
</span><span id="line-1141"></span><span>      </span><span class="hs-comment">--  Based on the config either delete the corresponding invocation logs or set trigger_name</span><span>
</span><span id="line-1142"></span><span>      </span><span class="hs-comment">--  to appropriate value. Please note that the event_id won't exist anymore in the event_log</span><span>
</span><span id="line-1143"></span><span>      </span><span class="hs-comment">--  table, but we are still retaining it for debugging purpose.</span><span>
</span><span id="line-1144"></span><span>      </span><span id="local-6989586621687555528"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621687555528"><span class="hs-identifier hs-var">deletedInvocationLogs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-comment">-- This will be an array of 1 and is only used to count the number of deleted rows.</span><span>
</span><span id="line-1145"></span><span>        </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Int]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1146"></span><span>          </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO [Int]) -&gt; Query -&gt; TxET QErr IO [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-1147"></span><span>          </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555515"><span class="hs-identifier hs-var">tlccCleanInvocationLogs</span></a></span><span>
</span><span id="line-1148"></span><span>            </span><span class="hs-keyword">then</span><span>
</span><span id="line-1149"></span><span>              </span><span class="annot"><span class="">[ST.st|
                DELETE FROM hdb_catalog.event_invocation_logs
                OUTPUT 1
                WHERE event_id = ANY ( SELECT id from  (VALUES #{eventIdsValues}) AS X(id));
                |]</span></span><span>
</span><span id="line-1154"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-1155"></span><span>              </span><span class="annot"><span class="">[ST.st|
                UPDATE hdb_catalog.event_invocation_logs
                SET trigger_name = '#{qTriggerName}'
                WHERE event_id = ANY ( SELECT id from  (VALUES #{eventIdsValues}) AS X(id));
                |]</span></span><span>
</span><span id="line-1160"></span><span>      </span><span class="hs-comment">--  Finally delete the event logs.</span><span>
</span><span id="line-1161"></span><span>      </span><span id="local-6989586621687555529"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621687555529"><span class="hs-identifier hs-var">deletedEventLogs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-comment">-- This will be an array of 1 and is only used to count the number of deleted rows.</span><span>
</span><span id="line-1162"></span><span>        </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Int]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1163"></span><span>          </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO [Int]) -&gt; Query -&gt; TxET QErr IO [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/odbc-0.2.7-3c7d85d816fece4c90be8de8848356fffc50fc0342725979614c93a5073dbb54/share/doc/html/src/Database.ODBC.SQLServer.html#rawUnescapedText"><span class="hs-identifier hs-var">rawUnescapedText</span></a></span><span>
</span><span id="line-1164"></span><span>          </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.st|
            DELETE FROM hdb_catalog.event_log
            OUTPUT 1
            WHERE id = ANY ( SELECT id from  (VALUES #{eventIdsValues}) AS X(id));
            |]</span></span><span>
</span><span id="line-1169"></span><span>      </span><span class="hs-comment">-- Removing the timeout (-1 is the default timeout)</span><span>
</span><span id="line-1170"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-1171"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1172"></span><span>        </span><span class="annot"><span class="annottext">Query
</span><span class="">[ODBC.sql|
              SET LOCK_TIMEOUT -1;
            |]</span></span><span>
</span><span id="line-1175"></span><span>      </span><span class="annot"><span class="annottext">DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats
forall a. a -&gt; TxET QErr IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats)
-&gt; DeletedEventLogStats -&gt; TxE QErr DeletedEventLogStats
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; DeletedEventLogStats
</span><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-var">DeletedEventLogStats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621687555529"><span class="hs-identifier hs-var">deletedEventLogs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621687555528"><span class="hs-identifier hs-var">deletedInvocationLogs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1176"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1177"></span><span>    </span><span id="local-6989586621687555522"><span class="annot"><span class="annottext">qTimeout :: Int
</span><a href="#local-6989586621687555522"><span class="hs-identifier hs-var hs-var">qTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555514"><span class="hs-identifier hs-var">tlccTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000</span></span><span>
</span><span id="line-1178"></span><span>    </span><span id="local-6989586621687555524"><span class="annot"><span class="annottext">qTriggerName :: Text
</span><a href="#local-6989586621687555524"><span class="hs-identifier hs-var hs-var">qTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555510"><span class="hs-identifier hs-var">tlccEventTriggerName</span></a></span><span>
</span><span id="line-1179"></span><span>    </span><span id="local-6989586621687555525"><span class="annot"><span class="annottext">qRetentionPeriod :: Int
</span><a href="#local-6989586621687555525"><span class="hs-identifier hs-var hs-var">qRetentionPeriod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555513"><span class="hs-identifier hs-var">tlccClearOlderThan</span></a></span><span>
</span><span id="line-1180"></span><span>    </span><span id="local-6989586621687555526"><span class="annot"><span class="annottext">qBatchSize :: Int
</span><a href="#local-6989586621687555526"><span class="hs-identifier hs-var hs-var">qBatchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555512"><span class="hs-identifier hs-var">tlccBatchSize</span></a></span><span>
</span><span id="line-1181"></span><span>
</span><span id="line-1182"></span><span class="hs-comment">-- | @deleteEventTriggerLogs@ deletes the event logs (and event invocation logs) based on the cleanup configuration given</span><span>
</span><span id="line-1183"></span><span class="hs-comment">-- This will perform the following steps:</span><span>
</span><span id="line-1184"></span><span class="hs-comment">--</span><span>
</span><span id="line-1185"></span><span class="hs-comment">-- 1. Select all the dead events based on criteria set in the cleanup config.</span><span>
</span><span id="line-1186"></span><span class="hs-comment">-- 2. Lock the events in the database so that other HGE instances don't pick them up for deletion.</span><span>
</span><span id="line-1187"></span><span class="hs-comment">-- 3. Based on the config, perform the delete action.</span><span>
</span><span id="line-1188"></span><span id="local-6989586621687554048"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogs"><span class="hs-identifier hs-type">deleteEventTriggerLogs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1189"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687554048"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554048"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1190"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1191"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerLogCleanupConfig"><span class="hs-identifier hs-type">TriggerLogCleanupConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1192"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerLogCleanupConfig"><span class="hs-identifier hs-type">TriggerLogCleanupConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventTriggerCleanupStatus"><span class="hs-identifier hs-type">EventTriggerCleanupStatus</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1193"></span><span>  </span><span class="annot"><a href="#local-6989586621687554048"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#DeletedEventLogStats"><span class="hs-identifier hs-type">DeletedEventLogStats</span></a></span></span><span>
</span><span id="line-1194"></span><span id="deleteEventTriggerLogs"><span class="annot"><span class="annottext">deleteEventTriggerLogs :: forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig
-&gt; TriggerLogCleanupConfig
-&gt; IO (Maybe (TriggerLogCleanupConfig, EventTriggerCleanupStatus))
-&gt; m DeletedEventLogStats
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogs"><span class="hs-identifier hs-var hs-var">deleteEventTriggerLogs</span></a></span></span><span> </span><span id="local-6989586621687555538"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555538"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687555539"><span class="annot"><span class="annottext">TriggerLogCleanupConfig
</span><a href="#local-6989586621687555539"><span class="hs-identifier hs-var">oldCleanupConfig</span></a></span></span><span> </span><span id="local-6989586621687555540"><span class="annot"><span class="annottext">IO (Maybe (TriggerLogCleanupConfig, EventTriggerCleanupStatus))
</span><a href="#local-6989586621687555540"><span class="hs-identifier hs-var">getLatestCleanupConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1195"></span><span>  </span><span class="annot"><span class="annottext">IO (Maybe (TriggerLogCleanupConfig, EventTriggerCleanupStatus))
-&gt; TriggerLogCleanupConfig
-&gt; (TriggerLogCleanupConfig
    -&gt; IO (Either QErr DeletedEventLogStats))
-&gt; m DeletedEventLogStats
forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
IO (Maybe (TriggerLogCleanupConfig, EventTriggerCleanupStatus))
-&gt; TriggerLogCleanupConfig
-&gt; (TriggerLogCleanupConfig
    -&gt; IO (Either QErr DeletedEventLogStats))
-&gt; m DeletedEventLogStats
</span><a href="Hasura.Eventing.Common.html#deleteEventTriggerLogsInBatchesWith"><span class="hs-identifier hs-var">deleteEventTriggerLogsInBatchesWith</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe (TriggerLogCleanupConfig, EventTriggerCleanupStatus))
</span><a href="#local-6989586621687555540"><span class="hs-identifier hs-var">getLatestCleanupConfig</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerLogCleanupConfig
</span><a href="#local-6989586621687555539"><span class="hs-identifier hs-var">oldCleanupConfig</span></a></span><span> </span><span class="annot"><span class="annottext">((TriggerLogCleanupConfig -&gt; IO (Either QErr DeletedEventLogStats))
 -&gt; m DeletedEventLogStats)
-&gt; (TriggerLogCleanupConfig
    -&gt; IO (Either QErr DeletedEventLogStats))
-&gt; m DeletedEventLogStats
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687555542"><span class="annot"><span class="annottext">TriggerLogCleanupConfig
</span><a href="#local-6989586621687555542"><span class="hs-identifier hs-var">cleanupConfig</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1196"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxE QErr DeletedEventLogStats
-&gt; IO (Either QErr DeletedEventLogStats)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555538"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr DeletedEventLogStats
 -&gt; IO (Either QErr DeletedEventLogStats))
-&gt; TxE QErr DeletedEventLogStats
-&gt; IO (Either QErr DeletedEventLogStats)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerLogCleanupConfig -&gt; TxE QErr DeletedEventLogStats
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#deleteEventTriggerLogsTx"><span class="hs-identifier hs-var">deleteEventTriggerLogsTx</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerLogCleanupConfig
</span><a href="#local-6989586621687555542"><span class="hs-identifier hs-var">cleanupConfig</span></a></span><span>
</span><span id="line-1197"></span><span>
</span><span id="line-1198"></span><span id="local-6989586621687554052"><span id="local-6989586621687554053"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventLogs"><span class="hs-identifier hs-type">fetchEventLogs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1199"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687554052"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554052"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1200"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1201"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#GetEventLogs"><span class="hs-identifier hs-type">GetEventLogs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554053"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1202"></span><span>  </span><span class="annot"><a href="#local-6989586621687554052"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventLog"><span class="hs-identifier hs-type">EventLog</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-1203"></span><span id="fetchEventLogs"><span class="annot"><span class="annottext">fetchEventLogs :: forall (m :: * -&gt; *) (b :: BackendType).
(MonadIO m, MonadError QErr m) =&gt;
MSSQLSourceConfig -&gt; GetEventLogs b -&gt; m [EventLog]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventLogs"><span class="hs-identifier hs-var hs-var">fetchEventLogs</span></a></span></span><span> </span><span id="local-6989586621687555552"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555552"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687555553"><span class="annot"><span class="annottext">GetEventLogs b
</span><a href="#local-6989586621687555553"><span class="hs-identifier hs-var">getEventLogs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1204"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr [EventLog]) -&gt; m (Either QErr [EventLog])
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO [EventLog] -&gt; IO (Either QErr [EventLog])
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceReadTx"><span class="hs-identifier hs-var">runMSSQLSourceReadTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555552"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO [EventLog] -&gt; IO (Either QErr [EventLog]))
-&gt; TxET QErr IO [EventLog] -&gt; IO (Either QErr [EventLog])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GetEventLogs b -&gt; TxET QErr IO [EventLog]
forall (b :: BackendType).
GetEventLogs b -&gt; TxET QErr IO [EventLog]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventLogsTxE"><span class="hs-identifier hs-var">fetchEventLogsTxE</span></a></span><span> </span><span class="annot"><span class="annottext">GetEventLogs b
</span><a href="#local-6989586621687555553"><span class="hs-identifier hs-var">getEventLogs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1205"></span><span>    </span><span class="annot"><span class="annottext">m (Either QErr [EventLog])
-&gt; (QErr -&gt; m [EventLog]) -&gt; m [EventLog]
forall (m :: * -&gt; *) e a.
Monad m =&gt;
m (Either e a) -&gt; (e -&gt; m a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onLeftM"><span class="hs-operator hs-var">`onLeftM`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QErr -&gt; m [EventLog]
forall a. QErr -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(QErr -&gt; m [EventLog]) -&gt; (QErr -&gt; QErr) -&gt; QErr -&gt; m [EventLog]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; QErr -&gt; QErr
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#prefixQErr"><span class="hs-identifier hs-var">prefixQErr</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected error while fetching event logs: &quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1206"></span><span>
</span><span id="line-1207"></span><span id="local-6989586621687554058"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventLogsTxE"><span class="hs-identifier hs-type">fetchEventLogsTxE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#GetEventLogs"><span class="hs-identifier hs-type">GetEventLogs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554058"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventLog"><span class="hs-identifier hs-type">EventLog</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-1208"></span><span id="fetchEventLogsTxE"><span class="annot"><span class="annottext">fetchEventLogsTxE :: forall (b :: BackendType).
GetEventLogs b -&gt; TxET QErr IO [EventLog]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventLogsTxE"><span class="hs-identifier hs-var hs-var">fetchEventLogsTxE</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#GetEventLogs"><span class="hs-identifier hs-type">GetEventLogs</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687555621"><span id="local-6989586621687555622"><span id="local-6989586621687555623"><span id="local-6989586621687555624"><span id="local-6989586621687555625"><span class="annot"><span class="annottext">Int
SourceName
EventLogStatus
TriggerName
_gelName :: TriggerName
_gelSourceName :: SourceName
_gelLimit :: Int
_gelOffset :: Int
_gelStatus :: EventLogStatus
_gelName :: forall (b :: BackendType). GetEventLogs b -&gt; TriggerName
_gelSourceName :: forall (b :: BackendType). GetEventLogs b -&gt; SourceName
_gelLimit :: forall (b :: BackendType). GetEventLogs b -&gt; Int
_gelOffset :: forall (b :: BackendType). GetEventLogs b -&gt; Int
_gelStatus :: forall (b :: BackendType). GetEventLogs b -&gt; EventLogStatus
</span><a href="#local-6989586621687555621"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1209"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EventLogStatus
</span><a href="#local-6989586621687555631"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1210"></span><span>    </span><span class="annot"><span class="annottext">EventLogStatus
</span><a href="Hasura.RQL.Types.EventTrigger.html#Pending"><span class="hs-identifier hs-var">Pending</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1211"></span><span>      </span><span id="local-6989586621687555633"><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)]
</span><a href="#local-6989586621687555633"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1212"></span><span>        </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
       Maybe ByteString, Maybe ByteString, Bool)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-1213"></span><span>          </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1214"></span><span>          </span><span class="annot"><span class="">[ODBC.sql|
            SELECT CONVERT(varchar(MAX), id), schema_name, table_name, trigger_name, payload, delivered, error, tries,
            CONVERT(varchar(MAX), created_at), CONVERT(varchar(MAX), locked), CONVERT(varchar(MAX), next_retry_at), archived
            FROM hdb_catalog.event_log
            WHERE trigger_name = $triggerName
            AND delivered=0 AND error=0 AND archived=0
            ORDER BY created_at DESC OFFSET $offset ROWS FETCH NEXT $limit ROWS ONLY;
          |]</span></span><span>
</span><span id="line-1222"></span><span>      </span><span class="annot"><span class="annottext">((ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)
 -&gt; TxET QErr IO EventLog)
-&gt; [(ByteString, Text, Text, Text, Text, Bool, Bool, Int,
     ByteString, Maybe ByteString, Maybe ByteString, Bool)]
-&gt; TxET QErr IO [EventLog]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
 Maybe ByteString, Maybe ByteString, Bool)
-&gt; TxET QErr IO EventLog
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
 Maybe ByteString, Maybe ByteString, Bool)
-&gt; m EventLog
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#uncurryEventLog"><span class="hs-identifier hs-var">uncurryEventLog</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)]
</span><a href="#local-6989586621687555633"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-1223"></span><span>    </span><span class="annot"><span class="annottext">EventLogStatus
</span><a href="Hasura.RQL.Types.EventTrigger.html#Processed"><span class="hs-identifier hs-var">Processed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1224"></span><span>      </span><span id="local-6989586621687555639"><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)]
</span><a href="#local-6989586621687555639"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1225"></span><span>        </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
       Maybe ByteString, Maybe ByteString, Bool)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-1226"></span><span>          </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1227"></span><span>          </span><span class="annot"><span class="">[ODBC.sql|
            SELECT CONVERT(varchar(MAX), id), schema_name, table_name, trigger_name, payload, delivered, error, tries,
            CONVERT(varchar(MAX), created_at), CONVERT(varchar(MAX), locked), CONVERT(varchar(MAX), next_retry_at), archived
            FROM hdb_catalog.event_log
            WHERE trigger_name = $triggerName
            AND (delivered=1 OR error=1) AND archived=0
            ORDER BY created_at DESC OFFSET $offset ROWS FETCH NEXT $limit ROWS ONLY;
          |]</span></span><span>
</span><span id="line-1235"></span><span>      </span><span class="annot"><span class="annottext">((ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)
 -&gt; TxET QErr IO EventLog)
-&gt; [(ByteString, Text, Text, Text, Text, Bool, Bool, Int,
     ByteString, Maybe ByteString, Maybe ByteString, Bool)]
-&gt; TxET QErr IO [EventLog]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
 Maybe ByteString, Maybe ByteString, Bool)
-&gt; TxET QErr IO EventLog
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
 Maybe ByteString, Maybe ByteString, Bool)
-&gt; m EventLog
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#uncurryEventLog"><span class="hs-identifier hs-var">uncurryEventLog</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)]
</span><a href="#local-6989586621687555639"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-1236"></span><span>    </span><span class="annot"><span class="annottext">EventLogStatus
</span><a href="Hasura.RQL.Types.EventTrigger.html#All"><span class="hs-identifier hs-var">All</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1237"></span><span>      </span><span id="local-6989586621687555641"><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)]
</span><a href="#local-6989586621687555641"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1238"></span><span>        </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
       Maybe ByteString, Maybe ByteString, Bool)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-1239"></span><span>          </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1240"></span><span>          </span><span class="annot"><span class="">[ODBC.sql|
            SELECT CONVERT(varchar(MAX), id), schema_name, table_name, trigger_name, payload, delivered, error, tries,
            CONVERT(varchar(MAX), created_at), CONVERT(varchar(MAX), locked), CONVERT(varchar(MAX), next_retry_at), archived
            FROM hdb_catalog.event_log
            WHERE trigger_name = $triggerName
            ORDER BY created_at DESC OFFSET $offset ROWS FETCH NEXT $limit ROWS ONLY;
          |]</span></span><span>
</span><span id="line-1247"></span><span>      </span><span class="annot"><span class="annottext">((ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)
 -&gt; TxET QErr IO EventLog)
-&gt; [(ByteString, Text, Text, Text, Text, Bool, Bool, Int,
     ByteString, Maybe ByteString, Maybe ByteString, Bool)]
-&gt; TxET QErr IO [EventLog]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
 Maybe ByteString, Maybe ByteString, Bool)
-&gt; TxET QErr IO EventLog
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
 Maybe ByteString, Maybe ByteString, Bool)
-&gt; m EventLog
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#uncurryEventLog"><span class="hs-identifier hs-var">uncurryEventLog</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)]
</span><a href="#local-6989586621687555641"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-1248"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1249"></span><span>    </span><span id="local-6989586621687555634"><span class="annot"><span class="annottext">triggerName :: Text
</span><a href="#local-6989586621687555634"><span class="hs-identifier hs-var hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555621"><span class="hs-identifier hs-var">_gelName</span></a></span><span>
</span><span id="line-1250"></span><span>    </span><span id="local-6989586621687555635"><span class="annot"><span class="annottext">limit :: Int
</span><a href="#local-6989586621687555635"><span class="hs-identifier hs-var hs-var">limit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555623"><span class="hs-identifier hs-var">_gelLimit</span></a></span><span>
</span><span id="line-1251"></span><span>    </span><span id="local-6989586621687555636"><span class="annot"><span class="annottext">offset :: Int
</span><a href="#local-6989586621687555636"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555624"><span class="hs-identifier hs-var">_gelOffset</span></a></span><span>
</span><span id="line-1252"></span><span>    </span><span id="local-6989586621687555631"><span class="annot"><span class="annottext">status :: EventLogStatus
</span><a href="#local-6989586621687555631"><span class="hs-identifier hs-var hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventLogStatus
</span><a href="#local-6989586621687555625"><span class="hs-identifier hs-var">_gelStatus</span></a></span><span>
</span><span id="line-1253"></span><span>
</span><span id="line-1254"></span><span id="local-6989586621687554082"><span id="local-6989586621687554083"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventInvocationLogs"><span class="hs-identifier hs-type">fetchEventInvocationLogs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1255"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554082"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687554082"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1256"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1257"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#GetEventInvocations"><span class="hs-identifier hs-type">GetEventInvocations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554083"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1258"></span><span>  </span><span class="annot"><a href="#local-6989586621687554082"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventInvocationLog"><span class="hs-identifier hs-type">EventInvocationLog</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-1259"></span><span id="fetchEventInvocationLogs"><span class="annot"><span class="annottext">fetchEventInvocationLogs :: forall (m :: * -&gt; *) (b :: BackendType).
(MonadError QErr m, MonadIO m) =&gt;
MSSQLSourceConfig
-&gt; GetEventInvocations b -&gt; m [EventInvocationLog]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventInvocationLogs"><span class="hs-identifier hs-var hs-var">fetchEventInvocationLogs</span></a></span></span><span> </span><span id="local-6989586621687555651"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555651"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687555652"><span class="annot"><span class="annottext">GetEventInvocations b
</span><a href="#local-6989586621687555652"><span class="hs-identifier hs-var">getEventInvocationLogs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1260"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr [EventInvocationLog])
-&gt; m (Either QErr [EventInvocationLog])
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO [EventInvocationLog]
-&gt; IO (Either QErr [EventInvocationLog])
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceReadTx"><span class="hs-identifier hs-var">runMSSQLSourceReadTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555651"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO [EventInvocationLog]
 -&gt; IO (Either QErr [EventInvocationLog]))
-&gt; TxET QErr IO [EventInvocationLog]
-&gt; IO (Either QErr [EventInvocationLog])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GetEventInvocations b -&gt; TxET QErr IO [EventInvocationLog]
forall (b :: BackendType).
GetEventInvocations b -&gt; TxET QErr IO [EventInvocationLog]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventInvocationLogsTxE"><span class="hs-identifier hs-var">fetchEventInvocationLogsTxE</span></a></span><span> </span><span class="annot"><span class="annottext">GetEventInvocations b
</span><a href="#local-6989586621687555652"><span class="hs-identifier hs-var">getEventInvocationLogs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1261"></span><span>    </span><span class="annot"><span class="annottext">m (Either QErr [EventInvocationLog])
-&gt; (QErr -&gt; m [EventInvocationLog]) -&gt; m [EventInvocationLog]
forall (m :: * -&gt; *) e a.
Monad m =&gt;
m (Either e a) -&gt; (e -&gt; m a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onLeftM"><span class="hs-operator hs-var">`onLeftM`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QErr -&gt; m [EventInvocationLog]
forall a. QErr -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(QErr -&gt; m [EventInvocationLog])
-&gt; (QErr -&gt; QErr) -&gt; QErr -&gt; m [EventInvocationLog]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; QErr -&gt; QErr
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#prefixQErr"><span class="hs-identifier hs-var">prefixQErr</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected error while fetching invocation logs: &quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1262"></span><span>
</span><span id="line-1263"></span><span id="local-6989586621687554088"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventInvocationLogsTxE"><span class="hs-identifier hs-type">fetchEventInvocationLogsTxE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#GetEventInvocations"><span class="hs-identifier hs-type">GetEventInvocations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554088"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventInvocationLog"><span class="hs-identifier hs-type">EventInvocationLog</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-1264"></span><span id="fetchEventInvocationLogsTxE"><span class="annot"><span class="annottext">fetchEventInvocationLogsTxE :: forall (b :: BackendType).
GetEventInvocations b -&gt; TxET QErr IO [EventInvocationLog]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventInvocationLogsTxE"><span class="hs-identifier hs-var hs-var">fetchEventInvocationLogsTxE</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#GetEventInvocations"><span class="hs-identifier hs-type">GetEventInvocations</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687555676"><span id="local-6989586621687555677"><span id="local-6989586621687555678"><span id="local-6989586621687555679"><span class="annot"><span class="annottext">Int
SourceName
TriggerName
_geiName :: TriggerName
_geiSourceName :: SourceName
_geiLimit :: Int
_geiOffset :: Int
_geiName :: forall (b :: BackendType). GetEventInvocations b -&gt; TriggerName
_geiSourceName :: forall (b :: BackendType). GetEventInvocations b -&gt; SourceName
_geiLimit :: forall (b :: BackendType). GetEventInvocations b -&gt; Int
_geiOffset :: forall (b :: BackendType). GetEventInvocations b -&gt; Int
</span><a href="#local-6989586621687555676"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1265"></span><span>  </span><span id="local-6989586621687555684"><span class="annot"><span class="annottext">[(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)]
</span><a href="#local-6989586621687555684"><span class="hs-identifier hs-var">invocations</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1266"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-1267"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1268"></span><span>      </span><span class="annot"><span class="">[ODBC.sql|
        SELECT CONVERT(varchar(MAX), id), trigger_name, CONVERT(varchar(MAX), event_id),
        status, request, response, CONVERT(varchar(MAX), created_at)
        FROM hdb_catalog.event_invocation_logs
        WHERE trigger_name = $triggerName
        ORDER BY created_at DESC OFFSET $offset ROWS FETCH NEXT $limit ROWS ONLY;
      |]</span></span><span>
</span><span id="line-1275"></span><span>  </span><span class="annot"><span class="annottext">((ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)
 -&gt; TxET QErr IO EventInvocationLog)
-&gt; [(ByteString, Text, ByteString, Maybe Int, Text, Text,
     ByteString)]
-&gt; TxET QErr IO [EventInvocationLog]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)
-&gt; TxET QErr IO EventInvocationLog
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)
-&gt; m EventInvocationLog
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#uncurryEventInvocationLog"><span class="hs-identifier hs-var">uncurryEventInvocationLog</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)]
</span><a href="#local-6989586621687555684"><span class="hs-identifier hs-var">invocations</span></a></span><span>
</span><span id="line-1276"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1277"></span><span>    </span><span id="local-6989586621687555685"><span class="annot"><span class="annottext">triggerName :: Text
</span><a href="#local-6989586621687555685"><span class="hs-identifier hs-var hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621687555676"><span class="hs-identifier hs-var">_geiName</span></a></span><span>
</span><span id="line-1278"></span><span>    </span><span id="local-6989586621687555686"><span class="annot"><span class="annottext">limit :: Int
</span><a href="#local-6989586621687555686"><span class="hs-identifier hs-var hs-var">limit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555678"><span class="hs-identifier hs-var">_geiLimit</span></a></span><span>
</span><span id="line-1279"></span><span>    </span><span id="local-6989586621687555687"><span class="annot"><span class="annottext">offset :: Int
</span><a href="#local-6989586621687555687"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555679"><span class="hs-identifier hs-var">_geiOffset</span></a></span><span>
</span><span id="line-1280"></span><span>
</span><span id="line-1281"></span><span id="local-6989586621687554101"><span id="local-6989586621687554102"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventById"><span class="hs-identifier hs-type">fetchEventById</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1282"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554101"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687554101"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1283"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1284"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#GetEventById"><span class="hs-identifier hs-type">GetEventById</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554102"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1285"></span><span>  </span><span class="annot"><a href="#local-6989586621687554101"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventLogWithInvocations"><span class="hs-identifier hs-type">EventLogWithInvocations</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1286"></span><span id="fetchEventById"><span class="annot"><span class="annottext">fetchEventById :: forall (m :: * -&gt; *) (b :: BackendType).
(MonadError QErr m, MonadIO m) =&gt;
MSSQLSourceConfig -&gt; GetEventById b -&gt; m EventLogWithInvocations
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventById"><span class="hs-identifier hs-var hs-var">fetchEventById</span></a></span></span><span> </span><span id="local-6989586621687555707"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555707"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687555708"><span class="annot"><span class="annottext">GetEventById b
</span><a href="#local-6989586621687555708"><span class="hs-identifier hs-var">getEventById</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1287"></span><span>  </span><span id="local-6989586621687555709"><span class="annot"><span class="annottext">Either QErr EventLogWithInvocations
</span><a href="#local-6989586621687555709"><span class="hs-identifier hs-var">fetchEventByIdTxE'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either QErr EventLogWithInvocations)
-&gt; m (Either QErr EventLogWithInvocations)
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr EventLogWithInvocations)
 -&gt; m (Either QErr EventLogWithInvocations))
-&gt; IO (Either QErr EventLogWithInvocations)
-&gt; m (Either QErr EventLogWithInvocations)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO EventLogWithInvocations
-&gt; IO (Either QErr EventLogWithInvocations)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceReadTx"><span class="hs-identifier hs-var">runMSSQLSourceReadTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621687555707"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO EventLogWithInvocations
 -&gt; IO (Either QErr EventLogWithInvocations))
-&gt; TxET QErr IO EventLogWithInvocations
-&gt; IO (Either QErr EventLogWithInvocations)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GetEventById b -&gt; TxET QErr IO EventLogWithInvocations
forall (b :: BackendType).
GetEventById b -&gt; TxET QErr IO EventLogWithInvocations
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventByIdTxE"><span class="hs-identifier hs-var">fetchEventByIdTxE</span></a></span><span> </span><span class="annot"><span class="annottext">GetEventById b
</span><a href="#local-6989586621687555708"><span class="hs-identifier hs-var">getEventById</span></a></span><span>
</span><span id="line-1288"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr EventLogWithInvocations
</span><a href="#local-6989586621687555709"><span class="hs-identifier hs-var">fetchEventByIdTxE'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1289"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687555711"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687555711"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1290"></span><span>      </span><span class="annot"><span class="annottext">QErr -&gt; m EventLogWithInvocations
forall a. QErr -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-1291"></span><span>        </span><span class="annot"><span class="annottext">(QErr -&gt; m EventLogWithInvocations)
-&gt; QErr -&gt; m EventLogWithInvocations
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; QErr -&gt; QErr
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#prefixQErr"><span class="hs-identifier hs-var">prefixQErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected error while fetching event with id &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555712"><span class="hs-identifier hs-var">eventId</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687555711"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1292"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687555713"><span class="annot"><span class="annottext">EventLogWithInvocations
</span><a href="#local-6989586621687555713"><span class="hs-identifier hs-var">eventLogWithInvocations</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1293"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Maybe EventLog -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLogWithInvocations -&gt; Maybe EventLog
</span><a href="Hasura.RQL.Types.EventTrigger.html#elwiEvent"><span class="hs-identifier hs-var">elwiEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLogWithInvocations
</span><a href="#local-6989586621687555713"><span class="hs-identifier hs-var">eventLogWithInvocations</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1294"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m EventLogWithInvocations
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#NotExists"><span class="hs-identifier hs-var">NotExists</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555716"><span class="hs-identifier hs-var">errMsg</span></a></span><span>
</span><span id="line-1295"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">EventLogWithInvocations -&gt; m EventLogWithInvocations
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">EventLogWithInvocations
</span><a href="#local-6989586621687555713"><span class="hs-identifier hs-var">eventLogWithInvocations</span></a></span><span>
</span><span id="line-1296"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1297"></span><span>    </span><span id="local-6989586621687555712"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621687555712"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GetEventById b -&gt; EventId
forall (b :: BackendType). GetEventById b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#_gebiEventId"><span class="hs-identifier hs-var">_gebiEventId</span></a></span><span> </span><span class="annot"><span class="annottext">GetEventById b
</span><a href="#local-6989586621687555708"><span class="hs-identifier hs-var">getEventById</span></a></span><span>
</span><span id="line-1298"></span><span>    </span><span id="local-6989586621687555716"><span class="annot"><span class="annottext">errMsg :: Text
</span><a href="#local-6989586621687555716"><span class="hs-identifier hs-var hs-var">errMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event id &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555712"><span class="hs-identifier hs-var">eventId</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; does not exist&quot;</span></span><span>
</span><span id="line-1299"></span><span>
</span><span id="line-1300"></span><span id="local-6989586621687554107"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventByIdTxE"><span class="hs-identifier hs-type">fetchEventByIdTxE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#GetEventById"><span class="hs-identifier hs-type">GetEventById</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554107"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventLogWithInvocations"><span class="hs-identifier hs-type">EventLogWithInvocations</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1301"></span><span id="fetchEventByIdTxE"><span class="annot"><span class="annottext">fetchEventByIdTxE :: forall (b :: BackendType).
GetEventById b -&gt; TxET QErr IO EventLogWithInvocations
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEventByIdTxE"><span class="hs-identifier hs-var hs-var">fetchEventByIdTxE</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#GetEventById"><span class="hs-identifier hs-type">GetEventById</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687555760"><span id="local-6989586621687555761"><span id="local-6989586621687555762"><span id="local-6989586621687555763"><span class="annot"><span class="annottext">Int
EventId
SourceName
_gebiEventId :: forall (b :: BackendType). GetEventById b -&gt; EventId
_gebiSourceName :: SourceName
_gebiEventId :: EventId
_gebiInvocationLogLimit :: Int
_gebiInvocationLogOffset :: Int
_gebiSourceName :: forall (b :: BackendType). GetEventById b -&gt; SourceName
_gebiInvocationLogLimit :: forall (b :: BackendType). GetEventById b -&gt; Int
_gebiInvocationLogOffset :: forall (b :: BackendType). GetEventById b -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#_gebiEventId"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1302"></span><span>  </span><span id="local-6989586621687555767"><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)]
</span><a href="#local-6989586621687555767"><span class="hs-identifier hs-var">eventsQuery</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1303"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
       Maybe ByteString, Maybe ByteString, Bool)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-1304"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1305"></span><span>      </span><span class="annot"><span class="">[ODBC.sql|
        SELECT CONVERT(varchar(MAX), id), schema_name, table_name, trigger_name, payload, delivered, error, tries,
        CONVERT(varchar(MAX), created_at), CONVERT(varchar(MAX), locked), CONVERT(varchar(MAX), next_retry_at), archived
        FROM hdb_catalog.event_log
        WHERE id = $eventId;
      |]</span></span><span>
</span><span id="line-1311"></span><span>  </span><span id="local-6989586621687555769"><span class="annot"><span class="annottext">[EventLog]
</span><a href="#local-6989586621687555769"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)
 -&gt; TxET QErr IO EventLog)
-&gt; [(ByteString, Text, Text, Text, Text, Bool, Bool, Int,
     ByteString, Maybe ByteString, Maybe ByteString, Bool)]
-&gt; TxET QErr IO [EventLog]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
 Maybe ByteString, Maybe ByteString, Bool)
-&gt; TxET QErr IO EventLog
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
 Maybe ByteString, Maybe ByteString, Bool)
-&gt; m EventLog
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#uncurryEventLog"><span class="hs-identifier hs-var">uncurryEventLog</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
  Maybe ByteString, Maybe ByteString, Bool)]
</span><a href="#local-6989586621687555767"><span class="hs-identifier hs-var">eventsQuery</span></a></span><span>
</span><span id="line-1312"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[EventLog]
</span><a href="#local-6989586621687555769"><span class="hs-identifier hs-var">events</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1313"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EventLogWithInvocations -&gt; TxET QErr IO EventLogWithInvocations
forall a. a -&gt; TxET QErr IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(EventLogWithInvocations -&gt; TxET QErr IO EventLogWithInvocations)
-&gt; EventLogWithInvocations -&gt; TxET QErr IO EventLogWithInvocations
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe EventLog -&gt; [EventInvocationLog] -&gt; EventLogWithInvocations
</span><a href="Hasura.RQL.Types.EventTrigger.html#EventLogWithInvocations"><span class="hs-identifier hs-var">EventLogWithInvocations</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EventLog
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1314"></span><span>    </span><span class="hs-special">[</span><span id="local-6989586621687555771"><span class="annot"><span class="annottext">EventLog
</span><a href="#local-6989586621687555771"><span class="hs-identifier hs-var">event</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1315"></span><span>      </span><span id="local-6989586621687555772"><span class="annot"><span class="annottext">[(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)]
</span><a href="#local-6989586621687555772"><span class="hs-identifier hs-var">invocationsQuery</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1316"></span><span>        </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-1317"></span><span>          </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-1318"></span><span>          </span><span class="annot"><span class="">[ODBC.sql|
            SELECT CONVERT(varchar(MAX), id), trigger_name, CONVERT(varchar(MAX), event_id),
            status, request, response, CONVERT(varchar(MAX), created_at)
            FROM hdb_catalog.event_invocation_logs
            WHERE event_id = $eventId
            ORDER BY created_at DESC OFFSET $offset ROWS FETCH NEXT $limit ROWS ONLY;
          |]</span></span><span>
</span><span id="line-1325"></span><span>      </span><span id="local-6989586621687555775"><span class="annot"><span class="annottext">[EventInvocationLog]
</span><a href="#local-6989586621687555775"><span class="hs-identifier hs-var">invocations</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)
 -&gt; TxET QErr IO EventInvocationLog)
-&gt; [(ByteString, Text, ByteString, Maybe Int, Text, Text,
     ByteString)]
-&gt; TxET QErr IO [EventInvocationLog]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)
-&gt; TxET QErr IO EventInvocationLog
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)
-&gt; m EventInvocationLog
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#uncurryEventInvocationLog"><span class="hs-identifier hs-var">uncurryEventInvocationLog</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)]
</span><a href="#local-6989586621687555772"><span class="hs-identifier hs-var">invocationsQuery</span></a></span><span>
</span><span id="line-1326"></span><span>      </span><span class="annot"><span class="annottext">EventLogWithInvocations -&gt; TxET QErr IO EventLogWithInvocations
forall a. a -&gt; TxET QErr IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(EventLogWithInvocations -&gt; TxET QErr IO EventLogWithInvocations)
-&gt; EventLogWithInvocations -&gt; TxET QErr IO EventLogWithInvocations
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe EventLog -&gt; [EventInvocationLog] -&gt; EventLogWithInvocations
</span><a href="Hasura.RQL.Types.EventTrigger.html#EventLogWithInvocations"><span class="hs-identifier hs-var">EventLogWithInvocations</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLog -&gt; Maybe EventLog
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">EventLog
</span><a href="#local-6989586621687555771"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EventInvocationLog]
</span><a href="#local-6989586621687555775"><span class="hs-identifier hs-var">invocations</span></a></span><span>
</span><span id="line-1327"></span><span>    </span><span class="annot"><span class="annottext">[EventLog]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO EventLogWithInvocations
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; TxET QErr IO EventLogWithInvocations)
-&gt; Text -&gt; TxET QErr IO EventLogWithInvocations
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Unexpected error: Multiple events present with event id &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555768"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-1328"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1329"></span><span>    </span><span id="local-6989586621687555768"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621687555768"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621687555761"><span class="hs-identifier hs-var">_gebiEventId</span></a></span><span>
</span><span id="line-1330"></span><span>    </span><span id="local-6989586621687555773"><span class="annot"><span class="annottext">limit :: Int
</span><a href="#local-6989586621687555773"><span class="hs-identifier hs-var hs-var">limit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555762"><span class="hs-identifier hs-var">_gebiInvocationLogLimit</span></a></span><span>
</span><span id="line-1331"></span><span>    </span><span id="local-6989586621687555774"><span class="annot"><span class="annottext">offset :: Int
</span><a href="#local-6989586621687555774"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555763"><span class="hs-identifier hs-var">_gebiInvocationLogOffset</span></a></span><span>
</span><span id="line-1332"></span><span>
</span><span id="line-1333"></span><span id="local-6989586621687554081"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#uncurryEventLog"><span class="hs-identifier hs-type">uncurryEventLog</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1334"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554081"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1335"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1336"></span><span>  </span><span class="annot"><a href="#local-6989586621687554081"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventLog"><span class="hs-identifier hs-type">EventLog</span></a></span></span><span>
</span><span id="line-1337"></span><span id="uncurryEventLog"><span class="annot"><span class="annottext">uncurryEventLog :: forall (m :: * -&gt; *).
MonadError QErr m =&gt;
(ByteString, Text, Text, Text, Text, Bool, Bool, Int, ByteString,
 Maybe ByteString, Maybe ByteString, Bool)
-&gt; m EventLog
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#uncurryEventLog"><span class="hs-identifier hs-var hs-var">uncurryEventLog</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687555795"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555795"><span class="hs-identifier hs-var">eventId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555796"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555796"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555797"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555797"><span class="hs-identifier hs-var">tableName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555798"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555798"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555799"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555799"><span class="hs-identifier hs-var">payload</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555800"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555800"><span class="hs-identifier hs-var">delivered</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555801"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555801"><span class="hs-identifier hs-var">isError</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555802"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555802"><span class="hs-identifier hs-var">tries</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555803"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555803"><span class="hs-identifier hs-var">createdAt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555804"><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621687555804"><span class="hs-identifier hs-var">locked</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555805"><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621687555805"><span class="hs-identifier hs-var">nextRetryAt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555806"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555806"><span class="hs-identifier hs-var">archived</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1338"></span><span>  </span><span class="hs-comment">-- see Note [Encode Event Trigger Payload to JSON in SQL Server]</span><span>
</span><span id="line-1339"></span><span>  </span><span id="local-6989586621687555807"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687555807"><span class="hs-identifier hs-var">payload'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String -&gt; m Value
forall a (m :: * -&gt; *).
(FromJSON a, QErrM m) =&gt;
Text -&gt; String -&gt; m a
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#encodeJSON"><span class="hs-identifier hs-var">encodeJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555799"><span class="hs-identifier hs-var">payload</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;payload decode failed while fetching MSSQL events&quot;</span></span><span>
</span><span id="line-1340"></span><span>  </span><span id="local-6989586621687555808"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555808"><span class="hs-identifier hs-var">createdAt'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; String -&gt; m UTCTime
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
ByteString -&gt; String -&gt; m UTCTime
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#bsToUTCTime"><span class="hs-identifier hs-var">bsToUTCTime</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555803"><span class="hs-identifier hs-var">createdAt</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;conversion of created_at to UTCTime failed while fetching MSSQL events&quot;</span></span><span>
</span><span id="line-1341"></span><span>  </span><span id="local-6989586621687555809"><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621687555809"><span class="hs-identifier hs-var">locked'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; m UTCTime) -&gt; Maybe ByteString -&gt; m (Maybe UTCTime)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; Maybe a -&gt; f (Maybe b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; String -&gt; m UTCTime
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
ByteString -&gt; String -&gt; m UTCTime
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#bsToUTCTime"><span class="hs-operator hs-var">`bsToUTCTime`</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;conversion of locked to UTCTime failed while fetching MSSQL events&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621687555804"><span class="hs-identifier hs-var">locked</span></a></span><span>
</span><span id="line-1342"></span><span>  </span><span id="local-6989586621687555810"><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621687555810"><span class="hs-identifier hs-var">nextRetryAt'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; m UTCTime) -&gt; Maybe ByteString -&gt; m (Maybe UTCTime)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; Maybe a -&gt; f (Maybe b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; String -&gt; m UTCTime
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
ByteString -&gt; String -&gt; m UTCTime
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#bsToUTCTime"><span class="hs-operator hs-var">`bsToUTCTime`</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;conversion of next_retry_at to UTCTime failed while fetching MSSQL events&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621687555805"><span class="hs-identifier hs-var">nextRetryAt</span></a></span><span>
</span><span id="line-1343"></span><span>  </span><span class="annot"><span class="annottext">EventLog -&gt; m EventLog
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-1344"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventLog"><span class="hs-identifier hs-type">EventLog</span></a></span><span>
</span><span id="line-1345"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">elId :: EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#elId"><span class="hs-identifier hs-var">elId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-var">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#bsToTxt"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555795"><span class="hs-identifier hs-var">eventId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1346"></span><span>        </span><span class="annot"><span class="annottext">elSchemaName :: Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#elSchemaName"><span class="hs-identifier hs-var">elSchemaName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555796"><span class="hs-identifier hs-var">schemaName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1347"></span><span>        </span><span class="annot"><span class="annottext">elTableName :: Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#elTableName"><span class="hs-identifier hs-var">elTableName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555797"><span class="hs-identifier hs-var">tableName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1348"></span><span>        </span><span class="annot"><span class="annottext">elTriggerName :: TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#elTriggerName"><span class="hs-identifier hs-var">elTriggerName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmptyText -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-var">TriggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; NonEmptyText
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier hs-var">mkNonEmptyTextUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555798"><span class="hs-identifier hs-var">triggerName</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1349"></span><span>        </span><span class="annot"><span class="annottext">elPayload :: Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#elPayload"><span class="hs-identifier hs-var">elPayload</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687555807"><span class="hs-identifier hs-var">payload'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1350"></span><span>        </span><span class="annot"><span class="annottext">elDelivered :: Bool
</span><a href="Hasura.RQL.Types.EventTrigger.html#elDelivered"><span class="hs-identifier hs-var">elDelivered</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555800"><span class="hs-identifier hs-var">delivered</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1351"></span><span>        </span><span class="annot"><span class="annottext">elError :: Bool
</span><a href="Hasura.RQL.Types.EventTrigger.html#elError"><span class="hs-identifier hs-var">elError</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555801"><span class="hs-identifier hs-var">isError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1352"></span><span>        </span><span class="annot"><span class="annottext">elTries :: Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#elTries"><span class="hs-identifier hs-var">elTries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687555802"><span class="hs-identifier hs-var">tries</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1353"></span><span>        </span><span class="annot"><span class="annottext">elCreatedAt :: UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#elCreatedAt"><span class="hs-identifier hs-var">elCreatedAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555808"><span class="hs-identifier hs-var">createdAt'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1354"></span><span>        </span><span class="annot"><span class="annottext">elLocked :: Maybe UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#elLocked"><span class="hs-identifier hs-var">elLocked</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621687555809"><span class="hs-identifier hs-var">locked'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1355"></span><span>        </span><span class="annot"><span class="annottext">elNextRetryAt :: Maybe UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#elNextRetryAt"><span class="hs-identifier hs-var">elNextRetryAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621687555810"><span class="hs-identifier hs-var">nextRetryAt'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1356"></span><span>        </span><span class="annot"><span class="annottext">elArchived :: Bool
</span><a href="Hasura.RQL.Types.EventTrigger.html#elArchived"><span class="hs-identifier hs-var">elArchived</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687555806"><span class="hs-identifier hs-var">archived</span></a></span><span>
</span><span id="line-1357"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-1358"></span><span>
</span><span id="line-1359"></span><span id="local-6989586621687554100"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#uncurryEventInvocationLog"><span class="hs-identifier hs-type">uncurryEventInvocationLog</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1360"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687554100"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1361"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1362"></span><span>  </span><span class="annot"><a href="#local-6989586621687554100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventInvocationLog"><span class="hs-identifier hs-type">EventInvocationLog</span></a></span></span><span>
</span><span id="line-1363"></span><span id="uncurryEventInvocationLog"><span class="annot"><span class="annottext">uncurryEventInvocationLog :: forall (m :: * -&gt; *).
MonadError QErr m =&gt;
(ByteString, Text, ByteString, Maybe Int, Text, Text, ByteString)
-&gt; m EventInvocationLog
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#uncurryEventInvocationLog"><span class="hs-identifier hs-var hs-var">uncurryEventInvocationLog</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687555836"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555836"><span class="hs-identifier hs-var">invocationId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555837"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555837"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555838"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555838"><span class="hs-identifier hs-var">eventId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555839"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621687555839"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555840"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555840"><span class="hs-identifier hs-var">request</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555841"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555841"><span class="hs-identifier hs-var">response</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687555842"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555842"><span class="hs-identifier hs-var">createdAt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1364"></span><span>  </span><span id="local-6989586621687555843"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687555843"><span class="hs-identifier hs-var">request'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String -&gt; m Value
forall a (m :: * -&gt; *).
(FromJSON a, QErrM m) =&gt;
Text -&gt; String -&gt; m a
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#encodeJSON"><span class="hs-identifier hs-var">encodeJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555840"><span class="hs-identifier hs-var">request</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;request decode failed while fetching MSSQL event invocations&quot;</span></span><span>
</span><span id="line-1365"></span><span>  </span><span id="local-6989586621687555844"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687555844"><span class="hs-identifier hs-var">response'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String -&gt; m Value
forall a (m :: * -&gt; *).
(FromJSON a, QErrM m) =&gt;
Text -&gt; String -&gt; m a
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#encodeJSON"><span class="hs-identifier hs-var">encodeJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555841"><span class="hs-identifier hs-var">response</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;response decode failed while fetching MSSQL event invocations&quot;</span></span><span>
</span><span id="line-1366"></span><span>  </span><span id="local-6989586621687555845"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555845"><span class="hs-identifier hs-var">createdAt'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; String -&gt; m UTCTime
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
ByteString -&gt; String -&gt; m UTCTime
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#bsToUTCTime"><span class="hs-identifier hs-var">bsToUTCTime</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555842"><span class="hs-identifier hs-var">createdAt</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;conversion of created_at to UTCTime failed while fetching MSSQL event invocations&quot;</span></span><span>
</span><span id="line-1367"></span><span>  </span><span class="annot"><span class="annottext">EventInvocationLog -&gt; m EventInvocationLog
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-1368"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventInvocationLog"><span class="hs-identifier hs-type">EventInvocationLog</span></a></span><span>
</span><span id="line-1369"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eilId :: Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#eilId"><span class="hs-identifier hs-var">eilId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#bsToTxt"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555836"><span class="hs-identifier hs-var">invocationId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1370"></span><span>        </span><span class="annot"><span class="annottext">eilTriggerName :: TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#eilTriggerName"><span class="hs-identifier hs-var">eilTriggerName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmptyText -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-var">TriggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; NonEmptyText
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier hs-var">mkNonEmptyTextUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555837"><span class="hs-identifier hs-var">triggerName</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1371"></span><span>        </span><span class="annot"><span class="annottext">eilEventId :: EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eilEventId"><span class="hs-identifier hs-var">eilEventId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-var">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#bsToTxt"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555838"><span class="hs-identifier hs-var">eventId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1372"></span><span>        </span><span class="annot"><span class="annottext">eilHttpStatus :: Maybe Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#eilHttpStatus"><span class="hs-identifier hs-var">eilHttpStatus</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621687555839"><span class="hs-identifier hs-var">status</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1373"></span><span>        </span><span class="annot"><span class="annottext">eilRequest :: Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eilRequest"><span class="hs-identifier hs-var">eilRequest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687555843"><span class="hs-identifier hs-var">request'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1374"></span><span>        </span><span class="annot"><span class="annottext">eilResponse :: Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eilResponse"><span class="hs-identifier hs-var">eilResponse</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687555844"><span class="hs-identifier hs-var">response'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1375"></span><span>        </span><span class="annot"><span class="annottext">eilCreatedAt :: UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eilCreatedAt"><span class="hs-identifier hs-var">eilCreatedAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621687555845"><span class="hs-identifier hs-var">createdAt'</span></a></span><span>
</span><span id="line-1376"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-1377"></span><span>
</span><span id="line-1378"></span><span class="hs-comment">{- Note [Encode Event Trigger Payload to JSON in SQL Server]

We do not have JSON datatype in SQL Server. But since in 'mkAllTriggersQ' we
ensure that all the values in the payload column of hdb_catalog.event_log is
always a JSON. We can directly decode the payload value and not worry that the
decoding will fail.

We ensure that the values in 'hd_catalog.event_log' is always a JSON is by using
the 'FOR JSON PATH' MSSQL operand when inserting value into the
'hdb_catalog.event_log' table.

-}</span><span>
</span><span id="line-1390"></span><span id="local-6989586621687553956"><span id="local-6989586621687553957"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#encodeJSON"><span class="hs-identifier hs-type">encodeJSON</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-78f82c0a41c76fc62260cf94c4b206816c9efb8c3788f4fbd6184398938cf6fb/share/doc/html/src/Data.Aeson.Types.FromJSON.html#FromJSON"><span class="hs-identifier hs-type">J.FromJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553956"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553957"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687553957"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553956"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1391"></span><span id="encodeJSON"><span class="annot"><span class="annottext">encodeJSON :: forall a (m :: * -&gt; *).
(FromJSON a, QErrM m) =&gt;
Text -&gt; String -&gt; m a
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#encodeJSON"><span class="hs-identifier hs-var hs-var">encodeJSON</span></a></span></span><span> </span><span id="local-6989586621687555861"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555861"><span class="hs-identifier hs-var">json</span></a></span></span><span> </span><span id="local-6989586621687555862"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621687555862"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1392"></span><span>  </span><span class="annot"><span class="annottext">Either String a -&gt; (String -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span>
</span><span id="line-1393"></span><span>    </span><span class="hs-comment">-- The NVARCHAR column has UTF-16 or UCS-2 encoding. Ref:</span><span>
</span><span id="line-1394"></span><span>    </span><span class="hs-comment">-- https://learn.microsoft.com/en-us/sql/t-sql/data-types/nchar-and-nvarchar-transact-sql?view=sql-server-ver16#nvarchar---n--max--</span><span>
</span><span id="line-1395"></span><span>    </span><span class="hs-comment">-- But JSON strings are expected to have UTF-8 encoding as per spec. Ref:</span><span>
</span><span id="line-1396"></span><span>    </span><span class="hs-comment">-- https://www.rfc-editor.org/rfc/rfc8259#section-8.1 Hence it's important</span><span>
</span><span id="line-1397"></span><span>    </span><span class="hs-comment">-- to encode the json into UTF-8 else the decoding of text to JSON will</span><span>
</span><span id="line-1398"></span><span>    </span><span class="hs-comment">-- fail.</span><span>
</span><span id="line-1399"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Either String a
forall a. FromJSON a =&gt; ByteString -&gt; Either String a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-78f82c0a41c76fc62260cf94c4b206816c9efb8c3788f4fbd6184398938cf6fb/share/doc/html/src/Data.Aeson.html#eitherDecode"><span class="hs-identifier hs-var">J.eitherDecode</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Either String a) -&gt; ByteString -&gt; Either String a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">fromStrict</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString) -&gt; ByteString -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Encoding.html#encodeUtf8"><span class="hs-identifier hs-var">TE.encodeUtf8</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687555861"><span class="hs-identifier hs-var">json</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1400"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m a
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m a) -&gt; Text -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621687555862"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1401"></span><span>
</span><span id="line-1402"></span><span class="hs-comment">-- | UTCTime type is used to store all the time related information pertaining</span><span>
</span><span id="line-1403"></span><span class="hs-comment">-- to  event triggers (i.e `created_at`, `locked` and `next_retry_at`).  The ODBC</span><span>
</span><span id="line-1404"></span><span class="hs-comment">-- server does not have a FromJSON instance of UTCTime datatype. This mean the</span><span>
</span><span id="line-1405"></span><span class="hs-comment">-- direct conversion of the &quot;time related data&quot; which ODBC server fetches to</span><span>
</span><span id="line-1406"></span><span class="hs-comment">-- UTCTime is not possible.</span><span>
</span><span id="line-1407"></span><span class="hs-comment">--</span><span>
</span><span id="line-1408"></span><span class="hs-comment">-- As a workaround, we cast the data from ODBC server to Bytestring and then use</span><span>
</span><span id="line-1409"></span><span class="hs-comment">-- the `readEither` to parse that bytestring to UTCTime.</span><span>
</span><span id="line-1410"></span><span class="hs-comment">--</span><span>
</span><span id="line-1411"></span><span class="hs-comment">-- We make sure that the parse will never fail, by ensuring that values present</span><span>
</span><span id="line-1412"></span><span class="hs-comment">-- in the `created_at`, `locked` and `next_retry_at` columns are always in UTC</span><span>
</span><span id="line-1413"></span><span class="hs-comment">-- Time.</span><span>
</span><span id="line-1414"></span><span id="local-6989586621687553958"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#bsToUTCTime"><span class="hs-identifier hs-type">bsToUTCTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687553958"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687553958"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span></span><span>
</span><span id="line-1415"></span><span id="bsToUTCTime"><span class="annot"><span class="annottext">bsToUTCTime :: forall (m :: * -&gt; *).
MonadError QErr m =&gt;
ByteString -&gt; String -&gt; m UTCTime
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#bsToUTCTime"><span class="hs-identifier hs-var hs-var">bsToUTCTime</span></a></span></span><span> </span><span id="local-6989586621687555874"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555874"><span class="hs-identifier hs-var">timeInByteString</span></a></span></span><span> </span><span id="local-6989586621687555875"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621687555875"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1416"></span><span>  </span><span class="annot"><span class="annottext">Either String UTCTime -&gt; (String -&gt; m UTCTime) -&gt; m UTCTime
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span>
</span><span id="line-1417"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Either String UTCTime
forall a. Read a =&gt; String -&gt; Either String a
</span><span class="hs-identifier hs-var">readEither</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.Show.html#unpack"><span class="hs-identifier hs-var">T.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; Text -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#bsToTxt"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687555874"><span class="hs-identifier hs-var">timeInByteString</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-1418"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m UTCTime
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m UTCTime) -&gt; Text -&gt; m UTCTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-27d8e86ddce8dd754c06549efa10988301d41e208fc11cac9fe9ed6d99d6eb35/share/doc/html/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621687555875"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1419"></span></pre></body></html>