<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">-- | Multiplexed subscription poller threads; see &quot;Hasura.GraphQL.Execute.Subscription&quot; for details.</span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Pollers</span></span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pollLiveQuery"><span class="hs-identifier">pollLiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.Split</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">chunksOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Sum</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.AssertNF.CPP.html"><span class="hs-identifier">GHC.AssertNF.CPP</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Backend</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Options</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.Common</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier">Cohort</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortMap"><span class="hs-identifier">CohortMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier">CohortSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.Common</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.TMap.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.TMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TMap</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Types</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html"><span class="hs-identifier">Hasura.GraphQL.ParameterizedQueryHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier">ParameterizedQueryHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Transport.Backend</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP.Protocol</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier">SourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#getNonNegativeInt"><span class="hs-identifier">getNonNegativeInt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html"><span class="hs-identifier">Hasura.RQL.Types.Subscription</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#SubscriptionType"><span class="hs-identifier">SubscriptionType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pushResultToCohort"><span class="hs-identifier hs-type">pushResultToCohort</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#GQResult"><span class="hs-identifier hs-type">GQResult</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-type">SubscriptionMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html#CohortSnapshot"><span class="hs-identifier hs-type">CohortSnapshot</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#LiveQuery"><span class="hs-identifier hs-type">LiveQuery</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-comment">-- | subscribers to which data has been pushed, subscribers which already</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-comment">-- have this data (this information is exposed by metrics reporting)</span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span id="pushResultToCohort"><span class="annot"><span class="annottext">pushResultToCohort :: GQResult ByteString
-&gt; Maybe ResponseHash
-&gt; SubscriptionMetadata
-&gt; CohortSnapshot 'LiveQuery
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pushResultToCohort"><span class="hs-identifier hs-var hs-var">pushResultToCohort</span></a></span></span><span> </span><span id="local-6989586621689314192"><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689314192"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621689314191"><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689314191"><span class="hs-identifier hs-var">respHashM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-type">SubscriptionMetadata</span></a></span><span> </span><span id="local-6989586621689314189"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314189"><span class="hs-identifier hs-var">dTime</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689314188"><span class="annot"><span class="annottext">CohortSnapshot 'LiveQuery
</span><a href="#local-6989586621689314188"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-44"></span><span>  </span><span id="local-6989586621689314187"><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689314187"><span class="hs-identifier hs-var">prevRespHashM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash) -&gt; IO (Maybe ResponseHash)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689314185"><span class="hs-identifier hs-var">respRef</span></a></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-comment">-- write to the current websockets if needed</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621689314184"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314184"><span class="hs-identifier hs-var">subscribersToPush</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314183"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314183"><span class="hs-identifier hs-var">subscribersToIgnore</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">GQResult ByteString -&gt; Bool
forall a. GQResult a -&gt; Bool
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#isExecError"><span class="hs-identifier hs-var">isExecError</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689314192"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689314191"><span class="hs-identifier hs-var">respHashM</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash -&gt; Maybe ResponseHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689314187"><span class="hs-identifier hs-var">prevRespHashM</span></a></span><span>
</span><span id="line-48"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-49"></span><span>        </span><span class="annot"><span class="annottext">String
String -&gt; Maybe ResponseHash -&gt; IO ()
forall a. String -&gt; a -&gt; IO ()
</span><span class="hs-var">$assertNFHere</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689314191"><span class="hs-identifier hs-var">respHashM</span></a></span><span> </span><span class="hs-comment">-- so we don't write thunks to mutable vars</span><span>
</span><span id="line-50"></span><span>        </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-51"></span><span>          </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash) -&gt; Maybe ResponseHash -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689314185"><span class="hs-identifier hs-var">respRef</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689314191"><span class="hs-identifier hs-var">respHashM</span></a></span><span>
</span><span id="line-52"></span><span>        </span><span class="annot"><span class="annottext">([Subscriber], [Subscriber]) -&gt; IO ([Subscriber], [Subscriber])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314176"><span class="hs-identifier hs-var">newSinks</span></a></span><span> </span><span class="annot"><span class="annottext">[Subscriber] -&gt; [Subscriber] -&gt; [Subscriber]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314175"><span class="hs-identifier hs-var">curSinks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">([Subscriber], [Subscriber]) -&gt; IO ([Subscriber], [Subscriber])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314176"><span class="hs-identifier hs-var">newSinks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314175"><span class="hs-identifier hs-var">curSinks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><span class="annottext">[Subscriber] -&gt; IO ()
</span><a href="#local-6989586621689314174"><span class="hs-identifier hs-var">pushResultToSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314184"><span class="hs-identifier hs-var">subscribersToPush</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="annot"><span class="annottext">([SubscriberExecutionDetails], [SubscriberExecutionDetails])
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(([SubscriberExecutionDetails], [SubscriberExecutionDetails])
 -&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails]))
-&gt; ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><span class="annottext">ASetter
  ([Subscriber], [Subscriber])
  ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
  Subscriber
  SubscriberExecutionDetails
-&gt; (Subscriber -&gt; SubscriberExecutionDetails)
-&gt; ([Subscriber], [Subscriber])
-&gt; ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span>
</span><span id="line-57"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([Subscriber] -&gt; Identity [SubscriberExecutionDetails])
-&gt; ([Subscriber], [Subscriber])
-&gt; Identity
     ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall s t a b. Each s t a b =&gt; Traversal s t a b
</span><span class="hs-identifier hs-var">each</span></span><span> </span><span class="annot"><span class="annottext">(([Subscriber] -&gt; Identity [SubscriberExecutionDetails])
 -&gt; ([Subscriber], [Subscriber])
 -&gt; Identity
      ([SubscriberExecutionDetails], [SubscriberExecutionDetails]))
-&gt; ((Subscriber -&gt; Identity SubscriberExecutionDetails)
    -&gt; [Subscriber] -&gt; Identity [SubscriberExecutionDetails])
-&gt; ASetter
     ([Subscriber], [Subscriber])
     ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
     Subscriber
     SubscriberExecutionDetails
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Subscriber -&gt; Identity SubscriberExecutionDetails)
-&gt; [Subscriber] -&gt; Identity [SubscriberExecutionDetails]
forall s t a b. Each s t a b =&gt; Traversal s t a b
</span><span class="hs-identifier hs-var">each</span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689314165"><span id="local-6989586621689314166"><span id="local-6989586621689314167"><span id="local-6989586621689314168"><span id="local-6989586621689314169"><span class="annot"><span class="annottext">Maybe OperationName
RequestId
SubscriberMetadata
SubscriberId
OnChange
_sOnChangeCallback :: Subscriber -&gt; OnChange
_sOperationName :: Subscriber -&gt; Maybe OperationName
_sRequestId :: Subscriber -&gt; RequestId
_sMetadata :: Subscriber -&gt; SubscriberMetadata
_sId :: Subscriber -&gt; SubscriberId
_sOnChangeCallback :: OnChange
_sOperationName :: Maybe OperationName
_sRequestId :: RequestId
_sMetadata :: SubscriberMetadata
_sId :: SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sOnChangeCallback"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-59"></span><span>          </span><span class="annot"><span class="annottext">SubscriberId -&gt; SubscriberMetadata -&gt; SubscriberExecutionDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-var">SubscriberExecutionDetails</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689314169"><span class="hs-identifier hs-var">_sId</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMetadata
</span><a href="#local-6989586621689314168"><span class="hs-identifier hs-var">_sMetadata</span></a></span><span>
</span><span id="line-60"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314184"><span class="hs-identifier hs-var">subscribersToPush</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314183"><span class="hs-identifier hs-var">subscribersToIgnore</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier hs-type">C.CohortSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621689314185"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689314185"><span class="hs-identifier hs-var">respRef</span></a></span></span><span> </span><span id="local-6989586621689314175"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314175"><span class="hs-identifier hs-var">curSinks</span></a></span></span><span> </span><span id="local-6989586621689314176"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689314176"><span class="hs-identifier hs-var">newSinks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
CohortSnapshot 'LiveQuery
</span><a href="#local-6989586621689314188"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span>    </span><span id="local-6989586621689314157"><span class="annot"><span class="annottext">response :: Either GQExecError SubscriptionResponse
</span><a href="#local-6989586621689314157"><span class="hs-identifier hs-var hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689314192"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
-&gt; (ByteString -&gt; SubscriptionResponse)
-&gt; Either GQExecError SubscriptionResponse
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; DiffTime -&gt; SubscriptionResponse
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionResponse"><span class="hs-operator hs-var">`SubscriptionResponse`</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314189"><span class="hs-identifier hs-var">dTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>    </span><span id="local-6989586621689314174"><span class="annot"><span class="annottext">pushResultToSubscribers :: [Subscriber] -&gt; IO ()
</span><a href="#local-6989586621689314174"><span class="hs-identifier hs-var hs-var">pushResultToSubscribers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-67"></span><span>      </span><span class="annot"><span class="annottext">(Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ()
forall (f :: * -&gt; *) a b. Foldable f =&gt; (a -&gt; IO b) -&gt; f a -&gt; IO ()
</span><span class="hs-identifier hs-var">A.mapConcurrently_</span></span><span> </span><span class="annot"><span class="annottext">((Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ())
-&gt; (Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689314149"><span id="local-6989586621689314150"><span id="local-6989586621689314151"><span id="local-6989586621689314152"><span id="local-6989586621689314153"><span class="annot"><span class="annottext">Maybe OperationName
RequestId
SubscriberMetadata
SubscriberId
OnChange
_sOnChangeCallback :: OnChange
_sOperationName :: Maybe OperationName
_sRequestId :: RequestId
_sMetadata :: SubscriberMetadata
_sId :: SubscriberId
_sOnChangeCallback :: Subscriber -&gt; OnChange
_sOperationName :: Subscriber -&gt; Maybe OperationName
_sRequestId :: Subscriber -&gt; RequestId
_sMetadata :: Subscriber -&gt; SubscriberMetadata
_sId :: Subscriber -&gt; SubscriberId
</span><a href="#local-6989586621689314149"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OnChange
</span><a href="#local-6989586621689314149"><span class="hs-identifier hs-var">_sOnChangeCallback</span></a></span><span> </span><span class="annot"><span class="annottext">Either GQExecError SubscriptionResponse
</span><a href="#local-6989586621689314157"><span class="hs-identifier hs-var">response</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-comment">-- | Where the magic happens: the top-level action run periodically by each</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- active 'Poller'. This needs to be async exception safe.</span><span>
</span><span id="line-71"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pollLiveQuery"><span class="hs-identifier hs-type">pollLiveQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621689314148"><span class="annot"><a href="#local-6989586621689314148"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-73"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html#BackendTransport"><span class="hs-identifier hs-type">BackendTransport</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689314148"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-74"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerId"><span class="hs-identifier hs-type">PollerId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-75"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#SubscriptionsOptions"><span class="hs-identifier hs-type">SubscriptionsOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689314148"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-77"></span><span>  </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier hs-type">ParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#MultiplexedQuery"><span class="hs-identifier hs-type">MultiplexedQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689314148"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html#CohortMap"><span class="hs-identifier hs-type">CohortMap</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#LiveQuery"><span class="hs-identifier hs-type">LiveQuery</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-81"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier hs-type">SubscriptionPostPollHook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-82"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span id="pollLiveQuery"><span class="annot"><span class="annottext">pollLiveQuery :: PollerId
-&gt; SubscriptionsOptions
-&gt; (SourceName, SourceConfig b)
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; MultiplexedQuery b
-&gt; CohortMap 'LiveQuery
-&gt; SubscriptionPostPollHook
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pollLiveQuery"><span class="hs-identifier hs-var hs-var">pollLiveQuery</span></a></span></span><span> </span><span id="local-6989586621689314147"><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621689314147"><span class="hs-identifier hs-var">pollerId</span></a></span></span><span> </span><span id="local-6989586621689314146"><span class="annot"><span class="annottext">SubscriptionsOptions
</span><a href="#local-6989586621689314146"><span class="hs-identifier hs-var">lqOpts</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689314145"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689314145"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314144"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621689314144"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689314143"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689314143"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621689314142"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621689314142"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span> </span><span id="local-6989586621689314141"><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621689314141"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span id="local-6989586621689314140"><span class="annot"><span class="annottext">CohortMap 'LiveQuery
</span><a href="#local-6989586621689314140"><span class="hs-identifier hs-var">cohortMap</span></a></span></span><span> </span><span id="local-6989586621689314139"><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621689314139"><span class="hs-identifier hs-var">postPollHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621689314138"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314138"><span class="hs-identifier hs-var">totalTime</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689314137"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314137"><span class="hs-identifier hs-var">snapshotTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314136"><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621689314136"><span class="hs-identifier hs-var">batchesDetails</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (DiffTime, [BatchExecutionDetails])
-&gt; IO (DiffTime, (DiffTime, [BatchExecutionDetails]))
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (DiffTime, [BatchExecutionDetails])
 -&gt; IO (DiffTime, (DiffTime, [BatchExecutionDetails])))
-&gt; IO (DiffTime, [BatchExecutionDetails])
-&gt; IO (DiffTime, (DiffTime, [BatchExecutionDetails]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-comment">-- snapshot the current cohorts and split them into batches</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621689314134"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314134"><span class="hs-identifier hs-var">snapshotTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314133"><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
</span><a href="#local-6989586621689314133"><span class="hs-identifier hs-var">cohortBatches</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO (DiffTime, [(BatchId, [(CohortId, CohortSnapshot)])])
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [(BatchId, [(CohortId, CohortSnapshot)])]
 -&gt; IO (DiffTime, [(BatchId, [(CohortId, CohortSnapshot)])]))
-&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO (DiffTime, [(BatchId, [(CohortId, CohortSnapshot)])])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-87"></span><span>      </span><span class="hs-comment">-- get a snapshot of all the cohorts</span><span>
</span><span id="line-88"></span><span>      </span><span class="hs-comment">-- this need not be done in a transaction</span><span>
</span><span id="line-89"></span><span>      </span><span id="local-6989586621689314132"><span class="annot"><span class="annottext">[(CohortVariables, Cohort ())]
</span><a href="#local-6989586621689314132"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM [(CohortVariables, Cohort ())]
-&gt; IO [(CohortVariables, Cohort ())]
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM [(CohortVariables, Cohort ())]
 -&gt; IO [(CohortVariables, Cohort ())])
-&gt; STM [(CohortVariables, Cohort ())]
-&gt; IO [(CohortVariables, Cohort ())]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort ())
-&gt; STM [(CohortVariables, Cohort ())]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort ())
CohortMap 'LiveQuery
</span><a href="#local-6989586621689314140"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-90"></span><span>      </span><span id="local-6989586621689314130"><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621689314130"><span class="hs-identifier hs-var">cohortSnapshots</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((CohortVariables, Cohort ()) -&gt; IO (CohortId, CohortSnapshot))
-&gt; [(CohortVariables, Cohort ())]
-&gt; IO [(CohortId, CohortSnapshot)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM (CohortId, CohortSnapshot) -&gt; IO (CohortId, CohortSnapshot)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (CohortId, CohortSnapshot) -&gt; IO (CohortId, CohortSnapshot))
-&gt; ((CohortVariables, Cohort ()) -&gt; STM (CohortId, CohortSnapshot))
-&gt; (CohortVariables, Cohort ())
-&gt; IO (CohortId, CohortSnapshot)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortVariables, Cohort ()) -&gt; STM (CohortId, CohortSnapshot)
</span><a href="#local-6989586621689314128"><span class="hs-identifier hs-var">getCohortSnapshot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortVariables, Cohort ())]
</span><a href="#local-6989586621689314132"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-91"></span><span>      </span><span class="hs-comment">-- cohorts are broken down into batches specified by the batch size</span><span>
</span><span id="line-92"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689314127"><span class="annot"><span class="annottext">cohortBatches :: [[(CohortId, CohortSnapshot)]]
</span><a href="#local-6989586621689314127"><span class="hs-identifier hs-var hs-var">cohortBatches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [(CohortId, CohortSnapshot)] -&gt; [[(CohortId, CohortSnapshot)]]
forall e. Int -&gt; [e] -&gt; [[e]]
</span><span class="hs-identifier hs-var">chunksOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonNegativeInt -&gt; Int
</span><a href="Hasura.RQL.Types.Common.html#getNonNegativeInt"><span class="hs-identifier hs-var hs-var">getNonNegativeInt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BatchSize -&gt; NonNegativeInt
</span><a href="Hasura.GraphQL.Execute.Subscription.Options.html#unBatchSize"><span class="hs-identifier hs-var hs-var">unBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">BatchSize
</span><a href="#local-6989586621689314125"><span class="hs-identifier hs-var">batchSize</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621689314130"><span class="hs-identifier hs-var">cohortSnapshots</span></a></span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-comment">-- associating every batch with their BatchId</span><span>
</span><span id="line-94"></span><span>      </span><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([(BatchId, [(CohortId, CohortSnapshot)])]
 -&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])])
-&gt; [(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BatchId]
-&gt; [[(CohortId, CohortSnapshot)]]
-&gt; [(BatchId, [(CohortId, CohortSnapshot)])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; BatchId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchId"><span class="hs-identifier hs-var">BatchId</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; BatchId) -&gt; [Int] -&gt; [BatchId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[[(CohortId, CohortSnapshot)]]
</span><a href="#local-6989586621689314127"><span class="hs-identifier hs-var">cohortBatches</span></a></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-comment">-- concurrently process each batch</span><span>
</span><span id="line-97"></span><span>    </span><span id="local-6989586621689314122"><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621689314122"><span class="hs-identifier hs-var">batchesDetails</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; ((BatchId, [(CohortId, CohortSnapshot)])
    -&gt; IO BatchExecutionDetails)
-&gt; IO [BatchExecutionDetails]
forall (t :: * -&gt; *) a b.
Traversable t =&gt;
t a -&gt; (a -&gt; IO b) -&gt; IO (t b)
</span><span class="hs-identifier hs-var">A.forConcurrently</span></span><span> </span><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
</span><a href="#local-6989586621689314133"><span class="hs-identifier hs-var">cohortBatches</span></a></span><span> </span><span class="annot"><span class="annottext">(((BatchId, [(CohortId, CohortSnapshot)])
  -&gt; IO BatchExecutionDetails)
 -&gt; IO [BatchExecutionDetails])
-&gt; ((BatchId, [(CohortId, CohortSnapshot)])
    -&gt; IO BatchExecutionDetails)
-&gt; IO [BatchExecutionDetails]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689314120"><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621689314120"><span class="hs-identifier hs-var">batchId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314119"><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621689314119"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-98"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621689314118"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314118"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314117"><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString)]
</span><a href="#local-6989586621689314117"><span class="hs-identifier hs-var">mxRes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceConfig b
-&gt; MultiplexedQuery b
-&gt; [(CohortId, CohortVariables)]
-&gt; IO (DiffTime, Either QErr [(CohortId, ByteString)])
forall (b :: BackendType) (m :: * -&gt; *).
(BackendTransport b, MonadIO m) =&gt;
SourceConfig b
-&gt; MultiplexedQuery b
-&gt; [(CohortId, CohortVariables)]
-&gt; m (DiffTime, Either QErr [(CohortId, ByteString)])
</span><a href="Hasura.GraphQL.Transport.Backend.html#runDBSubscription"><span class="hs-identifier hs-var">runDBSubscription</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689314148"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621689314144"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621689314141"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">([(CohortId, CohortVariables)]
 -&gt; IO (DiffTime, Either QErr [(CohortId, ByteString)]))
-&gt; [(CohortId, CohortVariables)]
-&gt; IO (DiffTime, Either QErr [(CohortId, ByteString)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  [(CohortId, CohortSnapshot)]
  [(CohortId, CohortVariables)]
  CohortSnapshot
  CohortVariables
-&gt; (CohortSnapshot -&gt; CohortVariables)
-&gt; [(CohortId, CohortSnapshot)]
-&gt; [(CohortId, CohortVariables)]
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CohortId, CohortSnapshot)
 -&gt; Identity (CohortId, CohortVariables))
-&gt; [(CohortId, CohortSnapshot)]
-&gt; Identity [(CohortId, CohortVariables)]
forall s t a b. Each s t a b =&gt; Traversal s t a b
</span><span class="hs-identifier hs-var">each</span></span><span> </span><span class="annot"><span class="annottext">(((CohortId, CohortSnapshot)
  -&gt; Identity (CohortId, CohortVariables))
 -&gt; [(CohortId, CohortSnapshot)]
 -&gt; Identity [(CohortId, CohortVariables)])
-&gt; ((CohortSnapshot -&gt; Identity CohortVariables)
    -&gt; (CohortId, CohortSnapshot)
    -&gt; Identity (CohortId, CohortVariables))
-&gt; ASetter
     [(CohortId, CohortSnapshot)]
     [(CohortId, CohortVariables)]
     CohortSnapshot
     CohortVariables
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortSnapshot -&gt; Identity CohortVariables)
-&gt; (CohortId, CohortSnapshot)
-&gt; Identity (CohortId, CohortVariables)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csVariables"><span class="hs-identifier hs-var hs-var">C._csVariables</span></a></span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621689314119"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689314113"><span class="annot"><span class="annottext">lqMeta :: SubscriptionMetadata
</span><a href="#local-6989586621689314113"><span class="hs-identifier hs-var hs-var">lqMeta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; SubscriptionMetadata
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-var">SubscriptionMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; SubscriptionMetadata)
-&gt; DiffTime -&gt; SubscriptionMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime
forall x y. (Duration x, Duration y) =&gt; x -&gt; y
</span><a href="Data.Time.Clock.Units.html#convertDuration"><span class="hs-identifier hs-var">convertDuration</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314118"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span><span>
</span><span id="line-101"></span><span>          </span><span id="local-6989586621689314111"><span class="annot"><span class="annottext">operations :: [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  CohortSnapshot)]
</span><a href="#local-6989586621689314111"><span class="hs-identifier hs-var hs-var">operations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
-&gt; Either QErr [(CohortId, ByteString)]
-&gt; [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)]
forall (m :: * -&gt; *) k t.
(MonadError GQExecError m, Eq k, Hashable k) =&gt;
[(k, t)]
-&gt; Either QErr [(k, ByteString)]
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)]
</span><a href="#local-6989586621689314110"><span class="hs-identifier hs-var">getCohortOperations</span></a></span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621689314119"><span class="hs-identifier hs-var">cohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString)]
</span><a href="#local-6989586621689314117"><span class="hs-identifier hs-var">mxRes</span></a></span><span>
</span><span id="line-102"></span><span>          </span><span class="hs-comment">-- batch response size is the sum of the response sizes of the cohorts</span><span>
</span><span id="line-103"></span><span>          </span><span id="local-6989586621689314109"><span class="annot"><span class="annottext">batchResponseSize :: Maybe Int
</span><a href="#local-6989586621689314109"><span class="hs-identifier hs-var hs-var">batchResponseSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-104"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString)]
</span><a href="#local-6989586621689314117"><span class="hs-identifier hs-var">mxRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-105"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-106"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621689314108"><span class="annot"><span class="annottext">[(CohortId, ByteString)]
</span><a href="#local-6989586621689314108"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sum Int -&gt; Int
forall a. Sum a -&gt; a
</span><span class="hs-identifier hs-var hs-var">getSum</span></span><span> </span><span class="annot"><span class="annottext">(Sum Int -&gt; Int) -&gt; Sum Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((CohortId, ByteString) -&gt; Sum Int)
-&gt; [(CohortId, ByteString)] -&gt; Sum Int
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Sum Int
forall a. a -&gt; Sum a
</span><span class="hs-identifier hs-var">Sum</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Sum Int)
-&gt; ((CohortId, ByteString) -&gt; Int)
-&gt; (CohortId, ByteString)
-&gt; Sum Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Int)
-&gt; ((CohortId, ByteString) -&gt; ByteString)
-&gt; (CohortId, ByteString)
-&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortId, ByteString) -&gt; ByteString
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortId, ByteString)]
</span><a href="#local-6989586621689314108"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621689314103"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314103"><span class="hs-identifier hs-var">pushTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314102"><span class="annot"><span class="annottext">[CohortExecutionDetails]
</span><a href="#local-6989586621689314102"><span class="hs-identifier hs-var">cohortsExecutionDetails</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [CohortExecutionDetails]
-&gt; IO (DiffTime, [CohortExecutionDetails])
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [CohortExecutionDetails]
 -&gt; IO (DiffTime, [CohortExecutionDetails]))
-&gt; IO [CohortExecutionDetails]
-&gt; IO (DiffTime, [CohortExecutionDetails])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-108"></span><span>        </span><span class="annot"><span class="annottext">[(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  CohortSnapshot)]
-&gt; ((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)
    -&gt; IO CohortExecutionDetails)
-&gt; IO [CohortExecutionDetails]
forall (t :: * -&gt; *) a b.
Traversable t =&gt;
t a -&gt; (a -&gt; IO b) -&gt; IO (t b)
</span><span class="hs-identifier hs-var">A.forConcurrently</span></span><span> </span><span class="annot"><span class="annottext">[(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  CohortSnapshot)]
</span><a href="#local-6989586621689314111"><span class="hs-identifier hs-var">operations</span></a></span><span> </span><span class="annot"><span class="annottext">(((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
   CohortSnapshot)
  -&gt; IO CohortExecutionDetails)
 -&gt; IO [CohortExecutionDetails])
-&gt; ((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)
    -&gt; IO CohortExecutionDetails)
-&gt; IO [CohortExecutionDetails]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689314101"><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689314101"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314100"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689314100"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314099"><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621689314099"><span class="hs-identifier hs-var">respData</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314098"><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621689314098"><span class="hs-identifier hs-var">snapshot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-109"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621689314097"><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621689314097"><span class="hs-identifier hs-var">pushedSubscribers</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314096"><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621689314096"><span class="hs-identifier hs-var">ignoredSubscribers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-110"></span><span>            </span><span class="annot"><span class="annottext">GQResult ByteString
-&gt; Maybe ResponseHash
-&gt; SubscriptionMetadata
-&gt; CohortSnapshot 'LiveQuery
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pushResultToCohort"><span class="hs-identifier hs-var">pushResultToCohort</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689314101"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; ResponseHash
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((ResponseHash, Int) -&gt; ResponseHash)
-&gt; Maybe (ResponseHash, Int) -&gt; Maybe ResponseHash
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621689314099"><span class="hs-identifier hs-var">respData</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetadata
</span><a href="#local-6989586621689314113"><span class="hs-identifier hs-var">lqMeta</span></a></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
CohortSnapshot 'LiveQuery
</span><a href="#local-6989586621689314098"><span class="hs-identifier hs-var">snapshot</span></a></span><span>
</span><span id="line-111"></span><span>          </span><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; IO CohortExecutionDetails
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-112"></span><span>            </span><span class="annot"><span class="annottext">CohortExecutionDetails :: CohortId
-&gt; CohortVariables
-&gt; Maybe Int
-&gt; [SubscriberExecutionDetails]
-&gt; [SubscriberExecutionDetails]
-&gt; BatchId
-&gt; CohortExecutionDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortExecutionDetails"><span class="hs-identifier hs-type">CohortExecutionDetails</span></a></span><span>
</span><span id="line-113"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_cedCohortId :: CohortId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedCohortId"><span class="hs-identifier hs-var">_cedCohortId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689314100"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-114"></span><span>                </span><span class="annot"><span class="annottext">_cedVariables :: CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedVariables"><span class="hs-identifier hs-var">_cedVariables</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csVariables"><span class="hs-identifier hs-var hs-var">C._csVariables</span></a></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621689314098"><span class="hs-identifier hs-var">snapshot</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-115"></span><span>                </span><span class="annot"><span class="annottext">_cedPushedTo :: [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedPushedTo"><span class="hs-identifier hs-var">_cedPushedTo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621689314097"><span class="hs-identifier hs-var">pushedSubscribers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-116"></span><span>                </span><span class="annot"><span class="annottext">_cedIgnored :: [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedIgnored"><span class="hs-identifier hs-var">_cedIgnored</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621689314096"><span class="hs-identifier hs-var">ignoredSubscribers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-117"></span><span>                </span><span class="annot"><span class="annottext">_cedResponseSize :: Maybe Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedResponseSize"><span class="hs-identifier hs-var">_cedResponseSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; Int
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((ResponseHash, Int) -&gt; Int)
-&gt; Maybe (ResponseHash, Int) -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621689314099"><span class="hs-identifier hs-var">respData</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-118"></span><span>                </span><span class="annot"><span class="annottext">_cedBatchId :: BatchId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedBatchId"><span class="hs-identifier hs-var">_cedBatchId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621689314120"><span class="hs-identifier hs-var">batchId</span></a></span><span>
</span><span id="line-119"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-120"></span><span>      </span><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; IO BatchExecutionDetails
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(BatchExecutionDetails -&gt; IO BatchExecutionDetails)
-&gt; BatchExecutionDetails -&gt; IO BatchExecutionDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-121"></span><span>        </span><span class="annot"><span class="annottext">DiffTime
-&gt; DiffTime
-&gt; BatchId
-&gt; [CohortExecutionDetails]
-&gt; Maybe Int
-&gt; BatchExecutionDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchExecutionDetails"><span class="hs-identifier hs-var">BatchExecutionDetails</span></a></span><span>
</span><span id="line-122"></span><span>          </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314118"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span><span>
</span><span id="line-123"></span><span>          </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314103"><span class="hs-identifier hs-var">pushTime</span></a></span><span>
</span><span id="line-124"></span><span>          </span><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621689314120"><span class="hs-identifier hs-var">batchId</span></a></span><span>
</span><span id="line-125"></span><span>          </span><span class="annot"><span class="annottext">[CohortExecutionDetails]
</span><a href="#local-6989586621689314102"><span class="hs-identifier hs-var">cohortsExecutionDetails</span></a></span><span>
</span><span id="line-126"></span><span>          </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621689314109"><span class="hs-identifier hs-var">batchResponseSize</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><span class="annottext">(DiffTime, [BatchExecutionDetails])
-&gt; IO (DiffTime, [BatchExecutionDetails])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314134"><span class="hs-identifier hs-var">snapshotTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621689314122"><span class="hs-identifier hs-var">batchesDetails</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689314087"><span class="annot"><span class="annottext">pollDetails :: PollDetails
</span><a href="#local-6989586621689314087"><span class="hs-identifier hs-var hs-var">pollDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-131"></span><span>        </span><span class="annot"><span class="annottext">PollDetails :: PollerId
-&gt; Text
-&gt; DiffTime
-&gt; [BatchExecutionDetails]
-&gt; DiffTime
-&gt; SubscriptionsOptions
-&gt; SourceName
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; PollDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span>
</span><span id="line-132"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_pdPollerId :: PollerId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdPollerId"><span class="hs-identifier hs-var">_pdPollerId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621689314147"><span class="hs-identifier hs-var">pollerId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-133"></span><span>            </span><span class="annot"><span class="annottext">_pdGeneratedSql :: Text
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdGeneratedSql"><span class="hs-identifier hs-var">_pdGeneratedSql</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621689314141"><span class="hs-identifier hs-var">query</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>            </span><span class="annot"><span class="annottext">_pdSnapshotTime :: DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdSnapshotTime"><span class="hs-identifier hs-var">_pdSnapshotTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314137"><span class="hs-identifier hs-var">snapshotTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>            </span><span class="annot"><span class="annottext">_pdBatches :: [BatchExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdBatches"><span class="hs-identifier hs-var">_pdBatches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621689314136"><span class="hs-identifier hs-var">batchesDetails</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-136"></span><span>            </span><span class="annot"><span class="annottext">_pdLiveQueryOptions :: SubscriptionsOptions
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdLiveQueryOptions"><span class="hs-identifier hs-var">_pdLiveQueryOptions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionsOptions
</span><a href="#local-6989586621689314146"><span class="hs-identifier hs-var">lqOpts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-137"></span><span>            </span><span class="annot"><span class="annottext">_pdTotalTime :: DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdTotalTime"><span class="hs-identifier hs-var">_pdTotalTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689314138"><span class="hs-identifier hs-var">totalTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-138"></span><span>            </span><span class="annot"><span class="annottext">_pdSource :: SourceName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdSource"><span class="hs-identifier hs-var">_pdSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689314145"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-139"></span><span>            </span><span class="annot"><span class="annottext">_pdRole :: RoleName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdRole"><span class="hs-identifier hs-var">_pdRole</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689314143"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-140"></span><span>            </span><span class="annot"><span class="annottext">_pdParameterizedQueryHash :: ParameterizedQueryHash
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdParameterizedQueryHash"><span class="hs-identifier hs-var">_pdParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621689314142"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-141"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621689314139"><span class="hs-identifier hs-var">postPollHook</span></a></span><span> </span><span class="annot"><span class="annottext">PollDetails
</span><a href="#local-6989586621689314087"><span class="hs-identifier hs-var">pollDetails</span></a></span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-144"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#SubscriptionsOptions"><span class="hs-identifier hs-type">SubscriptionsOptions</span></a></span><span> </span><span id="local-6989586621689314125"><span class="annot"><span class="annottext">BatchSize
</span><a href="#local-6989586621689314125"><span class="hs-identifier hs-var">batchSize</span></a></span></span><span> </span><span class="annot"><span class="annottext">RefetchInterval
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionsOptions
</span><a href="#local-6989586621689314146"><span class="hs-identifier hs-var">lqOpts</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>    </span><span id="local-6989586621689314128"><span class="annot"><span class="annottext">getCohortSnapshot :: (CohortVariables, Cohort ()) -&gt; STM (CohortId, CohortSnapshot)
</span><a href="#local-6989586621689314128"><span class="hs-identifier hs-var hs-var">getCohortSnapshot</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689314074"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689314074"><span class="hs-identifier hs-var">cohortVars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314073"><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621689314073"><span class="hs-identifier hs-var">handlerC</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-type">C.Cohort</span></a></span><span> </span><span id="local-6989586621689314071"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689314071"><span class="hs-identifier hs-var">resId</span></a></span></span><span> </span><span id="local-6989586621689314070"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689314070"><span class="hs-identifier hs-var">respRef</span></a></span></span><span> </span><span id="local-6989586621689314069"><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621689314069"><span class="hs-identifier hs-var">curOpsTV</span></a></span></span><span> </span><span id="local-6989586621689314068"><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621689314068"><span class="hs-identifier hs-var">newOpsTV</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621689314073"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-148"></span><span>      </span><span id="local-6989586621689314067"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689314067"><span class="hs-identifier hs-var">curOpsL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621689314069"><span class="hs-identifier hs-var">curOpsTV</span></a></span><span>
</span><span id="line-149"></span><span>      </span><span id="local-6989586621689314066"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689314066"><span class="hs-identifier hs-var">newOpsL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621689314068"><span class="hs-identifier hs-var">newOpsTV</span></a></span><span>
</span><span id="line-150"></span><span>      </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
-&gt; ((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689314066"><span class="hs-identifier hs-var">newOpsL</span></a></span><span> </span><span class="annot"><span class="annottext">(((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ())
-&gt; ((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689314064"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689314064"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314063"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621689314063"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberId -&gt; SubscriberMap -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621689314063"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689314064"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621689314069"><span class="hs-identifier hs-var">curOpsTV</span></a></span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM ()
forall k v. TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#reset"><span class="hs-identifier hs-var">TMap.reset</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621689314068"><span class="hs-identifier hs-var">newOpsTV</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689314060"><span class="annot"><span class="annottext">cohortSnapshot :: CohortSnapshot
</span><a href="#local-6989586621689314060"><span class="hs-identifier hs-var hs-var">cohortSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortVariables
-&gt; TVar (Maybe ResponseHash)
-&gt; [Subscriber]
-&gt; [Subscriber]
-&gt; CohortSnapshot
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier hs-var">C.CohortSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689314074"><span class="hs-identifier hs-var">cohortVars</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689314070"><span class="hs-identifier hs-var">respRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; Subscriber)
-&gt; [(SubscriberId, Subscriber)] -&gt; [Subscriber]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; Subscriber
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689314067"><span class="hs-identifier hs-var">curOpsL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; Subscriber)
-&gt; [(SubscriberId, Subscriber)] -&gt; [Subscriber]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; Subscriber
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689314066"><span class="hs-identifier hs-var">newOpsL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>      </span><span class="annot"><span class="annottext">(CohortId, CohortSnapshot) -&gt; STM (CohortId, CohortSnapshot)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689314071"><span class="hs-identifier hs-var">resId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621689314060"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>    </span><span id="local-6989586621689314110"><span class="annot"><span class="annottext">getCohortOperations :: [(k, t)]
-&gt; Either QErr [(k, ByteString)]
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)]
</span><a href="#local-6989586621689314110"><span class="hs-identifier hs-var hs-var">getCohortOperations</span></a></span></span><span> </span><span id="local-6989586621689314059"><span class="annot"><span class="annottext">[(k, t)]
</span><a href="#local-6989586621689314059"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-157"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621689314058"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689314058"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-comment">-- TODO: this is internal error</span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689314057"><span class="annot"><span class="annottext">resp :: m ByteString
</span><a href="#local-6989586621689314057"><span class="hs-identifier hs-var hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQExecError -&gt; m ByteString
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(GQExecError -&gt; m ByteString) -&gt; GQExecError -&gt; m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; GQExecError
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#GQExecError"><span class="hs-identifier hs-var">GQExecError</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Bool -&gt; QErr -&gt; Value
</span><a href="Hasura.Base.Error.html#encodeGQLErr"><span class="hs-identifier hs-var">encodeGQLErr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689314058"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-160"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">m ByteString
</span><a href="#local-6989586621689314057"><span class="hs-identifier hs-var">resp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621689314053"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621689314052"><span class="hs-identifier hs-var">snapshot</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689314053"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621689314053"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314052"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621689314052"><span class="hs-identifier hs-var">snapshot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(k, t)]
</span><a href="#local-6989586621689314059"><span class="hs-identifier hs-var">cohorts</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-161"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621689314051"><span class="annot"><span class="annottext">[(k, ByteString)]
</span><a href="#local-6989586621689314051"><span class="hs-identifier hs-var">responses</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689314050"><span class="annot"><span class="annottext">cohortSnapshotMap :: HashMap k t
</span><a href="#local-6989586621689314050"><span class="hs-identifier hs-var hs-var">cohortSnapshotMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(k, t)] -&gt; HashMap k t
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(k, t)]
</span><a href="#local-6989586621689314059"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-163"></span><span>        </span><span class="annot"><span class="annottext">(((k, ByteString)
  -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t))
 -&gt; [(k, ByteString)]
 -&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)])
-&gt; [(k, ByteString)]
-&gt; ((k, ByteString)
    -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t))
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">((k, ByteString)
 -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t))
-&gt; [(k, ByteString)]
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">[(k, ByteString)]
</span><a href="#local-6989586621689314051"><span class="hs-identifier hs-var">responses</span></a></span><span> </span><span class="annot"><span class="annottext">(((k, ByteString)
  -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t))
 -&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)])
-&gt; ((k, ByteString)
    -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t))
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689314046"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621689314046"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689314045"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689314045"><span class="hs-identifier hs-var">respBS</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-164"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689314044"><span class="annot"><span class="annottext">respHash :: ResponseHash
</span><a href="#local-6989586621689314044"><span class="hs-identifier hs-var hs-var">respHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ResponseHash
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#mkRespHash"><span class="hs-identifier hs-var">mkRespHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689314045"><span class="hs-identifier hs-var">respBS</span></a></span><span>
</span><span id="line-165"></span><span>              </span><span id="local-6989586621689314042"><span class="annot"><span class="annottext">respSize :: Int
</span><a href="#local-6989586621689314042"><span class="hs-identifier hs-var hs-var">respSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689314045"><span class="hs-identifier hs-var">respBS</span></a></span><span>
</span><span id="line-166"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- TODO: currently we ignore the cases when the cohortId from</span><span>
</span><span id="line-167"></span><span>              </span><span class="hs-comment">-- Postgres response is not present in the cohort map of this batch</span><span>
</span><span id="line-168"></span><span>              </span><span class="hs-comment">-- (this shouldn't happen but if it happens it means a logic error and</span><span>
</span><span id="line-169"></span><span>              </span><span class="hs-comment">-- we should log it)</span><span>
</span><span id="line-170"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; m ByteString
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689314045"><span class="hs-identifier hs-var">respBS</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621689314046"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; Maybe (ResponseHash, Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResponseHash
</span><a href="#local-6989586621689314044"><span class="hs-identifier hs-var">respHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689314042"><span class="hs-identifier hs-var">respSize</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>                </span><span class="annot"><span class="annottext">(t -&gt; (m ByteString, k, Maybe (ResponseHash, Int), t))
-&gt; Maybe t -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">k -&gt; HashMap k t -&gt; Maybe t
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621689314046"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap k t
</span><a href="#local-6989586621689314050"><span class="hs-identifier hs-var">cohortSnapshotMap</span></a></span><span>
</span><span id="line-172"></span></pre></body></html>