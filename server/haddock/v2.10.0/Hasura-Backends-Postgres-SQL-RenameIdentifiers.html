<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Hasura.Backends.Postgres.SQL.RenameIdentifiers</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">graphql-engine-1.0.0: GraphQL API over Postgres</span><ul class="links" id="page-menu"><li><a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Hasura.Backends.Postgres.SQL.RenameIdentifiers</p></div><div id="table-of-contents"><div id="contents-list"><p class="caption" onclick="window.scrollTo(0,0)">Contents</p><ul><li><a href="#g:1">API</a></li><li><a href="#g:2">Prefix long identifiers</a></li><li><a href="#g:3">Prefix table names with underscore</a><ul><li><a href="#g:4">API</a></li><li><a href="#g:5">Data types</a></li><li><a href="#g:6">Utilities</a></li><li><a href="#g:7">Algorithm</a></li></ul></li></ul></div></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Postgres SQL Rename Identifiers</p><ol><li>Prefix table names with underscores to avoid issues where column names and tables conflict.
    This can happen because we give columns and tables the name <code>root</code> for some reason,
    and that can trip up <code>row_to_json</code>.
    See <a href="https://github.com/PostgREST/postgrest/issues/993#issuecomment-340377813">https://github.com/PostgREST/postgrest/issues/993#issuecomment-340377813</a>.
    An alternative solution would be to not create a <code>TableAlias</code> with the name <code>root</code>,
    but that seemed a bit complicated for me to do at the time.</li><li>Bypass the Postgres limitation of truncating identifiers to 63 characters long
    by prepending they identifier's md5 hash when they are longer than 63 characters.</li></ol><p>We do both operations in the same traversal for performance reasons, but a simpler
   implementation of (1) would be <code>transformBi prefixHash</code> from the uniplate or the
   generic-plate package.</p><p>See Postgres docs:
 <a href="https://www.postgresql.org/docs/current/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS">https://www.postgresql.org/docs/current/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS</a></p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:renameIdentifiers">renameIdentifiers</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a></li><li class="src short"><a href="#v:renameIdentifiersSelectWith">renameIdentifiersSelectWith</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a></li><li class="src short"><a href="#v:prefixHash">prefixHash</a> :: <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a></li><li class="src short"><a href="#v:renameTablesAndLongIdentifiers">renameTablesAndLongIdentifiers</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a></li><li class="src short"><a href="#v:renameTablesAndLongIdentifiersWith">renameTablesAndLongIdentifiersWith</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a></li><li class="src short"><a href="#v:runMyState">runMyState</a> :: <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> a -&gt; a</li><li class="src short"><a href="#v:noTables">noTables</a> :: <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:TableNames" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">TableNames</a></li><li class="src short"><span class="keyword">newtype</span> <a href="#t:TableNames">TableNames</a> = <a href="#v:TableNames">TableNames</a> {<ul class="subs"><li><a href="#v:_tables">_tables</a> :: HashSet <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a></li></ul>}</li><li class="src short"><span class="keyword">type</span> <a href="#t:MyState">MyState</a> = <a href="file:///root/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/mtl-2.2.2/Control-Monad-State-Strict.html#t:State" title="Control.Monad.State.Strict">State</a> <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:TableNames" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">TableNames</a></li><li class="src short"><a href="#v:mkPrefixedName">mkPrefixedName</a> :: <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a></li><li class="src short"><a href="#v:addAliasAndPrefixHash">addAliasAndPrefixHash</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:TableAlias" title="Hasura.Backends.Postgres.SQL.DML">TableAlias</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:TableAlias" title="Hasura.Backends.Postgres.SQL.DML">TableAlias</a></li><li class="src short"><a href="#v:getIdentifierAndPrefixHash">getIdentifierAndPrefixHash</a> :: <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a></li><li class="src short"><a href="#v:restoringTables">restoringTables</a> :: <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> a -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> a</li><li class="src short"><a href="#v:uSelectWith">uSelectWith</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> (<a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a>)</li><li class="src short"><a href="#v:uSelect">uSelect</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a></li><li class="src short"><a href="#v:uFromExp">uFromExp</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FromExp" title="Hasura.Backends.Postgres.SQL.DML">FromExp</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FromExp" title="Hasura.Backends.Postgres.SQL.DML">FromExp</a></li><li class="src short"><a href="#v:uFromItem">uFromItem</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FromItem" title="Hasura.Backends.Postgres.SQL.DML">FromItem</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FromItem" title="Hasura.Backends.Postgres.SQL.DML">FromItem</a></li><li class="src short"><a href="#v:uFunctionExp">uFunctionExp</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionExp" title="Hasura.Backends.Postgres.SQL.DML">FunctionExp</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionExp" title="Hasura.Backends.Postgres.SQL.DML">FunctionExp</a></li><li class="src short"><a href="#v:uFunctionArgs">uFunctionArgs</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionArgs" title="Hasura.Backends.Postgres.SQL.DML">FunctionArgs</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionArgs" title="Hasura.Backends.Postgres.SQL.DML">FunctionArgs</a></li><li class="src short"><a href="#v:uFunctionAlias">uFunctionAlias</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionAlias" title="Hasura.Backends.Postgres.SQL.DML">FunctionAlias</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionAlias" title="Hasura.Backends.Postgres.SQL.DML">FunctionAlias</a></li><li class="src short"><a href="#v:uJoinExp">uJoinExp</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:JoinExpr" title="Hasura.Backends.Postgres.SQL.DML">JoinExpr</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:JoinExpr" title="Hasura.Backends.Postgres.SQL.DML">JoinExpr</a></li><li class="src short"><a href="#v:uJoinCond">uJoinCond</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:JoinCond" title="Hasura.Backends.Postgres.SQL.DML">JoinCond</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:JoinCond" title="Hasura.Backends.Postgres.SQL.DML">JoinCond</a></li><li class="src short"><a href="#v:uBoolExp">uBoolExp</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:BoolExp" title="Hasura.Backends.Postgres.SQL.DML">BoolExp</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:BoolExp" title="Hasura.Backends.Postgres.SQL.DML">BoolExp</a></li><li class="src short"><a href="#v:uSqlExp">uSqlExp</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SQLExp" title="Hasura.Backends.Postgres.SQL.DML">SQLExp</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SQLExp" title="Hasura.Backends.Postgres.SQL.DML">SQLExp</a></li><li class="src short"><a href="#v:uOrderBy">uOrderBy</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:OrderByExp" title="Hasura.Backends.Postgres.SQL.DML">OrderByExp</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:OrderByExp" title="Hasura.Backends.Postgres.SQL.DML">OrderByExp</a></li><li class="src short"><a href="#v:prefixHashTableAlias">prefixHashTableAlias</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:TableAlias" title="Hasura.Backends.Postgres.SQL.DML">TableAlias</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:TableAlias" title="Hasura.Backends.Postgres.SQL.DML">TableAlias</a></li><li class="src short"><a href="#v:prefixHashColumnAlias">prefixHashColumnAlias</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:ColumnAlias" title="Hasura.Backends.Postgres.SQL.DML">ColumnAlias</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:ColumnAlias" title="Hasura.Backends.Postgres.SQL.DML">ColumnAlias</a></li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>API</h1></a><div class="top"><p class="src"><a id="v:renameIdentifiers" class="def">renameIdentifiers</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#renameIdentifiers" class="link">Source</a> <a href="#v:renameIdentifiers" class="selflink">#</a></p><div class="doc"><p>Prefix table names with undescores and rename long identifiers.</p></div></div><div class="top"><p class="src"><a id="v:renameIdentifiersSelectWith" class="def">renameIdentifiersSelectWith</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#renameIdentifiersSelectWith" class="link">Source</a> <a href="#v:renameIdentifiersSelectWith" class="selflink">#</a></p><div class="doc"><p>prefix table names with undescores and rename long identifiers.</p></div></div><a href="#g:2" id="g:2"><h1>Prefix long identifiers</h1></a><div class="doc"><p>We are traversing the query transform <code><a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a></code>s in a query that are
 longer than 63 characters by prefixing them with their md5 hash.</p><p>This works because:</p><ol><li>Database table references and column references also use <code><a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a></code>, but they
    cannot be more than 63 characters long, so we will never transform those cases.</li><li>The md5 hash is a 32 characters long deterministic representation of the identifier,
    so even when truncated by postgres, it will always be enough to identify the identifiers.</li><li>It is possible in theory for to identifiers to produce the same hash, but extremely
    unlikely and I don't think we'll ever run into such a case.</li></ol><p><em>Note</em> that we could in theory replace the identifier with a hash,
 but we prefix the hash instead for our benefit as developers - if we need
 to read the query at some point we can look at the rest of the identifier
 ignoring the hash for a readable representation.</p></div><div class="top"><p class="src"><a id="v:prefixHash" class="def">prefixHash</a> :: <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#prefixHash" class="link">Source</a> <a href="#v:prefixHash" class="selflink">#</a></p><div class="doc"><p>Prefix md5 hash if identifier length is over 63 characters.
   We assume (rightly) that identifiers with names longer than 63 characters are not
   database table columns, and are made by us using aliases, so we should be free to
   rename them.</p></div></div><a href="#g:3" id="g:3"><h1>Prefix table names with underscore</h1></a><div class="doc empty">&nbsp;</div><a href="#g:4" id="g:4"><h2>API</h2></a><div class="top"><p class="src"><a id="v:renameTablesAndLongIdentifiers" class="def">renameTablesAndLongIdentifiers</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#renameTablesAndLongIdentifiers" class="link">Source</a> <a href="#v:renameTablesAndLongIdentifiers" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:renameTablesAndLongIdentifiersWith" class="def">renameTablesAndLongIdentifiersWith</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#renameTablesAndLongIdentifiersWith" class="link">Source</a> <a href="#v:renameTablesAndLongIdentifiersWith" class="selflink">#</a></p></div><a href="#g:5" id="g:5"><h2>Data types</h2></a><div class="top"><p class="src"><a id="v:runMyState" class="def">runMyState</a> :: <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> a -&gt; a <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#runMyState" class="link">Source</a> <a href="#v:runMyState" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:noTables" class="def">noTables</a> :: <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:TableNames" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">TableNames</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#noTables" class="link">Source</a> <a href="#v:noTables" class="selflink">#</a></p></div><div class="top"><p class="src"><span class="keyword">newtype</span> <a id="t:TableNames" class="def">TableNames</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#TableNames" class="link">Source</a> <a href="#t:TableNames" class="selflink">#</a></p><div class="doc"><p>The tables in scope</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:TableNames" class="def">TableNames</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:_tables" class="def">_tables</a> :: HashSet <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a></dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:MyState" class="def">MyState</a> = <a href="file:///root/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/mtl-2.2.2/Control-Monad-State-Strict.html#t:State" title="Control.Monad.State.Strict">State</a> <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:TableNames" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">TableNames</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#MyState" class="link">Source</a> <a href="#t:MyState" class="selflink">#</a></p></div><a href="#g:6" id="g:6"><h2>Utilities</h2></a><div class="top"><p class="src"><a id="v:mkPrefixedName" class="def">mkPrefixedName</a> :: <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#mkPrefixedName" class="link">Source</a> <a href="#v:mkPrefixedName" class="selflink">#</a></p><div class="doc"><p>attach a prefix to an identifier</p></div></div><div class="top"><p class="src"><a id="v:addAliasAndPrefixHash" class="def">addAliasAndPrefixHash</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:TableAlias" title="Hasura.Backends.Postgres.SQL.DML">TableAlias</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:TableAlias" title="Hasura.Backends.Postgres.SQL.DML">TableAlias</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#addAliasAndPrefixHash" class="link">Source</a> <a href="#v:addAliasAndPrefixHash" class="selflink">#</a></p><div class="doc"><p>Add the alias to the set and return a prefixed alias.</p></div></div><div class="top"><p class="src"><a id="v:getIdentifierAndPrefixHash" class="def">getIdentifierAndPrefixHash</a> :: <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-Types.html#t:Identifier" title="Hasura.Backends.Postgres.SQL.Types">Identifier</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#getIdentifierAndPrefixHash" class="link">Source</a> <a href="#v:getIdentifierAndPrefixHash" class="selflink">#</a></p><div class="doc"><p>Search for the identifier in the table names set and return
   a prefixed identifier if found, or the original identifier
   if not found in the set.</p></div></div><div class="top"><p class="src"><a id="v:restoringTables" class="def">restoringTables</a> :: <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> a -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> a <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#restoringTables" class="link">Source</a> <a href="#v:restoringTables" class="selflink">#</a></p><div class="doc"><p>Run an action that might change the tables names set
   and discard the changes made to the set.</p></div></div><a href="#g:7" id="g:7"><h2>Algorithm</h2></a><div class="top"><p class="src"><a id="v:uSelectWith" class="def">uSelectWith</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> (<a href="Hasura-Backends-Postgres-SQL-DML.html#t:SelectWithG" title="Hasura.Backends.Postgres.SQL.DML">SelectWithG</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a>) <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uSelectWith" class="link">Source</a> <a href="#v:uSelectWith" class="selflink">#</a></p><div class="doc"><p>We run the algorithm on each CTE separately and discard the table names set,
   then we run the algorithm on the main select and return that result
   (with the table names found in scope).</p></div></div><div class="top"><p class="src"><a id="v:uSelect" class="def">uSelect</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:Select" title="Hasura.Backends.Postgres.SQL.DML">Select</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uSelect" class="link">Source</a> <a href="#v:uSelect" class="selflink">#</a></p><div class="doc"><p>We go in order of each component in the select, starting with
   the from and CTE clauses (as those introduce new table names to scope).
   We return a transformed <code>Select</code> (with the table names).</p></div></div><div class="top"><p class="src"><a id="v:uFromExp" class="def">uFromExp</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FromExp" title="Hasura.Backends.Postgres.SQL.DML">FromExp</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FromExp" title="Hasura.Backends.Postgres.SQL.DML">FromExp</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uFromExp" class="link">Source</a> <a href="#v:uFromExp" class="selflink">#</a></p><div class="doc"><p>Transform every <code>from_item</code>.
   Potentially introduces a new alias.</p></div></div><div class="top"><p class="src"><a id="v:uFromItem" class="def">uFromItem</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FromItem" title="Hasura.Backends.Postgres.SQL.DML">FromItem</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FromItem" title="Hasura.Backends.Postgres.SQL.DML">FromItem</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uFromItem" class="link">Source</a> <a href="#v:uFromItem" class="selflink">#</a></p><div class="doc"><p>Transform a single <code>from_item</code>.
   Potentially introduces a new alias.</p></div></div><div class="top"><p class="src"><a id="v:uFunctionExp" class="def">uFunctionExp</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionExp" title="Hasura.Backends.Postgres.SQL.DML">FunctionExp</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionExp" title="Hasura.Backends.Postgres.SQL.DML">FunctionExp</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uFunctionExp" class="link">Source</a> <a href="#v:uFunctionExp" class="selflink">#</a></p><div class="doc"><p>Transform a function call expression.</p></div></div><div class="top"><p class="src"><a id="v:uFunctionArgs" class="def">uFunctionArgs</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionArgs" title="Hasura.Backends.Postgres.SQL.DML">FunctionArgs</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionArgs" title="Hasura.Backends.Postgres.SQL.DML">FunctionArgs</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uFunctionArgs" class="link">Source</a> <a href="#v:uFunctionArgs" class="selflink">#</a></p><div class="doc"><p>Transform function call arguments.</p></div></div><div class="top"><p class="src"><a id="v:uFunctionAlias" class="def">uFunctionAlias</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionAlias" title="Hasura.Backends.Postgres.SQL.DML">FunctionAlias</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:FunctionAlias" title="Hasura.Backends.Postgres.SQL.DML">FunctionAlias</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uFunctionAlias" class="link">Source</a> <a href="#v:uFunctionAlias" class="selflink">#</a></p><div class="doc"><p>Transform a function call alias.</p></div></div><div class="top"><p class="src"><a id="v:uJoinExp" class="def">uJoinExp</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:JoinExpr" title="Hasura.Backends.Postgres.SQL.DML">JoinExpr</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:JoinExpr" title="Hasura.Backends.Postgres.SQL.DML">JoinExpr</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uJoinExp" class="link">Source</a> <a href="#v:uJoinExp" class="selflink">#</a></p><div class="doc"><p>Transform join expressions.
   Potentially introduces a new alias.</p></div></div><div class="top"><p class="src"><a id="v:uJoinCond" class="def">uJoinCond</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:JoinCond" title="Hasura.Backends.Postgres.SQL.DML">JoinCond</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:JoinCond" title="Hasura.Backends.Postgres.SQL.DML">JoinCond</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uJoinCond" class="link">Source</a> <a href="#v:uJoinCond" class="selflink">#</a></p><div class="doc"><p>Transform Join condition. <code>ON</code> join condition might contain references
   to table names and aliases.</p></div></div><div class="top"><p class="src"><a id="v:uBoolExp" class="def">uBoolExp</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:BoolExp" title="Hasura.Backends.Postgres.SQL.DML">BoolExp</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:BoolExp" title="Hasura.Backends.Postgres.SQL.DML">BoolExp</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uBoolExp" class="link">Source</a> <a href="#v:uBoolExp" class="selflink">#</a></p><div class="doc"><p>Transform boolean expression.</p><p>The boolean expression structure does not contain a table name currently,
   So we look for <code>SQLExp</code>s and transform those, as those may contain table
   names and aliases.</p><p>We discard table names that might be introduced here because we don't
   use them outside of the boolean expression.</p></div></div><div class="top"><p class="src"><a id="v:uSqlExp" class="def">uSqlExp</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SQLExp" title="Hasura.Backends.Postgres.SQL.DML">SQLExp</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:SQLExp" title="Hasura.Backends.Postgres.SQL.DML">SQLExp</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uSqlExp" class="link">Source</a> <a href="#v:uSqlExp" class="selflink">#</a></p><div class="doc"><p>Transform a SQL expression.
   We look for table names and aliases and rename them if needed.
   SQL expressions do not introduce new table aliases, so we discard
   the new aliases that might be generated here.</p></div></div><div class="top"><p class="src"><a id="v:uOrderBy" class="def">uOrderBy</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:OrderByExp" title="Hasura.Backends.Postgres.SQL.DML">OrderByExp</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#t:MyState" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">MyState</a> <a href="Hasura-Backends-Postgres-SQL-DML.html#t:OrderByExp" title="Hasura.Backends.Postgres.SQL.DML">OrderByExp</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#uOrderBy" class="link">Source</a> <a href="#v:uOrderBy" class="selflink">#</a></p><div class="doc"><p>Transform order by clauses.
   Since order by does not introduce new aliases we can discard the new names
   that might be added, this is already done by <code><a href="Hasura-Backends-Postgres-SQL-RenameIdentifiers.html#v:uSqlExp" title="Hasura.Backends.Postgres.SQL.RenameIdentifiers">uSqlExp</a></code> though.</p></div></div><div class="top"><p class="src"><a id="v:prefixHashTableAlias" class="def">prefixHashTableAlias</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:TableAlias" title="Hasura.Backends.Postgres.SQL.DML">TableAlias</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:TableAlias" title="Hasura.Backends.Postgres.SQL.DML">TableAlias</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#prefixHashTableAlias" class="link">Source</a> <a href="#v:prefixHashTableAlias" class="selflink">#</a></p><div class="doc"><p>Prefix a table alias with a hash if needed.</p></div></div><div class="top"><p class="src"><a id="v:prefixHashColumnAlias" class="def">prefixHashColumnAlias</a> :: <a href="Hasura-Backends-Postgres-SQL-DML.html#t:ColumnAlias" title="Hasura.Backends.Postgres.SQL.DML">ColumnAlias</a> -&gt; <a href="Hasura-Backends-Postgres-SQL-DML.html#t:ColumnAlias" title="Hasura.Backends.Postgres.SQL.DML">ColumnAlias</a> <a href="src/Hasura.Backends.Postgres.SQL.RenameIdentifiers.html#prefixHashColumnAlias" class="link">Source</a> <a href="#v:prefixHashColumnAlias" class="selflink">#</a></p><div class="doc"><p>Prefix a column alias with a hash if needed.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.24.2</p></div></body></html>