<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Pollers</span></span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery.html#pollStreamingQuery"><span class="hs-identifier">pollStreamingQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.HashMap.Strict.Extended.html"><span class="hs-identifier">Data.HashMap.Strict.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.Split</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">chunksOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Sum</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.AssertNF.CPP.html"><span class="hs-identifier">GHC.AssertNF.CPP</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Backend</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Options</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Plan</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Plan</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.Common</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier">Cohort</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortMap"><span class="hs-identifier">CohortMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier">CohortSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.Common</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.TMap.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.TMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TMap</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Types</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html"><span class="hs-identifier">Hasura.GraphQL.ParameterizedQueryHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier">ParameterizedQueryHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Transport.Backend</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP.Protocol</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier">SourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#getNonNegativeInt"><span class="hs-identifier">getNonNegativeInt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html"><span class="hs-identifier">Hasura.RQL.Types.Subscription</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#SubscriptionType"><span class="hs-identifier">SubscriptionType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.Value.html"><span class="hs-identifier">Hasura.SQL.Value</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.SQL.Value.html#TxtEncodedVal"><span class="hs-identifier">TxtEncodedVal</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.GraphQL.Draft.Syntax</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Shakespeare.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">st</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-comment">{- Note [Streaming subscriptions rebuilding cohort map]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When the multiplexed query is polled, the cohort is snapshotted to get the
existing and newly added subscribers (if any), let's call these subscribers as
current poll subscribers.

Every cohort is associated with a cohort key and the cohort key is basically the
variables the cohort uses. The cohort variables contains multiple types of
variables in it, session variables, query variables, synthetic variables and
cursor variables, out of all these, the cursor variable may change with every
poll. So, we rebuild the cohort map at the end of every poll, see Note
[Streaming subscription polling]. But, rebuilding the cohort map is not straight
forward because there are race conditions that need to be taken care of. Some of
the race conditions which can happen when the current cohorts are processing:

1. A cohort is removed concurrently
2. A subscriber is removed concurrently
3. A new subscriber has started a subscription and it should be placed in the correct cohort

In the current code, the rebuilding of the cohort map goes as the follows:

1. After snapshotting the cohorts, we build a cohort map out of those cohorts,
   in the code these are called as &quot;processedCohorts&quot;, it's important to note
   that these are not retrieved from the mutable &quot;CohortMap&quot;, these are the
   snapshotted cohorts which were processed in the current poll. The reason we
   maintain the snapshotted cohorts is because it is later used while rebuilding
   the cohort map.

2. We create a processed cohort map which looks like HashMap CohortKey (Cohort
   'Streaming, CohortKey). The key of the map is the CohortKey which was
   associated with the cohort during the poll and the CohortKey in the value
   type is the cohort key after updating the cursor value. Note that both the
   values may or may not be equal.

3. We atomically get the list of the cohorts from the cohort map (mutable
reference), let's call it current cohorts and then traverse over it.

   1. Lookup with the given cohort key into the processed cohort map

      a. If no cohort is found, it means that the cohort with the given cohort
         key has been added while we were polling. So, we keep this as it is.

      b. If a processed cohort is found:

         i. We have to see if any new subscribers have been added to the current
            cohort, this is calculated using the diff of existing subscribers in
            the current cohort and the existing cohort, if there are any then we
            create a new cohort which includes only the newly added subscribers
            and add the new cohort into the cohort map.

         ii. We only retain the subscribers found in the processed cohort which
             exist in the current cohort. We do this because it is possible that
             a subscriber has been stopped their subscription in the time
             between the cohorts were snapshotted for processing and the time
             the cohort map is rebuilt.

         iii. Insert the processed cohort with the updated cohort key into the
         cohort map.
-}</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-comment">{- Note [Streaming subscription polling]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Every cohort of a streaming subscription is associated with a mutable latest
cursor value reference, which contains the current value of the cursor.

After a poll, the mutable cursor value gets updated if its value is a non-null
one, null value means that there were no rows to get the min/max value from.

After this, the cohort map associated with the poller is also rebuilt, which
will make sure that the cohort map's key contains the latest cursor values. So,
any new subscriber will get added to an existing cohort if the new subscriber's
cohort key matches with any of the existing cohorts. We *need* to rebuild the
cohort map, because, say if we don't rebuild the cohort map then a new
subscriber may get added to a cohort which has been streaming for a while now,
then the new subscriber will get the responses according to the cursor value
stored in the cohort, instead of the initial value specified by the client. For
example:

Client 1 started streaming a query at t1, say:

```
   subscription {
      log_stream(cursor: {initial_value: {created_at: &quot;2020-01-01&quot;}}, batch_size: 1000) {
         id
         level
         detail
     }
   }
```

Client 2 starts streaming at t2 with the same query (where t2 &gt; t1), if the
cohort map is not rebuilt (to reflect cursor value in the cohort key), then
client 2 and client 1 will both start getting the same responses, which is wrong
because client 2 should start streaming from the initial value it provided.

-}</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-comment">{- Note [Lifecycle of a streaming subscription poller]
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  +-------------------------------------------+           +-----------------------------------------------------------------+
  | Execute multiplexed query in the database | -------&gt;  | Parse the response, every row of response contains three things:|
  +-------------------------------------------+           |  1. Cohort ID                                                   |
             ^                                            |  2. Cohort's Response                                           |
             |                                            |  3. Cohort's latest cursor value                                |
             |                                            +-----------------------------------------------------------------+
             |                                                                            |
             |                                                                            |
             |                                                                            v
             |                                            +------------------------------------------------------------------------+
             |                                            | Processing of the response:                                            |
             |                                            | 1. Send the result to the subscribers                                  |
   +------------------------------------+                 | 2. Update the cursor value in the mutable reference                    |
   | Rebuild the cohort map             |                 |    of the snapshot so that the next poll uses this value               |
   +------------------------------------+        &lt;------  +------------------------------------------------------------------------+

-}</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery.html#mergeOldAndNewCursorValues"><span class="hs-identifier hs-type">mergeOldAndNewCursorValues</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-type">CursorVariableValues</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-type">CursorVariableValues</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-type">CursorVariableValues</span></a></span><span>
</span><span id="line-162"></span><span id="mergeOldAndNewCursorValues"><span class="annot"><span class="annottext">mergeOldAndNewCursorValues :: CursorVariableValues
-&gt; CursorVariableValues -&gt; CursorVariableValues
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery.html#mergeOldAndNewCursorValues"><span class="hs-identifier hs-var hs-var">mergeOldAndNewCursorValues</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-type">CursorVariableValues</span></a></span><span> </span><span id="local-6989586621689402531"><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal
</span><a href="#local-6989586621689402531"><span class="hs-identifier hs-var">prevPollCursorValues</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-type">CursorVariableValues</span></a></span><span> </span><span id="local-6989586621689402530"><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal
</span><a href="#local-6989586621689402530"><span class="hs-identifier hs-var">currentPollCursorValues</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402529"><span class="annot"><span class="annottext">combineFn :: TxtEncodedVal -&gt; TxtEncodedVal -&gt; TxtEncodedVal
</span><a href="#local-6989586621689402529"><span class="hs-identifier hs-var hs-var">combineFn</span></a></span></span><span> </span><span id="local-6989586621689402528"><span class="annot"><span class="annottext">TxtEncodedVal
</span><a href="#local-6989586621689402528"><span class="hs-identifier hs-var">previousVal</span></a></span></span><span> </span><span id="local-6989586621689402527"><span class="annot"><span class="annottext">TxtEncodedVal
</span><a href="#local-6989586621689402527"><span class="hs-identifier hs-var">currentVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TxtEncodedVal
</span><a href="#local-6989586621689402527"><span class="hs-identifier hs-var">currentVal</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-165"></span><span>          </span><span class="annot"><span class="annottext">TxtEncodedVal
</span><a href="Hasura.SQL.Value.html#TENull"><span class="hs-identifier hs-var">TENull</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxtEncodedVal
</span><a href="#local-6989586621689402528"><span class="hs-identifier hs-var">previousVal</span></a></span><span> </span><span class="hs-comment">-- When we get a null value from the DB, we retain the previous value</span><span>
</span><span id="line-166"></span><span>          </span><span class="annot"><a href="Hasura.SQL.Value.html#TELit"><span class="hs-identifier hs-type">TELit</span></a></span><span> </span><span id="local-6989586621689402524"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689402524"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxtEncodedVal
</span><a href="Hasura.SQL.Value.html#TELit"><span class="hs-identifier hs-var">TELit</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689402524"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-167"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal -&gt; CursorVariableValues
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-var">CursorVariableValues</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap Name TxtEncodedVal -&gt; CursorVariableValues)
-&gt; HashMap Name TxtEncodedVal -&gt; CursorVariableValues
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TxtEncodedVal -&gt; TxtEncodedVal -&gt; TxtEncodedVal)
-&gt; HashMap Name TxtEncodedVal
-&gt; HashMap Name TxtEncodedVal
-&gt; HashMap Name TxtEncodedVal
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; HashMap k v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.unionWith</span></span><span> </span><span class="annot"><span class="annottext">TxtEncodedVal -&gt; TxtEncodedVal -&gt; TxtEncodedVal
</span><a href="#local-6989586621689402529"><span class="hs-identifier hs-var">combineFn</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal
</span><a href="#local-6989586621689402531"><span class="hs-identifier hs-var">prevPollCursorValues</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal
</span><a href="#local-6989586621689402530"><span class="hs-identifier hs-var">currentPollCursorValues</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery.html#pushResultToCohort"><span class="hs-identifier hs-type">pushResultToCohort</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-170"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#GQResult"><span class="hs-identifier hs-type">GQResult</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-type">SubscriptionMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-type">CursorVariableValues</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-comment">-- | Root field name</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">G.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-comment">-- | subscribers to which data has been pushed, subscribers which already</span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-comment">-- have this data (this information is exposed by metrics reporting)</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html#CohortSnapshot"><span class="hs-identifier hs-type">CohortSnapshot</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#Streaming"><span class="hs-identifier hs-type">Streaming</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html#Cohort"><span class="hs-identifier hs-type">Cohort</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#Streaming"><span class="hs-identifier hs-type">Streaming</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span id="pushResultToCohort"><span class="annot"><span class="annottext">pushResultToCohort :: GQResult ByteString
-&gt; Maybe ResponseHash
-&gt; SubscriptionMetadata
-&gt; CursorVariableValues
-&gt; Name
-&gt; (CohortSnapshot 'Streaming, Cohort 'Streaming)
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery.html#pushResultToCohort"><span class="hs-identifier hs-var hs-var">pushResultToCohort</span></a></span></span><span> </span><span id="local-6989586621689402521"><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689402521"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621689402520"><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689402520"><span class="hs-identifier hs-var">respHashM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-type">SubscriptionMetadata</span></a></span><span> </span><span id="local-6989586621689402518"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402518"><span class="hs-identifier hs-var">dTime</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689402517"><span class="annot"><span class="annottext">CursorVariableValues
</span><a href="#local-6989586621689402517"><span class="hs-identifier hs-var">cursorValues</span></a></span></span><span> </span><span id="local-6989586621689402516"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621689402516"><span class="hs-identifier hs-var">rootFieldName</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689402515"><span class="annot"><span class="annottext">CohortSnapshot 'Streaming
</span><a href="#local-6989586621689402515"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402514"><span class="annot"><span class="annottext">Cohort 'Streaming
</span><a href="#local-6989586621689402514"><span class="hs-identifier hs-var">cohort</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>  </span><span id="local-6989586621689402513"><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689402513"><span class="hs-identifier hs-var">prevRespHashM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash) -&gt; IO (Maybe ResponseHash)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689402511"><span class="hs-identifier hs-var">respRef</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-comment">-- write to the current websockets if needed</span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621689402510"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402510"><span class="hs-identifier hs-var">subscribersToPush</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402509"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402509"><span class="hs-identifier hs-var">subscribersToIgnore</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-comment">-- We send the response to all the subscribers only when the response changes.</span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">GQResult ByteString -&gt; Bool
forall a. GQResult a -&gt; Bool
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#isExecError"><span class="hs-identifier hs-var">isExecError</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689402521"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689402520"><span class="hs-identifier hs-var">respHashM</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash -&gt; Maybe ResponseHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689402513"><span class="hs-identifier hs-var">prevRespHashM</span></a></span><span>
</span><span id="line-186"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>        </span><span class="annot"><span class="annottext">String
String -&gt; Maybe ResponseHash -&gt; IO ()
forall a. String -&gt; a -&gt; IO ()
</span><span class="hs-var">$assertNFHere</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689402520"><span class="hs-identifier hs-var">respHashM</span></a></span><span> </span><span class="hs-comment">-- so we don't write thunks to mutable vars</span><span>
</span><span id="line-188"></span><span>        </span><span class="annot"><span class="annottext">STM ([Subscriber], [Subscriber]) -&gt; IO ([Subscriber], [Subscriber])
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM ([Subscriber], [Subscriber])
 -&gt; IO ([Subscriber], [Subscriber]))
-&gt; STM ([Subscriber], [Subscriber])
-&gt; IO ([Subscriber], [Subscriber])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>          </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash) -&gt; Maybe ResponseHash -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689402511"><span class="hs-identifier hs-var">respRef</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689402520"><span class="hs-identifier hs-var">respHashM</span></a></span><span>
</span><span id="line-190"></span><span>          </span><span class="annot"><span class="annottext">TVar CursorVariableValues -&gt; CursorVariableValues -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.writeTVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TVar CursorVariableValues
forall streamCursorVars.
Cohort streamCursorVars -&gt; streamCursorVars
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cStreamCursorVariables"><span class="hs-identifier hs-var hs-var">C._cStreamCursorVariables</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
Cohort 'Streaming
</span><a href="#local-6989586621689402514"><span class="hs-identifier hs-var">cohort</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CursorVariableValues
</span><a href="#local-6989586621689402517"><span class="hs-identifier hs-var">cursorValues</span></a></span><span>
</span><span id="line-191"></span><span>          </span><span class="annot"><span class="annottext">([Subscriber], [Subscriber]) -&gt; STM ([Subscriber], [Subscriber])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402501"><span class="hs-identifier hs-var">newSinks</span></a></span><span> </span><span class="annot"><span class="annottext">[Subscriber] -&gt; [Subscriber] -&gt; [Subscriber]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402500"><span class="hs-identifier hs-var">curSinks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- when the response is unchanged, the response is only sent to the newly added subscribers</span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="annottext">([Subscriber], [Subscriber]) -&gt; IO ([Subscriber], [Subscriber])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402501"><span class="hs-identifier hs-var">newSinks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402500"><span class="hs-identifier hs-var">curSinks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>  </span><span class="annot"><span class="annottext">[Subscriber] -&gt; IO ()
</span><a href="#local-6989586621689402499"><span class="hs-identifier hs-var">pushResultToSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402510"><span class="hs-identifier hs-var">subscribersToPush</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span class="annot"><span class="annottext">([SubscriberExecutionDetails], [SubscriberExecutionDetails])
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(([SubscriberExecutionDetails], [SubscriberExecutionDetails])
 -&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails]))
-&gt; ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="annottext">ASetter
  ([Subscriber], [Subscriber])
  ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
  Subscriber
  SubscriberExecutionDetails
-&gt; (Subscriber -&gt; SubscriberExecutionDetails)
-&gt; ([Subscriber], [Subscriber])
-&gt; ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([Subscriber] -&gt; Identity [SubscriberExecutionDetails])
-&gt; ([Subscriber], [Subscriber])
-&gt; Identity
     ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall s t a b. Each s t a b =&gt; Traversal s t a b
</span><span class="hs-identifier hs-var">each</span></span><span> </span><span class="annot"><span class="annottext">(([Subscriber] -&gt; Identity [SubscriberExecutionDetails])
 -&gt; ([Subscriber], [Subscriber])
 -&gt; Identity
      ([SubscriberExecutionDetails], [SubscriberExecutionDetails]))
-&gt; ((Subscriber -&gt; Identity SubscriberExecutionDetails)
    -&gt; [Subscriber] -&gt; Identity [SubscriberExecutionDetails])
-&gt; ASetter
     ([Subscriber], [Subscriber])
     ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
     Subscriber
     SubscriberExecutionDetails
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Subscriber -&gt; Identity SubscriberExecutionDetails)
-&gt; [Subscriber] -&gt; Identity [SubscriberExecutionDetails]
forall s t a b. Each s t a b =&gt; Traversal s t a b
</span><span class="hs-identifier hs-var">each</span></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689402490"><span id="local-6989586621689402491"><span id="local-6989586621689402492"><span id="local-6989586621689402493"><span id="local-6989586621689402494"><span class="annot"><span class="annottext">Maybe OperationName
RequestId
SubscriberMetadata
SubscriberId
OnChange
_sOnChangeCallback :: Subscriber -&gt; OnChange
_sOperationName :: Subscriber -&gt; Maybe OperationName
_sRequestId :: Subscriber -&gt; RequestId
_sMetadata :: Subscriber -&gt; SubscriberMetadata
_sId :: Subscriber -&gt; SubscriberId
_sOnChangeCallback :: OnChange
_sOperationName :: Maybe OperationName
_sRequestId :: RequestId
_sMetadata :: SubscriberMetadata
_sId :: SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sOnChangeCallback"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-199"></span><span>          </span><span class="annot"><span class="annottext">SubscriberId -&gt; SubscriberMetadata -&gt; SubscriberExecutionDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-var">SubscriberExecutionDetails</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689402494"><span class="hs-identifier hs-var">_sId</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMetadata
</span><a href="#local-6989586621689402493"><span class="hs-identifier hs-var">_sMetadata</span></a></span><span>
</span><span id="line-200"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402510"><span class="hs-identifier hs-var">subscribersToPush</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402509"><span class="hs-identifier hs-var">subscribersToIgnore</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-203"></span><span>    </span><span id="local-6989586621689402483"><span class="annot"><span class="annottext">rootFieldNameText :: Text
</span><a href="#local-6989586621689402483"><span class="hs-identifier hs-var hs-var">rootFieldNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Text
</span><span class="hs-identifier hs-var hs-var">G.unName</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621689402516"><span class="hs-identifier hs-var">rootFieldName</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-comment">-- we want to know if the DB response is an empty array and if it is, then we don't send anything</span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-comment">-- to the client. We could do this by parsing the response and check for an empty list, but</span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-comment">-- this will have performance impact when large responses are parsed. Instead, we compare</span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-comment">-- the DB response to a templated empty array response.</span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-comment">-- We are using templating instead of doing something like</span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-comment">-- J.encode $ J.object [ rootFieldNameText J..= [] :: [J.Value] ]</span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-comment">-- is because, unfortunately, the value returned by the above is</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-comment">-- {&lt;rootFieldNameText&gt;:[]} (notice the lack of spaces). So, instead</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-comment">-- we're templating according to the format postgres sends JSON responses.</span><span>
</span><span id="line-214"></span><span>    </span><span id="local-6989586621689402481"><span class="annot"><span class="annottext">emptyRespBS :: ByteString
</span><a href="#local-6989586621689402481"><span class="hs-identifier hs-var hs-var">emptyRespBS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><a href="Hasura.Prelude.html#txtToBs"><span class="hs-identifier hs-var">txtToBs</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ByteString) -&gt; Text -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[st|{&quot;#{rootFieldNameText}&quot; : []}|]</span></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>    </span><span id="local-6989586621689402473"><span class="annot"><span class="annottext">isResponseEmpty :: Bool
</span><a href="#local-6989586621689402473"><span class="hs-identifier hs-var hs-var">isResponseEmpty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689402521"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString -&gt; GQResult ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; GQResult ByteString
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689402481"><span class="hs-identifier hs-var">emptyRespBS</span></a></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier hs-type">C.CohortSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621689402511"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689402511"><span class="hs-identifier hs-var">respRef</span></a></span></span><span> </span><span id="local-6989586621689402500"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402500"><span class="hs-identifier hs-var">curSinks</span></a></span></span><span> </span><span id="local-6989586621689402501"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402501"><span class="hs-identifier hs-var">newSinks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
CohortSnapshot 'Streaming
</span><a href="#local-6989586621689402515"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span>    </span><span id="local-6989586621689402471"><span class="annot"><span class="annottext">response :: Either GQExecError SubscriptionResponse
</span><a href="#local-6989586621689402471"><span class="hs-identifier hs-var hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689402521"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
-&gt; (ByteString -&gt; SubscriptionResponse)
-&gt; Either GQExecError SubscriptionResponse
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689402469"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689402469"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; DiffTime -&gt; SubscriptionResponse
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionResponse"><span class="hs-identifier hs-var">SubscriptionResponse</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689402469"><span class="hs-identifier hs-var">payload</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402518"><span class="hs-identifier hs-var">dTime</span></a></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span>    </span><span id="local-6989586621689402499"><span class="annot"><span class="annottext">pushResultToSubscribers :: [Subscriber] -&gt; IO ()
</span><a href="#local-6989586621689402499"><span class="hs-identifier hs-var hs-var">pushResultToSubscribers</span></a></span></span><span> </span><span id="local-6989586621689402467"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402467"><span class="hs-identifier hs-var">subscribers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689402473"><span class="hs-identifier hs-var">isResponseEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-224"></span><span>        </span><span class="annot"><span class="annottext">((Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ())
-&gt; [Subscriber] -&gt; (Subscriber -&gt; IO ()) -&gt; IO ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">(Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ()
forall (f :: * -&gt; *) a b. Foldable f =&gt; (a -&gt; IO b) -&gt; f a -&gt; IO ()
</span><span class="hs-identifier hs-var">A.mapConcurrently_</span></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402467"><span class="hs-identifier hs-var">subscribers</span></a></span><span> </span><span class="annot"><span class="annottext">((Subscriber -&gt; IO ()) -&gt; IO ()) -&gt; (Subscriber -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689402459"><span id="local-6989586621689402460"><span id="local-6989586621689402461"><span id="local-6989586621689402462"><span id="local-6989586621689402463"><span class="annot"><span class="annottext">Maybe OperationName
RequestId
SubscriberMetadata
SubscriberId
OnChange
_sOnChangeCallback :: OnChange
_sOperationName :: Maybe OperationName
_sRequestId :: RequestId
_sMetadata :: SubscriberMetadata
_sId :: SubscriberId
_sOnChangeCallback :: Subscriber -&gt; OnChange
_sOperationName :: Subscriber -&gt; Maybe OperationName
_sRequestId :: Subscriber -&gt; RequestId
_sMetadata :: Subscriber -&gt; SubscriberMetadata
_sId :: Subscriber -&gt; SubscriberId
</span><a href="#local-6989586621689402459"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OnChange
</span><a href="#local-6989586621689402459"><span class="hs-identifier hs-var">_sOnChangeCallback</span></a></span><span> </span><span class="annot"><span class="annottext">Either GQExecError SubscriptionResponse
</span><a href="#local-6989586621689402471"><span class="hs-identifier hs-var">response</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">-- | A single iteration of the streaming query polling loop. Invocations on the</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- same mutable objects may race.</span><span>
</span><span id="line-228"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery.html#pollStreamingQuery"><span class="hs-identifier hs-type">pollStreamingQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621689402458"><span class="annot"><a href="#local-6989586621689402458"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html#BackendTransport"><span class="hs-identifier hs-type">BackendTransport</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689402458"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerId"><span class="hs-identifier hs-type">PollerId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#SubscriptionsOptions"><span class="hs-identifier hs-type">SubscriptionsOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689402458"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier hs-type">ParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#MultiplexedQuery"><span class="hs-identifier hs-type">MultiplexedQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689402458"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html#CohortMap"><span class="hs-identifier hs-type">CohortMap</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#Streaming"><span class="hs-identifier hs-type">Streaming</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">G.Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier hs-type">SubscriptionPostPollHook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- Optional IO action to make this function (pollStreamingQuery) testable</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span id="pollStreamingQuery"><span class="annot"><span class="annottext">pollStreamingQuery :: PollerId
-&gt; SubscriptionsOptions
-&gt; (SourceName, SourceConfig b)
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; MultiplexedQuery b
-&gt; CohortMap 'Streaming
-&gt; Name
-&gt; SubscriptionPostPollHook
-&gt; Maybe (IO ())
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery.html#pollStreamingQuery"><span class="hs-identifier hs-var hs-var">pollStreamingQuery</span></a></span></span><span> </span><span id="local-6989586621689402457"><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621689402457"><span class="hs-identifier hs-var">pollerId</span></a></span></span><span> </span><span id="local-6989586621689402456"><span class="annot"><span class="annottext">SubscriptionsOptions
</span><a href="#local-6989586621689402456"><span class="hs-identifier hs-var">lqOpts</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689402455"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689402455"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402454"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621689402454"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689402453"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689402453"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621689402452"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621689402452"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span> </span><span id="local-6989586621689402451"><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621689402451"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span id="local-6989586621689402450"><span class="annot"><span class="annottext">CohortMap 'Streaming
</span><a href="#local-6989586621689402450"><span class="hs-identifier hs-var">cohortMap</span></a></span></span><span> </span><span id="local-6989586621689402449"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621689402449"><span class="hs-identifier hs-var">rootFieldName</span></a></span></span><span> </span><span id="local-6989586621689402448"><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621689402448"><span class="hs-identifier hs-var">postPollHook</span></a></span></span><span> </span><span id="local-6989586621689402447"><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621689402447"><span class="hs-identifier hs-var">testActionMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621689402446"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402446"><span class="hs-identifier hs-var">totalTime</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689402445"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402445"><span class="hs-identifier hs-var">snapshotTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402444"><span class="annot"><span class="annottext">[(BatchExecutionDetails,
  [(CohortVariables,
    (Cohort (TVar CursorVariableValues), CohortVariables,
     [Subscriber]))])]
</span><a href="#local-6989586621689402444"><span class="hs-identifier hs-var">batchesDetailsAndProcessedCohorts</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO
  (DiffTime,
   [(BatchExecutionDetails,
     [(CohortVariables,
       (Cohort (TVar CursorVariableValues), CohortVariables,
        [Subscriber]))])])
-&gt; IO
     (DiffTime,
      (DiffTime,
       [(BatchExecutionDetails,
         [(CohortVariables,
           (Cohort (TVar CursorVariableValues), CohortVariables,
            [Subscriber]))])]))
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO
   (DiffTime,
    [(BatchExecutionDetails,
      [(CohortVariables,
        (Cohort (TVar CursorVariableValues), CohortVariables,
         [Subscriber]))])])
 -&gt; IO
      (DiffTime,
       (DiffTime,
        [(BatchExecutionDetails,
          [(CohortVariables,
            (Cohort (TVar CursorVariableValues), CohortVariables,
             [Subscriber]))])])))
-&gt; IO
     (DiffTime,
      [(BatchExecutionDetails,
        [(CohortVariables,
          (Cohort (TVar CursorVariableValues), CohortVariables,
           [Subscriber]))])])
-&gt; IO
     (DiffTime,
      (DiffTime,
       [(BatchExecutionDetails,
         [(CohortVariables,
           (Cohort (TVar CursorVariableValues), CohortVariables,
            [Subscriber]))])]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-comment">-- snapshot the current cohorts and split them into batches</span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-comment">-- This STM transaction is a read only transaction i.e. it doesn't mutate any state</span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621689402442"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402442"><span class="hs-identifier hs-var">snapshotTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402441"><span class="annot"><span class="annottext">[(BatchId,
  [(CohortId,
    (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
</span><a href="#local-6989586621689402441"><span class="hs-identifier hs-var">cohortBatches</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO
  [(BatchId,
    [(CohortId,
      (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
-&gt; IO
     (DiffTime,
      [(BatchId,
        [(CohortId,
          (CohortSnapshot, Cohort (TVar CursorVariableValues)))])])
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO
   [(BatchId,
     [(CohortId,
       (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
 -&gt; IO
      (DiffTime,
       [(BatchId,
         [(CohortId,
           (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]))
-&gt; IO
     [(BatchId,
       [(CohortId,
         (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
-&gt; IO
     (DiffTime,
      [(BatchId,
        [(CohortId,
          (CohortSnapshot, Cohort (TVar CursorVariableValues)))])])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-247"></span><span>      </span><span class="hs-comment">-- get a snapshot of all the cohorts</span><span>
</span><span id="line-248"></span><span>      </span><span class="hs-comment">-- this need not be done in a transaction</span><span>
</span><span id="line-249"></span><span>      </span><span id="local-6989586621689402440"><span class="annot"><span class="annottext">[(CohortVariables, Cohort (TVar CursorVariableValues))]
</span><a href="#local-6989586621689402440"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM [(CohortVariables, Cohort (TVar CursorVariableValues))]
-&gt; IO [(CohortVariables, Cohort (TVar CursorVariableValues))]
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM [(CohortVariables, Cohort (TVar CursorVariableValues))]
 -&gt; IO [(CohortVariables, Cohort (TVar CursorVariableValues))])
-&gt; STM [(CohortVariables, Cohort (TVar CursorVariableValues))]
-&gt; IO [(CohortVariables, Cohort (TVar CursorVariableValues))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort (TVar CursorVariableValues))
-&gt; STM [(CohortVariables, Cohort (TVar CursorVariableValues))]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort (TVar CursorVariableValues))
CohortMap 'Streaming
</span><a href="#local-6989586621689402450"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-250"></span><span>      </span><span id="local-6989586621689402438"><span class="annot"><span class="annottext">[(CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
</span><a href="#local-6989586621689402438"><span class="hs-identifier hs-var">cohortSnapshots</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((CohortVariables, Cohort (TVar CursorVariableValues))
 -&gt; IO
      (CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues))))
-&gt; [(CohortVariables, Cohort (TVar CursorVariableValues))]
-&gt; IO
     [(CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM
  (CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))
-&gt; IO
     (CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   (CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))
 -&gt; IO
      (CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues))))
-&gt; ((CohortVariables, Cohort (TVar CursorVariableValues))
    -&gt; STM
         (CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues))))
-&gt; (CohortVariables, Cohort (TVar CursorVariableValues))
-&gt; IO
     (CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortVariables, Cohort (TVar CursorVariableValues))
-&gt; STM
     (CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))
forall streamCursorVars.
(CohortVariables, Cohort streamCursorVars)
-&gt; STM (CohortId, (CohortSnapshot, Cohort streamCursorVars))
</span><a href="#local-6989586621689402436"><span class="hs-identifier hs-var">getCohortSnapshot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortVariables, Cohort (TVar CursorVariableValues))]
</span><a href="#local-6989586621689402440"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-251"></span><span>      </span><span class="hs-comment">-- cohorts are broken down into batches specified by the batch size</span><span>
</span><span id="line-252"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402435"><span class="annot"><span class="annottext">cohortBatches :: [[(CohortId,
   (CohortSnapshot, Cohort (TVar CursorVariableValues)))]]
</span><a href="#local-6989586621689402435"><span class="hs-identifier hs-var hs-var">cohortBatches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [(CohortId,
     (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
-&gt; [[(CohortId,
      (CohortSnapshot, Cohort (TVar CursorVariableValues)))]]
forall e. Int -&gt; [e] -&gt; [[e]]
</span><span class="hs-identifier hs-var">chunksOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonNegativeInt -&gt; Int
</span><a href="Hasura.RQL.Types.Common.html#getNonNegativeInt"><span class="hs-identifier hs-var hs-var">getNonNegativeInt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BatchSize -&gt; NonNegativeInt
</span><a href="Hasura.GraphQL.Execute.Subscription.Options.html#unBatchSize"><span class="hs-identifier hs-var hs-var">unBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">BatchSize
</span><a href="#local-6989586621689402433"><span class="hs-identifier hs-var">batchSize</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
</span><a href="#local-6989586621689402438"><span class="hs-identifier hs-var">cohortSnapshots</span></a></span><span>
</span><span id="line-253"></span><span>      </span><span class="hs-comment">-- associating every batch with their BatchId</span><span>
</span><span id="line-254"></span><span>      </span><span class="annot"><span class="annottext">[(BatchId,
  [(CohortId,
    (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
-&gt; IO
     [(BatchId,
       [(CohortId,
         (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([(BatchId,
   [(CohortId,
     (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
 -&gt; IO
      [(BatchId,
        [(CohortId,
          (CohortSnapshot, Cohort (TVar CursorVariableValues)))])])
-&gt; [(BatchId,
     [(CohortId,
       (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
-&gt; IO
     [(BatchId,
       [(CohortId,
         (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BatchId]
-&gt; [[(CohortId,
      (CohortSnapshot, Cohort (TVar CursorVariableValues)))]]
-&gt; [(BatchId,
     [(CohortId,
       (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; BatchId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchId"><span class="hs-identifier hs-var">BatchId</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; BatchId) -&gt; [Int] -&gt; [BatchId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[[(CohortId,
   (CohortSnapshot, Cohort (TVar CursorVariableValues)))]]
</span><a href="#local-6989586621689402435"><span class="hs-identifier hs-var">cohortBatches</span></a></span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IO ()) -&gt; (IO () -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Hasura.Prelude.html#onJust"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621689402447"><span class="hs-identifier hs-var">testActionMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-comment">-- IO action intended to run after the cohorts have been snapshotted</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-comment">-- concurrently process each batch and also get the processed cohort with the new updated cohort key</span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621689402429"><span class="annot"><span class="annottext">[(BatchExecutionDetails,
  [(CohortVariables,
    (Cohort (TVar CursorVariableValues), CohortVariables,
     [Subscriber]))])]
</span><a href="#local-6989586621689402429"><span class="hs-identifier hs-var">batchesDetailsAndProcessedCohorts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(BatchId,
  [(CohortId,
    (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
-&gt; ((BatchId,
     [(CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))])
    -&gt; IO
         (BatchExecutionDetails,
          [(CohortVariables,
            (Cohort (TVar CursorVariableValues), CohortVariables,
             [Subscriber]))]))
-&gt; IO
     [(BatchExecutionDetails,
       [(CohortVariables,
         (Cohort (TVar CursorVariableValues), CohortVariables,
          [Subscriber]))])]
forall (t :: * -&gt; *) a b.
Traversable t =&gt;
t a -&gt; (a -&gt; IO b) -&gt; IO (t b)
</span><span class="hs-identifier hs-var">A.forConcurrently</span></span><span> </span><span class="annot"><span class="annottext">[(BatchId,
  [(CohortId,
    (CohortSnapshot, Cohort (TVar CursorVariableValues)))])]
</span><a href="#local-6989586621689402441"><span class="hs-identifier hs-var">cohortBatches</span></a></span><span> </span><span class="annot"><span class="annottext">(((BatchId,
   [(CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))])
  -&gt; IO
       (BatchExecutionDetails,
        [(CohortVariables,
          (Cohort (TVar CursorVariableValues), CohortVariables,
           [Subscriber]))]))
 -&gt; IO
      [(BatchExecutionDetails,
        [(CohortVariables,
          (Cohort (TVar CursorVariableValues), CohortVariables,
           [Subscriber]))])])
-&gt; ((BatchId,
     [(CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))])
    -&gt; IO
         (BatchExecutionDetails,
          [(CohortVariables,
            (Cohort (TVar CursorVariableValues), CohortVariables,
             [Subscriber]))]))
-&gt; IO
     [(BatchExecutionDetails,
       [(CohortVariables,
         (Cohort (TVar CursorVariableValues), CohortVariables,
          [Subscriber]))])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689402427"><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621689402427"><span class="hs-identifier hs-var">batchId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402426"><span class="annot"><span class="annottext">[(CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
</span><a href="#local-6989586621689402426"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621689402425"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402425"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402424"><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString, CursorVariableValues)]
</span><a href="#local-6989586621689402424"><span class="hs-identifier hs-var">mxRes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-261"></span><span>        </span><span class="annot"><span class="annottext">SourceConfig b
-&gt; MultiplexedQuery b
-&gt; [(CohortId, CohortVariables)]
-&gt; IO
     (DiffTime,
      Either QErr [(CohortId, ByteString, CursorVariableValues)])
forall (b :: BackendType) (m :: * -&gt; *).
(BackendTransport b, MonadIO m) =&gt;
SourceConfig b
-&gt; MultiplexedQuery b
-&gt; [(CohortId, CohortVariables)]
-&gt; m (DiffTime,
      Either QErr [(CohortId, ByteString, CursorVariableValues)])
</span><a href="Hasura.GraphQL.Transport.Backend.html#runDBStreamingSubscription"><span class="hs-identifier hs-var">runDBStreamingSubscription</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689402458"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621689402454"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621689402451"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">([(CohortId, CohortVariables)]
 -&gt; IO
      (DiffTime,
       Either QErr [(CohortId, ByteString, CursorVariableValues)]))
-&gt; [(CohortId, CohortVariables)]
-&gt; IO
     (DiffTime,
      Either QErr [(CohortId, ByteString, CursorVariableValues)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-262"></span><span>          </span><span class="annot"><span class="annottext">ASetter
  [(CohortId, CohortSnapshot)]
  [(CohortId, CohortVariables)]
  CohortSnapshot
  CohortVariables
-&gt; (CohortSnapshot -&gt; CohortVariables)
-&gt; [(CohortId, CohortSnapshot)]
-&gt; [(CohortId, CohortVariables)]
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CohortId, CohortSnapshot)
 -&gt; Identity (CohortId, CohortVariables))
-&gt; [(CohortId, CohortSnapshot)]
-&gt; Identity [(CohortId, CohortVariables)]
forall s t a b. Each s t a b =&gt; Traversal s t a b
</span><span class="hs-identifier hs-var">each</span></span><span> </span><span class="annot"><span class="annottext">(((CohortId, CohortSnapshot)
  -&gt; Identity (CohortId, CohortVariables))
 -&gt; [(CohortId, CohortSnapshot)]
 -&gt; Identity [(CohortId, CohortVariables)])
-&gt; ((CohortSnapshot -&gt; Identity CohortVariables)
    -&gt; (CohortId, CohortSnapshot)
    -&gt; Identity (CohortId, CohortVariables))
-&gt; ASetter
     [(CohortId, CohortSnapshot)]
     [(CohortId, CohortVariables)]
     CohortSnapshot
     CohortVariables
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortSnapshot -&gt; Identity CohortVariables)
-&gt; (CohortId, CohortSnapshot)
-&gt; Identity (CohortId, CohortVariables)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csVariables"><span class="hs-identifier hs-var hs-var">C._csVariables</span></a></span><span> </span><span class="annot"><span class="annottext">([(CohortId, CohortSnapshot)] -&gt; [(CohortId, CohortVariables)])
-&gt; [(CohortId, CohortSnapshot)] -&gt; [(CohortId, CohortVariables)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-263"></span><span>            </span><span class="annot"><span class="annottext">((CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))
 -&gt; (CohortId, CohortSnapshot))
-&gt; [(CohortId,
     (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
-&gt; [(CohortId, CohortSnapshot)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CohortSnapshot, Cohort (TVar CursorVariableValues))
 -&gt; CohortSnapshot)
-&gt; (CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))
-&gt; (CohortId, CohortSnapshot)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(CohortSnapshot, Cohort (TVar CursorVariableValues))
-&gt; CohortSnapshot
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
</span><a href="#local-6989586621689402426"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-264"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402420"><span class="annot"><span class="annottext">lqMeta :: SubscriptionMetadata
</span><a href="#local-6989586621689402420"><span class="hs-identifier hs-var hs-var">lqMeta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; SubscriptionMetadata
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-var">SubscriptionMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; SubscriptionMetadata)
-&gt; DiffTime -&gt; SubscriptionMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime
forall x y. (Duration x, Duration y) =&gt; x -&gt; y
</span><a href="Data.Time.Clock.Units.html#convertDuration"><span class="hs-identifier hs-var">convertDuration</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402425"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span><span>
</span><span id="line-265"></span><span>          </span><span id="local-6989586621689402418"><span class="annot"><span class="annottext">operations :: [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  Maybe CursorVariableValues,
  (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
</span><a href="#local-6989586621689402418"><span class="hs-identifier hs-var hs-var">operations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
-&gt; Either QErr [(CohortId, ByteString, CursorVariableValues)]
-&gt; [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     Maybe CursorVariableValues,
     (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
forall (m :: * -&gt; *) k t a.
(MonadError GQExecError m, Eq k, Hashable k) =&gt;
[(k, t)]
-&gt; Either QErr [(k, ByteString, a)]
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t)]
</span><a href="#local-6989586621689402417"><span class="hs-identifier hs-var">getCohortOperations</span></a></span><span> </span><span class="annot"><span class="annottext">[(CohortId, (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
</span><a href="#local-6989586621689402426"><span class="hs-identifier hs-var">cohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString, CursorVariableValues)]
</span><a href="#local-6989586621689402424"><span class="hs-identifier hs-var">mxRes</span></a></span><span>
</span><span id="line-266"></span><span>          </span><span class="hs-comment">-- batch response size is the sum of the response sizes of the cohorts</span><span>
</span><span id="line-267"></span><span>          </span><span id="local-6989586621689402416"><span class="annot"><span class="annottext">batchResponseSize :: Maybe Int
</span><a href="#local-6989586621689402416"><span class="hs-identifier hs-var hs-var">batchResponseSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-268"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString, CursorVariableValues)]
</span><a href="#local-6989586621689402424"><span class="hs-identifier hs-var">mxRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-269"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-270"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621689402415"><span class="annot"><span class="annottext">[(CohortId, ByteString, CursorVariableValues)]
</span><a href="#local-6989586621689402415"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sum Int -&gt; Int
forall a. Sum a -&gt; a
</span><span class="hs-identifier hs-var hs-var">getSum</span></span><span> </span><span class="annot"><span class="annottext">(Sum Int -&gt; Int) -&gt; Sum Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((CohortId, ByteString, CursorVariableValues) -&gt; Sum Int)
-&gt; [(CohortId, ByteString, CursorVariableValues)] -&gt; Sum Int
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402412"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689402412"><span class="hs-identifier hs-var">sqlResp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CursorVariableValues
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Sum Int
forall a. a -&gt; Sum a
</span><span class="hs-identifier hs-var">Sum</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Sum Int) -&gt; (ByteString -&gt; Int) -&gt; ByteString -&gt; Sum Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Sum Int) -&gt; ByteString -&gt; Sum Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689402412"><span class="hs-identifier hs-var">sqlResp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortId, ByteString, CursorVariableValues)]
</span><a href="#local-6989586621689402415"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-271"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621689402409"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402409"><span class="hs-identifier hs-var">pushTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402408"><span class="annot"><span class="annottext">[(CohortExecutionDetails,
  (CohortVariables,
   (Cohort (TVar CursorVariableValues), CohortVariables,
    [Subscriber])))]
</span><a href="#local-6989586621689402408"><span class="hs-identifier hs-var">cohortsExecutionDetails</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO
  [(CohortExecutionDetails,
    (CohortVariables,
     (Cohort (TVar CursorVariableValues), CohortVariables,
      [Subscriber])))]
-&gt; IO
     (DiffTime,
      [(CohortExecutionDetails,
        (CohortVariables,
         (Cohort (TVar CursorVariableValues), CohortVariables,
          [Subscriber])))])
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO
   [(CohortExecutionDetails,
     (CohortVariables,
      (Cohort (TVar CursorVariableValues), CohortVariables,
       [Subscriber])))]
 -&gt; IO
      (DiffTime,
       [(CohortExecutionDetails,
         (CohortVariables,
          (Cohort (TVar CursorVariableValues), CohortVariables,
           [Subscriber])))]))
-&gt; IO
     [(CohortExecutionDetails,
       (CohortVariables,
        (Cohort (TVar CursorVariableValues), CohortVariables,
         [Subscriber])))]
-&gt; IO
     (DiffTime,
      [(CohortExecutionDetails,
        (CohortVariables,
         (Cohort (TVar CursorVariableValues), CohortVariables,
          [Subscriber])))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-272"></span><span>        </span><span class="annot"><span class="annottext">[(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  Maybe CursorVariableValues,
  (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
-&gt; ((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     Maybe CursorVariableValues,
     (CohortSnapshot, Cohort (TVar CursorVariableValues)))
    -&gt; IO
         (CohortExecutionDetails,
          (CohortVariables,
           (Cohort (TVar CursorVariableValues), CohortVariables,
            [Subscriber]))))
-&gt; IO
     [(CohortExecutionDetails,
       (CohortVariables,
        (Cohort (TVar CursorVariableValues), CohortVariables,
         [Subscriber])))]
forall (t :: * -&gt; *) a b.
Traversable t =&gt;
t a -&gt; (a -&gt; IO b) -&gt; IO (t b)
</span><span class="hs-identifier hs-var">A.forConcurrently</span></span><span> </span><span class="annot"><span class="annottext">[(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  Maybe CursorVariableValues,
  (CohortSnapshot, Cohort (TVar CursorVariableValues)))]
</span><a href="#local-6989586621689402418"><span class="hs-identifier hs-var">operations</span></a></span><span> </span><span class="annot"><span class="annottext">(((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
   Maybe CursorVariableValues,
   (CohortSnapshot, Cohort (TVar CursorVariableValues)))
  -&gt; IO
       (CohortExecutionDetails,
        (CohortVariables,
         (Cohort (TVar CursorVariableValues), CohortVariables,
          [Subscriber]))))
 -&gt; IO
      [(CohortExecutionDetails,
        (CohortVariables,
         (Cohort (TVar CursorVariableValues), CohortVariables,
          [Subscriber])))])
-&gt; ((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     Maybe CursorVariableValues,
     (CohortSnapshot, Cohort (TVar CursorVariableValues)))
    -&gt; IO
         (CohortExecutionDetails,
          (CohortVariables,
           (Cohort (TVar CursorVariableValues), CohortVariables,
            [Subscriber]))))
-&gt; IO
     [(CohortExecutionDetails,
       (CohortVariables,
        (Cohort (TVar CursorVariableValues), CohortVariables,
         [Subscriber])))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689402407"><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689402407"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402406"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689402406"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402405"><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621689402405"><span class="hs-identifier hs-var">respData</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402404"><span class="annot"><span class="annottext">Maybe CursorVariableValues
</span><a href="#local-6989586621689402404"><span class="hs-identifier hs-var">latestCursorValueMaybe</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689402403"><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621689402403"><span class="hs-identifier hs-var">snapshot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402402"><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402402"><span class="hs-identifier hs-var">cohort</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402401"><span class="annot"><span class="annottext">latestCursorValue :: CursorVariableValues
</span><a href="#local-6989586621689402401"><span class="hs-identifier hs-var">latestCursorValue</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-type">CursorVariableValues</span></a></span><span> </span><span id="local-6989586621689402400"><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal
</span><a href="#local-6989586621689402400"><span class="hs-identifier hs-var">updatedCursorVarVal</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-274"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402399"><span class="annot"><span class="annottext">prevCursorVariableValue :: CursorVariableValues
</span><a href="#local-6989586621689402399"><span class="hs-identifier hs-var hs-var">prevCursorVariableValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal -&gt; CursorVariableValues
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-var">CursorVariableValues</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap Name TxtEncodedVal -&gt; CursorVariableValues)
-&gt; HashMap Name TxtEncodedVal -&gt; CursorVariableValues
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ValidatedVariables (HashMap Name) -&gt; HashMap Name TxtEncodedVal
forall (f :: * -&gt; *). ValidatedVariables f -&gt; f TxtEncodedVal
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#_unValidatedVariables"><span class="hs-identifier hs-var hs-var">C._unValidatedVariables</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidatedVariables (HashMap Name) -&gt; HashMap Name TxtEncodedVal)
-&gt; ValidatedVariables (HashMap Name) -&gt; HashMap Name TxtEncodedVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CohortVariables -&gt; ValidatedVariables (HashMap Name)
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#_cvCursorVariables"><span class="hs-identifier hs-var hs-var">C._cvCursorVariables</span></a></span><span> </span><span class="annot"><span class="annottext">(CohortVariables -&gt; ValidatedVariables (HashMap Name))
-&gt; CohortVariables -&gt; ValidatedVariables (HashMap Name)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csVariables"><span class="hs-identifier hs-var hs-var">C._csVariables</span></a></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621689402403"><span class="hs-identifier hs-var">snapshot</span></a></span><span>
</span><span id="line-275"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CursorVariableValues
</span><a href="#local-6989586621689402404"><span class="hs-identifier hs-var">latestCursorValueMaybe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-276"></span><span>                      </span><span class="annot"><span class="annottext">Maybe CursorVariableValues
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CursorVariableValues
</span><a href="#local-6989586621689402399"><span class="hs-identifier hs-var">prevCursorVariableValue</span></a></span><span> </span><span class="hs-comment">-- Nothing indicates there was an error when the query was polled</span><span>
</span><span id="line-277"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621689402396"><span class="annot"><span class="annottext">CursorVariableValues
</span><a href="#local-6989586621689402396"><span class="hs-identifier hs-var">currentPollCursorValue</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CursorVariableValues
-&gt; CursorVariableValues -&gt; CursorVariableValues
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery.html#mergeOldAndNewCursorValues"><span class="hs-identifier hs-var">mergeOldAndNewCursorValues</span></a></span><span> </span><span class="annot"><span class="annottext">CursorVariableValues
</span><a href="#local-6989586621689402399"><span class="hs-identifier hs-var">prevCursorVariableValue</span></a></span><span> </span><span class="annot"><span class="annottext">CursorVariableValues
</span><a href="#local-6989586621689402396"><span class="hs-identifier hs-var">currentPollCursorValue</span></a></span><span>
</span><span id="line-278"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621689402395"><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621689402395"><span class="hs-identifier hs-var">pushedSubscribers</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402394"><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621689402394"><span class="hs-identifier hs-var">ignoredSubscribers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-279"></span><span>            </span><span class="hs-comment">-- Push the result to the subscribers present in the cohorts</span><span>
</span><span id="line-280"></span><span>            </span><span class="annot"><span class="annottext">GQResult ByteString
-&gt; Maybe ResponseHash
-&gt; SubscriptionMetadata
-&gt; CursorVariableValues
-&gt; Name
-&gt; (CohortSnapshot 'Streaming, Cohort 'Streaming)
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery.html#pushResultToCohort"><span class="hs-identifier hs-var">pushResultToCohort</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621689402407"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; ResponseHash
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((ResponseHash, Int) -&gt; ResponseHash)
-&gt; Maybe (ResponseHash, Int) -&gt; Maybe ResponseHash
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621689402405"><span class="hs-identifier hs-var">respData</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetadata
</span><a href="#local-6989586621689402420"><span class="hs-identifier hs-var">lqMeta</span></a></span><span> </span><span class="annot"><span class="annottext">CursorVariableValues
</span><a href="#local-6989586621689402401"><span class="hs-identifier hs-var">latestCursorValue</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621689402449"><span class="hs-identifier hs-var">rootFieldName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortSnapshot
CohortSnapshot 'Streaming
</span><a href="#local-6989586621689402403"><span class="hs-identifier hs-var">snapshot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
Cohort 'Streaming
</span><a href="#local-6989586621689402402"><span class="hs-identifier hs-var">cohort</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402393"><span class="annot"><span class="annottext">currentCohortKey :: CohortVariables
</span><a href="#local-6989586621689402393"><span class="hs-identifier hs-var hs-var">currentCohortKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csVariables"><span class="hs-identifier hs-var hs-var">C._csVariables</span></a></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621689402403"><span class="hs-identifier hs-var">snapshot</span></a></span><span>
</span><span id="line-282"></span><span>              </span><span id="local-6989586621689402392"><span class="annot"><span class="annottext">updatedCohortKey :: CohortVariables
</span><a href="#local-6989586621689402392"><span class="hs-identifier hs-var hs-var">updatedCohortKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidatedVariables (HashMap Name)
-&gt; CohortVariables -&gt; CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#modifyCursorCohortVariables"><span class="hs-identifier hs-var">modifyCursorCohortVariables</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal -&gt; ValidatedVariables (HashMap Name)
forall (f :: * -&gt; *). f TxtEncodedVal -&gt; ValidatedVariables f
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#mkUnsafeValidateVariables"><span class="hs-identifier hs-var">mkUnsafeValidateVariables</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal
</span><a href="#local-6989586621689402400"><span class="hs-identifier hs-var">updatedCursorVarVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CohortVariables -&gt; CohortVariables)
-&gt; CohortVariables -&gt; CohortVariables
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csVariables"><span class="hs-identifier hs-var hs-var">C._csVariables</span></a></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621689402403"><span class="hs-identifier hs-var">snapshot</span></a></span><span>
</span><span id="line-283"></span><span>              </span><span id="local-6989586621689402389"><span class="annot"><span class="annottext">snapshottedNewSubs :: [Subscriber]
</span><a href="#local-6989586621689402389"><span class="hs-identifier hs-var hs-var">snapshottedNewSubs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; [Subscriber]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csNewSubscribers"><span class="hs-identifier hs-var hs-var">C._csNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621689402403"><span class="hs-identifier hs-var">snapshot</span></a></span><span>
</span><span id="line-284"></span><span>              </span><span id="local-6989586621689402387"><span class="annot"><span class="annottext">cohortExecutionDetails :: CohortExecutionDetails
</span><a href="#local-6989586621689402387"><span class="hs-identifier hs-var hs-var">cohortExecutionDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-285"></span><span>                </span><span class="annot"><span class="annottext">CohortExecutionDetails :: CohortId
-&gt; CohortVariables
-&gt; Maybe Int
-&gt; [SubscriberExecutionDetails]
-&gt; [SubscriberExecutionDetails]
-&gt; BatchId
-&gt; CohortExecutionDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortExecutionDetails"><span class="hs-identifier hs-type">CohortExecutionDetails</span></a></span><span>
</span><span id="line-286"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_cedCohortId :: CohortId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedCohortId"><span class="hs-identifier hs-var">_cedCohortId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689402406"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-287"></span><span>                    </span><span class="annot"><span class="annottext">_cedVariables :: CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedVariables"><span class="hs-identifier hs-var">_cedVariables</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402393"><span class="hs-identifier hs-var">currentCohortKey</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-288"></span><span>                    </span><span class="annot"><span class="annottext">_cedPushedTo :: [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedPushedTo"><span class="hs-identifier hs-var">_cedPushedTo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621689402395"><span class="hs-identifier hs-var">pushedSubscribers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-289"></span><span>                    </span><span class="annot"><span class="annottext">_cedIgnored :: [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedIgnored"><span class="hs-identifier hs-var">_cedIgnored</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621689402394"><span class="hs-identifier hs-var">ignoredSubscribers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-290"></span><span>                    </span><span class="annot"><span class="annottext">_cedResponseSize :: Maybe Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedResponseSize"><span class="hs-identifier hs-var">_cedResponseSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; Int
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((ResponseHash, Int) -&gt; Int)
-&gt; Maybe (ResponseHash, Int) -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621689402405"><span class="hs-identifier hs-var">respData</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-291"></span><span>                    </span><span class="annot"><span class="annottext">_cedBatchId :: BatchId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedBatchId"><span class="hs-identifier hs-var">_cedBatchId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621689402427"><span class="hs-identifier hs-var">batchId</span></a></span><span>
</span><span id="line-292"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-293"></span><span>          </span><span class="annot"><span class="annottext">(CohortExecutionDetails,
 (CohortVariables,
  (Cohort (TVar CursorVariableValues), CohortVariables,
   [Subscriber])))
-&gt; IO
     (CohortExecutionDetails,
      (CohortVariables,
       (Cohort (TVar CursorVariableValues), CohortVariables,
        [Subscriber])))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortExecutionDetails
</span><a href="#local-6989586621689402387"><span class="hs-identifier hs-var">cohortExecutionDetails</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402393"><span class="hs-identifier hs-var">currentCohortKey</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402402"><span class="hs-identifier hs-var">cohort</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402392"><span class="hs-identifier hs-var">updatedCohortKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402389"><span class="hs-identifier hs-var">snapshottedNewSubs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402379"><span class="annot"><span class="annottext">processedCohortBatch :: [(CohortVariables,
  (Cohort (TVar CursorVariableValues), CohortVariables,
   [Subscriber]))]
</span><a href="#local-6989586621689402379"><span class="hs-identifier hs-var hs-var">processedCohortBatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CohortExecutionDetails,
 (CohortVariables,
  (Cohort (TVar CursorVariableValues), CohortVariables,
   [Subscriber])))
-&gt; (CohortVariables,
    (Cohort (TVar CursorVariableValues), CohortVariables,
     [Subscriber]))
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((CohortExecutionDetails,
  (CohortVariables,
   (Cohort (TVar CursorVariableValues), CohortVariables,
    [Subscriber])))
 -&gt; (CohortVariables,
     (Cohort (TVar CursorVariableValues), CohortVariables,
      [Subscriber])))
-&gt; [(CohortExecutionDetails,
     (CohortVariables,
      (Cohort (TVar CursorVariableValues), CohortVariables,
       [Subscriber])))]
-&gt; [(CohortVariables,
     (Cohort (TVar CursorVariableValues), CohortVariables,
      [Subscriber]))]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(CohortExecutionDetails,
  (CohortVariables,
   (Cohort (TVar CursorVariableValues), CohortVariables,
    [Subscriber])))]
</span><a href="#local-6989586621689402408"><span class="hs-identifier hs-var">cohortsExecutionDetails</span></a></span><span>
</span><span id="line-295"></span><span>          </span><span id="local-6989586621689402378"><span class="annot"><span class="annottext">batchExecDetails :: BatchExecutionDetails
</span><a href="#local-6989586621689402378"><span class="hs-identifier hs-var hs-var">batchExecDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-296"></span><span>            </span><span class="annot"><span class="annottext">DiffTime
-&gt; DiffTime
-&gt; BatchId
-&gt; [CohortExecutionDetails]
-&gt; Maybe Int
-&gt; BatchExecutionDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchExecutionDetails"><span class="hs-identifier hs-var">BatchExecutionDetails</span></a></span><span>
</span><span id="line-297"></span><span>              </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402425"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span><span>
</span><span id="line-298"></span><span>              </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402409"><span class="hs-identifier hs-var">pushTime</span></a></span><span>
</span><span id="line-299"></span><span>              </span><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621689402427"><span class="hs-identifier hs-var">batchId</span></a></span><span>
</span><span id="line-300"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CohortExecutionDetails,
 (CohortVariables,
  (Cohort (TVar CursorVariableValues), CohortVariables,
   [Subscriber])))
-&gt; CohortExecutionDetails
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((CohortExecutionDetails,
  (CohortVariables,
   (Cohort (TVar CursorVariableValues), CohortVariables,
    [Subscriber])))
 -&gt; CohortExecutionDetails)
-&gt; [(CohortExecutionDetails,
     (CohortVariables,
      (Cohort (TVar CursorVariableValues), CohortVariables,
       [Subscriber])))]
-&gt; [CohortExecutionDetails]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(CohortExecutionDetails,
  (CohortVariables,
   (Cohort (TVar CursorVariableValues), CohortVariables,
    [Subscriber])))]
</span><a href="#local-6989586621689402408"><span class="hs-identifier hs-var">cohortsExecutionDetails</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>              </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621689402416"><span class="hs-identifier hs-var">batchResponseSize</span></a></span><span>
</span><span id="line-302"></span><span>      </span><span class="annot"><span class="annottext">(BatchExecutionDetails,
 [(CohortVariables,
   (Cohort (TVar CursorVariableValues), CohortVariables,
    [Subscriber]))])
-&gt; IO
     (BatchExecutionDetails,
      [(CohortVariables,
        (Cohort (TVar CursorVariableValues), CohortVariables,
         [Subscriber]))])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">((BatchExecutionDetails,
  [(CohortVariables,
    (Cohort (TVar CursorVariableValues), CohortVariables,
     [Subscriber]))])
 -&gt; IO
      (BatchExecutionDetails,
       [(CohortVariables,
         (Cohort (TVar CursorVariableValues), CohortVariables,
          [Subscriber]))]))
-&gt; (BatchExecutionDetails,
    [(CohortVariables,
      (Cohort (TVar CursorVariableValues), CohortVariables,
       [Subscriber]))])
-&gt; IO
     (BatchExecutionDetails,
      [(CohortVariables,
        (Cohort (TVar CursorVariableValues), CohortVariables,
         [Subscriber]))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BatchExecutionDetails
</span><a href="#local-6989586621689402378"><span class="hs-identifier hs-var">batchExecDetails</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(CohortVariables,
  (Cohort (TVar CursorVariableValues), CohortVariables,
   [Subscriber]))]
</span><a href="#local-6989586621689402379"><span class="hs-identifier hs-var">processedCohortBatch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>    </span><span class="annot"><span class="annottext">(DiffTime,
 [(BatchExecutionDetails,
   [(CohortVariables,
     (Cohort (TVar CursorVariableValues), CohortVariables,
      [Subscriber]))])])
-&gt; IO
     (DiffTime,
      [(BatchExecutionDetails,
        [(CohortVariables,
          (Cohort (TVar CursorVariableValues), CohortVariables,
           [Subscriber]))])])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402442"><span class="hs-identifier hs-var">snapshotTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(BatchExecutionDetails,
  [(CohortVariables,
    (Cohort (TVar CursorVariableValues), CohortVariables,
     [Subscriber]))])]
</span><a href="#local-6989586621689402429"><span class="hs-identifier hs-var">batchesDetailsAndProcessedCohorts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402376"><span class="annot"><span class="annottext">pollDetails :: PollDetails
</span><a href="#local-6989586621689402376"><span class="hs-identifier hs-var hs-var">pollDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-307"></span><span>        </span><span class="annot"><span class="annottext">PollDetails :: PollerId
-&gt; Text
-&gt; DiffTime
-&gt; [BatchExecutionDetails]
-&gt; DiffTime
-&gt; SubscriptionsOptions
-&gt; SourceName
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; PollDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span>
</span><span id="line-308"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_pdPollerId :: PollerId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdPollerId"><span class="hs-identifier hs-var">_pdPollerId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621689402457"><span class="hs-identifier hs-var">pollerId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-309"></span><span>            </span><span class="annot"><span class="annottext">_pdGeneratedSql :: Text
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdGeneratedSql"><span class="hs-identifier hs-var">_pdGeneratedSql</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621689402451"><span class="hs-identifier hs-var">query</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-310"></span><span>            </span><span class="annot"><span class="annottext">_pdSnapshotTime :: DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdSnapshotTime"><span class="hs-identifier hs-var">_pdSnapshotTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402445"><span class="hs-identifier hs-var">snapshotTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-311"></span><span>            </span><span class="annot"><span class="annottext">_pdBatches :: [BatchExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdBatches"><span class="hs-identifier hs-var">_pdBatches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(BatchExecutionDetails,
 [(CohortVariables,
   (Cohort (TVar CursorVariableValues), CohortVariables,
    [Subscriber]))])
-&gt; BatchExecutionDetails
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((BatchExecutionDetails,
  [(CohortVariables,
    (Cohort (TVar CursorVariableValues), CohortVariables,
     [Subscriber]))])
 -&gt; BatchExecutionDetails)
-&gt; [(BatchExecutionDetails,
     [(CohortVariables,
       (Cohort (TVar CursorVariableValues), CohortVariables,
        [Subscriber]))])]
-&gt; [BatchExecutionDetails]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(BatchExecutionDetails,
  [(CohortVariables,
    (Cohort (TVar CursorVariableValues), CohortVariables,
     [Subscriber]))])]
</span><a href="#local-6989586621689402444"><span class="hs-identifier hs-var">batchesDetailsAndProcessedCohorts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-312"></span><span>            </span><span class="annot"><span class="annottext">_pdLiveQueryOptions :: SubscriptionsOptions
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdLiveQueryOptions"><span class="hs-identifier hs-var">_pdLiveQueryOptions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionsOptions
</span><a href="#local-6989586621689402456"><span class="hs-identifier hs-var">lqOpts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-313"></span><span>            </span><span class="annot"><span class="annottext">_pdTotalTime :: DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdTotalTime"><span class="hs-identifier hs-var">_pdTotalTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689402446"><span class="hs-identifier hs-var">totalTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-314"></span><span>            </span><span class="annot"><span class="annottext">_pdSource :: SourceName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdSource"><span class="hs-identifier hs-var">_pdSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689402455"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-315"></span><span>            </span><span class="annot"><span class="annottext">_pdRole :: RoleName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdRole"><span class="hs-identifier hs-var">_pdRole</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689402453"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-316"></span><span>            </span><span class="annot"><span class="annottext">_pdParameterizedQueryHash :: ParameterizedQueryHash
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdParameterizedQueryHash"><span class="hs-identifier hs-var">_pdParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621689402452"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-317"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span>  </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-comment">-- constructing a cohort map for all the cohorts that have been</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-comment">-- processed in the current poll</span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-comment">-- processed cohorts is an array of tuples of the current poll cohort variables and a tuple</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-comment">-- of the cohort and the new cohort key</span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402364"><span class="annot"><span class="annottext">processedCohortsMap :: HashMap
  CohortVariables
  (Cohort (TVar CursorVariableValues), CohortVariables, [Subscriber])
</span><a href="#local-6989586621689402364"><span class="hs-identifier hs-var hs-var">processedCohortsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(CohortVariables,
  (Cohort (TVar CursorVariableValues), CohortVariables,
   [Subscriber]))]
-&gt; HashMap
     CohortVariables
     (Cohort (TVar CursorVariableValues), CohortVariables, [Subscriber])
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(CohortVariables,
   (Cohort (TVar CursorVariableValues), CohortVariables,
    [Subscriber]))]
 -&gt; HashMap
      CohortVariables
      (Cohort (TVar CursorVariableValues), CohortVariables,
       [Subscriber]))
-&gt; [(CohortVariables,
     (Cohort (TVar CursorVariableValues), CohortVariables,
      [Subscriber]))]
-&gt; HashMap
     CohortVariables
     (Cohort (TVar CursorVariableValues), CohortVariables, [Subscriber])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(BatchExecutionDetails,
 [(CohortVariables,
   (Cohort (TVar CursorVariableValues), CohortVariables,
    [Subscriber]))])
-&gt; [(CohortVariables,
     (Cohort (TVar CursorVariableValues), CohortVariables,
      [Subscriber]))]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((BatchExecutionDetails,
  [(CohortVariables,
    (Cohort (TVar CursorVariableValues), CohortVariables,
     [Subscriber]))])
 -&gt; [(CohortVariables,
      (Cohort (TVar CursorVariableValues), CohortVariables,
       [Subscriber]))])
-&gt; [(BatchExecutionDetails,
     [(CohortVariables,
       (Cohort (TVar CursorVariableValues), CohortVariables,
        [Subscriber]))])]
-&gt; [(CohortVariables,
     (Cohort (TVar CursorVariableValues), CohortVariables,
      [Subscriber]))]
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">[(BatchExecutionDetails,
  [(CohortVariables,
    (Cohort (TVar CursorVariableValues), CohortVariables,
     [Subscriber]))])]
</span><a href="#local-6989586621689402444"><span class="hs-identifier hs-var">batchesDetailsAndProcessedCohorts</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-comment">-- rebuilding the cohorts and the cohort map, see [Streaming subscription polling]</span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-comment">-- and [Streaming subscriptions rebuilding cohort map]</span><span>
</span><span id="line-329"></span><span>    </span><span id="local-6989586621689402361"><span class="annot"><span class="annottext">[(CohortVariables, Cohort (TVar CursorVariableValues))]
</span><a href="#local-6989586621689402361"><span class="hs-identifier hs-var">currentCohorts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort (TVar CursorVariableValues))
-&gt; STM [(CohortVariables, Cohort (TVar CursorVariableValues))]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort (TVar CursorVariableValues))
CohortMap 'Streaming
</span><a href="#local-6989586621689402450"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span id="local-6989586621689402360"><span class="annot"><span class="annottext">HashMap CohortVariables (Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621689402360"><span class="hs-identifier hs-var">updatedCohortsMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-331"></span><span>      </span><span class="annot"><span class="annottext">(HashMap CohortVariables (Cohort (TVar CursorVariableValues))
 -&gt; (CohortVariables, Cohort (TVar CursorVariableValues))
 -&gt; STM
      (HashMap CohortVariables (Cohort (TVar CursorVariableValues))))
-&gt; HashMap CohortVariables (Cohort (TVar CursorVariableValues))
-&gt; [(CohortVariables, Cohort (TVar CursorVariableValues))]
-&gt; STM
     (HashMap CohortVariables (Cohort (TVar CursorVariableValues)))
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span>
</span><span id="line-332"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689402358"><span class="annot"><span class="annottext">HashMap CohortVariables (Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621689402358"><span class="hs-identifier hs-var">accCohortMap</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689402357"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402357"><span class="hs-identifier hs-var">currentCohortKey</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402356"><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402356"><span class="hs-identifier hs-var">currentCohort</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402355"><span class="annot"><span class="annottext">processedCohortMaybe :: Maybe
  (Cohort (TVar CursorVariableValues), CohortVariables, [Subscriber])
</span><a href="#local-6989586621689402355"><span class="hs-identifier hs-var hs-var">processedCohortMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortVariables
-&gt; HashMap
     CohortVariables
     (Cohort (TVar CursorVariableValues), CohortVariables, [Subscriber])
-&gt; Maybe
     (Cohort (TVar CursorVariableValues), CohortVariables, [Subscriber])
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402357"><span class="hs-identifier hs-var">currentCohortKey</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  CohortVariables
  (Cohort (TVar CursorVariableValues), CohortVariables, [Subscriber])
</span><a href="#local-6989586621689402364"><span class="hs-identifier hs-var">processedCohortsMap</span></a></span><span>
</span><span id="line-334"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Cohort (TVar CursorVariableValues), CohortVariables, [Subscriber])
</span><a href="#local-6989586621689402355"><span class="hs-identifier hs-var">processedCohortMaybe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-335"></span><span>              </span><span class="hs-comment">-- A new cohort has been added in the cohort map whilst the</span><span>
</span><span id="line-336"></span><span>              </span><span class="hs-comment">-- current poll was happening, in this case we just return it</span><span>
</span><span id="line-337"></span><span>              </span><span class="hs-comment">-- as it is</span><span>
</span><span id="line-338"></span><span>              </span><span class="annot"><span class="annottext">Maybe
  (Cohort (TVar CursorVariableValues), CohortVariables, [Subscriber])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Cohort (TVar CursorVariableValues)
 -&gt; Cohort (TVar CursorVariableValues)
 -&gt; STM (Cohort (TVar CursorVariableValues)))
-&gt; CohortVariables
-&gt; Cohort (TVar CursorVariableValues)
-&gt; HashMap CohortVariables (Cohort (TVar CursorVariableValues))
-&gt; STM
     (HashMap CohortVariables (Cohort (TVar CursorVariableValues)))
forall (m :: * -&gt; *) k v.
(Monad m, Hashable k, Eq k) =&gt;
(v -&gt; v -&gt; m v) -&gt; k -&gt; v -&gt; HashMap k v -&gt; m (HashMap k v)
</span><a href="Data.HashMap.Strict.Extended.html#insertWithM"><span class="hs-identifier hs-var">Map.insertWithM</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
-&gt; Cohort (TVar CursorVariableValues)
-&gt; STM (Cohort (TVar CursorVariableValues))
Cohort 'Streaming -&gt; Cohort 'Streaming -&gt; STM (Cohort 'Streaming)
</span><a href="#local-6989586621689402352"><span class="hs-identifier hs-var">mergeCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402357"><span class="hs-identifier hs-var">currentCohortKey</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402356"><span class="hs-identifier hs-var">currentCohort</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap CohortVariables (Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621689402358"><span class="hs-identifier hs-var">accCohortMap</span></a></span><span>
</span><span id="line-339"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689402351"><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402351"><span class="hs-identifier hs-var">processedCohort</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402350"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402350"><span class="hs-identifier hs-var">updatedCohortKey</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402349"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402349"><span class="hs-identifier hs-var">snapshottedNewSubs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-340"></span><span>                </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; [Subscriber] -&gt; STM ()
forall streamCursorVars.
Cohort streamCursorVars -&gt; [Subscriber] -&gt; STM ()
</span><a href="#local-6989586621689402348"><span class="hs-identifier hs-var">updateCohortSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402356"><span class="hs-identifier hs-var">currentCohort</span></a></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402349"><span class="hs-identifier hs-var">snapshottedNewSubs</span></a></span><span>
</span><span id="line-341"></span><span>                </span><span id="local-6989586621689402347"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689402347"><span class="hs-identifier hs-var">currentCohortExistingSubscribers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(TMap SubscriberId Subscriber -&gt; STM [(SubscriberId, Subscriber)])
-&gt; TMap SubscriberId Subscriber -&gt; STM [(SubscriberId, Subscriber)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cExistingSubscribers"><span class="hs-identifier hs-var hs-var">C._cExistingSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402356"><span class="hs-identifier hs-var">currentCohort</span></a></span><span>
</span><span id="line-342"></span><span>                </span><span id="local-6989586621689402345"><span class="annot"><span class="annottext">HashMap SubscriberId Subscriber
</span><a href="#local-6989586621689402345"><span class="hs-identifier hs-var">newlyAddedSubscribers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
-&gt; STM (HashMap SubscriberId Subscriber)
forall k v. TMap k v -&gt; STM (HashMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#getMap"><span class="hs-identifier hs-var">TMap.getMap</span></a></span><span> </span><span class="annot"><span class="annottext">(TMap SubscriberId Subscriber
 -&gt; STM (HashMap SubscriberId Subscriber))
-&gt; TMap SubscriberId Subscriber
-&gt; STM (HashMap SubscriberId Subscriber)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var hs-var">C._cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402356"><span class="hs-identifier hs-var">currentCohort</span></a></span><span>
</span><span id="line-343"></span><span>                </span><span class="hs-comment">-- The newly added subscribers should not be added to the updated cohort, they should be added</span><span>
</span><span id="line-344"></span><span>                </span><span class="hs-comment">-- to the old cohort because they need to be procesed for the first time with their initial value.</span><span>
</span><span id="line-345"></span><span>                </span><span class="hs-comment">-- For example: let's take 2 cohorts,</span><span>
</span><span id="line-346"></span><span>                </span><span class="hs-comment">-- s means a subscriber</span><span>
</span><span id="line-347"></span><span>                </span><span class="hs-comment">-- C1 - [s1, s2]</span><span>
</span><span id="line-348"></span><span>                </span><span class="hs-comment">-- C2 -&gt; [s3]</span><span>
</span><span id="line-349"></span><span>                </span><span class="hs-comment">-- and S4 is added to C1 and S5 is added to C2 during the poll.</span><span>
</span><span id="line-350"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-351"></span><span>                </span><span class="hs-comment">-- Let's say C1 is updated to C2 and C2 to C3, then</span><span>
</span><span id="line-352"></span><span>                </span><span class="hs-comment">-- the updated cohort map should look like:</span><span>
</span><span id="line-353"></span><span>                </span><span class="hs-comment">-- C1 -&gt; [s4]</span><span>
</span><span id="line-354"></span><span>                </span><span class="hs-comment">-- C2 -&gt; [s1, s2, s5]</span><span>
</span><span id="line-355"></span><span>                </span><span class="hs-comment">-- C3 -&gt; [s3]</span><span>
</span><span id="line-356"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-357"></span><span>                </span><span class="hs-comment">-- Note that s4 and s5 have not been added to the updated cohort and instead</span><span>
</span><span id="line-358"></span><span>                </span><span class="hs-comment">-- are in the original cohort they were added in.</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>                </span><span class="hs-comment">-- all the existing subsribers are removed from the current cohort and</span><span>
</span><span id="line-361"></span><span>                </span><span class="hs-comment">-- the newly added subscribers are added back</span><span>
</span><span id="line-362"></span><span>                </span><span id="local-6989586621689402342"><span class="annot"><span class="annottext">HashMap CohortVariables (Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621689402342"><span class="hs-identifier hs-var">accCohortMapWithCurrentCohort</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-363"></span><span>                  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">HashMap SubscriberId Subscriber -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">HashMap SubscriberId Subscriber
</span><a href="#local-6989586621689402345"><span class="hs-identifier hs-var">newlyAddedSubscribers</span></a></span><span>
</span><span id="line-364"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">HashMap CohortVariables (Cohort (TVar CursorVariableValues))
-&gt; STM
     (HashMap CohortVariables (Cohort (TVar CursorVariableValues)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">HashMap CohortVariables (Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621689402358"><span class="hs-identifier hs-var">accCohortMap</span></a></span><span>
</span><span id="line-365"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>                      </span><span class="hs-comment">-- Creating a new cohort which will only contain the newly added subscribers</span><span>
</span><span id="line-367"></span><span>                      </span><span id="local-6989586621689402340"><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402340"><span class="hs-identifier hs-var">newCohort</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-368"></span><span>                        </span><span id="local-6989586621689402339"><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402339"><span class="hs-identifier hs-var">existingSubs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TMap SubscriberId Subscriber)
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span>
</span><span id="line-369"></span><span>                        </span><span id="local-6989586621689402337"><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402337"><span class="hs-identifier hs-var">newSubs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TMap SubscriberId Subscriber)
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span>
</span><span id="line-370"></span><span>                        </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
-&gt; STM (Cohort (TVar CursorVariableValues))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Cohort (TVar CursorVariableValues)
 -&gt; STM (Cohort (TVar CursorVariableValues)))
-&gt; Cohort (TVar CursorVariableValues)
-&gt; STM (Cohort (TVar CursorVariableValues))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-371"></span><span>                          </span><span class="annot"><span class="annottext">CohortId
-&gt; TVar (Maybe ResponseHash)
-&gt; TMap SubscriberId Subscriber
-&gt; TMap SubscriberId Subscriber
-&gt; TVar CursorVariableValues
-&gt; Cohort (TVar CursorVariableValues)
forall streamCursorVars.
CohortId
-&gt; TVar (Maybe ResponseHash)
-&gt; TMap SubscriberId Subscriber
-&gt; TMap SubscriberId Subscriber
-&gt; streamCursorVars
-&gt; Cohort streamCursorVars
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-var">C.Cohort</span></a></span><span>
</span><span id="line-372"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; CohortId
forall streamCursorVars. Cohort streamCursorVars -&gt; CohortId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cCohortId"><span class="hs-identifier hs-var hs-var">C._cCohortId</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402356"><span class="hs-identifier hs-var">currentCohort</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TVar (Maybe ResponseHash)
forall streamCursorVars.
Cohort streamCursorVars -&gt; TVar (Maybe ResponseHash)
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cPreviousResponse"><span class="hs-identifier hs-var hs-var">C._cPreviousResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402356"><span class="hs-identifier hs-var">currentCohort</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>                            </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402339"><span class="hs-identifier hs-var">existingSubs</span></a></span><span>
</span><span id="line-375"></span><span>                            </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402337"><span class="hs-identifier hs-var">newSubs</span></a></span><span>
</span><span id="line-376"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TVar CursorVariableValues
forall streamCursorVars.
Cohort streamCursorVars -&gt; streamCursorVars
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cStreamCursorVariables"><span class="hs-identifier hs-var hs-var">C._cStreamCursorVariables</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402356"><span class="hs-identifier hs-var">currentCohort</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>                      </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
-&gt; HashMap SubscriberId Subscriber -&gt; STM ()
forall k v. TMap k v -&gt; HashMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#replace"><span class="hs-identifier hs-var">TMap.replace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var hs-var">C._cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402340"><span class="hs-identifier hs-var">newCohort</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap SubscriberId Subscriber
</span><a href="#local-6989586621689402345"><span class="hs-identifier hs-var">newlyAddedSubscribers</span></a></span><span>
</span><span id="line-378"></span><span>                      </span><span class="annot"><span class="annottext">(Cohort (TVar CursorVariableValues)
 -&gt; Cohort (TVar CursorVariableValues)
 -&gt; STM (Cohort (TVar CursorVariableValues)))
-&gt; CohortVariables
-&gt; Cohort (TVar CursorVariableValues)
-&gt; HashMap CohortVariables (Cohort (TVar CursorVariableValues))
-&gt; STM
     (HashMap CohortVariables (Cohort (TVar CursorVariableValues)))
forall (m :: * -&gt; *) k v.
(Monad m, Hashable k, Eq k) =&gt;
(v -&gt; v -&gt; m v) -&gt; k -&gt; v -&gt; HashMap k v -&gt; m (HashMap k v)
</span><a href="Data.HashMap.Strict.Extended.html#insertWithM"><span class="hs-identifier hs-var">Map.insertWithM</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
-&gt; Cohort (TVar CursorVariableValues)
-&gt; STM (Cohort (TVar CursorVariableValues))
Cohort 'Streaming -&gt; Cohort 'Streaming -&gt; STM (Cohort 'Streaming)
</span><a href="#local-6989586621689402352"><span class="hs-identifier hs-var">mergeCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402357"><span class="hs-identifier hs-var">currentCohortKey</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402340"><span class="hs-identifier hs-var">newCohort</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap CohortVariables (Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621689402358"><span class="hs-identifier hs-var">accCohortMap</span></a></span><span>
</span><span id="line-379"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402332"><span class="annot"><span class="annottext">allCurrentSubscribers :: HashSet SubscriberId
</span><a href="#local-6989586621689402332"><span class="hs-identifier hs-var hs-var">allCurrentSubscribers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubscriberId] -&gt; HashSet SubscriberId
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([SubscriberId] -&gt; HashSet SubscriberId)
-&gt; [SubscriberId] -&gt; HashSet SubscriberId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; SubscriberId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; SubscriberId)
-&gt; [(SubscriberId, Subscriber)] -&gt; [SubscriberId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap SubscriberId Subscriber -&gt; [(SubscriberId, Subscriber)]
forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">HashMap SubscriberId Subscriber
</span><a href="#local-6989586621689402345"><span class="hs-identifier hs-var">newlyAddedSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
-&gt; [(SubscriberId, Subscriber)] -&gt; [(SubscriberId, Subscriber)]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689402347"><span class="hs-identifier hs-var">currentCohortExistingSubscribers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>                </span><span class="hs-comment">-- retain subscribers only if they still exist in the original cohort's subscriber.</span><span>
</span><span id="line-381"></span><span>                </span><span class="hs-comment">-- It may happen that a subscriber has stopped their subscription which means it will</span><span>
</span><span id="line-382"></span><span>                </span><span class="hs-comment">-- no longer exist in the cohort map, so we need to accordingly remove such subscribers</span><span>
</span><span id="line-383"></span><span>                </span><span class="hs-comment">-- from our processed cohorts.</span><span>
</span><span id="line-384"></span><span>                </span><span class="annot"><span class="annottext">(SubscriberId -&gt; Subscriber -&gt; Bool)
-&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. (k -&gt; v -&gt; Bool) -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#filterWithKey"><span class="hs-identifier hs-var">TMap.filterWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621689402328"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689402328"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689402328"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId -&gt; HashSet SubscriberId -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">HashSet SubscriberId
</span><a href="#local-6989586621689402332"><span class="hs-identifier hs-var">allCurrentSubscribers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TMap SubscriberId Subscriber -&gt; STM ())
-&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cExistingSubscribers"><span class="hs-identifier hs-var hs-var">C._cExistingSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402351"><span class="hs-identifier hs-var">processedCohort</span></a></span><span>
</span><span id="line-385"></span><span>                </span><span class="annot"><span class="annottext">(SubscriberId -&gt; Subscriber -&gt; Bool)
-&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. (k -&gt; v -&gt; Bool) -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#filterWithKey"><span class="hs-identifier hs-var">TMap.filterWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621689402326"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689402326"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689402326"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId -&gt; HashSet SubscriberId -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">HashSet SubscriberId
</span><a href="#local-6989586621689402332"><span class="hs-identifier hs-var">allCurrentSubscribers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TMap SubscriberId Subscriber -&gt; STM ())
-&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var hs-var">C._cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402351"><span class="hs-identifier hs-var">processedCohort</span></a></span><span>
</span><span id="line-386"></span><span>                </span><span class="annot"><span class="annottext">(Cohort (TVar CursorVariableValues)
 -&gt; Cohort (TVar CursorVariableValues)
 -&gt; STM (Cohort (TVar CursorVariableValues)))
-&gt; CohortVariables
-&gt; Cohort (TVar CursorVariableValues)
-&gt; HashMap CohortVariables (Cohort (TVar CursorVariableValues))
-&gt; STM
     (HashMap CohortVariables (Cohort (TVar CursorVariableValues)))
forall (m :: * -&gt; *) k v.
(Monad m, Hashable k, Eq k) =&gt;
(v -&gt; v -&gt; m v) -&gt; k -&gt; v -&gt; HashMap k v -&gt; m (HashMap k v)
</span><a href="Data.HashMap.Strict.Extended.html#insertWithM"><span class="hs-identifier hs-var">Map.insertWithM</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
-&gt; Cohort (TVar CursorVariableValues)
-&gt; STM (Cohort (TVar CursorVariableValues))
Cohort 'Streaming -&gt; Cohort 'Streaming -&gt; STM (Cohort 'Streaming)
</span><a href="#local-6989586621689402352"><span class="hs-identifier hs-var">mergeCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402350"><span class="hs-identifier hs-var">updatedCohortKey</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621689402351"><span class="hs-identifier hs-var">processedCohort</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap CohortVariables (Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621689402342"><span class="hs-identifier hs-var">accCohortMapWithCurrentCohort</span></a></span><span>
</span><span id="line-387"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="annottext">HashMap CohortVariables (Cohort (TVar CursorVariableValues))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-389"></span><span>        </span><span class="annot"><span class="annottext">[(CohortVariables, Cohort (TVar CursorVariableValues))]
</span><a href="#local-6989586621689402361"><span class="hs-identifier hs-var">currentCohorts</span></a></span><span>
</span><span id="line-390"></span><span>    </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort (TVar CursorVariableValues))
-&gt; HashMap CohortVariables (Cohort (TVar CursorVariableValues))
-&gt; STM ()
forall k v. TMap k v -&gt; HashMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#replace"><span class="hs-identifier hs-var">TMap.replace</span></a></span><span> </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort (TVar CursorVariableValues))
CohortMap 'Streaming
</span><a href="#local-6989586621689402450"><span class="hs-identifier hs-var">cohortMap</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap CohortVariables (Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621689402360"><span class="hs-identifier hs-var">updatedCohortsMap</span></a></span><span>
</span><span id="line-391"></span><span>  </span><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621689402448"><span class="hs-identifier hs-var">postPollHook</span></a></span><span> </span><span class="annot"><span class="annottext">PollDetails
</span><a href="#local-6989586621689402376"><span class="hs-identifier hs-var">pollDetails</span></a></span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-393"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#SubscriptionsOptions"><span class="hs-identifier hs-type">SubscriptionsOptions</span></a></span><span> </span><span id="local-6989586621689402433"><span class="annot"><span class="annottext">BatchSize
</span><a href="#local-6989586621689402433"><span class="hs-identifier hs-var">batchSize</span></a></span></span><span> </span><span class="annot"><span class="annottext">RefetchInterval
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionsOptions
</span><a href="#local-6989586621689402456"><span class="hs-identifier hs-var">lqOpts</span></a></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>    </span><span id="local-6989586621689402348"><span class="annot"><span class="annottext">updateCohortSubscribers :: Cohort streamCursorVars -&gt; [Subscriber] -&gt; STM ()
</span><a href="#local-6989586621689402348"><span class="hs-identifier hs-var hs-var">updateCohortSubscribers</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-type">C.Cohort</span></a></span><span> </span><span id="local-6989586621689402324"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689402324"><span class="hs-identifier hs-var">_id</span></a></span></span><span> </span><span id="local-6989586621689402323"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689402323"><span class="hs-identifier hs-var">_respRef</span></a></span></span><span> </span><span id="local-6989586621689402322"><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402322"><span class="hs-identifier hs-var">curOpsTV</span></a></span></span><span> </span><span id="local-6989586621689402321"><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402321"><span class="hs-identifier hs-var">newOpsTV</span></a></span></span><span> </span><span class="annot"><span class="annottext">streamCursorVars
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689402320"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402320"><span class="hs-identifier hs-var">snapshottedNewSubs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-396"></span><span>      </span><span id="local-6989586621689402319"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689402319"><span class="hs-identifier hs-var">allNewOpsL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402321"><span class="hs-identifier hs-var">newOpsTV</span></a></span><span>
</span><span id="line-397"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402318"><span class="annot"><span class="annottext">snapshottedNewSubsSet :: HashSet SubscriberId
</span><a href="#local-6989586621689402318"><span class="hs-identifier hs-var hs-var">snapshottedNewSubsSet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubscriberId] -&gt; HashSet SubscriberId
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([SubscriberId] -&gt; HashSet SubscriberId)
-&gt; [SubscriberId] -&gt; HashSet SubscriberId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sId"><span class="hs-identifier hs-var hs-var">_sId</span></a></span><span> </span><span class="annot"><span class="annottext">(Subscriber -&gt; SubscriberId) -&gt; [Subscriber] -&gt; [SubscriberId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621689402320"><span class="hs-identifier hs-var">snapshottedNewSubs</span></a></span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
-&gt; ((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689402319"><span class="hs-identifier hs-var">allNewOpsL</span></a></span><span> </span><span class="annot"><span class="annottext">(((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ())
-&gt; ((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689402316"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689402316"><span class="hs-identifier hs-var">subId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402315"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621689402315"><span class="hs-identifier hs-var">subscriber</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-399"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689402316"><span class="hs-identifier hs-var">subId</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId -&gt; HashSet SubscriberId -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">HashSet SubscriberId
</span><a href="#local-6989586621689402318"><span class="hs-identifier hs-var">snapshottedNewSubsSet</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>          </span><span class="hs-comment">-- we only add the snapshotted new subscribers to the current subscribers</span><span>
</span><span id="line-401"></span><span>          </span><span class="hs-comment">-- because they have been sent the first message of the subscription. The</span><span>
</span><span id="line-402"></span><span>          </span><span class="hs-comment">-- new subscribers apart from the snapshotted new subscribers are yet to</span><span>
</span><span id="line-403"></span><span>          </span><span class="hs-comment">-- recieve their first message so we just keep them as new subscribers</span><span>
</span><span id="line-404"></span><span>          </span><span class="annot"><span class="annottext">Subscriber
-&gt; SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621689402315"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689402316"><span class="hs-identifier hs-var">subId</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402322"><span class="hs-identifier hs-var">curOpsTV</span></a></span><span>
</span><span id="line-405"></span><span>          </span><span class="annot"><span class="annottext">SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621689402316"><span class="hs-identifier hs-var">subId</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402321"><span class="hs-identifier hs-var">newOpsTV</span></a></span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>    </span><span id="local-6989586621689402436"><span class="annot"><span class="annottext">getCohortSnapshot :: (CohortVariables, Cohort streamCursorVars)
-&gt; STM (CohortId, (CohortSnapshot, Cohort streamCursorVars))
</span><a href="#local-6989586621689402436"><span class="hs-identifier hs-var hs-var">getCohortSnapshot</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689402311"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402311"><span class="hs-identifier hs-var">cohortVars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402310"><span class="annot"><span class="annottext">Cohort streamCursorVars
</span><a href="#local-6989586621689402310"><span class="hs-identifier hs-var">cohort</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-408"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-type">C.Cohort</span></a></span><span> </span><span id="local-6989586621689402309"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689402309"><span class="hs-identifier hs-var">resId</span></a></span></span><span> </span><span id="local-6989586621689402308"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689402308"><span class="hs-identifier hs-var">respRef</span></a></span></span><span> </span><span id="local-6989586621689402307"><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402307"><span class="hs-identifier hs-var">curOpsTV</span></a></span></span><span> </span><span id="local-6989586621689402306"><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402306"><span class="hs-identifier hs-var">newOpsTV</span></a></span></span><span> </span><span class="annot"><span class="annottext">streamCursorVars
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort streamCursorVars
</span><a href="#local-6989586621689402310"><span class="hs-identifier hs-var">cohort</span></a></span><span>
</span><span id="line-409"></span><span>      </span><span id="local-6989586621689402305"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689402305"><span class="hs-identifier hs-var">curOpsL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402307"><span class="hs-identifier hs-var">curOpsTV</span></a></span><span>
</span><span id="line-410"></span><span>      </span><span id="local-6989586621689402304"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689402304"><span class="hs-identifier hs-var">newOpsL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402306"><span class="hs-identifier hs-var">newOpsTV</span></a></span><span>
</span><span id="line-411"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402303"><span class="annot"><span class="annottext">cohortSnapshot :: CohortSnapshot
</span><a href="#local-6989586621689402303"><span class="hs-identifier hs-var hs-var">cohortSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortVariables
-&gt; TVar (Maybe ResponseHash)
-&gt; [Subscriber]
-&gt; [Subscriber]
-&gt; CohortSnapshot
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier hs-var">C.CohortSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621689402311"><span class="hs-identifier hs-var">cohortVars</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689402308"><span class="hs-identifier hs-var">respRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; Subscriber)
-&gt; [(SubscriberId, Subscriber)] -&gt; [Subscriber]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; Subscriber
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689402305"><span class="hs-identifier hs-var">curOpsL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; Subscriber)
-&gt; [(SubscriberId, Subscriber)] -&gt; [Subscriber]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; Subscriber
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689402304"><span class="hs-identifier hs-var">newOpsL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>      </span><span class="annot"><span class="annottext">(CohortId, (CohortSnapshot, Cohort streamCursorVars))
-&gt; STM (CohortId, (CohortSnapshot, Cohort streamCursorVars))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689402309"><span class="hs-identifier hs-var">resId</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621689402303"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Cohort streamCursorVars
</span><a href="#local-6989586621689402310"><span class="hs-identifier hs-var">cohort</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span>    </span><span class="annot"><a href="#local-6989586621689402352"><span class="hs-identifier hs-type">mergeCohorts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html#Cohort"><span class="hs-identifier hs-type">Cohort</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#Streaming"><span class="hs-identifier hs-type">Streaming</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html#Cohort"><span class="hs-identifier hs-type">Cohort</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#Streaming"><span class="hs-identifier hs-type">Streaming</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM.STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html#Cohort"><span class="hs-identifier hs-type">Cohort</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#Streaming"><span class="hs-identifier hs-type">Streaming</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>    </span><span id="local-6989586621689402352"><span class="annot"><span class="annottext">mergeCohorts :: Cohort 'Streaming -&gt; Cohort 'Streaming -&gt; STM (Cohort 'Streaming)
</span><a href="#local-6989586621689402352"><span class="hs-identifier hs-var hs-var">mergeCohorts</span></a></span></span><span> </span><span id="local-6989586621689402302"><span class="annot"><span class="annottext">Cohort 'Streaming
</span><a href="#local-6989586621689402302"><span class="hs-identifier hs-var">newCohort</span></a></span></span><span> </span><span id="local-6989586621689402301"><span class="annot"><span class="annottext">Cohort 'Streaming
</span><a href="#local-6989586621689402301"><span class="hs-identifier hs-var">oldCohort</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-416"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402300"><span class="annot"><span class="annottext">newCohortExistingSubscribers :: TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402300"><span class="hs-identifier hs-var hs-var">newCohortExistingSubscribers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cExistingSubscribers"><span class="hs-identifier hs-var hs-var">C._cExistingSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
Cohort 'Streaming
</span><a href="#local-6989586621689402302"><span class="hs-identifier hs-var">newCohort</span></a></span><span>
</span><span id="line-417"></span><span>          </span><span id="local-6989586621689402299"><span class="annot"><span class="annottext">oldCohortExistingSubscribers :: TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402299"><span class="hs-identifier hs-var hs-var">oldCohortExistingSubscribers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cExistingSubscribers"><span class="hs-identifier hs-var hs-var">C._cExistingSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
Cohort 'Streaming
</span><a href="#local-6989586621689402301"><span class="hs-identifier hs-var">oldCohort</span></a></span><span>
</span><span id="line-418"></span><span>          </span><span id="local-6989586621689402298"><span class="annot"><span class="annottext">newCohortNewSubscribers :: TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402298"><span class="hs-identifier hs-var hs-var">newCohortNewSubscribers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var hs-var">C._cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
Cohort 'Streaming
</span><a href="#local-6989586621689402302"><span class="hs-identifier hs-var">newCohort</span></a></span><span>
</span><span id="line-419"></span><span>          </span><span id="local-6989586621689402297"><span class="annot"><span class="annottext">oldCohortNewSubscribers :: TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402297"><span class="hs-identifier hs-var hs-var">oldCohortNewSubscribers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var hs-var">C._cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
Cohort 'Streaming
</span><a href="#local-6989586621689402301"><span class="hs-identifier hs-var">oldCohort</span></a></span><span>
</span><span id="line-420"></span><span>      </span><span id="local-6989586621689402296"><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402296"><span class="hs-identifier hs-var">mergedExistingSubscribers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
-&gt; TMap SubscriberId Subscriber
-&gt; STM (TMap SubscriberId Subscriber)
forall k v.
(Eq k, Hashable k) =&gt;
TMap k v -&gt; TMap k v -&gt; STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#union"><span class="hs-identifier hs-var">TMap.union</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402300"><span class="hs-identifier hs-var">newCohortExistingSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402299"><span class="hs-identifier hs-var">oldCohortExistingSubscribers</span></a></span><span>
</span><span id="line-421"></span><span>      </span><span id="local-6989586621689402294"><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402294"><span class="hs-identifier hs-var">mergedNewSubscribers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
-&gt; TMap SubscriberId Subscriber
-&gt; STM (TMap SubscriberId Subscriber)
forall k v.
(Eq k, Hashable k) =&gt;
TMap k v -&gt; TMap k v -&gt; STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#union"><span class="hs-identifier hs-var">TMap.union</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402298"><span class="hs-identifier hs-var">newCohortNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402297"><span class="hs-identifier hs-var">oldCohortNewSubscribers</span></a></span><span>
</span><span id="line-422"></span><span>      </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
-&gt; STM (Cohort (TVar CursorVariableValues))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Cohort (TVar CursorVariableValues)
 -&gt; STM (Cohort (TVar CursorVariableValues)))
-&gt; Cohort (TVar CursorVariableValues)
-&gt; STM (Cohort (TVar CursorVariableValues))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-423"></span><span>        </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
Cohort 'Streaming
</span><a href="#local-6989586621689402302"><span class="hs-identifier hs-var">newCohort</span></a></span><span>
</span><span id="line-424"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_cNewSubscribers :: TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var">C._cNewSubscribers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402294"><span class="hs-identifier hs-var">mergedNewSubscribers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-425"></span><span>            </span><span class="annot"><span class="annottext">_cExistingSubscribers :: TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cExistingSubscribers"><span class="hs-identifier hs-var">C._cExistingSubscribers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621689402296"><span class="hs-identifier hs-var">mergedExistingSubscribers</span></a></span><span>
</span><span id="line-426"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span>    </span><span id="local-6989586621689402417"><span class="annot"><span class="annottext">getCohortOperations :: [(k, t)]
-&gt; Either QErr [(k, ByteString, a)]
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t)]
</span><a href="#local-6989586621689402417"><span class="hs-identifier hs-var hs-var">getCohortOperations</span></a></span></span><span> </span><span id="local-6989586621689402293"><span class="annot"><span class="annottext">[(k, t)]
</span><a href="#local-6989586621689402293"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-429"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621689402292"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689402292"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402291"><span class="annot"><span class="annottext">resp :: m ByteString
</span><a href="#local-6989586621689402291"><span class="hs-identifier hs-var hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQExecError -&gt; m ByteString
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(GQExecError -&gt; m ByteString) -&gt; GQExecError -&gt; m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; GQExecError
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#GQExecError"><span class="hs-identifier hs-var">GQExecError</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Bool -&gt; QErr -&gt; Value
</span><a href="Hasura.Base.Error.html#encodeGQLErr"><span class="hs-identifier hs-var">encodeGQLErr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689402292"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-431"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">m ByteString
</span><a href="#local-6989586621689402291"><span class="hs-identifier hs-var">resp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621689402287"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621689402286"><span class="hs-identifier hs-var">snapshot</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689402287"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621689402287"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402286"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621689402286"><span class="hs-identifier hs-var">snapshot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(k, t)]
</span><a href="#local-6989586621689402293"><span class="hs-identifier hs-var">cohorts</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-432"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621689402285"><span class="annot"><span class="annottext">[(k, ByteString, a)]
</span><a href="#local-6989586621689402285"><span class="hs-identifier hs-var">responses</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-433"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402284"><span class="annot"><span class="annottext">cohortSnapshotMap :: HashMap k t
</span><a href="#local-6989586621689402284"><span class="hs-identifier hs-var hs-var">cohortSnapshotMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(k, t)] -&gt; HashMap k t
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(k, t)]
</span><a href="#local-6989586621689402293"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-434"></span><span>        </span><span class="hs-comment">-- every row of the response will contain the cohortId, response of the query and the latest value of the cursor for the cohort</span><span>
</span><span id="line-435"></span><span>        </span><span class="annot"><span class="annottext">(((k, ByteString, a)
  -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t))
 -&gt; [(k, ByteString, a)]
 -&gt; [(m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t)])
-&gt; [(k, ByteString, a)]
-&gt; ((k, ByteString, a)
    -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t))
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">((k, ByteString, a)
 -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t))
-&gt; [(k, ByteString, a)]
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t)]
forall (f :: * -&gt; *) a b.
Filterable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">[(k, ByteString, a)]
</span><a href="#local-6989586621689402285"><span class="hs-identifier hs-var">responses</span></a></span><span> </span><span class="annot"><span class="annottext">(((k, ByteString, a)
  -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t))
 -&gt; [(m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t)])
-&gt; ((k, ByteString, a)
    -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t))
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689402282"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621689402282"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402281"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689402281"><span class="hs-identifier hs-var">respBS</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689402280"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689402280"><span class="hs-identifier hs-var">respCursorLatestValue</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-436"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689402279"><span class="annot"><span class="annottext">respHash :: ResponseHash
</span><a href="#local-6989586621689402279"><span class="hs-identifier hs-var hs-var">respHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ResponseHash
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#mkRespHash"><span class="hs-identifier hs-var">mkRespHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689402281"><span class="hs-identifier hs-var">respBS</span></a></span><span>
</span><span id="line-437"></span><span>              </span><span id="local-6989586621689402277"><span class="annot"><span class="annottext">respSize :: Int
</span><a href="#local-6989586621689402277"><span class="hs-identifier hs-var hs-var">respSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689402281"><span class="hs-identifier hs-var">respBS</span></a></span><span>
</span><span id="line-438"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- TODO: currently we ignore the cases when the cohortId from</span><span>
</span><span id="line-439"></span><span>              </span><span class="hs-comment">-- Postgres response is not present in the cohort map of this batch</span><span>
</span><span id="line-440"></span><span>              </span><span class="hs-comment">-- (this shouldn't happen but if it happens it means a logic error and</span><span>
</span><span id="line-441"></span><span>              </span><span class="hs-comment">-- we should log it)</span><span>
</span><span id="line-442"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; m ByteString
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689402281"><span class="hs-identifier hs-var">respBS</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621689402282"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; Maybe (ResponseHash, Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResponseHash
</span><a href="#local-6989586621689402279"><span class="hs-identifier hs-var">respHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689402277"><span class="hs-identifier hs-var">respSize</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689402280"><span class="hs-identifier hs-var">respCursorLatestValue</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>                </span><span class="annot"><span class="annottext">(t -&gt; (m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t))
-&gt; Maybe t
-&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), Maybe a, t)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">k -&gt; HashMap k t -&gt; Maybe t
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621689402282"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap k t
</span><a href="#local-6989586621689402284"><span class="hs-identifier hs-var">cohortSnapshotMap</span></a></span><span>
</span><span id="line-444"></span></pre></body></html>