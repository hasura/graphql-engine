<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Permission</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildTablePermissions"><span class="hs-identifier">buildTablePermissions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#orderRoles"><span class="hs-identifier">orderRoles</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier">OrderedRoles</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier">_unOrderedRoles</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkBooleanPermissionMap"><span class="hs-identifier">mkBooleanPermissionMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier">resolveCheckPermission</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildLogicalModelPermissions"><span class="hs-identifier">buildLogicalModelPermissions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.html"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier">ToJSON</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html"><span class="hs-identifier">Data.Environment</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Env</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Graph</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Strict.html"><span class="hs-identifier">Data.HashMap.Strict</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/insert-ordered-containers-0.2.5.1-b5ad8e22c80bc291a2f581fb78a4448e46180aa38110e81c957f693abd1dc222/share/doc/html/src/Data.HashMap.Strict.InsOrd.html"><span class="hs-identifier">Data.HashMap.Strict.InsOrd</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InsOrdHashMap</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Sequence</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Seq</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.LogicalModel.API.html"><span class="hs-identifier">Hasura.LogicalModel.API</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LogicalModelName"><span class="hs-identifier">LogicalModelName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.LogicalModel.Fields.html"><span class="hs-identifier">Hasura.LogicalModel.Fields</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.LogicalModel.Fields.html#LogicalModelFieldsLookupRT"><span class="hs-identifier">LogicalModelFieldsLookupRT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.LogicalModel.Fields.html#LogicalModelFieldsRM"><span class="hs-identifier">LogicalModelFieldsRM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.LogicalModel.Fields.html#runLogicalModelFieldsLookup"><span class="hs-identifier">runLogicalModelFieldsLookup</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.LogicalModel.Metadata.html"><span class="hs-identifier">Hasura.LogicalModel.Metadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.LogicalModel.Metadata.html#LogicalModelMetadata"><span class="hs-identifier">LogicalModelMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.LogicalModel.Metadata.html#WithLogicalModel"><span class="hs-identifier">WithLogicalModel</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.LogicalModel.Types.html"><span class="hs-identifier">Hasura.LogicalModel.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LogicalModelField"><span class="hs-identifier">LogicalModelField</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LogicalModelLocation"><span class="hs-identifier">LogicalModelLocation</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.NativeQuery.Metadata.html"><span class="hs-identifier">Hasura.NativeQuery.Metadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.NativeQuery.Metadata.html#WithNativeQuery"><span class="hs-identifier">WithNativeQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html"><span class="hs-identifier">Hasura.RQL.DDL.Permission</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Common</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.IR.BoolExp.html"><span class="hs-identifier">Hasura.RQL.IR.BoolExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.IR.BoolExp.html#AnnRedactionExp"><span class="hs-identifier">AnnRedactionExp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata.Backend</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata.Object</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Permission.html"><span class="hs-identifier">Hasura.RQL.Types.Permission</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Relationships.Local.html"><span class="hs-identifier">Hasura.RQL.Types.Relationships.Local</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html"><span class="hs-identifier">Hasura.RQL.Types.Roles</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html"><span class="hs-identifier">Hasura.RQL.Types.Roles.Internal</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CheckPermission"><span class="hs-identifier">CheckPermission</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CombineRolePermInfo"><span class="hs-identifier">CombineRolePermInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#rolePermInfoToCombineRolePermInfo"><span class="hs-identifier">rolePermInfoToCombineRolePermInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache.Build</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCacheTypes</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Table.Cache.html"><span class="hs-identifier">Hasura.Table.Cache</span></a></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-comment">{- Note: [Inherited roles architecture for read queries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. Schema generation
--------------------

Schema generation for inherited roles is similar to the schema
generation of non-inherited roles. In the case of inherited roles,
we combine the `SelectPermInfo`s of the
inherited role's role set and a new `SelectPermInfo` will be generated
which will be the select permission of the inherited role.

Two `SelPermInfo`s will be combined in the following manner:

1. Columns - The `SelPermInfo` contains a hashset of the columns that are
   accessible to the role. To combine two `SelPermInfo`s, every column of the
   hashset is coupled with the boolean expression (filter) of the `SelPermInfo`
   and a hash map of all the columns is created out of it, this hashmap is
   generated for the `SelPermInfo`s that are going to be combined. These hashmaps
   are then unioned and the values of these hashmaps are `OR`ed. When a column
   is accessible to all the select permissions then the nullability of the column
   is inferred from the DB column otherwise the column is explicitly marked as
   nullable to accomodate cell-value nullification.
2. Scalar computed fields - Scalar computed fields work the same as Columns (#1)
3. Filter / Boolean expression - The filters are combined using a `BoolOr`
4. Limit - Limits are combined by taking the maximum of the two limits
5. Allow Aggregation - Aggregation is allowed, if any of the permissions allow it.
6. Request Headers - Request headers are concatenated

2. SQL generation
-----------------

See note [SQL generation for inherited roles]

3. Introspection
----------------

The columns accessible to an inherited role are explicitly set to
nullable irrespective of the nullability of the DB column to accomodate
cell value nullification.
-}</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span id="local-6989586621687979651"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkBooleanPermissionMap"><span class="hs-identifier hs-type">mkBooleanPermissionMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687979651"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979651"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979651"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-90"></span><span id="mkBooleanPermissionMap"><span class="annot"><span class="annottext">mkBooleanPermissionMap :: forall a.
(RoleName -&gt; a)
-&gt; HashMap RoleName a -&gt; OrderedRoles -&gt; HashMap RoleName a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#mkBooleanPermissionMap"><span class="hs-identifier hs-var hs-var">mkBooleanPermissionMap</span></a></span></span><span> </span><span id="local-6989586621687980088"><span class="annot"><span class="annottext">RoleName -&gt; a
</span><a href="#local-6989586621687980088"><span class="hs-identifier hs-var">constructorFn</span></a></span></span><span> </span><span id="local-6989586621687980089"><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621687980089"><span class="hs-identifier hs-var">metadataPermissions</span></a></span></span><span> </span><span id="local-6989586621687980090"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621687980090"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="annottext">(HashMap RoleName a -&gt; Role -&gt; HashMap RoleName a)
-&gt; HashMap RoleName a -&gt; [Role] -&gt; HashMap RoleName a
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a -&gt; Role -&gt; HashMap RoleName a
</span><a href="#local-6989586621687980092"><span class="hs-identifier hs-var">combineBooleanPermission</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621687980089"><span class="hs-identifier hs-var">metadataPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">([Role] -&gt; HashMap RoleName a) -&gt; [Role] -&gt; HashMap RoleName a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var">_unOrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621687980090"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-93"></span><span>    </span><span id="local-6989586621687980092"><span class="annot"><span class="annottext">combineBooleanPermission :: HashMap RoleName a -&gt; Role -&gt; HashMap RoleName a
</span><a href="#local-6989586621687980092"><span class="hs-identifier hs-var hs-var">combineBooleanPermission</span></a></span></span><span> </span><span id="local-6989586621687980093"><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621687980093"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span id="local-6989586621687980095"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980095"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#ParentRoles"><span class="hs-identifier hs-type">ParentRoles</span></a></span><span> </span><span id="local-6989586621687980097"><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621687980097"><span class="hs-identifier hs-var">parentRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; HashMap RoleName a -&gt; Maybe a
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980095"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621687980093"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-95"></span><span>        </span><span class="hs-comment">-- We check if a permission for the given role exists in the metadata, if it</span><span>
</span><span id="line-96"></span><span>        </span><span class="hs-comment">-- exists, we use that</span><span>
</span><span id="line-97"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621687980093"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span><span>
</span><span id="line-98"></span><span>        </span><span class="hs-comment">-- 2. When the permission doesn't exist, we try to inherit the permission from its parent roles</span><span>
</span><span id="line-99"></span><span>        </span><span class="hs-comment">-- For boolean permissions, if any of the parent roles have a permission to access an entity,</span><span>
</span><span id="line-100"></span><span>        </span><span class="hs-comment">-- then the inherited role will also be able to access the entity.</span><span>
</span><span id="line-101"></span><span>        </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-102"></span><span>          </span><span class="hs-comment">-- see Note [Roles Inheritance]</span><span>
</span><span id="line-103"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980099"><span class="annot"><span class="annottext">canInheritPermission :: Bool
</span><a href="#local-6989586621687980099"><span class="hs-identifier hs-var hs-var">canInheritPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RoleName -&gt; Bool) -&gt; [RoleName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; HashMap RoleName a -&gt; Bool
forall k a. (Eq k, Hashable k) =&gt; k -&gt; HashMap k a -&gt; Bool
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#member"><span class="hs-operator hs-var">`HashMap.member`</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621687980093"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall a. HashSet a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621687980097"><span class="hs-identifier hs-var">parentRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687980099"><span class="hs-identifier hs-var">canInheritPermission</span></a></span><span>
</span><span id="line-105"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; a -&gt; HashMap RoleName a -&gt; HashMap RoleName a
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.Strict.html#insert"><span class="hs-identifier hs-var">HashMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980095"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; a
</span><a href="#local-6989586621687980088"><span class="hs-identifier hs-var">constructorFn</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980095"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621687980093"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span><span>
</span><span id="line-106"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName a
</span><a href="#local-6989586621687980093"><span class="hs-identifier hs-var">accumulatedPermMap</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-comment">-- | `OrderedRoles` is a data type to hold topologically sorted roles</span><span>
</span><span id="line-109"></span><span class="hs-comment">--   according to each role's parent roles, see `orderRoles` for more details.</span><span>
</span><span id="line-110"></span><span class="hs-keyword">newtype</span><span> </span><span id="OrderedRoles"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-var">OrderedRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="OrderedRoles"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-var">OrderedRoles</span></a></span></span><span> </span><span class="hs-special">{</span><span id="_unOrderedRoles"><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var hs-var">_unOrderedRoles</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687980106"><span id="local-6989586621687980112"><span class="annot"><span class="annottext">OrderedRoles -&gt; OrderedRoles -&gt; Bool
(OrderedRoles -&gt; OrderedRoles -&gt; Bool)
-&gt; (OrderedRoles -&gt; OrderedRoles -&gt; Bool) -&gt; Eq OrderedRoles
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: OrderedRoles -&gt; OrderedRoles -&gt; Bool
== :: OrderedRoles -&gt; OrderedRoles -&gt; Bool
$c/= :: OrderedRoles -&gt; OrderedRoles -&gt; Bool
/= :: OrderedRoles -&gt; OrderedRoles -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980120"><span id="local-6989586621687980122"><span class="annot"><span class="annottext">(forall x. OrderedRoles -&gt; Rep OrderedRoles x)
-&gt; (forall x. Rep OrderedRoles x -&gt; OrderedRoles)
-&gt; Generic OrderedRoles
forall x. Rep OrderedRoles x -&gt; OrderedRoles
forall x. OrderedRoles -&gt; Rep OrderedRoles x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. OrderedRoles -&gt; Rep OrderedRoles x
from :: forall x. OrderedRoles -&gt; Rep OrderedRoles x
$cto :: forall x. Rep OrderedRoles x -&gt; OrderedRoles
to :: forall x. Rep OrderedRoles x -&gt; OrderedRoles
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-comment">-- | 'orderRoles' is used to order the roles, in such a way that given</span><span>
</span><span id="line-114"></span><span class="hs-comment">--   a role R with n parent roles - PR1, PR2 .. PRn, then the 'orderRoles'</span><span>
</span><span id="line-115"></span><span class="hs-comment">--   function will order the roles in such a way that all the parent roles</span><span>
</span><span id="line-116"></span><span class="hs-comment">--   precede the role R. Note that the order of the parent roles itself doesn't</span><span>
</span><span id="line-117"></span><span class="hs-comment">--   matter as long as they precede the roles on which they are dependent on.</span><span>
</span><span id="line-118"></span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span class="hs-comment">--   For example, the orderRoles may return `[PR1, PR3, PR2, ... PRn, R]`</span><span>
</span><span id="line-120"></span><span class="hs-comment">--   or `[PR5, PR3, PR1 ... R]`, both of them are correct because all</span><span>
</span><span id="line-121"></span><span class="hs-comment">--   the parent roles precede the inherited role R, assuming the parent roles</span><span>
</span><span id="line-122"></span><span class="hs-comment">--   themselves don't have any parents for the sake of this example.</span><span>
</span><span id="line-123"></span><span id="local-6989586621687979680"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#orderRoles"><span class="hs-identifier hs-type">orderRoles</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979680"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-126"></span><span>  </span><span class="annot"><a href="#local-6989586621687979680"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span></span><span>
</span><span id="line-127"></span><span id="orderRoles"><span class="annot"><span class="annottext">orderRoles :: forall (m :: * -&gt; *). MonadError QErr m =&gt; [Role] -&gt; m OrderedRoles
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#orderRoles"><span class="hs-identifier hs-var hs-var">orderRoles</span></a></span></span><span> </span><span id="local-6989586621687980149"><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621687980149"><span class="hs-identifier hs-var">allRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-comment">-- inherited roles can be created from other inherited and non-inherited roles</span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-comment">-- So, roles can be thought of as a graph where non-inherited roles don't have</span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-comment">-- any outgoing edges and inherited roles as nodes with edges to its parent roles</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-comment">-- However, we can't allow cyclic roles since permissions built by a role is used</span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-comment">-- by the dependent roles to build their permissions and if cyclic roles were to be</span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-comment">-- allowed, the permissions building will be stuck in an infinite loop</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980150"><span class="annot"><span class="annottext">graphNodesList :: [(Role, RoleName, [RoleName])]
</span><a href="#local-6989586621687980150"><span class="hs-identifier hs-var hs-var">graphNodesList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621687980151"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role -&gt; RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_rRoleName"><span class="hs-identifier hs-var">_rRoleName</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621687980151"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall a. HashSet a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ParentRoles -&gt; HashSet RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_unParentRoles"><span class="hs-identifier hs-var">_unParentRoles</span></a></span><span> </span><span class="annot"><span class="annottext">(ParentRoles -&gt; HashSet RoleName)
-&gt; (Role -&gt; ParentRoles) -&gt; Role -&gt; HashSet RoleName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; ParentRoles
</span><a href="Hasura.RQL.Types.Roles.html#_rParentRoles"><span class="hs-identifier hs-var">_rParentRoles</span></a></span><span> </span><span class="annot"><span class="annottext">(Role -&gt; HashSet RoleName) -&gt; Role -&gt; HashSet RoleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621687980151"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621687980151"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621687980151"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621687980149"><span class="hs-identifier hs-var">allRoles</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980156"><span class="annot"><span class="annottext">orderedGraphNodes :: [SCC Role]
</span><a href="#local-6989586621687980156"><span class="hs-identifier hs-var hs-var">orderedGraphNodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Role, RoleName, [RoleName])] -&gt; [SCC Role]
forall key node. Ord key =&gt; [(node, key, [key])] -&gt; [SCC node]
</span><span class="hs-identifier hs-var">G.stronglyConnComp</span></span><span> </span><span class="annot"><span class="annottext">[(Role, RoleName, [RoleName])]
</span><a href="#local-6989586621687980150"><span class="hs-identifier hs-var">graphNodesList</span></a></span><span> </span><span class="hs-comment">-- topologically sort the nodes of the graph</span><span>
</span><span id="line-136"></span><span>      </span><span id="local-6989586621687980158"><span class="annot"><span class="annottext">cyclicRoles :: [SCC Role]
</span><a href="#local-6989586621687980158"><span class="hs-identifier hs-var hs-var">cyclicRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SCC Role -&gt; Bool) -&gt; [SCC Role] -&gt; [SCC Role]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">SCC Role -&gt; Bool
forall {vertex}. SCC vertex -&gt; Bool
</span><a href="#local-6989586621687980159"><span class="hs-identifier hs-var">checkCycle</span></a></span><span> </span><span class="annot"><span class="annottext">[SCC Role]
</span><a href="#local-6989586621687980156"><span class="hs-identifier hs-var">orderedGraphNodes</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SCC Role] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[SCC Role]
</span><a href="#local-6989586621687980158"><span class="hs-identifier hs-var">cyclicRoles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-comment">-- we're appending the first element of the list at the end, so that the error message will</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-comment">-- contain the complete cycle of the roles</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980162"><span class="annot"><span class="annottext">roleCycles :: [Text]
</span><a href="#local-6989586621687980162"><span class="hs-identifier hs-var hs-var">roleCycles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SCC Role -&gt; Text) -&gt; [SCC Role] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; (SCC Role -&gt; [Text]) -&gt; SCC Role -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Role -&gt; Text) -&gt; [Role] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; Text
</span><a href="Hasura.RQL.Types.Roles.html#roleNameToTxt"><span class="hs-identifier hs-var">roleNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">(RoleName -&gt; Text) -&gt; (Role -&gt; RoleName) -&gt; Role -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; RoleName
</span><a href="Hasura.RQL.Types.Roles.html#_rRoleName"><span class="hs-identifier hs-var">_rRoleName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Role] -&gt; [Text]) -&gt; (SCC Role -&gt; [Role]) -&gt; SCC Role -&gt; [Text]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Role] -&gt; [Role]
forall {a}. [a] -&gt; [a]
</span><a href="#local-6989586621687980165"><span class="hs-identifier hs-var">appendFirstElementAtEnd</span></a></span><span> </span><span class="annot"><span class="annottext">([Role] -&gt; [Role]) -&gt; (SCC Role -&gt; [Role]) -&gt; SCC Role -&gt; [Role]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SCC Role -&gt; [Role]
forall vertex. SCC vertex -&gt; [vertex]
</span><span class="hs-identifier hs-var">G.flattenSCC</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SCC Role]
</span><a href="#local-6989586621687980158"><span class="hs-identifier hs-var">cyclicRoles</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#CyclicDependency"><span class="hs-identifier hs-var">CyclicDependency</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;found cycle(s) in roles: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621687980162"><span class="hs-identifier hs-var">roleCycles</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980170"><span class="annot"><span class="annottext">allOrderedRoles :: [Role]
</span><a href="#local-6989586621687980170"><span class="hs-identifier hs-var hs-var">allOrderedRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SCC Role] -&gt; [Role]
forall a. [SCC a] -&gt; [a]
</span><span class="hs-identifier hs-var">G.flattenSCCs</span></span><span> </span><span class="annot"><span class="annottext">[SCC Role]
</span><a href="#local-6989586621687980156"><span class="hs-identifier hs-var">orderedGraphNodes</span></a></span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><span class="annottext">OrderedRoles -&gt; m OrderedRoles
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(OrderedRoles -&gt; m OrderedRoles) -&gt; OrderedRoles -&gt; m OrderedRoles
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Role] -&gt; OrderedRoles
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-var">OrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621687980170"><span class="hs-identifier hs-var">allOrderedRoles</span></a></span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621687980159"><span class="annot"><span class="annottext">checkCycle :: SCC vertex -&gt; Bool
</span><a href="#local-6989586621687980159"><span class="hs-identifier hs-var hs-var">checkCycle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">G.AcyclicSCC</span></span><span> </span><span class="annot"><span class="annottext">vertex
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-147"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">G.CyclicSCC</span></span><span> </span><span class="annot"><span class="annottext">[vertex]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>    </span><span id="local-6989586621687980165"><span class="annot"><span class="annottext">appendFirstElementAtEnd :: [a] -&gt; [a]
</span><a href="#local-6989586621687980165"><span class="hs-identifier hs-var hs-var">appendFirstElementAtEnd</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><a href="#local-6989586621687980165"><span class="hs-identifier hs-var">appendFirstElementAtEnd</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687980174"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621687980174"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621687980175"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621687980175"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621687980174"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621687980175"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621687980174"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-comment">-- | `resolveCheckPermission` is a helper function which will convert the indermediate</span><span>
</span><span id="line-153"></span><span class="hs-comment">--    type `CheckPermission` to its original type. It will record any metadata inconsistencies, if exists.</span><span>
</span><span id="line-154"></span><span id="local-6989586621687979718"><span id="local-6989586621687979720"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier hs-type">resolveCheckPermission</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadWriter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectItem"><span class="hs-identifier hs-type">CollectItem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687979718"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CheckPermission"><span class="hs-identifier hs-type">CheckPermission</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979720"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#InconsistentRoleEntity"><span class="hs-identifier hs-type">InconsistentRoleEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><a href="#local-6989586621687979718"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621687979720"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-160"></span><span id="resolveCheckPermission"><span class="annot"><span class="annottext">resolveCheckPermission :: forall (m :: * -&gt; *) p.
MonadWriter (Seq CollectItem) m =&gt;
CheckPermission p
-&gt; RoleName -&gt; InconsistentRoleEntity -&gt; m (Maybe p)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier hs-var hs-var">resolveCheckPermission</span></a></span></span><span> </span><span id="local-6989586621687980185"><span class="annot"><span class="annottext">CheckPermission p
</span><a href="#local-6989586621687980185"><span class="hs-identifier hs-var">checkPermission</span></a></span></span><span> </span><span id="local-6989586621687980186"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980186"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621687980187"><span class="annot"><span class="annottext">InconsistentRoleEntity
</span><a href="#local-6989586621687980187"><span class="hs-identifier hs-var">inconsistentEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CheckPermission p
</span><a href="#local-6989586621687980185"><span class="hs-identifier hs-var">checkPermission</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="annottext">CheckPermission p
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPInconsistent"><span class="hs-identifier hs-var">CPInconsistent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980189"><span class="annot"><span class="annottext">inconsistentObj :: CollectItem
</span><a href="#local-6989586621687980189"><span class="hs-identifier hs-var hs-var">inconsistentObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-164"></span><span>            </span><span class="hs-comment">-- check `Conflicts while inheriting permissions` in `rfcs/inherited-roles-improvements.md`</span><span>
</span><span id="line-165"></span><span>            </span><span class="annot"><span class="annottext">InconsistentMetadata -&gt; CollectItem
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectInconsistentMetadata"><span class="hs-identifier hs-var">CollectInconsistentMetadata</span></a></span><span>
</span><span id="line-166"></span><span>              </span><span class="annot"><span class="annottext">(InconsistentMetadata -&gt; CollectItem)
-&gt; InconsistentMetadata -&gt; CollectItem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; InconsistentRoleEntity -&gt; InconsistentMetadata
</span><a href="Hasura.RQL.Types.Metadata.Object.html#ConflictingInheritedPermission"><span class="hs-identifier hs-var">ConflictingInheritedPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980186"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">InconsistentRoleEntity
</span><a href="#local-6989586621687980187"><span class="hs-identifier hs-var">inconsistentEntity</span></a></span><span>
</span><span id="line-167"></span><span>      </span><span class="annot"><span class="annottext">Seq CollectItem -&gt; m ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(Seq CollectItem -&gt; m ()) -&gt; Seq CollectItem -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CollectItem -&gt; Seq CollectItem
forall a. a -&gt; Seq a
</span><span class="hs-identifier hs-var">Seq.singleton</span></span><span> </span><span class="annot"><span class="annottext">CollectItem
</span><a href="#local-6989586621687980189"><span class="hs-identifier hs-var">inconsistentObj</span></a></span><span>
</span><span id="line-168"></span><span>      </span><span class="annot"><span class="annottext">Maybe p -&gt; m (Maybe p)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe p
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CPDefined"><span class="hs-identifier hs-type">CPDefined</span></a></span><span> </span><span id="local-6989586621687980195"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621687980195"><span class="hs-identifier hs-var">permissionDefn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe p -&gt; m (Maybe p)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe p -&gt; m (Maybe p)) -&gt; Maybe p -&gt; m (Maybe p)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">p -&gt; Maybe p
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621687980195"><span class="hs-identifier hs-var">permissionDefn</span></a></span><span>
</span><span id="line-170"></span><span>    </span><span class="annot"><span class="annottext">CheckPermission p
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPUndefined"><span class="hs-identifier hs-var">CPUndefined</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe p -&gt; m (Maybe p)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe p
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span id="local-6989586621687979730"><span id="local-6989586621687979731"><span id="local-6989586621687979733"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckTablePermission"><span class="hs-identifier hs-type">resolveCheckTablePermission</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadWriter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectItem"><span class="hs-identifier hs-type">CollectItem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687979730"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-174"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979731"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CheckPermission"><span class="hs-identifier hs-type">CheckPermission</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979733"><span class="hs-identifier hs-type">perm</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#RolePermInfo"><span class="hs-identifier hs-type">RolePermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979731"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#RolePermInfo"><span class="hs-identifier hs-type">RolePermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979731"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621687979733"><span class="hs-identifier hs-type">perm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979731"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermType"><span class="hs-identifier hs-type">PermType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><a href="#local-6989586621687979730"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621687979733"><span class="hs-identifier hs-type">perm</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-184"></span><span id="resolveCheckTablePermission"><span class="annot"><span class="annottext">resolveCheckTablePermission :: forall (m :: * -&gt; *) (b :: BackendType) perm.
(MonadWriter (Seq CollectItem) m, BackendMetadata b) =&gt;
CheckPermission perm
-&gt; Maybe (RolePermInfo b)
-&gt; (RolePermInfo b -&gt; Maybe perm)
-&gt; RoleName
-&gt; SourceName
-&gt; TableName b
-&gt; PermType
-&gt; m (Maybe perm)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckTablePermission"><span class="hs-identifier hs-var hs-var">resolveCheckTablePermission</span></a></span></span><span> </span><span id="local-6989586621687980208"><span class="annot"><span class="annottext">CheckPermission perm
</span><a href="#local-6989586621687980208"><span class="hs-identifier hs-var">inheritedRolePermission</span></a></span></span><span> </span><span id="local-6989586621687980209"><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621687980209"><span class="hs-identifier hs-var">accumulatedRolePermInfo</span></a></span></span><span> </span><span id="local-6989586621687980210"><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe perm
</span><a href="#local-6989586621687980210"><span class="hs-identifier hs-var">permAcc</span></a></span></span><span> </span><span id="local-6989586621687980211"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980211"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621687980212"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980212"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621687980213"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980213"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621687980214"><span class="annot"><span class="annottext">PermType
</span><a href="#local-6989586621687980214"><span class="hs-identifier hs-var">permType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-comment">-- when for a given entity and role, a permission exists in the metadata, we override the metadata permission</span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-comment">-- over the inherited permission</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980215"><span class="annot"><span class="annottext">checkPermission :: CheckPermission perm
</span><a href="#local-6989586621687980215"><span class="hs-identifier hs-var hs-var">checkPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckPermission perm
-&gt; (perm -&gt; CheckPermission perm)
-&gt; Maybe perm
-&gt; CheckPermission perm
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">CheckPermission perm
</span><a href="#local-6989586621687980208"><span class="hs-identifier hs-var">inheritedRolePermission</span></a></span><span> </span><span class="annot"><span class="annottext">perm -&gt; CheckPermission perm
forall permissionType.
permissionType -&gt; CheckPermission permissionType
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPDefined"><span class="hs-identifier hs-var">CPDefined</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe perm
</span><a href="#local-6989586621687980210"><span class="hs-identifier hs-var">permAcc</span></a></span><span> </span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; Maybe perm)
-&gt; Maybe (RolePermInfo b) -&gt; Maybe perm
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621687980209"><span class="hs-identifier hs-var">accumulatedRolePermInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>      </span><span id="local-6989586621687980218"><span class="annot"><span class="annottext">inconsistentRoleEntity :: InconsistentRoleEntity
</span><a href="#local-6989586621687980218"><span class="hs-identifier hs-var hs-var">inconsistentRoleEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Text -&gt; PermType -&gt; InconsistentRoleEntity
</span><a href="Hasura.RQL.Types.Metadata.Object.html#InconsistentTablePermission"><span class="hs-identifier hs-var">InconsistentTablePermission</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980212"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName b -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980213"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="#local-6989586621687980214"><span class="hs-identifier hs-var">permType</span></a></span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="annottext">CheckPermission perm
-&gt; RoleName -&gt; InconsistentRoleEntity -&gt; m (Maybe perm)
forall (m :: * -&gt; *) p.
MonadWriter (Seq CollectItem) m =&gt;
CheckPermission p
-&gt; RoleName -&gt; InconsistentRoleEntity -&gt; m (Maybe p)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier hs-var">resolveCheckPermission</span></a></span><span> </span><span class="annot"><span class="annottext">CheckPermission perm
</span><a href="#local-6989586621687980215"><span class="hs-identifier hs-var">checkPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980211"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">InconsistentRoleEntity
</span><a href="#local-6989586621687980218"><span class="hs-identifier hs-var">inconsistentRoleEntity</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-keyword">data</span><span> </span><span id="SelectPermissionSource"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#SelectPermissionSource"><span class="hs-identifier hs-var">SelectPermissionSource</span></a></span></span><span> </span><span id="local-6989586621687979897"><span class="annot"><a href="#local-6989586621687979897"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SPSTable"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#SPSTable"><span class="hs-identifier hs-var">SPSTable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979897"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="SPSLogicalModel"><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#SPSLogicalModel"><span class="hs-identifier hs-var">SPSLogicalModel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LogicalModelLocation"><span class="hs-identifier hs-type">LogicalModelLocation</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621687979753"><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979753"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#ToTxt"><span class="hs-identifier hs-type">ToTxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#SelectPermissionSource"><span class="hs-identifier hs-type">SelectPermissionSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979753"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-196"></span><span>  </span><span id="local-6989586621687980236"><span class="annot"><span class="annottext">toTxt :: SelectPermissionSource b -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var hs-var hs-var hs-var">toTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#SPSTable"><span class="hs-identifier hs-type">SPSTable</span></a></span><span> </span><span id="local-6989586621687980237"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980237"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;table &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; TableName b -&gt; Text
forall t. ToTxt t =&gt; Text -&gt; t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3E%3E"><span class="hs-operator hs-var">&lt;&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980237"><span class="hs-identifier hs-var">tableName</span></a></span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#SPSLogicalModel"><span class="hs-identifier hs-type">SPSLogicalModel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LMLLogicalModel"><span class="hs-identifier hs-type">LMLLogicalModel</span></a></span><span> </span><span id="local-6989586621687980240"><span class="annot"><span class="annottext">LogicalModelName
</span><a href="#local-6989586621687980240"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;logical model &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LogicalModelName -&gt; Text
forall t. ToTxt t =&gt; Text -&gt; t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3E%3E"><span class="hs-operator hs-var">&lt;&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LogicalModelName
</span><a href="#local-6989586621687980240"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#SPSLogicalModel"><span class="hs-identifier hs-type">SPSLogicalModel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LMLNativeQuery"><span class="hs-identifier hs-type">LMLNativeQuery</span></a></span><span> </span><span id="local-6989586621687980242"><span class="annot"><span class="annottext">NativeQueryName
</span><a href="#local-6989586621687980242"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;native query &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; NativeQueryName -&gt; Text
forall t. ToTxt t =&gt; Text -&gt; t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3E%3E"><span class="hs-operator hs-var">&lt;&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">NativeQueryName
</span><a href="#local-6989586621687980242"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveSelectPermission"><span class="hs-identifier hs-type">resolveSelectPermission</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687979759"><span class="annot"><a href="#local-6989586621687979759"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621687979758"><span class="annot"><a href="#local-6989586621687979758"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadWriter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectItem"><span class="hs-identifier hs-type">CollectItem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687979758"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979759"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979759"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#SelectPermissionSource"><span class="hs-identifier hs-type">SelectPermissionSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979759"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#CombinedSelPermInfo"><span class="hs-identifier hs-type">CombinedSelPermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979759"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-211"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#SelPermInfo"><span class="hs-identifier hs-type">SelPermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979759"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="#local-6989586621687979758"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#SelPermInfo"><span class="hs-identifier hs-type">SelPermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979759"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span id="resolveSelectPermission"><span class="annot"><span class="annottext">resolveSelectPermission :: forall (b :: BackendType) (m :: * -&gt; *).
(MonadWriter (Seq CollectItem) m, BackendMetadata b) =&gt;
SourceName
-&gt; SourceConfig b
-&gt; SelectPermissionSource b
-&gt; Role
-&gt; Maybe (CombinedSelPermInfo b)
-&gt; Int
-&gt; Maybe (SelPermInfo b)
-&gt; m (Maybe (SelPermInfo b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveSelectPermission"><span class="hs-identifier hs-var hs-var">resolveSelectPermission</span></a></span></span><span> </span><span id="local-6989586621687980318"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980318"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621687980319"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687980319"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687980320"><span class="annot"><span class="annottext">SelectPermissionSource b
</span><a href="#local-6989586621687980320"><span class="hs-identifier hs-var">selectPermissionSource</span></a></span></span><span> </span><span id="local-6989586621687980321"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621687980321"><span class="hs-keyword hs-var">role</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span id="local-6989586621687980322"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980322"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#ParentRoles"><span class="hs-identifier hs-type">ParentRoles</span></a></span><span> </span><span id="local-6989586621687980323"><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621687980323"><span class="hs-identifier hs-var">parentRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621687980324"><span class="annot"><span class="annottext">Maybe (CombinedSelPermInfo b)
</span><a href="#local-6989586621687980324"><span class="hs-identifier hs-var">combinedParentRoleSelPermInfo</span></a></span></span><span> </span><span id="local-6989586621687980325"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687980325"><span class="hs-identifier hs-var">selectPermissionsCount</span></a></span></span><span> </span><span id="local-6989586621687980326"><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980326"><span class="hs-identifier hs-var">explicitSelectPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeT m (SelPermInfo b) -&gt; m (Maybe (SelPermInfo b))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="annot"><span class="annottext">(MaybeT m (SelPermInfo b) -&gt; m (Maybe (SelPermInfo b)))
-&gt; MaybeT m (SelPermInfo b) -&gt; m (Maybe (SelPermInfo b))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-comment">-- Prefer the explicitly defined select permissions over the inherited ones, if they exist</span><span>
</span><span id="line-216"></span><span>  </span><span id="local-6989586621687980328"><span class="annot"><span class="annottext">SelPermInfo b
</span><a href="#local-6989586621687980328"><span class="hs-identifier hs-var">selPermInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b) -&gt; MaybeT m (SelPermInfo b)
forall (m :: * -&gt; *) b. Applicative m =&gt; Maybe b -&gt; MaybeT m b
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#hoistMaybe"><span class="hs-identifier hs-var">hoistMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (SelPermInfo b) -&gt; MaybeT m (SelPermInfo b))
-&gt; Maybe (SelPermInfo b) -&gt; MaybeT m (SelPermInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980326"><span class="hs-identifier hs-var">explicitSelectPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
-&gt; Maybe (SelPermInfo b) -&gt; Maybe (SelPermInfo b)
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980331"><span class="hs-identifier hs-var">computedInheritedSelPermInfo</span></a></span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621687980332"><span class="hs-identifier hs-var">supportsRedaction</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">(AnnRedactionExp b (PartialSQLExp b) -&gt; Bool)
-&gt; HashMap (Column b) (AnnRedactionExp b (PartialSQLExp b)) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnnRedactionExp b (PartialSQLExp b)
-&gt; AnnRedactionExp b (PartialSQLExp b) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">AnnRedactionExp b (PartialSQLExp b)
forall (b :: BackendType) v. AnnRedactionExp b v
</span><a href="Hasura.RQL.IR.BoolExp.html#NoRedaction"><span class="hs-identifier hs-var">NoRedaction</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SelPermInfo b
-&gt; HashMap (Column b) (AnnRedactionExp b (PartialSQLExp b))
forall (b :: BackendType).
SelPermInfo b -&gt; HashMap (Column b) (AnnRedactionExpPartialSQL b)
</span><a href="Hasura.Table.Cache.html#spiCols"><span class="hs-identifier hs-var">spiCols</span></a></span><span> </span><span class="annot"><span class="annottext">SelPermInfo b
</span><a href="#local-6989586621687980328"><span class="hs-identifier hs-var">selPermInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SelPermInfo b -&gt; MaybeT m (SelPermInfo b)
forall a. a -&gt; MaybeT m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SelPermInfo b
</span><a href="#local-6989586621687980328"><span class="hs-identifier hs-var">selPermInfo</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>      </span><span class="annot"><span class="annottext">Maybe Value -&gt; MetadataObject -&gt; Text -&gt; MaybeT m ()
forall (m :: * -&gt; *).
MonadWriter (Seq CollectItem) m =&gt;
Maybe Value -&gt; MetadataObject -&gt; Text -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordInconsistencyM"><span class="hs-identifier hs-var">recordInconsistencyM</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621687980338"><span class="hs-identifier hs-var">errMetadataObj</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687980339"><span class="hs-identifier hs-var">errReason</span></a></span><span>
</span><span id="line-221"></span><span>      </span><span class="annot"><span class="annottext">MaybeT m (SelPermInfo b)
forall a. MaybeT m a
forall (m :: * -&gt; *) a. MonadPlus m =&gt; m a
</span><span class="hs-identifier hs-var">mzero</span></span><span> </span><span class="hs-comment">-- Return no select permissions (ie. no select access)</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><a href="#local-6989586621687980332"><span class="hs-identifier hs-type">supportsRedaction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-224"></span><span>    </span><span id="local-6989586621687980332"><span class="annot"><span class="annottext">supportsRedaction :: Bool
</span><a href="#local-6989586621687980332"><span class="hs-identifier hs-var hs-var">supportsRedaction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
HasSourceConfiguration b =&gt;
SourceConfig b -&gt; Bool
</span><a href="Hasura.RQL.Types.SourceConfiguration.html#sourceSupportsColumnRedaction"><span class="hs-identifier hs-var">sourceSupportsColumnRedaction</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687979759"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687980319"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>    </span><span class="annot"><a href="#local-6989586621687980331"><span class="hs-identifier hs-type">computedInheritedSelPermInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#SelPermInfo"><span class="hs-identifier hs-type">SelPermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979759"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621687980331"><span class="annot"><span class="annottext">computedInheritedSelPermInfo :: Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980331"><span class="hs-identifier hs-var hs-var">computedInheritedSelPermInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CombinedSelPermInfo b -&gt; SelPermInfo b
forall (b :: BackendType).
Backend b =&gt;
Int -&gt; CombinedSelPermInfo b -&gt; SelPermInfo b
</span><a href="Hasura.Table.Cache.html#combinedSelPermInfoToSelPermInfo"><span class="hs-identifier hs-var">combinedSelPermInfoToSelPermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687980325"><span class="hs-identifier hs-var">selectPermissionsCount</span></a></span><span> </span><span class="annot"><span class="annottext">(CombinedSelPermInfo b -&gt; SelPermInfo b)
-&gt; Maybe (CombinedSelPermInfo b) -&gt; Maybe (SelPermInfo b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (CombinedSelPermInfo b)
</span><a href="#local-6989586621687980324"><span class="hs-identifier hs-var">combinedParentRoleSelPermInfo</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><a href="#local-6989586621687980338"><span class="hs-identifier hs-type">errMetadataObj</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621687980338"><span class="annot"><span class="annottext">errMetadataObj :: MetadataObject
</span><a href="#local-6989586621687980338"><span class="hs-identifier hs-var hs-var">errMetadataObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOInheritedRole"><span class="hs-identifier hs-var">MOInheritedRole</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980322"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621687980321"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><a href="#local-6989586621687980339"><span class="hs-identifier hs-type">errReason</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-d0f6d61f5277bae932134563876cbceb4967915f364959864c72abbc2978d8ed/share/doc/html/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621687980339"><span class="annot"><span class="annottext">errReason :: Text
</span><a href="#local-6989586621687980339"><span class="hs-identifier hs-var hs-var">errReason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-234"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;The source &quot;</span></span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980318"><span class="hs-identifier hs-var">sourceName</span></a></span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><span class="annottext">SourceName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; does not support inherited roles where the columns allowed are different in the column select permissions in the parent roles. This occurs for the column select permissions defined for the &quot;</span></span><span>
</span><span id="line-237"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SelectPermissionSource b -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">SelectPermissionSource b
</span><a href="#local-6989586621687980320"><span class="hs-identifier hs-var">selectPermissionSource</span></a></span><span>
</span><span id="line-238"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; for the inherited role &quot;</span></span><span>
</span><span id="line-239"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980322"><span class="hs-identifier hs-var">roleName</span></a></span><span>
</span><span id="line-240"></span><span>        </span><span class="annot"><span class="annottext">RoleName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;, which combines the roles &quot;</span></span><span>
</span><span id="line-241"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#dquote"><span class="hs-identifier hs-var">dquote</span></a></span><span> </span><span class="annot"><span class="annottext">(RoleName -&gt; Text) -&gt; [RoleName] -&gt; [Text]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall a. HashSet a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621687980323"><span class="hs-identifier hs-var">parentRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildTablePermissions"><span class="hs-identifier hs-type">buildTablePermissions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687979831"><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621687979830"><span class="annot"><a href="#local-6989586621687979830"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979830"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadWriter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectItem"><span class="hs-identifier hs-type">CollectItem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687979830"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#GetAggregationPredicatesDeps"><span class="hs-identifier hs-type">GetAggregationPredicatesDeps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><a href="Hasura.Table.Cache.html#TableCoreCache"><span class="hs-identifier hs-type">TableCoreCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><a href="Hasura.Table.Cache.html#FieldInfoMap"><span class="hs-identifier hs-type">FieldInfoMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#FieldInfo"><span class="hs-identifier hs-type">FieldInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#TablePermissionInputs"><span class="hs-identifier hs-type">TablePermissionInputs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LogicalModelName"><span class="hs-identifier hs-type">LogicalModelName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.LogicalModel.Metadata.html#LogicalModelMetadata"><span class="hs-identifier hs-type">LogicalModelMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><a href="#local-6989586621687979830"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#RolePermInfoMap"><span class="hs-identifier hs-type">RolePermInfoMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span id="buildTablePermissions"><span class="annot"><span class="annottext">buildTablePermissions :: forall (b :: BackendType) (m :: * -&gt; *).
(MonadError QErr m, MonadWriter (Seq CollectItem) m,
 BackendMetadata b, GetAggregationPredicatesDeps b) =&gt;
Environment
-&gt; SourceName
-&gt; SourceConfig b
-&gt; TableCoreCache b
-&gt; TableName b
-&gt; FieldInfoMap (FieldInfo b)
-&gt; TablePermissionInputs b
-&gt; OrderedRoles
-&gt; HashMap LogicalModelName (LogicalModelMetadata b)
-&gt; m (RolePermInfoMap b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildTablePermissions"><span class="hs-identifier hs-var hs-var">buildTablePermissions</span></a></span></span><span> </span><span id="local-6989586621687980452"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621687980452"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621687980453"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980453"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621687980454"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687980454"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687980455"><span class="annot"><span class="annottext">TableCoreCache b
</span><a href="#local-6989586621687980455"><span class="hs-identifier hs-var">tableCache</span></a></span></span><span> </span><span id="local-6989586621687980456"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980456"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621687980457"><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621687980457"><span class="hs-identifier hs-var">tableFields</span></a></span></span><span> </span><span id="local-6989586621687980458"><span class="annot"><span class="annottext">TablePermissionInputs b
</span><a href="#local-6989586621687980458"><span class="hs-identifier hs-var">tablePermissions</span></a></span></span><span> </span><span id="local-6989586621687980459"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621687980459"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span> </span><span id="local-6989586621687980460"><span class="annot"><span class="annottext">HashMap LogicalModelName (LogicalModelMetadata b)
</span><a href="#local-6989586621687980460"><span class="hs-identifier hs-var">logicalModels</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980461"><span class="annot"><span class="annottext">alignedPermissions :: HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980461"><span class="hs-identifier hs-var hs-var">alignedPermissions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TablePermissionInputs b
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980462"><span class="hs-identifier hs-var">alignPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">TablePermissionInputs b
</span><a href="#local-6989586621687980458"><span class="hs-identifier hs-var">tablePermissions</span></a></span><span>
</span><span id="line-262"></span><span>      </span><span id="local-6989586621687980463"><span class="annot"><span class="annottext">go :: RolePermInfoMap b -&gt; Role -&gt; m (RolePermInfoMap b)
</span><a href="#local-6989586621687980463"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621687980464"><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980464"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span></span><span> </span><span id="local-6989586621687980465"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621687980465"><span class="hs-keyword hs-var">role</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span id="local-6989586621687980466"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980466"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#ParentRoles"><span class="hs-identifier hs-type">ParentRoles</span></a></span><span> </span><span id="local-6989586621687980467"><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621687980467"><span class="hs-identifier hs-var">parentRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>        </span><span id="local-6989586621687980468"><span class="annot"><span class="annottext">[RolePermInfo b]
</span><a href="#local-6989586621687980468"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-264"></span><span>          </span><span class="annot"><span class="annottext">[RoleName]
-&gt; (RoleName -&gt; m (RolePermInfo b)) -&gt; m [RolePermInfo b]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall a. HashSet a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621687980467"><span class="hs-identifier hs-var">parentRoles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RoleName -&gt; m (RolePermInfo b)) -&gt; m [RolePermInfo b])
-&gt; (RoleName -&gt; m (RolePermInfo b)) -&gt; m [RolePermInfo b]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687980470"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980470"><span class="hs-identifier hs-var">parentRoleName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-265"></span><span>            </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b) -&gt; m (RolePermInfo b) -&gt; m (RolePermInfo b)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName -&gt; RolePermInfoMap b -&gt; Maybe (RolePermInfo b)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980470"><span class="hs-identifier hs-var">parentRoleName</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980464"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>              </span><span class="hs-comment">-- this error will ideally never be thrown, but if it's thrown then</span><span>
</span><span id="line-267"></span><span>              </span><span class="hs-comment">-- it's possible that the permissions for the role do exist, but it's</span><span>
</span><span id="line-268"></span><span>              </span><span class="hs-comment">-- not yet built due to wrong ordering of the roles, check `orderRoles`</span><span>
</span><span id="line-269"></span><span>              </span><span class="annot"><span class="annottext">(m (RolePermInfo b) -&gt; m (RolePermInfo b))
-&gt; m (RolePermInfo b) -&gt; m (RolePermInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; m (RolePermInfo b)
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;buildTablePermissions: table role permissions for role: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980470"><span class="hs-identifier hs-var">parentRoleName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; not found&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980473"><span class="annot"><span class="annottext">combinedParentRolePermInfo :: CombineRolePermInfo b
</span><a href="#local-6989586621687980473"><span class="hs-identifier hs-var hs-var">combinedParentRolePermInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CombineRolePermInfo b] -&gt; CombineRolePermInfo b
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([CombineRolePermInfo b] -&gt; CombineRolePermInfo b)
-&gt; [CombineRolePermInfo b] -&gt; CombineRolePermInfo b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; CombineRolePermInfo b)
-&gt; [RolePermInfo b] -&gt; [CombineRolePermInfo b]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; CombineRolePermInfo b
forall (b :: BackendType). RolePermInfo b -&gt; CombineRolePermInfo b
</span><a href="Hasura.RQL.Types.Roles.Internal.html#rolePermInfoToCombineRolePermInfo"><span class="hs-identifier hs-var">rolePermInfoToCombineRolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[RolePermInfo b]
</span><a href="#local-6989586621687980468"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span><span>
</span><span id="line-272"></span><span>            </span><span id="local-6989586621687980474"><span class="annot"><span class="annottext">selectPermissionsCount :: Int
</span><a href="#local-6989586621687980474"><span class="hs-identifier hs-var hs-var">selectPermissionsCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RolePermInfo b] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([RolePermInfo b] -&gt; Int) -&gt; [RolePermInfo b] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; Bool) -&gt; [RolePermInfo b] -&gt; [RolePermInfo b]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (SelPermInfo b) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (SelPermInfo b) -&gt; Bool)
-&gt; (RolePermInfo b -&gt; Maybe (SelPermInfo b))
-&gt; RolePermInfo b
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (SelPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (SelPermInfo b)
</span><a href="Hasura.Table.Cache.html#_permSel"><span class="hs-identifier hs-var">_permSel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[RolePermInfo b]
</span><a href="#local-6989586621687980468"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span><span>
</span><span id="line-273"></span><span>            </span><span id="local-6989586621687980478"><span class="annot"><span class="annottext">accumulatedRolePermission :: Maybe (RolePermInfo b)
</span><a href="#local-6989586621687980478"><span class="hs-identifier hs-var hs-var">accumulatedRolePermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RolePermInfoMap b -&gt; Maybe (RolePermInfo b)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980466"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980464"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span>        </span><span id="local-6989586621687980479"><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980479"><span class="hs-identifier hs-var">roleSelectPermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; SourceConfig b
-&gt; SelectPermissionSource b
-&gt; Role
-&gt; Maybe (CombinedSelPermInfo b)
-&gt; Int
-&gt; Maybe (SelPermInfo b)
-&gt; m (Maybe (SelPermInfo b))
forall (b :: BackendType) (m :: * -&gt; *).
(MonadWriter (Seq CollectItem) m, BackendMetadata b) =&gt;
SourceName
-&gt; SourceConfig b
-&gt; SelectPermissionSource b
-&gt; Role
-&gt; Maybe (CombinedSelPermInfo b)
-&gt; Int
-&gt; Maybe (SelPermInfo b)
-&gt; m (Maybe (SelPermInfo b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveSelectPermission"><span class="hs-identifier hs-var">resolveSelectPermission</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980453"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687980454"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName b -&gt; SelectPermissionSource b
forall (b :: BackendType). TableName b -&gt; SelectPermissionSource b
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#SPSTable"><span class="hs-identifier hs-var">SPSTable</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980456"><span class="hs-identifier hs-var">tableName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621687980465"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CombineRolePermInfo b -&gt; Maybe (CombinedSelPermInfo b)
forall (b :: BackendType).
CombineRolePermInfo b -&gt; Maybe (CombinedSelPermInfo b)
</span><a href="Hasura.RQL.Types.Roles.Internal.html#crpiSelPerm"><span class="hs-identifier hs-var">crpiSelPerm</span></a></span><span> </span><span class="annot"><span class="annottext">CombineRolePermInfo b
</span><a href="#local-6989586621687980473"><span class="hs-identifier hs-var">combinedParentRolePermInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687980474"><span class="hs-identifier hs-var">selectPermissionsCount</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (SelPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (SelPermInfo b)
</span><a href="Hasura.Table.Cache.html#_permSel"><span class="hs-identifier hs-var">_permSel</span></a></span><span> </span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; Maybe (SelPermInfo b))
-&gt; Maybe (RolePermInfo b) -&gt; Maybe (SelPermInfo b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621687980478"><span class="hs-identifier hs-var">accumulatedRolePermission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>        </span><span id="local-6989586621687980481"><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
</span><a href="#local-6989586621687980481"><span class="hs-identifier hs-var">roleInsertPermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CheckPermission (InsPermInfo b)
-&gt; Maybe (RolePermInfo b)
-&gt; (RolePermInfo b -&gt; Maybe (InsPermInfo b))
-&gt; RoleName
-&gt; SourceName
-&gt; TableName b
-&gt; PermType
-&gt; m (Maybe (InsPermInfo b))
forall (m :: * -&gt; *) (b :: BackendType) perm.
(MonadWriter (Seq CollectItem) m, BackendMetadata b) =&gt;
CheckPermission perm
-&gt; Maybe (RolePermInfo b)
-&gt; (RolePermInfo b -&gt; Maybe perm)
-&gt; RoleName
-&gt; SourceName
-&gt; TableName b
-&gt; PermType
-&gt; m (Maybe perm)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckTablePermission"><span class="hs-identifier hs-var">resolveCheckTablePermission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CombineRolePermInfo b -&gt; CheckPermission (InsPermInfo b)
forall (b :: BackendType).
CombineRolePermInfo b -&gt; CheckPermission (InsPermInfo b)
</span><a href="Hasura.RQL.Types.Roles.Internal.html#crpiInsPerm"><span class="hs-identifier hs-var">crpiInsPerm</span></a></span><span> </span><span class="annot"><span class="annottext">CombineRolePermInfo b
</span><a href="#local-6989586621687980473"><span class="hs-identifier hs-var">combinedParentRolePermInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621687980478"><span class="hs-identifier hs-var">accumulatedRolePermission</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (InsPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (InsPermInfo b)
</span><a href="Hasura.Table.Cache.html#_permIns"><span class="hs-identifier hs-var">_permIns</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980466"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980453"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980484"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="Hasura.RQL.Types.Permission.html#PTInsert"><span class="hs-identifier hs-var">PTInsert</span></a></span><span>
</span><span id="line-277"></span><span>        </span><span id="local-6989586621687980486"><span class="annot"><span class="annottext">Maybe (UpdPermInfo b)
</span><a href="#local-6989586621687980486"><span class="hs-identifier hs-var">roleUpdatePermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CheckPermission (UpdPermInfo b)
-&gt; Maybe (RolePermInfo b)
-&gt; (RolePermInfo b -&gt; Maybe (UpdPermInfo b))
-&gt; RoleName
-&gt; SourceName
-&gt; TableName b
-&gt; PermType
-&gt; m (Maybe (UpdPermInfo b))
forall (m :: * -&gt; *) (b :: BackendType) perm.
(MonadWriter (Seq CollectItem) m, BackendMetadata b) =&gt;
CheckPermission perm
-&gt; Maybe (RolePermInfo b)
-&gt; (RolePermInfo b -&gt; Maybe perm)
-&gt; RoleName
-&gt; SourceName
-&gt; TableName b
-&gt; PermType
-&gt; m (Maybe perm)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckTablePermission"><span class="hs-identifier hs-var">resolveCheckTablePermission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CombineRolePermInfo b -&gt; CheckPermission (UpdPermInfo b)
forall (b :: BackendType).
CombineRolePermInfo b -&gt; CheckPermission (UpdPermInfo b)
</span><a href="Hasura.RQL.Types.Roles.Internal.html#crpiUpdPerm"><span class="hs-identifier hs-var">crpiUpdPerm</span></a></span><span> </span><span class="annot"><span class="annottext">CombineRolePermInfo b
</span><a href="#local-6989586621687980473"><span class="hs-identifier hs-var">combinedParentRolePermInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621687980478"><span class="hs-identifier hs-var">accumulatedRolePermission</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (UpdPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (UpdPermInfo b)
</span><a href="Hasura.Table.Cache.html#_permUpd"><span class="hs-identifier hs-var">_permUpd</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980466"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980453"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980484"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="Hasura.RQL.Types.Permission.html#PTUpdate"><span class="hs-identifier hs-var">PTUpdate</span></a></span><span>
</span><span id="line-278"></span><span>        </span><span id="local-6989586621687980490"><span class="annot"><span class="annottext">Maybe (DelPermInfo b)
</span><a href="#local-6989586621687980490"><span class="hs-identifier hs-var">roleDeletePermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CheckPermission (DelPermInfo b)
-&gt; Maybe (RolePermInfo b)
-&gt; (RolePermInfo b -&gt; Maybe (DelPermInfo b))
-&gt; RoleName
-&gt; SourceName
-&gt; TableName b
-&gt; PermType
-&gt; m (Maybe (DelPermInfo b))
forall (m :: * -&gt; *) (b :: BackendType) perm.
(MonadWriter (Seq CollectItem) m, BackendMetadata b) =&gt;
CheckPermission perm
-&gt; Maybe (RolePermInfo b)
-&gt; (RolePermInfo b -&gt; Maybe perm)
-&gt; RoleName
-&gt; SourceName
-&gt; TableName b
-&gt; PermType
-&gt; m (Maybe perm)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckTablePermission"><span class="hs-identifier hs-var">resolveCheckTablePermission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CombineRolePermInfo b -&gt; CheckPermission (DelPermInfo b)
forall (b :: BackendType).
CombineRolePermInfo b -&gt; CheckPermission (DelPermInfo b)
</span><a href="Hasura.RQL.Types.Roles.Internal.html#crpiDelPerm"><span class="hs-identifier hs-var">crpiDelPerm</span></a></span><span> </span><span class="annot"><span class="annottext">CombineRolePermInfo b
</span><a href="#local-6989586621687980473"><span class="hs-identifier hs-var">combinedParentRolePermInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621687980478"><span class="hs-identifier hs-var">accumulatedRolePermission</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (DelPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (DelPermInfo b)
</span><a href="Hasura.Table.Cache.html#_permDel"><span class="hs-identifier hs-var">_permDel</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980466"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980453"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980484"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="Hasura.RQL.Types.Permission.html#PTDelete"><span class="hs-identifier hs-var">PTDelete</span></a></span><span>
</span><span id="line-279"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980494"><span class="annot"><span class="annottext">rolePermInfo :: RolePermInfo b
</span><a href="#local-6989586621687980494"><span class="hs-identifier hs-var hs-var">rolePermInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
forall (b :: BackendType).
Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
</span><a href="Hasura.Table.Cache.html#RolePermInfo"><span class="hs-identifier hs-var">RolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
</span><a href="#local-6989586621687980481"><span class="hs-identifier hs-var">roleInsertPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980479"><span class="hs-identifier hs-var">roleSelectPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UpdPermInfo b)
</span><a href="#local-6989586621687980486"><span class="hs-identifier hs-var">roleUpdatePermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DelPermInfo b)
</span><a href="#local-6989586621687980490"><span class="hs-identifier hs-var">roleDeletePermission</span></a></span><span>
</span><span id="line-280"></span><span>        </span><span class="annot"><span class="annottext">RolePermInfoMap b -&gt; m (RolePermInfoMap b)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RolePermInfoMap b -&gt; m (RolePermInfoMap b))
-&gt; RolePermInfoMap b -&gt; m (RolePermInfoMap b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RoleName
-&gt; RolePermInfo b -&gt; RolePermInfoMap b -&gt; RolePermInfoMap b
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.Strict.html#insert"><span class="hs-identifier hs-var">HashMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980466"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b
</span><a href="#local-6989586621687980494"><span class="hs-identifier hs-var">rolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980464"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>  </span><span id="local-6989586621687980496"><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980496"><span class="hs-identifier hs-var">metadataRolePermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-283"></span><span>    </span><span class="annot"><span class="annottext">HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
-&gt; ((Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
     Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
    -&gt; m (RolePermInfo b))
-&gt; m (RolePermInfoMap b)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980461"><span class="hs-identifier hs-var">alignedPermissions</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687980497"><span class="annot"><span class="annottext">Maybe (PermDef b InsPerm)
</span><a href="#local-6989586621687980497"><span class="hs-identifier hs-var">insertPermission</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980498"><span class="annot"><span class="annottext">Maybe (PermDef b SelPerm)
</span><a href="#local-6989586621687980498"><span class="hs-identifier hs-var">selectPermission</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980499"><span class="annot"><span class="annottext">Maybe (PermDef b UpdPerm)
</span><a href="#local-6989586621687980499"><span class="hs-identifier hs-var">updatePermission</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980500"><span class="annot"><span class="annottext">Maybe (PermDef b DelPerm)
</span><a href="#local-6989586621687980500"><span class="hs-identifier hs-var">deletePermission</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-284"></span><span>      </span><span id="local-6989586621687980501"><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
</span><a href="#local-6989586621687980501"><span class="hs-identifier hs-var">insert</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b InsPerm) -&gt; m (Maybe (PermInfo InsPerm b))
forall (a :: BackendType -&gt; *).
Maybe (PermDef b a) -&gt; m (Maybe (PermInfo a b))
</span><a href="#local-6989586621687980502"><span class="hs-identifier hs-var">buildPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b InsPerm)
</span><a href="#local-6989586621687980497"><span class="hs-identifier hs-var">insertPermission</span></a></span><span>
</span><span id="line-285"></span><span>      </span><span id="local-6989586621687980503"><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980503"><span class="hs-identifier hs-var">select</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b SelPerm) -&gt; m (Maybe (PermInfo SelPerm b))
forall (a :: BackendType -&gt; *).
Maybe (PermDef b a) -&gt; m (Maybe (PermInfo a b))
</span><a href="#local-6989586621687980502"><span class="hs-identifier hs-var">buildPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b SelPerm)
</span><a href="#local-6989586621687980498"><span class="hs-identifier hs-var">selectPermission</span></a></span><span>
</span><span id="line-286"></span><span>      </span><span id="local-6989586621687980504"><span class="annot"><span class="annottext">Maybe (UpdPermInfo b)
</span><a href="#local-6989586621687980504"><span class="hs-identifier hs-var">update</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b UpdPerm) -&gt; m (Maybe (PermInfo UpdPerm b))
forall (a :: BackendType -&gt; *).
Maybe (PermDef b a) -&gt; m (Maybe (PermInfo a b))
</span><a href="#local-6989586621687980502"><span class="hs-identifier hs-var">buildPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b UpdPerm)
</span><a href="#local-6989586621687980499"><span class="hs-identifier hs-var">updatePermission</span></a></span><span>
</span><span id="line-287"></span><span>      </span><span id="local-6989586621687980505"><span class="annot"><span class="annottext">Maybe (DelPermInfo b)
</span><a href="#local-6989586621687980505"><span class="hs-identifier hs-var">delete</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b DelPerm) -&gt; m (Maybe (PermInfo DelPerm b))
forall (a :: BackendType -&gt; *).
Maybe (PermDef b a) -&gt; m (Maybe (PermInfo a b))
</span><a href="#local-6989586621687980502"><span class="hs-identifier hs-var">buildPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b DelPerm)
</span><a href="#local-6989586621687980500"><span class="hs-identifier hs-var">deletePermission</span></a></span><span>
</span><span id="line-288"></span><span>      </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; m (RolePermInfo b)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; m (RolePermInfo b))
-&gt; RolePermInfo b -&gt; m (RolePermInfo b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
forall (b :: BackendType).
Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
</span><a href="Hasura.Table.Cache.html#RolePermInfo"><span class="hs-identifier hs-var">RolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
</span><a href="#local-6989586621687980501"><span class="hs-identifier hs-var">insert</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980503"><span class="hs-identifier hs-var">select</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UpdPermInfo b)
</span><a href="#local-6989586621687980504"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DelPermInfo b)
</span><a href="#local-6989586621687980505"><span class="hs-identifier hs-var">delete</span></a></span><span>
</span><span id="line-289"></span><span>  </span><span class="annot"><span class="annottext">(RolePermInfoMap b -&gt; Role -&gt; m (RolePermInfoMap b))
-&gt; RolePermInfoMap b -&gt; [Role] -&gt; m (RolePermInfoMap b)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldlM</span></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b -&gt; Role -&gt; m (RolePermInfoMap b)
</span><a href="#local-6989586621687980463"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980496"><span class="hs-identifier hs-var">metadataRolePermissions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var">_unOrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621687980459"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-291"></span><span>    </span><span id="local-6989586621687980484"><span class="annot"><span class="annottext">table :: TableName b
</span><a href="#local-6989586621687980484"><span class="hs-identifier hs-var hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TablePermissionInputs b -&gt; TableName b
forall (b :: BackendType). TablePermissionInputs b -&gt; TableName b
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_tpiTable"><span class="hs-identifier hs-var">_tpiTable</span></a></span><span> </span><span class="annot"><span class="annottext">TablePermissionInputs b
</span><a href="#local-6989586621687980458"><span class="hs-identifier hs-var">tablePermissions</span></a></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>    </span><span id="local-6989586621687979913"><span class="annot"><a href="#local-6989586621687980508"><span class="hs-identifier hs-type">mkMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermDef"><span class="hs-identifier hs-type">PermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979913"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermDef"><span class="hs-identifier hs-type">PermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979913"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-294"></span><span>    </span><span id="local-6989586621687980508"><span class="annot"><span class="annottext">mkMap :: forall (e :: BackendType -&gt; *).
[PermDef b e] -&gt; HashMap RoleName (PermDef b e)
</span><a href="#local-6989586621687980508"><span class="hs-identifier hs-var hs-var">mkMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PermDef b e -&gt; RoleName)
-&gt; [PermDef b e] -&gt; HashMap RoleName (PermDef b e)
forall k a. Hashable k =&gt; (a -&gt; k) -&gt; [a] -&gt; HashMap k a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#mapFromL"><span class="hs-identifier hs-var">mapFromL</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef b e -&gt; RoleName
forall (b :: BackendType) (perm :: BackendType -&gt; *).
PermDef b perm -&gt; RoleName
</span><a href="Hasura.RQL.Types.Permission.html#_pdRole"><span class="hs-identifier hs-var">_pdRole</span></a></span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span>    </span><span id="local-6989586621687980462"><span class="annot"><span class="annottext">alignPermissions :: TablePermissionInputs b
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980462"><span class="hs-identifier hs-var hs-var">alignPermissions</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#TablePermissionInputs"><span class="hs-identifier hs-type">TablePermissionInputs</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687980513"><span id="local-6989586621687980514"><span id="local-6989586621687980515"><span id="local-6989586621687980516"><span id="local-6989586621687980517"><span class="annot"><span class="annottext">[PermDef b UpdPerm]
[PermDef b DelPerm]
[PermDef b SelPerm]
[PermDef b InsPerm]
TableName b
_tpiTable :: forall (b :: BackendType). TablePermissionInputs b -&gt; TableName b
_tpiTable :: TableName b
_tpiInsert :: [PermDef b InsPerm]
_tpiSelect :: [PermDef b SelPerm]
_tpiUpdate :: [PermDef b UpdPerm]
_tpiDelete :: [PermDef b DelPerm]
_tpiInsert :: forall (b :: BackendType).
TablePermissionInputs b -&gt; [InsPermDef b]
_tpiSelect :: forall (b :: BackendType).
TablePermissionInputs b -&gt; [SelPermDef b]
_tpiUpdate :: forall (b :: BackendType).
TablePermissionInputs b -&gt; [UpdPermDef b]
_tpiDelete :: forall (b :: BackendType).
TablePermissionInputs b -&gt; [DelPermDef b]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#_tpiTable"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-297"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980522"><span class="annot"><span class="annottext">insertsMap :: HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980522"><span class="hs-identifier hs-var hs-var">insertsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621687980523"><span class="annot"><span class="annottext">PermDef b InsPerm
</span><a href="#local-6989586621687980523"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermDef b InsPerm -&gt; Maybe (PermDef b InsPerm)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PermDef b InsPerm
</span><a href="#local-6989586621687980523"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b SelPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b UpdPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b DelPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PermDef b InsPerm
 -&gt; (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
     Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm)))
-&gt; HashMap RoleName (PermDef b InsPerm)
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[PermDef b InsPerm] -&gt; HashMap RoleName (PermDef b InsPerm)
forall (e :: BackendType -&gt; *).
[PermDef b e] -&gt; HashMap RoleName (PermDef b e)
</span><a href="#local-6989586621687980508"><span class="hs-identifier hs-var">mkMap</span></a></span><span> </span><span class="annot"><span class="annottext">[PermDef b InsPerm]
</span><a href="#local-6989586621687980514"><span class="hs-identifier hs-var">_tpiInsert</span></a></span><span>
</span><span id="line-298"></span><span>          </span><span id="local-6989586621687980524"><span class="annot"><span class="annottext">selectsMap :: HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980524"><span class="hs-identifier hs-var hs-var">selectsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621687980525"><span class="annot"><span class="annottext">PermDef b SelPerm
</span><a href="#local-6989586621687980525"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (PermDef b InsPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PermDef b SelPerm -&gt; Maybe (PermDef b SelPerm)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PermDef b SelPerm
</span><a href="#local-6989586621687980525"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b UpdPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b DelPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PermDef b SelPerm
 -&gt; (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
     Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm)))
-&gt; HashMap RoleName (PermDef b SelPerm)
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[PermDef b SelPerm] -&gt; HashMap RoleName (PermDef b SelPerm)
forall (e :: BackendType -&gt; *).
[PermDef b e] -&gt; HashMap RoleName (PermDef b e)
</span><a href="#local-6989586621687980508"><span class="hs-identifier hs-var">mkMap</span></a></span><span> </span><span class="annot"><span class="annottext">[PermDef b SelPerm]
</span><a href="#local-6989586621687980515"><span class="hs-identifier hs-var">_tpiSelect</span></a></span><span>
</span><span id="line-299"></span><span>          </span><span id="local-6989586621687980526"><span class="annot"><span class="annottext">updatesMap :: HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980526"><span class="hs-identifier hs-var hs-var">updatesMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621687980527"><span class="annot"><span class="annottext">PermDef b UpdPerm
</span><a href="#local-6989586621687980527"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (PermDef b InsPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b SelPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PermDef b UpdPerm -&gt; Maybe (PermDef b UpdPerm)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PermDef b UpdPerm
</span><a href="#local-6989586621687980527"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b DelPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PermDef b UpdPerm
 -&gt; (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
     Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm)))
-&gt; HashMap RoleName (PermDef b UpdPerm)
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[PermDef b UpdPerm] -&gt; HashMap RoleName (PermDef b UpdPerm)
forall (e :: BackendType -&gt; *).
[PermDef b e] -&gt; HashMap RoleName (PermDef b e)
</span><a href="#local-6989586621687980508"><span class="hs-identifier hs-var">mkMap</span></a></span><span> </span><span class="annot"><span class="annottext">[PermDef b UpdPerm]
</span><a href="#local-6989586621687980516"><span class="hs-identifier hs-var">_tpiUpdate</span></a></span><span>
</span><span id="line-300"></span><span>          </span><span id="local-6989586621687980528"><span class="annot"><span class="annottext">deletesMap :: HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980528"><span class="hs-identifier hs-var hs-var">deletesMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621687980529"><span class="annot"><span class="annottext">PermDef b DelPerm
</span><a href="#local-6989586621687980529"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (PermDef b InsPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b SelPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b UpdPerm)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PermDef b DelPerm -&gt; Maybe (PermDef b DelPerm)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PermDef b DelPerm
</span><a href="#local-6989586621687980529"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PermDef b DelPerm
 -&gt; (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
     Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm)))
-&gt; HashMap RoleName (PermDef b DelPerm)
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[PermDef b DelPerm] -&gt; HashMap RoleName (PermDef b DelPerm)
forall (e :: BackendType -&gt; *).
[PermDef b e] -&gt; HashMap RoleName (PermDef b e)
</span><a href="#local-6989586621687980508"><span class="hs-identifier hs-var">mkMap</span></a></span><span> </span><span class="annot"><span class="annottext">[PermDef b DelPerm]
</span><a href="#local-6989586621687980517"><span class="hs-identifier hs-var">_tpiDelete</span></a></span><span>
</span><span id="line-301"></span><span>          </span><span id="local-6989586621687980546"><span class="annot"><span class="annottext">unionMap :: HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
</span><a href="#local-6989586621687980546"><span class="hs-identifier hs-var hs-var">unionMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Maybe a, Maybe a, Maybe a, Maybe a)
 -&gt; (Maybe a, Maybe a, Maybe a, Maybe a)
 -&gt; (Maybe a, Maybe a, Maybe a, Maybe a))
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; HashMap k v -&gt; HashMap k v -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.Strict.html#unionWith"><span class="hs-identifier hs-var">HashMap.unionWith</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687980548"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980548"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980549"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980549"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980550"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980550"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980551"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980551"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687980552"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980552"><span class="hs-identifier hs-var">a'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980553"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980553"><span class="hs-identifier hs-var">b'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980554"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980554"><span class="hs-identifier hs-var">c'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980555"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980555"><span class="hs-identifier hs-var">d'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980548"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Maybe a -&gt; Maybe a
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980552"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980549"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Maybe a -&gt; Maybe a
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980553"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980550"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Maybe a -&gt; Maybe a
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980554"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980551"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Maybe a -&gt; Maybe a
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621687980555"><span class="hs-identifier hs-var">d'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980522"><span class="hs-identifier hs-var">insertsMap</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
forall {a} {a} {a} {a}.
HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
</span><a href="#local-6989586621687980546"><span class="hs-operator hs-var">`unionMap`</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980524"><span class="hs-identifier hs-var">selectsMap</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
forall {a} {a} {a} {a}.
HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
</span><a href="#local-6989586621687980546"><span class="hs-operator hs-var">`unionMap`</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980526"><span class="hs-identifier hs-var">updatesMap</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
-&gt; HashMap
     RoleName
     (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
      Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
forall {a} {a} {a} {a}.
HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
-&gt; HashMap RoleName (Maybe a, Maybe a, Maybe a, Maybe a)
</span><a href="#local-6989586621687980546"><span class="hs-operator hs-var">`unionMap`</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap
  RoleName
  (Maybe (PermDef b InsPerm), Maybe (PermDef b SelPerm),
   Maybe (PermDef b UpdPerm), Maybe (PermDef b DelPerm))
</span><a href="#local-6989586621687980528"><span class="hs-identifier hs-var">deletesMap</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>    </span><span id="local-6989586621687979907"><span class="annot"><a href="#local-6989586621687980502"><span class="hs-identifier hs-type">buildPermission</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermDef"><span class="hs-identifier hs-type">PermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979907"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687979830"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html#PermInfo"><span class="hs-identifier hs-type">PermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979907"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-305"></span><span>    </span><span id="local-6989586621687980502"><span class="annot"><span class="annottext">buildPermission :: forall (a :: BackendType -&gt; *).
Maybe (PermDef b a) -&gt; m (Maybe (PermInfo a b))
</span><a href="#local-6989586621687980502"><span class="hs-identifier hs-var hs-var">buildPermission</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (PermDef b a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (PermInfo a b) -&gt; m (Maybe (PermInfo a b))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (PermInfo a b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><a href="#local-6989586621687980502"><span class="hs-identifier hs-var">buildPermission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621687980604"><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980604"><span class="hs-identifier hs-var">permission</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-307"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980605"><span class="annot"><span class="annottext">metadataObject :: MetadataObject
</span><a href="#local-6989586621687980605"><span class="hs-identifier hs-var hs-var">metadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PermDef b a -&gt; MetadataObject
forall (a :: BackendType -&gt; *). PermDef b a -&gt; MetadataObject
</span><a href="#local-6989586621687980606"><span class="hs-identifier hs-var">mkPermissionMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980604"><span class="hs-identifier hs-var">permission</span></a></span><span>
</span><span id="line-308"></span><span>          </span><span id="local-6989586621687980607"><span class="annot"><span class="annottext">permType :: PermType
</span><a href="#local-6989586621687980607"><span class="hs-identifier hs-var hs-var">permType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PermDefPermission b a -&gt; PermType
forall (b :: BackendType) (a :: BackendType -&gt; *).
PermDefPermission b a -&gt; PermType
</span><a href="Hasura.RQL.Types.Permission.html#reflectPermDefPermission"><span class="hs-identifier hs-var">reflectPermDefPermission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermDef b a -&gt; PermDefPermission b a
forall (b :: BackendType) (perm :: BackendType -&gt; *).
PermDef b perm -&gt; PermDefPermission b perm
</span><a href="Hasura.RQL.Types.Permission.html#_pdPermission"><span class="hs-identifier hs-var">_pdPermission</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980604"><span class="hs-identifier hs-var">permission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>          </span><span id="local-6989586621687980610"><span class="annot"><span class="annottext">roleName :: RoleName
</span><a href="#local-6989586621687980610"><span class="hs-identifier hs-var hs-var">roleName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PermDef b a -&gt; RoleName
forall (b :: BackendType) (perm :: BackendType -&gt; *).
PermDef b perm -&gt; RoleName
</span><a href="Hasura.RQL.Types.Permission.html#_pdRole"><span class="hs-identifier hs-var">_pdRole</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980604"><span class="hs-identifier hs-var">permission</span></a></span><span>
</span><span id="line-310"></span><span>          </span><span id="local-6989586621687980611"><span class="annot"><span class="annottext">schemaObject :: SchemaObjId
</span><a href="#local-6989586621687980611"><span class="hs-identifier hs-var hs-var">schemaObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>            </span><span class="annot"><span class="annottext">SourceName -&gt; AnyBackend SourceObjId -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOSourceObj"><span class="hs-identifier hs-var">SOSourceObj</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980453"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-312"></span><span>              </span><span class="annot"><span class="annottext">(AnyBackend SourceObjId -&gt; SchemaObjId)
-&gt; AnyBackend SourceObjId -&gt; SchemaObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceObjId b -&gt; AnyBackend SourceObjId
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span>
</span><span id="line-313"></span><span>              </span><span class="annot"><span class="annottext">(SourceObjId b -&gt; AnyBackend SourceObjId)
-&gt; SourceObjId b -&gt; AnyBackend SourceObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
TableName b -&gt; TableObjId b -&gt; SourceObjId b
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOITableObj"><span class="hs-identifier hs-var">SOITableObj</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980484"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-314"></span><span>              </span><span class="annot"><span class="annottext">(TableObjId b -&gt; SourceObjId b) -&gt; TableObjId b -&gt; SourceObjId b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; PermType -&gt; TableObjId b
forall (b :: BackendType). RoleName -&gt; PermType -&gt; TableObjId b
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#TOPerm"><span class="hs-identifier hs-var">TOPerm</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980610"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="#local-6989586621687980607"><span class="hs-identifier hs-var">permType</span></a></span><span>
</span><span id="line-315"></span><span>          </span><span id="local-6989586621687980616"><span class="annot"><span class="annottext">addPermContext :: Text -&gt; Text
</span><a href="#local-6989586621687980616"><span class="hs-identifier hs-var hs-var">addPermContext</span></a></span></span><span> </span><span id="local-6989586621687980617"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687980617"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in permission for role &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980610"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687980617"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-316"></span><span>      </span><span class="annot"><span class="annottext">MetadataObject
-&gt; ExceptT QErr m (PermInfo a b) -&gt; m (Maybe (PermInfo a b))
forall (m :: * -&gt; *) a.
MonadWriter (Seq CollectItem) m =&gt;
MetadataObject -&gt; ExceptT QErr m a -&gt; m (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistencyM"><span class="hs-identifier hs-var">withRecordInconsistencyM</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621687980605"><span class="hs-identifier hs-var">metadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m (PermInfo a b) -&gt; m (Maybe (PermInfo a b)))
-&gt; ExceptT QErr m (PermInfo a b) -&gt; m (Maybe (PermInfo a b))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text)
-&gt; ExceptT QErr m (PermInfo a b) -&gt; ExceptT QErr m (PermInfo a b)
forall (m :: * -&gt; *) a. QErrM m =&gt; (Text -&gt; Text) -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#modifyErr"><span class="hs-identifier hs-var">modifyErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). Backend b =&gt; TableName b -&gt; Text -&gt; Text
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#addTableContext"><span class="hs-identifier hs-var">addTableContext</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980484"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621687980616"><span class="hs-identifier hs-var">addPermContext</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; ExceptT QErr m () -&gt; ExceptT QErr m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermDef b a -&gt; RoleName
forall (b :: BackendType) (perm :: BackendType -&gt; *).
PermDef b perm -&gt; RoleName
</span><a href="Hasura.RQL.Types.Permission.html#_pdRole"><span class="hs-identifier hs-var">_pdRole</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980604"><span class="hs-identifier hs-var">permission</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RoleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="Hasura.RQL.Types.Roles.html#adminRoleName"><span class="hs-identifier hs-var">adminRoleName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>          </span><span class="annot"><span class="annottext">(ExceptT QErr m () -&gt; ExceptT QErr m ())
-&gt; ExceptT QErr m () -&gt; ExceptT QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; ExceptT QErr m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#ConstraintViolation"><span class="hs-identifier hs-var">ConstraintViolation</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cannot define permission for admin role&quot;</span></span><span>
</span><span id="line-319"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621687980624"><span class="annot"><span class="annottext">PermInfo a b
</span><a href="#local-6989586621687980624"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980625"><span class="annot"><span class="annottext">Seq SchemaDependency
</span><a href="#local-6989586621687980625"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-320"></span><span>          </span><span class="annot"><span class="annottext">(TableCoreCacheRT
   b (ExceptT QErr m) (PermInfo a b, Seq SchemaDependency)
 -&gt; TableCoreCache b
 -&gt; ExceptT QErr m (PermInfo a b, Seq SchemaDependency))
-&gt; TableCoreCache b
-&gt; TableCoreCacheRT
     b (ExceptT QErr m) (PermInfo a b, Seq SchemaDependency)
-&gt; ExceptT QErr m (PermInfo a b, Seq SchemaDependency)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">TableCoreCacheRT
  b (ExceptT QErr m) (PermInfo a b, Seq SchemaDependency)
-&gt; TableCoreCache b
-&gt; ExceptT QErr m (PermInfo a b, Seq SchemaDependency)
forall (b :: BackendType) (m :: * -&gt; *) a.
TableCoreCacheRT b m a -&gt; TableCoreCache b -&gt; m a
</span><a href="Hasura.RQL.Types.SchemaCache.html#runTableCoreCacheRT"><span class="hs-identifier hs-var">runTableCoreCacheRT</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreCache b
</span><a href="#local-6989586621687980455"><span class="hs-identifier hs-var">tableCache</span></a></span><span>
</span><span id="line-321"></span><span>            </span><span class="annot"><span class="annottext">(TableCoreCacheRT
   b (ExceptT QErr m) (PermInfo a b, Seq SchemaDependency)
 -&gt; ExceptT QErr m (PermInfo a b, Seq SchemaDependency))
-&gt; (ReaderT
      (SourceConfig b)
      (TableCoreCacheRT b (ExceptT QErr m))
      (PermInfo a b, Seq SchemaDependency)
    -&gt; TableCoreCacheRT
         b (ExceptT QErr m) (PermInfo a b, Seq SchemaDependency))
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (PermInfo a b, Seq SchemaDependency)
-&gt; ExceptT QErr m (PermInfo a b, Seq SchemaDependency)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   (SourceConfig b)
   (TableCoreCacheRT b (ExceptT QErr m))
   (PermInfo a b, Seq SchemaDependency)
 -&gt; SourceConfig b
 -&gt; TableCoreCacheRT
      b (ExceptT QErr m) (PermInfo a b, Seq SchemaDependency))
-&gt; SourceConfig b
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (PermInfo a b, Seq SchemaDependency)
-&gt; TableCoreCacheRT
     b (ExceptT QErr m) (PermInfo a b, Seq SchemaDependency)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT
  (SourceConfig b)
  (TableCoreCacheRT b (ExceptT QErr m))
  (PermInfo a b, Seq SchemaDependency)
-&gt; SourceConfig b
-&gt; TableCoreCacheRT
     b (ExceptT QErr m) (PermInfo a b, Seq SchemaDependency)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687980454"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-322"></span><span>            </span><span class="annot"><span class="annottext">(ReaderT
   (SourceConfig b)
   (TableCoreCacheRT b (ExceptT QErr m))
   (PermInfo a b, Seq SchemaDependency)
 -&gt; ExceptT QErr m (PermInfo a b, Seq SchemaDependency))
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (PermInfo a b, Seq SchemaDependency)
-&gt; ExceptT QErr m (PermInfo a b, Seq SchemaDependency)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LogicalModelMetadata b -&gt; LogicalModelFields b)
-&gt; HashMap LogicalModelName (LogicalModelMetadata b)
-&gt; LogicalModelFieldsLookupRT
     b
     (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
     (PermInfo a b, Seq SchemaDependency)
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (PermInfo a b, Seq SchemaDependency)
forall x (b :: BackendType) (m :: * -&gt; *) a.
(x -&gt; LogicalModelFields b)
-&gt; HashMap LogicalModelName x
-&gt; LogicalModelFieldsLookupRT b m a
-&gt; m a
</span><a href="Hasura.LogicalModel.Fields.html#runLogicalModelFieldsLookup"><span class="hs-identifier hs-var">runLogicalModelFieldsLookup</span></a></span><span> </span><span class="annot"><span class="annottext">LogicalModelMetadata b -&gt; LogicalModelFields b
forall (b :: BackendType).
LogicalModelMetadata b -&gt; LogicalModelFields b
</span><a href="Hasura.LogicalModel.Metadata.html#_lmmFields"><span class="hs-identifier hs-var">_lmmFields</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap LogicalModelName (LogicalModelMetadata b)
</span><a href="#local-6989586621687980460"><span class="hs-identifier hs-var">logicalModels</span></a></span><span>
</span><span id="line-323"></span><span>            </span><span class="annot"><span class="annottext">(LogicalModelFieldsLookupRT
   b
   (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
   (PermInfo a b, Seq SchemaDependency)
 -&gt; ReaderT
      (SourceConfig b)
      (TableCoreCacheRT b (ExceptT QErr m))
      (PermInfo a b, Seq SchemaDependency))
-&gt; LogicalModelFieldsLookupRT
     b
     (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
     (PermInfo a b, Seq SchemaDependency)
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (PermInfo a b, Seq SchemaDependency)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Environment
-&gt; SourceName
-&gt; TableName b
-&gt; FieldInfoMap (FieldInfo b)
-&gt; RoleName
-&gt; PermDefPermission b a
-&gt; LogicalModelFieldsLookupRT
     b
     (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
     (PermInfo a b, Seq SchemaDependency)
forall (b :: BackendType) (m :: * -&gt; *) r
       (perm :: BackendType -&gt; *).
(BackendMetadata b, QErrM m, TableCoreInfoRM b m,
 LogicalModelFieldsRM b m, GetAggregationPredicatesDeps b,
 MonadReader r m, Has (ScalarTypeParsingContext b) r) =&gt;
Environment
-&gt; SourceName
-&gt; TableName b
-&gt; FieldInfoMap (FieldInfo b)
-&gt; RoleName
-&gt; PermDefPermission b perm
-&gt; m (WithDeps (PermInfo perm b))
</span><a href="Hasura.RQL.DDL.Permission.html#buildPermInfo"><span class="hs-identifier hs-var">buildPermInfo</span></a></span><span>
</span><span id="line-324"></span><span>              </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621687980452"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-325"></span><span>              </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980453"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-326"></span><span>              </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980484"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-327"></span><span>              </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo b)
</span><a href="#local-6989586621687980457"><span class="hs-identifier hs-var">tableFields</span></a></span><span>
</span><span id="line-328"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermDef b a -&gt; RoleName
forall (b :: BackendType) (perm :: BackendType -&gt; *).
PermDef b perm -&gt; RoleName
</span><a href="Hasura.RQL.Types.Permission.html#_pdRole"><span class="hs-identifier hs-var">_pdRole</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980604"><span class="hs-identifier hs-var">permission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermDef b a -&gt; PermDefPermission b a
forall (b :: BackendType) (perm :: BackendType -&gt; *).
PermDef b perm -&gt; PermDefPermission b perm
</span><a href="Hasura.RQL.Types.Permission.html#_pdPermission"><span class="hs-identifier hs-var">_pdPermission</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980604"><span class="hs-identifier hs-var">permission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><span class="annottext">MetadataObject
-&gt; SchemaObjId -&gt; Seq SchemaDependency -&gt; ExceptT QErr m ()
forall (m :: * -&gt; *).
MonadWriter (Seq CollectItem) m =&gt;
MetadataObject -&gt; SchemaObjId -&gt; Seq SchemaDependency -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordDependenciesM"><span class="hs-identifier hs-var">recordDependenciesM</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621687980605"><span class="hs-identifier hs-var">metadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaObjId
</span><a href="#local-6989586621687980611"><span class="hs-identifier hs-var">schemaObject</span></a></span><span> </span><span class="annot"><span class="annottext">Seq SchemaDependency
</span><a href="#local-6989586621687980625"><span class="hs-identifier hs-var">dependencies</span></a></span><span>
</span><span id="line-331"></span><span>        </span><span class="annot"><span class="annottext">PermInfo a b -&gt; ExceptT QErr m (PermInfo a b)
forall a. a -&gt; ExceptT QErr m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">PermInfo a b
</span><a href="#local-6989586621687980624"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span>    </span><span id="local-6989586621687979977"><span class="annot"><a href="#local-6989586621687980606"><span class="hs-identifier hs-type">mkPermissionMetadataObject</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#PermDef"><span class="hs-identifier hs-type">PermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687979977"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span></span><span>
</span><span id="line-334"></span><span>    </span><span id="local-6989586621687980606"><span class="annot"><span class="annottext">mkPermissionMetadataObject :: forall (a :: BackendType -&gt; *). PermDef b a -&gt; MetadataObject
</span><a href="#local-6989586621687980606"><span class="hs-identifier hs-var hs-var">mkPermissionMetadataObject</span></a></span></span><span> </span><span id="local-6989586621687980637"><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980637"><span class="hs-identifier hs-var">permDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-335"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687980638"><span class="annot"><span class="annottext">permType :: PermType
</span><a href="#local-6989586621687980638"><span class="hs-identifier hs-var hs-var">permType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PermDefPermission b a -&gt; PermType
forall (b :: BackendType) (a :: BackendType -&gt; *).
PermDefPermission b a -&gt; PermType
</span><a href="Hasura.RQL.Types.Permission.html#reflectPermDefPermission"><span class="hs-identifier hs-var">reflectPermDefPermission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermDef b a -&gt; PermDefPermission b a
forall (b :: BackendType) (perm :: BackendType -&gt; *).
PermDef b perm -&gt; PermDefPermission b perm
</span><a href="Hasura.RQL.Types.Permission.html#_pdPermission"><span class="hs-identifier hs-var">_pdPermission</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980637"><span class="hs-identifier hs-var">permDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>          </span><span id="local-6989586621687980639"><span class="annot"><span class="annottext">objectId :: MetadataObjId
</span><a href="#local-6989586621687980639"><span class="hs-identifier hs-var hs-var">objectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-337"></span><span>            </span><span class="annot"><span class="annottext">SourceName -&gt; AnyBackend SourceMetadataObjId -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOSourceObjId"><span class="hs-identifier hs-var">MOSourceObjId</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980453"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-338"></span><span>              </span><span class="annot"><span class="annottext">(AnyBackend SourceMetadataObjId -&gt; MetadataObjId)
-&gt; AnyBackend SourceMetadataObjId -&gt; MetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span>
</span><span id="line-339"></span><span>              </span><span class="annot"><span class="annottext">(SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId)
-&gt; SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
TableName b -&gt; TableMetadataObjId -&gt; SourceMetadataObjId b
</span><a href="Hasura.RQL.Types.Metadata.Object.html#SMOTableObj"><span class="hs-identifier hs-var">SMOTableObj</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980484"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-340"></span><span>              </span><span class="annot"><span class="annottext">(TableMetadataObjId -&gt; SourceMetadataObjId b)
-&gt; TableMetadataObjId -&gt; SourceMetadataObjId b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; PermType -&gt; TableMetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MTOPerm"><span class="hs-identifier hs-var">MTOPerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermDef b a -&gt; RoleName
forall (b :: BackendType) (perm :: BackendType -&gt; *).
PermDef b perm -&gt; RoleName
</span><a href="Hasura.RQL.Types.Permission.html#_pdRole"><span class="hs-identifier hs-var">_pdRole</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980637"><span class="hs-identifier hs-var">permDef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="#local-6989586621687980638"><span class="hs-identifier hs-var">permType</span></a></span><span>
</span><span id="line-341"></span><span>          </span><span id="local-6989586621687980643"><span class="annot"><span class="annottext">definition :: Value
</span><a href="#local-6989586621687980643"><span class="hs-identifier hs-var hs-var">definition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithTable b (PermDef b a) -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTable b (PermDef b a) -&gt; Value)
-&gt; WithTable b (PermDef b a) -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) a.
SourceName -&gt; TableName b -&gt; a -&gt; WithTable b a
</span><a href="Hasura.RQL.Types.Relationships.Local.html#WithTable"><span class="hs-identifier hs-var">WithTable</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687979831"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980453"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621687980484"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">PermDef b a
</span><a href="#local-6989586621687980637"><span class="hs-identifier hs-var">permDef</span></a></span><span>
</span><span id="line-342"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="#local-6989586621687980639"><span class="hs-identifier hs-var">objectId</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621687980643"><span class="hs-identifier hs-var">definition</span></a></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span class="hs-comment">-- | Create the permission map for a native query based on the select</span><span>
</span><span id="line-345"></span><span class="hs-comment">-- permissions given in metadata. Compare with 'buildTablePermissions'.</span><span>
</span><span id="line-346"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildLogicalModelPermissions"><span class="hs-identifier hs-type">buildLogicalModelPermissions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687980031"><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621687980030"><span class="annot"><a href="#local-6989586621687980030"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980030"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadWriter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectItem"><span class="hs-identifier hs-type">CollectItem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687980030"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-350"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-351"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#GetAggregationPredicatesDeps"><span class="hs-identifier hs-type">GetAggregationPredicatesDeps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><a href="Hasura.LogicalModel.Fields.html#LogicalModelFieldsRM"><span class="hs-identifier hs-type">LogicalModelFieldsRM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980030"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-354"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-355"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-356"></span><span>  </span><span class="annot"><a href="Hasura.Table.Cache.html#TableCoreCache"><span class="hs-identifier hs-type">TableCoreCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-357"></span><span>  </span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LogicalModelLocation"><span class="hs-identifier hs-type">LogicalModelLocation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/insert-ordered-containers-0.2.5.1-b5ad8e22c80bc291a2f581fb78a4448e46180aa38110e81c957f693abd1dc222/share/doc/html/src/Data.HashMap.Strict.InsOrd.html#InsOrdHashMap"><span class="hs-identifier hs-type">InsOrdHashMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Column"><span class="hs-identifier hs-type">Column</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LogicalModelField"><span class="hs-identifier hs-type">LogicalModelField</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-359"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/insert-ordered-containers-0.2.5.1-b5ad8e22c80bc291a2f581fb78a4448e46180aa38110e81c957f693abd1dc222/share/doc/html/src/Data.HashMap.Strict.InsOrd.html#InsOrdHashMap"><span class="hs-identifier hs-type">InsOrdHashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#SelPermDef"><span class="hs-identifier hs-type">SelPermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-360"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-361"></span><span>  </span><span class="annot"><a href="#local-6989586621687980030"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#RolePermInfoMap"><span class="hs-identifier hs-type">RolePermInfoMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span id="buildLogicalModelPermissions"><span class="annot"><span class="annottext">buildLogicalModelPermissions :: forall (b :: BackendType) (m :: * -&gt; *).
(MonadError QErr m, MonadWriter (Seq CollectItem) m,
 BackendMetadata b, GetAggregationPredicatesDeps b,
 LogicalModelFieldsRM b m) =&gt;
SourceName
-&gt; SourceConfig b
-&gt; TableCoreCache b
-&gt; LogicalModelLocation
-&gt; InsOrdHashMap (Column b) (LogicalModelField b)
-&gt; InsOrdHashMap RoleName (SelPermDef b)
-&gt; OrderedRoles
-&gt; m (RolePermInfoMap b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildLogicalModelPermissions"><span class="hs-identifier hs-var hs-var">buildLogicalModelPermissions</span></a></span></span><span> </span><span id="local-6989586621687980710"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980710"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621687980711"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687980711"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687980712"><span class="annot"><span class="annottext">TableCoreCache b
</span><a href="#local-6989586621687980712"><span class="hs-identifier hs-var">tableCache</span></a></span></span><span> </span><span id="local-6989586621687980713"><span class="annot"><span class="annottext">LogicalModelLocation
</span><a href="#local-6989586621687980713"><span class="hs-identifier hs-var">logicalModelLocation</span></a></span></span><span> </span><span id="local-6989586621687980714"><span class="annot"><span class="annottext">InsOrdHashMap (Column b) (LogicalModelField b)
</span><a href="#local-6989586621687980714"><span class="hs-identifier hs-var">logicalModelFields</span></a></span></span><span> </span><span id="local-6989586621687980715"><span class="annot"><span class="annottext">InsOrdHashMap RoleName (SelPermDef b)
</span><a href="#local-6989586621687980715"><span class="hs-identifier hs-var">selectPermissions</span></a></span></span><span> </span><span id="local-6989586621687980716"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621687980716"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621687980717"><span class="hs-identifier hs-type">combineRolePermissions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Table.Cache.html#RolePermInfoMap"><span class="hs-identifier hs-type">RolePermInfoMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621687980030"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#RolePermInfoMap"><span class="hs-identifier hs-type">RolePermInfoMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>      </span><span id="local-6989586621687980717"><span class="annot"><span class="annottext">combineRolePermissions :: RolePermInfoMap b -&gt; Role -&gt; m (RolePermInfoMap b)
</span><a href="#local-6989586621687980717"><span class="hs-identifier hs-var hs-var">combineRolePermissions</span></a></span></span><span> </span><span id="local-6989586621687980718"><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980718"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621687980719"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621687980719"><span class="hs-keyword hs-var">role</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span id="local-6989586621687980720"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980720"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#ParentRoles"><span class="hs-identifier hs-type">ParentRoles</span></a></span><span> </span><span id="local-6989586621687980721"><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621687980721"><span class="hs-identifier hs-var">parentRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-365"></span><span>        </span><span class="hs-comment">-- This error will ideally never be thrown, but if it's thrown then</span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-comment">-- it's possible that the permissions for the role do exist, but it's</span><span>
</span><span id="line-367"></span><span>        </span><span class="hs-comment">-- not yet built due to wrong ordering of the roles, check `orderRoles`.</span><span>
</span><span id="line-368"></span><span>        </span><span id="local-6989586621687980722"><span class="annot"><span class="annottext">[RolePermInfo b]
</span><a href="#local-6989586621687980722"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-369"></span><span>          </span><span class="annot"><span class="annottext">[RoleName]
-&gt; (RoleName -&gt; m (RolePermInfo b)) -&gt; m [RolePermInfo b]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall a. HashSet a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621687980721"><span class="hs-identifier hs-var">parentRoles</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687980723"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980723"><span class="hs-identifier hs-var">parentRole</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-370"></span><span>            </span><span class="annot"><span class="annottext">RoleName -&gt; RolePermInfoMap b -&gt; Maybe (RolePermInfo b)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980723"><span class="hs-identifier hs-var">parentRole</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980718"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-371"></span><span>              </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b) -&gt; m (RolePermInfo b) -&gt; m (RolePermInfo b)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onNothing"><span class="hs-operator hs-var">`onNothing`</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; m (RolePermInfo b)
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;buildTablePermissions: table role permissions for role: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980723"><span class="hs-identifier hs-var">parentRole</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; not found&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- What permissions are we inheriting?</span><span>
</span><span id="line-374"></span><span>            </span><span class="annot"><a href="#local-6989586621687980724"><span class="hs-identifier hs-type">combinedParentRolePermInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CombineRolePermInfo"><span class="hs-identifier hs-type">CombineRolePermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-375"></span><span>            </span><span id="local-6989586621687980724"><span class="annot"><span class="annottext">combinedParentRolePermInfo :: CombineRolePermInfo b
</span><a href="#local-6989586621687980724"><span class="hs-identifier hs-var hs-var">combinedParentRolePermInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; CombineRolePermInfo b)
-&gt; [RolePermInfo b] -&gt; CombineRolePermInfo b
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; [a] -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; CombineRolePermInfo b
forall (b :: BackendType). RolePermInfo b -&gt; CombineRolePermInfo b
</span><a href="Hasura.RQL.Types.Roles.Internal.html#rolePermInfoToCombineRolePermInfo"><span class="hs-identifier hs-var">rolePermInfoToCombineRolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[RolePermInfo b]
</span><a href="#local-6989586621687980722"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span>            </span><span class="hs-comment">-- How many select permissions are we inheriting? See</span><span>
</span><span id="line-378"></span><span>            </span><span class="hs-comment">-- 'combinedSelPermInfoToSelPermInfo' for information on the</span><span>
</span><span id="line-379"></span><span>            </span><span class="hs-comment">-- optimisation this count enables.</span><span>
</span><span id="line-380"></span><span>            </span><span class="annot"><a href="#local-6989586621687980726"><span class="hs-identifier hs-type">selectPermissionsCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-381"></span><span>            </span><span id="local-6989586621687980726"><span class="annot"><span class="annottext">selectPermissionsCount :: Int
</span><a href="#local-6989586621687980726"><span class="hs-identifier hs-var hs-var">selectPermissionsCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SelPermInfo b] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; Maybe (SelPermInfo b))
-&gt; [RolePermInfo b] -&gt; [SelPermInfo b]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b.
Filterable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; f b
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/witherable-0.4.2-c348fd1be527fbb040281c624d4766fb2c04c7e7f3be298bbe123b3357fb1136/share/doc/html/src/Witherable.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (SelPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (SelPermInfo b)
</span><a href="Hasura.Table.Cache.html#_permSel"><span class="hs-identifier hs-var">_permSel</span></a></span><span> </span><span class="annot"><span class="annottext">[RolePermInfo b]
</span><a href="#local-6989586621687980722"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span>            </span><span class="hs-comment">-- Does our specific role have any permissions?</span><span>
</span><span id="line-384"></span><span>            </span><span class="annot"><a href="#local-6989586621687980728"><span class="hs-identifier hs-type">accumulatedRolePermission</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#RolePermInfo"><span class="hs-identifier hs-type">RolePermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>            </span><span id="local-6989586621687980728"><span class="annot"><span class="annottext">accumulatedRolePermission :: Maybe (RolePermInfo b)
</span><a href="#local-6989586621687980728"><span class="hs-identifier hs-var hs-var">accumulatedRolePermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RolePermInfoMap b -&gt; Maybe (RolePermInfo b)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980720"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980718"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span>        </span><span class="hs-comment">-- If we have a permission, we'll use it. Otherwise, we'll fall</span><span>
</span><span id="line-388"></span><span>        </span><span class="hs-comment">-- back to the inherited permission.</span><span>
</span><span id="line-389"></span><span>        </span><span id="local-6989586621687980729"><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980729"><span class="hs-identifier hs-var">roleSelectPermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; SourceConfig b
-&gt; SelectPermissionSource b
-&gt; Role
-&gt; Maybe (CombinedSelPermInfo b)
-&gt; Int
-&gt; Maybe (SelPermInfo b)
-&gt; m (Maybe (SelPermInfo b))
forall (b :: BackendType) (m :: * -&gt; *).
(MonadWriter (Seq CollectItem) m, BackendMetadata b) =&gt;
SourceName
-&gt; SourceConfig b
-&gt; SelectPermissionSource b
-&gt; Role
-&gt; Maybe (CombinedSelPermInfo b)
-&gt; Int
-&gt; Maybe (SelPermInfo b)
-&gt; m (Maybe (SelPermInfo b))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveSelectPermission"><span class="hs-identifier hs-var">resolveSelectPermission</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980710"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687980711"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogicalModelLocation -&gt; SelectPermissionSource b
forall (b :: BackendType).
LogicalModelLocation -&gt; SelectPermissionSource b
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#SPSLogicalModel"><span class="hs-identifier hs-var">SPSLogicalModel</span></a></span><span> </span><span class="annot"><span class="annottext">LogicalModelLocation
</span><a href="#local-6989586621687980713"><span class="hs-identifier hs-var">logicalModelLocation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621687980719"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CombineRolePermInfo b -&gt; Maybe (CombinedSelPermInfo b)
forall (b :: BackendType).
CombineRolePermInfo b -&gt; Maybe (CombinedSelPermInfo b)
</span><a href="Hasura.RQL.Types.Roles.Internal.html#crpiSelPerm"><span class="hs-identifier hs-var">crpiSelPerm</span></a></span><span> </span><span class="annot"><span class="annottext">CombineRolePermInfo b
</span><a href="#local-6989586621687980724"><span class="hs-identifier hs-var">combinedParentRolePermInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687980726"><span class="hs-identifier hs-var">selectPermissionsCount</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RolePermInfo b -&gt; Maybe (SelPermInfo b)
forall (b :: BackendType). RolePermInfo b -&gt; Maybe (SelPermInfo b)
</span><a href="Hasura.Table.Cache.html#_permSel"><span class="hs-identifier hs-var">_permSel</span></a></span><span> </span><span class="annot"><span class="annottext">(RolePermInfo b -&gt; Maybe (SelPermInfo b))
-&gt; Maybe (RolePermInfo b) -&gt; Maybe (SelPermInfo b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (RolePermInfo b)
</span><a href="#local-6989586621687980728"><span class="hs-identifier hs-var">accumulatedRolePermission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621687980730"><span class="hs-identifier hs-type">rolePermInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Table.Cache.html#RolePermInfo"><span class="hs-identifier hs-type">RolePermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980031"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-392"></span><span>            </span><span id="local-6989586621687980730"><span class="annot"><span class="annottext">rolePermInfo :: RolePermInfo b
</span><a href="#local-6989586621687980730"><span class="hs-identifier hs-var hs-var">rolePermInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
forall (b :: BackendType).
Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
</span><a href="Hasura.Table.Cache.html#RolePermInfo"><span class="hs-identifier hs-var">RolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980729"><span class="hs-identifier hs-var">roleSelectPermission</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UpdPermInfo b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe (DelPermInfo b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span>        </span><span class="annot"><span class="annottext">RolePermInfoMap b -&gt; m (RolePermInfoMap b)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
-&gt; RolePermInfo b -&gt; RolePermInfoMap b -&gt; RolePermInfoMap b
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.Strict.html#insert"><span class="hs-identifier hs-var">HashMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980720"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfo b
</span><a href="#local-6989586621687980730"><span class="hs-identifier hs-var">rolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980718"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-comment">-- At the moment, we only support select permissions for logical models</span><span>
</span><span id="line-397"></span><span>  </span><span id="local-6989586621687980731"><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980731"><span class="hs-identifier hs-var">metadataRolePermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-398"></span><span>    </span><span class="annot"><span class="annottext">HashMap RoleName (SelPermDef b)
-&gt; (SelPermDef b -&gt; m (RolePermInfo b)) -&gt; m (RolePermInfoMap b)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span>
</span><span id="line-399"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InsOrdHashMap RoleName (SelPermDef b)
-&gt; HashMap RoleName (SelPermDef b)
forall k v. InsOrdHashMap k v -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/insert-ordered-containers-0.2.5.1-b5ad8e22c80bc291a2f581fb78a4448e46180aa38110e81c957f693abd1dc222/share/doc/html/src/Data.HashMap.Strict.InsOrd.html#toHashMap"><span class="hs-identifier hs-var">InsOrdHashMap.toHashMap</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap RoleName (SelPermDef b)
</span><a href="#local-6989586621687980715"><span class="hs-identifier hs-var">selectPermissions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
-&gt; SourceConfig b
-&gt; TableCoreCache b
-&gt; LogicalModelLocation
-&gt; InsOrdHashMap (Column b) (LogicalModelField b)
-&gt; SelPermDef b
-&gt; m (RolePermInfo b)
forall (b :: BackendType) (m :: * -&gt; *).
(MonadError QErr m, MonadWriter (Seq CollectItem) m,
 BackendMetadata b, GetAggregationPredicatesDeps b,
 LogicalModelFieldsRM b m) =&gt;
SourceName
-&gt; SourceConfig b
-&gt; TableCoreCache b
-&gt; LogicalModelLocation
-&gt; InsOrdHashMap (Column b) (LogicalModelField b)
-&gt; SelPermDef b
-&gt; m (RolePermInfo b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildLogicalModelSelectPermission"><span class="hs-identifier hs-var">buildLogicalModelSelectPermission</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980710"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687980711"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreCache b
</span><a href="#local-6989586621687980712"><span class="hs-identifier hs-var">tableCache</span></a></span><span> </span><span class="annot"><span class="annottext">LogicalModelLocation
</span><a href="#local-6989586621687980713"><span class="hs-identifier hs-var">logicalModelLocation</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap (Column b) (LogicalModelField b)
</span><a href="#local-6989586621687980714"><span class="hs-identifier hs-var">logicalModelFields</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span>  </span><span class="annot"><span class="annottext">(RolePermInfoMap b -&gt; Role -&gt; m (RolePermInfoMap b))
-&gt; RolePermInfoMap b -&gt; [Role] -&gt; m (RolePermInfoMap b)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldlM</span></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b -&gt; Role -&gt; m (RolePermInfoMap b)
</span><a href="#local-6989586621687980717"><span class="hs-identifier hs-var">combineRolePermissions</span></a></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap b
</span><a href="#local-6989586621687980731"><span class="hs-identifier hs-var">metadataRolePermissions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var">_unOrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621687980716"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildLogicalModelSelectPermission"><span class="hs-identifier hs-type">buildLogicalModelSelectPermission</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687980045"><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621687980044"><span class="annot"><a href="#local-6989586621687980044"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-406"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980044"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-407"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadWriter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectItem"><span class="hs-identifier hs-type">CollectItem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687980044"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-408"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-409"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#GetAggregationPredicatesDeps"><span class="hs-identifier hs-type">GetAggregationPredicatesDeps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-410"></span><span>    </span><span class="annot"><a href="Hasura.LogicalModel.Fields.html#LogicalModelFieldsRM"><span class="hs-identifier hs-type">LogicalModelFieldsRM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980044"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-412"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-413"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-414"></span><span>  </span><span class="annot"><a href="Hasura.Table.Cache.html#TableCoreCache"><span class="hs-identifier hs-type">TableCoreCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-415"></span><span>  </span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LogicalModelLocation"><span class="hs-identifier hs-type">LogicalModelLocation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-416"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/insert-ordered-containers-0.2.5.1-b5ad8e22c80bc291a2f581fb78a4448e46180aa38110e81c957f693abd1dc222/share/doc/html/src/Data.HashMap.Strict.InsOrd.html#InsOrdHashMap"><span class="hs-identifier hs-type">InsOrdHashMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Column"><span class="hs-identifier hs-type">Column</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LogicalModelField"><span class="hs-identifier hs-type">LogicalModelField</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-417"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Permission.html#SelPermDef"><span class="hs-identifier hs-type">SelPermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-418"></span><span>  </span><span class="annot"><a href="#local-6989586621687980044"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#RolePermInfo"><span class="hs-identifier hs-type">RolePermInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span id="buildLogicalModelSelectPermission"><span class="annot"><span class="annottext">buildLogicalModelSelectPermission :: forall (b :: BackendType) (m :: * -&gt; *).
(MonadError QErr m, MonadWriter (Seq CollectItem) m,
 BackendMetadata b, GetAggregationPredicatesDeps b,
 LogicalModelFieldsRM b m) =&gt;
SourceName
-&gt; SourceConfig b
-&gt; TableCoreCache b
-&gt; LogicalModelLocation
-&gt; InsOrdHashMap (Column b) (LogicalModelField b)
-&gt; SelPermDef b
-&gt; m (RolePermInfo b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#buildLogicalModelSelectPermission"><span class="hs-identifier hs-var hs-var">buildLogicalModelSelectPermission</span></a></span></span><span> </span><span id="local-6989586621687980781"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980781"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621687980782"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687980782"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621687980783"><span class="annot"><span class="annottext">TableCoreCache b
</span><a href="#local-6989586621687980783"><span class="hs-identifier hs-var">tableCache</span></a></span></span><span> </span><span id="local-6989586621687980784"><span class="annot"><span class="annottext">LogicalModelLocation
</span><a href="#local-6989586621687980784"><span class="hs-identifier hs-var">logicalModelLocation</span></a></span></span><span> </span><span id="local-6989586621687980785"><span class="annot"><span class="annottext">InsOrdHashMap (Column b) (LogicalModelField b)
</span><a href="#local-6989586621687980785"><span class="hs-identifier hs-var">logicalModelFields</span></a></span></span><span> </span><span id="local-6989586621687980786"><span class="annot"><span class="annottext">SelPermDef b
</span><a href="#local-6989586621687980786"><span class="hs-identifier hs-var">selectPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621687980787"><span class="hs-keyword hs-type">role</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span>
</span><span id="line-421"></span><span>      </span><span id="local-6989586621687980787"><span class="annot"><span class="annottext">role :: RoleName
</span><a href="#local-6989586621687980787"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SelPermDef b -&gt; RoleName
forall (b :: BackendType) (perm :: BackendType -&gt; *).
PermDef b perm -&gt; RoleName
</span><a href="Hasura.RQL.Types.Permission.html#_pdRole"><span class="hs-identifier hs-var">_pdRole</span></a></span><span> </span><span class="annot"><span class="annottext">SelPermDef b
</span><a href="#local-6989586621687980786"><span class="hs-identifier hs-var">selectPermission</span></a></span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span>      </span><span class="hs-comment">-- An identifier for the object on we're going to need to depend to</span><span>
</span><span id="line-424"></span><span>      </span><span class="hs-comment">-- generate this permission.</span><span>
</span><span id="line-425"></span><span>      </span><span class="annot"><a href="#local-6989586621687980788"><span class="hs-identifier hs-type">sourceObjId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObjId"><span class="hs-identifier hs-type">MetadataObjId</span></a></span><span>
</span><span id="line-426"></span><span>      </span><span id="local-6989586621687980788"><span class="annot"><span class="annottext">sourceObjId :: MetadataObjId
</span><a href="#local-6989586621687980788"><span class="hs-identifier hs-var hs-var">sourceObjId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-427"></span><span>        </span><span class="annot"><span class="annottext">SourceName -&gt; AnyBackend SourceMetadataObjId -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOSourceObjId"><span class="hs-identifier hs-var">MOSourceObjId</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980781"><span class="hs-identifier hs-var">sourceName</span></a></span><span>
</span><span id="line-428"></span><span>          </span><span class="annot"><span class="annottext">(AnyBackend SourceMetadataObjId -&gt; MetadataObjId)
-&gt; AnyBackend SourceMetadataObjId -&gt; MetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span>
</span><span id="line-429"></span><span>          </span><span class="annot"><span class="annottext">(SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId)
-&gt; SourceMetadataObjId b -&gt; AnyBackend SourceMetadataObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
LogicalModelLocation
-&gt; LogicalModelMetadataObjId -&gt; SourceMetadataObjId b
</span><a href="Hasura.RQL.Types.Metadata.Object.html#SMOLogicalModelObj"><span class="hs-identifier hs-var">SMOLogicalModelObj</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">LogicalModelLocation
</span><a href="#local-6989586621687980784"><span class="hs-identifier hs-var">logicalModelLocation</span></a></span><span>
</span><span id="line-430"></span><span>          </span><span class="annot"><span class="annottext">(LogicalModelMetadataObjId -&gt; SourceMetadataObjId b)
-&gt; LogicalModelMetadataObjId -&gt; SourceMetadataObjId b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; PermType -&gt; LogicalModelMetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#LMMOPerm"><span class="hs-identifier hs-var">LMMOPerm</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980787"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="Hasura.RQL.Types.Permission.html#PTSelect"><span class="hs-identifier hs-var">PTSelect</span></a></span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span>      </span><span class="hs-comment">-- The object we're going to use to track the dependency and any</span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-comment">-- potential cache inconsistencies.</span><span>
</span><span id="line-434"></span><span>      </span><span class="hs-comment">-- we'll need to add one for each location a Logical Model can live in future (a Stored Procedure, etc)</span><span>
</span><span id="line-435"></span><span>      </span><span class="annot"><a href="#local-6989586621687980792"><span class="hs-identifier hs-type">metadataObject</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span>
</span><span id="line-436"></span><span>      </span><span id="local-6989586621687980792"><span class="annot"><span class="annottext">metadataObject :: MetadataObject
</span><a href="#local-6989586621687980792"><span class="hs-identifier hs-var hs-var">metadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LogicalModelLocation
</span><a href="#local-6989586621687980784"><span class="hs-identifier hs-var">logicalModelLocation</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-437"></span><span>        </span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LMLLogicalModel"><span class="hs-identifier hs-type">LMLLogicalModel</span></a></span><span> </span><span id="local-6989586621687980793"><span class="annot"><span class="annottext">LogicalModelName
</span><a href="#local-6989586621687980793"><span class="hs-identifier hs-var">logicalModelName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-438"></span><span>          </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="#local-6989586621687980788"><span class="hs-identifier hs-var">sourceObjId</span></a></span><span>
</span><span id="line-439"></span><span>            </span><span class="annot"><span class="annottext">(Value -&gt; MetadataObject) -&gt; Value -&gt; MetadataObject
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WithLogicalModel (SelPermDef b) -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">toJSON</span></a></span><span>
</span><span id="line-440"></span><span>              </span><span class="annot"><a href="Hasura.LogicalModel.Metadata.html#WithLogicalModel"><span class="hs-identifier hs-type">WithLogicalModel</span></a></span><span>
</span><span id="line-441"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_wlmSource :: SourceName
</span><a href="Hasura.LogicalModel.Metadata.html#_wlmSource"><span class="hs-identifier hs-var">_wlmSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980781"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-442"></span><span>                  </span><span class="annot"><span class="annottext">_wlmName :: LogicalModelName
</span><a href="Hasura.LogicalModel.Metadata.html#_wlmName"><span class="hs-identifier hs-var">_wlmName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LogicalModelName
</span><a href="#local-6989586621687980793"><span class="hs-identifier hs-var">logicalModelName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-443"></span><span>                  </span><span class="annot"><span class="annottext">_wlmInfo :: SelPermDef b
</span><a href="Hasura.LogicalModel.Metadata.html#_wlmInfo"><span class="hs-identifier hs-var">_wlmInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SelPermDef b
</span><a href="#local-6989586621687980786"><span class="hs-identifier hs-var">selectPermission</span></a></span><span>
</span><span id="line-444"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-445"></span><span>        </span><span class="annot"><a href="Hasura.LogicalModel.Types.html#LMLNativeQuery"><span class="hs-identifier hs-type">LMLNativeQuery</span></a></span><span> </span><span id="local-6989586621687980798"><span class="annot"><span class="annottext">NativeQueryName
</span><a href="#local-6989586621687980798"><span class="hs-identifier hs-var">nativeQueryName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-446"></span><span>          </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="#local-6989586621687980788"><span class="hs-identifier hs-var">sourceObjId</span></a></span><span>
</span><span id="line-447"></span><span>            </span><span class="annot"><span class="annottext">(Value -&gt; MetadataObject) -&gt; Value -&gt; MetadataObject
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WithNativeQuery (SelPermDef b) -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">toJSON</span></a></span><span>
</span><span id="line-448"></span><span>              </span><span class="annot"><a href="Hasura.NativeQuery.Metadata.html#WithNativeQuery"><span class="hs-identifier hs-type">WithNativeQuery</span></a></span><span>
</span><span id="line-449"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_wnqSource :: SourceName
</span><a href="Hasura.NativeQuery.Metadata.html#_wnqSource"><span class="hs-identifier hs-var">_wnqSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980781"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-450"></span><span>                  </span><span class="annot"><span class="annottext">_wnqName :: NativeQueryName
</span><a href="Hasura.NativeQuery.Metadata.html#_wnqName"><span class="hs-identifier hs-var">_wnqName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NativeQueryName
</span><a href="#local-6989586621687980798"><span class="hs-identifier hs-var">nativeQueryName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-451"></span><span>                  </span><span class="annot"><span class="annottext">_wnqInfo :: SelPermDef b
</span><a href="Hasura.NativeQuery.Metadata.html#_wnqInfo"><span class="hs-identifier hs-var">_wnqInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SelPermDef b
</span><a href="#local-6989586621687980786"><span class="hs-identifier hs-var">selectPermission</span></a></span><span>
</span><span id="line-452"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span>      </span><span class="hs-comment">-- An identifier for this permission within the metadata structure.</span><span>
</span><span id="line-455"></span><span>      </span><span class="annot"><a href="#local-6989586621687980803"><span class="hs-identifier hs-type">schemaObject</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SchemaObjId"><span class="hs-identifier hs-type">SchemaObjId</span></a></span><span>
</span><span id="line-456"></span><span>      </span><span id="local-6989586621687980803"><span class="annot"><span class="annottext">schemaObject :: SchemaObjId
</span><a href="#local-6989586621687980803"><span class="hs-identifier hs-var hs-var">schemaObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-457"></span><span>        </span><span class="annot"><span class="annottext">SourceName -&gt; AnyBackend SourceObjId -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOSourceObj"><span class="hs-identifier hs-var">SOSourceObj</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980781"><span class="hs-identifier hs-var">sourceName</span></a></span><span>
</span><span id="line-458"></span><span>          </span><span class="annot"><span class="annottext">(AnyBackend SourceObjId -&gt; SchemaObjId)
-&gt; AnyBackend SourceObjId -&gt; SchemaObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceObjId b -&gt; AnyBackend SourceObjId
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span>
</span><span id="line-459"></span><span>          </span><span class="annot"><span class="annottext">(SourceObjId b -&gt; AnyBackend SourceObjId)
-&gt; SourceObjId b -&gt; AnyBackend SourceObjId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
LogicalModelLocation -&gt; LogicalModelObjId b -&gt; SourceObjId b
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOILogicalModelObj"><span class="hs-identifier hs-var">SOILogicalModelObj</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">LogicalModelLocation
</span><a href="#local-6989586621687980784"><span class="hs-identifier hs-var">logicalModelLocation</span></a></span><span>
</span><span id="line-460"></span><span>          </span><span class="annot"><span class="annottext">(LogicalModelObjId b -&gt; SourceObjId b)
-&gt; LogicalModelObjId b -&gt; SourceObjId b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; PermType -&gt; LogicalModelObjId b
forall (b :: BackendType).
RoleName -&gt; PermType -&gt; LogicalModelObjId b
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#LMOPerm"><span class="hs-identifier hs-var">LMOPerm</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980787"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="Hasura.RQL.Types.Permission.html#PTSelect"><span class="hs-identifier hs-var">PTSelect</span></a></span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span>      </span><span id="local-6989586621687980055"><span class="annot"><a href="#local-6989586621687980806"><span class="hs-identifier hs-type">modifyError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980044"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980055"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980044"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687980055"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-463"></span><span>      </span><span id="local-6989586621687980806"><span class="annot"><span class="annottext">modifyError :: forall a. ExceptT QErr m a -&gt; ExceptT QErr m a
</span><a href="#local-6989586621687980806"><span class="hs-identifier hs-var hs-var">modifyError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; ExceptT QErr m a -&gt; ExceptT QErr m a
forall (m :: * -&gt; *) a. QErrM m =&gt; (Text -&gt; Text) -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#modifyErr"><span class="hs-identifier hs-var">modifyErr</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687980813"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687980813"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-464"></span><span>        </span><span class="annot"><span class="annottext">LogicalModelLocation -&gt; Text -&gt; Text
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#addLogicalModelContext"><span class="hs-identifier hs-var">addLogicalModelContext</span></a></span><span> </span><span class="annot"><span class="annottext">LogicalModelLocation
</span><a href="#local-6989586621687980784"><span class="hs-identifier hs-var">logicalModelLocation</span></a></span><span>
</span><span id="line-465"></span><span>          </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in permission for role &quot;</span></span><span>
</span><span id="line-466"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980787"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-467"></span><span>          </span><span class="annot"><span class="annottext">RoleName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span>
</span><span id="line-468"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687980813"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-469"></span><span>
</span><span id="line-470"></span><span>  </span><span id="local-6989586621687980815"><span class="annot"><span class="annottext">LogicalModelName
-&gt; Maybe (InsOrdHashMap (Column b) (LogicalModelField b))
</span><a href="#local-6989586621687980815"><span class="hs-identifier hs-var">logicalModels</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
LogicalModelFieldsRM b m =&gt;
m (LogicalModelFieldsLookup b)
</span><a href="Hasura.LogicalModel.Fields.html#getLogicalModelFieldsLookup"><span class="hs-identifier hs-var">getLogicalModelFieldsLookup</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687980045"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-471"></span><span>  </span><span id="local-6989586621687980817"><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980817"><span class="hs-identifier hs-var">select</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MetadataObject
-&gt; ExceptT QErr m (SelPermInfo b) -&gt; m (Maybe (SelPermInfo b))
forall (m :: * -&gt; *) a.
MonadWriter (Seq CollectItem) m =&gt;
MetadataObject -&gt; ExceptT QErr m a -&gt; m (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistencyM"><span class="hs-identifier hs-var">withRecordInconsistencyM</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621687980792"><span class="hs-identifier hs-var">metadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m (SelPermInfo b) -&gt; m (Maybe (SelPermInfo b)))
-&gt; ExceptT QErr m (SelPermInfo b) -&gt; m (Maybe (SelPermInfo b))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExceptT QErr m (SelPermInfo b) -&gt; ExceptT QErr m (SelPermInfo b)
forall a. ExceptT QErr m a -&gt; ExceptT QErr m a
</span><a href="#local-6989586621687980806"><span class="hs-identifier hs-var">modifyError</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-472"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ExceptT QErr m () -&gt; ExceptT QErr m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687980787"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RoleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="Hasura.RQL.Types.Roles.html#adminRoleName"><span class="hs-identifier hs-var">adminRoleName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>      </span><span class="annot"><span class="annottext">(ExceptT QErr m () -&gt; ExceptT QErr m ())
-&gt; ExceptT QErr m () -&gt; ExceptT QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; ExceptT QErr m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#ConstraintViolation"><span class="hs-identifier hs-var">ConstraintViolation</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cannot define permission for admin role&quot;</span></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621687980818"><span class="annot"><span class="annottext">SelPermInfo b
</span><a href="#local-6989586621687980818"><span class="hs-identifier hs-var">permissionInformation</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687980819"><span class="annot"><span class="annottext">Seq SchemaDependency
</span><a href="#local-6989586621687980819"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-476"></span><span>      </span><span class="annot"><span class="annottext">(TableCoreCacheRT
   b (ExceptT QErr m) (SelPermInfo b, Seq SchemaDependency)
 -&gt; TableCoreCache b
 -&gt; ExceptT QErr m (SelPermInfo b, Seq SchemaDependency))
-&gt; TableCoreCache b
-&gt; TableCoreCacheRT
     b (ExceptT QErr m) (SelPermInfo b, Seq SchemaDependency)
-&gt; ExceptT QErr m (SelPermInfo b, Seq SchemaDependency)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">TableCoreCacheRT
  b (ExceptT QErr m) (SelPermInfo b, Seq SchemaDependency)
-&gt; TableCoreCache b
-&gt; ExceptT QErr m (SelPermInfo b, Seq SchemaDependency)
forall (b :: BackendType) (m :: * -&gt; *) a.
TableCoreCacheRT b m a -&gt; TableCoreCache b -&gt; m a
</span><a href="Hasura.RQL.Types.SchemaCache.html#runTableCoreCacheRT"><span class="hs-identifier hs-var">runTableCoreCacheRT</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreCache b
</span><a href="#local-6989586621687980783"><span class="hs-identifier hs-var">tableCache</span></a></span><span>
</span><span id="line-477"></span><span>        </span><span class="annot"><span class="annottext">(TableCoreCacheRT
   b (ExceptT QErr m) (SelPermInfo b, Seq SchemaDependency)
 -&gt; ExceptT QErr m (SelPermInfo b, Seq SchemaDependency))
-&gt; (ReaderT
      (SourceConfig b)
      (TableCoreCacheRT b (ExceptT QErr m))
      (SelPermInfo b, Seq SchemaDependency)
    -&gt; TableCoreCacheRT
         b (ExceptT QErr m) (SelPermInfo b, Seq SchemaDependency))
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (SelPermInfo b, Seq SchemaDependency)
-&gt; ExceptT QErr m (SelPermInfo b, Seq SchemaDependency)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   (SourceConfig b)
   (TableCoreCacheRT b (ExceptT QErr m))
   (SelPermInfo b, Seq SchemaDependency)
 -&gt; SourceConfig b
 -&gt; TableCoreCacheRT
      b (ExceptT QErr m) (SelPermInfo b, Seq SchemaDependency))
-&gt; SourceConfig b
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (SelPermInfo b, Seq SchemaDependency)
-&gt; TableCoreCacheRT
     b (ExceptT QErr m) (SelPermInfo b, Seq SchemaDependency)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT
  (SourceConfig b)
  (TableCoreCacheRT b (ExceptT QErr m))
  (SelPermInfo b, Seq SchemaDependency)
-&gt; SourceConfig b
-&gt; TableCoreCacheRT
     b (ExceptT QErr m) (SelPermInfo b, Seq SchemaDependency)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687980782"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-478"></span><span>        </span><span class="annot"><span class="annottext">(ReaderT
   (SourceConfig b)
   (TableCoreCacheRT b (ExceptT QErr m))
   (SelPermInfo b, Seq SchemaDependency)
 -&gt; ExceptT QErr m (SelPermInfo b, Seq SchemaDependency))
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (SelPermInfo b, Seq SchemaDependency)
-&gt; ExceptT QErr m (SelPermInfo b, Seq SchemaDependency)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LogicalModelFieldsLookupRT
   b
   (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
   (SelPermInfo b, Seq SchemaDependency)
 -&gt; (LogicalModelName
     -&gt; Maybe (InsOrdHashMap (Column b) (LogicalModelField b)))
 -&gt; ReaderT
      (SourceConfig b)
      (TableCoreCacheRT b (ExceptT QErr m))
      (SelPermInfo b, Seq SchemaDependency))
-&gt; (LogicalModelName
    -&gt; Maybe (InsOrdHashMap (Column b) (LogicalModelField b)))
-&gt; LogicalModelFieldsLookupRT
     b
     (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
     (SelPermInfo b, Seq SchemaDependency)
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (SelPermInfo b, Seq SchemaDependency)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">LogicalModelFieldsLookupRT
  b
  (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
  (SelPermInfo b, Seq SchemaDependency)
-&gt; (LogicalModelName
    -&gt; Maybe (InsOrdHashMap (Column b) (LogicalModelField b)))
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (SelPermInfo b, Seq SchemaDependency)
forall (b :: BackendType) (m :: * -&gt; *) a.
LogicalModelFieldsLookupRT b m a
-&gt; LogicalModelFieldsLookup b -&gt; m a
</span><a href="Hasura.LogicalModel.Fields.html#runLogicalModelFieldsLookupRT"><span class="hs-identifier hs-var">runLogicalModelFieldsLookupRT</span></a></span><span> </span><span class="annot"><span class="annottext">LogicalModelName
-&gt; Maybe (InsOrdHashMap (Column b) (LogicalModelField b))
</span><a href="#local-6989586621687980815"><span class="hs-identifier hs-var">logicalModels</span></a></span><span>
</span><span id="line-479"></span><span>        </span><span class="annot"><span class="annottext">(LogicalModelFieldsLookupRT
   b
   (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
   (SelPermInfo b, Seq SchemaDependency)
 -&gt; ReaderT
      (SourceConfig b)
      (TableCoreCacheRT b (ExceptT QErr m))
      (SelPermInfo b, Seq SchemaDependency))
-&gt; LogicalModelFieldsLookupRT
     b
     (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
     (SelPermInfo b, Seq SchemaDependency)
-&gt; ReaderT
     (SourceConfig b)
     (TableCoreCacheRT b (ExceptT QErr m))
     (SelPermInfo b, Seq SchemaDependency)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; LogicalModelLocation
-&gt; InsOrdHashMap (Column b) (LogicalModelField b)
-&gt; PermDefPermission b SelPerm
-&gt; LogicalModelFieldsLookupRT
     b
     (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
     (WithDeps (PermInfo SelPerm b))
forall (b :: BackendType) (m :: * -&gt; *) r
       (perm :: BackendType -&gt; *).
(BackendMetadata b, QErrM m, TableCoreInfoRM b m,
 LogicalModelFieldsRM b m, GetAggregationPredicatesDeps b,
 MonadReader r m, Has (ScalarTypeParsingContext b) r) =&gt;
SourceName
-&gt; LogicalModelLocation
-&gt; InsOrdHashMap (Column b) (LogicalModelField b)
-&gt; PermDefPermission b perm
-&gt; m (WithDeps (PermInfo perm b))
</span><a href="Hasura.RQL.DDL.Permission.html#buildLogicalModelPermInfo"><span class="hs-identifier hs-var">buildLogicalModelPermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687980781"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">LogicalModelLocation
</span><a href="#local-6989586621687980784"><span class="hs-identifier hs-var">logicalModelLocation</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap (Column b) (LogicalModelField b)
</span><a href="#local-6989586621687980785"><span class="hs-identifier hs-var">logicalModelFields</span></a></span><span>
</span><span id="line-480"></span><span>        </span><span class="annot"><span class="annottext">(PermDefPermission b SelPerm
 -&gt; LogicalModelFieldsLookupRT
      b
      (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
      (WithDeps (PermInfo SelPerm b)))
-&gt; PermDefPermission b SelPerm
-&gt; LogicalModelFieldsLookupRT
     b
     (ReaderT (SourceConfig b) (TableCoreCacheRT b (ExceptT QErr m)))
     (WithDeps (PermInfo SelPerm b))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SelPermDef b -&gt; PermDefPermission b SelPerm
forall (b :: BackendType) (perm :: BackendType -&gt; *).
PermDef b perm -&gt; PermDefPermission b perm
</span><a href="Hasura.RQL.Types.Permission.html#_pdPermission"><span class="hs-identifier hs-var">_pdPermission</span></a></span><span> </span><span class="annot"><span class="annottext">SelPermDef b
</span><a href="#local-6989586621687980786"><span class="hs-identifier hs-var">selectPermission</span></a></span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span>    </span><span class="annot"><span class="annottext">MetadataObject
-&gt; SchemaObjId -&gt; Seq SchemaDependency -&gt; ExceptT QErr m ()
forall (m :: * -&gt; *).
MonadWriter (Seq CollectItem) m =&gt;
MetadataObject -&gt; SchemaObjId -&gt; Seq SchemaDependency -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordDependenciesM"><span class="hs-identifier hs-var">recordDependenciesM</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621687980792"><span class="hs-identifier hs-var">metadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaObjId
</span><a href="#local-6989586621687980803"><span class="hs-identifier hs-var">schemaObject</span></a></span><span> </span><span class="annot"><span class="annottext">Seq SchemaDependency
</span><a href="#local-6989586621687980819"><span class="hs-identifier hs-var">dependencies</span></a></span><span>
</span><span id="line-483"></span><span>    </span><span class="annot"><span class="annottext">SelPermInfo b -&gt; ExceptT QErr m (SelPermInfo b)
forall a. a -&gt; ExceptT QErr m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SelPermInfo b
</span><a href="#local-6989586621687980818"><span class="hs-identifier hs-var">permissionInformation</span></a></span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span>  </span><span class="annot"><span class="annottext">RolePermInfo b -&gt; m (RolePermInfo b)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
forall (b :: BackendType).
Maybe (InsPermInfo b)
-&gt; Maybe (SelPermInfo b)
-&gt; Maybe (UpdPermInfo b)
-&gt; Maybe (DelPermInfo b)
-&gt; RolePermInfo b
</span><a href="Hasura.Table.Cache.html#RolePermInfo"><span class="hs-identifier hs-var">RolePermInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (InsPermInfo b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SelPermInfo b)
</span><a href="#local-6989586621687980817"><span class="hs-identifier hs-var">select</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UpdPermInfo b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe (DelPermInfo b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span></pre></body></html>