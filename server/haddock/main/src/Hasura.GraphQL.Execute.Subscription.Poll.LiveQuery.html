<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="annot"><span class="hs-comment">-- | Multiplexed subscription poller threads; see &quot;Hasura.GraphQL.Execute.Subscription&quot; for details.</span></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Pollers</span></span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pollLiveQuery"><span class="hs-identifier">pollLiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/hspec-core-2.10.10-de263ac8ebbf55c7971310f8a215d00129d22068c07959a0c97ad20b624c7172/share/doc/html/src/Control.Concurrent.Async.html"><span class="hs-identifier">Control.Concurrent.Async</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.html"><span class="hs-identifier">Control.Lens</span></a></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/aeson-ordered-0.1.0.0/opt/doc/html/aeson-ordered/src/Data.Aeson.Ordered.html"><span class="hs-identifier">Data.Aeson.Ordered</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">JO</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Strict.html"><span class="hs-identifier">Data.HashMap.Strict</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/split-0.2.3.5-810c9f4b27dff7f86631a6e5a76b673b410281589aee1a9c34999873f307b15e/share/doc/html/src/Data.List.Split.html"><span class="hs-identifier">Data.List.Split</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/split-0.2.3.5-810c9f4b27dff7f86631a6e5a76b673b410281589aee1a9c34999873f307b15e/share/doc/html/src/Data.List.Split.Internals.html#chunksOf"><span class="hs-identifier">chunksOf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Endo</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Sum</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/GHC.AssertNF.CPP.html"><span class="hs-identifier">GHC.AssertNF.CPP</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Backend</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Options</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Plan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#applyModifier"><span class="hs-identifier">applyModifier</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.Common</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier">Cohort</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortMap"><span class="hs-identifier">CohortMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier">CohortSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.Common</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.TMap.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.TMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TMap</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Types</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html"><span class="hs-identifier">Hasura.GraphQL.ParameterizedQueryHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier">ParameterizedQueryHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Transport.Backend</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP.Protocol</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#LogLevel"><span class="hs-identifier">LogLevel</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendTag.html"><span class="hs-identifier">Hasura.RQL.Types.BackendTag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.BackendTag.html#backendTag"><span class="hs-identifier">backendTag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendTag.html#reify"><span class="hs-identifier">reify</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html"><span class="hs-identifier">Hasura.RQL.Types.BackendType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#BackendType"><span class="hs-identifier">BackendType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#PostgresKind"><span class="hs-identifier">PostgresKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Vanilla"><span class="hs-identifier">Vanilla</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier">SourceName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html"><span class="hs-identifier">Hasura.RQL.Types.Roles</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier">RoleName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html"><span class="hs-identifier">Hasura.RQL.Types.Subscription</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#SubscriptionType"><span class="hs-identifier">SubscriptionType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html"><span class="hs-identifier">Hasura.Server.Prometheus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Prometheus.html#PrometheusMetrics"><span class="hs-identifier">PrometheusMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html#SubscriptionMetrics"><span class="hs-identifier">SubscriptionMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html#liveQuerySubscriptionLabel"><span class="hs-identifier">liveQuerySubscriptionLabel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html#recordSubcriptionMetric"><span class="hs-identifier">recordSubcriptionMetric</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#GranularPrometheusMetricsState"><span class="hs-identifier">GranularPrometheusMetricsState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html"><span class="hs-identifier">Refined</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#unrefine"><span class="hs-identifier">unrefine</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html"><span class="hs-identifier">System.Metrics.Prometheus.Gauge</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Prometheus.Gauge</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.HistogramVector.html"><span class="hs-identifier">System.Metrics.Prometheus.HistogramVector</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HistogramVector</span></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pushResultToCohort"><span class="hs-identifier hs-type">pushResultToCohort</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#GQResult"><span class="hs-identifier hs-type">GQResult</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-47"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-type">SubscriptionMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html#CohortSnapshot"><span class="hs-identifier hs-type">CohortSnapshot</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#LiveQuery"><span class="hs-identifier hs-type">LiveQuery</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-comment">-- | subscribers to which data has been pushed, subscribers which already</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-comment">-- have this data (this information is exposed by metrics reporting)</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span id="pushResultToCohort"><span class="annot"><span class="annottext">pushResultToCohort :: GQResult ByteString
-&gt; Maybe ResponseHash
-&gt; SubscriptionMetadata
-&gt; CohortSnapshot 'LiveQuery
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pushResultToCohort"><span class="hs-identifier hs-var hs-var">pushResultToCohort</span></a></span></span><span> </span><span id="local-6989586621687779402"><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621687779402"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621687779403"><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621687779403"><span class="hs-identifier hs-var">respHashM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-type">SubscriptionMetadata</span></a></span><span> </span><span id="local-6989586621687779405"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779405"><span class="hs-identifier hs-var">dTime</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621687779406"><span class="annot"><span class="annottext">CohortSnapshot 'LiveQuery
</span><a href="#local-6989586621687779406"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-54"></span><span>  </span><span id="local-6989586621687779407"><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621687779407"><span class="hs-identifier hs-var">prevRespHashM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash) -&gt; IO (Maybe ResponseHash)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621687779409"><span class="hs-identifier hs-var">respRef</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-comment">-- write to the current websockets if needed</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621687779410"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779410"><span class="hs-identifier hs-var">subscribersToPush</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779411"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779411"><span class="hs-identifier hs-var">subscribersToIgnore</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">GQResult ByteString -&gt; Bool
forall a. GQResult a -&gt; Bool
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#isExecError"><span class="hs-identifier hs-var">isExecError</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621687779402"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621687779403"><span class="hs-identifier hs-var">respHashM</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash -&gt; Maybe ResponseHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621687779407"><span class="hs-identifier hs-var">prevRespHashM</span></a></span><span>
</span><span id="line-58"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-59"></span><span>        </span><span class="hs-special">$</span><span class="annot"><span class="annottext">String
String -&gt; Maybe ResponseHash -&gt; IO ()
forall a. String -&gt; a -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ghc-heap-view-0.6.4-f3db7814b25c86ce10e8e9996b01c55915a4624099b8464adbe1f6a62fc2a06b/share/doc/html/src/GHC.AssertNF.html#assertNFNamed"><span class="hs-identifier hs-var">assertNFHere</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621687779403"><span class="hs-identifier hs-var">respHashM</span></a></span><span> </span><span class="hs-comment">-- so we don't write thunks to mutable vars</span><span>
</span><span id="line-60"></span><span>        </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-61"></span><span>          </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash) -&gt; Maybe ResponseHash -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621687779409"><span class="hs-identifier hs-var">respRef</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621687779403"><span class="hs-identifier hs-var">respHashM</span></a></span><span>
</span><span id="line-62"></span><span>        </span><span class="annot"><span class="annottext">([Subscriber], [Subscriber]) -&gt; IO ([Subscriber], [Subscriber])
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779418"><span class="hs-identifier hs-var">newSinks</span></a></span><span> </span><span class="annot"><span class="annottext">[Subscriber] -&gt; [Subscriber] -&gt; [Subscriber]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779419"><span class="hs-identifier hs-var">curSinks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">([Subscriber], [Subscriber]) -&gt; IO ([Subscriber], [Subscriber])
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779418"><span class="hs-identifier hs-var">newSinks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779419"><span class="hs-identifier hs-var">curSinks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><span class="annottext">[Subscriber] -&gt; IO ()
</span><a href="#local-6989586621687779420"><span class="hs-identifier hs-var">pushResultToSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779410"><span class="hs-identifier hs-var">subscribersToPush</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><span class="annottext">([SubscriberExecutionDetails], [SubscriberExecutionDetails])
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><span class="annottext">(([SubscriberExecutionDetails], [SubscriberExecutionDetails])
 -&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails]))
-&gt; ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  ([Subscriber], [Subscriber])
  ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
  Subscriber
  SubscriberExecutionDetails
-&gt; (Subscriber -&gt; SubscriberExecutionDetails)
-&gt; ([Subscriber], [Subscriber])
-&gt; ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.Setter.html#over"><span class="hs-identifier hs-var">over</span></a></span><span>
</span><span id="line-67"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([Subscriber] -&gt; Identity [SubscriberExecutionDetails])
-&gt; ([Subscriber], [Subscriber])
-&gt; Identity
     ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall s t a b. Each s t a b =&gt; Traversal s t a b
Traversal
  ([Subscriber], [Subscriber])
  ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
  [Subscriber]
  [SubscriberExecutionDetails]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.Each.html#each"><span class="hs-identifier hs-var">each</span></a></span><span> </span><span class="annot"><span class="annottext">(([Subscriber] -&gt; Identity [SubscriberExecutionDetails])
 -&gt; ([Subscriber], [Subscriber])
 -&gt; Identity
      ([SubscriberExecutionDetails], [SubscriberExecutionDetails]))
-&gt; ((Subscriber -&gt; Identity SubscriberExecutionDetails)
    -&gt; [Subscriber] -&gt; Identity [SubscriberExecutionDetails])
-&gt; ASetter
     ([Subscriber], [Subscriber])
     ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
     Subscriber
     SubscriberExecutionDetails
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Subscriber -&gt; Identity SubscriberExecutionDetails)
-&gt; [Subscriber] -&gt; Identity [SubscriberExecutionDetails]
forall s t a b. Each s t a b =&gt; Traversal s t a b
Traversal
  [Subscriber]
  [SubscriberExecutionDetails]
  Subscriber
  SubscriberExecutionDetails
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.Each.html#each"><span class="hs-identifier hs-var">each</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687779425"><span id="local-6989586621687779426"><span id="local-6989586621687779427"><span id="local-6989586621687779428"><span id="local-6989586621687779429"><span class="annot"><span class="annottext">Maybe OperationName
RequestId
SubscriberMetadata
SubscriberId
OnChange
_sId :: SubscriberId
_sMetadata :: SubscriberMetadata
_sRequestId :: RequestId
_sOperationName :: Maybe OperationName
_sOnChangeCallback :: OnChange
_sId :: Subscriber -&gt; SubscriberId
_sMetadata :: Subscriber -&gt; SubscriberMetadata
_sRequestId :: Subscriber -&gt; RequestId
_sOperationName :: Subscriber -&gt; Maybe OperationName
_sOnChangeCallback :: Subscriber -&gt; OnChange
</span><a href="#local-6989586621687779425"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-69"></span><span>          </span><span class="annot"><span class="annottext">SubscriberId -&gt; SubscriberMetadata -&gt; SubscriberExecutionDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-var">SubscriberExecutionDetails</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621687779425"><span class="hs-identifier hs-var">_sId</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMetadata
</span><a href="#local-6989586621687779426"><span class="hs-identifier hs-var">_sMetadata</span></a></span><span>
</span><span id="line-70"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779410"><span class="hs-identifier hs-var">subscribersToPush</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779411"><span class="hs-identifier hs-var">subscribersToIgnore</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier hs-type">C.CohortSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621687779409"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621687779409"><span class="hs-identifier hs-var">respRef</span></a></span></span><span> </span><span id="local-6989586621687779419"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779419"><span class="hs-identifier hs-var">curSinks</span></a></span></span><span> </span><span id="local-6989586621687779418"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621687779418"><span class="hs-identifier hs-var">newSinks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot 'LiveQuery
</span><a href="#local-6989586621687779406"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621687779437"><span class="annot"><span class="annottext">response :: Either GQExecError SubscriptionResponse
</span><a href="#local-6989586621687779437"><span class="hs-identifier hs-var hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621687779402"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
-&gt; (ByteString -&gt; SubscriptionResponse)
-&gt; Either GQExecError SubscriptionResponse
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; DiffTime -&gt; SubscriptionResponse
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionResponse"><span class="hs-operator hs-var">`SubscriptionResponse`</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779405"><span class="hs-identifier hs-var">dTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>    </span><span id="local-6989586621687779420"><span class="annot"><span class="annottext">pushResultToSubscribers :: [Subscriber] -&gt; IO ()
</span><a href="#local-6989586621687779420"><span class="hs-identifier hs-var hs-var">pushResultToSubscribers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-77"></span><span>      </span><span class="annot"><span class="annottext">(Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ()
forall (f :: * -&gt; *) a b. Foldable f =&gt; (a -&gt; IO b) -&gt; f a -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/async-2.2.4-745dffd9ca491716dc47acb47aea7b64658c47992a206a312129588089b2e389/share/doc/html/src/Control.Concurrent.Async.html#mapConcurrently_"><span class="hs-identifier hs-var">A.mapConcurrently_</span></a></span><span> </span><span class="annot"><span class="annottext">((Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ())
-&gt; (Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687779441"><span id="local-6989586621687779442"><span id="local-6989586621687779443"><span id="local-6989586621687779444"><span id="local-6989586621687779445"><span class="annot"><span class="annottext">Maybe OperationName
RequestId
SubscriberMetadata
SubscriberId
OnChange
_sId :: Subscriber -&gt; SubscriberId
_sMetadata :: Subscriber -&gt; SubscriberMetadata
_sRequestId :: Subscriber -&gt; RequestId
_sOperationName :: Subscriber -&gt; Maybe OperationName
_sOnChangeCallback :: Subscriber -&gt; OnChange
_sId :: SubscriberId
_sMetadata :: SubscriberMetadata
_sRequestId :: RequestId
_sOperationName :: Maybe OperationName
_sOnChangeCallback :: OnChange
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sId"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OnChange
</span><a href="#local-6989586621687779445"><span class="hs-identifier hs-var">_sOnChangeCallback</span></a></span><span> </span><span class="annot"><span class="annottext">Either GQExecError SubscriptionResponse
</span><a href="#local-6989586621687779437"><span class="hs-identifier hs-var">response</span></a></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-comment">-- | Where the magic happens: the top-level action run periodically by each</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- active 'Poller'. This needs to be async exception safe.</span><span>
</span><span id="line-81"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pollLiveQuery"><span class="hs-identifier hs-type">pollLiveQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621687779220"><span class="annot"><a href="#local-6989586621687779220"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html#BackendTransport"><span class="hs-identifier hs-type">BackendTransport</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687779220"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerId"><span class="hs-identifier hs-type">PollerId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-85"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM.TVar</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerResponseState"><span class="hs-identifier hs-type">PollerResponseState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#SubscriptionsOptions"><span class="hs-identifier hs-type">SubscriptionsOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687779220"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier hs-type">ParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#MultiplexedQuery"><span class="hs-identifier hs-type">MultiplexedQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687779220"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Types.html#CohortMap"><span class="hs-identifier hs-type">CohortMap</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Subscription.html#LiveQuery"><span class="hs-identifier hs-type">LiveQuery</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier hs-type">SubscriptionPostPollHook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#PrometheusMetrics"><span class="hs-identifier hs-type">PrometheusMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#GranularPrometheusMetricsState"><span class="hs-identifier hs-type">GranularPrometheusMetricsState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#TMap"><span class="hs-identifier hs-type">TMap.TMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#ResolvedConnectionTemplate"><span class="hs-identifier hs-type">ResolvedConnectionTemplate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687779220"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Endo</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/aeson-ordered-0.1.0.0/opt/doc/html/aeson-ordered/src/Data.Aeson.Ordered.html#Value"><span class="hs-identifier hs-type">JO.Value</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-98"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span id="pollLiveQuery"><span class="annot"><span class="annottext">pollLiveQuery :: forall (b :: BackendType).
BackendTransport b =&gt;
PollerId
-&gt; TVar PollerResponseState
-&gt; SubscriptionsOptions
-&gt; (SourceName, SourceConfig b)
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; MultiplexedQuery b
-&gt; CohortMap 'LiveQuery
-&gt; SubscriptionPostPollHook
-&gt; PrometheusMetrics
-&gt; IO GranularPrometheusMetricsState
-&gt; TMap (Maybe OperationName) Int
-&gt; ResolvedConnectionTemplate b
-&gt; Maybe (Endo Value)
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pollLiveQuery"><span class="hs-identifier hs-var hs-var">pollLiveQuery</span></a></span></span><span> </span><span id="local-6989586621687779549"><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621687779549"><span class="hs-identifier hs-var">pollerId</span></a></span></span><span> </span><span id="local-6989586621687779550"><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621687779550"><span class="hs-identifier hs-var">pollerResponseState</span></a></span></span><span> </span><span id="local-6989586621687779551"><span class="annot"><span class="annottext">SubscriptionsOptions
</span><a href="#local-6989586621687779551"><span class="hs-identifier hs-var">lqOpts</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687779552"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687779552"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779553"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687779553"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621687779554"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687779554"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621687779555"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621687779555"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span> </span><span id="local-6989586621687779556"><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621687779556"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span id="local-6989586621687779557"><span class="annot"><span class="annottext">CohortMap 'LiveQuery
</span><a href="#local-6989586621687779557"><span class="hs-identifier hs-var">cohortMap</span></a></span></span><span> </span><span id="local-6989586621687779558"><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621687779558"><span class="hs-identifier hs-var">postPollHook</span></a></span></span><span> </span><span id="local-6989586621687779559"><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621687779559"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span></span><span> </span><span id="local-6989586621687779560"><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687779560"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span></span><span> </span><span id="local-6989586621687779561"><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621687779561"><span class="hs-identifier hs-var">operationNamesMap'</span></a></span></span><span> </span><span id="local-6989586621687779562"><span class="annot"><span class="annottext">ResolvedConnectionTemplate b
</span><a href="#local-6989586621687779562"><span class="hs-identifier hs-var">resolvedConnectionTemplate</span></a></span></span><span> </span><span id="local-6989586621687779563"><span class="annot"><span class="annottext">Maybe (Endo Value)
</span><a href="#local-6989586621687779563"><span class="hs-identifier hs-var">modifier</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-100"></span><span>  </span><span id="local-6989586621687779564"><span class="annot"><span class="annottext">HashMap (Maybe OperationName) Int
</span><a href="#local-6989586621687779564"><span class="hs-identifier hs-var">operationNamesMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (HashMap (Maybe OperationName) Int)
-&gt; IO (HashMap (Maybe OperationName) Int)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (HashMap (Maybe OperationName) Int)
 -&gt; IO (HashMap (Maybe OperationName) Int))
-&gt; STM (HashMap (Maybe OperationName) Int)
-&gt; IO (HashMap (Maybe OperationName) Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
-&gt; STM (HashMap (Maybe OperationName) Int)
forall k v. TMap k v -&gt; STM (HashMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#getMap"><span class="hs-identifier hs-var">TMap.getMap</span></a></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621687779561"><span class="hs-identifier hs-var">operationNamesMap'</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621687779566"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779566"><span class="hs-identifier hs-var">totalTime</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687779567"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779567"><span class="hs-identifier hs-var">snapshotTime</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687779568"><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621687779568"><span class="hs-identifier hs-var">batchesDetails</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779569"><span class="annot"><span class="annottext">[Maybe PollDetailsError]
</span><a href="#local-6989586621687779569"><span class="hs-identifier hs-var">maybeErrors</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (DiffTime, ([BatchExecutionDetails], [Maybe PollDetailsError]))
-&gt; IO
     (DiffTime,
      (DiffTime, ([BatchExecutionDetails], [Maybe PollDetailsError])))
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (DiffTime, ([BatchExecutionDetails], [Maybe PollDetailsError]))
 -&gt; IO
      (DiffTime,
       (DiffTime, ([BatchExecutionDetails], [Maybe PollDetailsError]))))
-&gt; IO
     (DiffTime, ([BatchExecutionDetails], [Maybe PollDetailsError]))
-&gt; IO
     (DiffTime,
      (DiffTime, ([BatchExecutionDetails], [Maybe PollDetailsError])))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- snapshot the current cohorts and split them into batches</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621687779571"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779571"><span class="hs-identifier hs-var">snapshotTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779572"><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
</span><a href="#local-6989586621687779572"><span class="hs-identifier hs-var">cohortBatches</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO (DiffTime, [(BatchId, [(CohortId, CohortSnapshot)])])
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [(BatchId, [(CohortId, CohortSnapshot)])]
 -&gt; IO (DiffTime, [(BatchId, [(CohortId, CohortSnapshot)])]))
-&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO (DiffTime, [(BatchId, [(CohortId, CohortSnapshot)])])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-104"></span><span>      </span><span class="hs-comment">-- get a snapshot of all the cohorts</span><span>
</span><span id="line-105"></span><span>      </span><span class="hs-comment">-- this need not be done in a transaction</span><span>
</span><span id="line-106"></span><span>      </span><span id="local-6989586621687779573"><span class="annot"><span class="annottext">[(CohortVariables, Cohort ())]
</span><a href="#local-6989586621687779573"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM [(CohortVariables, Cohort ())]
-&gt; IO [(CohortVariables, Cohort ())]
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM [(CohortVariables, Cohort ())]
 -&gt; IO [(CohortVariables, Cohort ())])
-&gt; STM [(CohortVariables, Cohort ())]
-&gt; IO [(CohortVariables, Cohort ())]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort ())
-&gt; STM [(CohortVariables, Cohort ())]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort ())
CohortMap 'LiveQuery
</span><a href="#local-6989586621687779557"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-107"></span><span>      </span><span id="local-6989586621687779575"><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621687779575"><span class="hs-identifier hs-var">cohortSnapshots</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((CohortVariables, Cohort ()) -&gt; IO (CohortId, CohortSnapshot))
-&gt; [(CohortVariables, Cohort ())]
-&gt; IO [(CohortId, CohortSnapshot)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM (CohortId, CohortSnapshot) -&gt; IO (CohortId, CohortSnapshot)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (CohortId, CohortSnapshot) -&gt; IO (CohortId, CohortSnapshot))
-&gt; ((CohortVariables, Cohort ()) -&gt; STM (CohortId, CohortSnapshot))
-&gt; (CohortVariables, Cohort ())
-&gt; IO (CohortId, CohortSnapshot)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortVariables, Cohort ()) -&gt; STM (CohortId, CohortSnapshot)
</span><a href="#local-6989586621687779577"><span class="hs-identifier hs-var">getCohortSnapshot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortVariables, Cohort ())]
</span><a href="#local-6989586621687779573"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-comment">-- cohorts are broken down into batches specified by the batch size</span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779578"><span class="annot"><span class="annottext">cohortBatches :: [[(CohortId, CohortSnapshot)]]
</span><a href="#local-6989586621687779578"><span class="hs-identifier hs-var hs-var">cohortBatches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [(CohortId, CohortSnapshot)] -&gt; [[(CohortId, CohortSnapshot)]]
forall e. Int -&gt; [e] -&gt; [[e]]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/split-0.2.3.5-810c9f4b27dff7f86631a6e5a76b673b410281589aee1a9c34999873f307b15e/share/doc/html/src/Data.List.Split.Internals.html#chunksOf"><span class="hs-identifier hs-var">chunksOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Refined NonNegative Int -&gt; Int
forall {k} (p :: k) x. Refined p x -&gt; x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#unrefine"><span class="hs-identifier hs-var">unrefine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BatchSize -&gt; Refined NonNegative Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Options.html#unBatchSize"><span class="hs-identifier hs-var">unBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">BatchSize
</span><a href="#local-6989586621687779580"><span class="hs-identifier hs-var">batchSize</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621687779575"><span class="hs-identifier hs-var">cohortSnapshots</span></a></span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-comment">-- associating every batch with their BatchId</span><span>
</span><span id="line-111"></span><span>      </span><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])]
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([(BatchId, [(CohortId, CohortSnapshot)])]
 -&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])])
-&gt; [(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BatchId]
-&gt; [[(CohortId, CohortSnapshot)]]
-&gt; [(BatchId, [(CohortId, CohortSnapshot)])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; BatchId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchId"><span class="hs-identifier hs-var">BatchId</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; BatchId) -&gt; [Int] -&gt; [BatchId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[[(CohortId, CohortSnapshot)]]
</span><a href="#local-6989586621687779578"><span class="hs-identifier hs-var">cohortBatches</span></a></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-comment">-- concurrently process each batch</span><span>
</span><span id="line-114"></span><span>    </span><span id="local-6989586621687779583"><span class="annot"><span class="annottext">[(BatchExecutionDetails, Maybe PollDetailsError)]
</span><a href="#local-6989586621687779583"><span class="hs-identifier hs-var">batchesDetailsWithMaybeError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; ((BatchId, [(CohortId, CohortSnapshot)])
    -&gt; IO (BatchExecutionDetails, Maybe PollDetailsError))
-&gt; IO [(BatchExecutionDetails, Maybe PollDetailsError)]
forall (t :: * -&gt; *) a b.
Traversable t =&gt;
t a -&gt; (a -&gt; IO b) -&gt; IO (t b)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/async-2.2.4-745dffd9ca491716dc47acb47aea7b64658c47992a206a312129588089b2e389/share/doc/html/src/Control.Concurrent.Async.html#forConcurrently"><span class="hs-identifier hs-var">A.forConcurrently</span></a></span><span> </span><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
</span><a href="#local-6989586621687779572"><span class="hs-identifier hs-var">cohortBatches</span></a></span><span> </span><span class="annot"><span class="annottext">(((BatchId, [(CohortId, CohortSnapshot)])
  -&gt; IO (BatchExecutionDetails, Maybe PollDetailsError))
 -&gt; IO [(BatchExecutionDetails, Maybe PollDetailsError)])
-&gt; ((BatchId, [(CohortId, CohortSnapshot)])
    -&gt; IO (BatchExecutionDetails, Maybe PollDetailsError))
-&gt; IO [(BatchExecutionDetails, Maybe PollDetailsError)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687779585"><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621687779585"><span class="hs-identifier hs-var">batchId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779586"><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621687779586"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621687779587"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779587"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779588"><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString)]
</span><a href="#local-6989586621687779588"><span class="hs-identifier hs-var">mxRes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendTransport b, MonadIO m, MonadBaseControl IO m) =&gt;
SourceConfig b
-&gt; MultiplexedQuery b
-&gt; [(CohortId, CohortVariables)]
-&gt; ResolvedConnectionTemplate b
-&gt; m (DiffTime, Either QErr [(CohortId, ByteString)])
</span><a href="Hasura.GraphQL.Transport.Backend.html#runDBSubscription"><span class="hs-identifier hs-var">runDBSubscription</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687779220"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621687779553"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621687779556"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ASetter
  [(CohortId, CohortSnapshot)]
  [(CohortId, CohortVariables)]
  CohortSnapshot
  CohortVariables
-&gt; (CohortSnapshot -&gt; CohortVariables)
-&gt; [(CohortId, CohortSnapshot)]
-&gt; [(CohortId, CohortVariables)]
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.Setter.html#over"><span class="hs-identifier hs-var">over</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CohortId, CohortSnapshot)
 -&gt; Identity (CohortId, CohortVariables))
-&gt; [(CohortId, CohortSnapshot)]
-&gt; Identity [(CohortId, CohortVariables)]
forall s t a b. Each s t a b =&gt; Traversal s t a b
Traversal
  [(CohortId, CohortSnapshot)]
  [(CohortId, CohortVariables)]
  (CohortId, CohortSnapshot)
  (CohortId, CohortVariables)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.Each.html#each"><span class="hs-identifier hs-var">each</span></a></span><span> </span><span class="annot"><span class="annottext">(((CohortId, CohortSnapshot)
  -&gt; Identity (CohortId, CohortVariables))
 -&gt; [(CohortId, CohortSnapshot)]
 -&gt; Identity [(CohortId, CohortVariables)])
-&gt; ((CohortSnapshot -&gt; Identity CohortVariables)
    -&gt; (CohortId, CohortSnapshot)
    -&gt; Identity (CohortId, CohortVariables))
-&gt; ASetter
     [(CohortId, CohortSnapshot)]
     [(CohortId, CohortVariables)]
     CohortSnapshot
     CohortVariables
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortSnapshot -&gt; Identity CohortVariables)
-&gt; (CohortId, CohortSnapshot)
-&gt; Identity (CohortId, CohortVariables)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens
  (CohortId, CohortSnapshot)
  (CohortId, CohortVariables)
  CohortSnapshot
  CohortVariables
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/lens-5.2.2-c288f4ab3533e91c5d241152121e172474cc553aa524e32488a24b727cc130b5/share/doc/html/src/Control.Lens.Tuple.html#_2"><span class="hs-identifier hs-var">_2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csVariables"><span class="hs-identifier hs-var">C._csVariables</span></a></span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621687779586"><span class="hs-identifier hs-var">cohorts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ResolvedConnectionTemplate b
</span><a href="#local-6989586621687779562"><span class="hs-identifier hs-var">resolvedConnectionTemplate</span></a></span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779592"><span class="annot"><span class="annottext">dbExecTimeMetric :: HistogramVector SubscriptionLabel
</span><a href="#local-6989586621687779592"><span class="hs-identifier hs-var hs-var">dbExecTimeMetric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; HistogramVector SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#submDBExecTotalTime"><span class="hs-identifier hs-var">submDBExecTotalTime</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; HistogramVector SubscriptionLabel)
-&gt; SubscriptionMetrics -&gt; HistogramVector SubscriptionLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PrometheusMetrics -&gt; SubscriptionMetrics)
-&gt; PrometheusMetrics -&gt; SubscriptionMetrics
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621687779559"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; HashMap (Maybe OperationName) Int
-&gt; ParameterizedQueryHash
-&gt; SubscriptionKindLabel
-&gt; (SubscriptionLabel -&gt; IO ())
-&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; HashMap (Maybe OperationName) Int
-&gt; ParameterizedQueryHash
-&gt; SubscriptionKindLabel
-&gt; (SubscriptionLabel -&gt; IO ())
-&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#recordSubcriptionMetric"><span class="hs-identifier hs-var">recordSubcriptionMetric</span></a></span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687779560"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-120"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-121"></span><span>        </span><span class="annot"><span class="annottext">HashMap (Maybe OperationName) Int
</span><a href="#local-6989586621687779564"><span class="hs-identifier hs-var">operationNamesMap</span></a></span><span>
</span><span id="line-122"></span><span>        </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621687779555"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span class="annot"><span class="annottext">SubscriptionKindLabel
</span><a href="Hasura.Server.Prometheus.html#liveQuerySubscriptionLabel"><span class="hs-identifier hs-var">liveQuerySubscriptionLabel</span></a></span><span>
</span><span id="line-124"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubscriptionLabel -&gt; Double -&gt; IO ())
-&gt; Double -&gt; SubscriptionLabel -&gt; IO ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistogramVector SubscriptionLabel
-&gt; SubscriptionLabel -&gt; Double -&gt; IO ()
forall label.
Ord label =&gt;
HistogramVector label -&gt; label -&gt; Double -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.HistogramVector.html#observe"><span class="hs-identifier hs-var">HistogramVector.observe</span></a></span><span> </span><span class="annot"><span class="annottext">HistogramVector SubscriptionLabel
</span><a href="#local-6989586621687779592"><span class="hs-identifier hs-var">dbExecTimeMetric</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; Double
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779587"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span>      </span><span id="local-6989586621687779597"><span class="annot"><span class="annottext">PollerResponseState
</span><a href="#local-6989586621687779597"><span class="hs-identifier hs-var">previousPollerResponseState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState -&gt; IO PollerResponseState
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621687779550"><span class="hs-identifier hs-var">pollerResponseState</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>      </span><span id="local-6989586621687779598"><span class="annot"><span class="annottext">Maybe PollDetailsError
</span><a href="#local-6989586621687779598"><span class="hs-identifier hs-var">maybeError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString)]
</span><a href="#local-6989586621687779588"><span class="hs-identifier hs-var">mxRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-129"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687779599"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687779599"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="#local-6989586621687779597"><span class="hs-identifier hs-var">previousPollerResponseState</span></a></span><span> </span><span class="annot"><span class="annottext">PollerResponseState -&gt; PollerResponseState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PRSSuccess"><span class="hs-identifier hs-var">PRSSuccess</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-131"></span><span>            </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#inc"><span class="hs-identifier hs-var">Prometheus.Gauge.inc</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#submActiveLiveQueryPollersInError"><span class="hs-identifier hs-var">submActiveLiveQueryPollersInError</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; Gauge) -&gt; SubscriptionMetrics -&gt; Gauge
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621687779559"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-132"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState -&gt; PollerResponseState -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621687779550"><span class="hs-identifier hs-var">pollerResponseState</span></a></span><span> </span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PRSError"><span class="hs-identifier hs-var">PRSError</span></a></span><span>
</span><span id="line-133"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779605"><span class="annot"><span class="annottext">pollDetailsError :: PollDetailsError
</span><a href="#local-6989586621687779605"><span class="hs-identifier hs-var hs-var">pollDetailsError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-134"></span><span>                </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetailsError"><span class="hs-identifier hs-type">PollDetailsError</span></a></span><span>
</span><span id="line-135"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_pdeBatchId :: BatchId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdeBatchId"><span class="hs-identifier hs-var">_pdeBatchId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621687779585"><span class="hs-identifier hs-var">batchId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-136"></span><span>                    </span><span class="annot"><span class="annottext">_pdeErrorDetails :: QErr
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdeErrorDetails"><span class="hs-identifier hs-var">_pdeErrorDetails</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687779599"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-137"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>          </span><span class="annot"><span class="annottext">Maybe PollDetailsError -&gt; IO (Maybe PollDetailsError)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe PollDetailsError -&gt; IO (Maybe PollDetailsError))
-&gt; Maybe PollDetailsError -&gt; IO (Maybe PollDetailsError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PollDetailsError -&gt; Maybe PollDetailsError
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PollDetailsError
</span><a href="#local-6989586621687779605"><span class="hs-identifier hs-var">pollDetailsError</span></a></span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">[(CohortId, ByteString)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="#local-6989586621687779597"><span class="hs-identifier hs-var">previousPollerResponseState</span></a></span><span> </span><span class="annot"><span class="annottext">PollerResponseState -&gt; PollerResponseState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PRSError"><span class="hs-identifier hs-var">PRSError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>            </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#dec"><span class="hs-identifier hs-var">Prometheus.Gauge.dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#submActiveLiveQueryPollersInError"><span class="hs-identifier hs-var">submActiveLiveQueryPollersInError</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; Gauge) -&gt; SubscriptionMetrics -&gt; Gauge
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621687779559"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-142"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState -&gt; PollerResponseState -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621687779550"><span class="hs-identifier hs-var">pollerResponseState</span></a></span><span> </span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PRSSuccess"><span class="hs-identifier hs-var">PRSSuccess</span></a></span><span>
</span><span id="line-143"></span><span>          </span><span class="annot"><span class="annottext">Maybe PollDetailsError -&gt; IO (Maybe PollDetailsError)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe PollDetailsError
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779610"><span class="annot"><span class="annottext">lqMeta :: SubscriptionMetadata
</span><a href="#local-6989586621687779610"><span class="hs-identifier hs-var hs-var">lqMeta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; SubscriptionMetadata
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-var">SubscriptionMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; SubscriptionMetadata)
-&gt; DiffTime -&gt; SubscriptionMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime
forall x y. (Duration x, Duration y) =&gt; x -&gt; y
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Data.Time.Clock.Units.html#convertDuration"><span class="hs-identifier hs-var">convertDuration</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779587"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span><span>
</span><span id="line-146"></span><span>          </span><span id="local-6989586621687779612"><span class="annot"><span class="annottext">operations :: [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  CohortSnapshot)]
</span><a href="#local-6989586621687779612"><span class="hs-identifier hs-var hs-var">operations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
-&gt; Either QErr [(CohortId, ByteString)]
-&gt; [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)]
</span><a href="#local-6989586621687779613"><span class="hs-identifier hs-var">getCohortOperations</span></a></span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621687779586"><span class="hs-identifier hs-var">cohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString)]
</span><a href="#local-6989586621687779588"><span class="hs-identifier hs-var">mxRes</span></a></span><span>
</span><span id="line-147"></span><span>          </span><span class="hs-comment">-- batch response size is the sum of the response sizes of the cohorts</span><span>
</span><span id="line-148"></span><span>          </span><span id="local-6989586621687779614"><span class="annot"><span class="annottext">batchResponseSize :: Maybe Int
</span><a href="#local-6989586621687779614"><span class="hs-identifier hs-var hs-var">batchResponseSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-149"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString)]
</span><a href="#local-6989586621687779588"><span class="hs-identifier hs-var">mxRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-150"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-151"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687779615"><span class="annot"><span class="annottext">[(CohortId, ByteString)]
</span><a href="#local-6989586621687779615"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sum Int -&gt; Int
forall a. Sum a -&gt; a
</span><span class="hs-identifier hs-var">getSum</span></span><span> </span><span class="annot"><span class="annottext">(Sum Int -&gt; Int) -&gt; Sum Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((CohortId, ByteString) -&gt; Sum Int)
-&gt; [(CohortId, ByteString)] -&gt; Sum Int
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; [a] -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Sum Int
forall a. a -&gt; Sum a
</span><span class="hs-identifier hs-var">Sum</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Sum Int)
-&gt; ((CohortId, ByteString) -&gt; Int)
-&gt; (CohortId, ByteString)
-&gt; Sum Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Int)
-&gt; ((CohortId, ByteString) -&gt; ByteString)
-&gt; (CohortId, ByteString)
-&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortId, ByteString) -&gt; ByteString
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortId, ByteString)]
</span><a href="#local-6989586621687779615"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621687779621"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779621"><span class="hs-identifier hs-var">pushTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779622"><span class="annot"><span class="annottext">[CohortExecutionDetails]
</span><a href="#local-6989586621687779622"><span class="hs-identifier hs-var">cohortsExecutionDetails</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [CohortExecutionDetails]
-&gt; IO (DiffTime, [CohortExecutionDetails])
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span>
</span><span id="line-153"></span><span>        </span><span class="annot"><span class="annottext">(IO [CohortExecutionDetails]
 -&gt; IO (DiffTime, [CohortExecutionDetails]))
-&gt; IO [CohortExecutionDetails]
-&gt; IO (DiffTime, [CohortExecutionDetails])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  CohortSnapshot)]
-&gt; ((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)
    -&gt; IO CohortExecutionDetails)
-&gt; IO [CohortExecutionDetails]
forall (t :: * -&gt; *) a b.
Traversable t =&gt;
t a -&gt; (a -&gt; IO b) -&gt; IO (t b)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/async-2.2.4-745dffd9ca491716dc47acb47aea7b64658c47992a206a312129588089b2e389/share/doc/html/src/Control.Concurrent.Async.html#forConcurrently"><span class="hs-identifier hs-var">A.forConcurrently</span></a></span><span> </span><span class="annot"><span class="annottext">[(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  CohortSnapshot)]
</span><a href="#local-6989586621687779612"><span class="hs-identifier hs-var">operations</span></a></span><span>
</span><span id="line-154"></span><span>        </span><span class="annot"><span class="annottext">(((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
   CohortSnapshot)
  -&gt; IO CohortExecutionDetails)
 -&gt; IO [CohortExecutionDetails])
-&gt; ((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)
    -&gt; IO CohortExecutionDetails)
-&gt; IO [CohortExecutionDetails]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687779623"><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621687779623"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779624"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621687779624"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779625"><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621687779625"><span class="hs-identifier hs-var">respData</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779626"><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621687779626"><span class="hs-identifier hs-var">snapshot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-155"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621687779627"><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621687779627"><span class="hs-identifier hs-var">pushedSubscribers</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779628"><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621687779628"><span class="hs-identifier hs-var">ignoredSubscribers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-156"></span><span>            </span><span class="annot"><span class="annottext">GQResult ByteString
-&gt; Maybe ResponseHash
-&gt; SubscriptionMetadata
-&gt; CohortSnapshot 'LiveQuery
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pushResultToCohort"><span class="hs-identifier hs-var">pushResultToCohort</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621687779623"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; ResponseHash
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((ResponseHash, Int) -&gt; ResponseHash)
-&gt; Maybe (ResponseHash, Int) -&gt; Maybe ResponseHash
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621687779625"><span class="hs-identifier hs-var">respData</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetadata
</span><a href="#local-6989586621687779610"><span class="hs-identifier hs-var">lqMeta</span></a></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
CohortSnapshot 'LiveQuery
</span><a href="#local-6989586621687779626"><span class="hs-identifier hs-var">snapshot</span></a></span><span>
</span><span id="line-157"></span><span>          </span><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; IO CohortExecutionDetails
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-158"></span><span>            </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortExecutionDetails"><span class="hs-identifier hs-type">CohortExecutionDetails</span></a></span><span>
</span><span id="line-159"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_cedCohortId :: CohortId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedCohortId"><span class="hs-identifier hs-var">_cedCohortId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621687779624"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-160"></span><span>                </span><span class="annot"><span class="annottext">_cedVariables :: CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedVariables"><span class="hs-identifier hs-var">_cedVariables</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csVariables"><span class="hs-identifier hs-var">C._csVariables</span></a></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621687779626"><span class="hs-identifier hs-var">snapshot</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>                </span><span class="annot"><span class="annottext">_cedPushedTo :: [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedPushedTo"><span class="hs-identifier hs-var">_cedPushedTo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621687779627"><span class="hs-identifier hs-var">pushedSubscribers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>                </span><span class="annot"><span class="annottext">_cedIgnored :: [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedIgnored"><span class="hs-identifier hs-var">_cedIgnored</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621687779628"><span class="hs-identifier hs-var">ignoredSubscribers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-163"></span><span>                </span><span class="annot"><span class="annottext">_cedResponseSize :: Maybe Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedResponseSize"><span class="hs-identifier hs-var">_cedResponseSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; Int
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((ResponseHash, Int) -&gt; Int)
-&gt; Maybe (ResponseHash, Int) -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621687779625"><span class="hs-identifier hs-var">respData</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-164"></span><span>                </span><span class="annot"><span class="annottext">_cedBatchId :: BatchId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedBatchId"><span class="hs-identifier hs-var">_cedBatchId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621687779585"><span class="hs-identifier hs-var">batchId</span></a></span><span>
</span><span id="line-165"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-comment">-- Note: We want to keep the '_bedPgExecutionTime' field for backwards</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-comment">-- compatibility reason, which will be 'Nothing' for non-PG backends. See</span><span>
</span><span id="line-169"></span><span>      </span><span class="hs-comment">-- https://hasurahq.atlassian.net/browse/GS-329</span><span>
</span><span id="line-170"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779637"><span class="annot"><span class="annottext">pgExecutionTime :: Maybe DiffTime
</span><a href="#local-6989586621687779637"><span class="hs-identifier hs-var hs-var">pgExecutionTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BackendTag b -&gt; BackendType
forall (b :: BackendType). BackendTag b -&gt; BackendType
</span><a href="Hasura.RQL.Types.BackendTag.html#reify"><span class="hs-identifier hs-var">reify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). HasTag b =&gt; BackendTag b
</span><a href="Hasura.RQL.Types.BackendTag.html#backendTag"><span class="hs-identifier hs-var">backendTag</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621687779220"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-171"></span><span>            </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><span class="annottext">PostgresKind
</span><a href="Hasura.RQL.Types.BackendType.html#Vanilla"><span class="hs-identifier hs-var">Vanilla</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; Maybe DiffTime
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779587"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span><span>
</span><span id="line-172"></span><span>            </span><span class="annot"><span class="annottext">BackendType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe DiffTime
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-173"></span><span>          </span><span id="local-6989586621687779639"><span class="annot"><span class="annottext">batchExecDetails :: BatchExecutionDetails
</span><a href="#local-6989586621687779639"><span class="hs-identifier hs-var hs-var">batchExecDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-174"></span><span>            </span><span class="annot"><span class="annottext">Maybe DiffTime
-&gt; DiffTime
-&gt; DiffTime
-&gt; BatchId
-&gt; [CohortExecutionDetails]
-&gt; Maybe Int
-&gt; BatchExecutionDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchExecutionDetails"><span class="hs-identifier hs-var">BatchExecutionDetails</span></a></span><span>
</span><span id="line-175"></span><span>              </span><span class="annot"><span class="annottext">Maybe DiffTime
</span><a href="#local-6989586621687779637"><span class="hs-identifier hs-var">pgExecutionTime</span></a></span><span>
</span><span id="line-176"></span><span>              </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779587"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span><span>
</span><span id="line-177"></span><span>              </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779621"><span class="hs-identifier hs-var">pushTime</span></a></span><span>
</span><span id="line-178"></span><span>              </span><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621687779585"><span class="hs-identifier hs-var">batchId</span></a></span><span>
</span><span id="line-179"></span><span>              </span><span class="annot"><span class="annottext">[CohortExecutionDetails]
</span><a href="#local-6989586621687779622"><span class="hs-identifier hs-var">cohortsExecutionDetails</span></a></span><span>
</span><span id="line-180"></span><span>              </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621687779614"><span class="hs-identifier hs-var">batchResponseSize</span></a></span><span>
</span><span id="line-181"></span><span>      </span><span class="annot"><span class="annottext">(BatchExecutionDetails, Maybe PollDetailsError)
-&gt; IO (BatchExecutionDetails, Maybe PollDetailsError)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">((BatchExecutionDetails, Maybe PollDetailsError)
 -&gt; IO (BatchExecutionDetails, Maybe PollDetailsError))
-&gt; (BatchExecutionDetails, Maybe PollDetailsError)
-&gt; IO (BatchExecutionDetails, Maybe PollDetailsError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BatchExecutionDetails
</span><a href="#local-6989586621687779639"><span class="hs-identifier hs-var">batchExecDetails</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe PollDetailsError
</span><a href="#local-6989586621687779598"><span class="hs-identifier hs-var">maybeError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><span class="annottext">(DiffTime, ([BatchExecutionDetails], [Maybe PollDetailsError]))
-&gt; IO
     (DiffTime, ([BatchExecutionDetails], [Maybe PollDetailsError]))
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779571"><span class="hs-identifier hs-var">snapshotTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(BatchExecutionDetails, Maybe PollDetailsError)]
-&gt; ([BatchExecutionDetails], [Maybe PollDetailsError])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(BatchExecutionDetails, Maybe PollDetailsError)]
</span><a href="#local-6989586621687779583"><span class="hs-identifier hs-var">batchesDetailsWithMaybeError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779642"><span class="annot"><span class="annottext">initPollDetails :: PollDetails
</span><a href="#local-6989586621687779642"><span class="hs-identifier hs-var hs-var">initPollDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-184"></span><span>        </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span>
</span><span id="line-185"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_pdPollerId :: PollerId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdPollerId"><span class="hs-identifier hs-var">_pdPollerId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621687779549"><span class="hs-identifier hs-var">pollerId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-186"></span><span>            </span><span class="annot"><span class="annottext">_pdKind :: SubscriptionType
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdKind"><span class="hs-identifier hs-var">_pdKind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionType
</span><a href="Hasura.RQL.Types.Subscription.html#LiveQuery"><span class="hs-identifier hs-var">LiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><span class="annottext">_pdGeneratedSql :: Text
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdGeneratedSql"><span class="hs-identifier hs-var">_pdGeneratedSql</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621687779556"><span class="hs-identifier hs-var">query</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-188"></span><span>            </span><span class="annot"><span class="annottext">_pdSnapshotTime :: DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdSnapshotTime"><span class="hs-identifier hs-var">_pdSnapshotTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779567"><span class="hs-identifier hs-var">snapshotTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-189"></span><span>            </span><span class="annot"><span class="annottext">_pdBatches :: [BatchExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdBatches"><span class="hs-identifier hs-var">_pdBatches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621687779568"><span class="hs-identifier hs-var">batchesDetails</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-190"></span><span>            </span><span class="annot"><span class="annottext">_pdLiveQueryOptions :: SubscriptionsOptions
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdLiveQueryOptions"><span class="hs-identifier hs-var">_pdLiveQueryOptions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionsOptions
</span><a href="#local-6989586621687779551"><span class="hs-identifier hs-var">lqOpts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-191"></span><span>            </span><span class="annot"><span class="annottext">_pdTotalTime :: DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdTotalTime"><span class="hs-identifier hs-var">_pdTotalTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779566"><span class="hs-identifier hs-var">totalTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-192"></span><span>            </span><span class="annot"><span class="annottext">_pdSource :: SourceName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdSource"><span class="hs-identifier hs-var">_pdSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621687779552"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-193"></span><span>            </span><span class="annot"><span class="annottext">_pdRole :: RoleName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdRole"><span class="hs-identifier hs-var">_pdRole</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687779554"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-194"></span><span>            </span><span class="annot"><span class="annottext">_pdParameterizedQueryHash :: ParameterizedQueryHash
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdParameterizedQueryHash"><span class="hs-identifier hs-var">_pdParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621687779555"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-195"></span><span>            </span><span class="annot"><span class="annottext">_pdLogLevel :: LogLevel
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdLogLevel"><span class="hs-identifier hs-var">_pdLogLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-196"></span><span>            </span><span class="annot"><span class="annottext">_pdErrors :: Maybe [PollDetailsError]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdErrors"><span class="hs-identifier hs-var">_pdErrors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [PollDetailsError]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-197"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-198"></span><span>      </span><span id="local-6989586621687779658"><span class="annot"><span class="annottext">maybePollDetailsErrors :: Maybe [PollDetailsError]
</span><a href="#local-6989586621687779658"><span class="hs-identifier hs-var hs-var">maybePollDetailsErrors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe PollDetailsError] -&gt; Maybe [PollDetailsError]
forall (t :: * -&gt; *) (f :: * -&gt; *) a.
(Traversable t, Applicative f) =&gt;
t (f a) -&gt; f (t a)
forall (f :: * -&gt; *) a. Applicative f =&gt; [f a] -&gt; f [a]
</span><span class="hs-identifier hs-var">sequenceA</span></span><span> </span><span class="annot"><span class="annottext">[Maybe PollDetailsError]
</span><a href="#local-6989586621687779569"><span class="hs-identifier hs-var">maybeErrors</span></a></span><span>
</span><span id="line-199"></span><span>      </span><span id="local-6989586621687779660"><span class="annot"><span class="annottext">pollDetails :: PollDetails
</span><a href="#local-6989586621687779660"><span class="hs-identifier hs-var hs-var">pollDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [PollDetailsError]
</span><a href="#local-6989586621687779658"><span class="hs-identifier hs-var">maybePollDetailsErrors</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-200"></span><span>        </span><span class="annot"><span class="annottext">Maybe [PollDetailsError]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PollDetails
</span><a href="#local-6989586621687779642"><span class="hs-identifier hs-var">initPollDetails</span></a></span><span>
</span><span id="line-201"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621687779661"><span class="annot"><span class="annottext">[PollDetailsError]
</span><a href="#local-6989586621687779661"><span class="hs-identifier hs-var">pollDetailsErrors</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-202"></span><span>          </span><span class="annot"><span class="annottext">PollDetails
</span><a href="#local-6989586621687779642"><span class="hs-identifier hs-var">initPollDetails</span></a></span><span>
</span><span id="line-203"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_pdLogLevel :: LogLevel
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdLogLevel"><span class="hs-identifier hs-var">_pdLogLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">LevelError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-204"></span><span>              </span><span class="annot"><span class="annottext">_pdErrors :: Maybe [PollDetailsError]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdErrors"><span class="hs-identifier hs-var">_pdErrors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PollDetailsError] -&gt; Maybe [PollDetailsError]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[PollDetailsError]
</span><a href="#local-6989586621687779661"><span class="hs-identifier hs-var">pollDetailsErrors</span></a></span><span>
</span><span id="line-205"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621687779558"><span class="hs-identifier hs-var">postPollHook</span></a></span><span> </span><span class="annot"><span class="annottext">PollDetails
</span><a href="#local-6989586621687779660"><span class="hs-identifier hs-var">pollDetails</span></a></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779663"><span class="annot"><span class="annottext">totalTimeMetric :: HistogramVector SubscriptionLabel
</span><a href="#local-6989586621687779663"><span class="hs-identifier hs-var hs-var">totalTimeMetric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; HistogramVector SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#submTotalTime"><span class="hs-identifier hs-var">submTotalTime</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; HistogramVector SubscriptionLabel)
-&gt; SubscriptionMetrics -&gt; HistogramVector SubscriptionLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PrometheusMetrics -&gt; SubscriptionMetrics)
-&gt; PrometheusMetrics -&gt; SubscriptionMetrics
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621687779559"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; HashMap (Maybe OperationName) Int
-&gt; ParameterizedQueryHash
-&gt; SubscriptionKindLabel
-&gt; (SubscriptionLabel -&gt; IO ())
-&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState
-&gt; Bool
-&gt; HashMap (Maybe OperationName) Int
-&gt; ParameterizedQueryHash
-&gt; SubscriptionKindLabel
-&gt; (SubscriptionLabel -&gt; IO ())
-&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#recordSubcriptionMetric"><span class="hs-identifier hs-var">recordSubcriptionMetric</span></a></span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621687779560"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><span class="annottext">HashMap (Maybe OperationName) Int
</span><a href="#local-6989586621687779564"><span class="hs-identifier hs-var">operationNamesMap</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621687779555"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><span class="annottext">SubscriptionKindLabel
</span><a href="Hasura.Server.Prometheus.html#liveQuerySubscriptionLabel"><span class="hs-identifier hs-var">liveQuerySubscriptionLabel</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubscriptionLabel -&gt; Double -&gt; IO ())
-&gt; Double -&gt; SubscriptionLabel -&gt; IO ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistogramVector SubscriptionLabel
-&gt; SubscriptionLabel -&gt; Double -&gt; IO ()
forall label.
Ord label =&gt;
HistogramVector label -&gt; label -&gt; Double -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.HistogramVector.html#observe"><span class="hs-identifier hs-var">HistogramVector.observe</span></a></span><span> </span><span class="annot"><span class="annottext">HistogramVector SubscriptionLabel
</span><a href="#local-6989586621687779663"><span class="hs-identifier hs-var">totalTimeMetric</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; Double
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621687779566"><span class="hs-identifier hs-var">totalTime</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#SubscriptionsOptions"><span class="hs-identifier hs-type">SubscriptionsOptions</span></a></span><span> </span><span id="local-6989586621687779580"><span class="annot"><span class="annottext">BatchSize
</span><a href="#local-6989586621687779580"><span class="hs-identifier hs-var">batchSize</span></a></span></span><span> </span><span class="annot"><span class="annottext">RefetchInterval
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionsOptions
</span><a href="#local-6989586621687779551"><span class="hs-identifier hs-var">lqOpts</span></a></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621687779577"><span class="annot"><span class="annottext">getCohortSnapshot :: (CohortVariables, Cohort ()) -&gt; STM (CohortId, CohortSnapshot)
</span><a href="#local-6989586621687779577"><span class="hs-identifier hs-var hs-var">getCohortSnapshot</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687779676"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621687779676"><span class="hs-identifier hs-var">cohortVars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779677"><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621687779677"><span class="hs-identifier hs-var">handlerC</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-219"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-type">C.Cohort</span></a></span><span> </span><span id="local-6989586621687779679"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621687779679"><span class="hs-identifier hs-var">resId</span></a></span></span><span> </span><span id="local-6989586621687779680"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621687779680"><span class="hs-identifier hs-var">respRef</span></a></span></span><span> </span><span id="local-6989586621687779681"><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621687779681"><span class="hs-identifier hs-var">curOpsTV</span></a></span></span><span> </span><span id="local-6989586621687779682"><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621687779682"><span class="hs-identifier hs-var">newOpsTV</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621687779677"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-220"></span><span>      </span><span id="local-6989586621687779683"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621687779683"><span class="hs-identifier hs-var">curOpsL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621687779681"><span class="hs-identifier hs-var">curOpsTV</span></a></span><span>
</span><span id="line-221"></span><span>      </span><span id="local-6989586621687779684"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621687779684"><span class="hs-identifier hs-var">newOpsL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621687779682"><span class="hs-identifier hs-var">newOpsTV</span></a></span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
-&gt; ((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621687779684"><span class="hs-identifier hs-var">newOpsL</span></a></span><span> </span><span class="annot"><span class="annottext">(((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ())
-&gt; ((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687779686"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621687779686"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779687"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621687779687"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberId -&gt; SubscriberMap -&gt; STM ()
forall k v. Hashable k =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621687779687"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621687779686"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621687779681"><span class="hs-identifier hs-var">curOpsTV</span></a></span><span>
</span><span id="line-223"></span><span>      </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM ()
forall k v. TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#reset"><span class="hs-identifier hs-var">TMap.reset</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621687779682"><span class="hs-identifier hs-var">newOpsTV</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779690"><span class="annot"><span class="annottext">cohortSnapshot :: CohortSnapshot
</span><a href="#local-6989586621687779690"><span class="hs-identifier hs-var hs-var">cohortSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortVariables
-&gt; TVar (Maybe ResponseHash)
-&gt; [Subscriber]
-&gt; [Subscriber]
-&gt; CohortSnapshot
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier hs-var">C.CohortSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621687779676"><span class="hs-identifier hs-var">cohortVars</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621687779680"><span class="hs-identifier hs-var">respRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; Subscriber)
-&gt; [(SubscriberId, Subscriber)] -&gt; [Subscriber]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; Subscriber
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621687779683"><span class="hs-identifier hs-var">curOpsL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; Subscriber)
-&gt; [(SubscriberId, Subscriber)] -&gt; [Subscriber]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; Subscriber
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621687779684"><span class="hs-identifier hs-var">newOpsL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>      </span><span class="annot"><span class="annottext">(CohortId, CohortSnapshot) -&gt; STM (CohortId, CohortSnapshot)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621687779679"><span class="hs-identifier hs-var">resId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621687779690"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span>    </span><span id="local-6989586621687779613"><span class="annot"><span class="annottext">getCohortOperations :: [(CohortId, CohortSnapshot)]
-&gt; Either QErr [(CohortId, ByteString)]
-&gt; [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)]
</span><a href="#local-6989586621687779613"><span class="hs-identifier hs-var hs-var">getCohortOperations</span></a></span></span><span> </span><span id="local-6989586621687779691"><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621687779691"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-229"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687779692"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687779692"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-230"></span><span>        </span><span class="hs-comment">-- TODO: this is internal error</span><span>
</span><span id="line-231"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779693"><span class="annot"><span class="annottext">resp :: GQResult ByteString
</span><a href="#local-6989586621687779693"><span class="hs-identifier hs-var hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQExecError -&gt; GQResult ByteString
forall a. GQExecError -&gt; Either GQExecError a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(GQExecError -&gt; GQResult ByteString)
-&gt; GQExecError -&gt; GQResult ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Encoding] -&gt; GQExecError
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#GQExecError"><span class="hs-identifier hs-var">GQExecError</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Bool -&gt; QErr -&gt; Encoding
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#encodeGQLErr"><span class="hs-identifier hs-var">encodeGQLErr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687779692"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-232"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621687779693"><span class="hs-identifier hs-var">resp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621687779697"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621687779698"><span class="hs-identifier hs-var">snapshot</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687779697"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621687779697"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779698"><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621687779698"><span class="hs-identifier hs-var">snapshot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621687779691"><span class="hs-identifier hs-var">cohorts</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-233"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687779699"><span class="annot"><span class="annottext">[(CohortId, ByteString)]
</span><a href="#local-6989586621687779699"><span class="hs-identifier hs-var">responses</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779700"><span class="annot"><span class="annottext">cohortSnapshotMap :: HashMap CohortId CohortSnapshot
</span><a href="#local-6989586621687779700"><span class="hs-identifier hs-var hs-var">cohortSnapshotMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)] -&gt; HashMap CohortId CohortSnapshot
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.Strict.html#fromList"><span class="hs-identifier hs-var">HashMap.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621687779691"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">(((CohortId, ByteString)
  -&gt; Maybe
       (GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
        CohortSnapshot))
 -&gt; [(CohortId, ByteString)]
 -&gt; [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
      CohortSnapshot)])
-&gt; [(CohortId, ByteString)]
-&gt; ((CohortId, ByteString)
    -&gt; Maybe
         (GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
          CohortSnapshot))
-&gt; [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">((CohortId, ByteString)
 -&gt; Maybe
      (GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
       CohortSnapshot))
-&gt; [(CohortId, ByteString)]
-&gt; [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b.
Filterable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; f b
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/witherable-0.4.2-c348fd1be527fbb040281c624d4766fb2c04c7e7f3be298bbe123b3357fb1136/share/doc/html/src/Witherable.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[(CohortId, ByteString)]
</span><a href="#local-6989586621687779699"><span class="hs-identifier hs-var">responses</span></a></span><span> </span><span class="annot"><span class="annottext">(((CohortId, ByteString)
  -&gt; Maybe
       (GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
        CohortSnapshot))
 -&gt; [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
      CohortSnapshot)])
-&gt; ((CohortId, ByteString)
    -&gt; Maybe
         (GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
          CohortSnapshot))
-&gt; [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687779703"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621687779703"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687779704"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687779704"><span class="hs-identifier hs-var">respBS</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-236"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687779705"><span class="annot"><span class="annottext">respHash :: ResponseHash
</span><a href="#local-6989586621687779705"><span class="hs-identifier hs-var hs-var">respHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ResponseHash
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#mkRespHash"><span class="hs-identifier hs-var">mkRespHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687779704"><span class="hs-identifier hs-var">respBS</span></a></span><span>
</span><span id="line-237"></span><span>              </span><span id="local-6989586621687779707"><span class="annot"><span class="annottext">respSize :: Int
</span><a href="#local-6989586621687779707"><span class="hs-identifier hs-var hs-var">respSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687779704"><span class="hs-identifier hs-var">respBS</span></a></span><span>
</span><span id="line-238"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- TODO: currently we ignore the cases when the cohortId from</span><span>
</span><span id="line-239"></span><span>              </span><span class="hs-comment">-- Postgres response is not present in the cohort map of this batch</span><span>
</span><span id="line-240"></span><span>              </span><span class="hs-comment">-- (this shouldn't happen but if it happens it means a logic error and</span><span>
</span><span id="line-241"></span><span>              </span><span class="hs-comment">-- we should log it)</span><span>
</span><span id="line-242"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; GQResult ByteString
forall a. a -&gt; Either GQExecError a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Endo Value) -&gt; ByteString -&gt; ByteString
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#applyModifier"><span class="hs-identifier hs-var">applyModifier</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Endo Value)
</span><a href="#local-6989586621687779563"><span class="hs-identifier hs-var">modifier</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687779704"><span class="hs-identifier hs-var">respBS</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621687779703"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; Maybe (ResponseHash, Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResponseHash
</span><a href="#local-6989586621687779705"><span class="hs-identifier hs-var">respHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621687779707"><span class="hs-identifier hs-var">respSize</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>                </span><span class="annot"><span class="annottext">(CohortSnapshot
 -&gt; (GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot))
-&gt; Maybe CohortSnapshot
-&gt; Maybe
     (GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
      CohortSnapshot)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CohortId -&gt; HashMap CohortId CohortSnapshot -&gt; Maybe CohortSnapshot
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-fc2e0f1d37ef28cdf90ef4bc038ad0de1aaee4c64eb6ed4574eefbec08a983d1/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621687779703"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap CohortId CohortSnapshot
</span><a href="#local-6989586621687779700"><span class="hs-identifier hs-var">cohortSnapshotMap</span></a></span><span>
</span><span id="line-244"></span></pre></body></html>