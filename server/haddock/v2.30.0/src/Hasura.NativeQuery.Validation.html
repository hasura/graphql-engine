<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="annot"><span class="hs-comment">-- | Generic validation of native queries while tracking them.</span></span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.NativeQuery.Validation</span><span>
</span><span id="line-3"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.NativeQuery.Validation.html#validateArgumentDeclaration"><span class="hs-identifier">validateArgumentDeclaration</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-5"></span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-a5b4fa803c841f948b5080a5c7a22f4e3b108a71ab10582fd155001f6f7ca093/share/doc/html/src/Data.HashMap.Strict.html"><span class="hs-identifier">Data.HashMap.Strict</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Set</span></span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-error-message-1.0.0/opt/doc/html/hasura-error-message/src/Hasura.Base.ErrorMessage.html"><span class="hs-identifier">Hasura.Base.ErrorMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-error-message-1.0.0/opt/doc/html/hasura-error-message/src/Hasura.Base.ErrorMessage.html#fromErrorMessage"><span class="hs-identifier">fromErrorMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-error-message-1.0.0/opt/doc/html/hasura-error-message/src/Hasura.Base.ToErrorValue.html"><span class="hs-identifier">Hasura.Base.ToErrorValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-error-message-1.0.0/opt/doc/html/hasura-error-message/src/Hasura.Base.ToErrorValue.html#toErrorValue"><span class="hs-identifier">toErrorValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.NativeQuery.InterpolatedQuery.html"><span class="hs-identifier">Hasura.NativeQuery.InterpolatedQuery</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.NativeQuery.Metadata.html"><span class="hs-identifier">Hasura.NativeQuery.Metadata</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">first</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-comment">-- | Check that the set of declared arguments and the set of used arguments (in the code)</span><span>
</span><span id="line-18"></span><span class="hs-comment">--   is the same.</span><span>
</span><span id="line-19"></span><span id="local-6989586621687211529"><span id="local-6989586621687211533"><span class="annot"><a href="Hasura.NativeQuery.Validation.html#validateArgumentDeclaration"><span class="hs-identifier hs-type">validateArgumentDeclaration</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687211529"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687211529"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-21"></span><span>  </span><span class="annot"><a href="Hasura.NativeQuery.Metadata.html#NativeQueryMetadata"><span class="hs-identifier hs-type">NativeQueryMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687211533"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><a href="#local-6989586621687211529"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-23"></span><span id="validateArgumentDeclaration"><span class="annot"><span class="annottext">validateArgumentDeclaration :: forall (m :: * -&gt; *) (b :: BackendType).
(MonadIO m, MonadError QErr m) =&gt;
NativeQueryMetadata b -&gt; m ()
</span><a href="Hasura.NativeQuery.Validation.html#validateArgumentDeclaration"><span class="hs-identifier hs-var hs-var">validateArgumentDeclaration</span></a></span></span><span> </span><span class="annot"><a href="Hasura.NativeQuery.Metadata.html#NativeQueryMetadata"><span class="hs-identifier hs-type">NativeQueryMetadata</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687211597"><span class="annot"><span class="annottext">InterpolatedQuery ArgumentName
_nqmCode :: InterpolatedQuery ArgumentName
_nqmCode :: forall (b :: BackendType).
NativeQueryMetadata b -&gt; InterpolatedQuery ArgumentName
</span><a href="#local-6989586621687211597"><span class="hs-identifier hs-var hs-var">_nqmCode</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687211599"><span class="annot"><span class="annottext">HashMap ArgumentName (NullableScalarType b)
_nqmArguments :: HashMap ArgumentName (NullableScalarType b)
_nqmArguments :: forall (b :: BackendType).
NativeQueryMetadata b
-&gt; HashMap ArgumentName (NullableScalarType b)
</span><a href="#local-6989586621687211599"><span class="hs-identifier hs-var hs-var">_nqmArguments</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621687211601"><span class="hs-identifier hs-type">occurringArguments</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="Hasura.LogicalModelResolver.Types.html#ArgumentName"><span class="hs-identifier hs-type">ArgumentName</span></a></span><span>
</span><span id="line-25"></span><span>      </span><span id="local-6989586621687211601"><span class="annot"><span class="annottext">occurringArguments :: Set ArgumentName
</span><a href="#local-6989586621687211601"><span class="hs-identifier hs-var hs-var">occurringArguments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InterpolatedQuery ArgumentName -&gt; Set ArgumentName
forall var. Ord var =&gt; InterpolatedQuery var -&gt; Set var
</span><a href="Hasura.NativeQuery.InterpolatedQuery.html#getUniqueVariables"><span class="hs-identifier hs-var">getUniqueVariables</span></a></span><span> </span><span class="annot"><span class="annottext">InterpolatedQuery ArgumentName
</span><a href="#local-6989586621687211597"><span class="hs-identifier hs-var">_nqmCode</span></a></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span>      </span><span class="annot"><a href="#local-6989586621687211603"><span class="hs-identifier hs-type">declaredArguments</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="Hasura.LogicalModelResolver.Types.html#ArgumentName"><span class="hs-identifier hs-type">ArgumentName</span></a></span><span>
</span><span id="line-28"></span><span>      </span><span id="local-6989586621687211603"><span class="annot"><span class="annottext">declaredArguments :: Set ArgumentName
</span><a href="#local-6989586621687211603"><span class="hs-identifier hs-var hs-var">declaredArguments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgumentName] -&gt; Set ArgumentName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([ArgumentName] -&gt; Set ArgumentName)
-&gt; [ArgumentName] -&gt; Set ArgumentName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMap ArgumentName (NullableScalarType b) -&gt; [ArgumentName]
forall k v. HashMap k v -&gt; [k]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-a5b4fa803c841f948b5080a5c7a22f4e3b108a71ab10582fd155001f6f7ca093/share/doc/html/src/Data.HashMap.Internal.html#keys"><span class="hs-identifier hs-var">HashMap.keys</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ArgumentName (NullableScalarType b)
</span><a href="#local-6989586621687211599"><span class="hs-identifier hs-var">_nqmArguments</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span>      </span><span class="annot"><a href="#local-6989586621687211606"><span class="hs-identifier hs-type">undeclaredArguments</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="Hasura.LogicalModelResolver.Types.html#ArgumentName"><span class="hs-identifier hs-type">ArgumentName</span></a></span><span>
</span><span id="line-31"></span><span>      </span><span id="local-6989586621687211606"><span class="annot"><span class="annottext">undeclaredArguments :: Set ArgumentName
</span><a href="#local-6989586621687211606"><span class="hs-identifier hs-var hs-var">undeclaredArguments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set ArgumentName
</span><a href="#local-6989586621687211601"><span class="hs-identifier hs-var">occurringArguments</span></a></span><span> </span><span class="annot"><span class="annottext">Set ArgumentName -&gt; Set ArgumentName -&gt; Set ArgumentName
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`Set.difference`</span></span><span> </span><span class="annot"><span class="annottext">Set ArgumentName
</span><a href="#local-6989586621687211603"><span class="hs-identifier hs-var">declaredArguments</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span>      </span><span class="annot"><a href="#local-6989586621687211608"><span class="hs-identifier hs-type">unusedArguments</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="Hasura.LogicalModelResolver.Types.html#ArgumentName"><span class="hs-identifier hs-type">ArgumentName</span></a></span><span>
</span><span id="line-34"></span><span>      </span><span id="local-6989586621687211608"><span class="annot"><span class="annottext">unusedArguments :: Set ArgumentName
</span><a href="#local-6989586621687211608"><span class="hs-identifier hs-var hs-var">unusedArguments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set ArgumentName
</span><a href="#local-6989586621687211603"><span class="hs-identifier hs-var">declaredArguments</span></a></span><span> </span><span class="annot"><span class="annottext">Set ArgumentName -&gt; Set ArgumentName -&gt; Set ArgumentName
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`Set.difference`</span></span><span> </span><span class="annot"><span class="annottext">Set ArgumentName
</span><a href="#local-6989586621687211601"><span class="hs-identifier hs-var">occurringArguments</span></a></span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set ArgumentName -&gt; Bool
forall a. Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.null</span></span><span> </span><span class="annot"><span class="annottext">Set ArgumentName
</span><a href="#local-6989586621687211606"><span class="hs-identifier hs-var">undeclaredArguments</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; m ()
forall a. QErr -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><span class="annottext">(QErr -&gt; m ()) -&gt; QErr -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#err400"><span class="hs-identifier hs-var">err400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#ValidationFailed"><span class="hs-identifier hs-var">ValidationFailed</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="annottext">(Text -&gt; QErr) -&gt; Text -&gt; QErr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorMessage -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-error-message-1.0.0/opt/doc/html/hasura-error-message/src/Hasura.Base.ErrorMessage.html#fromErrorMessage"><span class="hs-identifier hs-var">fromErrorMessage</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="annottext">(ErrorMessage -&gt; Text) -&gt; ErrorMessage -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorMessage
</span><span class="hs-string">&quot;The following columns are used in the query, but are not declared as arguments: &quot;</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="annottext">ErrorMessage -&gt; ErrorMessage -&gt; ErrorMessage
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set ArgumentName -&gt; ErrorMessage
forall a. ToErrorValue a =&gt; a -&gt; ErrorMessage
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-error-message-1.0.0/opt/doc/html/hasura-error-message/src/Hasura.Base.ToErrorValue.html#toErrorValue"><span class="hs-identifier hs-var">toErrorValue</span></a></span><span> </span><span class="annot"><span class="annottext">Set ArgumentName
</span><a href="#local-6989586621687211606"><span class="hs-identifier hs-var">undeclaredArguments</span></a></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set ArgumentName -&gt; Bool
forall a. Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.null</span></span><span> </span><span class="annot"><span class="annottext">Set ArgumentName
</span><a href="#local-6989586621687211608"><span class="hs-identifier hs-var">unusedArguments</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; m ()
forall a. QErr -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="annottext">(QErr -&gt; m ()) -&gt; QErr -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#err400"><span class="hs-identifier hs-var">err400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#ValidationFailed"><span class="hs-identifier hs-var">ValidationFailed</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="annottext">(Text -&gt; QErr) -&gt; Text -&gt; QErr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorMessage -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-error-message-1.0.0/opt/doc/html/hasura-error-message/src/Hasura.Base.ErrorMessage.html#fromErrorMessage"><span class="hs-identifier hs-var">fromErrorMessage</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="annottext">(ErrorMessage -&gt; Text) -&gt; ErrorMessage -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorMessage
</span><span class="hs-string">&quot;The following columns are declared as arguments, but are not used in the query: &quot;</span></span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="annottext">ErrorMessage -&gt; ErrorMessage -&gt; ErrorMessage
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set ArgumentName -&gt; ErrorMessage
forall a. ToErrorValue a =&gt; a -&gt; ErrorMessage
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-error-message-1.0.0/opt/doc/html/hasura-error-message/src/Hasura.Base.ToErrorValue.html#toErrorValue"><span class="hs-identifier hs-var">toErrorValue</span></a></span><span> </span><span class="annot"><span class="annottext">Set ArgumentName
</span><a href="#local-6989586621687211608"><span class="hs-identifier hs-var">unusedArguments</span></a></span><span>
</span><span id="line-48"></span></pre></body></html>