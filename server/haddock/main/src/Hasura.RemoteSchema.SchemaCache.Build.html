<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Arrows #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.RemoteSchema.SchemaCache.Build</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemas"><span class="hs-identifier">buildRemoteSchemas</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Build.html#addRemoteSchemaP2Setup"><span class="hs-identifier">addRemoteSchemaP2Setup</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-7"></span><span class="hs-keyword">where</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Extended.html"><span class="hs-identifier">Control.Arrow.Extended</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Interpret.html"><span class="hs-identifier">Control.Arrow.Interpret</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/monad-control-1.0.3.1-b7641e5e6467aae2ffb36e8dd9c4b443e0d54b20f5b88407c4f64baad27c0cd1/share/doc/html/src/Control.Monad.Trans.Control.html"><span class="hs-identifier">Control.Monad.Trans.Control</span></a></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-eb2865ffe23f31228547a6f32a9edc574ee6a6324e10506583c4975c7f9d4b7b/share/doc/html/src/Data.Aeson.html"><span class="hs-identifier">Data.Aeson</span></a></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BL</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html"><span class="hs-identifier">Data.Environment</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Env</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.HashMap.Strict.Extended.html"><span class="hs-identifier">Data.HashMap.Strict.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-c1b0bc5939db4f075c6a7688c6244ff9a6bf720cfcf4ace60cc230967ee3783b/share/doc/html/src/Data.Text.html"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-json-encoding-1.0.0/opt/doc/html/hasura-json-encoding/src/Hasura.EncJSON.html"><span class="hs-identifier">Hasura.EncJSON</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-json-encoding-1.0.0/opt/doc/html/hasura-json-encoding/src/Hasura.EncJSON.html#encJFromLBS"><span class="hs-identifier">encJFromLBS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.RemoteServer.html"><span class="hs-identifier">Hasura.GraphQL.RemoteServer</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/incremental-1.0.0/opt/doc/html/incremental/src/Hasura.Incremental.html"><span class="hs-identifier">Hasura.Incremental</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Inc</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Common</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Permission</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata.Object</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html"><span class="hs-identifier">Hasura.RQL.Types.Roles</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html"><span class="hs-identifier">Hasura.RQL.Types.Roles.Internal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CheckPermission"><span class="hs-identifier">CheckPermission</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache.Build</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.html"><span class="hs-identifier">Hasura.RemoteSchema.Metadata</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Permission.html"><span class="hs-identifier">Hasura.RemoteSchema.SchemaCache.Permission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Permission.html#resolveRoleBasedRemoteSchema"><span class="hs-identifier">resolveRoleBasedRemoteSchema</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html"><span class="hs-identifier">Hasura.RemoteSchema.SchemaCache.Types</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Services.html"><span class="hs-identifier">Hasura.Services</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-comment">-- Resolves a user specified `RemoteSchemaMetadata` into information rich `RemoteSchemaCtx`</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- However, given the nature of remote relationships, we cannot fully 'resolve' them, so</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- we resolve of remote relationships as much as possible.</span><span>
</span><span id="line-40"></span><span id="local-6989586621687656283"><span id="local-6989586621687656289"><span id="local-6989586621687656293"><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemas"><span class="hs-identifier hs-type">buildRemoteSchemas</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621687656283"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/incremental-1.0.0/opt/doc/html/incremental/src/Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656283"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectItem"><span class="hs-identifier hs-type">CollectItem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687656283"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/incremental-1.0.0/opt/doc/html/incremental/src/Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656289"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656283"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687656289"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/monad-control-1.0.3.1-b7641e5e6467aae2ffb36e8dd9c4b443e0d54b20f5b88407c4f64baad27c0cd1/share/doc/html/src/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621687656289"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621687656293"><span class="hs-identifier hs-type">remoteRelationshipDefinition</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-eb2865ffe23f31228547a6f32a9edc574ee6a6324e10506583c4975c7f9d4b7b/share/doc/html/src/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656293"><span class="hs-identifier hs-type">remoteRelationshipDefinition</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656289"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><a href="Hasura.Services.Network.html#ProvidesNetwork"><span class="hs-identifier hs-type">ProvidesNetwork</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656289"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/incremental-1.0.0/opt/doc/html/incremental/src/Hasura.Incremental.Internal.Dependency.html#Dependency"><span class="hs-identifier hs-type">Inc.Dependency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-8335dfa2c360fbc99338d79b59c29f0e55b38395ab008163a5f9c1bb67e3a4b4/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/incremental-1.0.0/opt/doc/html/incremental/src/Hasura.Incremental.html#InvalidationKey"><span class="hs-identifier hs-type">Inc.InvalidationKey</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-8335dfa2c360fbc99338d79b59c29f0e55b38395ab008163a5f9c1bb67e3a4b4/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Core.html#RemoteSchemaMetadataG"><span class="hs-identifier hs-type">RemoteSchemaMetadataG</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656293"><span class="hs-identifier hs-type">remoteRelationshipDefinition</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="#local-6989586621687656283"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-8335dfa2c360fbc99338d79b59c29f0e55b38395ab008163a5f9c1bb67e3a4b4/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#PartiallyResolvedRemoteSchemaCtxG"><span class="hs-identifier hs-type">PartiallyResolvedRemoteSchemaCtxG</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656293"><span class="hs-identifier hs-type">remoteRelationshipDefinition</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-58"></span><span id="buildRemoteSchemas"><span class="annot"><span class="annottext">buildRemoteSchemas :: forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *)
       remoteRelationshipDefinition.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectItem) arr, ArrowCache m arr, MonadIO m,
 MonadBaseControl IO m, Eq remoteRelationshipDefinition,
 ToJSON remoteRelationshipDefinition, MonadError QErr m,
 ProvidesNetwork m) =&gt;
Logger Hasura
-&gt; Environment
-&gt; arr
     ((Dependency (HashMap RemoteSchemaName InvalidationKey),
       OrderedRoles, Maybe (HashMap RemoteSchemaName ByteString)),
      [RemoteSchemaMetadataG remoteRelationshipDefinition])
     (HashMap
        RemoteSchemaName
        (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition,
         MetadataObject))
</span><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemas"><span class="hs-identifier hs-var hs-var">buildRemoteSchemas</span></a></span></span><span> </span><span id="local-6989586621687656678"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687656678"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621687656679"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621687656679"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><span class="annottext">(RemoteSchemaMetadataG remoteRelationshipDefinition
 -&gt; RemoteSchemaName)
-&gt; (RemoteSchemaMetadataG remoteRelationshipDefinition
    -&gt; MetadataObject)
-&gt; arr
     ((Dependency (HashMap RemoteSchemaName InvalidationKey),
       OrderedRoles, Maybe (HashMap RemoteSchemaName ByteString)),
      RemoteSchemaMetadataG remoteRelationshipDefinition)
     (Maybe
        (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition))
-&gt; arr
     ((Dependency (HashMap RemoteSchemaName InvalidationKey),
       OrderedRoles, Maybe (HashMap RemoteSchemaName ByteString)),
      [RemoteSchemaMetadataG remoteRelationshipDefinition])
     (HashMap
        RemoteSchemaName
        (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition,
         MetadataObject))
forall (arr :: * -&gt; * -&gt; *) k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectItem) arr, Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k (b, MetadataObject))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMapPreservingMetadata"><span class="hs-identifier hs-var">buildInfoMapPreservingMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadataG remoteRelationshipDefinition
-&gt; RemoteSchemaName
forall r. RemoteSchemaMetadataG r -&gt; RemoteSchemaName
</span><a href="Hasura.RemoteSchema.Metadata.Core.html#_rsmName"><span class="hs-identifier hs-var">_rsmName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadataG remoteRelationshipDefinition
-&gt; MetadataObject
forall {r}. ToJSON r =&gt; RemoteSchemaMetadataG r -&gt; MetadataObject
</span><a href="#local-6989586621687656682"><span class="hs-identifier hs-var">mkRemoteSchemaMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">arr
  ((Dependency (HashMap RemoteSchemaName InvalidationKey),
    OrderedRoles, Maybe (HashMap RemoteSchemaName ByteString)),
   RemoteSchemaMetadataG remoteRelationshipDefinition)
  (Maybe
     (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition))
</span><a href="#local-6989586621687656683"><span class="hs-identifier hs-var">buildRemoteSchema</span></a></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-comment">-- We want to cache this call because it fetches the remote schema over</span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-comment">-- HTTP, and we don&#8217;t want to re-run that if the remote schema definition</span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-comment">-- hasn&#8217;t changed.</span><span>
</span><span id="line-64"></span><span>    </span><span id="local-6989586621687656683"><span class="annot"><span class="annottext">buildRemoteSchema :: arr
  ((Dependency (HashMap RemoteSchemaName InvalidationKey),
    OrderedRoles, Maybe (HashMap RemoteSchemaName ByteString)),
   RemoteSchemaMetadataG remoteRelationshipDefinition)
  (Maybe
     (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition))
</span><a href="#local-6989586621687656683"><span class="hs-identifier hs-var hs-var">buildRemoteSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">arr
  ((Dependency (HashMap RemoteSchemaName InvalidationKey),
    OrderedRoles, Maybe (HashMap RemoteSchemaName ByteString)),
   RemoteSchemaMetadataG remoteRelationshipDefinition)
  (Maybe
     (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition))
-&gt; arr
     ((Dependency (HashMap RemoteSchemaName InvalidationKey),
       OrderedRoles, Maybe (HashMap RemoteSchemaName ByteString)),
      RemoteSchemaMetadataG remoteRelationshipDefinition)
     (Maybe
        (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition))
forall a b. (Given Accesses =&gt; Eq a) =&gt; arr a b -&gt; arr a b
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a b.
(ArrowCache m arr, Given Accesses =&gt; Eq a) =&gt;
arr a b -&gt; arr a b
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/incremental-1.0.0/opt/doc/html/incremental/src/Hasura.Incremental.Internal.Cache.html#cache"><span class="hs-identifier hs-var">Inc.cache</span></a></span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621687656685"><span class="annot"><span class="annottext">Dependency (HashMap RemoteSchemaName InvalidationKey)
</span><a href="#local-6989586621687656685"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656686"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621687656686"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656687"><span class="annot"><span class="annottext">Maybe (HashMap RemoteSchemaName ByteString)
</span><a href="#local-6989586621687656687"><span class="hs-identifier hs-var">storedIntrospection</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656688"><span class="annot"><span class="annottext">remoteSchema :: RemoteSchemaMetadataG remoteRelationshipDefinition
</span><a href="#local-6989586621687656688"><span class="hs-identifier hs-var">remoteSchema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Core.html#RemoteSchemaMetadata"><span class="hs-identifier hs-type">RemoteSchemaMetadata</span></a></span><span> </span><span id="local-6989586621687656690"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656690"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621687656691"><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621687656691"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span id="local-6989586621687656692"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621687656692"><span class="hs-identifier hs-var">_comment</span></a></span></span><span> </span><span id="local-6989586621687656693"><span class="annot"><span class="annottext">[RemoteSchemaPermissionMetadata]
</span><a href="#local-6989586621687656693"><span class="hs-identifier hs-var">permissions</span></a></span></span><span> </span><span id="local-6989586621687656694"><span class="annot"><span class="annottext">SchemaRemoteRelationships remoteRelationshipDefinition
</span><a href="#local-6989586621687656694"><span class="hs-identifier hs-var">relationships</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-65"></span><span>      </span><span class="annot"><span class="annottext">arr (Dependency (Maybe InvalidationKey)) (Maybe InvalidationKey)
forall a. Eq a =&gt; arr (Dependency a) a
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
(ArrowCache m arr, Eq a) =&gt;
arr (Dependency a) a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/incremental-1.0.0/opt/doc/html/incremental/src/Hasura.Incremental.Internal.Cache.html#dependOn"><span class="hs-identifier hs-var">Inc.dependOn</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
-&gt; Dependency (HashMap RemoteSchemaName InvalidationKey)
-&gt; Dependency (Maybe InvalidationKey)
forall a k v.
(Select a, Selector a ~ ConstS k v) =&gt;
k -&gt; Dependency a -&gt; Dependency v
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/incremental-1.0.0/opt/doc/html/incremental/src/Hasura.Incremental.Internal.Dependency.html#selectKeyD"><span class="hs-identifier hs-var">Inc.selectKeyD</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656690"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Dependency (HashMap RemoteSchemaName InvalidationKey)
</span><a href="#local-6989586621687656685"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span>
</span><span id="line-66"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687656697"><span class="annot"><span class="annottext">metadataObj :: MetadataObject
</span><a href="#local-6989586621687656697"><span class="hs-identifier hs-var hs-var">metadataObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadataG remoteRelationshipDefinition
-&gt; MetadataObject
forall {r}. ToJSON r =&gt; RemoteSchemaMetadataG r -&gt; MetadataObject
</span><a href="#local-6989586621687656682"><span class="hs-identifier hs-var">mkRemoteSchemaMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadataG remoteRelationshipDefinition
</span><a href="#local-6989586621687656688"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span>
</span><span id="line-67"></span><span>      </span><span id="local-6989586621687656698"><span class="annot"><span class="annottext">Either QErr (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621687656698"><span class="hs-identifier hs-var">upstreamResponse</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  (m (Either
        QErr (IntrospectionResult, ByteString, RemoteSchemaInfo)))
  (Either QErr (IntrospectionResult, ByteString, RemoteSchemaInfo))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr m (IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; m (Either
        QErr (IntrospectionResult, ByteString, RemoteSchemaInfo))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TraceT
  (ExceptT QErr m)
  (IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; ExceptT
     QErr m (IntrospectionResult, ByteString, RemoteSchemaInfo)
forall {m :: * -&gt; *} {a}. TraceT m a -&gt; m a
</span><a href="#local-6989586621687656701"><span class="hs-identifier hs-var">noopTrace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceT
   (ExceptT QErr m)
   (IntrospectionResult, ByteString, RemoteSchemaInfo)
 -&gt; ExceptT
      QErr m (IntrospectionResult, ByteString, RemoteSchemaInfo))
-&gt; TraceT
     (ExceptT QErr m)
     (IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; ExceptT
     QErr m (IntrospectionResult, ByteString, RemoteSchemaInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Environment
-&gt; RemoteSchemaDef
-&gt; TraceT
     (ExceptT QErr m)
     (IntrospectionResult, ByteString, RemoteSchemaInfo)
forall (m :: * -&gt; *).
(QErrM m, MonadIO m, ProvidesNetwork m, MonadTrace m) =&gt;
Environment
-&gt; RemoteSchemaDef
-&gt; m (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="Hasura.RemoteSchema.SchemaCache.Build.html#addRemoteSchemaP2Setup"><span class="hs-identifier hs-var">addRemoteSchemaP2Setup</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621687656679"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621687656691"><span class="hs-identifier hs-var">defn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>      </span><span id="local-6989586621687656702"><span class="annot"><span class="annottext">Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621687656702"><span class="hs-identifier hs-var">remoteSchemaContextParts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-69"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621687656698"><span class="hs-identifier hs-var">upstreamResponse</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-70"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687656703"><span class="annot"><span class="annottext">upstream :: (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621687656703"><span class="hs-identifier hs-var">upstream</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntrospectionResult
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656704"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687656704"><span class="hs-identifier hs-var">byteString</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-71"></span><span>            </span><span class="hs-comment">-- Collect upstream introspection response to persist in the storage</span><span>
</span><span id="line-72"></span><span>            </span><span class="annot"><span class="annottext">arr (Seq CollectItem) ()
forall w (arr :: * -&gt; * -&gt; *). ArrowWriter w arr =&gt; arr w ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Trans.html#tellA"><span class="hs-identifier hs-var">tellA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">CollectItem -&gt; Seq CollectItem
forall a. a -&gt; Seq a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StoredIntrospectionItem -&gt; CollectItem
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectStoredIntrospection"><span class="hs-identifier hs-var">CollectStoredIntrospection</span></a></span><span> </span><span class="annot"><span class="annottext">(StoredIntrospectionItem -&gt; CollectItem)
-&gt; StoredIntrospectionItem -&gt; CollectItem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; EncJSON -&gt; StoredIntrospectionItem
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#RemoteSchemaIntrospectionItem"><span class="hs-identifier hs-var">RemoteSchemaIntrospectionItem</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656690"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(EncJSON -&gt; StoredIntrospectionItem)
-&gt; EncJSON -&gt; StoredIntrospectionItem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; EncJSON
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-json-encoding-1.0.0/opt/doc/html/hasura-json-encoding/src/Hasura.EncJSON.html#encJFromLBS"><span class="hs-identifier hs-var">encJFromLBS</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687656704"><span class="hs-identifier hs-var">byteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>            </span><span class="annot"><span class="annottext">arr
  (Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo))
  (Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">(IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621687656703"><span class="hs-identifier hs-var">upstream</span></a></span><span>
</span><span id="line-74"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687656709"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687656709"><span class="hs-identifier hs-var">upstreamError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-75"></span><span>            </span><span class="hs-comment">-- If upstream is not available, try to lookup from stored introspection</span><span>
</span><span id="line-76"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName
-&gt; HashMap RemoteSchemaName ByteString -&gt; Maybe ByteString
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-8335dfa2c360fbc99338d79b59c29f0e55b38395ab008163a5f9c1bb67e3a4b4/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656690"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap RemoteSchemaName ByteString -&gt; Maybe ByteString)
-&gt; Maybe (HashMap RemoteSchemaName ByteString) -&gt; Maybe ByteString
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (HashMap RemoteSchemaName ByteString)
</span><a href="#local-6989586621687656687"><span class="hs-identifier hs-var">storedIntrospection</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-77"></span><span>              </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-78"></span><span>                </span><span class="hs-comment">-- If no stored introspection exist, re-throw the upstream exception</span><span>
</span><span id="line-79"></span><span>                </span><span class="hs-glyph">(|</span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (a, ())
  (IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; arr
     (a, (MetadataObject, ()))
     (Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo))
forall {a}.
ErrorA
  QErr
  arr
  (a, ())
  (IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; arr
     (a, (MetadataObject, ()))
     (Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo))
forall (arr :: * -&gt; * -&gt; *) e s a.
(ArrowChoice arr, ArrowWriter (Seq CollectItem) arr) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorA
  QErr arr QErr (IntrospectionResult, ByteString, RemoteSchemaInfo)
forall a. ErrorA QErr arr QErr a
forall e (arr :: * -&gt; * -&gt; *) a. ArrowError e arr =&gt; arr e a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Trans.html#throwA"><span class="hs-identifier hs-var">throwA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687656709"><span class="hs-identifier hs-var">upstreamError</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621687656697"><span class="hs-identifier hs-var">metadataObj</span></a></span><span>
</span><span id="line-80"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621687656716"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687656716"><span class="hs-identifier hs-var">storedRawIntrospection</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-81"></span><span>                </span><span id="local-6989586621687656717"><span class="annot"><span class="annottext">Either QErr (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621687656717"><span class="hs-identifier hs-var">processedIntrospection</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-82"></span><span>                  </span><span class="annot"><span class="annottext">arr
  (m (Either
        QErr (IntrospectionResult, ByteString, RemoteSchemaInfo)))
  (Either QErr (IntrospectionResult, ByteString, RemoteSchemaInfo))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-83"></span><span>                    </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr m (IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; m (Either
        QErr (IntrospectionResult, ByteString, RemoteSchemaInfo))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-84"></span><span>                      </span><span id="local-6989586621687656718"><span class="annot"><span class="annottext">ValidatedRemoteSchemaDef
</span><a href="#local-6989586621687656718"><span class="hs-identifier hs-var">rsDef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Environment
-&gt; RemoteSchemaDef -&gt; ExceptT QErr m ValidatedRemoteSchemaDef
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
Environment -&gt; RemoteSchemaDef -&gt; m ValidatedRemoteSchemaDef
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#validateRemoteSchemaDef"><span class="hs-identifier hs-var">validateRemoteSchemaDef</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621687656679"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621687656691"><span class="hs-identifier hs-var">defn</span></a></span><span>
</span><span id="line-85"></span><span>                      </span><span class="hs-special">(</span><span id="local-6989586621687656720"><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656720"><span class="hs-identifier hs-var">ir</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656721"><span class="annot"><span class="annottext">RemoteSchemaInfo
</span><a href="#local-6989586621687656721"><span class="hs-identifier hs-var">rsi</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; ValidatedRemoteSchemaDef
-&gt; ExceptT QErr m (IntrospectionResult, RemoteSchemaInfo)
forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
ByteString
-&gt; ValidatedRemoteSchemaDef
-&gt; m (IntrospectionResult, RemoteSchemaInfo)
</span><a href="Hasura.GraphQL.RemoteServer.html#stitchRemoteSchema"><span class="hs-identifier hs-var">stitchRemoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687656716"><span class="hs-identifier hs-var">storedRawIntrospection</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedRemoteSchemaDef
</span><a href="#local-6989586621687656718"><span class="hs-identifier hs-var">rsDef</span></a></span><span>
</span><span id="line-86"></span><span>                      </span><span class="annot"><span class="annottext">(IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; ExceptT
     QErr m (IntrospectionResult, ByteString, RemoteSchemaInfo)
forall a. a -&gt; ExceptT QErr m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656720"><span class="hs-identifier hs-var">ir</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687656716"><span class="hs-identifier hs-var">storedRawIntrospection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaInfo
</span><a href="#local-6989586621687656721"><span class="hs-identifier hs-var">rsi</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621687656717"><span class="hs-identifier hs-var">processedIntrospection</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-88"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687656723"><span class="annot"><span class="annottext">(IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621687656723"><span class="hs-identifier hs-var">processed</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-89"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687656724"><span class="annot"><span class="annottext">inconsistencyMessage :: Text
</span><a href="#local-6989586621687656724"><span class="hs-identifier hs-var hs-var">inconsistencyMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-90"></span><span>                          </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/text-2.0.1-c1b0bc5939db4f075c6a7688c6244ff9a6bf720cfcf4ace60cc230967ee3783b/share/doc/html/src/Data.Text.html#unwords"><span class="hs-identifier hs-var">T.unwords</span></a></span><span>
</span><span id="line-91"></span><span>                            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;remote schema &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; RemoteSchemaName -&gt; Text
forall t. ToTxt t =&gt; Text -&gt; t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3E%3E"><span class="hs-operator hs-var">&lt;&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656690"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-92"></span><span>                              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; is inconsistent because of stale remote schema introspection is used.&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-93"></span><span>                              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;The remote schema couldn't be reached for a fresh introspection&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>                              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;because we got error: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#qeError"><span class="hs-identifier hs-var">qeError</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687656709"><span class="hs-identifier hs-var">upstreamError</span></a></span><span>
</span><span id="line-95"></span><span>                            </span><span class="hs-special">]</span><span>
</span><span id="line-96"></span><span>                    </span><span class="hs-comment">-- Still record inconsistency to notify the user obout the usage of stored stale data</span><span>
</span><span id="line-97"></span><span>                    </span><span class="annot"><span class="annottext">arr ((Maybe Value, [MetadataObject]), Text) ()
forall (arr :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(ArrowWriter (Seq CollectItem) arr, Functor f, Foldable f) =&gt;
arr ((Maybe Value, f MetadataObject), Text) ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordInconsistencies"><span class="hs-identifier hs-var">recordInconsistencies</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; Maybe Value) -&gt; Value -&gt; Maybe Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe QErrExtra -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-eb2865ffe23f31228547a6f32a9edc574ee6a6324e10506583c4975c7f9d4b7b/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">toJSON</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QErr -&gt; Maybe QErrExtra
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#qeInternal"><span class="hs-identifier hs-var">qeInternal</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687656709"><span class="hs-identifier hs-var">upstreamError</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621687656697"><span class="hs-identifier hs-var">metadataObj</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687656724"><span class="hs-identifier hs-var">inconsistencyMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>                    </span><span class="annot"><span class="annottext">arr (m ()) ()
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621687656678"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StoredIntrospectionLog -&gt; m ()) -&gt; StoredIntrospectionLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; QErr -&gt; StoredIntrospectionLog
</span><a href="Hasura.Logging.html#StoredIntrospectionLog"><span class="hs-identifier hs-var">StoredIntrospectionLog</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Using stored introspection for remote schema &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; RemoteSchemaName -&gt; Text
forall t. ToTxt t =&gt; Text -&gt; t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3E%3E"><span class="hs-operator hs-var">&lt;&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656690"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687656709"><span class="hs-identifier hs-var">upstreamError</span></a></span><span>
</span><span id="line-99"></span><span>                    </span><span class="annot"><span class="annottext">arr
  (Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo))
  (Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">(IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621687656723"><span class="hs-identifier hs-var">processed</span></a></span><span>
</span><span id="line-100"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687656733"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687656733"><span class="hs-identifier hs-var">_processError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-101"></span><span>                    </span><span class="hs-comment">-- Unable to process stored introspection, give up and re-throw upstream exception</span><span>
</span><span id="line-102"></span><span>                    </span><span class="hs-glyph">(|</span><span> </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (a, ())
  (IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; arr
     (a, (MetadataObject, ()))
     (Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo))
forall {a}.
ErrorA
  QErr
  arr
  (a, ())
  (IntrospectionResult, ByteString, RemoteSchemaInfo)
-&gt; arr
     (a, (MetadataObject, ()))
     (Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo))
forall (arr :: * -&gt; * -&gt; *) e s a.
(ArrowChoice arr, ArrowWriter (Seq CollectItem) arr) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorA
  QErr arr QErr (IntrospectionResult, ByteString, RemoteSchemaInfo)
forall a. ErrorA QErr arr QErr a
forall e (arr :: * -&gt; * -&gt; *) a. ArrowError e arr =&gt; arr e a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Trans.html#throwA"><span class="hs-identifier hs-var">throwA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687656709"><span class="hs-identifier hs-var">upstreamError</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621687656697"><span class="hs-identifier hs-var">metadataObj</span></a></span><span>
</span><span id="line-103"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621687656702"><span class="hs-identifier hs-var">remoteSchemaContextParts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-104"></span><span>        </span><span class="annot"><span class="annottext">Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">arr
  (Maybe
     (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition))
  (Maybe
     (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Maybe
  (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-105"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687656736"><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656736"><span class="hs-identifier hs-var">introspection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656737"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687656737"><span class="hs-identifier hs-var">rawIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656738"><span class="annot"><span class="annottext">RemoteSchemaInfo
</span><a href="#local-6989586621687656738"><span class="hs-identifier hs-var">remoteSchemaInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>          </span><span class="hs-comment">-- we then resolve permissions</span><span>
</span><span id="line-107"></span><span>          </span><span id="local-6989586621687656739"><span class="annot"><span class="annottext">HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621687656739"><span class="hs-identifier hs-var">resolvedPermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">arr
  ((RemoteSchemaName, IntrospectionResult, OrderedRoles),
   [(RemoteSchemaName, RemoteSchemaPermissionMetadata)])
  (HashMap RoleName IntrospectionResult)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectItem) arr, ArrowKleisli m arr,
 MonadError QErr m) =&gt;
arr
  ((RemoteSchemaName, IntrospectionResult, OrderedRoles),
   [(RemoteSchemaName, RemoteSchemaPermissionMetadata)])
  (HashMap RoleName IntrospectionResult)
</span><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemaPermissions"><span class="hs-identifier hs-var">buildRemoteSchemaPermissions</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656690"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656736"><span class="hs-identifier hs-var">introspection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621687656686"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaPermissionMetadata
 -&gt; (RemoteSchemaName, RemoteSchemaPermissionMetadata))
-&gt; [RemoteSchemaPermissionMetadata]
-&gt; [(RemoteSchemaName, RemoteSchemaPermissionMetadata)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656690"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[RemoteSchemaPermissionMetadata]
</span><a href="#local-6989586621687656693"><span class="hs-identifier hs-var">permissions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>          </span><span class="hs-comment">-- resolve remote relationships</span><span>
</span><span id="line-109"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687656741"><span class="annot"><span class="annottext">transformedRelationships :: InsOrdHashMap
  Name
  (InsOrdHashMap
     RelName
     (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition))
</span><a href="#local-6989586621687656741"><span class="hs-identifier hs-var hs-var">transformedRelationships</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SchemaRemoteRelationships remoteRelationshipDefinition
</span><a href="#local-6989586621687656694"><span class="hs-identifier hs-var">relationships</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaRemoteRelationships remoteRelationshipDefinition
-&gt; (RemoteSchemaTypeRelationships remoteRelationshipDefinition
    -&gt; InsOrdHashMap
         RelName
         (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition))
-&gt; InsOrdHashMap
     Name
     (InsOrdHashMap
        RelName
        (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition))
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.RemoteRelationship.html#RemoteSchemaTypeRelationships"><span class="hs-identifier hs-type">RemoteSchemaTypeRelationships</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687656744"><span id="local-6989586621687656745"><span class="annot"><span class="annottext">Name
RemoteRelationships remoteRelationshipDefinition
_rstrsName :: Name
_rstrsRelationships :: RemoteRelationships remoteRelationshipDefinition
_rstrsName :: forall r. RemoteSchemaTypeRelationships r -&gt; Name
_rstrsRelationships :: forall r. RemoteSchemaTypeRelationships r -&gt; RemoteRelationships r
</span><a href="#local-6989586621687656744"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; RemoteRelationshipG remoteRelationshipDefinition
-&gt; PartiallyResolvedRemoteRelationship remoteRelationshipDefinition
forall remoteRelationshipDefinition.
Name
-&gt; RemoteRelationshipG remoteRelationshipDefinition
-&gt; PartiallyResolvedRemoteRelationship remoteRelationshipDefinition
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#PartiallyResolvedRemoteRelationship"><span class="hs-identifier hs-var">PartiallyResolvedRemoteRelationship</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621687656744"><span class="hs-identifier hs-var">_rstrsName</span></a></span><span> </span><span class="annot"><span class="annottext">(RemoteRelationshipG remoteRelationshipDefinition
 -&gt; PartiallyResolvedRemoteRelationship
      remoteRelationshipDefinition)
-&gt; RemoteRelationships remoteRelationshipDefinition
-&gt; InsOrdHashMap
     RelName
     (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RemoteRelationships remoteRelationshipDefinition
</span><a href="#local-6989586621687656745"><span class="hs-identifier hs-var">_rstrsRelationships</span></a></span><span>
</span><span id="line-110"></span><span>              </span><span id="local-6989586621687656750"><span class="annot"><span class="annottext">remoteSchemaContext :: PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition
</span><a href="#local-6989586621687656750"><span class="hs-identifier hs-var hs-var">remoteSchemaContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-111"></span><span>                </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#RemoteSchemaCtx"><span class="hs-identifier hs-type">RemoteSchemaCtx</span></a></span><span>
</span><span id="line-112"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_rscName :: RemoteSchemaName
</span><a href="#local-6989586621687656752"><span class="hs-identifier hs-var">_rscName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656690"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>                    </span><span class="annot"><span class="annottext">_rscIntroOriginal :: IntrospectionResult
</span><a href="#local-6989586621687656753"><span class="hs-identifier hs-var">_rscIntroOriginal</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656736"><span class="hs-identifier hs-var">introspection</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-114"></span><span>                    </span><span class="annot"><span class="annottext">_rscInfo :: RemoteSchemaInfo
</span><a href="#local-6989586621687656754"><span class="hs-identifier hs-var">_rscInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaInfo
</span><a href="#local-6989586621687656738"><span class="hs-identifier hs-var">remoteSchemaInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-115"></span><span>                    </span><span class="annot"><span class="annottext">_rscRawIntrospectionResult :: ByteString
</span><a href="#local-6989586621687656755"><span class="hs-identifier hs-var">_rscRawIntrospectionResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621687656737"><span class="hs-identifier hs-var">rawIntrospection</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-116"></span><span>                    </span><span class="annot"><span class="annottext">_rscPermissions :: HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621687656756"><span class="hs-identifier hs-var">_rscPermissions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621687656739"><span class="hs-identifier hs-var">resolvedPermissions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-117"></span><span>                    </span><span class="annot"><span class="annottext">_rscRemoteRelationships :: InsOrdHashMap
  Name
  (InsOrdHashMap
     RelName
     (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition))
</span><a href="#local-6989586621687656757"><span class="hs-identifier hs-var">_rscRemoteRelationships</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap
  Name
  (InsOrdHashMap
     RelName
     (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition))
</span><a href="#local-6989586621687656741"><span class="hs-identifier hs-var">transformedRelationships</span></a></span><span>
</span><span id="line-118"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-119"></span><span>          </span><span class="annot"><span class="annottext">arr
  (Maybe
     (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition))
  (Maybe
     (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition))
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition
-&gt; Maybe
     (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition
</span><a href="#local-6989586621687656750"><span class="hs-identifier hs-var">remoteSchemaContext</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-comment">-- TODO continue propagating MonadTrace up calls so that we can get tracing</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-comment">-- for remote schema introspection. This will require modifying CacheBuild.</span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">-- TODO(Antoine): do this when changing CacheBuild to be on top of the app's m.</span><span>
</span><span id="line-124"></span><span>    </span><span id="local-6989586621687656701"><span class="annot"><span class="annottext">noopTrace :: TraceT m a -&gt; m a
</span><a href="#local-6989586621687656701"><span class="hs-identifier hs-var hs-var">noopTrace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TraceT m a -&gt; m a
forall {m :: * -&gt; *} {a}. TraceT m a -&gt; m a
</span><a href="Hasura.Tracing.Monad.html#ignoreTraceT"><span class="hs-identifier hs-var">Tracing.ignoreTraceT</span></a></span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621687656682"><span class="annot"><span class="annottext">mkRemoteSchemaMetadataObject :: RemoteSchemaMetadataG r -&gt; MetadataObject
</span><a href="#local-6989586621687656682"><span class="hs-identifier hs-var hs-var">mkRemoteSchemaMetadataObject</span></a></span></span><span> </span><span id="local-6989586621687656765"><span class="annot"><span class="annottext">RemoteSchemaMetadataG r
</span><a href="#local-6989586621687656765"><span class="hs-identifier hs-var">remoteSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-127"></span><span>      </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MORemoteSchema"><span class="hs-identifier hs-var">MORemoteSchema</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaMetadataG r -&gt; RemoteSchemaName
forall r. RemoteSchemaMetadataG r -&gt; RemoteSchemaName
</span><a href="Hasura.RemoteSchema.Metadata.Core.html#_rsmName"><span class="hs-identifier hs-var">_rsmName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadataG r
</span><a href="#local-6989586621687656765"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaMetadataG r -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-eb2865ffe23f31228547a6f32a9edc574ee6a6324e10506583c4975c7f9d4b7b/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadataG r
</span><a href="#local-6989586621687656765"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="annot"><span class="hs-comment">-- | Resolves a RemoteSchemaPermission metadata object into a 'GraphQL schema'.</span></span><span>
</span><span id="line-130"></span><span id="local-6989586621687656433"><span id="local-6989586621687656434"><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemaPermissions"><span class="hs-identifier hs-type">buildRemoteSchemaPermissions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ArrowChoice</span></span><span> </span><span class="annot"><a href="#local-6989586621687656433"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-132"></span><span>    </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/incremental-1.0.0/opt/doc/html/incremental/src/Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656433"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-133"></span><span>    </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CollectItem"><span class="hs-identifier hs-type">CollectItem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687656433"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Extended.html#ArrowKleisli"><span class="hs-identifier hs-type">ArrowKleisli</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656433"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656434"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-comment">-- this ridiculous duplication of [(RemoteSchemaName, RemoteSchemaPermissionMetadata)]</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-comment">-- instead of just [RemoteSchemaName] is because buildInfoMap doesn't pass `e` to the</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-comment">-- mkMetadataObject function. However, that change is very invasive.</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#IntrospectionResult"><span class="hs-identifier hs-type">IntrospectionResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Permission.html#RemoteSchemaPermissionMetadata"><span class="hs-identifier hs-type">RemoteSchemaPermissionMetadata</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621687656433"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-8335dfa2c360fbc99338d79b59c29f0e55b38395ab008163a5f9c1bb67e3a4b4/share/doc/html/src/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap.HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#IntrospectionResult"><span class="hs-identifier hs-type">IntrospectionResult</span></a></span></span></span><span>
</span><span id="line-141"></span><span id="buildRemoteSchemaPermissions"><span class="annot"><span class="annottext">buildRemoteSchemaPermissions :: forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectItem) arr, ArrowKleisli m arr,
 MonadError QErr m) =&gt;
arr
  ((RemoteSchemaName, IntrospectionResult, OrderedRoles),
   [(RemoteSchemaName, RemoteSchemaPermissionMetadata)])
  (HashMap RoleName IntrospectionResult)
</span><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemaPermissions"><span class="hs-identifier hs-var hs-var">buildRemoteSchemaPermissions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621687656843"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656843"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656844"><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656844"><span class="hs-identifier hs-var">originalIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656845"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621687656845"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656846"><span class="annot"><span class="annottext">[(RemoteSchemaName, RemoteSchemaPermissionMetadata)]
</span><a href="#local-6989586621687656846"><span class="hs-identifier hs-var">permissions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>  </span><span id="local-6989586621687656847"><span class="annot"><span class="annottext">HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621687656847"><span class="hs-identifier hs-var">metadataPermissionsMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><span class="annottext">((RemoteSchemaName, RemoteSchemaPermissionMetadata) -&gt; RoleName)
-&gt; ((RemoteSchemaName, RemoteSchemaPermissionMetadata)
    -&gt; MetadataObject)
-&gt; arr
     (IntrospectionResult,
      (RemoteSchemaName, RemoteSchemaPermissionMetadata))
     (Maybe IntrospectionResult)
-&gt; arr
     (IntrospectionResult,
      [(RemoteSchemaName, RemoteSchemaPermissionMetadata)])
     (HashMap RoleName IntrospectionResult)
forall (arr :: * -&gt; * -&gt; *) k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq CollectItem) arr, Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMap"><span class="hs-identifier hs-var">buildInfoMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaPermissionMetadata -&gt; RoleName
</span><a href="Hasura.RemoteSchema.Metadata.Permission.html#_rspmRole"><span class="hs-identifier hs-var">_rspmRole</span></a></span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaPermissionMetadata -&gt; RoleName)
-&gt; ((RemoteSchemaName, RemoteSchemaPermissionMetadata)
    -&gt; RemoteSchemaPermissionMetadata)
-&gt; (RemoteSchemaName, RemoteSchemaPermissionMetadata)
-&gt; RoleName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaName, RemoteSchemaPermissionMetadata)
-&gt; RemoteSchemaPermissionMetadata
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaName, RemoteSchemaPermissionMetadata)
-&gt; MetadataObject
</span><a href="#local-6989586621687656852"><span class="hs-identifier hs-var">mkRemoteSchemaPermissionMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">arr
  (IntrospectionResult,
   (RemoteSchemaName, RemoteSchemaPermissionMetadata))
  (Maybe IntrospectionResult)
</span><a href="#local-6989586621687656853"><span class="hs-identifier hs-var">buildRemoteSchemaPermission</span></a></span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-145"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656844"><span class="hs-identifier hs-var">originalIntrospection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(RemoteSchemaName, RemoteSchemaPermissionMetadata)]
</span><a href="#local-6989586621687656846"><span class="hs-identifier hs-var">permissions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-comment">-- convert to the intermediate form `CheckPermission` whose `Semigroup`</span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-comment">-- instance is used to combine permissions</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687656854"><span class="annot"><span class="annottext">metadataCheckPermissionsMap :: HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621687656854"><span class="hs-identifier hs-var hs-var">metadataCheckPermissionsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntrospectionResult -&gt; CheckPermission IntrospectionResult
forall permissionType.
permissionType -&gt; CheckPermission permissionType
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPDefined"><span class="hs-identifier hs-var">CPDefined</span></a></span><span> </span><span class="annot"><span class="annottext">(IntrospectionResult -&gt; CheckPermission IntrospectionResult)
-&gt; HashMap RoleName IntrospectionResult
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621687656847"><span class="hs-identifier hs-var">metadataPermissionsMap</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span id="local-6989586621687656856"><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621687656856"><span class="hs-identifier hs-var">allRolesUnresolvedPermissionsMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><span class="annottext">arr
  (m (HashMap RoleName (CheckPermission IntrospectionResult)))
  (HashMap RoleName (CheckPermission IntrospectionResult))
forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-152"></span><span>        </span><span class="annot"><span class="annottext">(HashMap RoleName (CheckPermission IntrospectionResult)
 -&gt; Role
 -&gt; m (HashMap RoleName (CheckPermission IntrospectionResult)))
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; [Role]
-&gt; m (HashMap RoleName (CheckPermission IntrospectionResult))
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span>
</span><span id="line-153"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687656858"><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621687656858"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span id="local-6989586621687656860"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656860"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#ParentRoles"><span class="hs-identifier hs-type">ParentRoles</span></a></span><span> </span><span id="local-6989586621687656862"><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621687656862"><span class="hs-identifier hs-var">parentRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-154"></span><span>              </span><span id="local-6989586621687656863"><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621687656863"><span class="hs-identifier hs-var">rolePermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; Maybe (CheckPermission IntrospectionResult)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-8335dfa2c360fbc99338d79b59c29f0e55b38395ab008163a5f9c1bb67e3a4b4/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656860"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621687656858"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (CheckPermission IntrospectionResult)
 -&gt; m (CheckPermission IntrospectionResult))
-&gt; m (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-155"></span><span>                </span><span id="local-6989586621687656865"><span class="annot"><span class="annottext">[CheckPermission IntrospectionResult]
</span><a href="#local-6989586621687656865"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-156"></span><span>                  </span><span class="annot"><span class="annottext">[RoleName]
-&gt; (RoleName -&gt; m (CheckPermission IntrospectionResult))
-&gt; m [CheckPermission IntrospectionResult]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet RoleName -&gt; [RoleName]
forall a. HashSet a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621687656862"><span class="hs-identifier hs-var">parentRoles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RoleName -&gt; m (CheckPermission IntrospectionResult))
 -&gt; m [CheckPermission IntrospectionResult])
-&gt; (RoleName -&gt; m (CheckPermission IntrospectionResult))
-&gt; m [CheckPermission IntrospectionResult]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621687656868"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656868"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-157"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; Maybe (CheckPermission IntrospectionResult)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-8335dfa2c360fbc99338d79b59c29f0e55b38395ab008163a5f9c1bb67e3a4b4/share/doc/html/src/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656868"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621687656858"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>                      </span><span class="annot"><span class="annottext">(m (CheckPermission IntrospectionResult)
 -&gt; m (CheckPermission IntrospectionResult))
-&gt; m (CheckPermission IntrospectionResult)
-&gt; m (CheckPermission IntrospectionResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; m (CheckPermission IntrospectionResult)
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span>
</span><span id="line-159"></span><span>                      </span><span class="annot"><span class="annottext">(Text -&gt; m (CheckPermission IntrospectionResult))
-&gt; Text -&gt; m (CheckPermission IntrospectionResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;remote schema permissions: bad ordering of roles, could not find the permission of role: &quot;</span></span><span>
</span><span id="line-160"></span><span>                      </span><span class="annot"><span class="annottext">Text -&gt; RoleName -&gt; Text
forall t. ToTxt t =&gt; Text -&gt; t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3E%3E"><span class="hs-operator hs-var">&lt;&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656868"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-161"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687656870"><span class="annot"><span class="annottext">combinedPermission :: Maybe (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621687656870"><span class="hs-identifier hs-var hs-var">combinedPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (CheckPermission IntrospectionResult)
-&gt; CheckPermission IntrospectionResult
forall a. Semigroup a =&gt; NonEmpty a -&gt; a
</span><span class="hs-identifier hs-var">sconcat</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty (CheckPermission IntrospectionResult)
 -&gt; CheckPermission IntrospectionResult)
-&gt; Maybe (NonEmpty (CheckPermission IntrospectionResult))
-&gt; Maybe (CheckPermission IntrospectionResult)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[CheckPermission IntrospectionResult]
-&gt; Maybe (NonEmpty (CheckPermission IntrospectionResult))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><span class="hs-identifier hs-var">nonEmpty</span></span><span> </span><span class="annot"><span class="annottext">[CheckPermission IntrospectionResult]
</span><a href="#local-6989586621687656865"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span><span>
</span><span id="line-162"></span><span>                </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
-&gt; m (CheckPermission IntrospectionResult)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(CheckPermission IntrospectionResult
 -&gt; m (CheckPermission IntrospectionResult))
-&gt; CheckPermission IntrospectionResult
-&gt; m (CheckPermission IntrospectionResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
-&gt; Maybe (CheckPermission IntrospectionResult)
-&gt; CheckPermission IntrospectionResult
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
forall permissionType. CheckPermission permissionType
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPUndefined"><span class="hs-identifier hs-var">CPUndefined</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621687656870"><span class="hs-identifier hs-var">combinedPermission</span></a></span><span>
</span><span id="line-163"></span><span>              </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; m (HashMap RoleName (CheckPermission IntrospectionResult))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(HashMap RoleName (CheckPermission IntrospectionResult)
 -&gt; m (HashMap RoleName (CheckPermission IntrospectionResult)))
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; m (HashMap RoleName (CheckPermission IntrospectionResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RoleName
-&gt; CheckPermission IntrospectionResult
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; HashMap RoleName (CheckPermission IntrospectionResult)
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-8335dfa2c360fbc99338d79b59c29f0e55b38395ab008163a5f9c1bb67e3a4b4/share/doc/html/src/Data.HashMap.Internal.Strict.html#insert"><span class="hs-identifier hs-var">HashMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656860"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621687656863"><span class="hs-identifier hs-var">rolePermission</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621687656858"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span>
</span><span id="line-164"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>          </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621687656854"><span class="hs-identifier hs-var">metadataCheckPermissionsMap</span></a></span><span>
</span><span id="line-166"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var">_unOrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621687656845"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-comment">-- traverse through `allRolesUnresolvedPermissionsMap` to record any inconsistencies (if exists)</span><span>
</span><span id="line-168"></span><span>  </span><span id="local-6989586621687656877"><span class="annot"><span class="annottext">[(RoleName, Maybe IntrospectionResult)]
</span><a href="#local-6989586621687656877"><span class="hs-identifier hs-var">resolvedPermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="annottext">arr
  (Writer (Seq CollectItem) [(RoleName, Maybe IntrospectionResult)])
  [(RoleName, Maybe IntrospectionResult)]
forall w (arr :: * -&gt; * -&gt; *) a.
ArrowWriter w arr =&gt;
arr (Writer w a) a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Interpret.html#interpretWriter"><span class="hs-identifier hs-var">interpretWriter</span></a></span><span>
</span><span id="line-170"></span><span>      </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">[(RoleName, CheckPermission IntrospectionResult)]
-&gt; ((RoleName, CheckPermission IntrospectionResult)
    -&gt; WriterT
         (Seq CollectItem) Identity (RoleName, Maybe IntrospectionResult))
-&gt; Writer (Seq CollectItem) [(RoleName, Maybe IntrospectionResult)]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
-&gt; [(RoleName, CheckPermission IntrospectionResult)]
forall k v. HashMap k v -&gt; [(k, v)]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-8335dfa2c360fbc99338d79b59c29f0e55b38395ab008163a5f9c1bb67e3a4b4/share/doc/html/src/Data.HashMap.Internal.html#toList"><span class="hs-identifier hs-var">HashMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621687656856"><span class="hs-identifier hs-var">allRolesUnresolvedPermissionsMap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621687656880"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656880"><span class="hs-identifier hs-var">roleName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656881"><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621687656881"><span class="hs-identifier hs-var">checkPermission</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687656882"><span class="annot"><span class="annottext">inconsistentRoleEntity :: InconsistentRoleEntity
</span><a href="#local-6989586621687656882"><span class="hs-identifier hs-var hs-var">inconsistentRoleEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; InconsistentRoleEntity
</span><a href="Hasura.RQL.Types.Metadata.Object.html#InconsistentRemoteSchemaPermission"><span class="hs-identifier hs-var">InconsistentRemoteSchemaPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656843"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span>
</span><span id="line-172"></span><span>        </span><span id="local-6989586621687656884"><span class="annot"><span class="annottext">Maybe IntrospectionResult
</span><a href="#local-6989586621687656884"><span class="hs-identifier hs-var">resolvedCheckPermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
-&gt; RoleName
-&gt; InconsistentRoleEntity
-&gt; WriterT (Seq CollectItem) Identity (Maybe IntrospectionResult)
forall (m :: * -&gt; *) p.
MonadWriter (Seq CollectItem) m =&gt;
CheckPermission p
-&gt; RoleName -&gt; InconsistentRoleEntity -&gt; m (Maybe p)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier hs-var">resolveCheckPermission</span></a></span><span> </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621687656881"><span class="hs-identifier hs-var">checkPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656880"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">InconsistentRoleEntity
</span><a href="#local-6989586621687656882"><span class="hs-identifier hs-var">inconsistentRoleEntity</span></a></span><span>
</span><span id="line-173"></span><span>        </span><span class="annot"><span class="annottext">(RoleName, Maybe IntrospectionResult)
-&gt; WriterT
     (Seq CollectItem) Identity (RoleName, Maybe IntrospectionResult)
forall a. a -&gt; WriterT (Seq CollectItem) Identity a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656880"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe IntrospectionResult
</span><a href="#local-6989586621687656884"><span class="hs-identifier hs-var">resolvedCheckPermission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="annottext">arr
  (HashMap RoleName IntrospectionResult)
  (HashMap RoleName IntrospectionResult)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (Maybe IntrospectionResult)
-&gt; HashMap RoleName IntrospectionResult
forall a. HashMap RoleName (Maybe a) -&gt; HashMap RoleName a
forall (f :: * -&gt; *) a. Filterable f =&gt; f (Maybe a) -&gt; f a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/witherable-0.4.2-27d2e54ee8e55049a04643f21c35add9624422a067ad828340766ae5c9a5fd18/share/doc/html/src/Witherable.html#catMaybes"><span class="hs-identifier hs-var">catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap RoleName (Maybe IntrospectionResult)
 -&gt; HashMap RoleName IntrospectionResult)
-&gt; HashMap RoleName (Maybe IntrospectionResult)
-&gt; HashMap RoleName IntrospectionResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(RoleName, Maybe IntrospectionResult)]
-&gt; HashMap RoleName (Maybe IntrospectionResult)
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/unordered-containers-0.2.19.1-8335dfa2c360fbc99338d79b59c29f0e55b38395ab008163a5f9c1bb67e3a4b4/share/doc/html/src/Data.HashMap.Internal.Strict.html#fromList"><span class="hs-identifier hs-var">HashMap.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[(RoleName, Maybe IntrospectionResult)]
</span><a href="#local-6989586621687656877"><span class="hs-identifier hs-var">resolvedPermissions</span></a></span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-176"></span><span>    </span><span id="local-6989586621687656853"><span class="annot"><span class="annottext">buildRemoteSchemaPermission :: arr
  (IntrospectionResult,
   (RemoteSchemaName, RemoteSchemaPermissionMetadata))
  (Maybe IntrospectionResult)
</span><a href="#local-6989586621687656853"><span class="hs-identifier hs-var hs-var">buildRemoteSchemaPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687656928"><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656928"><span class="hs-identifier hs-var">originalIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621687656929"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656929"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656930"><span class="annot"><span class="annottext">RemoteSchemaPermissionMetadata
</span><a href="#local-6989586621687656930"><span class="hs-identifier hs-var">remoteSchemaPerm</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Permission.html#RemoteSchemaPermissionMetadata"><span class="hs-identifier hs-type">RemoteSchemaPermissionMetadata</span></a></span><span> </span><span id="local-6989586621687656932"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656932"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621687656933"><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621687656933"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionMetadata
</span><a href="#local-6989586621687656930"><span class="hs-identifier hs-var">remoteSchemaPerm</span></a></span><span>
</span><span id="line-178"></span><span>          </span><span id="local-6989586621687656934"><span class="annot"><span class="annottext">metadataObject :: MetadataObject
</span><a href="#local-6989586621687656934"><span class="hs-identifier hs-var hs-var">metadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaName, RemoteSchemaPermissionMetadata)
-&gt; MetadataObject
</span><a href="#local-6989586621687656852"><span class="hs-identifier hs-var">mkRemoteSchemaPermissionMetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656929"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionMetadata
</span><a href="#local-6989586621687656930"><span class="hs-identifier hs-var">remoteSchemaPerm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>          </span><span id="local-6989586621687656935"><span class="annot"><span class="annottext">schemaObject :: SchemaObjId
</span><a href="#local-6989586621687656935"><span class="hs-identifier hs-var hs-var">schemaObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; RoleName -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SORemoteSchemaPermission"><span class="hs-identifier hs-var">SORemoteSchemaPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656929"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656932"><span class="hs-identifier hs-var">roleName</span></a></span><span>
</span><span id="line-180"></span><span>          </span><span id="local-6989586621687656937"><span class="annot"><span class="annottext">providedSchemaDoc :: SchemaDocument
</span><a href="#local-6989586621687656937"><span class="hs-identifier hs-var hs-var">providedSchemaDoc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition -&gt; SchemaDocument
</span><a href="Hasura.RemoteSchema.Metadata.Permission.html#_rspdSchema"><span class="hs-identifier hs-var">_rspdSchema</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621687656933"><span class="hs-identifier hs-var">defn</span></a></span><span>
</span><span id="line-181"></span><span>          </span><span id="local-6989586621687656939"><span class="annot"><span class="annottext">addPermContext :: Text -&gt; Text
</span><a href="#local-6989586621687656939"><span class="hs-identifier hs-var hs-var">addPermContext</span></a></span></span><span> </span><span id="local-6989586621687656940"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687656940"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in remote schema permission for role &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656932"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687656940"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-glyph">(|</span><span>
</span><span id="line-183"></span><span>        </span><span class="annot"><span class="annottext">ErrorA QErr arr (a, ()) IntrospectionResult
-&gt; arr (a, (MetadataObject, ())) (Maybe IntrospectionResult)
forall {a}.
ErrorA QErr arr (a, ()) IntrospectionResult
-&gt; arr (a, (MetadataObject, ())) (Maybe IntrospectionResult)
forall (arr :: * -&gt; * -&gt; *) e s a.
(ArrowChoice arr, ArrowWriter (Seq CollectItem) arr) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-184"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621687656949"><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656949"><span class="hs-identifier hs-var">resolvedSchemaIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621687656950"><span class="annot"><span class="annottext">SchemaDependency
</span><a href="#local-6989586621687656950"><span class="hs-keyword hs-var">dependency</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-186"></span><span>                </span><span class="annot"><span class="annottext">ErrorA
  QErr
  arr
  (ExceptT QErr m (IntrospectionResult, SchemaDependency))
  (IntrospectionResult, SchemaDependency)
forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *) e a.
(ArrowChoice arr, ArrowKleisli m arr, ArrowError e arr) =&gt;
arr (ExceptT e m a) a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/arrows-extra-1.0.0/opt/doc/html/arrows-extra/src/Control.Arrow.Extended.html#bindErrorA"><span class="hs-identifier hs-var">bindErrorA</span></a></span><span>
</span><span id="line-187"></span><span>                  </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-188"></span><span>                    </span><span class="annot"><span class="annottext">(Text -&gt; Text)
-&gt; ExceptT QErr m (IntrospectionResult, SchemaDependency)
-&gt; ExceptT QErr m (IntrospectionResult, SchemaDependency)
forall (m :: * -&gt; *) a. QErrM m =&gt; (Text -&gt; Text) -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#modifyErr"><span class="hs-identifier hs-var">modifyErr</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621687656939"><span class="hs-identifier hs-var">addPermContext</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m (IntrospectionResult, SchemaDependency)
 -&gt; ExceptT QErr m (IntrospectionResult, SchemaDependency))
-&gt; ExceptT QErr m (IntrospectionResult, SchemaDependency)
-&gt; ExceptT QErr m (IntrospectionResult, SchemaDependency)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RoleName
-&gt; RemoteSchemaName
-&gt; IntrospectionResult
-&gt; SchemaDocument
-&gt; ExceptT QErr m (IntrospectionResult, SchemaDependency)
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
RoleName
-&gt; RemoteSchemaName
-&gt; IntrospectionResult
-&gt; SchemaDocument
-&gt; m (IntrospectionResult, SchemaDependency)
</span><a href="Hasura.RemoteSchema.SchemaCache.Permission.html#resolveRoleBasedRemoteSchema"><span class="hs-identifier hs-var">resolveRoleBasedRemoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656932"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656929"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656928"><span class="hs-identifier hs-var">originalIntrospection</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaDocument
</span><a href="#local-6989586621687656937"><span class="hs-identifier hs-var">providedSchemaDoc</span></a></span><span>
</span><span id="line-189"></span><span>              </span><span class="annot"><span class="annottext">ErrorA
  QErr arr (MetadataObject, SchemaObjId, Seq SchemaDependency) ()
forall (arr :: * -&gt; * -&gt; *).
ArrowWriter (Seq CollectItem) arr =&gt;
arr (MetadataObject, SchemaObjId, Seq SchemaDependency) ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordDependencies"><span class="hs-identifier hs-var">recordDependencies</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621687656934"><span class="hs-identifier hs-var">metadataObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SchemaObjId
</span><a href="#local-6989586621687656935"><span class="hs-identifier hs-var">schemaObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SchemaDependency -&gt; Seq SchemaDependency
forall a. a -&gt; Seq a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SchemaDependency
</span><a href="#local-6989586621687656950"><span class="hs-keyword hs-var">dependency</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>              </span><span class="annot"><span class="annottext">ErrorA QErr arr IntrospectionResult IntrospectionResult
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621687656949"><span class="hs-identifier hs-var">resolvedSchemaIntrospection</span></a></span><span>
</span><span id="line-191"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>        </span><span class="hs-glyph">|)</span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621687656934"><span class="hs-identifier hs-var">metadataObject</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><a href="#local-6989586621687656852"><span class="hs-identifier hs-type">mkRemoteSchemaPermissionMetadataObject</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-196"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Permission.html#RemoteSchemaPermissionMetadata"><span class="hs-identifier hs-type">RemoteSchemaPermissionMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-197"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span>
</span><span id="line-198"></span><span>    </span><span id="local-6989586621687656852"><span class="annot"><span class="annottext">mkRemoteSchemaPermissionMetadataObject :: (RemoteSchemaName, RemoteSchemaPermissionMetadata)
-&gt; MetadataObject
</span><a href="#local-6989586621687656852"><span class="hs-identifier hs-var hs-var">mkRemoteSchemaPermissionMetadataObject</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621687656954"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656954"><span class="hs-identifier hs-var">rsName</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Permission.html#RemoteSchemaPermissionMetadata"><span class="hs-identifier hs-type">RemoteSchemaPermissionMetadata</span></a></span><span> </span><span id="local-6989586621687656955"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656955"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621687656956"><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621687656956"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687656957"><span class="annot"><span class="annottext">objectId :: MetadataObjId
</span><a href="#local-6989586621687656957"><span class="hs-identifier hs-var hs-var">objectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; RoleName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MORemoteSchemaPermissions"><span class="hs-identifier hs-var">MORemoteSchemaPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621687656954"><span class="hs-identifier hs-var">rsName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621687656955"><span class="hs-identifier hs-var">roleName</span></a></span><span>
</span><span id="line-200"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="#local-6989586621687656957"><span class="hs-identifier hs-var">objectId</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; MetadataObject) -&gt; Value -&gt; MetadataObject
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-eb2865ffe23f31228547a6f32a9edc574ee6a6324e10506583c4975c7f9d4b7b/share/doc/html/src/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621687656956"><span class="hs-identifier hs-var">defn</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span id="local-6989586621687656396"><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Build.html#addRemoteSchemaP2Setup"><span class="hs-identifier hs-type">addRemoteSchemaP2Setup</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656396"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621687656396"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Services.Network.html#ProvidesNetwork"><span class="hs-identifier hs-type">ProvidesNetwork</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656396"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Tracing.Class.html#MonadTrace"><span class="hs-identifier hs-type">Tracing.MonadTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687656396"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-204"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-205"></span><span>  </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Core.html#RemoteSchemaDef"><span class="hs-identifier hs-type">RemoteSchemaDef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><a href="#local-6989586621687656396"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#IntrospectionResult"><span class="hs-identifier hs-type">IntrospectionResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#RemoteSchemaInfo"><span class="hs-identifier hs-type">RemoteSchemaInfo</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-207"></span><span id="addRemoteSchemaP2Setup"><span class="annot"><span class="annottext">addRemoteSchemaP2Setup :: forall (m :: * -&gt; *).
(QErrM m, MonadIO m, ProvidesNetwork m, MonadTrace m) =&gt;
Environment
-&gt; RemoteSchemaDef
-&gt; m (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="Hasura.RemoteSchema.SchemaCache.Build.html#addRemoteSchemaP2Setup"><span class="hs-identifier hs-var hs-var">addRemoteSchemaP2Setup</span></a></span></span><span> </span><span id="local-6989586621687656971"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621687656971"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621687656972"><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621687656972"><span class="hs-identifier hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>  </span><span id="local-6989586621687656973"><span class="annot"><span class="annottext">ValidatedRemoteSchemaDef
</span><a href="#local-6989586621687656973"><span class="hs-identifier hs-var">rsi</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Environment -&gt; RemoteSchemaDef -&gt; m ValidatedRemoteSchemaDef
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
Environment -&gt; RemoteSchemaDef -&gt; m ValidatedRemoteSchemaDef
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#validateRemoteSchemaDef"><span class="hs-identifier hs-var">validateRemoteSchemaDef</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621687656971"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621687656972"><span class="hs-identifier hs-var">def</span></a></span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><span class="annottext">Environment
-&gt; ValidatedRemoteSchemaDef
-&gt; m (IntrospectionResult, ByteString, RemoteSchemaInfo)
forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m, MonadTrace m, ProvidesNetwork m) =&gt;
Environment
-&gt; ValidatedRemoteSchemaDef
-&gt; m (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="Hasura.GraphQL.RemoteServer.html#fetchRemoteSchema"><span class="hs-identifier hs-var">fetchRemoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621687656971"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedRemoteSchemaDef
</span><a href="#local-6989586621687656973"><span class="hs-identifier hs-var">rsi</span></a></span><span>
</span><span id="line-210"></span></pre></body></html>