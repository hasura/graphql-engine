<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.RQL.DDL.Metadata</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadata"><span class="hs-identifier">runReplaceMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadataV2"><span class="hs-identifier">runReplaceMetadataV2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runExportMetadata"><span class="hs-identifier">runExportMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runExportMetadataV2"><span class="hs-identifier">runExportMetadataV2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runClearMetadata"><span class="hs-identifier">runClearMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runReloadMetadata"><span class="hs-identifier">runReloadMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runDumpInternalState"><span class="hs-identifier">runDumpInternalState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runGetInconsistentMetadata"><span class="hs-identifier">runGetInconsistentMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runDropInconsistentMetadata"><span class="hs-identifier">runDropInconsistentMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runGetCatalogState"><span class="hs-identifier">runGetCatalogState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runSetCatalogState"><span class="hs-identifier">runSetCatalogState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runTestWebhookTransform"><span class="hs-identifier">runTestWebhookTransform</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runSetMetricsConfig"><span class="hs-identifier">runSetMetricsConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runRemoveMetricsConfig"><span class="hs-identifier">runRemoveMetricsConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html"><span class="hs-identifier">Hasura.RQL.DDL.Metadata.Types</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">where</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">to</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.~)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(^.)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(^?)</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/aeson-ordered-0.1.0.0/opt/doc/html/aeson-ordered/src"><span class="hs-identifier">Data.Aeson.Ordered</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AO</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Attoparsec.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AT</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">first</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bitraversable</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BL</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.CaseInsensitive</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CI</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Environment.html"><span class="hs-identifier">Data.Environment</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Env</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Has</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Has</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">getter</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.HashMap.Strict.InsOrd.Extended.html"><span class="hs-identifier">Data.HashMap.Strict.InsOrd.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OMap</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HS</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.SerializableBlob.html"><span class="hs-identifier">Data.SerializableBlob</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SB</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TE</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Extended.html#dquoteList"><span class="hs-identifier">dquoteList</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator">(&lt;&lt;&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.EncJSON.html"><span class="hs-identifier">Hasura.EncJSON</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html"><span class="hs-identifier">Hasura.Eventing.EventTrigger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier">logQErr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HL</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html"><span class="hs-identifier">Hasura.Metadata.Class</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier">Hasura.Prelude</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">first</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Action.html"><span class="hs-identifier">Hasura.RQL.DDL.Action</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.ComputedField.html"><span class="hs-identifier">Hasura.RQL.DDL.ComputedField</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.CustomTypes.html"><span class="hs-identifier">Hasura.RQL.DDL.CustomTypes</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Endpoint.html"><span class="hs-identifier">Hasura.RQL.DDL.Endpoint</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.DDL.EventTrigger</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.InheritedRoles.html"><span class="hs-identifier">Hasura.RQL.DDL.InheritedRoles</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html"><span class="hs-identifier">Hasura.RQL.DDL.Metadata.Types</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Network.html"><span class="hs-identifier">Hasura.RQL.DDL.Network</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Permission.html"><span class="hs-identifier">Hasura.RQL.DDL.Permission</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Relationship.html"><span class="hs-identifier">Hasura.RQL.DDL.Relationship</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteRelationship.html"><span class="hs-identifier">Hasura.RQL.DDL.RemoteRelationship</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.RemoteSchema.html"><span class="hs-identifier">Hasura.RQL.DDL.RemoteSchema</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.ScheduledTrigger.html"><span class="hs-identifier">Hasura.RQL.DDL.ScheduledTrigger</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Source.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Source</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Webhook.Transform.html"><span class="hs-identifier">Hasura.RQL.DDL.Webhook.Transform</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Webhook.Transform.Class.html"><span class="hs-identifier">Hasura.RQL.DDL.Webhook.Transform.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Webhook.Transform.Class.html#mkReqTransformCtx"><span class="hs-identifier">mkReqTransformCtx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Allowlist.html"><span class="hs-identifier">Hasura.RQL.Types.Allowlist</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.ApiLimit.html"><span class="hs-identifier">Hasura.RQL.Types.ApiLimit</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html"><span class="hs-identifier">Hasura.RQL.Types.Endpoint</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.Types.EventTrigger</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.Types.EventTrigger</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ET</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Eventing.Backend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier">BackendEventTrigger</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata.Backend</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata.Object</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Network.html"><span class="hs-identifier">Hasura.RQL.Types.Network</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html"><span class="hs-identifier">Hasura.RQL.Types.QueryCollection</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.ScheduledTrigger.html"><span class="hs-identifier">Hasura.RQL.Types.ScheduledTrigger</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache.Build</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier">SourceInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SourceCustomization.html"><span class="hs-identifier">Hasura.RQL.Types.SourceCustomization</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.Backend.html"><span class="hs-identifier">Hasura.SQL.Backend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.SQL.Backend.html#BackendType"><span class="hs-identifier">BackendType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.BackendMap.html"><span class="hs-identifier">Hasura.SQL.BackendMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BackendMap</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Transformable.html"><span class="hs-identifier">Network.HTTP.Client.Transformable</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HTTP</span></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runClearMetadata"><span class="hs-identifier hs-type">runClearMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621689751631"><span class="annot"><a href="#local-6989586621689751631"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621689751630"><span class="annot"><a href="#local-6989586621689751630"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751631"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689751631"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751631"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751631"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorageQueryAPI"><span class="hs-identifier hs-type">MonadMetadataStorageQueryAPI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751631"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689751631"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621689751630"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751631"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Has</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">HL.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">HL.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621689751630"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html#MonadEventLogCleanup"><span class="hs-identifier hs-type">MonadEventLogCleanup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751631"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-98"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ClearMetadata"><span class="hs-identifier hs-type">ClearMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><a href="#local-6989586621689751631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span><span>
</span><span id="line-100"></span><span id="runClearMetadata"><span class="annot"><span class="annottext">runClearMetadata :: ClearMetadata -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runClearMetadata"><span class="hs-identifier hs-var hs-var">runClearMetadata</span></a></span></span><span> </span><span class="annot"><span class="annottext">ClearMetadata
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621689751629"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751629"><span class="hs-identifier hs-var">metadata</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Metadata
forall (m :: * -&gt; *). MetadataM m =&gt; m Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#getMetadata"><span class="hs-identifier hs-var">getMetadata</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-comment">-- Clean up all sources, drop hdb_catalog schema from source</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">[(SourceName, BackendSourceMetadata)]
-&gt; ((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
-&gt; [(SourceName, BackendSourceMetadata)]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap SourceName BackendSourceMetadata
 -&gt; [(SourceName, BackendSourceMetadata)])
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; [(SourceName, BackendSourceMetadata)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.html#_metaSources"><span class="hs-identifier hs-var hs-var">_metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751629"><span class="hs-identifier hs-var">metadata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ())
-&gt; ((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751624"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751624"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689751623"><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751623"><span class="hs-identifier hs-var">backendSourceMetadata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata
-&gt; (forall (b :: BackendType).
    BackendMetadata b =&gt;
    SourceMetadata b -&gt; m ())
-&gt; m ()
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BackendSourceMetadata -&gt; AnyBackend SourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#unBackendSourceMetadata"><span class="hs-identifier hs-var hs-var">unBackendSourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751623"><span class="hs-identifier hs-var">backendSourceMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751620"><span id="local-6989586621689751619"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751619"><span class="hs-identifier hs-var">_sourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751620"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-105"></span><span>      </span><span id="local-6989586621689751618"><span class="annot"><span class="annottext">SourceInfo b
</span><a href="#local-6989586621689751618"><span class="hs-identifier hs-var">sourceInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; m (SourceInfo b)
forall (b :: BackendType) (m :: * -&gt; *).
(CacheRM m, MetadataM m, MonadError QErr m, Backend b) =&gt;
SourceName -&gt; m (SourceInfo b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSourceInfo"><span class="hs-identifier hs-var">askSourceInfo</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751620"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751624"><span class="hs-identifier hs-var">sourceName</span></a></span><span>
</span><span id="line-106"></span><span>      </span><span class="hs-comment">-- We do not bother dropping all dependencies on the source, because the</span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-comment">-- metadata is going to be replaced with an empty metadata. And dropping the</span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-comment">-- depdencies would lead to rebuilding of schema cache which is of no use here</span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-comment">-- since we do not use the rebuilt schema cache. Hence, we only clean up the</span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-comment">-- 'hdb_catalog' tables from the source.</span><span>
</span><span id="line-111"></span><span>      </span><span class="annot"><span class="annottext">SourceName -&gt; SourceInfo b -&gt; m ()
forall (m :: * -&gt; *) r (b :: BackendType).
(MonadError QErr m, MonadIO m, MonadBaseControl IO m,
 MonadReader r m, Has (Logger Hasura) r, BackendMetadata b) =&gt;
SourceName -&gt; SourceInfo b -&gt; m ()
</span><a href="Hasura.RQL.DDL.Schema.Source.html#runPostDropSourceHook"><span class="hs-identifier hs-var">runPostDropSourceHook</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751624"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">SourceInfo b
</span><a href="#local-6989586621689751618"><span class="hs-identifier hs-var">sourceInfo</span></a></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-comment">-- We can infer whether the server is started with `--database-url` option</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-comment">-- (or corresponding env variable) by checking the existence of @'defaultSource'</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-comment">-- in current metadata.</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751615"><span class="annot"><span class="annottext">maybeDefaultSourceMetadata :: Maybe (AnyBackend SourceMetadata)
</span><a href="#local-6989586621689751615"><span class="hs-identifier hs-var hs-var">maybeDefaultSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751629"><span class="hs-identifier hs-var">metadata</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
-&gt; Getting
     (First (AnyBackend SourceMetadata))
     Metadata
     (AnyBackend SourceMetadata)
-&gt; Maybe (AnyBackend SourceMetadata)
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><span class="hs-operator hs-var">^?</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap SourceName BackendSourceMetadata
 -&gt; Const
      (First (AnyBackend SourceMetadata))
      (InsOrdHashMap SourceName BackendSourceMetadata))
-&gt; Metadata -&gt; Const (First (AnyBackend SourceMetadata)) Metadata
Lens' Metadata (InsOrdHashMap SourceName BackendSourceMetadata)
</span><a href="Hasura.RQL.Types.Metadata.html#metaSources"><span class="hs-identifier hs-var">metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">((InsOrdHashMap SourceName BackendSourceMetadata
  -&gt; Const
       (First (AnyBackend SourceMetadata))
       (InsOrdHashMap SourceName BackendSourceMetadata))
 -&gt; Metadata -&gt; Const (First (AnyBackend SourceMetadata)) Metadata)
-&gt; ((AnyBackend SourceMetadata
     -&gt; Const
          (First (AnyBackend SourceMetadata)) (AnyBackend SourceMetadata))
    -&gt; InsOrdHashMap SourceName BackendSourceMetadata
    -&gt; Const
         (First (AnyBackend SourceMetadata))
         (InsOrdHashMap SourceName BackendSourceMetadata))
-&gt; Getting
     (First (AnyBackend SourceMetadata))
     Metadata
     (AnyBackend SourceMetadata)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (InsOrdHashMap SourceName BackendSourceMetadata)
-&gt; Traversal'
     (InsOrdHashMap SourceName BackendSourceMetadata)
     (IxValue (InsOrdHashMap SourceName BackendSourceMetadata))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (InsOrdHashMap SourceName BackendSourceMetadata)
SourceName
</span><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-var">defaultSource</span></a></span><span> </span><span class="annot"><span class="annottext">((BackendSourceMetadata
  -&gt; Const (First (AnyBackend SourceMetadata)) BackendSourceMetadata)
 -&gt; InsOrdHashMap SourceName BackendSourceMetadata
 -&gt; Const
      (First (AnyBackend SourceMetadata))
      (InsOrdHashMap SourceName BackendSourceMetadata))
-&gt; ((AnyBackend SourceMetadata
     -&gt; Const
          (First (AnyBackend SourceMetadata)) (AnyBackend SourceMetadata))
    -&gt; BackendSourceMetadata
    -&gt; Const (First (AnyBackend SourceMetadata)) BackendSourceMetadata)
-&gt; (AnyBackend SourceMetadata
    -&gt; Const
         (First (AnyBackend SourceMetadata)) (AnyBackend SourceMetadata))
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; Const
     (First (AnyBackend SourceMetadata))
     (InsOrdHashMap SourceName BackendSourceMetadata)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BackendSourceMetadata -&gt; AnyBackend SourceMetadata)
-&gt; (AnyBackend SourceMetadata
    -&gt; Const
         (First (AnyBackend SourceMetadata)) (AnyBackend SourceMetadata))
-&gt; BackendSourceMetadata
-&gt; Const (First (AnyBackend SourceMetadata)) BackendSourceMetadata
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata -&gt; AnyBackend SourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#unBackendSourceMetadata"><span class="hs-identifier hs-var hs-var">unBackendSourceMetadata</span></a></span><span>
</span><span id="line-117"></span><span>      </span><span id="local-6989586621689751610"><span class="annot"><span class="annottext">emptyMetadata' :: Metadata
</span><a href="#local-6989586621689751610"><span class="hs-identifier hs-var hs-var">emptyMetadata'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (AnyBackend SourceMetadata)
</span><a href="#local-6989586621689751615"><span class="hs-identifier hs-var">maybeDefaultSourceMetadata</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-118"></span><span>        </span><span class="annot"><span class="annottext">Maybe (AnyBackend SourceMetadata)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#emptyMetadata"><span class="hs-identifier hs-var">emptyMetadata</span></a></span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621689751608"><span class="annot"><span class="annottext">AnyBackend SourceMetadata
</span><a href="#local-6989586621689751608"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-120"></span><span>          </span><span class="hs-comment">-- If default postgres source is defined, we need to set metadata</span><span>
</span><span id="line-121"></span><span>          </span><span class="hs-comment">-- which contains only default source without any tables and functions.</span><span>
</span><span id="line-122"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751607"><span class="annot"><span class="annottext">emptyDefaultSource :: BackendSourceMetadata
</span><a href="#local-6989586621689751607"><span class="hs-identifier hs-var hs-var">emptyDefaultSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-123"></span><span>                </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata
-&gt; (forall (b :: BackendType).
    Backend b =&gt;
    SourceMetadata b -&gt; BackendSourceMetadata)
-&gt; BackendSourceMetadata
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata
</span><a href="#local-6989586621689751608"><span class="hs-identifier hs-var">exists</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751606"><span id="local-6989586621689751605"><span class="annot"><a href="#local-6989586621689751605"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751606"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-124"></span><span>                  </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata -&gt; BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-var">BackendSourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(AnyBackend SourceMetadata -&gt; BackendSourceMetadata)
-&gt; AnyBackend SourceMetadata -&gt; BackendSourceMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-125"></span><span>                    </span><span class="annot"><span class="annottext">forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
forall (i :: BackendType -&gt; *). HasTag b =&gt; i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751606"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceMetadata b -&gt; AnyBackend SourceMetadata)
-&gt; SourceMetadata b -&gt; AnyBackend SourceMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-126"></span><span>                      </span><span class="annot"><span class="annottext">SourceName
-&gt; BackendSourceKind b
-&gt; Tables b
-&gt; Functions b
-&gt; SourceConnConfiguration b
-&gt; Maybe QueryTagsConfig
-&gt; SourceCustomization
-&gt; Maybe (HealthCheckConfig b)
-&gt; SourceMetadata b
forall (b :: BackendType).
SourceName
-&gt; BackendSourceKind b
-&gt; Tables b
-&gt; Functions b
-&gt; SourceConnConfiguration b
-&gt; Maybe QueryTagsConfig
-&gt; SourceCustomization
-&gt; Maybe (HealthCheckConfig b)
-&gt; SourceMetadata b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#SourceMetadata"><span class="hs-identifier hs-var">SourceMetadata</span></a></span><span>
</span><span id="line-127"></span><span>                        </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751606"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-128"></span><span>                        </span><span class="annot"><span class="annottext">SourceName
</span><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-var">defaultSource</span></a></span><span>
</span><span id="line-129"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceMetadata b -&gt; BackendSourceKind b
forall (b :: BackendType). SourceMetadata b -&gt; BackendSourceKind b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#_smKind"><span class="hs-identifier hs-var hs-var">_smKind</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751606"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751605"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>                        </span><span class="annot"><span class="annottext">Tables b
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-131"></span><span>                        </span><span class="annot"><span class="annottext">Functions b
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-132"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceMetadata b -&gt; SourceConnConfiguration b
forall (b :: BackendType).
SourceMetadata b -&gt; SourceConnConfiguration b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#_smConfiguration"><span class="hs-identifier hs-var hs-var">_smConfiguration</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751606"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751605"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>                        </span><span class="annot"><span class="annottext">Maybe QueryTagsConfig
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-134"></span><span>                        </span><span class="annot"><span class="annottext">SourceCustomization
</span><a href="Hasura.RQL.Types.SourceCustomization.html#emptySourceCustomization"><span class="hs-identifier hs-var">emptySourceCustomization</span></a></span><span>
</span><span id="line-135"></span><span>                        </span><span class="annot"><span class="annottext">Maybe (HealthCheckConfig b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-136"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#emptyMetadata"><span class="hs-identifier hs-var">emptyMetadata</span></a></span><span>
</span><span id="line-137"></span><span>                </span><span class="annot"><span class="annottext">Metadata -&gt; (Metadata -&gt; Metadata) -&gt; Metadata
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap SourceName BackendSourceMetadata
 -&gt; Identity (InsOrdHashMap SourceName BackendSourceMetadata))
-&gt; Metadata -&gt; Identity Metadata
Lens' Metadata (InsOrdHashMap SourceName BackendSourceMetadata)
</span><a href="Hasura.RQL.Types.Metadata.html#metaSources"><span class="hs-identifier hs-var">metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">((InsOrdHashMap SourceName BackendSourceMetadata
  -&gt; Identity (InsOrdHashMap SourceName BackendSourceMetadata))
 -&gt; Metadata -&gt; Identity Metadata)
-&gt; (InsOrdHashMap SourceName BackendSourceMetadata
    -&gt; InsOrdHashMap SourceName BackendSourceMetadata)
-&gt; Metadata
-&gt; Metadata
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; InsOrdHashMap k v -&gt; InsOrdHashMap k v
</span><span class="hs-identifier hs-var">OMap.insert</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-var">defaultSource</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751607"><span class="hs-identifier hs-var">emptyDefaultSource</span></a></span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><span class="annottext">ReplaceMetadataV1 -&gt; m EncJSON
forall (m :: * -&gt; *) r.
(QErrM m, CacheRWM m, MetadataM m, MonadIO m,
 MonadBaseControl IO m, MonadMetadataStorageQueryAPI m,
 MonadReader r m, Has (Logger Hasura) r, MonadEventLogCleanup m) =&gt;
ReplaceMetadataV1 -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadataV1"><span class="hs-identifier hs-var">runReplaceMetadataV1</span></a></span><span> </span><span class="annot"><span class="annottext">(ReplaceMetadataV1 -&gt; m EncJSON) -&gt; ReplaceMetadataV1 -&gt; m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; ReplaceMetadataV1
</span><a href="Hasura.RQL.DDL.Metadata.Types.html#RMWithSources"><span class="hs-identifier hs-var">RMWithSources</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751610"><span class="hs-identifier hs-var">emptyMetadata'</span></a></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-comment">{- Note [Cleanup for dropped triggers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There was an issue (https://github.com/hasura/graphql-engine/issues/5461)
fixed (via https://github.com/hasura/graphql-engine/pull/6137) related to
event triggers while replacing metadata in the catalog prior to metadata
separation. The metadata separation solves the issue naturally, since the
'hdb_catalog.event_triggers' table is no more in use and new/updated event
triggers are processed in building schema cache. But we need to drop the
database trigger and archive events for dropped event triggers. This is handled
explicitly in @'runReplaceMetadata' function.
-}</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-comment">-- | Replace the 'current metadata' with the 'new metadata'</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- The 'new metadata' might come via the 'Import Metadata' in console</span><span>
</span><span id="line-154"></span><span id="local-6989586621689751592"><span id="local-6989586621689751593"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadata"><span class="hs-identifier hs-type">runReplaceMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751593"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-156"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751593"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689751593"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689751593"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-159"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorageQueryAPI"><span class="hs-identifier hs-type">MonadMetadataStorageQueryAPI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751593"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-160"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621689751592"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751593"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Has</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">HL.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">HL.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621689751592"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html#MonadEventLogCleanup"><span class="hs-identifier hs-type">MonadEventLogCleanup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751593"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-164"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ReplaceMetadata"><span class="hs-identifier hs-type">ReplaceMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><a href="#local-6989586621689751593"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span></span><span>
</span><span id="line-166"></span><span id="runReplaceMetadata"><span class="annot"><span class="annottext">runReplaceMetadata :: ReplaceMetadata -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadata"><span class="hs-identifier hs-var hs-var">runReplaceMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RMReplaceMetadataV1"><span class="hs-identifier hs-type">RMReplaceMetadataV1</span></a></span><span> </span><span id="local-6989586621689751590"><span class="annot"><span class="annottext">ReplaceMetadataV1
</span><a href="#local-6989586621689751590"><span class="hs-identifier hs-var">v1args</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReplaceMetadataV1 -&gt; m EncJSON
forall (m :: * -&gt; *) r.
(QErrM m, CacheRWM m, MetadataM m, MonadIO m,
 MonadBaseControl IO m, MonadMetadataStorageQueryAPI m,
 MonadReader r m, Has (Logger Hasura) r, MonadEventLogCleanup m) =&gt;
ReplaceMetadataV1 -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadataV1"><span class="hs-identifier hs-var">runReplaceMetadataV1</span></a></span><span> </span><span class="annot"><span class="annottext">ReplaceMetadataV1
</span><a href="#local-6989586621689751590"><span class="hs-identifier hs-var">v1args</span></a></span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RMReplaceMetadataV2"><span class="hs-identifier hs-type">RMReplaceMetadataV2</span></a></span><span> </span><span id="local-6989586621689751588"><span class="annot"><span class="annottext">ReplaceMetadataV2
</span><a href="#local-6989586621689751588"><span class="hs-identifier hs-var">v2args</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReplaceMetadataV2 -&gt; m EncJSON
forall (m :: * -&gt; *) r.
(QErrM m, CacheRWM m, MetadataM m, MonadIO m,
 MonadBaseControl IO m, MonadMetadataStorageQueryAPI m,
 MonadReader r m, Has (Logger Hasura) r, MonadEventLogCleanup m) =&gt;
ReplaceMetadataV2 -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadataV2"><span class="hs-identifier hs-var">runReplaceMetadataV2</span></a></span><span> </span><span class="annot"><span class="annottext">ReplaceMetadataV2
</span><a href="#local-6989586621689751588"><span class="hs-identifier hs-var">v2args</span></a></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span id="local-6989586621689752042"><span id="local-6989586621689752046"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadataV1"><span class="hs-identifier hs-type">runReplaceMetadataV1</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752046"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-172"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752046"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752046"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-174"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689752046"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689752046"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-176"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorageQueryAPI"><span class="hs-identifier hs-type">MonadMetadataStorageQueryAPI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752046"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621689752042"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752046"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Has</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">HL.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">HL.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621689752042"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html#MonadEventLogCleanup"><span class="hs-identifier hs-type">MonadEventLogCleanup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752046"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ReplaceMetadataV1"><span class="hs-identifier hs-type">ReplaceMetadataV1</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><a href="#local-6989586621689752046"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span></span><span>
</span><span id="line-183"></span><span id="runReplaceMetadataV1"><span class="annot"><span class="annottext">runReplaceMetadataV1 :: ReplaceMetadataV1 -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadataV1"><span class="hs-identifier hs-var hs-var">runReplaceMetadataV1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EncJSON
</span><a href="Hasura.RQL.Types.Common.html#successMsg"><span class="hs-identifier hs-var">successMsg</span></a></span><span> </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON -&gt; m EncJSON
forall (f :: * -&gt; *) a b. Functor f =&gt; a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;$</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m EncJSON -&gt; m EncJSON)
-&gt; (ReplaceMetadataV1 -&gt; m EncJSON)
-&gt; ReplaceMetadataV1
-&gt; m EncJSON
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ReplaceMetadataV2 -&gt; m EncJSON
forall (m :: * -&gt; *) r.
(QErrM m, CacheRWM m, MetadataM m, MonadIO m,
 MonadBaseControl IO m, MonadMetadataStorageQueryAPI m,
 MonadReader r m, Has (Logger Hasura) r, MonadEventLogCleanup m) =&gt;
ReplaceMetadataV2 -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadataV2"><span class="hs-identifier hs-var">runReplaceMetadataV2</span></a></span><span> </span><span class="annot"><span class="annottext">(ReplaceMetadataV2 -&gt; m EncJSON)
-&gt; (ReplaceMetadataV1 -&gt; ReplaceMetadataV2)
-&gt; ReplaceMetadataV1
-&gt; m EncJSON
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">AllowInconsistentMetadata -&gt; ReplaceMetadataV1 -&gt; ReplaceMetadataV2
</span><a href="Hasura.RQL.DDL.Metadata.Types.html#ReplaceMetadataV2"><span class="hs-identifier hs-var">ReplaceMetadataV2</span></a></span><span> </span><span class="annot"><span class="annottext">AllowInconsistentMetadata
</span><a href="Hasura.RQL.DDL.Metadata.Types.html#NoAllowInconsistentMetadata"><span class="hs-identifier hs-var">NoAllowInconsistentMetadata</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadataV2"><span class="hs-identifier hs-type">runReplaceMetadataV2</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621689752037"><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621689752036"><span class="annot"><a href="#local-6989586621689752036"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-189"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorageQueryAPI"><span class="hs-identifier hs-type">MonadMetadataStorageQueryAPI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621689752036"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Has</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">HL.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">HL.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621689752036"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html#MonadEventLogCleanup"><span class="hs-identifier hs-type">MonadEventLogCleanup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ReplaceMetadataV2"><span class="hs-identifier hs-type">ReplaceMetadataV2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span><span>
</span><span id="line-200"></span><span id="runReplaceMetadataV2"><span class="annot"><span class="annottext">runReplaceMetadataV2 :: ReplaceMetadataV2 -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runReplaceMetadataV2"><span class="hs-identifier hs-var hs-var">runReplaceMetadataV2</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ReplaceMetadataV2"><span class="hs-identifier hs-type">ReplaceMetadataV2</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689751582"><span id="local-6989586621689751583"><span class="annot"><span class="annottext">ReplaceMetadataV1
AllowInconsistentMetadata
_rmv2Metadata :: ReplaceMetadataV2 -&gt; ReplaceMetadataV1
_rmv2AllowInconsistentMetadata :: ReplaceMetadataV2 -&gt; AllowInconsistentMetadata
_rmv2Metadata :: ReplaceMetadataV1
_rmv2AllowInconsistentMetadata :: AllowInconsistentMetadata
</span><a href="Hasura.RQL.DDL.Metadata.Types.html#_rmv2Metadata"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-201"></span><span>  </span><span id="local-6989586621689751579"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689751579"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">HL.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">HL.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(r -&gt; Logger Hasura) -&gt; m (Logger Hasura)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">r -&gt; Logger Hasura
forall a t. Has a t =&gt; t -&gt; a
</span><span class="hs-identifier hs-var">getter</span></span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-comment">-- we drop all the future cron trigger events before inserting the new metadata</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-comment">-- and re-populating future cron events below</span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751577"><span class="annot"><span class="annottext">introspectionDisabledRoles :: SetGraphqlIntrospectionOptions
</span><a href="#local-6989586621689751577"><span class="hs-identifier hs-var hs-var">introspectionDisabledRoles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-205"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ReplaceMetadataV1
</span><a href="#local-6989586621689751582"><span class="hs-identifier hs-var">_rmv2Metadata</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-206"></span><span>          </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RMWithSources"><span class="hs-identifier hs-type">RMWithSources</span></a></span><span> </span><span id="local-6989586621689751576"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751576"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; SetGraphqlIntrospectionOptions
</span><a href="Hasura.RQL.Types.Metadata.html#_metaSetGraphqlIntrospectionOptions"><span class="hs-identifier hs-var hs-var">_metaSetGraphqlIntrospectionOptions</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751576"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-207"></span><span>          </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RMWithoutSources"><span class="hs-identifier hs-type">RMWithoutSources</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataNoSources
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SetGraphqlIntrospectionOptions
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-208"></span><span>  </span><span id="local-6989586621689751573"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751573"><span class="hs-identifier hs-var">oldMetadata</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Metadata
forall (m :: * -&gt; *). MetadataM m =&gt; m Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#getMetadata"><span class="hs-identifier hs-var">getMetadata</span></a></span><span>
</span><span id="line-209"></span><span>  </span><span id="local-6989586621689751572"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689751572"><span class="hs-identifier hs-var">oldSchemaCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m SchemaCache
forall (m :: * -&gt; *). CacheRM m =&gt; m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var">askSchemaCache</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621689751570"><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751570"><span class="hs-identifier hs-var">cronTriggersMetadata</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689751569"><span class="annot"><span class="annottext">HashMap TriggerName CronTriggerMetadata
</span><a href="#local-6989586621689751569"><span class="hs-identifier hs-var">cronTriggersToBeAdded</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Metadata
-&gt; m (CronTriggers, HashMap TriggerName CronTriggerMetadata)
</span><a href="#local-6989586621689751568"><span class="hs-identifier hs-var">processCronTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751573"><span class="hs-identifier hs-var">oldMetadata</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>  </span><span id="local-6989586621689751567"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751567"><span class="hs-identifier hs-var">metadata</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ReplaceMetadataV1
</span><a href="#local-6989586621689751582"><span class="hs-identifier hs-var">_rmv2Metadata</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-214"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RMWithSources"><span class="hs-identifier hs-type">RMWithSources</span></a></span><span> </span><span id="local-6989586621689751566"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751566"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; m Metadata
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Metadata -&gt; m Metadata) -&gt; Metadata -&gt; m Metadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751566"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">_metaCronTriggers :: CronTriggers
</span><a href="Hasura.RQL.Types.Metadata.html#_metaCronTriggers"><span class="hs-identifier hs-var">_metaCronTriggers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751570"><span class="hs-identifier hs-var">cronTriggersMetadata</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RMWithoutSources"><span class="hs-identifier hs-type">RMWithoutSources</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataNoSources"><span class="hs-identifier hs-type">MetadataNoSources</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689751556"><span id="local-6989586621689751557"><span id="local-6989586621689751558"><span id="local-6989586621689751559"><span id="local-6989586621689751560"><span id="local-6989586621689751561"><span id="local-6989586621689751562"><span id="local-6989586621689751563"><span class="annot"><span class="annottext">QueryCollections
MetadataAllowlist
Tables ('Postgres 'Vanilla)
Functions ('Postgres 'Vanilla)
CronTriggers
RemoteSchemas
Actions
CustomTypes
_mnsCronTriggers :: MetadataNoSources -&gt; CronTriggers
_mnsActions :: MetadataNoSources -&gt; Actions
_mnsCustomTypes :: MetadataNoSources -&gt; CustomTypes
_mnsAllowlist :: MetadataNoSources -&gt; MetadataAllowlist
_mnsQueryCollections :: MetadataNoSources -&gt; QueryCollections
_mnsRemoteSchemas :: MetadataNoSources -&gt; RemoteSchemas
_mnsFunctions :: MetadataNoSources -&gt; Functions ('Postgres 'Vanilla)
_mnsTables :: MetadataNoSources -&gt; Tables ('Postgres 'Vanilla)
_mnsCronTriggers :: CronTriggers
_mnsActions :: Actions
_mnsCustomTypes :: CustomTypes
_mnsAllowlist :: MetadataAllowlist
_mnsQueryCollections :: QueryCollections
_mnsRemoteSchemas :: RemoteSchemas
_mnsFunctions :: Functions ('Postgres 'Vanilla)
_mnsTables :: Tables ('Postgres 'Vanilla)
</span><a href="Hasura.RQL.Types.Metadata.html#_mnsCronTriggers"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751547"><span class="annot"><span class="annottext">maybeDefaultSourceMetadata :: Maybe (SourceMetadata ('Postgres 'Vanilla))
</span><a href="#local-6989586621689751547"><span class="hs-identifier hs-var hs-var">maybeDefaultSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751573"><span class="hs-identifier hs-var">oldMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
-&gt; Getting
     (First (SourceMetadata ('Postgres 'Vanilla)))
     Metadata
     (SourceMetadata ('Postgres 'Vanilla))
-&gt; Maybe (SourceMetadata ('Postgres 'Vanilla))
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><span class="hs-operator hs-var">^?</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap SourceName BackendSourceMetadata
 -&gt; Const
      (First (SourceMetadata ('Postgres 'Vanilla)))
      (InsOrdHashMap SourceName BackendSourceMetadata))
-&gt; Metadata
-&gt; Const (First (SourceMetadata ('Postgres 'Vanilla))) Metadata
Lens' Metadata (InsOrdHashMap SourceName BackendSourceMetadata)
</span><a href="Hasura.RQL.Types.Metadata.html#metaSources"><span class="hs-identifier hs-var">metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">((InsOrdHashMap SourceName BackendSourceMetadata
  -&gt; Const
       (First (SourceMetadata ('Postgres 'Vanilla)))
       (InsOrdHashMap SourceName BackendSourceMetadata))
 -&gt; Metadata
 -&gt; Const (First (SourceMetadata ('Postgres 'Vanilla))) Metadata)
-&gt; ((SourceMetadata ('Postgres 'Vanilla)
     -&gt; Const
          (First (SourceMetadata ('Postgres 'Vanilla)))
          (SourceMetadata ('Postgres 'Vanilla)))
    -&gt; InsOrdHashMap SourceName BackendSourceMetadata
    -&gt; Const
         (First (SourceMetadata ('Postgres 'Vanilla)))
         (InsOrdHashMap SourceName BackendSourceMetadata))
-&gt; Getting
     (First (SourceMetadata ('Postgres 'Vanilla)))
     Metadata
     (SourceMetadata ('Postgres 'Vanilla))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (InsOrdHashMap SourceName BackendSourceMetadata)
-&gt; Traversal'
     (InsOrdHashMap SourceName BackendSourceMetadata)
     (IxValue (InsOrdHashMap SourceName BackendSourceMetadata))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (InsOrdHashMap SourceName BackendSourceMetadata)
SourceName
</span><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-var">defaultSource</span></a></span><span> </span><span class="annot"><span class="annottext">((BackendSourceMetadata
  -&gt; Const
       (First (SourceMetadata ('Postgres 'Vanilla)))
       BackendSourceMetadata)
 -&gt; InsOrdHashMap SourceName BackendSourceMetadata
 -&gt; Const
      (First (SourceMetadata ('Postgres 'Vanilla)))
      (InsOrdHashMap SourceName BackendSourceMetadata))
-&gt; ((SourceMetadata ('Postgres 'Vanilla)
     -&gt; Const
          (First (SourceMetadata ('Postgres 'Vanilla)))
          (SourceMetadata ('Postgres 'Vanilla)))
    -&gt; BackendSourceMetadata
    -&gt; Const
         (First (SourceMetadata ('Postgres 'Vanilla)))
         BackendSourceMetadata)
-&gt; (SourceMetadata ('Postgres 'Vanilla)
    -&gt; Const
         (First (SourceMetadata ('Postgres 'Vanilla)))
         (SourceMetadata ('Postgres 'Vanilla)))
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; Const
     (First (SourceMetadata ('Postgres 'Vanilla)))
     (InsOrdHashMap SourceName BackendSourceMetadata)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SourceMetadata ('Postgres 'Vanilla)
 -&gt; Const
      (First (SourceMetadata ('Postgres 'Vanilla)))
      (SourceMetadata ('Postgres 'Vanilla)))
-&gt; BackendSourceMetadata
-&gt; Const
     (First (SourceMetadata ('Postgres 'Vanilla))) BackendSourceMetadata
forall (b :: BackendType).
Backend b =&gt;
Prism' BackendSourceMetadata (SourceMetadata b)
</span><a href="Hasura.RQL.Types.Metadata.Common.html#toSourceMetadata"><span class="hs-identifier hs-var">toSourceMetadata</span></a></span><span>
</span><span id="line-217"></span><span>      </span><span id="local-6989586621689751545"><span class="annot"><span class="annottext">SourceMetadata ('Postgres 'Vanilla)
</span><a href="#local-6989586621689751545"><span class="hs-identifier hs-var">defaultSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-218"></span><span>        </span><span class="annot"><span class="annottext">Maybe (SourceMetadata ('Postgres 'Vanilla))
-&gt; m (SourceMetadata ('Postgres 'Vanilla))
-&gt; m (SourceMetadata ('Postgres 'Vanilla))
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceMetadata ('Postgres 'Vanilla))
</span><a href="#local-6989586621689751547"><span class="hs-identifier hs-var">maybeDefaultSourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(m (SourceMetadata ('Postgres 'Vanilla))
 -&gt; m (SourceMetadata ('Postgres 'Vanilla)))
-&gt; m (SourceMetadata ('Postgres 'Vanilla))
-&gt; m (SourceMetadata ('Postgres 'Vanilla))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-219"></span><span>          </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m (SourceMetadata ('Postgres 'Vanilla))
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cannot import metadata without sources since no default source is defined&quot;</span></span><span>
</span><span id="line-220"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751541"><span class="annot"><span class="annottext">newDefaultSourceMetadata :: BackendSourceMetadata
</span><a href="#local-6989586621689751541"><span class="hs-identifier hs-var hs-var">newDefaultSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-221"></span><span>            </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata -&gt; BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-var">BackendSourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(AnyBackend SourceMetadata -&gt; BackendSourceMetadata)
-&gt; AnyBackend SourceMetadata -&gt; BackendSourceMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-222"></span><span>              </span><span class="annot"><span class="annottext">SourceMetadata ('Postgres 'Vanilla) -&gt; AnyBackend SourceMetadata
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span>
</span><span id="line-223"></span><span>                </span><span class="annot"><span class="annottext">SourceMetadata ('Postgres 'Vanilla)
</span><a href="#local-6989586621689751545"><span class="hs-identifier hs-var">defaultSourceMetadata</span></a></span><span>
</span><span id="line-224"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_smTables :: Tables ('Postgres 'Vanilla)
</span><a href="Hasura.RQL.Types.Metadata.Common.html#_smTables"><span class="hs-identifier hs-var">_smTables</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tables ('Postgres 'Vanilla)
</span><a href="#local-6989586621689751563"><span class="hs-identifier hs-var">_mnsTables</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-225"></span><span>                    </span><span class="annot"><span class="annottext">_smFunctions :: Functions ('Postgres 'Vanilla)
</span><a href="#local-6989586621689751539"><span class="hs-identifier hs-var">_smFunctions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Functions ('Postgres 'Vanilla)
</span><a href="#local-6989586621689751562"><span class="hs-identifier hs-var">_mnsFunctions</span></a></span><span>
</span><span id="line-226"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-227"></span><span>      </span><span class="annot"><span class="annottext">Metadata -&gt; m Metadata
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Metadata -&gt; m Metadata) -&gt; Metadata -&gt; m Metadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-228"></span><span>        </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
-&gt; RemoteSchemas
-&gt; QueryCollections
-&gt; MetadataAllowlist
-&gt; CustomTypes
-&gt; Actions
-&gt; CronTriggers
-&gt; Endpoints
-&gt; ApiLimit
-&gt; MetricsConfig
-&gt; InheritedRoles
-&gt; SetGraphqlIntrospectionOptions
-&gt; Network
-&gt; BackendMap BackendConfigWrapper
-&gt; Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#Metadata"><span class="hs-identifier hs-var">Metadata</span></a></span><span>
</span><span id="line-229"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
-&gt; BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
forall k v. Hashable k =&gt; k -&gt; v -&gt; InsOrdHashMap k v
</span><span class="hs-identifier hs-var">OMap.singleton</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-var">defaultSource</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751541"><span class="hs-identifier hs-var">newDefaultSourceMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>          </span><span class="annot"><span class="annottext">RemoteSchemas
</span><a href="#local-6989586621689751561"><span class="hs-identifier hs-var">_mnsRemoteSchemas</span></a></span><span>
</span><span id="line-231"></span><span>          </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621689751560"><span class="hs-identifier hs-var">_mnsQueryCollections</span></a></span><span>
</span><span id="line-232"></span><span>          </span><span class="annot"><span class="annottext">MetadataAllowlist
</span><a href="#local-6989586621689751559"><span class="hs-identifier hs-var">_mnsAllowlist</span></a></span><span>
</span><span id="line-233"></span><span>          </span><span class="annot"><span class="annottext">CustomTypes
</span><a href="#local-6989586621689751558"><span class="hs-identifier hs-var">_mnsCustomTypes</span></a></span><span>
</span><span id="line-234"></span><span>          </span><span class="annot"><span class="annottext">Actions
</span><a href="#local-6989586621689751557"><span class="hs-identifier hs-var">_mnsActions</span></a></span><span>
</span><span id="line-235"></span><span>          </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751570"><span class="hs-identifier hs-var">cronTriggersMetadata</span></a></span><span>
</span><span id="line-236"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; Endpoints
</span><a href="Hasura.RQL.Types.Metadata.html#_metaRestEndpoints"><span class="hs-identifier hs-var hs-var">_metaRestEndpoints</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751573"><span class="hs-identifier hs-var">oldMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>          </span><span class="annot"><span class="annottext">ApiLimit
</span><a href="Hasura.RQL.Types.ApiLimit.html#emptyApiLimit"><span class="hs-identifier hs-var">emptyApiLimit</span></a></span><span>
</span><span id="line-238"></span><span>          </span><span class="annot"><span class="annottext">MetricsConfig
</span><a href="Hasura.RQL.Types.Common.html#emptyMetricsConfig"><span class="hs-identifier hs-var">emptyMetricsConfig</span></a></span><span>
</span><span id="line-239"></span><span>          </span><span class="annot"><span class="annottext">InheritedRoles
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-240"></span><span>          </span><span class="annot"><span class="annottext">SetGraphqlIntrospectionOptions
</span><a href="#local-6989586621689751577"><span class="hs-identifier hs-var">introspectionDisabledRoles</span></a></span><span>
</span><span id="line-241"></span><span>          </span><span class="annot"><span class="annottext">Network
</span><a href="Hasura.RQL.Types.Network.html#emptyNetwork"><span class="hs-identifier hs-var">emptyNetwork</span></a></span><span>
</span><span id="line-242"></span><span>          </span><span class="annot"><span class="annottext">BackendMap BackendConfigWrapper
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><span class="annottext">Metadata -&gt; m ()
forall (m :: * -&gt; *). MetadataM m =&gt; Metadata -&gt; m ()
</span><a href="Hasura.RQL.Types.Metadata.html#putMetadata"><span class="hs-identifier hs-var">putMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751567"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751531"><span class="annot"><span class="annottext">oldSources :: InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751531"><span class="hs-identifier hs-var hs-var">oldSources</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.html#_metaSources"><span class="hs-identifier hs-var hs-var">_metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751573"><span class="hs-identifier hs-var">oldMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751530"><span class="annot"><span class="annottext">newSources :: InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751530"><span class="hs-identifier hs-var hs-var">newSources</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.html#_metaSources"><span class="hs-identifier hs-var hs-var">_metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751567"><span class="hs-identifier hs-var">metadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-comment">-- Clean up the sources that are not present in the new metadata</span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><span class="annottext">[(SourceName, BackendSourceMetadata)]
-&gt; ((SourceName, BackendSourceMetadata) -&gt; m BackendSourceMetadata)
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
-&gt; [(SourceName, BackendSourceMetadata)]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751531"><span class="hs-identifier hs-var">oldSources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SourceName, BackendSourceMetadata) -&gt; m BackendSourceMetadata)
 -&gt; m ())
-&gt; ((SourceName, BackendSourceMetadata) -&gt; m BackendSourceMetadata)
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751529"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751529"><span class="hs-identifier hs-var">oldSource</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689751528"><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751528"><span class="hs-identifier hs-var">oldSourceBackendMetadata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-comment">-- If the source present in old metadata is not present in the new metadata,</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-comment">-- clean that source.</span><span>
</span><span id="line-252"></span><span>    </span><span class="annot"><span class="annottext">Maybe BackendSourceMetadata
-&gt; m BackendSourceMetadata -&gt; m BackendSourceMetadata
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; Maybe BackendSourceMetadata
forall k v. (Eq k, Hashable k) =&gt; k -&gt; InsOrdHashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751529"><span class="hs-identifier hs-var">oldSource</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751530"><span class="hs-identifier hs-var">newSources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m BackendSourceMetadata -&gt; m BackendSourceMetadata)
-&gt; m BackendSourceMetadata -&gt; m BackendSourceMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-253"></span><span>      </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata
-&gt; (forall (b :: BackendType).
    BackendMetadata b =&gt;
    SourceMetadata b -&gt; m BackendSourceMetadata)
-&gt; m BackendSourceMetadata
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BackendSourceMetadata -&gt; AnyBackend SourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#unBackendSourceMetadata"><span class="hs-identifier hs-var hs-var">unBackendSourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751528"><span class="hs-identifier hs-var">oldSourceBackendMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751526"><span id="local-6989586621689751525"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751525"><span class="hs-identifier hs-var">_oldSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751526"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-254"></span><span>        </span><span id="local-6989586621689751524"><span class="annot"><span class="annottext">SourceInfo b
</span><a href="#local-6989586621689751524"><span class="hs-identifier hs-var">sourceInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; m (SourceInfo b)
forall (b :: BackendType) (m :: * -&gt; *).
(CacheRM m, MetadataM m, MonadError QErr m, Backend b) =&gt;
SourceName -&gt; m (SourceInfo b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSourceInfo"><span class="hs-identifier hs-var">askSourceInfo</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751526"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751529"><span class="hs-identifier hs-var">oldSource</span></a></span><span>
</span><span id="line-255"></span><span>        </span><span class="annot"><span class="annottext">SourceName -&gt; SourceInfo b -&gt; m ()
forall (m :: * -&gt; *) r (b :: BackendType).
(MonadError QErr m, MonadIO m, MonadBaseControl IO m,
 MonadReader r m, Has (Logger Hasura) r, BackendMetadata b) =&gt;
SourceName -&gt; SourceInfo b -&gt; m ()
</span><a href="Hasura.RQL.DDL.Schema.Source.html#runPostDropSourceHook"><span class="hs-identifier hs-var">runPostDropSourceHook</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751529"><span class="hs-identifier hs-var">oldSource</span></a></span><span> </span><span class="annot"><span class="annottext">SourceInfo b
</span><a href="#local-6989586621689751524"><span class="hs-identifier hs-var">sourceInfo</span></a></span><span>
</span><span id="line-256"></span><span>        </span><span class="annot"><span class="annottext">BackendSourceMetadata -&gt; m BackendSourceMetadata
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnyBackend SourceMetadata -&gt; BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-var">BackendSourceMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceMetadata b -&gt; AnyBackend SourceMetadata
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751525"><span class="hs-identifier hs-var">_oldSourceMetadata</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-comment">-- Check for duplicate trigger names in the new source metadata</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">[(SourceName, BackendSourceMetadata)]
-&gt; ((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
-&gt; [(SourceName, BackendSourceMetadata)]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751530"><span class="hs-identifier hs-var">newSources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ())
-&gt; ((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751523"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751523"><span class="hs-identifier hs-var">source</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689751522"><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751522"><span class="hs-identifier hs-var">newBackendSourceMetadata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><span class="annottext">Maybe BackendSourceMetadata
-&gt; (BackendSourceMetadata -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; Maybe BackendSourceMetadata
forall k v. (Eq k, Hashable k) =&gt; k -&gt; InsOrdHashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751523"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751531"><span class="hs-identifier hs-var">oldSources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((BackendSourceMetadata -&gt; m ()) -&gt; m ())
-&gt; (BackendSourceMetadata -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689751520"><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751520"><span class="hs-identifier hs-var">_oldBackendSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-261"></span><span>      </span><span class="annot"><span class="annottext">BackendSourceMetadata
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceMetadata b -&gt; m ())
-&gt; m ()
forall r.
BackendSourceMetadata
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceMetadata b -&gt; r)
-&gt; r
</span><a href="#local-6989586621689751519"><span class="hs-identifier hs-var">dispatch</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751522"><span class="hs-identifier hs-var">newBackendSourceMetadata</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751518"><span id="local-6989586621689751517"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751517"><span class="hs-identifier hs-var">newSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751518"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751516"><span class="annot"><span class="annottext">newTriggerNames :: [TriggerName]
</span><a href="#local-6989586621689751516"><span class="hs-identifier hs-var hs-var">newTriggerNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TableMetadata b -&gt; [TriggerName])
-&gt; [TableMetadata b] -&gt; [TriggerName]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b) -&gt; [TriggerName]
forall k v. InsOrdHashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">OMap.keys</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap TriggerName (EventTriggerConf b) -&gt; [TriggerName])
-&gt; (TableMetadata b
    -&gt; InsOrdHashMap TriggerName (EventTriggerConf b))
-&gt; TableMetadata b
-&gt; [TriggerName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableMetadata b -&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
forall (b :: BackendType). TableMetadata b -&gt; EventTriggers b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#_tmEventTriggers"><span class="hs-identifier hs-var hs-var">_tmEventTriggers</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InsOrdHashMap (TableName b) (TableMetadata b) -&gt; [TableMetadata b]
forall k v. InsOrdHashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">OMap.elems</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap (TableName b) (TableMetadata b)
 -&gt; [TableMetadata b])
-&gt; InsOrdHashMap (TableName b) (TableMetadata b)
-&gt; [TableMetadata b]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; InsOrdHashMap (TableName b) (TableMetadata b)
forall (b :: BackendType). SourceMetadata b -&gt; Tables b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#_smTables"><span class="hs-identifier hs-var hs-var">_smTables</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751517"><span class="hs-identifier hs-var">newSourceMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>            </span><span id="local-6989586621689751511"><span class="annot"><span class="annottext">duplicateTriggerNamesInNewMetadata :: [TriggerName]
</span><a href="#local-6989586621689751511"><span class="hs-identifier hs-var hs-var">duplicateTriggerNamesInNewMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689751516"><span class="hs-identifier hs-var">newTriggerNames</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName] -&gt; [TriggerName] -&gt; [TriggerName]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">\\</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TriggerName] -&gt; [TriggerName]
forall a. (Hashable a, Eq a) =&gt; [a] -&gt; [a]
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">hashNub</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689751516"><span class="hs-identifier hs-var">newTriggerNames</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TriggerName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689751511"><span class="hs-identifier hs-var">duplicateTriggerNamesInNewMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>          </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Event trigger with duplicate names not allowed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#dquoteList"><span class="hs-identifier hs-var">dquoteList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TriggerName -&gt; Text) -&gt; [TriggerName] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689751511"><span class="hs-identifier hs-var">duplicateTriggerNamesInNewMetadata</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AllowInconsistentMetadata
</span><a href="#local-6989586621689751583"><span class="hs-identifier hs-var">_rmv2AllowInconsistentMetadata</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><span class="annottext">AllowInconsistentMetadata
</span><a href="Hasura.RQL.DDL.Metadata.Types.html#AllowInconsistentMetadata"><span class="hs-identifier hs-var">AllowInconsistentMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-269"></span><span>      </span><span class="annot"><span class="annottext">MetadataModifier -&gt; m ()
forall (m :: * -&gt; *).
(MetadataM m, CacheRWM m) =&gt;
MetadataModifier -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCache"><span class="hs-identifier hs-var">buildSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataModifier
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="annottext">AllowInconsistentMetadata
</span><a href="Hasura.RQL.DDL.Metadata.Types.html#NoAllowInconsistentMetadata"><span class="hs-identifier hs-var">NoAllowInconsistentMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-271"></span><span>      </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). (QErrM m, CacheRWM m, MetadataM m) =&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCacheStrict"><span class="hs-identifier hs-var">buildSchemaCacheStrict</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-comment">-- populate future cron events for all the new cron triggers that are imported</span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><span class="annottext">HashMap TriggerName CronTriggerMetadata
-&gt; (CronTriggerMetadata -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName CronTriggerMetadata
</span><a href="#local-6989586621689751569"><span class="hs-identifier hs-var">cronTriggersToBeAdded</span></a></span><span> </span><span class="annot"><span class="annottext">((CronTriggerMetadata -&gt; m ()) -&gt; m ())
-&gt; (CronTriggerMetadata -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.RQL.Types.ScheduledTrigger.html#CronTriggerMetadata"><span class="hs-identifier hs-type">CronTriggerMetadata</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689751492"><span id="local-6989586621689751493"><span id="local-6989586621689751494"><span id="local-6989586621689751495"><span id="local-6989586621689751496"><span id="local-6989586621689751497"><span id="local-6989586621689751498"><span id="local-6989586621689751499"><span id="local-6989586621689751500"><span id="local-6989586621689751501"><span class="annot"><span class="annottext">Bool
[HeaderConf]
Maybe Value
Maybe Text
Maybe MetadataResponseTransform
Maybe RequestTransform
CronSchedule
InputWebhook
TriggerName
STRetryConf
ctResponseTransform :: CronTriggerMetadata -&gt; Maybe MetadataResponseTransform
ctRequestTransform :: CronTriggerMetadata -&gt; Maybe RequestTransform
ctComment :: CronTriggerMetadata -&gt; Maybe Text
ctIncludeInMetadata :: CronTriggerMetadata -&gt; Bool
ctHeaders :: CronTriggerMetadata -&gt; [HeaderConf]
ctRetryConf :: CronTriggerMetadata -&gt; STRetryConf
ctPayload :: CronTriggerMetadata -&gt; Maybe Value
ctSchedule :: CronTriggerMetadata -&gt; CronSchedule
ctWebhook :: CronTriggerMetadata -&gt; InputWebhook
ctName :: CronTriggerMetadata -&gt; TriggerName
ctResponseTransform :: Maybe MetadataResponseTransform
ctRequestTransform :: Maybe RequestTransform
ctComment :: Maybe Text
ctIncludeInMetadata :: Bool
ctHeaders :: [HeaderConf]
ctRetryConf :: STRetryConf
ctPayload :: Maybe Value
ctSchedule :: CronSchedule
ctWebhook :: InputWebhook
ctName :: TriggerName
</span><a href="Hasura.RQL.Types.ScheduledTrigger.html#ctResponseTransform"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-275"></span><span>    </span><span class="annot"><span class="annottext">CronSchedule -&gt; TriggerName -&gt; m ()
forall (m :: * -&gt; *).
(MonadIO m, MonadMetadataStorageQueryAPI m) =&gt;
CronSchedule -&gt; TriggerName -&gt; m ()
</span><a href="Hasura.RQL.DDL.ScheduledTrigger.html#populateInitialCronTriggerEvents"><span class="hs-identifier hs-var">populateInitialCronTriggerEvents</span></a></span><span> </span><span class="annot"><span class="annottext">CronSchedule
</span><a href="#local-6989586621689751499"><span class="hs-identifier hs-var">ctSchedule</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751501"><span class="hs-identifier hs-var">ctName</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-comment">-- See Note [Cleanup for dropped triggers]</span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; SchemaCache
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; m ()
</span><a href="#local-6989586621689751480"><span class="hs-identifier hs-var">dropSourceSQLTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689751579"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689751572"><span class="hs-identifier hs-var">oldSchemaCache</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.html#_metaSources"><span class="hs-identifier hs-var hs-var">_metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751573"><span class="hs-identifier hs-var">oldMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.html#_metaSources"><span class="hs-identifier hs-var hs-var">_metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751567"><span class="hs-identifier hs-var">metadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata -&gt; m ()
</span><a href="#local-6989586621689751479"><span class="hs-identifier hs-var">generateSQLTriggerCleanupSchedules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.html#_metaSources"><span class="hs-identifier hs-var hs-var">_metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751573"><span class="hs-identifier hs-var">oldMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.html#_metaSources"><span class="hs-identifier hs-var hs-var">_metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751567"><span class="hs-identifier hs-var">metadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><span class="annottext">Value -&gt; EncJSON
forall a. ToJSON a =&gt; a -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromJValue"><span class="hs-identifier hs-var">encJFromJValue</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; EncJSON)
-&gt; (SchemaCache -&gt; Value) -&gt; SchemaCache -&gt; EncJSON
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata] -&gt; Value
</span><a href="Hasura.RQL.DDL.Metadata.html#formatInconsistentObjs"><span class="hs-identifier hs-var">formatInconsistentObjs</span></a></span><span> </span><span class="annot"><span class="annottext">([InconsistentMetadata] -&gt; Value)
-&gt; (SchemaCache -&gt; [InconsistentMetadata]) -&gt; SchemaCache -&gt; Value
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; [InconsistentMetadata]
</span><a href="Hasura.RQL.Types.SchemaCache.html#scInconsistentObjs"><span class="hs-identifier hs-var hs-var">scInconsistentObjs</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; EncJSON) -&gt; m SchemaCache -&gt; m EncJSON
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m SchemaCache
forall (m :: * -&gt; *). CacheRM m =&gt; m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var">askSchemaCache</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-comment">{- Note [Cron triggers behaviour with replace metadata]
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    When the metadata is replaced, we delete only the cron triggers
    that were deleted, instead of deleting all the old cron triggers (which
    existed in the metadata before it was replaced) and inserting all the
    new cron triggers. This is done this way, because when a cron trigger is
    dropped, the cron events associated with it will also be dropped from the DB
    and when a new cron trigger is added, new cron events are generated by the
    graphql-engine. So, this way we only delete and insert the data which has been changed.

    The cron triggers that were deleted is calculated by getting a diff
    of the old cron triggers and the new cron triggers. Note that we don't just
    check the name of the trigger to calculate the diff, the whole cron trigger
    definition is considered in the calculation.

    Note: Only cron triggers with `include_in_metadata` set to `true` can be updated/deleted
    via the replace metadata API. Cron triggers with `include_in_metadata` can only be modified
    via the `create_cron_trigger` and `delete_cron_trigger` APIs.

    -}</span><span>
</span><span id="line-305"></span><span>    </span><span id="local-6989586621689751568"><span class="annot"><span class="annottext">processCronTriggers :: Metadata
-&gt; m (CronTriggers, HashMap TriggerName CronTriggerMetadata)
</span><a href="#local-6989586621689751568"><span class="hs-identifier hs-var hs-var">processCronTriggers</span></a></span></span><span> </span><span id="local-6989586621689751474"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751474"><span class="hs-identifier hs-var">oldMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689751473"><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751473"><span class="hs-identifier hs-var">oldCronTriggersIncludedInMetadata</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689751472"><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751472"><span class="hs-identifier hs-var">oldCronTriggersNotIncludedInMetadata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-307"></span><span>            </span><span class="annot"><span class="annottext">(CronTriggerMetadata -&gt; Bool)
-&gt; CronTriggers -&gt; (CronTriggers, CronTriggers)
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; Bool)
-&gt; InsOrdHashMap k v -&gt; (InsOrdHashMap k v, InsOrdHashMap k v)
</span><a href="Data.HashMap.Strict.InsOrd.Extended.html#partition"><span class="hs-identifier hs-var">OMap.partition</span></a></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata -&gt; Bool
</span><a href="Hasura.RQL.Types.ScheduledTrigger.html#ctIncludeInMetadata"><span class="hs-identifier hs-var hs-var">ctIncludeInMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; CronTriggers
</span><a href="Hasura.RQL.Types.Metadata.html#_metaCronTriggers"><span class="hs-identifier hs-var hs-var">_metaCronTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751474"><span class="hs-identifier hs-var">oldMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>          </span><span id="local-6989586621689751470"><span class="annot"><span class="annottext">allNewCronTriggers :: CronTriggers
</span><a href="#local-6989586621689751470"><span class="hs-identifier hs-var hs-var">allNewCronTriggers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-309"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ReplaceMetadataV1
</span><a href="#local-6989586621689751582"><span class="hs-identifier hs-var">_rmv2Metadata</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-310"></span><span>              </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RMWithoutSources"><span class="hs-identifier hs-type">RMWithoutSources</span></a></span><span> </span><span id="local-6989586621689751469"><span class="annot"><span class="annottext">MetadataNoSources
</span><a href="#local-6989586621689751469"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetadataNoSources -&gt; CronTriggers
</span><a href="Hasura.RQL.Types.Metadata.html#_mnsCronTriggers"><span class="hs-identifier hs-var hs-var">_mnsCronTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataNoSources
</span><a href="#local-6989586621689751469"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-311"></span><span>              </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RMWithSources"><span class="hs-identifier hs-type">RMWithSources</span></a></span><span> </span><span id="local-6989586621689751468"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751468"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; CronTriggers
</span><a href="Hasura.RQL.Types.Metadata.html#_metaCronTriggers"><span class="hs-identifier hs-var hs-var">_metaCronTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751468"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-312"></span><span>          </span><span class="hs-comment">-- this function is intended to use with `Map.differenceWith`, it's used when two</span><span>
</span><span id="line-313"></span><span>          </span><span class="hs-comment">-- equal keys are encountered, then the values are compared to calculate the diff.</span><span>
</span><span id="line-314"></span><span>          </span><span class="hs-comment">-- see https://hackage.haskell.org/package/unordered-containers-0.2.14.0/docs/Data-HashMap-Internal.html#v:differenceWith</span><span>
</span><span id="line-315"></span><span>          </span><span id="local-6989586621689751467"><span class="annot"><span class="annottext">leftIfDifferent :: a -&gt; a -&gt; Maybe a
</span><a href="#local-6989586621689751467"><span class="hs-identifier hs-var hs-var">leftIfDifferent</span></a></span></span><span> </span><span id="local-6989586621689751466"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689751466"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621689751465"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689751465"><span class="hs-identifier hs-var">r</span></a></span></span><span>
</span><span id="line-316"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689751466"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689751465"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-317"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689751466"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-318"></span><span>          </span><span id="local-6989586621689751464"><span class="annot"><span class="annottext">cronTriggersToBeAdded :: HashMap TriggerName CronTriggerMetadata
</span><a href="#local-6989586621689751464"><span class="hs-identifier hs-var hs-var">cronTriggersToBeAdded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-319"></span><span>            </span><span class="annot"><span class="annottext">(CronTriggerMetadata
 -&gt; CronTriggerMetadata -&gt; Maybe CronTriggerMetadata)
-&gt; HashMap TriggerName CronTriggerMetadata
-&gt; HashMap TriggerName CronTriggerMetadata
-&gt; HashMap TriggerName CronTriggerMetadata
forall k v w.
(Eq k, Hashable k) =&gt;
(v -&gt; w -&gt; Maybe v) -&gt; HashMap k v -&gt; HashMap k w -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.differenceWith</span></span><span>
</span><span id="line-320"></span><span>              </span><span class="annot"><span class="annottext">CronTriggerMetadata
-&gt; CronTriggerMetadata -&gt; Maybe CronTriggerMetadata
forall a. Eq a =&gt; a -&gt; a -&gt; Maybe a
</span><a href="#local-6989586621689751467"><span class="hs-identifier hs-var">leftIfDifferent</span></a></span><span>
</span><span id="line-321"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CronTriggers -&gt; HashMap TriggerName CronTriggerMetadata
forall k v. InsOrdHashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">OMap.toHashMap</span></span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751470"><span class="hs-identifier hs-var">allNewCronTriggers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CronTriggers -&gt; HashMap TriggerName CronTriggerMetadata
forall k v. InsOrdHashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">OMap.toHashMap</span></span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751473"><span class="hs-identifier hs-var">oldCronTriggersIncludedInMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>          </span><span id="local-6989586621689751461"><span class="annot"><span class="annottext">cronTriggersToBeDropped :: HashMap TriggerName CronTriggerMetadata
</span><a href="#local-6989586621689751461"><span class="hs-identifier hs-var hs-var">cronTriggersToBeDropped</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-324"></span><span>            </span><span class="annot"><span class="annottext">(CronTriggerMetadata
 -&gt; CronTriggerMetadata -&gt; Maybe CronTriggerMetadata)
-&gt; HashMap TriggerName CronTriggerMetadata
-&gt; HashMap TriggerName CronTriggerMetadata
-&gt; HashMap TriggerName CronTriggerMetadata
forall k v w.
(Eq k, Hashable k) =&gt;
(v -&gt; w -&gt; Maybe v) -&gt; HashMap k v -&gt; HashMap k w -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.differenceWith</span></span><span>
</span><span id="line-325"></span><span>              </span><span class="annot"><span class="annottext">CronTriggerMetadata
-&gt; CronTriggerMetadata -&gt; Maybe CronTriggerMetadata
forall a. Eq a =&gt; a -&gt; a -&gt; Maybe a
</span><a href="#local-6989586621689751467"><span class="hs-identifier hs-var">leftIfDifferent</span></a></span><span>
</span><span id="line-326"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CronTriggers -&gt; HashMap TriggerName CronTriggerMetadata
forall k v. InsOrdHashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">OMap.toHashMap</span></span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751473"><span class="hs-identifier hs-var">oldCronTriggersIncludedInMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CronTriggers -&gt; HashMap TriggerName CronTriggerMetadata
forall k v. InsOrdHashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">OMap.toHashMap</span></span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751470"><span class="hs-identifier hs-var">allNewCronTriggers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">ClearCronEvents -&gt; m ()
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
ClearCronEvents -&gt; m ()
</span><a href="Hasura.Metadata.Class.html#dropFutureCronEvents"><span class="hs-identifier hs-var">dropFutureCronEvents</span></a></span><span> </span><span class="annot"><span class="annottext">(ClearCronEvents -&gt; m ()) -&gt; ClearCronEvents -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TriggerName] -&gt; ClearCronEvents
</span><a href="Hasura.RQL.Types.ScheduledTrigger.html#MetadataCronTriggers"><span class="hs-identifier hs-var">MetadataCronTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">([TriggerName] -&gt; ClearCronEvents)
-&gt; [TriggerName] -&gt; ClearCronEvents
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName CronTriggerMetadata -&gt; [TriggerName]
forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">Map.keys</span></span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName CronTriggerMetadata
</span><a href="#local-6989586621689751461"><span class="hs-identifier hs-var">cronTriggersToBeDropped</span></a></span><span>
</span><span id="line-329"></span><span>      </span><span id="local-6989586621689751457"><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751457"><span class="hs-identifier hs-var">cronTriggers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-330"></span><span>        </span><span class="hs-comment">-- traverse over the new cron triggers and check if any of them</span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-comment">-- already exists as a cron trigger with &quot;included_in_metadata: false&quot;</span><span>
</span><span id="line-332"></span><span>        </span><span class="annot"><span class="annottext">CronTriggers -&gt; (CronTriggerMetadata -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751470"><span class="hs-identifier hs-var">allNewCronTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">((CronTriggerMetadata -&gt; m ()) -&gt; m ())
-&gt; (CronTriggerMetadata -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689751456"><span class="annot"><span class="annottext">CronTriggerMetadata
</span><a href="#local-6989586621689751456"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-333"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CronTriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.ScheduledTrigger.html#ctName"><span class="hs-identifier hs-var hs-var">ctName</span></a></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata
</span><a href="#local-6989586621689751456"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; CronTriggers -&gt; Bool
forall k a. (Eq k, Hashable k) =&gt; k -&gt; InsOrdHashMap k a -&gt; Bool
</span><span class="hs-operator hs-var">`OMap.member`</span></span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751472"><span class="hs-identifier hs-var">oldCronTriggersNotIncludedInMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-334"></span><span>            </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#AlreadyExists"><span class="hs-identifier hs-var">AlreadyExists</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-335"></span><span>              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cron trigger with name &quot;</span></span><span>
</span><span id="line-336"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.ScheduledTrigger.html#ctName"><span class="hs-identifier hs-var hs-var">ctName</span></a></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata
</span><a href="#local-6989586621689751456"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-337"></span><span>                </span><span class="annot"><span class="annottext">TriggerName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; already exists as a cron trigger with \&quot;included_in_metadata\&quot; as false&quot;</span></span><span>
</span><span id="line-338"></span><span>        </span><span class="hs-comment">-- we add the old cron triggers with included_in_metadata set to false with the</span><span>
</span><span id="line-339"></span><span>        </span><span class="hs-comment">-- newly added cron triggers</span><span>
</span><span id="line-340"></span><span>        </span><span class="annot"><span class="annottext">CronTriggers -&gt; m CronTriggers
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(CronTriggers -&gt; m CronTriggers) -&gt; CronTriggers -&gt; m CronTriggers
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751470"><span class="hs-identifier hs-var">allNewCronTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">CronTriggers -&gt; CronTriggers -&gt; CronTriggers
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751472"><span class="hs-identifier hs-var">oldCronTriggersNotIncludedInMetadata</span></a></span><span>
</span><span id="line-341"></span><span>      </span><span class="annot"><span class="annottext">(CronTriggers, HashMap TriggerName CronTriggerMetadata)
-&gt; m (CronTriggers, HashMap TriggerName CronTriggerMetadata)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">((CronTriggers, HashMap TriggerName CronTriggerMetadata)
 -&gt; m (CronTriggers, HashMap TriggerName CronTriggerMetadata))
-&gt; (CronTriggers, HashMap TriggerName CronTriggerMetadata)
-&gt; m (CronTriggers, HashMap TriggerName CronTriggerMetadata)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751457"><span class="hs-identifier hs-var">cronTriggers</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName CronTriggerMetadata
</span><a href="#local-6989586621689751464"><span class="hs-identifier hs-var">cronTriggersToBeAdded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><a href="#local-6989586621689751480"><span class="hs-identifier hs-type">dropSourceSQLTriggers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-344"></span><span>      </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">HL.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">HL.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-345"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#SchemaCache"><span class="hs-identifier hs-type">SchemaCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-346"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">InsOrdHashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-type">BackendSourceMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-347"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">InsOrdHashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-type">BackendSourceMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-348"></span><span>      </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>    </span><span id="local-6989586621689751480"><span class="annot"><span class="annottext">dropSourceSQLTriggers :: Logger Hasura
-&gt; SchemaCache
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; m ()
</span><a href="#local-6989586621689751480"><span class="hs-identifier hs-var hs-var">dropSourceSQLTriggers</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">HL.Logger</span></a></span><span> </span><span id="local-6989586621689751451"><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621689751451"><span class="hs-identifier hs-var">logger</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689751450"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689751450"><span class="hs-identifier hs-var">oldSchemaCache</span></a></span></span><span> </span><span id="local-6989586621689751449"><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751449"><span class="hs-identifier hs-var">oldSources</span></a></span></span><span> </span><span id="local-6989586621689751448"><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751448"><span class="hs-identifier hs-var">newSources</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>      </span><span class="hs-comment">-- NOTE: the current implementation of this function has an edge case.</span><span>
</span><span id="line-351"></span><span>      </span><span class="hs-comment">-- The edge case is that when a `SourceA` which contained some event triggers</span><span>
</span><span id="line-352"></span><span>      </span><span class="hs-comment">-- is modified to point to a new database, this function will try to drop the</span><span>
</span><span id="line-353"></span><span>      </span><span class="hs-comment">-- SQL triggers of the dropped event triggers on the new database which doesn't exist.</span><span>
</span><span id="line-354"></span><span>      </span><span class="hs-comment">-- In the current implementation, this doesn't throw an error because the trigger is dropped</span><span>
</span><span id="line-355"></span><span>      </span><span class="hs-comment">-- using `DROP IF EXISTS..` meaning this silently fails without throwing an error.</span><span>
</span><span id="line-356"></span><span>      </span><span class="annot"><span class="annottext">[(SourceName, BackendSourceMetadata)]
-&gt; ((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
-&gt; [(SourceName, BackendSourceMetadata)]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751448"><span class="hs-identifier hs-var">newSources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ())
-&gt; ((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751447"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751447"><span class="hs-identifier hs-var">source</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689751446"><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751446"><span class="hs-identifier hs-var">newBackendSourceMetadata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><span class="annottext">Maybe BackendSourceMetadata
-&gt; (BackendSourceMetadata -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; Maybe BackendSourceMetadata
forall k v. (Eq k, Hashable k) =&gt; k -&gt; InsOrdHashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751447"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751449"><span class="hs-identifier hs-var">oldSources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((BackendSourceMetadata -&gt; m ()) -&gt; m ())
-&gt; (BackendSourceMetadata -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689751445"><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751445"><span class="hs-identifier hs-var">oldBackendSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>          </span><span class="annot"><span class="annottext">SourceName
-&gt; AnyBackend SourceMetadata
-&gt; AnyBackend SourceMetadata
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceMetadata b -&gt; SourceMetadata b -&gt; m ())
-&gt; m ()
forall (i :: BackendType -&gt; *).
SourceName
-&gt; AnyBackend i
-&gt; AnyBackend i
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    i b -&gt; i b -&gt; m ())
-&gt; m ()
</span><a href="#local-6989586621689751444"><span class="hs-identifier hs-var">compose</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751447"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BackendSourceMetadata -&gt; AnyBackend SourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#unBackendSourceMetadata"><span class="hs-identifier hs-var hs-var">unBackendSourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751446"><span class="hs-identifier hs-var">newBackendSourceMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BackendSourceMetadata -&gt; AnyBackend SourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#unBackendSourceMetadata"><span class="hs-identifier hs-var hs-var">unBackendSourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751445"><span class="hs-identifier hs-var">oldBackendSourceMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751443"><span id="local-6989586621689751442"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751442"><span class="hs-identifier hs-var">newSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751443"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-359"></span><span>            </span><span class="annot"><span class="annottext">BackendSourceMetadata
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceMetadata b -&gt; SourceMetadata b -&gt; m ())
-&gt; SourceMetadata b
-&gt; m ()
forall r.
BackendSourceMetadata
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceMetadata b -&gt; r)
-&gt; r
</span><a href="#local-6989586621689751519"><span class="hs-identifier hs-var">dispatch</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751445"><span class="hs-identifier hs-var">oldBackendSourceMetadata</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689751441"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751441"><span class="hs-identifier hs-var">oldSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-360"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751440"><span class="annot"><span class="annottext">oldTriggersMap :: InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="#local-6989586621689751440"><span class="hs-identifier hs-var hs-var">oldTriggersMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
forall (b :: BackendType).
SourceMetadata b -&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="Hasura.RQL.DDL.EventTrigger.html#getTriggersMap"><span class="hs-identifier hs-var">getTriggersMap</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751441"><span class="hs-identifier hs-var">oldSourceMetadata</span></a></span><span>
</span><span id="line-361"></span><span>                  </span><span id="local-6989586621689751438"><span class="annot"><span class="annottext">newTriggersMap :: InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="#local-6989586621689751438"><span class="hs-identifier hs-var hs-var">newTriggersMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
forall (b :: BackendType).
SourceMetadata b -&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="Hasura.RQL.DDL.EventTrigger.html#getTriggersMap"><span class="hs-identifier hs-var">getTriggersMap</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751442"><span class="hs-identifier hs-var">newSourceMetadata</span></a></span><span>
</span><span id="line-362"></span><span>                  </span><span id="local-6989586621689751437"><span class="annot"><span class="annottext">droppedEventTriggers :: [TriggerName]
</span><a href="#local-6989586621689751437"><span class="hs-identifier hs-var hs-var">droppedEventTriggers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b) -&gt; [TriggerName]
forall k v. InsOrdHashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">OMap.keys</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap TriggerName (EventTriggerConf b) -&gt; [TriggerName])
-&gt; InsOrdHashMap TriggerName (EventTriggerConf b) -&gt; [TriggerName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="#local-6989586621689751440"><span class="hs-identifier hs-var">oldTriggersMap</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b)
-&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
-&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
forall k v w.
(Eq k, Hashable k) =&gt;
InsOrdHashMap k v -&gt; InsOrdHashMap k w -&gt; InsOrdHashMap k v
</span><span class="hs-operator hs-var">`OMap.difference`</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="#local-6989586621689751438"><span class="hs-identifier hs-var">newTriggersMap</span></a></span><span>
</span><span id="line-363"></span><span>                  </span><span id="local-6989586621689751435"><span class="annot"><span class="annottext">retainedNewTriggers :: InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="#local-6989586621689751435"><span class="hs-identifier hs-var hs-var">retainedNewTriggers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="#local-6989586621689751438"><span class="hs-identifier hs-var">newTriggersMap</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b)
-&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
-&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
forall k v w.
(Eq k, Hashable k) =&gt;
InsOrdHashMap k v -&gt; InsOrdHashMap k w -&gt; InsOrdHashMap k v
</span><span class="hs-operator hs-var">`OMap.intersection`</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="#local-6989586621689751440"><span class="hs-identifier hs-var">oldTriggersMap</span></a></span><span>
</span><span id="line-364"></span><span>                  </span><span id="local-6989586621689751433"><span class="annot"><span class="annottext">catcher :: QErr -&gt; f ()
</span><a href="#local-6989586621689751433"><span class="hs-identifier hs-var hs-var">catcher</span></a></span></span><span> </span><span id="local-6989586621689751432"><span class="annot"><span class="annottext">e :: QErr
</span><a href="#local-6989586621689751432"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689751430"><span class="annot"><span class="annottext">Code
qeCode :: QErr -&gt; Code
qeCode :: Code
</span><a href="Hasura.Base.Error.html#qeCode"><span class="hs-identifier hs-var hs-var">qeCode</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-365"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621689751430"><span class="hs-identifier hs-var">qeCode</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#Unexpected"><span class="hs-identifier hs-var">Unexpected</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; f ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- NOTE: This information should be returned by the inconsistent_metadata response, so doesn't need additional logging.</span><span>
</span><span id="line-366"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; f ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689751432"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-comment">-- rethrow other errors</span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span>              </span><span class="hs-comment">-- This will swallow Unexpected exceptions for sources if allow_inconsistent_metadata is enabled</span><span>
</span><span id="line-369"></span><span>              </span><span class="hs-comment">-- This should be ok since if the sources are already missing from the cache then they should</span><span>
</span><span id="line-370"></span><span>              </span><span class="hs-comment">-- not need to be removed.</span><span>
</span><span id="line-371"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-372"></span><span>              </span><span class="hs-comment">-- TODO: Determine if any errors should be thrown from askSourceConfig at all if the errors are just being discarded</span><span>
</span><span id="line-373"></span><span>              </span><span class="annot"><span class="annottext">m () -&gt; SourceMetadata b -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; SourceMetadata b -&gt; m ())
-&gt; m () -&gt; SourceMetadata b -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-374"></span><span>                </span><span class="annot"><span class="annottext">(m () -&gt; (QErr -&gt; m ()) -&gt; m ()) -&gt; (QErr -&gt; m ()) -&gt; m () -&gt; m ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">m () -&gt; (QErr -&gt; m ()) -&gt; m ()
forall e (m :: * -&gt; *) a.
MonadError e m =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">catchError</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; m ()
forall (f :: * -&gt; *). MonadError QErr f =&gt; QErr -&gt; f ()
</span><a href="#local-6989586621689751433"><span class="hs-identifier hs-var">catcher</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-375"></span><span>                  </span><span id="local-6989586621689751424"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621689751424"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; m (SourceConfig b)
forall (b :: BackendType) (m :: * -&gt; *).
(CacheRM m, MonadError QErr m, Backend b, MetadataM m) =&gt;
SourceName -&gt; m (SourceConfig b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSourceConfig"><span class="hs-identifier hs-var">askSourceConfig</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751443"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751447"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-376"></span><span>                  </span><span class="annot"><span class="annottext">[TriggerName] -&gt; (TriggerName -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689751437"><span class="hs-identifier hs-var">droppedEventTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">((TriggerName -&gt; m ()) -&gt; m ()) -&gt; (TriggerName -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-377"></span><span>                    </span><span class="hs-glyph">\</span><span id="local-6989586621689751422"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751422"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-378"></span><span>                      </span><span id="local-6989586621689751421"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621689751421"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceName -&gt; TriggerName -&gt; m (TableName b)
forall (b :: BackendType) (m :: * -&gt; *).
(Backend b, QErrM m) =&gt;
SchemaCache -&gt; SourceName -&gt; TriggerName -&gt; m (TableName b)
</span><a href="Hasura.RQL.DDL.EventTrigger.html#getTableNameFromTrigger"><span class="hs-identifier hs-var">getTableNameFromTrigger</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751443"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689751450"><span class="hs-identifier hs-var">oldSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751447"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751422"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-379"></span><span>                      </span><span class="annot"><span class="annottext">SourceConfig b -&gt; TriggerName -&gt; TableName b -&gt; m ()
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b -&gt; TriggerName -&gt; TableName b -&gt; m ()
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#dropTriggerAndArchiveEvents"><span class="hs-identifier hs-var">dropTriggerAndArchiveEvents</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751443"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621689751424"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751422"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621689751421"><span class="hs-identifier hs-var">tableName</span></a></span><span>
</span><span id="line-380"></span><span>                  </span><span class="annot"><span class="annottext">[(TriggerName, EventTriggerConf b)]
-&gt; ((TriggerName, EventTriggerConf b) -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b)
-&gt; [(TriggerName, EventTriggerConf b)]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="#local-6989586621689751435"><span class="hs-identifier hs-var">retainedNewTriggers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TriggerName, EventTriggerConf b) -&gt; m ()) -&gt; m ())
-&gt; ((TriggerName, EventTriggerConf b) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751418"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751418"><span class="hs-identifier hs-var">retainedNewTriggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689751417"><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621689751417"><span class="hs-identifier hs-var">retainedNewTriggerConf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-381"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; InsOrdHashMap TriggerName (EventTriggerConf b)
-&gt; Maybe (EventTriggerConf b)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; InsOrdHashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751418"><span class="hs-identifier hs-var">retainedNewTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap TriggerName (EventTriggerConf b)
</span><a href="#local-6989586621689751440"><span class="hs-identifier hs-var">oldTriggersMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-382"></span><span>                      </span><span class="annot"><span class="annottext">Maybe (EventTriggerConf b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621689751416"><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621689751416"><span class="hs-identifier hs-var">oldTriggerConf</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-384"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751415"><span class="annot"><span class="annottext">newTriggerOps :: TriggerOpsDef b
</span><a href="#local-6989586621689751415"><span class="hs-identifier hs-var hs-var">newTriggerOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b -&gt; TriggerOpsDef b
forall (b :: BackendType). EventTriggerConf b -&gt; TriggerOpsDef b
</span><a href="Hasura.RQL.Types.EventTrigger.html#etcDefinition"><span class="hs-identifier hs-var hs-var">etcDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621689751417"><span class="hs-identifier hs-var">retainedNewTriggerConf</span></a></span><span>
</span><span id="line-385"></span><span>                            </span><span id="local-6989586621689751413"><span class="annot"><span class="annottext">oldTriggerOps :: TriggerOpsDef b
</span><a href="#local-6989586621689751413"><span class="hs-identifier hs-var hs-var">oldTriggerOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b -&gt; TriggerOpsDef b
forall (b :: BackendType). EventTriggerConf b -&gt; TriggerOpsDef b
</span><a href="Hasura.RQL.Types.EventTrigger.html#etcDefinition"><span class="hs-identifier hs-var hs-var">etcDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerConf b
</span><a href="#local-6989586621689751416"><span class="hs-identifier hs-var">oldTriggerConf</span></a></span><span>
</span><span id="line-386"></span><span>                            </span><span id="local-6989586621689751412"><span class="annot"><span class="annottext">isDroppedOp :: Maybe a -&gt; Maybe a -&gt; Bool
</span><a href="#local-6989586621689751412"><span class="hs-identifier hs-var hs-var">isDroppedOp</span></a></span></span><span> </span><span id="local-6989586621689751411"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621689751411"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621689751410"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621689751410"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621689751411"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621689751410"><span class="hs-identifier hs-var">new</span></a></span><span>
</span><span id="line-387"></span><span>                            </span><span id="local-6989586621689751406"><span class="annot"><span class="annottext">droppedOps :: [Maybe Ops]
</span><a href="#local-6989586621689751406"><span class="hs-identifier hs-var hs-var">droppedOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-388"></span><span>                              </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Ops -&gt; Maybe Ops -&gt; Bool -&gt; Maybe Ops
forall a. a -&gt; a -&gt; Bool -&gt; a
</span><span class="hs-identifier hs-var">bool</span></span><span> </span><span class="annot"><span class="annottext">Maybe Ops
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; Maybe Ops
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec b) -&gt; Maybe (SubscribeOpSpec b) -&gt; Bool
forall a a. Maybe a -&gt; Maybe a -&gt; Bool
</span><a href="#local-6989586621689751412"><span class="hs-identifier hs-var">isDroppedOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdInsert"><span class="hs-identifier hs-var hs-var">tdInsert</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef b
</span><a href="#local-6989586621689751413"><span class="hs-identifier hs-var">oldTriggerOps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdInsert"><span class="hs-identifier hs-var hs-var">tdInsert</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef b
</span><a href="#local-6989586621689751415"><span class="hs-identifier hs-var">newTriggerOps</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-389"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Ops -&gt; Maybe Ops -&gt; Bool -&gt; Maybe Ops
forall a. a -&gt; a -&gt; Bool -&gt; a
</span><span class="hs-identifier hs-var">bool</span></span><span> </span><span class="annot"><span class="annottext">Maybe Ops
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; Maybe Ops
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec b) -&gt; Maybe (SubscribeOpSpec b) -&gt; Bool
forall a a. Maybe a -&gt; Maybe a -&gt; Bool
</span><a href="#local-6989586621689751412"><span class="hs-identifier hs-var">isDroppedOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdUpdate"><span class="hs-identifier hs-var hs-var">tdUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef b
</span><a href="#local-6989586621689751413"><span class="hs-identifier hs-var">oldTriggerOps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdUpdate"><span class="hs-identifier hs-var hs-var">tdUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef b
</span><a href="#local-6989586621689751415"><span class="hs-identifier hs-var">newTriggerOps</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-390"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Ops -&gt; Maybe Ops -&gt; Bool -&gt; Maybe Ops
forall a. a -&gt; a -&gt; Bool -&gt; a
</span><span class="hs-identifier hs-var">bool</span></span><span> </span><span class="annot"><span class="annottext">Maybe Ops
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; Maybe Ops
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">ET.DELETE</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec b) -&gt; Maybe (SubscribeOpSpec b) -&gt; Bool
forall a a. Maybe a -&gt; Maybe a -&gt; Bool
</span><a href="#local-6989586621689751412"><span class="hs-identifier hs-var">isDroppedOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdDelete"><span class="hs-identifier hs-var hs-var">tdDelete</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef b
</span><a href="#local-6989586621689751413"><span class="hs-identifier hs-var">oldTriggerOps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdDelete"><span class="hs-identifier hs-var hs-var">tdDelete</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef b
</span><a href="#local-6989586621689751415"><span class="hs-identifier hs-var">newTriggerOps</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span>                              </span><span class="hs-special">]</span><span>
</span><span id="line-392"></span><span>                        </span><span id="local-6989586621689751398"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621689751398"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceName -&gt; TriggerName -&gt; m (TableName b)
forall (b :: BackendType) (m :: * -&gt; *).
(Backend b, QErrM m) =&gt;
SchemaCache -&gt; SourceName -&gt; TriggerName -&gt; m (TableName b)
</span><a href="Hasura.RQL.DDL.EventTrigger.html#getTableNameFromTrigger"><span class="hs-identifier hs-var">getTableNameFromTrigger</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751443"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689751450"><span class="hs-identifier hs-var">oldSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751447"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751418"><span class="hs-identifier hs-var">retainedNewTriggerName</span></a></span><span>
</span><span id="line-393"></span><span>                        </span><span class="annot"><span class="annottext">SourceConfig b -&gt; TriggerName -&gt; TableName b -&gt; HashSet Ops -&gt; m ()
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b -&gt; TriggerName -&gt; TableName b -&gt; HashSet Ops -&gt; m ()
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#dropDanglingSQLTrigger"><span class="hs-identifier hs-var">dropDanglingSQLTrigger</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751443"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621689751424"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751418"><span class="hs-identifier hs-var">retainedNewTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621689751398"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ops] -&gt; HashSet Ops
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Ops] -&gt; HashSet Ops) -&gt; [Ops] -&gt; HashSet Ops
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Ops] -&gt; [Ops]
forall (f :: * -&gt; *) a. Filterable f =&gt; f (Maybe a) -&gt; f a
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Ops]
</span><a href="#local-6989586621689751406"><span class="hs-identifier hs-var">droppedOps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-395"></span><span>        </span><span id="local-6989586621689751921"><span class="annot"><a href="#local-6989586621689751444"><span class="hs-identifier hs-type">compose</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-396"></span><span>          </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-397"></span><span>          </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html#AnyBackend"><span class="hs-identifier hs-type">AB.AnyBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751921"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-398"></span><span>          </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html#AnyBackend"><span class="hs-identifier hs-type">AB.AnyBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751921"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-399"></span><span>          </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621689751922"><span class="annot"><a href="#local-6989586621689751922"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751922"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689751921"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751922"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689751921"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751922"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-400"></span><span>          </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-401"></span><span>        </span><span id="local-6989586621689751444"><span class="annot"><span class="annottext">compose :: SourceName
-&gt; AnyBackend i
-&gt; AnyBackend i
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    i b -&gt; i b -&gt; m ())
-&gt; m ()
</span><a href="#local-6989586621689751444"><span class="hs-identifier hs-var hs-var">compose</span></a></span></span><span> </span><span id="local-6989586621689751394"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751394"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621689751393"><span class="annot"><span class="annottext">AnyBackend i
</span><a href="#local-6989586621689751393"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621689751392"><span class="annot"><span class="annottext">AnyBackend i
</span><a href="#local-6989586621689751392"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621689751391"><span class="annot"><span class="annottext">forall (b :: BackendType).
BackendEventTrigger b =&gt;
i b -&gt; i b -&gt; m ()
</span><a href="#local-6989586621689751391"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall (b :: BackendType).
 BackendEventTrigger b =&gt;
 i b -&gt; i b -&gt; m ())
-&gt; AnyBackend i -&gt; AnyBackend i -&gt; m () -&gt; m ()
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
(forall (b :: BackendType). c b =&gt; i b -&gt; i b -&gt; r)
-&gt; AnyBackend i -&gt; AnyBackend i -&gt; r -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#composeAnyBackend"><span class="hs-identifier hs-var">AB.composeAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
BackendEventTrigger b =&gt;
i b -&gt; i b -&gt; m ()
</span><a href="#local-6989586621689751391"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">AnyBackend i
</span><a href="#local-6989586621689751393"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">AnyBackend i
</span><a href="#local-6989586621689751392"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnstructuredLog -&gt; m ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621689751451"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(UnstructuredLog -&gt; m ()) -&gt; UnstructuredLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; SerializableBlob -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">HL.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">HL.LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(SerializableBlob -&gt; UnstructuredLog)
-&gt; SerializableBlob -&gt; UnstructuredLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; SerializableBlob
</span><a href="Data.SerializableBlob.html#fromText"><span class="hs-identifier hs-var">SB.fromText</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SerializableBlob) -&gt; Text -&gt; SerializableBlob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Event trigger clean up couldn't be done on the source &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751394"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; because it has changed its type&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span>    </span><span class="annot"><a href="#local-6989586621689751479"><span class="hs-identifier hs-type">generateSQLTriggerCleanupSchedules</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-404"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">InsOrdHashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-type">BackendSourceMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-405"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">InsOrdHashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-type">BackendSourceMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-406"></span><span>      </span><span class="annot"><a href="#local-6989586621689752037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>    </span><span id="local-6989586621689751479"><span class="annot"><span class="annottext">generateSQLTriggerCleanupSchedules :: InsOrdHashMap SourceName BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata -&gt; m ()
</span><a href="#local-6989586621689751479"><span class="hs-identifier hs-var hs-var">generateSQLTriggerCleanupSchedules</span></a></span></span><span> </span><span id="local-6989586621689751386"><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751386"><span class="hs-identifier hs-var">oldSources</span></a></span></span><span> </span><span id="local-6989586621689751385"><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751385"><span class="hs-identifier hs-var">newSources</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-408"></span><span>      </span><span class="hs-comment">-- If there are any event trigger cleanup configs with different cron then delete the older schedules</span><span>
</span><span id="line-409"></span><span>      </span><span class="hs-comment">-- generate cleanup logs for new event trigger cleanup config</span><span>
</span><span id="line-410"></span><span>      </span><span class="annot"><span class="annottext">[(SourceName, BackendSourceMetadata)]
-&gt; ((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
-&gt; [(SourceName, BackendSourceMetadata)]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751385"><span class="hs-identifier hs-var">newSources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ())
-&gt; ((SourceName, BackendSourceMetadata) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751384"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751384"><span class="hs-identifier hs-var">source</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689751383"><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751383"><span class="hs-identifier hs-var">newBackendSourceMetadata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-411"></span><span>        </span><span class="annot"><span class="annottext">Maybe BackendSourceMetadata
-&gt; (BackendSourceMetadata -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; Maybe BackendSourceMetadata
forall k v. (Eq k, Hashable k) =&gt; k -&gt; InsOrdHashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751384"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621689751386"><span class="hs-identifier hs-var">oldSources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((BackendSourceMetadata -&gt; m ()) -&gt; m ())
-&gt; (BackendSourceMetadata -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689751382"><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751382"><span class="hs-identifier hs-var">oldBackendSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-412"></span><span>          </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceMetadata b -&gt; m ())
-&gt; m ()
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BackendSourceMetadata -&gt; AnyBackend SourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#unBackendSourceMetadata"><span class="hs-identifier hs-var hs-var">unBackendSourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751383"><span class="hs-identifier hs-var">newBackendSourceMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751381"><span id="local-6989586621689751380"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751380"><span class="hs-identifier hs-var">newSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751381"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-413"></span><span>            </span><span class="annot"><span class="annottext">BackendSourceMetadata
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceMetadata b -&gt; m ())
-&gt; m ()
forall r.
BackendSourceMetadata
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceMetadata b -&gt; r)
-&gt; r
</span><a href="#local-6989586621689751519"><span class="hs-identifier hs-var">dispatch</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621689751382"><span class="hs-identifier hs-var">oldBackendSourceMetadata</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689751379"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751379"><span class="hs-identifier hs-var">oldSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-414"></span><span>              </span><span id="local-6989586621689751378"><span class="annot"><span class="annottext">sourceInfo :: SourceInfo b
</span><a href="#local-6989586621689751378"><span class="hs-identifier hs-var">sourceInfo</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TableCache b
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FunctionCache b
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621689751376"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621689751376"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe QueryTagsConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ResolvedSourceCustomization
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; m (SourceInfo b)
forall (b :: BackendType) (m :: * -&gt; *).
(CacheRM m, MetadataM m, MonadError QErr m, Backend b) =&gt;
SourceName -&gt; m (SourceInfo b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSourceInfo"><span class="hs-identifier hs-var">askSourceInfo</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751381"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751384"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-415"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751375"><span class="annot"><span class="annottext">getEventMapWithCC :: SourceMetadata b -&gt; HashMap TriggerName AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751375"><span class="hs-identifier hs-var hs-var">getEventMapWithCC</span></a></span></span><span> </span><span id="local-6989586621689751374"><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751374"><span class="hs-identifier hs-var">sourceMeta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
-&gt; HashMap TriggerName AutoTriggerLogCleanupConfig
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(TriggerName, AutoTriggerLogCleanupConfig)]
 -&gt; HashMap TriggerName AutoTriggerLogCleanupConfig)
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)]
-&gt; HashMap TriggerName AutoTriggerLogCleanupConfig
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((TableName b, TableMetadata b)
 -&gt; [(TriggerName, AutoTriggerLogCleanupConfig)])
-&gt; [(TableName b, TableMetadata b)]
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableMetadata b -&gt; [(TriggerName, AutoTriggerLogCleanupConfig)]
forall (b :: BackendType).
TableMetadata b -&gt; [(TriggerName, AutoTriggerLogCleanupConfig)]
</span><a href="Hasura.RQL.DDL.EventTrigger.html#getAllETWithCleanupConfigInTableMetadata"><span class="hs-identifier hs-var">getAllETWithCleanupConfigInTableMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(TableMetadata b -&gt; [(TriggerName, AutoTriggerLogCleanupConfig)])
-&gt; ((TableName b, TableMetadata b) -&gt; TableMetadata b)
-&gt; (TableName b, TableMetadata b)
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TableName b, TableMetadata b) -&gt; TableMetadata b
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(TableName b, TableMetadata b)]
 -&gt; [(TriggerName, AutoTriggerLogCleanupConfig)])
-&gt; [(TableName b, TableMetadata b)]
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap (TableName b) (TableMetadata b)
-&gt; [(TableName b, TableMetadata b)]
forall k v. InsOrdHashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.toList</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap (TableName b) (TableMetadata b)
 -&gt; [(TableName b, TableMetadata b)])
-&gt; InsOrdHashMap (TableName b) (TableMetadata b)
-&gt; [(TableName b, TableMetadata b)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; InsOrdHashMap (TableName b) (TableMetadata b)
forall (b :: BackendType). SourceMetadata b -&gt; Tables b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#_smTables"><span class="hs-identifier hs-var hs-var">_smTables</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751374"><span class="hs-identifier hs-var">sourceMeta</span></a></span><span>
</span><span id="line-416"></span><span>                  </span><span id="local-6989586621689751371"><span class="annot"><span class="annottext">oldEventTriggersWithCC :: HashMap TriggerName AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751371"><span class="hs-identifier hs-var hs-var">oldEventTriggersWithCC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; HashMap TriggerName AutoTriggerLogCleanupConfig
forall (b :: BackendType).
SourceMetadata b -&gt; HashMap TriggerName AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751375"><span class="hs-identifier hs-var">getEventMapWithCC</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751379"><span class="hs-identifier hs-var">oldSourceMetadata</span></a></span><span>
</span><span id="line-417"></span><span>                  </span><span id="local-6989586621689751370"><span class="annot"><span class="annottext">newEventTriggersWithCC :: HashMap TriggerName AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751370"><span class="hs-identifier hs-var hs-var">newEventTriggersWithCC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceMetadata b -&gt; HashMap TriggerName AutoTriggerLogCleanupConfig
forall (b :: BackendType).
SourceMetadata b -&gt; HashMap TriggerName AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751375"><span class="hs-identifier hs-var">getEventMapWithCC</span></a></span><span> </span><span class="annot"><span class="annottext">SourceMetadata b
</span><a href="#local-6989586621689751380"><span class="hs-identifier hs-var">newSourceMetadata</span></a></span><span>
</span><span id="line-418"></span><span>                  </span><span class="hs-comment">-- event triggers with cleanup config that existed in old metadata but are missing in new metadata</span><span>
</span><span id="line-419"></span><span>                  </span><span id="local-6989586621689751369"><span class="annot"><span class="annottext">differenceMap :: HashMap TriggerName AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751369"><span class="hs-identifier hs-var hs-var">differenceMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName AutoTriggerLogCleanupConfig
-&gt; HashMap TriggerName AutoTriggerLogCleanupConfig
-&gt; HashMap TriggerName AutoTriggerLogCleanupConfig
forall k v w.
(Eq k, Hashable k) =&gt;
HashMap k v -&gt; HashMap k w -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.difference</span></span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751371"><span class="hs-identifier hs-var">oldEventTriggersWithCC</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751370"><span class="hs-identifier hs-var">newEventTriggersWithCC</span></a></span><span>
</span><span id="line-420"></span><span>              </span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
-&gt; ((TriggerName, AutoTriggerLogCleanupConfig)
    -&gt; m AutoTriggerLogCleanupConfig)
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap TriggerName AutoTriggerLogCleanupConfig
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)]
forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751369"><span class="hs-identifier hs-var">differenceMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TriggerName, AutoTriggerLogCleanupConfig)
  -&gt; m AutoTriggerLogCleanupConfig)
 -&gt; m ())
-&gt; ((TriggerName, AutoTriggerLogCleanupConfig)
    -&gt; m AutoTriggerLogCleanupConfig)
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751366"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751366"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689751365"><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751365"><span class="hs-identifier hs-var">cleanupConfig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-421"></span><span>                </span><span class="annot"><span class="annottext">SourceConfig b -&gt; TriggerName -&gt; m ()
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b -&gt; TriggerName -&gt; m ()
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#deleteAllScheduledCleanups"><span class="hs-identifier hs-var">deleteAllScheduledCleanups</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751381"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621689751376"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751366"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-422"></span><span>                </span><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig -&gt; m AutoTriggerLogCleanupConfig
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751365"><span class="hs-identifier hs-var">cleanupConfig</span></a></span><span>
</span><span id="line-423"></span><span>              </span><span class="annot"><span class="annottext">[(TriggerName, AutoTriggerLogCleanupConfig)]
-&gt; ((TriggerName, AutoTriggerLogCleanupConfig) -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap TriggerName AutoTriggerLogCleanupConfig
-&gt; [(TriggerName, AutoTriggerLogCleanupConfig)]
forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">HashMap TriggerName AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751370"><span class="hs-identifier hs-var">newEventTriggersWithCC</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TriggerName, AutoTriggerLogCleanupConfig) -&gt; m ()) -&gt; m ())
-&gt; ((TriggerName, AutoTriggerLogCleanupConfig) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689751363"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751363"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689751362"><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751362"><span class="hs-identifier hs-var">cleanupConfig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-424"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-operator hs-var">`onLeft`</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; m ()
forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceInfo
-&gt; TriggerName -&gt; AutoTriggerLogCleanupConfig -&gt; m (Either QErr ())
forall (m :: * -&gt; *).
MonadEventLogCleanup m =&gt;
AnyBackend SourceInfo
-&gt; TriggerName -&gt; AutoTriggerLogCleanupConfig -&gt; m (Either QErr ())
</span><a href="Hasura.RQL.DDL.EventTrigger.html#generateCleanupSchedules"><span class="hs-identifier hs-var">generateCleanupSchedules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceInfo b -&gt; AnyBackend SourceInfo
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="annot"><span class="annottext">SourceInfo b
</span><a href="#local-6989586621689751378"><span class="hs-identifier hs-var">sourceInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751363"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig
</span><a href="#local-6989586621689751362"><span class="hs-identifier hs-var">cleanupConfig</span></a></span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span>    </span><span id="local-6989586621689751519"><span class="annot"><span class="annottext">dispatch :: BackendSourceMetadata
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceMetadata b -&gt; r)
-&gt; r
</span><a href="#local-6989586621689751519"><span class="hs-identifier hs-var hs-var">dispatch</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-type">BackendSourceMetadata</span></a></span><span> </span><span id="local-6989586621689751358"><span class="annot"><span class="annottext">AnyBackend SourceMetadata
</span><a href="#local-6989586621689751358"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceMetadata b -&gt; r)
-&gt; r
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata
</span><a href="#local-6989586621689751358"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span class="hs-comment">-- | Only includes the cron triggers with `included_in_metadata` set to `True`</span><span>
</span><span id="line-429"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#processCronTriggersMetadata"><span class="hs-identifier hs-type">processCronTriggersMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#Metadata"><span class="hs-identifier hs-type">Metadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#Metadata"><span class="hs-identifier hs-type">Metadata</span></a></span><span>
</span><span id="line-430"></span><span id="processCronTriggersMetadata"><span class="annot"><span class="annottext">processCronTriggersMetadata :: Metadata -&gt; Metadata
</span><a href="Hasura.RQL.DDL.Metadata.html#processCronTriggersMetadata"><span class="hs-identifier hs-var hs-var">processCronTriggersMetadata</span></a></span></span><span> </span><span id="local-6989586621689751356"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751356"><span class="hs-identifier hs-var">metadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-431"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751355"><span class="annot"><span class="annottext">cronTriggersIncludedInMetadata :: CronTriggers
</span><a href="#local-6989586621689751355"><span class="hs-identifier hs-var hs-var">cronTriggersIncludedInMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CronTriggerMetadata -&gt; Bool) -&gt; CronTriggers -&gt; CronTriggers
forall v k. (v -&gt; Bool) -&gt; InsOrdHashMap k v -&gt; InsOrdHashMap k v
</span><span class="hs-identifier hs-var">OMap.filter</span></span><span> </span><span class="annot"><span class="annottext">CronTriggerMetadata -&gt; Bool
</span><a href="Hasura.RQL.Types.ScheduledTrigger.html#ctIncludeInMetadata"><span class="hs-identifier hs-var hs-var">ctIncludeInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(CronTriggers -&gt; CronTriggers) -&gt; CronTriggers -&gt; CronTriggers
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; CronTriggers
</span><a href="Hasura.RQL.Types.Metadata.html#_metaCronTriggers"><span class="hs-identifier hs-var hs-var">_metaCronTriggers</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751356"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-432"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751356"><span class="hs-identifier hs-var">metadata</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">_metaCronTriggers :: CronTriggers
</span><a href="Hasura.RQL.Types.Metadata.html#_metaCronTriggers"><span class="hs-identifier hs-var">_metaCronTriggers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621689751355"><span class="hs-identifier hs-var">cronTriggersIncludedInMetadata</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runExportMetadata"><span class="hs-identifier hs-type">runExportMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621689751353"><span class="annot"><a href="#local-6989586621689751353"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751353"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751353"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-437"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ExportMetadata"><span class="hs-identifier hs-type">ExportMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-438"></span><span>  </span><span class="annot"><a href="#local-6989586621689751353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span><span>
</span><span id="line-439"></span><span id="runExportMetadata"><span class="annot"><span class="annottext">runExportMetadata :: ExportMetadata -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runExportMetadata"><span class="hs-identifier hs-var hs-var">runExportMetadata</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ExportMetadata"><span class="hs-identifier hs-type">ExportMetadata</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-440"></span><span>  </span><span class="annot"><span class="annottext">Value -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromOrderedValue"><span class="hs-identifier hs-var">encJFromOrderedValue</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; EncJSON) -&gt; (Metadata -&gt; Value) -&gt; Metadata -&gt; EncJSON
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; Value
</span><a href="Hasura.RQL.Types.Metadata.html#metadataToOrdJSON"><span class="hs-identifier hs-var">metadataToOrdJSON</span></a></span><span> </span><span class="annot"><span class="annottext">(Metadata -&gt; EncJSON) -&gt; m Metadata -&gt; m EncJSON
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; Metadata
</span><a href="Hasura.RQL.DDL.Metadata.html#processCronTriggersMetadata"><span class="hs-identifier hs-var">processCronTriggersMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(Metadata -&gt; Metadata) -&gt; m Metadata -&gt; m Metadata
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m Metadata
forall (m :: * -&gt; *). MetadataM m =&gt; m Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#getMetadata"><span class="hs-identifier hs-var">getMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runExportMetadataV2"><span class="hs-identifier hs-type">runExportMetadataV2</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-443"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621689751349"><span class="annot"><a href="#local-6989586621689751349"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751349"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751349"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-445"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-446"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ExportMetadata"><span class="hs-identifier hs-type">ExportMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-447"></span><span>  </span><span class="annot"><a href="#local-6989586621689751349"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span><span>
</span><span id="line-448"></span><span id="runExportMetadataV2"><span class="annot"><span class="annottext">runExportMetadataV2 :: MetadataResourceVersion -&gt; ExportMetadata -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runExportMetadataV2"><span class="hs-identifier hs-var hs-var">runExportMetadataV2</span></a></span></span><span> </span><span id="local-6989586621689751348"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689751348"><span class="hs-identifier hs-var">currentResourceVersion</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ExportMetadata"><span class="hs-identifier hs-type">ExportMetadata</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-449"></span><span>  </span><span id="local-6989586621689751347"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751347"><span class="hs-identifier hs-var">exportMetadata</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; Metadata
</span><a href="Hasura.RQL.DDL.Metadata.html#processCronTriggersMetadata"><span class="hs-identifier hs-var">processCronTriggersMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(Metadata -&gt; Metadata) -&gt; m Metadata -&gt; m Metadata
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m Metadata
forall (m :: * -&gt; *). MetadataM m =&gt; m Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#getMetadata"><span class="hs-identifier hs-var">getMetadata</span></a></span><span>
</span><span id="line-450"></span><span>  </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(EncJSON -&gt; m EncJSON) -&gt; EncJSON -&gt; m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-451"></span><span>    </span><span class="annot"><span class="annottext">Value -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromOrderedValue"><span class="hs-identifier hs-var">encJFromOrderedValue</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; EncJSON) -&gt; Value -&gt; EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-452"></span><span>      </span><span class="annot"><span class="annottext">[(Text, Value)] -&gt; Value
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/aeson-ordered-0.1.0.0/opt/doc/html/aeson-ordered/src"><span class="hs-identifier hs-var">AO.object</span></a></span><span>
</span><span id="line-453"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;resource_version&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/aeson-ordered-0.1.0.0/opt/doc/html/aeson-ordered/src"><span class="hs-identifier hs-var">AO.toOrdered</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689751348"><span class="hs-identifier hs-var">currentResourceVersion</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-454"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;metadata&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; Value
</span><a href="Hasura.RQL.Types.Metadata.html#metadataToOrdJSON"><span class="hs-identifier hs-var">metadataToOrdJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751347"><span class="hs-identifier hs-var">exportMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span id="local-6989586621689751344"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runReloadMetadata"><span class="hs-identifier hs-type">runReloadMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751344"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751344"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751344"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ReloadMetadata"><span class="hs-identifier hs-type">ReloadMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689751344"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-458"></span><span id="runReloadMetadata"><span class="annot"><span class="annottext">runReloadMetadata :: ReloadMetadata -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runReloadMetadata"><span class="hs-identifier hs-var hs-var">runReloadMetadata</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#ReloadMetadata"><span class="hs-identifier hs-type">ReloadMetadata</span></a></span><span> </span><span id="local-6989586621689751342"><span class="annot"><span class="annottext">ReloadRemoteSchemas
</span><a href="#local-6989586621689751342"><span class="hs-identifier hs-var">reloadRemoteSchemas</span></a></span></span><span> </span><span id="local-6989586621689751341"><span class="annot"><span class="annottext">ReloadSources
</span><a href="#local-6989586621689751341"><span class="hs-identifier hs-var">reloadSources</span></a></span></span><span> </span><span id="local-6989586621689751340"><span class="annot"><span class="annottext">ReloadSources
</span><a href="#local-6989586621689751340"><span class="hs-identifier hs-var">reloadRecreateEventTriggers</span></a></span></span><span> </span><span id="local-6989586621689751339"><span class="annot"><span class="annottext">ReloadDataConnectors
</span><a href="#local-6989586621689751339"><span class="hs-identifier hs-var">reloadDataConnectors</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-459"></span><span>  </span><span id="local-6989586621689751338"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751338"><span class="hs-identifier hs-var">metadata</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Metadata
forall (m :: * -&gt; *). MetadataM m =&gt; m Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#getMetadata"><span class="hs-identifier hs-var">getMetadata</span></a></span><span>
</span><span id="line-460"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751337"><span class="annot"><span class="annottext">allSources :: HashSet SourceName
</span><a href="#local-6989586621689751337"><span class="hs-identifier hs-var hs-var">allSources</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SourceName] -&gt; HashSet SourceName
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.fromList</span></span><span> </span><span class="annot"><span class="annottext">([SourceName] -&gt; HashSet SourceName)
-&gt; [SourceName] -&gt; HashSet SourceName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata -&gt; [SourceName]
forall k v. InsOrdHashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">OMap.keys</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap SourceName BackendSourceMetadata -&gt; [SourceName])
-&gt; InsOrdHashMap SourceName BackendSourceMetadata -&gt; [SourceName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.html#_metaSources"><span class="hs-identifier hs-var hs-var">_metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751338"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-461"></span><span>      </span><span id="local-6989586621689751336"><span class="annot"><span class="annottext">allRemoteSchemas :: HashSet RemoteSchemaName
</span><a href="#local-6989586621689751336"><span class="hs-identifier hs-var hs-var">allRemoteSchemas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RemoteSchemaName] -&gt; HashSet RemoteSchemaName
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.fromList</span></span><span> </span><span class="annot"><span class="annottext">([RemoteSchemaName] -&gt; HashSet RemoteSchemaName)
-&gt; [RemoteSchemaName] -&gt; HashSet RemoteSchemaName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemas -&gt; [RemoteSchemaName]
forall k v. InsOrdHashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">OMap.keys</span></span><span> </span><span class="annot"><span class="annottext">(RemoteSchemas -&gt; [RemoteSchemaName])
-&gt; RemoteSchemas -&gt; [RemoteSchemaName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; RemoteSchemas
</span><a href="Hasura.RQL.Types.Metadata.html#_metaRemoteSchemas"><span class="hs-identifier hs-var hs-var">_metaRemoteSchemas</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751338"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-462"></span><span>      </span><span id="local-6989586621689751334"><span class="annot"><span class="annottext">allDataConnectors :: HashSet DataConnectorName
</span><a href="#local-6989586621689751334"><span class="hs-identifier hs-var hs-var">allDataConnectors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-463"></span><span>        </span><span class="annot"><span class="annottext">HashSet DataConnectorName
-&gt; (BackendConfigWrapper 'DataConnector
    -&gt; HashSet DataConnectorName)
-&gt; Maybe (BackendConfigWrapper 'DataConnector)
-&gt; HashSet DataConnectorName
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">HashSet DataConnectorName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DataConnectorName] -&gt; HashSet DataConnectorName
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.fromList</span></span><span> </span><span class="annot"><span class="annottext">([DataConnectorName] -&gt; HashSet DataConnectorName)
-&gt; (BackendConfigWrapper 'DataConnector -&gt; [DataConnectorName])
-&gt; BackendConfigWrapper 'DataConnector
-&gt; HashSet DataConnectorName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap DataConnectorName DataConnectorOptions
-&gt; [DataConnectorName]
forall k v. InsOrdHashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">OMap.keys</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap DataConnectorName DataConnectorOptions
 -&gt; [DataConnectorName])
-&gt; (BackendConfigWrapper 'DataConnector
    -&gt; InsOrdHashMap DataConnectorName DataConnectorOptions)
-&gt; BackendConfigWrapper 'DataConnector
-&gt; [DataConnectorName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BackendConfigWrapper 'DataConnector
-&gt; InsOrdHashMap DataConnectorName DataConnectorOptions
forall (b :: BackendType).
BackendConfigWrapper b -&gt; BackendConfig b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#unBackendConfigWrapper"><span class="hs-identifier hs-var hs-var">unBackendConfigWrapper</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (BackendConfigWrapper 'DataConnector)
 -&gt; HashSet DataConnectorName)
-&gt; Maybe (BackendConfigWrapper 'DataConnector)
-&gt; HashSet DataConnectorName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-464"></span><span>          </span><span class="annot"><span class="annottext">forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
BackendMap i -&gt; Maybe (i b)
forall (i :: BackendType -&gt; *).
HasTag 'DataConnector =&gt;
BackendMap i -&gt; Maybe (i 'DataConnector)
</span><a href="Hasura.SQL.BackendMap.html#lookup"><span class="hs-identifier hs-var">BackendMap.lookup</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#DataConnector"><span class="hs-identifier hs-type">DataConnector</span></a></span><span> </span><span class="annot"><span class="annottext">(BackendMap BackendConfigWrapper
 -&gt; Maybe (BackendConfigWrapper 'DataConnector))
-&gt; BackendMap BackendConfigWrapper
-&gt; Maybe (BackendConfigWrapper 'DataConnector)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; BackendMap BackendConfigWrapper
</span><a href="Hasura.RQL.Types.Metadata.html#_metaBackendConfigs"><span class="hs-identifier hs-var hs-var">_metaBackendConfigs</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751338"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-465"></span><span>      </span><span id="local-6989586621689751329"><span class="annot"><span class="annottext">checkRemoteSchema :: RemoteSchemaName -&gt; m ()
</span><a href="#local-6989586621689751329"><span class="hs-identifier hs-var hs-var">checkRemoteSchema</span></a></span></span><span> </span><span id="local-6989586621689751328"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621689751328"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-466"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; HashSet RemoteSchemaName -&gt; Bool
forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-identifier hs-var">HS.member</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621689751328"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet RemoteSchemaName
</span><a href="#local-6989586621689751336"><span class="hs-identifier hs-var">allRemoteSchemas</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-467"></span><span>          </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotExists"><span class="hs-identifier hs-var">NotExists</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-468"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Remote schema with name &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621689751328"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; not found in metadata&quot;</span></span><span>
</span><span id="line-469"></span><span>      </span><span id="local-6989586621689751325"><span class="annot"><span class="annottext">checkSource :: SourceName -&gt; m ()
</span><a href="#local-6989586621689751325"><span class="hs-identifier hs-var hs-var">checkSource</span></a></span></span><span> </span><span id="local-6989586621689751324"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751324"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-470"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName -&gt; HashSet SourceName -&gt; Bool
forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-identifier hs-var">HS.member</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751324"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751337"><span class="hs-identifier hs-var">allSources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-471"></span><span>          </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotExists"><span class="hs-identifier hs-var">NotExists</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-472"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Source with name &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751324"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; not found in metadata&quot;</span></span><span>
</span><span id="line-473"></span><span>      </span><span id="local-6989586621689751323"><span class="annot"><span class="annottext">checkDataConnector :: DataConnectorName -&gt; m ()
</span><a href="#local-6989586621689751323"><span class="hs-identifier hs-var hs-var">checkDataConnector</span></a></span></span><span> </span><span id="local-6989586621689751322"><span class="annot"><span class="annottext">DataConnectorName
</span><a href="#local-6989586621689751322"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataConnectorName -&gt; HashSet DataConnectorName -&gt; Bool
forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-identifier hs-var">HS.member</span></span><span> </span><span class="annot"><span class="annottext">DataConnectorName
</span><a href="#local-6989586621689751322"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet DataConnectorName
</span><a href="#local-6989586621689751334"><span class="hs-identifier hs-var">allDataConnectors</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-475"></span><span>          </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotExists"><span class="hs-identifier hs-var">NotExists</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-476"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Data connector with name &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">DataConnectorName
</span><a href="#local-6989586621689751322"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">DataConnectorName -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; not found in metadata&quot;</span></span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span>  </span><span id="local-6989586621689751321"><span class="annot"><span class="annottext">HashSet RemoteSchemaName
</span><a href="#local-6989586621689751321"><span class="hs-identifier hs-var">remoteSchemaInvalidations</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ReloadRemoteSchemas
</span><a href="#local-6989586621689751342"><span class="hs-identifier hs-var">reloadRemoteSchemas</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-479"></span><span>    </span><span class="annot"><span class="annottext">ReloadRemoteSchemas
</span><a href="Hasura.RQL.DDL.Metadata.Types.html#RSReloadAll"><span class="hs-identifier hs-var">RSReloadAll</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashSet RemoteSchemaName -&gt; m (HashSet RemoteSchemaName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">HashSet RemoteSchemaName
</span><a href="#local-6989586621689751336"><span class="hs-identifier hs-var">allRemoteSchemas</span></a></span><span>
</span><span id="line-480"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RSReloadList"><span class="hs-identifier hs-type">RSReloadList</span></a></span><span> </span><span id="local-6989586621689751318"><span class="annot"><span class="annottext">HashSet RemoteSchemaName
</span><a href="#local-6989586621689751318"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaName -&gt; m ()) -&gt; HashSet RemoteSchemaName -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; m ()
</span><a href="#local-6989586621689751329"><span class="hs-identifier hs-var">checkRemoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet RemoteSchemaName
</span><a href="#local-6989586621689751318"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">m ()
-&gt; m (HashSet RemoteSchemaName) -&gt; m (HashSet RemoteSchemaName)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashSet RemoteSchemaName -&gt; m (HashSet RemoteSchemaName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">HashSet RemoteSchemaName
</span><a href="#local-6989586621689751318"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-481"></span><span>  </span><span id="local-6989586621689751316"><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751316"><span class="hs-identifier hs-var">pgSourcesInvalidations</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ReloadSources
</span><a href="#local-6989586621689751341"><span class="hs-identifier hs-var">reloadSources</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-482"></span><span>    </span><span class="annot"><span class="annottext">ReloadSources
</span><a href="Hasura.RQL.DDL.Metadata.Types.html#RSReloadAll"><span class="hs-identifier hs-var">RSReloadAll</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashSet SourceName -&gt; m (HashSet SourceName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751337"><span class="hs-identifier hs-var">allSources</span></a></span><span>
</span><span id="line-483"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RSReloadList"><span class="hs-identifier hs-type">RSReloadList</span></a></span><span> </span><span id="local-6989586621689751315"><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751315"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SourceName -&gt; m ()) -&gt; HashSet SourceName -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; m ()
</span><a href="#local-6989586621689751325"><span class="hs-identifier hs-var">checkSource</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751315"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m (HashSet SourceName) -&gt; m (HashSet SourceName)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName -&gt; m (HashSet SourceName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751315"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-484"></span><span>  </span><span id="local-6989586621689751314"><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751314"><span class="hs-identifier hs-var">recreateEventTriggersSources</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ReloadSources
</span><a href="#local-6989586621689751340"><span class="hs-identifier hs-var">reloadRecreateEventTriggers</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-485"></span><span>    </span><span class="annot"><span class="annottext">ReloadSources
</span><a href="Hasura.RQL.DDL.Metadata.Types.html#RSReloadAll"><span class="hs-identifier hs-var">RSReloadAll</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashSet SourceName -&gt; m (HashSet SourceName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751337"><span class="hs-identifier hs-var">allSources</span></a></span><span>
</span><span id="line-486"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RSReloadList"><span class="hs-identifier hs-type">RSReloadList</span></a></span><span> </span><span id="local-6989586621689751313"><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751313"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SourceName -&gt; m ()) -&gt; HashSet SourceName -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; m ()
</span><a href="#local-6989586621689751325"><span class="hs-identifier hs-var">checkSource</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751313"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m (HashSet SourceName) -&gt; m (HashSet SourceName)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName -&gt; m (HashSet SourceName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751313"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-487"></span><span>  </span><span id="local-6989586621689751312"><span class="annot"><span class="annottext">HashSet DataConnectorName
</span><a href="#local-6989586621689751312"><span class="hs-identifier hs-var">dataConnectorInvalidations</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ReloadDataConnectors
</span><a href="#local-6989586621689751339"><span class="hs-identifier hs-var">reloadDataConnectors</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-488"></span><span>    </span><span class="annot"><span class="annottext">ReloadDataConnectors
</span><a href="Hasura.RQL.DDL.Metadata.Types.html#RSReloadAll"><span class="hs-identifier hs-var">RSReloadAll</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashSet DataConnectorName -&gt; m (HashSet DataConnectorName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">HashSet DataConnectorName
</span><a href="#local-6989586621689751334"><span class="hs-identifier hs-var">allDataConnectors</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#RSReloadList"><span class="hs-identifier hs-type">RSReloadList</span></a></span><span> </span><span id="local-6989586621689751311"><span class="annot"><span class="annottext">HashSet DataConnectorName
</span><a href="#local-6989586621689751311"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(DataConnectorName -&gt; m ()) -&gt; HashSet DataConnectorName -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">DataConnectorName -&gt; m ()
</span><a href="#local-6989586621689751323"><span class="hs-identifier hs-var">checkDataConnector</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet DataConnectorName
</span><a href="#local-6989586621689751311"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">m ()
-&gt; m (HashSet DataConnectorName) -&gt; m (HashSet DataConnectorName)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashSet DataConnectorName -&gt; m (HashSet DataConnectorName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">HashSet DataConnectorName
</span><a href="#local-6989586621689751311"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751310"><span class="annot"><span class="annottext">cacheInvalidations :: CacheInvalidations
</span><a href="#local-6989586621689751310"><span class="hs-identifier hs-var hs-var">cacheInvalidations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-492"></span><span>        </span><span class="annot"><span class="annottext">CacheInvalidations :: Bool
-&gt; HashSet RemoteSchemaName
-&gt; HashSet SourceName
-&gt; HashSet DataConnectorName
-&gt; CacheInvalidations
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheInvalidations"><span class="hs-identifier hs-type">CacheInvalidations</span></a></span><span>
</span><span id="line-493"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ciMetadata :: Bool
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciMetadata"><span class="hs-identifier hs-var">ciMetadata</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span>
</span><span id="line-494"></span><span>            </span><span class="annot"><span class="annottext">ciRemoteSchemas :: HashSet RemoteSchemaName
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciRemoteSchemas"><span class="hs-identifier hs-var">ciRemoteSchemas</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashSet RemoteSchemaName
</span><a href="#local-6989586621689751321"><span class="hs-identifier hs-var">remoteSchemaInvalidations</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-495"></span><span>            </span><span class="annot"><span class="annottext">ciSources :: HashSet SourceName
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciSources"><span class="hs-identifier hs-var">ciSources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751316"><span class="hs-identifier hs-var">pgSourcesInvalidations</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-496"></span><span>            </span><span class="annot"><span class="annottext">ciDataConnectors :: HashSet DataConnectorName
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciDataConnectors"><span class="hs-identifier hs-var">ciDataConnectors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashSet DataConnectorName
</span><a href="#local-6989586621689751312"><span class="hs-identifier hs-var">dataConnectorInvalidations</span></a></span><span>
</span><span id="line-497"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span>  </span><span class="annot"><span class="annottext">BuildReason -&gt; CacheInvalidations -&gt; Metadata -&gt; m ()
forall (m :: * -&gt; *).
CacheRWM m =&gt;
BuildReason -&gt; CacheInvalidations -&gt; Metadata -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCacheWithOptions"><span class="hs-identifier hs-var">buildSchemaCacheWithOptions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (HashSet SourceName) -&gt; BuildReason
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CatalogUpdate"><span class="hs-identifier hs-var">CatalogUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (HashSet SourceName) -&gt; BuildReason)
-&gt; Maybe (HashSet SourceName) -&gt; BuildReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName -&gt; Maybe (HashSet SourceName)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">HashSet SourceName
</span><a href="#local-6989586621689751314"><span class="hs-identifier hs-var">recreateEventTriggersSources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621689751310"><span class="hs-identifier hs-var">cacheInvalidations</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751338"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-500"></span><span>  </span><span id="local-6989586621689751302"><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751302"><span class="hs-identifier hs-var">inconsObjs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; [InconsistentMetadata]
</span><a href="Hasura.RQL.Types.SchemaCache.html#scInconsistentObjs"><span class="hs-identifier hs-var hs-var">scInconsistentObjs</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; [InconsistentMetadata])
-&gt; m SchemaCache -&gt; m [InconsistentMetadata]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m SchemaCache
forall (m :: * -&gt; *). CacheRM m =&gt; m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var">askSchemaCache</span></a></span><span>
</span><span id="line-501"></span><span>  </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(EncJSON -&gt; m EncJSON)
-&gt; ([Pair] -&gt; EncJSON) -&gt; [Pair] -&gt; m EncJSON
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; EncJSON
forall a. ToJSON a =&gt; a -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromJValue"><span class="hs-identifier hs-var">encJFromJValue</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; EncJSON) -&gt; ([Pair] -&gt; Value) -&gt; [Pair] -&gt; EncJSON
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span> </span><span class="annot"><span class="annottext">([Pair] -&gt; m EncJSON) -&gt; [Pair] -&gt; m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;message&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;success&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-503"></span><span>      </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;is_consistent&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Bool -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751302"><span class="hs-identifier hs-var">inconsObjs</span></a></span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-505"></span><span>      </span><span class="annot"><span class="annottext">[Pair] -&gt; [Pair] -&gt; [Pair]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;inconsistent_objects&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; [InconsistentMetadata] -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751302"><span class="hs-identifier hs-var">inconsObjs</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InconsistentMetadata] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751302"><span class="hs-identifier hs-var">inconsObjs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-506"></span><span>
</span><span id="line-507"></span><span id="local-6989586621689751298"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runDumpInternalState"><span class="hs-identifier hs-type">runDumpInternalState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751298"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#CacheRM"><span class="hs-identifier hs-type">CacheRM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751298"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-509"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#DumpInternalState"><span class="hs-identifier hs-type">DumpInternalState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-510"></span><span>  </span><span class="annot"><a href="#local-6989586621689751298"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-511"></span><span id="runDumpInternalState"><span class="annot"><span class="annottext">runDumpInternalState :: DumpInternalState -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runDumpInternalState"><span class="hs-identifier hs-var hs-var">runDumpInternalState</span></a></span></span><span> </span><span class="annot"><span class="annottext">DumpInternalState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-512"></span><span>  </span><span class="annot"><span class="annottext">SchemaCache -&gt; EncJSON
forall a. ToJSON a =&gt; a -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromJValue"><span class="hs-identifier hs-var">encJFromJValue</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; EncJSON) -&gt; m SchemaCache -&gt; m EncJSON
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m SchemaCache
forall (m :: * -&gt; *). CacheRM m =&gt; m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var">askSchemaCache</span></a></span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span id="local-6989586621689751297"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runGetInconsistentMetadata"><span class="hs-identifier hs-type">runGetInconsistentMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751297"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#CacheRM"><span class="hs-identifier hs-type">CacheRM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751297"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-516"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#GetInconsistentMetadata"><span class="hs-identifier hs-type">GetInconsistentMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-517"></span><span>  </span><span class="annot"><a href="#local-6989586621689751297"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-518"></span><span id="runGetInconsistentMetadata"><span class="annot"><span class="annottext">runGetInconsistentMetadata :: GetInconsistentMetadata -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runGetInconsistentMetadata"><span class="hs-identifier hs-var hs-var">runGetInconsistentMetadata</span></a></span></span><span> </span><span class="annot"><span class="annottext">GetInconsistentMetadata
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-519"></span><span>  </span><span id="local-6989586621689751296"><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751296"><span class="hs-identifier hs-var">inconsObjs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; [InconsistentMetadata]
</span><a href="Hasura.RQL.Types.SchemaCache.html#scInconsistentObjs"><span class="hs-identifier hs-var hs-var">scInconsistentObjs</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; [InconsistentMetadata])
-&gt; m SchemaCache -&gt; m [InconsistentMetadata]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m SchemaCache
forall (m :: * -&gt; *). CacheRM m =&gt; m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var">askSchemaCache</span></a></span><span>
</span><span id="line-520"></span><span>  </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(EncJSON -&gt; m EncJSON) -&gt; EncJSON -&gt; m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; EncJSON
forall a. ToJSON a =&gt; a -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromJValue"><span class="hs-identifier hs-var">encJFromJValue</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; EncJSON) -&gt; Value -&gt; EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata] -&gt; Value
</span><a href="Hasura.RQL.DDL.Metadata.html#formatInconsistentObjs"><span class="hs-identifier hs-var">formatInconsistentObjs</span></a></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751296"><span class="hs-identifier hs-var">inconsObjs</span></a></span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#formatInconsistentObjs"><span class="hs-identifier hs-type">formatInconsistentObjs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#InconsistentMetadata"><span class="hs-identifier hs-type">InconsistentMetadata</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-523"></span><span id="formatInconsistentObjs"><span class="annot"><span class="annottext">formatInconsistentObjs :: [InconsistentMetadata] -&gt; Value
</span><a href="Hasura.RQL.DDL.Metadata.html#formatInconsistentObjs"><span class="hs-identifier hs-var hs-var">formatInconsistentObjs</span></a></span></span><span> </span><span id="local-6989586621689751295"><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751295"><span class="hs-identifier hs-var">inconsObjs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-524"></span><span>  </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-525"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;is_consistent&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Bool -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751295"><span class="hs-identifier hs-var">inconsObjs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-526"></span><span>      </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;inconsistent_objects&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; [InconsistentMetadata] -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751295"><span class="hs-identifier hs-var">inconsObjs</span></a></span><span>
</span><span id="line-527"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span id="local-6989586621689751294"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runDropInconsistentMetadata"><span class="hs-identifier hs-type">runDropInconsistentMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751294"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751294"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751294"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-531"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#DropInconsistentMetadata"><span class="hs-identifier hs-type">DropInconsistentMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-532"></span><span>  </span><span class="annot"><a href="#local-6989586621689751294"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-533"></span><span id="runDropInconsistentMetadata"><span class="annot"><span class="annottext">runDropInconsistentMetadata :: DropInconsistentMetadata -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runDropInconsistentMetadata"><span class="hs-identifier hs-var hs-var">runDropInconsistentMetadata</span></a></span></span><span> </span><span class="annot"><span class="annottext">DropInconsistentMetadata
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-534"></span><span>  </span><span id="local-6989586621689751293"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689751293"><span class="hs-identifier hs-var">sc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m SchemaCache
forall (m :: * -&gt; *). CacheRM m =&gt; m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var">askSchemaCache</span></a></span><span>
</span><span id="line-535"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751292"><span class="annot"><span class="annottext">inconsSchObjs :: [MetadataObjId]
</span><a href="#local-6989586621689751292"><span class="hs-identifier hs-var hs-var">inconsSchObjs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[MetadataObjId] -&gt; [MetadataObjId]
forall a. Eq a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.nub</span></span><span> </span><span class="annot"><span class="annottext">([MetadataObjId] -&gt; [MetadataObjId])
-&gt; ([InconsistentMetadata] -&gt; [MetadataObjId])
-&gt; [InconsistentMetadata]
-&gt; [MetadataObjId]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(InconsistentMetadata -&gt; [MetadataObjId])
-&gt; [InconsistentMetadata] -&gt; [MetadataObjId]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">InconsistentMetadata -&gt; [MetadataObjId]
</span><a href="Hasura.RQL.Types.Metadata.Object.html#imObjectIds"><span class="hs-identifier hs-var">imObjectIds</span></a></span><span> </span><span class="annot"><span class="annottext">([InconsistentMetadata] -&gt; [MetadataObjId])
-&gt; [InconsistentMetadata] -&gt; [MetadataObjId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; [InconsistentMetadata]
</span><a href="Hasura.RQL.Types.SchemaCache.html#scInconsistentObjs"><span class="hs-identifier hs-var hs-var">scInconsistentObjs</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689751293"><span class="hs-identifier hs-var">sc</span></a></span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-comment">-- Note: when building the schema cache, we try to put dependents after their dependencies in the</span><span>
</span><span id="line-537"></span><span>  </span><span class="hs-comment">-- list of inconsistent objects, so reverse the list to start with dependents first. This is not</span><span>
</span><span id="line-538"></span><span>  </span><span class="hs-comment">-- perfect &#8212; a completely accurate solution would require performing a topological sort &#8212; but it</span><span>
</span><span id="line-539"></span><span>  </span><span class="hs-comment">-- seems to work well enough for now.</span><span>
</span><span id="line-540"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-type">MetadataModifier</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689751288"><span class="annot"><span class="annottext">Metadata -&gt; Metadata
runMetadataModifier :: MetadataModifier -&gt; Metadata -&gt; Metadata
runMetadataModifier :: Metadata -&gt; Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#runMetadataModifier"><span class="hs-glyph hs-var hs-var">..</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WriterT MetadataModifier m () -&gt; m MetadataModifier
forall (m :: * -&gt; *) w a. Monad m =&gt; WriterT w m a -&gt; m w
</span><span class="hs-identifier hs-var">execWriterT</span></span><span> </span><span class="annot"><span class="annottext">(WriterT MetadataModifier m () -&gt; m MetadataModifier)
-&gt; WriterT MetadataModifier m () -&gt; m MetadataModifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(MetadataObjId -&gt; WriterT MetadataModifier m ())
-&gt; [MetadataObjId] -&gt; WriterT MetadataModifier m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataModifier -&gt; WriterT MetadataModifier m ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(MetadataModifier -&gt; WriterT MetadataModifier m ())
-&gt; (MetadataObjId -&gt; MetadataModifier)
-&gt; MetadataObjId
-&gt; WriterT MetadataModifier m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; MetadataModifier
</span><a href="Hasura.RQL.DDL.Metadata.html#purgeMetadataObj"><span class="hs-identifier hs-var">purgeMetadataObj</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MetadataObjId] -&gt; [MetadataObjId]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[MetadataObjId]
</span><a href="#local-6989586621689751292"><span class="hs-identifier hs-var">inconsSchObjs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>  </span><span id="local-6989586621689751282"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751282"><span class="hs-identifier hs-var">metadata</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Metadata
forall (m :: * -&gt; *). MetadataM m =&gt; m Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#getMetadata"><span class="hs-identifier hs-var">getMetadata</span></a></span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><span class="annottext">Metadata -&gt; m ()
forall (m :: * -&gt; *). MetadataM m =&gt; Metadata -&gt; m ()
</span><a href="Hasura.RQL.Types.Metadata.html#putMetadata"><span class="hs-identifier hs-var">putMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(Metadata -&gt; m ()) -&gt; Metadata -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; Metadata
</span><a href="#local-6989586621689751288"><span class="hs-identifier hs-var">runMetadataModifier</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751282"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-543"></span><span>  </span><span class="annot"><span class="annottext">MetadataModifier -&gt; m ()
forall (m :: * -&gt; *).
(MetadataM m, CacheRWM m) =&gt;
MetadataModifier -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCache"><span class="hs-identifier hs-var">buildSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataModifier
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-comment">-- after building the schema cache, we need to check the inconsistent metadata, if any</span><span>
</span><span id="line-545"></span><span>  </span><span class="hs-comment">-- are only those which are not droppable</span><span>
</span><span id="line-546"></span><span>  </span><span id="local-6989586621689751281"><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751281"><span class="hs-identifier hs-var">newInconsistentObjects</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; [InconsistentMetadata]
</span><a href="Hasura.RQL.Types.SchemaCache.html#scInconsistentObjs"><span class="hs-identifier hs-var hs-var">scInconsistentObjs</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; [InconsistentMetadata])
-&gt; m SchemaCache -&gt; m [InconsistentMetadata]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m SchemaCache
forall (m :: * -&gt; *). CacheRM m =&gt; m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var">askSchemaCache</span></a></span><span>
</span><span id="line-547"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751280"><span class="annot"><span class="annottext">droppableInconsistentObjects :: [InconsistentMetadata]
</span><a href="#local-6989586621689751280"><span class="hs-identifier hs-var hs-var">droppableInconsistentObjects</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(InconsistentMetadata -&gt; Bool)
-&gt; [InconsistentMetadata] -&gt; [InconsistentMetadata]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">InconsistentMetadata -&gt; Bool
</span><a href="Hasura.RQL.Types.Metadata.Object.html#droppableInconsistentMetadata"><span class="hs-identifier hs-var">droppableInconsistentMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751281"><span class="hs-identifier hs-var">newInconsistentObjects</span></a></span><span>
</span><span id="line-548"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InconsistentMetadata] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751280"><span class="hs-identifier hs-var">droppableInconsistentObjects</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-549"></span><span>    </span><span class="annot"><span class="annottext">QErr -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-550"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="Hasura.Base.Error.html#err400"><span class="hs-identifier hs-var">err400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#Unexpected"><span class="hs-identifier hs-var">Unexpected</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cannot continue due to new inconsistent metadata&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">qeInternal :: Maybe QErrExtra
</span><a href="Hasura.Base.Error.html#qeInternal"><span class="hs-identifier hs-var">qeInternal</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QErrExtra -&gt; Maybe QErrExtra
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(QErrExtra -&gt; Maybe QErrExtra) -&gt; QErrExtra -&gt; Maybe QErrExtra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; QErrExtra
</span><a href="Hasura.Base.Error.html#ExtraInternal"><span class="hs-identifier hs-var">ExtraInternal</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; QErrExtra) -&gt; Value -&gt; QErrExtra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata] -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621689751281"><span class="hs-identifier hs-var">newInconsistentObjects</span></a></span><span>
</span><span id="line-552"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-553"></span><span>  </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">EncJSON
</span><a href="Hasura.RQL.Types.Common.html#successMsg"><span class="hs-identifier hs-var">successMsg</span></a></span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#purgeMetadataObj"><span class="hs-identifier hs-type">purgeMetadataObj</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObjId"><span class="hs-identifier hs-type">MetadataObjId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-type">MetadataModifier</span></a></span><span>
</span><span id="line-556"></span><span id="purgeMetadataObj"><span class="annot"><span class="annottext">purgeMetadataObj :: MetadataObjId -&gt; MetadataModifier
</span><a href="Hasura.RQL.DDL.Metadata.html#purgeMetadataObj"><span class="hs-identifier hs-var hs-var">purgeMetadataObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-557"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MOSource"><span class="hs-identifier hs-type">MOSource</span></a></span><span> </span><span id="local-6989586621689751273"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751273"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Metadata -&gt; Metadata) -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-var">MetadataModifier</span></a></span><span> </span><span class="annot"><span class="annottext">((Metadata -&gt; Metadata) -&gt; MetadataModifier)
-&gt; (Metadata -&gt; Metadata) -&gt; MetadataModifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap SourceName BackendSourceMetadata
 -&gt; Identity (InsOrdHashMap SourceName BackendSourceMetadata))
-&gt; Metadata -&gt; Identity Metadata
Lens' Metadata (InsOrdHashMap SourceName BackendSourceMetadata)
</span><a href="Hasura.RQL.Types.Metadata.html#metaSources"><span class="hs-identifier hs-var">metaSources</span></a></span><span> </span><span class="annot"><span class="annottext">((InsOrdHashMap SourceName BackendSourceMetadata
  -&gt; Identity (InsOrdHashMap SourceName BackendSourceMetadata))
 -&gt; Metadata -&gt; Identity Metadata)
-&gt; (InsOrdHashMap SourceName BackendSourceMetadata
    -&gt; InsOrdHashMap SourceName BackendSourceMetadata)
-&gt; Metadata
-&gt; Metadata
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; InsOrdHashMap k v -&gt; InsOrdHashMap k v
</span><span class="hs-identifier hs-var">OMap.delete</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751273"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-558"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MOSourceObjId"><span class="hs-identifier hs-type">MOSourceObjId</span></a></span><span> </span><span id="local-6989586621689751270"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751270"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621689751269"><span class="annot"><span class="annottext">AnyBackend SourceMetadataObjId
</span><a href="#local-6989586621689751269"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceMetadataObjId
-&gt; (forall (b :: BackendType).
    BackendMetadata b =&gt;
    SourceMetadataObjId b -&gt; MetadataModifier)
-&gt; MetadataModifier
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceMetadataObjId
</span><a href="#local-6989586621689751269"><span class="hs-identifier hs-var">exists</span></a></span><span> </span><span class="annot"><span class="annottext">((forall (b :: BackendType).
  BackendMetadata b =&gt;
  SourceMetadataObjId b -&gt; MetadataModifier)
 -&gt; MetadataModifier)
-&gt; (forall (b :: BackendType).
    BackendMetadata b =&gt;
    SourceMetadataObjId b -&gt; MetadataModifier)
-&gt; MetadataModifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; SourceMetadataObjId b -&gt; MetadataModifier
forall (b :: BackendType).
BackendMetadata b =&gt;
SourceName -&gt; SourceMetadataObjId b -&gt; MetadataModifier
</span><a href="#local-6989586621689751268"><span class="hs-identifier hs-var">handleSourceObj</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751270"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-559"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MORemoteSchema"><span class="hs-identifier hs-type">MORemoteSchema</span></a></span><span> </span><span id="local-6989586621689751266"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621689751266"><span class="hs-identifier hs-var">rsn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#dropRemoteSchemaInMetadata"><span class="hs-identifier hs-var">dropRemoteSchemaInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621689751266"><span class="hs-identifier hs-var">rsn</span></a></span><span>
</span><span id="line-560"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MORemoteSchemaPermissions"><span class="hs-identifier hs-type">MORemoteSchemaPermissions</span></a></span><span> </span><span id="local-6989586621689751263"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621689751263"><span class="hs-identifier hs-var">rsName</span></a></span></span><span> </span><span id="local-6989586621689751262"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689751262"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; RoleName -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#dropRemoteSchemaPermissionInMetadata"><span class="hs-identifier hs-var">dropRemoteSchemaPermissionInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621689751263"><span class="hs-identifier hs-var">rsName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689751262"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-561"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MORemoteSchemaRemoteRelationship"><span class="hs-identifier hs-type">MORemoteSchemaRemoteRelationship</span></a></span><span> </span><span id="local-6989586621689751259"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621689751259"><span class="hs-identifier hs-var">rsName</span></a></span></span><span> </span><span id="local-6989586621689751258"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621689751258"><span class="hs-identifier hs-var">typeName</span></a></span></span><span> </span><span id="local-6989586621689751257"><span class="annot"><span class="annottext">RelName
</span><a href="#local-6989586621689751257"><span class="hs-identifier hs-var">relName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-562"></span><span>    </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; Name -&gt; RelName -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#dropRemoteSchemaRemoteRelationshipInMetadata"><span class="hs-identifier hs-var">dropRemoteSchemaRemoteRelationshipInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621689751259"><span class="hs-identifier hs-var">rsName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621689751258"><span class="hs-identifier hs-var">typeName</span></a></span><span> </span><span class="annot"><span class="annottext">RelName
</span><a href="#local-6989586621689751257"><span class="hs-identifier hs-var">relName</span></a></span><span>
</span><span id="line-563"></span><span>  </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MOCustomTypes"><span class="hs-identifier hs-var">MOCustomTypes</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetadataModifier
</span><a href="Hasura.RQL.DDL.CustomTypes.html#clearCustomTypesInMetadata"><span class="hs-identifier hs-var">clearCustomTypesInMetadata</span></a></span><span>
</span><span id="line-564"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MOAction"><span class="hs-identifier hs-type">MOAction</span></a></span><span> </span><span id="local-6989586621689751252"><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621689751252"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ActionName -&gt; MetadataModifier
</span><a href="Hasura.RQL.DDL.Action.html#dropActionInMetadata"><span class="hs-identifier hs-var">dropActionInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621689751252"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="hs-comment">-- Nothing</span><span>
</span><span id="line-565"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MOActionPermission"><span class="hs-identifier hs-type">MOActionPermission</span></a></span><span> </span><span id="local-6989586621689751249"><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621689751249"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span id="local-6989586621689751248"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689751248"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ActionName -&gt; RoleName -&gt; MetadataModifier
</span><a href="Hasura.RQL.DDL.Action.html#dropActionPermissionInMetadata"><span class="hs-identifier hs-var">dropActionPermissionInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621689751249"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689751248"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-566"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MOCronTrigger"><span class="hs-identifier hs-type">MOCronTrigger</span></a></span><span> </span><span id="local-6989586621689751245"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751245"><span class="hs-identifier hs-var">ctName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; MetadataModifier
</span><a href="Hasura.RQL.DDL.ScheduledTrigger.html#dropCronTriggerInMetadata"><span class="hs-identifier hs-var">dropCronTriggerInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751245"><span class="hs-identifier hs-var">ctName</span></a></span><span>
</span><span id="line-567"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MOEndpoint"><span class="hs-identifier hs-type">MOEndpoint</span></a></span><span> </span><span id="local-6989586621689751242"><span class="annot"><span class="annottext">EndpointName
</span><a href="#local-6989586621689751242"><span class="hs-identifier hs-var">epName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EndpointName -&gt; MetadataModifier
</span><a href="Hasura.RQL.DDL.Endpoint.html#dropEndpointInMetadata"><span class="hs-identifier hs-var">dropEndpointInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointName
</span><a href="#local-6989586621689751242"><span class="hs-identifier hs-var">epName</span></a></span><span>
</span><span id="line-568"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MOInheritedRole"><span class="hs-identifier hs-type">MOInheritedRole</span></a></span><span> </span><span id="local-6989586621689751239"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689751239"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; MetadataModifier
</span><a href="Hasura.RQL.DDL.InheritedRoles.html#dropInheritedRoleInMetadata"><span class="hs-identifier hs-var">dropInheritedRoleInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689751239"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-569"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MOHostTlsAllowlist"><span class="hs-identifier hs-type">MOHostTlsAllowlist</span></a></span><span> </span><span id="local-6989586621689751236"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689751236"><span class="hs-identifier hs-var">host</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; MetadataModifier
</span><a href="Hasura.RQL.DDL.Network.html#dropHostFromAllowList"><span class="hs-identifier hs-var">dropHostFromAllowList</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689751236"><span class="hs-identifier hs-var">host</span></a></span><span>
</span><span id="line-570"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MOQueryCollectionsQuery"><span class="hs-identifier hs-type">MOQueryCollectionsQuery</span></a></span><span> </span><span id="local-6989586621689751233"><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621689751233"><span class="hs-identifier hs-var">cName</span></a></span></span><span> </span><span id="local-6989586621689751232"><span class="annot"><span class="annottext">ListedQuery
</span><a href="#local-6989586621689751232"><span class="hs-identifier hs-var">lq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CollectionName -&gt; ListedQuery -&gt; MetadataModifier
</span><a href="#local-6989586621689751231"><span class="hs-identifier hs-var">dropListedQueryFromQueryCollections</span></a></span><span> </span><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621689751233"><span class="hs-identifier hs-var">cName</span></a></span><span> </span><span class="annot"><span class="annottext">ListedQuery
</span><a href="#local-6989586621689751232"><span class="hs-identifier hs-var">lq</span></a></span><span>
</span><span id="line-571"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MODataConnectorAgent"><span class="hs-identifier hs-type">MODataConnectorAgent</span></a></span><span> </span><span id="local-6989586621689751229"><span class="annot"><span class="annottext">DataConnectorName
</span><a href="#local-6989586621689751229"><span class="hs-identifier hs-var">agentName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-572"></span><span>    </span><span class="annot"><span class="annottext">(Metadata -&gt; Metadata) -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-var">MetadataModifier</span></a></span><span> </span><span class="annot"><span class="annottext">((Metadata -&gt; Metadata) -&gt; MetadataModifier)
-&gt; (Metadata -&gt; Metadata) -&gt; MetadataModifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-573"></span><span>      </span><span class="annot"><span class="annottext">(BackendMap BackendConfigWrapper
 -&gt; Identity (BackendMap BackendConfigWrapper))
-&gt; Metadata -&gt; Identity Metadata
Lens' Metadata (BackendMap BackendConfigWrapper)
</span><a href="Hasura.RQL.Types.Metadata.html#metaBackendConfigs"><span class="hs-identifier hs-var">metaBackendConfigs</span></a></span><span>
</span><span id="line-574"></span><span>        </span><span class="annot"><span class="annottext">((BackendMap BackendConfigWrapper
  -&gt; Identity (BackendMap BackendConfigWrapper))
 -&gt; Metadata -&gt; Identity Metadata)
-&gt; (BackendMap BackendConfigWrapper
    -&gt; BackendMap BackendConfigWrapper)
-&gt; Metadata
-&gt; Metadata
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">(BackendConfigWrapper 'DataConnector
 -&gt; BackendConfigWrapper 'DataConnector)
-&gt; BackendMap BackendConfigWrapper
-&gt; BackendMap BackendConfigWrapper
forall (b :: BackendType) (i :: BackendType -&gt; *).
(HasTag b, Monoid (i b)) =&gt;
(i b -&gt; i b) -&gt; BackendMap i -&gt; BackendMap i
</span><a href="Hasura.SQL.BackendMap.html#modify"><span class="hs-identifier hs-var">BackendMap.modify</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#DataConnector"><span class="hs-identifier hs-type">DataConnector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InsOrdHashMap DataConnectorName DataConnectorOptions
-&gt; BackendConfigWrapper 'DataConnector
forall (b :: BackendType).
BackendConfig b -&gt; BackendConfigWrapper b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#BackendConfigWrapper"><span class="hs-identifier hs-var">BackendConfigWrapper</span></a></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap DataConnectorName DataConnectorOptions
 -&gt; BackendConfigWrapper 'DataConnector)
-&gt; (BackendConfigWrapper 'DataConnector
    -&gt; InsOrdHashMap DataConnectorName DataConnectorOptions)
-&gt; BackendConfigWrapper 'DataConnector
-&gt; BackendConfigWrapper 'DataConnector
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DataConnectorName
-&gt; InsOrdHashMap DataConnectorName DataConnectorOptions
-&gt; InsOrdHashMap DataConnectorName DataConnectorOptions
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; InsOrdHashMap k v -&gt; InsOrdHashMap k v
</span><span class="hs-identifier hs-var">OMap.delete</span></span><span> </span><span class="annot"><span class="annottext">DataConnectorName
</span><a href="#local-6989586621689751229"><span class="hs-identifier hs-var">agentName</span></a></span><span> </span><span class="annot"><span class="annottext">(InsOrdHashMap DataConnectorName DataConnectorOptions
 -&gt; InsOrdHashMap DataConnectorName DataConnectorOptions)
-&gt; (BackendConfigWrapper 'DataConnector
    -&gt; InsOrdHashMap DataConnectorName DataConnectorOptions)
-&gt; BackendConfigWrapper 'DataConnector
-&gt; InsOrdHashMap DataConnectorName DataConnectorOptions
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BackendConfigWrapper 'DataConnector
-&gt; InsOrdHashMap DataConnectorName DataConnectorOptions
forall (b :: BackendType).
BackendConfigWrapper b -&gt; BackendConfig b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#unBackendConfigWrapper"><span class="hs-identifier hs-var hs-var">unBackendConfigWrapper</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-576"></span><span>    </span><span class="annot"><a href="#local-6989586621689751268"><span class="hs-identifier hs-type">handleSourceObj</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621689751786"><span class="annot"><a href="#local-6989586621689751786"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751786"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#SourceMetadataObjId"><span class="hs-identifier hs-type">SourceMetadataObjId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751786"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-type">MetadataModifier</span></a></span><span>
</span><span id="line-577"></span><span>    </span><span id="local-6989586621689751268"><span class="annot"><span class="annottext">handleSourceObj :: SourceName -&gt; SourceMetadataObjId b -&gt; MetadataModifier
</span><a href="#local-6989586621689751268"><span class="hs-identifier hs-var hs-var">handleSourceObj</span></a></span></span><span> </span><span id="local-6989586621689751225"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751225"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-578"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#SMOTable"><span class="hs-identifier hs-type">SMOTable</span></a></span><span> </span><span id="local-6989586621689751223"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621689751223"><span class="hs-identifier hs-var">qt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; TableName b -&gt; MetadataModifier
forall (b :: BackendType).
Backend b =&gt;
SourceName -&gt; TableName b -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#dropTableInMetadata"><span class="hs-identifier hs-var">dropTableInMetadata</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751786"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751225"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621689751223"><span class="hs-identifier hs-var">qt</span></a></span><span>
</span><span id="line-579"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#SMOFunction"><span class="hs-identifier hs-type">SMOFunction</span></a></span><span> </span><span id="local-6989586621689751220"><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621689751220"><span class="hs-identifier hs-var">qf</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; FunctionName b -&gt; MetadataModifier
forall (b :: BackendType).
Backend b =&gt;
SourceName -&gt; FunctionName b -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#dropFunctionInMetadata"><span class="hs-identifier hs-var">dropFunctionInMetadata</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751786"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751225"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621689751220"><span class="hs-identifier hs-var">qf</span></a></span><span>
</span><span id="line-580"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#SMOFunctionPermission"><span class="hs-identifier hs-type">SMOFunctionPermission</span></a></span><span> </span><span id="local-6989586621689751217"><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621689751217"><span class="hs-identifier hs-var">qf</span></a></span></span><span> </span><span id="local-6989586621689751216"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689751216"><span class="hs-identifier hs-var">rn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; FunctionName b -&gt; RoleName -&gt; MetadataModifier
forall (b :: BackendType).
BackendMetadata b =&gt;
SourceName -&gt; FunctionName b -&gt; RoleName -&gt; MetadataModifier
</span><a href="Hasura.RQL.DDL.Schema.Function.html#dropFunctionPermissionInMetadata"><span class="hs-identifier hs-var">dropFunctionPermissionInMetadata</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751786"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751225"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionName b
</span><a href="#local-6989586621689751217"><span class="hs-identifier hs-var">qf</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689751216"><span class="hs-identifier hs-var">rn</span></a></span><span>
</span><span id="line-581"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#SMOTableObj"><span class="hs-identifier hs-type">SMOTableObj</span></a></span><span> </span><span id="local-6989586621689751213"><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621689751213"><span class="hs-identifier hs-var">qt</span></a></span></span><span> </span><span id="local-6989586621689751212"><span class="annot"><span class="annottext">TableMetadataObjId
</span><a href="#local-6989586621689751212"><span class="hs-identifier hs-var">tableObj</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-582"></span><span>        </span><span class="annot"><span class="annottext">(Metadata -&gt; Metadata) -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-var">MetadataModifier</span></a></span><span> </span><span class="annot"><span class="annottext">((Metadata -&gt; Metadata) -&gt; MetadataModifier)
-&gt; (Metadata -&gt; Metadata) -&gt; MetadataModifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-583"></span><span>          </span><span class="annot"><span class="annottext">SourceName -&gt; TableName b -&gt; ASetter' Metadata (TableMetadata b)
forall (b :: BackendType).
Backend b =&gt;
SourceName -&gt; TableName b -&gt; ASetter' Metadata (TableMetadata b)
</span><a href="Hasura.RQL.Types.Metadata.html#tableMetadataSetter"><span class="hs-identifier hs-var">tableMetadataSetter</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621689751786"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689751225"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621689751213"><span class="hs-identifier hs-var">qt</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter' Metadata (TableMetadata b)
-&gt; (TableMetadata b -&gt; TableMetadata b) -&gt; Metadata -&gt; Metadata
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TableMetadataObjId
</span><a href="#local-6989586621689751212"><span class="hs-identifier hs-var">tableObj</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-584"></span><span>            </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MTORel"><span class="hs-identifier hs-type">MTORel</span></a></span><span> </span><span id="local-6989586621689751209"><span class="annot"><span class="annottext">RelName
</span><a href="#local-6989586621689751209"><span class="hs-identifier hs-var">rn</span></a></span></span><span> </span><span class="annot"><span class="annottext">RelType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RelName -&gt; TableMetadata b -&gt; TableMetadata b
forall (b :: BackendType).
RelName -&gt; TableMetadata b -&gt; TableMetadata b
</span><a href="Hasura.RQL.Types.Metadata.html#dropRelationshipInMetadata"><span class="hs-identifier hs-var">dropRelationshipInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RelName
</span><a href="#local-6989586621689751209"><span class="hs-identifier hs-var">rn</span></a></span><span>
</span><span id="line-585"></span><span>            </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MTOPerm"><span class="hs-identifier hs-type">MTOPerm</span></a></span><span> </span><span id="local-6989586621689751206"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689751206"><span class="hs-identifier hs-var">rn</span></a></span></span><span> </span><span id="local-6989586621689751205"><span class="annot"><span class="annottext">PermType
</span><a href="#local-6989586621689751205"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; PermType -&gt; TableMetadata b -&gt; TableMetadata b
forall (b :: BackendType).
RoleName -&gt; PermType -&gt; TableMetadata b -&gt; TableMetadata b
</span><a href="Hasura.RQL.Types.Metadata.html#dropPermissionInMetadata"><span class="hs-identifier hs-var">dropPermissionInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689751206"><span class="hs-identifier hs-var">rn</span></a></span><span> </span><span class="annot"><span class="annottext">PermType
</span><a href="#local-6989586621689751205"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-586"></span><span>            </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MTOTrigger"><span class="hs-identifier hs-type">MTOTrigger</span></a></span><span> </span><span id="local-6989586621689751202"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751202"><span class="hs-identifier hs-var">trn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; TableMetadata b -&gt; TableMetadata b
forall (b :: BackendType).
TriggerName -&gt; TableMetadata b -&gt; TableMetadata b
</span><a href="Hasura.RQL.Types.Metadata.html#dropEventTriggerInMetadata"><span class="hs-identifier hs-var">dropEventTriggerInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689751202"><span class="hs-identifier hs-var">trn</span></a></span><span>
</span><span id="line-587"></span><span>            </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MTOComputedField"><span class="hs-identifier hs-type">MTOComputedField</span></a></span><span> </span><span id="local-6989586621689751199"><span class="annot"><span class="annottext">ComputedFieldName
</span><a href="#local-6989586621689751199"><span class="hs-identifier hs-var">ccn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ComputedFieldName -&gt; TableMetadata b -&gt; TableMetadata b
forall (b :: BackendType).
ComputedFieldName -&gt; TableMetadata b -&gt; TableMetadata b
</span><a href="Hasura.RQL.Types.Metadata.html#dropComputedFieldInMetadata"><span class="hs-identifier hs-var">dropComputedFieldInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">ComputedFieldName
</span><a href="#local-6989586621689751199"><span class="hs-identifier hs-var">ccn</span></a></span><span>
</span><span id="line-588"></span><span>            </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MTORemoteRelationship"><span class="hs-identifier hs-type">MTORemoteRelationship</span></a></span><span> </span><span id="local-6989586621689751196"><span class="annot"><span class="annottext">RelName
</span><a href="#local-6989586621689751196"><span class="hs-identifier hs-var">rn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RelName -&gt; TableMetadata b -&gt; TableMetadata b
forall (b :: BackendType).
RelName -&gt; TableMetadata b -&gt; TableMetadata b
</span><a href="Hasura.RQL.Types.Metadata.html#dropRemoteRelationshipInMetadata"><span class="hs-identifier hs-var">dropRemoteRelationshipInMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RelName
</span><a href="#local-6989586621689751196"><span class="hs-identifier hs-var">rn</span></a></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span>    </span><span class="annot"><a href="#local-6989586621689751231"><span class="hs-identifier hs-type">dropListedQueryFromQueryCollections</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#CollectionName"><span class="hs-identifier hs-type">CollectionName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#ListedQuery"><span class="hs-identifier hs-type">ListedQuery</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-type">MetadataModifier</span></a></span><span>
</span><span id="line-591"></span><span>    </span><span id="local-6989586621689751231"><span class="annot"><span class="annottext">dropListedQueryFromQueryCollections :: CollectionName -&gt; ListedQuery -&gt; MetadataModifier
</span><a href="#local-6989586621689751231"><span class="hs-identifier hs-var hs-var">dropListedQueryFromQueryCollections</span></a></span></span><span> </span><span id="local-6989586621689751194"><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621689751194"><span class="hs-identifier hs-var">cName</span></a></span></span><span> </span><span id="local-6989586621689751193"><span class="annot"><span class="annottext">ListedQuery
</span><a href="#local-6989586621689751193"><span class="hs-identifier hs-var">lq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Metadata -&gt; Metadata) -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-var">MetadataModifier</span></a></span><span> </span><span class="annot"><span class="annottext">((Metadata -&gt; Metadata) -&gt; MetadataModifier)
-&gt; (Metadata -&gt; Metadata) -&gt; MetadataModifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; Metadata
</span><a href="#local-6989586621689751192"><span class="hs-identifier hs-var">removeAndCleanupMetadata</span></a></span><span>
</span><span id="line-592"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-593"></span><span>        </span><span id="local-6989586621689751192"><span class="annot"><span class="annottext">removeAndCleanupMetadata :: Metadata -&gt; Metadata
</span><a href="#local-6989586621689751192"><span class="hs-identifier hs-var hs-var">removeAndCleanupMetadata</span></a></span></span><span> </span><span id="local-6989586621689751191"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751191"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-594"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751190"><span class="annot"><span class="annottext">newQueryCollection :: QueryCollections
</span><a href="#local-6989586621689751190"><span class="hs-identifier hs-var hs-var">newQueryCollection</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QueryCollections -&gt; QueryCollections
</span><a href="#local-6989586621689751189"><span class="hs-identifier hs-var">filteredCollection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; QueryCollections
</span><a href="Hasura.RQL.Types.Metadata.html#_metaQueryCollections"><span class="hs-identifier hs-var hs-var">_metaQueryCollections</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751191"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>              </span><span class="hs-comment">-- QueryCollections = InsOrdHashMap CollectionName CreateCollection</span><span>
</span><span id="line-596"></span><span>              </span><span class="annot"><a href="#local-6989586621689751189"><span class="hs-identifier hs-type">filteredCollection</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#QueryCollections"><span class="hs-identifier hs-type">QueryCollections</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#QueryCollections"><span class="hs-identifier hs-type">QueryCollections</span></a></span><span>
</span><span id="line-597"></span><span>              </span><span id="local-6989586621689751189"><span class="annot"><span class="annottext">filteredCollection :: QueryCollections -&gt; QueryCollections
</span><a href="#local-6989586621689751189"><span class="hs-identifier hs-var hs-var">filteredCollection</span></a></span></span><span> </span><span id="local-6989586621689751187"><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621689751187"><span class="hs-identifier hs-var">qc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CreateCollection -&gt; Bool) -&gt; QueryCollections -&gt; QueryCollections
forall v k. (v -&gt; Bool) -&gt; InsOrdHashMap k v -&gt; InsOrdHashMap k v
</span><span class="hs-identifier hs-var">OMap.filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CreateCollection -&gt; Bool
</span><a href="#local-6989586621689751186"><span class="hs-identifier hs-var">isNonEmptyCC</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(QueryCollections -&gt; QueryCollections)
-&gt; QueryCollections -&gt; QueryCollections
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(CreateCollection -&gt; CreateCollection)
-&gt; CollectionName -&gt; QueryCollections -&gt; QueryCollections
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v) -&gt; k -&gt; InsOrdHashMap k v -&gt; InsOrdHashMap k v
</span><span class="hs-identifier hs-var">OMap.adjust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CreateCollection -&gt; CreateCollection
</span><a href="#local-6989586621689751184"><span class="hs-identifier hs-var">collectionModifier</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621689751194"><span class="hs-identifier hs-var">cName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621689751187"><span class="hs-identifier hs-var">qc</span></a></span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span>              </span><span class="annot"><a href="#local-6989586621689751184"><span class="hs-identifier hs-type">collectionModifier</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#CreateCollection"><span class="hs-identifier hs-type">CreateCollection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#CreateCollection"><span class="hs-identifier hs-type">CreateCollection</span></a></span><span>
</span><span id="line-600"></span><span>              </span><span id="local-6989586621689751184"><span class="annot"><span class="annottext">collectionModifier :: CreateCollection -&gt; CreateCollection
</span><a href="#local-6989586621689751184"><span class="hs-identifier hs-var hs-var">collectionModifier</span></a></span></span><span> </span><span id="local-6989586621689751183"><span class="annot"><span class="annottext">cc :: CreateCollection
</span><a href="#local-6989586621689751183"><span class="hs-identifier hs-var">cc</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#CreateCollection"><span class="hs-identifier hs-type">CreateCollection</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689751179"><span id="local-6989586621689751180"><span id="local-6989586621689751181"><span class="annot"><span class="annottext">Maybe Text
CollectionName
CollectionDef
_ccComment :: CreateCollection -&gt; Maybe Text
_ccDefinition :: CreateCollection -&gt; CollectionDef
_ccName :: CreateCollection -&gt; CollectionName
_ccComment :: Maybe Text
_ccDefinition :: CollectionDef
_ccName :: CollectionName
</span><a href="Hasura.RQL.Types.QueryCollection.html#_ccComment"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-601"></span><span>                </span><span class="annot"><span class="annottext">CreateCollection
</span><a href="#local-6989586621689751183"><span class="hs-identifier hs-var">cc</span></a></span><span>
</span><span id="line-602"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_ccDefinition :: CollectionDef
</span><a href="Hasura.RQL.Types.QueryCollection.html#_ccDefinition"><span class="hs-identifier hs-var">_ccDefinition</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-603"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751175"><span class="annot"><span class="annottext">oldQueries :: [ListedQuery]
</span><a href="#local-6989586621689751175"><span class="hs-identifier hs-var hs-var">oldQueries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CollectionDef -&gt; [ListedQuery]
</span><a href="Hasura.RQL.Types.QueryCollection.html#_cdQueries"><span class="hs-identifier hs-var hs-var">_cdQueries</span></a></span><span> </span><span class="annot"><span class="annottext">CollectionDef
</span><a href="#local-6989586621689751180"><span class="hs-identifier hs-var">_ccDefinition</span></a></span><span>
</span><span id="line-604"></span><span>                       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">CollectionDef
</span><a href="#local-6989586621689751180"><span class="hs-identifier hs-var">_ccDefinition</span></a></span><span>
</span><span id="line-605"></span><span>                            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_cdQueries :: [ListedQuery]
</span><a href="Hasura.RQL.Types.QueryCollection.html#_cdQueries"><span class="hs-identifier hs-var">_cdQueries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ListedQuery -&gt; Bool) -&gt; [ListedQuery] -&gt; [ListedQuery]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ListedQuery -&gt; ListedQuery -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">ListedQuery
</span><a href="#local-6989586621689751193"><span class="hs-identifier hs-var">lq</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ListedQuery]
</span><a href="#local-6989586621689751175"><span class="hs-identifier hs-var">oldQueries</span></a></span><span>
</span><span id="line-606"></span><span>                            </span><span class="hs-special">}</span><span>
</span><span id="line-607"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-608"></span><span>
</span><span id="line-609"></span><span>              </span><span class="annot"><a href="#local-6989586621689751186"><span class="hs-identifier hs-type">isNonEmptyCC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.QueryCollection.html#CreateCollection"><span class="hs-identifier hs-type">CreateCollection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-610"></span><span>              </span><span id="local-6989586621689751186"><span class="annot"><span class="annottext">isNonEmptyCC :: CreateCollection -&gt; Bool
</span><a href="#local-6989586621689751186"><span class="hs-identifier hs-var hs-var">isNonEmptyCC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (CreateCollection -&gt; Bool) -&gt; CreateCollection -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[ListedQuery] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([ListedQuery] -&gt; Bool)
-&gt; (CreateCollection -&gt; [ListedQuery]) -&gt; CreateCollection -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CollectionDef -&gt; [ListedQuery]
</span><a href="Hasura.RQL.Types.QueryCollection.html#_cdQueries"><span class="hs-identifier hs-var hs-var">_cdQueries</span></a></span><span> </span><span class="annot"><span class="annottext">(CollectionDef -&gt; [ListedQuery])
-&gt; (CreateCollection -&gt; CollectionDef)
-&gt; CreateCollection
-&gt; [ListedQuery]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CreateCollection -&gt; CollectionDef
</span><a href="Hasura.RQL.Types.QueryCollection.html#_ccDefinition"><span class="hs-identifier hs-var hs-var">_ccDefinition</span></a></span><span>
</span><span id="line-611"></span><span>
</span><span id="line-612"></span><span>              </span><span class="annot"><a href="#local-6989586621689751172"><span class="hs-identifier hs-type">cleanupAllowList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Allowlist.html#MetadataAllowlist"><span class="hs-identifier hs-type">MetadataAllowlist</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Allowlist.html#MetadataAllowlist"><span class="hs-identifier hs-type">MetadataAllowlist</span></a></span><span>
</span><span id="line-613"></span><span>              </span><span id="local-6989586621689751172"><span class="annot"><span class="annottext">cleanupAllowList :: MetadataAllowlist -&gt; MetadataAllowlist
</span><a href="#local-6989586621689751172"><span class="hs-identifier hs-var hs-var">cleanupAllowList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CollectionName -&gt; AllowlistEntry -&gt; Bool)
-&gt; MetadataAllowlist -&gt; MetadataAllowlist
forall k v.
(k -&gt; v -&gt; Bool) -&gt; InsOrdHashMap k v -&gt; InsOrdHashMap k v
</span><span class="hs-identifier hs-var">OMap.filterWithKey</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">CollectionName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AllowlistEntry
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CollectionName -&gt; QueryCollections -&gt; Bool
forall k a. (Eq k, Hashable k) =&gt; k -&gt; InsOrdHashMap k a -&gt; Bool
</span><span class="hs-identifier hs-var">OMap.member</span></span><span> </span><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621689751194"><span class="hs-identifier hs-var">cName</span></a></span><span> </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621689751190"><span class="hs-identifier hs-var">newQueryCollection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span>              </span><span class="annot"><a href="#local-6989586621689751170"><span class="hs-identifier hs-type">cleanupRESTEndpoints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#Endpoints"><span class="hs-identifier hs-type">Endpoints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#Endpoints"><span class="hs-identifier hs-type">Endpoints</span></a></span><span>
</span><span id="line-616"></span><span>              </span><span id="local-6989586621689751170"><span class="annot"><span class="annottext">cleanupRESTEndpoints :: Endpoints -&gt; Endpoints
</span><a href="#local-6989586621689751170"><span class="hs-identifier hs-var hs-var">cleanupRESTEndpoints</span></a></span></span><span> </span><span id="local-6989586621689751169"><span class="annot"><span class="annottext">Endpoints
</span><a href="#local-6989586621689751169"><span class="hs-identifier hs-var">endpoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EndpointMetadata QueryReference -&gt; Bool) -&gt; Endpoints -&gt; Endpoints
forall v k. (v -&gt; Bool) -&gt; InsOrdHashMap k v -&gt; InsOrdHashMap k v
</span><span class="hs-identifier hs-var">OMap.filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (EndpointMetadata QueryReference -&gt; Bool)
-&gt; EndpointMetadata QueryReference
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">QueryReference -&gt; Bool
</span><a href="#local-6989586621689751168"><span class="hs-identifier hs-var">isFaultyQuery</span></a></span><span> </span><span class="annot"><span class="annottext">(QueryReference -&gt; Bool)
-&gt; (EndpointMetadata QueryReference -&gt; QueryReference)
-&gt; EndpointMetadata QueryReference
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EndpointDef QueryReference -&gt; QueryReference
forall query. EndpointDef query -&gt; query
</span><a href="Hasura.RQL.Types.Endpoint.html#_edQuery"><span class="hs-identifier hs-var hs-var">_edQuery</span></a></span><span> </span><span class="annot"><span class="annottext">(EndpointDef QueryReference -&gt; QueryReference)
-&gt; (EndpointMetadata QueryReference -&gt; EndpointDef QueryReference)
-&gt; EndpointMetadata QueryReference
-&gt; QueryReference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EndpointMetadata QueryReference -&gt; EndpointDef QueryReference
forall query. EndpointMetadata query -&gt; EndpointDef query
</span><a href="Hasura.RQL.Types.Endpoint.html#_ceDefinition"><span class="hs-identifier hs-var hs-var">_ceDefinition</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Endpoints
</span><a href="#local-6989586621689751169"><span class="hs-identifier hs-var">endpoints</span></a></span><span>
</span><span id="line-617"></span><span>
</span><span id="line-618"></span><span>              </span><span class="annot"><a href="#local-6989586621689751168"><span class="hs-identifier hs-type">isFaultyQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#QueryReference"><span class="hs-identifier hs-type">QueryReference</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-619"></span><span>              </span><span id="local-6989586621689751168"><span class="annot"><span class="annottext">isFaultyQuery :: QueryReference -&gt; Bool
</span><a href="#local-6989586621689751168"><span class="hs-identifier hs-var hs-var">isFaultyQuery</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Endpoint.html#QueryReference"><span class="hs-identifier hs-type">QueryReference</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689751163"><span id="local-6989586621689751164"><span class="annot"><span class="annottext">QueryName
CollectionName
_qrQueryName :: QueryReference -&gt; QueryName
_qrCollectionName :: QueryReference -&gt; CollectionName
_qrQueryName :: QueryName
_qrCollectionName :: CollectionName
</span><a href="Hasura.RQL.Types.Endpoint.html#_qrQueryName"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621689751164"><span class="hs-identifier hs-var">_qrCollectionName</span></a></span><span> </span><span class="annot"><span class="annottext">CollectionName -&gt; CollectionName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CollectionName
</span><a href="#local-6989586621689751194"><span class="hs-identifier hs-var">cName</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">QueryName
</span><a href="#local-6989586621689751163"><span class="hs-identifier hs-var">_qrQueryName</span></a></span><span> </span><span class="annot"><span class="annottext">QueryName -&gt; QueryName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ListedQuery -&gt; QueryName
</span><a href="Hasura.RQL.Types.QueryCollection.html#_lqName"><span class="hs-identifier hs-var hs-var">_lqName</span></a></span><span> </span><span class="annot"><span class="annottext">ListedQuery
</span><a href="#local-6989586621689751193"><span class="hs-identifier hs-var">lq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751191"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-621"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_metaQueryCollections :: QueryCollections
</span><a href="Hasura.RQL.Types.Metadata.html#_metaQueryCollections"><span class="hs-identifier hs-var">_metaQueryCollections</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621689751190"><span class="hs-identifier hs-var">newQueryCollection</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-622"></span><span>                  </span><span class="annot"><span class="annottext">_metaAllowlist :: MetadataAllowlist
</span><a href="Hasura.RQL.Types.Metadata.html#_metaAllowlist"><span class="hs-identifier hs-var">_metaAllowlist</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataAllowlist -&gt; MetadataAllowlist
</span><a href="#local-6989586621689751172"><span class="hs-identifier hs-var">cleanupAllowList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; MetadataAllowlist
</span><a href="Hasura.RQL.Types.Metadata.html#_metaAllowlist"><span class="hs-identifier hs-var hs-var">_metaAllowlist</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751191"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-623"></span><span>                  </span><span class="annot"><span class="annottext">_metaRestEndpoints :: Endpoints
</span><a href="Hasura.RQL.Types.Metadata.html#_metaRestEndpoints"><span class="hs-identifier hs-var">_metaRestEndpoints</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Endpoints -&gt; Endpoints
</span><a href="#local-6989586621689751170"><span class="hs-identifier hs-var">cleanupRESTEndpoints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Metadata -&gt; Endpoints
</span><a href="Hasura.RQL.Types.Metadata.html#_metaRestEndpoints"><span class="hs-identifier hs-var hs-var">_metaRestEndpoints</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689751191"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-624"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span id="local-6989586621689751158"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runGetCatalogState"><span class="hs-identifier hs-type">runGetCatalogState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-627"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorageQueryAPI"><span class="hs-identifier hs-type">MonadMetadataStorageQueryAPI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751158"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#GetCatalogState"><span class="hs-identifier hs-type">GetCatalogState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689751158"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-628"></span><span id="runGetCatalogState"><span class="annot"><span class="annottext">runGetCatalogState :: GetCatalogState -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runGetCatalogState"><span class="hs-identifier hs-var hs-var">runGetCatalogState</span></a></span></span><span> </span><span class="annot"><span class="annottext">GetCatalogState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-629"></span><span>  </span><span class="annot"><span class="annottext">CatalogState -&gt; EncJSON
forall a. ToJSON a =&gt; a -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromJValue"><span class="hs-identifier hs-var">encJFromJValue</span></a></span><span> </span><span class="annot"><span class="annottext">(CatalogState -&gt; EncJSON) -&gt; m CatalogState -&gt; m EncJSON
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m CatalogState
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
m CatalogState
</span><a href="Hasura.Metadata.Class.html#fetchCatalogState"><span class="hs-identifier hs-var">fetchCatalogState</span></a></span><span>
</span><span id="line-630"></span><span>
</span><span id="line-631"></span><span id="local-6989586621689751156"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runSetCatalogState"><span class="hs-identifier hs-type">runSetCatalogState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-632"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorageQueryAPI"><span class="hs-identifier hs-type">MonadMetadataStorageQueryAPI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751156"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#SetCatalogState"><span class="hs-identifier hs-type">SetCatalogState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689751156"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-633"></span><span id="runSetCatalogState"><span class="annot"><span class="annottext">runSetCatalogState :: SetCatalogState -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runSetCatalogState"><span class="hs-identifier hs-var hs-var">runSetCatalogState</span></a></span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#SetCatalogState"><span class="hs-identifier hs-type">SetCatalogState</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689751153"><span id="local-6989586621689751154"><span class="annot"><span class="annottext">Value
CatalogStateType
_scsState :: SetCatalogState -&gt; Value
_scsType :: SetCatalogState -&gt; CatalogStateType
_scsState :: Value
_scsType :: CatalogStateType
</span><a href="Hasura.RQL.Types.Metadata.Common.html#_scsState"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-634"></span><span>  </span><span class="annot"><span class="annottext">CatalogStateType -&gt; Value -&gt; m ()
forall (m :: * -&gt; *).
MonadMetadataStorageQueryAPI m =&gt;
CatalogStateType -&gt; Value -&gt; m ()
</span><a href="Hasura.Metadata.Class.html#updateCatalogState"><span class="hs-identifier hs-var">updateCatalogState</span></a></span><span> </span><span class="annot"><span class="annottext">CatalogStateType
</span><a href="#local-6989586621689751154"><span class="hs-identifier hs-var">_scsType</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689751153"><span class="hs-identifier hs-var">_scsState</span></a></span><span>
</span><span id="line-635"></span><span>  </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">EncJSON
</span><a href="Hasura.RQL.Types.Common.html#successMsg"><span class="hs-identifier hs-var">successMsg</span></a></span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span id="local-6989586621689751149"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runSetMetricsConfig"><span class="hs-identifier hs-type">runSetMetricsConfig</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-638"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689751149"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751149"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751149"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751149"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-639"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#MetricsConfig"><span class="hs-identifier hs-type">MetricsConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-640"></span><span>  </span><span class="annot"><a href="#local-6989586621689751149"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-641"></span><span id="runSetMetricsConfig"><span class="annot"><span class="annottext">runSetMetricsConfig :: MetricsConfig -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runSetMetricsConfig"><span class="hs-identifier hs-var hs-var">runSetMetricsConfig</span></a></span></span><span> </span><span id="local-6989586621689751148"><span class="annot"><span class="annottext">MetricsConfig
</span><a href="#local-6989586621689751148"><span class="hs-identifier hs-var">mc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-642"></span><span>  </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. (QErrM m, CacheRM m) =&gt; m a -&gt; m a
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withNewInconsistentObjsCheck"><span class="hs-identifier hs-var">withNewInconsistentObjsCheck</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-643"></span><span>    </span><span class="annot"><span class="annottext">MetadataModifier -&gt; m ()
forall (m :: * -&gt; *).
(MetadataM m, CacheRWM m) =&gt;
MetadataModifier -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCache"><span class="hs-identifier hs-var">buildSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">(MetadataModifier -&gt; m ()) -&gt; MetadataModifier -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-644"></span><span>      </span><span class="annot"><span class="annottext">(Metadata -&gt; Metadata) -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-var">MetadataModifier</span></a></span><span> </span><span class="annot"><span class="annottext">((Metadata -&gt; Metadata) -&gt; MetadataModifier)
-&gt; (Metadata -&gt; Metadata) -&gt; MetadataModifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-645"></span><span>        </span><span class="annot"><span class="annottext">(MetricsConfig -&gt; Identity MetricsConfig)
-&gt; Metadata -&gt; Identity Metadata
Lens' Metadata MetricsConfig
</span><a href="Hasura.RQL.Types.Metadata.html#metaMetricsConfig"><span class="hs-identifier hs-var">metaMetricsConfig</span></a></span><span> </span><span class="annot"><span class="annottext">((MetricsConfig -&gt; Identity MetricsConfig)
 -&gt; Metadata -&gt; Identity Metadata)
-&gt; MetricsConfig -&gt; Metadata -&gt; Metadata
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">MetricsConfig
</span><a href="#local-6989586621689751148"><span class="hs-identifier hs-var">mc</span></a></span><span>
</span><span id="line-646"></span><span>  </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">EncJSON
</span><a href="Hasura.RQL.Types.Common.html#successMsg"><span class="hs-identifier hs-var">successMsg</span></a></span><span>
</span><span id="line-647"></span><span>
</span><span id="line-648"></span><span id="local-6989586621689751145"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runRemoveMetricsConfig"><span class="hs-identifier hs-type">runRemoveMetricsConfig</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-649"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689751145"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751145"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751145"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751145"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-650"></span><span>  </span><span class="annot"><a href="#local-6989586621689751145"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-651"></span><span id="runRemoveMetricsConfig"><span class="annot"><span class="annottext">runRemoveMetricsConfig :: m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runRemoveMetricsConfig"><span class="hs-identifier hs-var hs-var">runRemoveMetricsConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-652"></span><span>  </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. (QErrM m, CacheRM m) =&gt; m a -&gt; m a
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withNewInconsistentObjsCheck"><span class="hs-identifier hs-var">withNewInconsistentObjsCheck</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-653"></span><span>    </span><span class="annot"><span class="annottext">MetadataModifier -&gt; m ()
forall (m :: * -&gt; *).
(MetadataM m, CacheRWM m) =&gt;
MetadataModifier -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCache"><span class="hs-identifier hs-var">buildSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">(MetadataModifier -&gt; m ()) -&gt; MetadataModifier -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-654"></span><span>      </span><span class="annot"><span class="annottext">(Metadata -&gt; Metadata) -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-var">MetadataModifier</span></a></span><span> </span><span class="annot"><span class="annottext">((Metadata -&gt; Metadata) -&gt; MetadataModifier)
-&gt; (Metadata -&gt; Metadata) -&gt; MetadataModifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-655"></span><span>        </span><span class="annot"><span class="annottext">(MetricsConfig -&gt; Identity MetricsConfig)
-&gt; Metadata -&gt; Identity Metadata
Lens' Metadata MetricsConfig
</span><a href="Hasura.RQL.Types.Metadata.html#metaMetricsConfig"><span class="hs-identifier hs-var">metaMetricsConfig</span></a></span><span> </span><span class="annot"><span class="annottext">((MetricsConfig -&gt; Identity MetricsConfig)
 -&gt; Metadata -&gt; Identity Metadata)
-&gt; MetricsConfig -&gt; Metadata -&gt; Metadata
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">MetricsConfig
</span><a href="Hasura.RQL.Types.Common.html#emptyMetricsConfig"><span class="hs-identifier hs-var">emptyMetricsConfig</span></a></span><span>
</span><span id="line-656"></span><span>  </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">EncJSON
</span><a href="Hasura.RQL.Types.Common.html#successMsg"><span class="hs-identifier hs-var">successMsg</span></a></span><span>
</span><span id="line-657"></span><span>
</span><span id="line-658"></span><span class="hs-keyword">data</span><span> </span><span id="TestTransformError"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#TestTransformError"><span class="hs-identifier hs-var">TestTransformError</span></a></span></span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="RequestInitializationError"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#RequestInitializationError"><span class="hs-identifier hs-var">RequestInitializationError</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HTTP.HttpException</span></span><span>
</span><span id="line-660"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="RequestTransformationError"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#RequestTransformationError"><span class="hs-identifier hs-var">RequestTransformationError</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP.Client.Transformable.html#Request"><span class="hs-identifier hs-type">HTTP.Request</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Webhook.Transform.Class.html#TransformErrorBundle"><span class="hs-identifier hs-type">TransformErrorBundle</span></a></span><span>
</span><span id="line-661"></span><span>
</span><span id="line-662"></span><span id="local-6989586621689751142"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#runTestWebhookTransform"><span class="hs-identifier hs-type">runTestWebhookTransform</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-663"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751142"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-664"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#TestWebhookTransform"><span class="hs-identifier hs-type">TestWebhookTransform</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-665"></span><span>  </span><span class="annot"><a href="#local-6989586621689751142"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-666"></span><span id="runTestWebhookTransform"><span class="annot"><span class="annottext">runTestWebhookTransform :: TestWebhookTransform -&gt; m EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#runTestWebhookTransform"><span class="hs-identifier hs-var hs-var">runTestWebhookTransform</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#TestWebhookTransform"><span class="hs-identifier hs-type">TestWebhookTransform</span></a></span><span> </span><span id="local-6989586621689751140"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621689751140"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621689751139"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621689751139"><span class="hs-identifier hs-var">headers</span></a></span></span><span> </span><span id="local-6989586621689751138"><span class="annot"><span class="annottext">WebHookUrl
</span><a href="#local-6989586621689751138"><span class="hs-identifier hs-var">urlE</span></a></span></span><span> </span><span id="local-6989586621689751137"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689751137"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span id="local-6989586621689751136"><span class="annot"><span class="annottext">RequestTransform
</span><a href="#local-6989586621689751136"><span class="hs-identifier hs-var">rt</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe MetadataResponseTransform
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621689751135"><span class="annot"><span class="annottext">Maybe SessionVariables
</span><a href="#local-6989586621689751135"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-667"></span><span>  </span><span id="local-6989586621689751134"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751134"><span class="hs-identifier hs-var">url</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WebHookUrl
</span><a href="#local-6989586621689751138"><span class="hs-identifier hs-var">urlE</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-668"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#URL"><span class="hs-identifier hs-type">URL</span></a></span><span> </span><span id="local-6989586621689751132"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751132"><span class="hs-identifier hs-var">url'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Environment -&gt; Text -&gt; m Text
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
Environment -&gt; Text -&gt; m Text
</span><a href="Hasura.RQL.DDL.Metadata.html#interpolateFromEnv"><span class="hs-identifier hs-var">interpolateFromEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621689751140"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751132"><span class="hs-identifier hs-var">url'</span></a></span><span>
</span><span id="line-669"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.Types.html#EnvVar"><span class="hs-identifier hs-type">EnvVar</span></a></span><span> </span><span id="local-6989586621689751129"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689751129"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-670"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751128"><span class="annot"><span class="annottext">err :: m a
</span><a href="#local-6989586621689751128"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(QErr -&gt; m a) -&gt; QErr -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="Hasura.Base.Error.html#err400"><span class="hs-identifier hs-var">err400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotFound"><span class="hs-identifier hs-var">NotFound</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Missing Env Var&quot;</span></span><span>
</span><span id="line-671"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">m Text -&gt; (String -&gt; m Text) -&gt; Maybe String -&gt; m Text
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">m Text
forall a. m a
</span><a href="#local-6989586621689751128"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; m Text
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m Text) -&gt; (String -&gt; Text) -&gt; String -&gt; m Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; m Text) -&gt; Maybe String -&gt; m Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Environment -&gt; String -&gt; Maybe String
</span><a href="Data.Environment.html#lookupEnv"><span class="hs-identifier hs-var">Env.lookupEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621689751140"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689751129"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-672"></span><span>
</span><span id="line-673"></span><span>  </span><span id="local-6989586621689751124"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621689751124"><span class="hs-identifier hs-var">headers'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Header -&gt; m Header) -&gt; [Header] -&gt; m [Header]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ByteString -&gt; m ByteString) -&gt; Header -&gt; m Header
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Text -&gt; ByteString) -&gt; m Text -&gt; m ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><span class="hs-identifier hs-var">TE.encodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(m Text -&gt; m ByteString)
-&gt; (ByteString -&gt; m Text) -&gt; ByteString -&gt; m ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Environment -&gt; Text -&gt; m Text
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
Environment -&gt; Text -&gt; m Text
</span><a href="Hasura.RQL.DDL.Metadata.html#interpolateFromEnv"><span class="hs-identifier hs-var">interpolateFromEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621689751140"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m Text) -&gt; (ByteString -&gt; Text) -&gt; ByteString -&gt; m Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><span class="hs-identifier hs-var">TE.decodeUtf8</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621689751139"><span class="hs-identifier hs-var">headers</span></a></span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span>  </span><span id="local-6989586621689751120"><span class="annot"><span class="annottext">Either TestTransformError Request
</span><a href="#local-6989586621689751120"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExceptT TestTransformError m Request
-&gt; m (Either TestTransformError Request)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT TestTransformError m Request
 -&gt; m (Either TestTransformError Request))
-&gt; ExceptT TestTransformError m Request
-&gt; m (Either TestTransformError Request)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-676"></span><span>    </span><span id="local-6989586621689751118"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751118"><span class="hs-identifier hs-var">initReq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either TestTransformError Request
-&gt; ExceptT TestTransformError m Request
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; ExceptT e m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">hoistEither</span></a></span><span> </span><span class="annot"><span class="annottext">(Either TestTransformError Request
 -&gt; ExceptT TestTransformError m Request)
-&gt; Either TestTransformError Request
-&gt; ExceptT TestTransformError m Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HttpException -&gt; TestTransformError)
-&gt; Either HttpException Request
-&gt; Either TestTransformError Request
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">HttpException -&gt; TestTransformError
</span><a href="Hasura.RQL.DDL.Metadata.html#RequestInitializationError"><span class="hs-identifier hs-var">RequestInitializationError</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HttpException Request -&gt; Either TestTransformError Request)
-&gt; Either HttpException Request
-&gt; Either TestTransformError Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either HttpException Request
</span><a href="Network.HTTP.Client.Transformable.html#mkRequestEither"><span class="hs-identifier hs-var">HTTP.mkRequestEither</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751134"><span class="hs-identifier hs-var">url</span></a></span><span>
</span><span id="line-677"></span><span>
</span><span id="line-678"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751115"><span class="annot"><span class="annottext">req :: Request
</span><a href="#local-6989586621689751115"><span class="hs-identifier hs-var hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751118"><span class="hs-identifier hs-var">initReq</span></a></span><span> </span><span class="annot"><span class="annottext">Request -&gt; (Request -&gt; Request) -&gt; Request
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ByteString -&gt; Identity (Maybe ByteString))
-&gt; Request -&gt; Identity Request
Lens' Request (Maybe ByteString)
</span><a href="Network.HTTP.Client.Transformable.html#body"><span class="hs-identifier hs-var">HTTP.body</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe ByteString -&gt; Identity (Maybe ByteString))
 -&gt; Request -&gt; Identity Request)
-&gt; Maybe ByteString -&gt; Request -&gt; Request
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689751137"><span class="hs-identifier hs-var">payload</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Request -&gt; (Request -&gt; Request) -&gt; Request
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">([Header] -&gt; Identity [Header]) -&gt; Request -&gt; Identity Request
Lens' Request [Header]
</span><a href="Network.HTTP.Client.Transformable.html#headers"><span class="hs-identifier hs-var">HTTP.headers</span></a></span><span> </span><span class="annot"><span class="annottext">(([Header] -&gt; Identity [Header]) -&gt; Request -&gt; Identity Request)
-&gt; [Header] -&gt; Request -&gt; Request
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621689751124"><span class="hs-identifier hs-var">headers'</span></a></span><span>
</span><span id="line-679"></span><span>        </span><span id="local-6989586621689751111"><span class="annot"><span class="annottext">reqTransform :: RequestFields (WithOptional TransformFn)
</span><a href="#local-6989586621689751111"><span class="hs-identifier hs-var hs-var">reqTransform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RequestTransform -&gt; RequestFields (WithOptional TransformFn)
</span><a href="Hasura.RQL.DDL.Webhook.Transform.html#requestFields"><span class="hs-identifier hs-var hs-var">requestFields</span></a></span><span> </span><span class="annot"><span class="annottext">RequestTransform
</span><a href="#local-6989586621689751136"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-680"></span><span>        </span><span id="local-6989586621689751109"><span class="annot"><span class="annottext">engine :: TemplatingEngine
</span><a href="#local-6989586621689751109"><span class="hs-identifier hs-var hs-var">engine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RequestTransform -&gt; TemplatingEngine
</span><a href="Hasura.RQL.DDL.Webhook.Transform.html#templateEngine"><span class="hs-identifier hs-var hs-var">templateEngine</span></a></span><span> </span><span class="annot"><span class="annottext">RequestTransform
</span><a href="#local-6989586621689751136"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-681"></span><span>        </span><span id="local-6989586621689751107"><span class="annot"><span class="annottext">reqTransformCtx :: Request -&gt; RequestTransformCtx
</span><a href="#local-6989586621689751107"><span class="hs-identifier hs-var hs-var">reqTransformCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; Maybe SessionVariables
-&gt; TemplatingEngine
-&gt; Request
-&gt; RequestTransformCtx
</span><a href="Hasura.RQL.DDL.Webhook.Transform.Class.html#mkReqTransformCtx"><span class="hs-identifier hs-var">mkReqTransformCtx</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751134"><span class="hs-identifier hs-var">url</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SessionVariables
</span><a href="#local-6989586621689751135"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">TemplatingEngine
</span><a href="#local-6989586621689751109"><span class="hs-identifier hs-var">engine</span></a></span><span>
</span><span id="line-682"></span><span>    </span><span class="annot"><span class="annottext">Either TestTransformError Request
-&gt; ExceptT TestTransformError m Request
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; ExceptT e m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">hoistEither</span></a></span><span> </span><span class="annot"><span class="annottext">(Either TestTransformError Request
 -&gt; ExceptT TestTransformError m Request)
-&gt; Either TestTransformError Request
-&gt; ExceptT TestTransformError m Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TransformErrorBundle -&gt; TestTransformError)
-&gt; Either TransformErrorBundle Request
-&gt; Either TestTransformError Request
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request -&gt; TransformErrorBundle -&gt; TestTransformError
</span><a href="Hasura.RQL.DDL.Metadata.html#RequestTransformationError"><span class="hs-identifier hs-var">RequestTransformationError</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751115"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either TransformErrorBundle Request
 -&gt; Either TestTransformError Request)
-&gt; Either TransformErrorBundle Request
-&gt; Either TestTransformError Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Request -&gt; RequestTransformCtx)
-&gt; RequestFields (WithOptional TransformFn)
-&gt; Request
-&gt; Either TransformErrorBundle Request
forall (m :: * -&gt; *).
MonadError TransformErrorBundle m =&gt;
(Request -&gt; RequestTransformCtx)
-&gt; RequestFields (WithOptional TransformFn) -&gt; Request -&gt; m Request
</span><a href="Hasura.RQL.DDL.Webhook.Transform.html#applyRequestTransform"><span class="hs-identifier hs-var">applyRequestTransform</span></a></span><span> </span><span class="annot"><span class="annottext">Request -&gt; RequestTransformCtx
</span><a href="#local-6989586621689751107"><span class="hs-identifier hs-var">reqTransformCtx</span></a></span><span> </span><span class="annot"><span class="annottext">RequestFields (WithOptional TransformFn)
</span><a href="#local-6989586621689751111"><span class="hs-identifier hs-var">reqTransform</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751115"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-683"></span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either TestTransformError Request
</span><a href="#local-6989586621689751120"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-685"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621689751105"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751105"><span class="hs-identifier hs-var">transformed</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-686"></span><span>      </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(EncJSON -&gt; m EncJSON) -&gt; EncJSON -&gt; m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either TransformErrorBundle Request -&gt; EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#packTransformResult"><span class="hs-identifier hs-var">packTransformResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Either TransformErrorBundle Request -&gt; EncJSON)
-&gt; Either TransformErrorBundle Request -&gt; EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; Either TransformErrorBundle Request
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751105"><span class="hs-identifier hs-var">transformed</span></a></span><span>
</span><span id="line-687"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#RequestTransformationError"><span class="hs-identifier hs-type">RequestTransformationError</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621689751103"><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621689751103"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(EncJSON -&gt; m EncJSON) -&gt; EncJSON -&gt; m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either TransformErrorBundle Request -&gt; EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#packTransformResult"><span class="hs-identifier hs-var">packTransformResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransformErrorBundle -&gt; Either TransformErrorBundle Request
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621689751103"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-comment">-- NOTE: In the following case we have failed before producing a valid request.</span><span>
</span><span id="line-689"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#RequestInitializationError"><span class="hs-identifier hs-type">RequestInitializationError</span></a></span><span> </span><span id="local-6989586621689751102"><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621689751102"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-690"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751101"><span class="annot"><span class="annottext">errorBundle :: TransformErrorBundle
</span><a href="#local-6989586621689751101"><span class="hs-identifier hs-var hs-var">errorBundle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-691"></span><span>            </span><span class="annot"><span class="annottext">[Value] -&gt; TransformErrorBundle
</span><a href="Hasura.RQL.DDL.Webhook.Transform.Class.html#TransformErrorBundle"><span class="hs-identifier hs-var">TransformErrorBundle</span></a></span><span> </span><span class="annot"><span class="annottext">([Value] -&gt; TransformErrorBundle)
-&gt; [Value] -&gt; TransformErrorBundle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-692"></span><span>              </span><span class="annot"><span class="annottext">Value -&gt; [Value]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; [Value]) -&gt; Value -&gt; [Value]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-693"></span><span>                </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;error_code&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value
</span><span class="hs-identifier hs-var">J.String</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Request Initialization Error&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;message&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value
</span><span class="hs-identifier hs-var">J.String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HttpException -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621689751102"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-694"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EncJSON -&gt; m EncJSON
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(EncJSON -&gt; m EncJSON) -&gt; EncJSON -&gt; m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; EncJSON
forall a. ToJSON a =&gt; a -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromJValue"><span class="hs-identifier hs-var">encJFromJValue</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; EncJSON) -&gt; Value -&gt; EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TransformErrorBundle -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621689751101"><span class="hs-identifier hs-var">errorBundle</span></a></span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span id="local-6989586621689751727"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#interpolateFromEnv"><span class="hs-identifier hs-type">interpolateFromEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751727"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689751727"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span></span><span>
</span><span id="line-697"></span><span id="interpolateFromEnv"><span class="annot"><span class="annottext">interpolateFromEnv :: Environment -&gt; Text -&gt; m Text
</span><a href="Hasura.RQL.DDL.Metadata.html#interpolateFromEnv"><span class="hs-identifier hs-var hs-var">interpolateFromEnv</span></a></span></span><span> </span><span id="local-6989586621689751097"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621689751097"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621689751096"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751096"><span class="hs-identifier hs-var">url</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-698"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Parser [Either Text Text]
-&gt; Text -&gt; Either String [Either Text Text]
forall a. Parser a -&gt; Text -&gt; Either String a
</span><span class="hs-identifier hs-var">AT.parseOnly</span></span><span> </span><span class="annot"><span class="annottext">Parser [Either Text Text]
</span><a href="Hasura.RQL.DDL.Metadata.html#parseEnvTemplate"><span class="hs-identifier hs-var">parseEnvTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751096"><span class="hs-identifier hs-var">url</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-699"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; m Text
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(QErr -&gt; m Text) -&gt; QErr -&gt; m Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="Hasura.Base.Error.html#err400"><span class="hs-identifier hs-var">err400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#ParseFailed"><span class="hs-identifier hs-var">ParseFailed</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Invalid Url Template&quot;</span></span><span>
</span><span id="line-700"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621689751092"><span class="annot"><span class="annottext">[Either Text Text]
</span><a href="#local-6989586621689751092"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-701"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689751091"><span class="annot"><span class="annottext">lookup' :: Text -&gt; Either Text Text
</span><a href="#local-6989586621689751091"><span class="hs-identifier hs-var hs-var">lookup'</span></a></span></span><span> </span><span id="local-6989586621689751090"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751090"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either Text Text
-&gt; (String -&gt; Either Text Text) -&gt; Maybe String -&gt; Either Text Text
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Either Text Text
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751090"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Either Text Text
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Either Text Text)
-&gt; (String -&gt; Text) -&gt; String -&gt; Either Text Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Either Text Text)
-&gt; Maybe String -&gt; Either Text Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Environment -&gt; String -&gt; Maybe String
</span><a href="Data.Environment.html#lookupEnv"><span class="hs-identifier hs-var">Env.lookupEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621689751097"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751090"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span>          </span><span id="local-6989586621689751088"><span class="annot"><span class="annottext">result :: Either Text [Text]
</span><a href="#local-6989586621689751088"><span class="hs-identifier hs-var hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Either Text Text -&gt; Either Text Text)
-&gt; [Either Text Text] -&gt; Either Text [Text]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Either Text Text -&gt; Text)
-&gt; Either Text (Either Text Text) -&gt; Either Text Text
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Either Text Text -&gt; Text
forall a. Either a a -&gt; a
</span><a href="Hasura.RQL.DDL.Metadata.html#indistinct"><span class="hs-identifier hs-var">indistinct</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Text (Either Text Text) -&gt; Either Text Text)
-&gt; (Either Text Text -&gt; Either Text (Either Text Text))
-&gt; Either Text Text
-&gt; Either Text Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Either Text Text)
-&gt; (Text -&gt; Either Text Text)
-&gt; Either Text Text
-&gt; Either Text (Either Text Text)
forall (t :: * -&gt; * -&gt; *) (f :: * -&gt; *) a c b d.
(Bitraversable t, Applicative f) =&gt;
(a -&gt; f c) -&gt; (b -&gt; f d) -&gt; t a b -&gt; f (t c d)
</span><span class="hs-identifier hs-var">bitraverse</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text Text
</span><a href="#local-6989586621689751091"><span class="hs-identifier hs-var">lookup'</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text Text
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Either Text Text]
</span><a href="#local-6989586621689751092"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-703"></span><span>          </span><span id="local-6989586621689751085"><span class="annot"><span class="annottext">err :: Text -&gt; m a
</span><a href="#local-6989586621689751085"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span id="local-6989586621689751084"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751084"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-704"></span><span>            </span><span class="annot"><span class="annottext">QErr -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(QErr -&gt; m a) -&gt; QErr -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-705"></span><span>              </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="Hasura.Base.Error.html#err400"><span class="hs-identifier hs-var">err400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotFound"><span class="hs-identifier hs-var">NotFound</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; QErr) -&gt; Text -&gt; QErr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-706"></span><span>                </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Missing Env Var: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751084"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-707"></span><span>                  </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;. For security reasons when testing request options real environment variable values are not available. Please enter a mock value for &quot;</span></span><span>
</span><span id="line-708"></span><span>                  </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689751084"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-709"></span><span>                  </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; in the Sample Env Variables list. See https://hasura.io/docs/latest/graphql/core/actions/rest-connectors/#action-transforms-sample-context&quot;</span></span><span>
</span><span id="line-710"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m Text)
-&gt; ([Text] -&gt; m Text) -&gt; Either Text [Text] -&gt; m Text
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; m Text
forall (m :: * -&gt; *) a. MonadError QErr m =&gt; Text -&gt; m a
</span><a href="#local-6989586621689751085"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; m Text
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m Text) -&gt; ([Text] -&gt; Text) -&gt; [Text] -&gt; m Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><span class="hs-identifier hs-var">fold</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either Text [Text]
</span><a href="#local-6989586621689751088"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span class="hs-comment">-- | Deserialize a JSON or X-WWW-URL-FORMENCODED body from an</span><span>
</span><span id="line-713"></span><span class="hs-comment">-- 'HTTP.Request' as 'J.Value'.</span><span>
</span><span id="line-714"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#decodeBody"><span class="hs-identifier hs-type">decodeBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-715"></span><span id="decodeBody"><span class="annot"><span class="annottext">decodeBody :: Maybe ByteString -&gt; Value
</span><a href="Hasura.RQL.DDL.Metadata.html#decodeBody"><span class="hs-identifier hs-var hs-var">decodeBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier hs-var">J.Null</span></span><span>
</span><span id="line-716"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#decodeBody"><span class="hs-identifier hs-var">decodeBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621689751079"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689751079"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value -&gt; Value
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier hs-var">J.Null</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Value -&gt; Value) -&gt; Maybe Value -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe Value
</span><a href="Hasura.RQL.DDL.Metadata.html#jsonToValue"><span class="hs-identifier hs-var">jsonToValue</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689751079"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value -&gt; Maybe Value -&gt; Maybe Value
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe Value
</span><a href="Hasura.RQL.DDL.Metadata.html#formUrlEncodedToValue"><span class="hs-identifier hs-var">formUrlEncodedToValue</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689751079"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-717"></span><span>
</span><span id="line-718"></span><span class="hs-comment">-- | Attempt to encode a 'ByteString' as an Aeson 'Value'</span><span>
</span><span id="line-719"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#jsonToValue"><span class="hs-identifier hs-type">jsonToValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-720"></span><span id="jsonToValue"><span class="annot"><span class="annottext">jsonToValue :: ByteString -&gt; Maybe Value
</span><a href="Hasura.RQL.DDL.Metadata.html#jsonToValue"><span class="hs-identifier hs-var hs-var">jsonToValue</span></a></span></span><span> </span><span id="local-6989586621689751074"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689751074"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe Value
forall a. FromJSON a =&gt; ByteString -&gt; Maybe a
</span><span class="hs-identifier hs-var">J.decode</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689751074"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-721"></span><span>
</span><span id="line-722"></span><span class="hs-comment">-- | Quote a 'ByteString' then attempt to encode it as a JSON</span><span>
</span><span id="line-723"></span><span class="hs-comment">-- String. This is necessary for 'x-www-url-formencoded' bodies. They</span><span>
</span><span id="line-724"></span><span class="hs-comment">-- are a list of key/value pairs encoded as a raw 'ByteString' with no</span><span>
</span><span id="line-725"></span><span class="hs-comment">-- quoting whereas JSON Strings must be quoted.</span><span>
</span><span id="line-726"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#formUrlEncodedToValue"><span class="hs-identifier hs-type">formUrlEncodedToValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-727"></span><span id="formUrlEncodedToValue"><span class="annot"><span class="annottext">formUrlEncodedToValue :: ByteString -&gt; Maybe Value
</span><a href="Hasura.RQL.DDL.Metadata.html#formUrlEncodedToValue"><span class="hs-identifier hs-var hs-var">formUrlEncodedToValue</span></a></span></span><span> </span><span id="local-6989586621689751072"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689751072"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe Value
forall a. FromJSON a =&gt; ByteString -&gt; Maybe a
</span><span class="hs-identifier hs-var">J.decode</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;\&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689751072"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;\&quot;&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-728"></span><span>
</span><span id="line-729"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#parseEnvTemplate"><span class="hs-identifier hs-type">parseEnvTemplate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AT.Parser</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span class="hs-special">]</span><span>
</span><span id="line-730"></span><span id="parseEnvTemplate"><span class="annot"><span class="annottext">parseEnvTemplate :: Parser [Either Text Text]
</span><a href="Hasura.RQL.DDL.Metadata.html#parseEnvTemplate"><span class="hs-identifier hs-var hs-var">parseEnvTemplate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Parser Text (Either Text Text) -&gt; Parser [Either Text Text]
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f [a]
</span><span class="hs-identifier hs-var">AT.many1</span></span><span> </span><span class="annot"><span class="annottext">(Parser Text (Either Text Text) -&gt; Parser [Either Text Text])
-&gt; Parser Text (Either Text Text) -&gt; Parser [Either Text Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Parser Text (Either Text Text)
forall b. Parser Text (Either Text b)
</span><a href="#local-6989586621689751070"><span class="hs-identifier hs-var">pEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Parser Text (Either Text Text)
-&gt; Parser Text (Either Text Text) -&gt; Parser Text (Either Text Text)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser Text (Either Text Text)
forall a. Parser Text (Either a Text)
</span><a href="#local-6989586621689751069"><span class="hs-identifier hs-var">pLit</span></a></span><span> </span><span class="annot"><span class="annottext">Parser Text (Either Text Text)
-&gt; Parser Text (Either Text Text) -&gt; Parser Text (Either Text Text)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Either Text Text)
-&gt; Parser Text Text -&gt; Parser Text (Either Text Text)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text Text
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Parser Text Text
</span><span class="hs-string">&quot;{&quot;</span></span><span>
</span><span id="line-731"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-732"></span><span>    </span><span id="local-6989586621689751070"><span class="annot"><span class="annottext">pEnv :: Parser Text (Either Text b)
</span><a href="#local-6989586621689751070"><span class="hs-identifier hs-var hs-var">pEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Either Text b)
-&gt; Parser Text Text -&gt; Parser Text (Either Text b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Either Text b
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Parser Text Text -&gt; Parser Text (Either Text b))
-&gt; Parser Text Text -&gt; Parser Text (Either Text b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Parser Text Text
</span><span class="hs-string">&quot;{{&quot;</span></span><span> </span><span class="annot"><span class="annottext">Parser Text Text -&gt; Parser Text Text -&gt; Parser Text Text
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; Parser Text Text
</span><span class="hs-identifier hs-var">AT.takeWhile1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'}'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Parser Text Text -&gt; Parser Text Text -&gt; Parser Text Text
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;*</span></span><span> </span><span class="annot"><span class="annottext">Parser Text Text
</span><span class="hs-string">&quot;}}&quot;</span></span><span>
</span><span id="line-733"></span><span>    </span><span id="local-6989586621689751069"><span class="annot"><span class="annottext">pLit :: Parser Text (Either a Text)
</span><a href="#local-6989586621689751069"><span class="hs-identifier hs-var hs-var">pLit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Either a Text)
-&gt; Parser Text Text -&gt; Parser Text (Either a Text)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either a Text
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Parser Text Text -&gt; Parser Text (Either a Text))
-&gt; Parser Text Text -&gt; Parser Text (Either a Text)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; Parser Text Text
</span><span class="hs-identifier hs-var">AT.takeWhile1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'{'</span></span><span class="hs-special">)</span><span>
</span><span id="line-734"></span><span>
</span><span id="line-735"></span><span id="local-6989586621689751688"><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#indistinct"><span class="hs-identifier hs-type">indistinct</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621689751688"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689751688"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689751688"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-736"></span><span id="indistinct"><span class="annot"><span class="annottext">indistinct :: Either a a -&gt; a
</span><a href="Hasura.RQL.DDL.Metadata.html#indistinct"><span class="hs-identifier hs-var hs-var">indistinct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; a) -&gt; (a -&gt; a) -&gt; Either a a -&gt; a
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-737"></span><span>
</span><span id="line-738"></span><span class="annot"><a href="Hasura.RQL.DDL.Metadata.html#packTransformResult"><span class="hs-identifier hs-type">packTransformResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Webhook.Transform.Class.html#TransformErrorBundle"><span class="hs-identifier hs-type">TransformErrorBundle</span></a></span><span> </span><span class="annot"><a href="Network.HTTP.Client.Transformable.html#Request"><span class="hs-identifier hs-type">HTTP.Request</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span><span>
</span><span id="line-739"></span><span id="packTransformResult"><span class="annot"><span class="annottext">packTransformResult :: Either TransformErrorBundle Request -&gt; EncJSON
</span><a href="Hasura.RQL.DDL.Metadata.html#packTransformResult"><span class="hs-identifier hs-var hs-var">packTransformResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-740"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621689751065"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751065"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-741"></span><span>    </span><span class="annot"><span class="annottext">Value -&gt; EncJSON
forall a. ToJSON a =&gt; a -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromJValue"><span class="hs-identifier hs-var">encJFromJValue</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; EncJSON) -&gt; Value -&gt; EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-742"></span><span>      </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-743"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;webhook_url&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751065"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Request -&gt; Getting Text Request Text -&gt; Text
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Text Request Text
Lens' Request Text
</span><a href="Network.HTTP.Client.Transformable.html#url"><span class="hs-identifier hs-var">HTTP.url</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-744"></span><span>          </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;method&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; ByteString -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751065"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Request -&gt; Getting ByteString Request ByteString -&gt; ByteString
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting ByteString Request ByteString
Lens' Request ByteString
</span><a href="Network.HTTP.Client.Transformable.html#method"><span class="hs-identifier hs-var">HTTP.method</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-745"></span><span>          </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;headers&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; [(ByteString, ByteString)] -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CI ByteString -&gt; ByteString) -&gt; Header -&gt; (ByteString, ByteString)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">CI ByteString -&gt; ByteString
forall s. CI s -&gt; s
</span><span class="hs-identifier hs-var hs-var">CI.foldedCase</span></span><span> </span><span class="annot"><span class="annottext">(Header -&gt; (ByteString, ByteString))
-&gt; [Header] -&gt; [(ByteString, ByteString)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751065"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Request -&gt; Getting [Header] Request [Header] -&gt; [Header]
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting [Header] Request [Header]
Lens' Request [Header]
</span><a href="Network.HTTP.Client.Transformable.html#headers"><span class="hs-identifier hs-var">HTTP.headers</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-746"></span><span>          </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;body&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Value
</span><a href="Hasura.RQL.DDL.Metadata.html#decodeBody"><span class="hs-identifier hs-var">decodeBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621689751065"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Request
-&gt; Getting (Maybe ByteString) Request (Maybe ByteString)
-&gt; Maybe ByteString
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting (Maybe ByteString) Request (Maybe ByteString)
Lens' Request (Maybe ByteString)
</span><a href="Network.HTTP.Client.Transformable.html#body"><span class="hs-identifier hs-var">HTTP.body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-747"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-748"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621689751061"><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621689751061"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Value -&gt; EncJSON
forall a. ToJSON a =&gt; a -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromJValue"><span class="hs-identifier hs-var">encJFromJValue</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; EncJSON) -&gt; Value -&gt; EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TransformErrorBundle -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621689751061"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-749"></span></pre></body></html>