<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -Wno-unrecognised-pragmas #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Control.Concurrent.Extended</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier">sleep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier">ForkableMonadIO</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Robust forking</span></span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkImmortal"><span class="hs-identifier">forkImmortal</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier">forkManagedT</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedTWithGracefulShutdown"><span class="hs-identifier">forkManagedTWithGracefulShutdown</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Concurrency in MonadError</span></span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#forConcurrentlyEIO"><span class="hs-identifier">forConcurrentlyEIO</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#concurrentlyEIO"><span class="hs-identifier">concurrentlyEIO</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Deprecated</span></span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#ImmortalThreadLog"><span class="hs-identifier">ImmortalThreadLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadState"><span class="hs-identifier">ThreadState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier">ThreadShutdown</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier">Forever</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">where</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">threadDelay</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Base</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async.Lifted.Safe</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LA</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Immortal</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Immortal</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Loops</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">iterateM_</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MC</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Monad.Trans.Managed.html"><span class="hs-identifier">Control.Monad.Trans.Managed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier">ManagedT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#allocate"><span class="hs-identifier">allocate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.Split</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Traversable</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Void</span></span><span>
</span><span id="line-40"></span><span class="hs-comment">-- For forkImmortal. We could also have it take a cumbersome continuation if we</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- want to break this dependency. Probably best to move Hasura.Logging into a</span><span>
</span><span id="line-42"></span><span class="hs-comment">-- separate lib with this if we do the override thing.</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-pragma">{-# HLINT ignore sleep #-}</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-comment">-- | Like 'Base.threadDelay', but takes a 'DiffTime' instead of an 'Int' microseconds.</span><span>
</span><span id="line-49"></span><span class="hs-comment">--</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- NOTE: you cannot simply replace e.g. @threadDelay 1000@ with @sleep 1000@ since those literals</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- have different meanings!</span><span>
</span><span id="line-52"></span><span class="annot"><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-type">sleep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DiffTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span id="sleep"><span class="annot"><span class="annottext">sleep :: DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var hs-var">sleep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><span class="hs-identifier hs-var">Base.threadDelay</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO ()) -&gt; (DiffTime -&gt; Int) -&gt; DiffTime -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Microseconds -&gt; Int
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">round</span></span><span> </span><span class="annot"><span class="annottext">(Microseconds -&gt; Int)
-&gt; (DiffTime -&gt; Microseconds) -&gt; DiffTime -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; Microseconds
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">Microseconds</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-comment">-- | Note: Please consider using 'forkManagedT' instead to ensure reliable</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- resource cleanup.</span><span>
</span><span id="line-57"></span><span id="local-6989586621689587449"><span class="annot"><a href="Control.Concurrent.Extended.html#forkImmortal"><span class="hs-identifier hs-type">forkImmortal</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-58"></span><span>  </span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689587449"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-comment">-- | A label describing this thread's function (see 'labelThread').</span><span>
</span><span id="line-60"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-comment">-- | An IO action we expect never to return normally. This will have the type</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-comment">-- signature ':: m a' (see e.g. the type of 'forever').</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><a href="#local-6989586621689587449"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-comment">-- | A handle for the forked thread. See &quot;Control.Immortal&quot;.</span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><a href="#local-6989586621689587449"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span></span><span>
</span><span id="line-67"></span><span id="forkImmortal"><span class="annot"><span class="annottext">forkImmortal :: String -&gt; Logger Hasura -&gt; m Void -&gt; m Thread
</span><a href="Control.Concurrent.Extended.html#forkImmortal"><span class="hs-identifier hs-var hs-var">forkImmortal</span></a></span></span><span> </span><span id="local-6989586621689587348"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587348"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621689587347"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689587347"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621689587346"><span class="annot"><span class="annottext">m Void
</span><a href="#local-6989586621689587346"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; (Thread -&gt; m ()) -&gt; m Thread
forall (m :: * -&gt; *).
MonadBaseControl IO m =&gt;
String -&gt; (Thread -&gt; m ()) -&gt; m Thread
</span><span class="hs-identifier hs-var">Immortal.createWithLabel</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587348"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">((Thread -&gt; m ()) -&gt; m Thread) -&gt; (Thread -&gt; m ()) -&gt; m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689587344"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689587344"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- Log that the thread has started</span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ImmortalThreadLog -&gt; IO ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689587347"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ImmortalThreadLog
</span><a href="Control.Concurrent.Extended.html#ImmortalThreadRestarted"><span class="hs-identifier hs-var">ImmortalThreadRestarted</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587348"><span class="hs-keyword hs-var">label</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">-- In this case, we are handling unexpected exceptions.</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-comment">-- i.e This does not catch the asynchronous exception which stops the thread.</span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="annottext">Thread -&gt; (Either SomeException () -&gt; m ()) -&gt; m () -&gt; m ()
forall (m :: * -&gt; *).
MonadBaseControl IO m =&gt;
Thread -&gt; (Either SomeException () -&gt; m ()) -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">Immortal.onUnexpectedFinish</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689587344"><span class="hs-identifier hs-var">this</span></a></span><span> </span><span class="annot"><span class="annottext">Either SomeException () -&gt; m ()
</span><a href="#local-6989586621689587339"><span class="hs-identifier hs-var">logAndPause</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m Void -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">m Void
</span><a href="#local-6989586621689587346"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621689587339"><span class="annot"><span class="annottext">logAndPause :: Either SomeException () -&gt; m ()
</span><a href="#local-6989586621689587339"><span class="hs-identifier hs-var hs-var">logAndPause</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-76"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621689587337"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621689587337"><span class="hs-identifier hs-var">_void</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- absurd _void (i.e. unreachable)</span><span>
</span><span id="line-77"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621689587336"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621689587336"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-78"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ImmortalThreadLog -&gt; IO ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689587347"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SomeException -&gt; ImmortalThreadLog
</span><a href="Control.Concurrent.Extended.html#ImmortalThreadUnexpectedException"><span class="hs-identifier hs-var">ImmortalThreadUnexpectedException</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587348"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621689587336"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>        </span><span class="hs-comment">-- pause before restarting some arbitrary amount of time. The idea is not to flood</span><span>
</span><span id="line-80"></span><span>        </span><span class="hs-comment">-- logs or cause other cascading failures.</span><span>
</span><span id="line-81"></span><span>        </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">sleep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Seconds -&gt; DiffTime
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var hs-var">seconds</span></a></span><span> </span><span class="annot"><span class="annottext">Seconds
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-keyword">data</span><span> </span><span id="ThreadState"><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadState"><span class="hs-identifier hs-var">ThreadState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ThreadForked"><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadForked"><span class="hs-identifier hs-var">ThreadForked</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="ThreadBlocking"><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadBlocking"><span class="hs-identifier hs-var">ThreadBlocking</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="ThreadShutdownInitiated"><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadShutdownInitiated"><span class="hs-identifier hs-var">ThreadShutdownInitiated</span></a></span></span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689587325"><span id="local-6989586621689587327"><span id="local-6989586621689587329"><span class="annot"><span class="annottext">Int -&gt; ThreadState -&gt; ShowS
[ThreadState] -&gt; ShowS
ThreadState -&gt; String
(Int -&gt; ThreadState -&gt; ShowS)
-&gt; (ThreadState -&gt; String)
-&gt; ([ThreadState] -&gt; ShowS)
-&gt; Show ThreadState
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ThreadState] -&gt; ShowS
$cshowList :: [ThreadState] -&gt; ShowS
show :: ThreadState -&gt; String
$cshow :: ThreadState -&gt; String
showsPrec :: Int -&gt; ThreadState -&gt; ShowS
$cshowsPrec :: Int -&gt; ThreadState -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689587320"><span id="local-6989586621689587322"><span class="annot"><span class="annottext">ThreadState -&gt; ThreadState -&gt; Bool
(ThreadState -&gt; ThreadState -&gt; Bool)
-&gt; (ThreadState -&gt; ThreadState -&gt; Bool) -&gt; Eq ThreadState
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ThreadState -&gt; ThreadState -&gt; Bool
$c/= :: ThreadState -&gt; ThreadState -&gt; Bool
== :: ThreadState -&gt; ThreadState -&gt; Bool
$c== :: ThreadState -&gt; ThreadState -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-comment">-- | @ThreadShutdown@ is a newtype wrapper over an action which is intended</span><span>
</span><span id="line-87"></span><span class="hs-comment">--   to execute when a thread's shutdown is initiated before killing the thread</span><span>
</span><span id="line-88"></span><span class="hs-keyword">newtype</span><span> </span><span id="ThreadShutdown"><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier hs-var">ThreadShutdown</span></a></span></span><span> </span><span id="local-6989586621689587318"><span class="annot"><a href="#local-6989586621689587318"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ThreadShutdown"><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier hs-var">ThreadShutdown</span></a></span></span><span> </span><span class="hs-special">{</span><span id="tsThreadShutdown"><span class="annot"><span class="annottext">ThreadShutdown m -&gt; m ()
</span><a href="Control.Concurrent.Extended.html#tsThreadShutdown"><span class="hs-identifier hs-var hs-var">tsThreadShutdown</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621689587318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">-- | This function pairs a call to 'forkImmortal' with a finalizer which stops</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- the immortal thread.</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">-- Note, the thread object can leave its scope if this function is incorrectly</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- used. Generally, the result should only be used later in the same ManagedT</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- scope.</span><span>
</span><span id="line-96"></span><span id="local-6989586621689587315"><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-type">forkManagedT</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689587315"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-98"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-100"></span><span>  </span><span class="annot"><a href="#local-6989586621689587315"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-101"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689587315"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span></span><span>
</span><span id="line-102"></span><span id="forkManagedT"><span class="annot"><span class="annottext">forkManagedT :: String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-var hs-var">forkManagedT</span></a></span></span><span> </span><span id="local-6989586621689587314"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587314"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621689587313"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689587313"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621689587312"><span class="annot"><span class="annottext">m Void
</span><a href="#local-6989586621689587312"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">m Thread -&gt; (Thread -&gt; m ()) -&gt; ManagedT m Thread
forall (m :: * -&gt; *) a b.
MonadBaseControl IO m =&gt;
m a -&gt; (a -&gt; m b) -&gt; ManagedT m a
</span><a href="Control.Monad.Trans.Managed.html#allocate"><span class="hs-identifier hs-var">allocate</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Logger Hasura -&gt; m Void -&gt; m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; m Thread
</span><a href="Control.Concurrent.Extended.html#forkImmortal"><span class="hs-identifier hs-var">forkImmortal</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587314"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689587313"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">m Void
</span><a href="#local-6989586621689587312"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689587311"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689587311"><span class="hs-identifier hs-var">thread</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>        </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ImmortalThreadLog -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689587313"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ImmortalThreadLog
</span><a href="Control.Concurrent.Extended.html#ImmortalThreadStopping"><span class="hs-identifier hs-var">ImmortalThreadStopping</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587314"><span class="hs-keyword hs-var">label</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Thread -&gt; IO ()
</span><span class="hs-identifier hs-var">Immortal.stop</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689587311"><span class="hs-identifier hs-var">thread</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="hs-comment">-- | The @Forever@ type defines an infinite looping monadic action (like @m void@), but allows the</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- caller to control the recursion or insert code before each iteration. The @a@ is the initial argument,</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- and subsequent iterations will be fed the argument returned by the previous one.  See</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- @forkManagedTWithGracefulShutdown@ to see how it's used</span><span>
</span><span id="line-114"></span><span class="hs-keyword">data</span><span> </span><span id="Forever"><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier hs-var">Forever</span></a></span></span><span> </span><span id="local-6989586621689587308"><span class="annot"><a href="#local-6989586621689587308"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621689587307"><span class="annot"><a href="#local-6989586621689587307"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span id="Forever"><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier hs-var">Forever</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621689587307"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621689587307"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689587308"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689587307"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-comment">-- | @forkManagedTWithGracefulShutdown@ is an extension of the @forkManagedT@</span><span>
</span><span id="line-117"></span><span class="hs-comment">--   function this function also attempts to gracefully shutdown the thread. This function</span><span>
</span><span id="line-118"></span><span class="hs-comment">--   accepts a `m (Forever m)` argument. The @Forever@ type contains a function and an argument</span><span>
</span><span id="line-119"></span><span class="hs-comment">--   to the function. The function supplied will be run repeatedly until shutdown is initiated. The</span><span>
</span><span id="line-120"></span><span class="hs-comment">--   response of the function will be the argument to the next iteration.</span><span>
</span><span id="line-121"></span><span class="hs-comment">--</span><span>
</span><span id="line-122"></span><span class="hs-comment">--   For reference, this function is used to run the async actions processor. Check</span><span>
</span><span id="line-123"></span><span class="hs-comment">--   `asyncActionsProcessor`</span><span>
</span><span id="line-124"></span><span id="local-6989586621689587305"><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedTWithGracefulShutdown"><span class="hs-identifier hs-type">forkManagedTWithGracefulShutdown</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689587305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-126"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-127"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-128"></span><span>  </span><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier hs-type">ThreadShutdown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689587305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><a href="#local-6989586621689587305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier hs-type">Forever</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689587305"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-130"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689587305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span></span><span>
</span><span id="line-131"></span><span id="forkManagedTWithGracefulShutdown"><span class="annot"><span class="annottext">forkManagedTWithGracefulShutdown :: String
-&gt; Logger Hasura
-&gt; ThreadShutdown m
-&gt; m (Forever m)
-&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedTWithGracefulShutdown"><span class="hs-identifier hs-var hs-var">forkManagedTWithGracefulShutdown</span></a></span></span><span> </span><span id="local-6989586621689587304"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587304"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621689587303"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689587303"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier hs-type">ThreadShutdown</span></a></span><span> </span><span id="local-6989586621689587302"><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621689587302"><span class="hs-identifier hs-var">threadShutdownHandler</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689587301"><span class="annot"><span class="annottext">m (Forever m)
</span><a href="#local-6989586621689587301"><span class="hs-identifier hs-var">loopIteration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-132"></span><span>  </span><span id="local-6989586621689587300"><span class="annot"><span class="annottext">TVar ThreadState
</span><a href="#local-6989586621689587300"><span class="hs-identifier hs-var">threadStateTVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TVar ThreadState) -&gt; ManagedT m (TVar ThreadState)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (TVar ThreadState) -&gt; ManagedT m (TVar ThreadState))
-&gt; IO (TVar ThreadState) -&gt; ManagedT m (TVar ThreadState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ThreadState -&gt; IO (TVar ThreadState)
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">ThreadState
</span><a href="Control.Concurrent.Extended.html#ThreadForked"><span class="hs-identifier hs-var">ThreadForked</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><span class="annottext">m Thread -&gt; (Thread -&gt; m ()) -&gt; ManagedT m Thread
forall (m :: * -&gt; *) a b.
MonadBaseControl IO m =&gt;
m a -&gt; (a -&gt; m b) -&gt; ManagedT m a
</span><a href="Control.Monad.Trans.Managed.html#allocate"><span class="hs-identifier hs-var">allocate</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String -&gt; (Thread -&gt; m ()) -&gt; m Thread
forall (m :: * -&gt; *).
MonadBaseControl IO m =&gt;
String -&gt; (Thread -&gt; m ()) -&gt; m Thread
</span><span class="hs-identifier hs-var">Immortal.createWithLabel</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587304"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">((Thread -&gt; m ()) -&gt; m Thread) -&gt; (Thread -&gt; m ()) -&gt; m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689587298"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689587298"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-comment">-- Log that the thread has started</span><span>
</span><span id="line-136"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ImmortalThreadLog -&gt; IO ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689587303"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ImmortalThreadLog
</span><a href="Control.Concurrent.Extended.html#ImmortalThreadRestarted"><span class="hs-identifier hs-var">ImmortalThreadRestarted</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587304"><span class="hs-keyword hs-var">label</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>        </span><span class="hs-comment">-- In this case, we are handling unexpected exceptions.</span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-comment">-- i.e This does not catch the asynchronous exception which stops the thread.</span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><span class="annottext">Thread -&gt; (Either SomeException () -&gt; m ()) -&gt; m () -&gt; m ()
forall (m :: * -&gt; *).
MonadBaseControl IO m =&gt;
Thread -&gt; (Either SomeException () -&gt; m ()) -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">Immortal.onUnexpectedFinish</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689587298"><span class="hs-identifier hs-var">this</span></a></span><span> </span><span class="annot"><span class="annottext">Either SomeException () -&gt; m ()
</span><a href="#local-6989586621689587297"><span class="hs-identifier hs-var">logAndPause</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-140"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689587296"><span class="annot"><span class="annottext">mLoop :: Forever m -&gt; m Any
</span><a href="#local-6989586621689587296"><span class="hs-identifier hs-var hs-var">mLoop</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier hs-type">Forever</span></a></span><span> </span><span id="local-6989586621689587295"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689587295"><span class="hs-identifier hs-var">loopFunctionInitArg</span></a></span></span><span> </span><span id="local-6989586621689587294"><span class="annot"><span class="annottext">a -&gt; m a
</span><a href="#local-6989586621689587294"><span class="hs-identifier hs-var">loopFunction</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-142"></span><span>                    </span><span class="annot"><span class="annottext">((a -&gt; m a) -&gt; a -&gt; m Any) -&gt; a -&gt; (a -&gt; m a) -&gt; m Any
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; m a) -&gt; a -&gt; m Any
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m a) -&gt; a -&gt; m b
</span><span class="hs-identifier hs-var">iterateM_</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689587295"><span class="hs-identifier hs-var">loopFunctionInitArg</span></a></span><span> </span><span class="annot"><span class="annottext">((a -&gt; m a) -&gt; m Any) -&gt; (a -&gt; m a) -&gt; m Any
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689587292"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689587292"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-143"></span><span>                      </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-144"></span><span>                        </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-145"></span><span>                          </span><span class="annot"><span class="annottext">TVar ThreadState -&gt; STM ThreadState
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">STM.readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ThreadState
</span><a href="#local-6989586621689587300"><span class="hs-identifier hs-var">threadStateTVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM ThreadState -&gt; (ThreadState -&gt; STM ()) -&gt; STM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-146"></span><span>                            </span><span class="annot"><span class="annottext">ThreadState
</span><a href="Control.Concurrent.Extended.html#ThreadShutdownInitiated"><span class="hs-identifier hs-var">ThreadShutdownInitiated</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>                              </span><span class="hs-comment">-- signal to the finalizer that we are now blocking</span><span>
</span><span id="line-148"></span><span>                              </span><span class="hs-comment">-- and blocking forever since this</span><span>
</span><span id="line-149"></span><span>                              </span><span class="hs-comment">-- var moves monotonically from forked -&gt; shutdown -&gt; blocking</span><span>
</span><span id="line-150"></span><span>                              </span><span class="annot"><span class="annottext">TVar ThreadState -&gt; ThreadState -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ThreadState
</span><a href="#local-6989586621689587300"><span class="hs-identifier hs-var">threadStateTVar</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadState
</span><a href="Control.Concurrent.Extended.html#ThreadBlocking"><span class="hs-identifier hs-var">ThreadBlocking</span></a></span><span>
</span><span id="line-151"></span><span>                            </span><span class="annot"><span class="annottext">ThreadState
</span><a href="Control.Concurrent.Extended.html#ThreadBlocking"><span class="hs-identifier hs-var">ThreadBlocking</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM ()
forall a. STM a
</span><span class="hs-identifier hs-var">STM.retry</span></span><span>
</span><span id="line-152"></span><span>                            </span><span class="annot"><span class="annottext">ThreadState
</span><a href="Control.Concurrent.Extended.html#ThreadForked"><span class="hs-identifier hs-var">ThreadForked</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>                      </span><span class="annot"><span class="annottext">a -&gt; m a
</span><a href="#local-6989586621689587294"><span class="hs-identifier hs-var">loopFunction</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689587292"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-154"></span><span>              </span><span id="local-6989586621689587287"><span class="annot"><span class="annottext">Async Any
</span><a href="#local-6989586621689587287"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Any -&gt; m (Async Any)
forall (m :: * -&gt; *) a.
(MonadBaseControl IO m, Forall (Pure m)) =&gt;
m a -&gt; m (Async a)
</span><span class="hs-identifier hs-var">LA.async</span></span><span> </span><span class="annot"><span class="annottext">(m Any -&gt; m (Async Any)) -&gt; m Any -&gt; m (Async Any)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Forever m -&gt; m Any
</span><a href="#local-6989586621689587296"><span class="hs-identifier hs-var">mLoop</span></a></span><span> </span><span class="annot"><span class="annottext">(Forever m -&gt; m Any) -&gt; m (Forever m) -&gt; m Any
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">m (Forever m)
</span><a href="#local-6989586621689587301"><span class="hs-identifier hs-var">loopIteration</span></a></span><span>
</span><span id="line-155"></span><span>              </span><span class="annot"><span class="annottext">Async Any -&gt; m ()
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; Async a -&gt; m ()
</span><span class="hs-identifier hs-var">LA.link</span></span><span> </span><span class="annot"><span class="annottext">Async Any
</span><a href="#local-6989586621689587287"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-156"></span><span>              </span><span class="annot"><span class="annottext">m Any -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Any -&gt; m ()) -&gt; m Any -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Async Any -&gt; m Any
forall (m :: * -&gt; *) a.
(MonadBase IO m, Forall (Pure m)) =&gt;
Async a -&gt; m a
</span><span class="hs-identifier hs-var">LA.wait</span></span><span> </span><span class="annot"><span class="annottext">Async Any
</span><a href="#local-6989586621689587287"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-157"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689587282"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689587282"><span class="hs-identifier hs-var">thread</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-161"></span><span>          </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-162"></span><span>            </span><span class="annot"><span class="annottext">TVar ThreadState -&gt; (ThreadState -&gt; ThreadState) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar ThreadState
</span><a href="#local-6989586621689587300"><span class="hs-identifier hs-var">threadStateTVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadState -&gt; ThreadState -&gt; ThreadState
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">ThreadState
</span><a href="Control.Concurrent.Extended.html#ThreadShutdownInitiated"><span class="hs-identifier hs-var">ThreadShutdownInitiated</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-comment">-- the threadShutdownHandler here will wait for any in-flight events</span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-comment">-- to finish processing</span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-comment">{-
            There is a conundrum here about whether the @threadShutdownHandler@
            should be before or after the @ThreadBlocking@ check call, this is because
            there are problems with both the cases:

            1. @threadShutdownHandler@ before the @ThreadBlocking@ check
            ------------------------------------------------------------

            Let's say we're just about to start processing a new iteration of the
            loop function and before the processing actually starts the shutdown is
            initiated, there will be no in-flight events (because the batch hasn't started processing yet) so
            @threadShutdownHandler@ will return immediately and the new batch will start processing
            which were fetched earlier. This is a race condition and may kill the thread with some
            of the events still processing.

            2. @threadShutdownHandler@ after the @ThreadBlocking@ check
            -----------------------------------------------------------

            This will solve the above race condition but will cause a new problem. The
            graphql-engine accepts a config called `--graceful-shutdown-timeout` which is a timeout
            for any in-flight processing events that are running in the graphql-engine to complete
            processing within this time.

            Let's say we are going to start iterating over the next iteration of `processEventQueue`
            and without loss of generality let's say this batch takes 100 seconds to finish processing
            and the graceful shutdown timeout is 10 seconds and shutdown is initiated in the midst of processing
            this batch, this will have no effect and the thread will be shutdown after the batch completes (after
            100 seconds) which is wrong because it doesn't respect the graceful shutdown timeout

            TODO: figure out a way which solves both the problems

            At the time of writing this PR, we decided to go with 1 because the worst thing
            that will happen is that some events might get processed more than once but this
            is a better solution than what we had earlier where we were shutting down all the in-flight
            processing events without the graceful shutdown timeout.
        -}</span><span>
</span><span id="line-201"></span><span>        </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621689587302"><span class="hs-identifier hs-var">threadShutdownHandler</span></a></span><span>
</span><span id="line-202"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-203"></span><span>          </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>            </span><span class="annot"><span class="annottext">TVar ThreadState -&gt; STM ThreadState
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">STM.readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ThreadState
</span><a href="#local-6989586621689587300"><span class="hs-identifier hs-var">threadStateTVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM ThreadState -&gt; (ThreadState -&gt; STM ()) -&gt; STM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.check</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM ()) -&gt; (ThreadState -&gt; Bool) -&gt; ThreadState -&gt; STM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadState -&gt; ThreadState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ThreadState
</span><a href="Control.Concurrent.Extended.html#ThreadBlocking"><span class="hs-identifier hs-var">ThreadBlocking</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>        </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ImmortalThreadLog -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689587303"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ImmortalThreadLog
</span><a href="Control.Concurrent.Extended.html#ImmortalThreadStopping"><span class="hs-identifier hs-var">ImmortalThreadStopping</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587304"><span class="hs-keyword hs-var">label</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Thread -&gt; IO ()
</span><span class="hs-identifier hs-var">Immortal.stop</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689587282"><span class="hs-identifier hs-var">thread</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621689587297"><span class="annot"><span class="annottext">logAndPause :: Either SomeException () -&gt; m ()
</span><a href="#local-6989586621689587297"><span class="hs-identifier hs-var hs-var">logAndPause</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-210"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621689587278"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621689587278"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ImmortalThreadLog -&gt; IO ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689587303"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SomeException -&gt; ImmortalThreadLog
</span><a href="Control.Concurrent.Extended.html#ImmortalThreadUnexpectedException"><span class="hs-identifier hs-var">ImmortalThreadUnexpectedException</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587304"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621689587278"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>        </span><span class="hs-comment">-- pause before restarting some arbitrary amount of time. The idea is not to flood</span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-comment">-- logs or cause other cascading failures.</span><span>
</span><span id="line-215"></span><span>        </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">sleep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Seconds -&gt; DiffTime
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var hs-var">seconds</span></a></span><span> </span><span class="annot"><span class="annottext">Seconds
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-keyword">data</span><span> </span><span id="ImmortalThreadLog"><span class="annot"><a href="Control.Concurrent.Extended.html#ImmortalThreadLog"><span class="hs-identifier hs-var">ImmortalThreadLog</span></a></span></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- | Synchronous Exception</span><span>
</span><span id="line-219"></span><span>    </span><span id="ImmortalThreadUnexpectedException"><span class="annot"><a href="Control.Concurrent.Extended.html#ImmortalThreadUnexpectedException"><span class="hs-identifier hs-var">ImmortalThreadUnexpectedException</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | Asynchronous Exception about to be sent</span><span>
</span><span id="line-221"></span><span>    </span><span id="ImmortalThreadStopping"><span class="annot"><a href="Control.Concurrent.Extended.html#ImmortalThreadStopping"><span class="hs-identifier hs-var">ImmortalThreadStopping</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ImmortalThreadRestarted"><span class="annot"><a href="Control.Concurrent.Extended.html#ImmortalThreadRestarted"><span class="hs-identifier hs-var">ImmortalThreadRestarted</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Logging.html#ToEngineLog"><span class="hs-identifier hs-type">ToEngineLog</span></a></span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#ImmortalThreadLog"><span class="hs-identifier hs-type">ImmortalThreadLog</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-225"></span><span>  </span><span id="local-6989586621689587274"><span class="annot"><span class="annottext">toEngineLog :: ImmortalThreadLog -&gt; (LogLevel, EngineLogType Hasura, Value)
</span><a href="Hasura.Logging.html#toEngineLog"><span class="hs-identifier hs-var hs-var hs-var hs-var">toEngineLog</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ImmortalThreadStopping"><span class="hs-identifier hs-type">ImmortalThreadStopping</span></a></span><span> </span><span id="local-6989586621689587272"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587272"><span class="hs-keyword hs-var">label</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InternalLogTypes -&gt; EngineLogType Hasura
</span><a href="Hasura.Logging.html#ELTInternal"><span class="hs-identifier hs-var">ELTInternal</span></a></span><span> </span><span class="annot"><span class="annottext">InternalLogTypes
</span><a href="Hasura.Logging.html#ILTUnstructured"><span class="hs-identifier hs-var">ILTUnstructured</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587267"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-228"></span><span>      </span><span id="local-6989586621689587267"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621689587267"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Stopping immortal &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587272"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; thread&quot;</span></span><span>
</span><span id="line-229"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#toEngineLog"><span class="hs-identifier hs-var">toEngineLog</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ImmortalThreadUnexpectedException"><span class="hs-identifier hs-type">ImmortalThreadUnexpectedException</span></a></span><span> </span><span id="local-6989586621689587266"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587266"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621689587265"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621689587265"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">LevelError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InternalLogTypes -&gt; EngineLogType Hasura
</span><a href="Hasura.Logging.html#ELTInternal"><span class="hs-identifier hs-var">ELTInternal</span></a></span><span> </span><span class="annot"><span class="annottext">InternalLogTypes
</span><a href="Hasura.Logging.html#ILTUnstructured"><span class="hs-identifier hs-var">ILTUnstructured</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587263"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-232"></span><span>      </span><span id="local-6989586621689587263"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621689587263"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-233"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unexpected exception in immortal thread &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587266"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; (it will be restarted):\n&quot;</span></span><span>
</span><span id="line-234"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621689587265"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#toEngineLog"><span class="hs-identifier hs-var">toEngineLog</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ImmortalThreadRestarted"><span class="hs-identifier hs-type">ImmortalThreadRestarted</span></a></span><span> </span><span id="local-6989586621689587261"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587261"><span class="hs-keyword hs-var">label</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InternalLogTypes -&gt; EngineLogType Hasura
</span><a href="Hasura.Logging.html#ELTInternal"><span class="hs-identifier hs-var">ELTInternal</span></a></span><span> </span><span class="annot"><span class="annottext">InternalLogTypes
</span><a href="Hasura.Logging.html#ILTUnstructured"><span class="hs-identifier hs-var">ILTUnstructured</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587260"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-238"></span><span>      </span><span id="local-6989586621689587260"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621689587260"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Thread &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689587261"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; (re)started&quot;</span></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span class="hs-comment">-- TODO</span><span>
</span><span id="line-241"></span><span class="hs-comment">--   - maybe use this everywhere, but also:</span><span>
</span><span id="line-242"></span><span class="hs-comment">--     - consider unifying with: src-lib/Control/Monad/Stateless.hs  ?</span><span>
</span><span id="line-243"></span><span class="hs-comment">--   - nice TypeError:  https://kodimensional.dev/type-errors</span><span>
</span><span id="line-244"></span><span class="hs-comment">--</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span class="hs-comment">-- | Like 'MonadIO' but constrained to stacks in which forking a new thread is reasonable/safe.</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- In particular 'StateT' causes problems.</span><span>
</span><span id="line-248"></span><span class="hs-comment">--</span><span>
</span><span id="line-249"></span><span class="hs-comment">-- This is the constraint you can use for functions that call 'LA.async', or 'immortal'.</span><span>
</span><span id="line-250"></span><span class="hs-keyword">type</span><span> </span><span id="ForkableMonadIO"><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-var">ForkableMonadIO</span></a></span></span><span> </span><span id="local-6989586621689587259"><span class="annot"><a href="#local-6989586621689587259"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689587259"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689587259"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LA.Forall</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LA.Pure</span></span><span> </span><span class="annot"><a href="#local-6989586621689587259"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-comment">-- TODO consider deprecating async.</span><span>
</span><span id="line-253"></span><span class="hs-comment">--        export something with polymorphic return type, which makes &quot;fork and forget&quot; difficult</span><span>
</span><span id="line-254"></span><span class="hs-comment">--        this could automatically link in one variant</span><span>
</span><span id="line-255"></span><span class="hs-comment">--        another variant might return ThreadId that self destructs w/ finalizer (mkWeakThreadId)</span><span>
</span><span id="line-256"></span><span class="hs-comment">--          and note: &quot;Holding a normal ThreadId reference will prevent the delivery of BlockedIndefinitely exceptions because the reference could be used as the target of throwTo at any time,  &quot;</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="hs-comment">-- | A somewhat wonky function for parallelizing @for xs f@ where @f@ is</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- @(MonadIO m, MonadError e m)@. This is equivalent to @for xs f@ modulo the</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- IO effects (i.e. when the IO has no real side effects we care about).</span><span>
</span><span id="line-261"></span><span class="hs-comment">--</span><span>
</span><span id="line-262"></span><span class="hs-comment">-- This also takes a @chunkSize@ argument so you can manipulate the amount of</span><span>
</span><span id="line-263"></span><span class="hs-comment">-- work given to each thread.</span><span>
</span><span id="line-264"></span><span id="local-6989586621689587255"><span id="local-6989586621689587256"><span id="local-6989586621689587257"><span id="local-6989586621689587258"><span class="annot"><a href="Control.Concurrent.Extended.html#forConcurrentlyEIO"><span class="hs-identifier hs-type">forConcurrentlyEIO</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689587258"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="#local-6989586621689587257"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689587258"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621689587256"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621689587256"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="#local-6989586621689587257"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689587255"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689587258"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621689587255"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span></span></span></span></span><span>
</span><span id="line-265"></span><span id="forConcurrentlyEIO"><span class="annot"><span class="annottext">forConcurrentlyEIO :: Int -&gt; [a] -&gt; (a -&gt; ExceptT e IO b) -&gt; m [b]
</span><a href="Control.Concurrent.Extended.html#forConcurrentlyEIO"><span class="hs-identifier hs-var hs-var">forConcurrentlyEIO</span></a></span></span><span> </span><span id="local-6989586621689587254"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689587254"><span class="hs-identifier hs-var">chunkSize</span></a></span></span><span> </span><span id="local-6989586621689587253"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621689587253"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621689587252"><span class="annot"><span class="annottext">a -&gt; ExceptT e IO b
</span><a href="#local-6989586621689587252"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689587251"><span class="annot"><span class="annottext">fIO :: a -&gt; IO (Either e b)
</span><a href="#local-6989586621689587251"><span class="hs-identifier hs-var hs-var">fIO</span></a></span></span><span> </span><span id="local-6989586621689587250"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689587250"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT e IO b -&gt; IO (Either e b)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; ExceptT e IO b
</span><a href="#local-6989586621689587252"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689587250"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO (Either e b)
-&gt; (Either e b -&gt; IO (Either e b)) -&gt; IO (Either e b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Either e b -&gt; IO (Either e b)
forall a. a -&gt; IO a
</span><span class="hs-identifier hs-var">evaluate</span></span><span>
</span><span id="line-267"></span><span>  </span><span id="local-6989586621689587247"><span class="annot"><span class="annottext">[Either e b]
</span><a href="#local-6989586621689587247"><span class="hs-identifier hs-var">xs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [Either e b] -&gt; m [Either e b]
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO [Either e b] -&gt; m [Either e b])
-&gt; IO [Either e b] -&gt; m [Either e b]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([[Either e b]] -&gt; [Either e b])
-&gt; IO [[Either e b]] -&gt; IO [Either e b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[[Either e b]] -&gt; [Either e b]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">(IO [[Either e b]] -&gt; IO [Either e b])
-&gt; IO [[Either e b]] -&gt; IO [Either e b]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[a]] -&gt; ([a] -&gt; IO [Either e b]) -&gt; IO [[Either e b]]
forall (t :: * -&gt; *) a b.
Traversable t =&gt;
t a -&gt; (a -&gt; IO b) -&gt; IO (t b)
</span><span class="hs-identifier hs-var">A.forConcurrently</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [[a]]
forall e. Int -&gt; [e] -&gt; [[e]]
</span><span class="hs-identifier hs-var">chunksOf</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689587254"><span class="hs-identifier hs-var">chunkSize</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621689587253"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([a] -&gt; IO [Either e b]) -&gt; IO [[Either e b]])
-&gt; ([a] -&gt; IO [Either e b]) -&gt; IO [[Either e b]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; IO (Either e b)) -&gt; [a] -&gt; IO [Either e b]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; IO (Either e b)
</span><a href="#local-6989586621689587251"><span class="hs-identifier hs-var">fIO</span></a></span><span>
</span><span id="line-268"></span><span>  </span><span class="annot"><span class="annottext">[Either e b] -&gt; (Either e b -&gt; m b) -&gt; m [b]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">[Either e b]
</span><a href="#local-6989586621689587247"><span class="hs-identifier hs-var">xs'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(e -&gt; m b) -&gt; (b -&gt; m b) -&gt; Either e b -&gt; m b
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">e -&gt; m b
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span id="local-6989586621689587236"><span id="local-6989586621689587237"><span id="local-6989586621689587238"><span id="local-6989586621689587239"><span class="annot"><a href="Control.Concurrent.Extended.html#concurrentlyEIO"><span class="hs-identifier hs-type">concurrentlyEIO</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689587239"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="#local-6989586621689587238"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689587239"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="#local-6989586621689587238"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689587237"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="#local-6989586621689587238"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689587236"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689587239"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621689587237"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621689587236"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-271"></span><span id="concurrentlyEIO"><span class="annot"><span class="annottext">concurrentlyEIO :: ExceptT e IO a -&gt; ExceptT e IO b -&gt; m (a, b)
</span><a href="Control.Concurrent.Extended.html#concurrentlyEIO"><span class="hs-identifier hs-var hs-var">concurrentlyEIO</span></a></span></span><span> </span><span id="local-6989586621689587235"><span class="annot"><span class="annottext">ExceptT e IO a
</span><a href="#local-6989586621689587235"><span class="hs-identifier hs-var">left</span></a></span></span><span> </span><span id="local-6989586621689587234"><span class="annot"><span class="annottext">ExceptT e IO b
</span><a href="#local-6989586621689587234"><span class="hs-identifier hs-var">right</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621689587233"><span class="annot"><span class="annottext">Either e a
</span><a href="#local-6989586621689587233"><span class="hs-identifier hs-var">leftE</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689587232"><span class="annot"><span class="annottext">Either e b
</span><a href="#local-6989586621689587232"><span class="hs-identifier hs-var">rightE</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either e a, Either e b) -&gt; m (Either e a, Either e b)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either e a, Either e b) -&gt; m (Either e a, Either e b))
-&gt; IO (Either e a, Either e b) -&gt; m (Either e a, Either e b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either e a) -&gt; IO (Either e b) -&gt; IO (Either e a, Either e b)
forall a b. IO a -&gt; IO b -&gt; IO (a, b)
</span><span class="hs-identifier hs-var">A.concurrently</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT e IO a -&gt; IO (Either e a)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">ExceptT e IO a
</span><a href="#local-6989586621689587235"><span class="hs-identifier hs-var">left</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either e a)
-&gt; (Either e a -&gt; IO (Either e a)) -&gt; IO (Either e a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Either e a -&gt; IO (Either e a)
forall a. a -&gt; IO a
</span><span class="hs-identifier hs-var">evaluate</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT e IO b -&gt; IO (Either e b)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">ExceptT e IO b
</span><a href="#local-6989586621689587234"><span class="hs-identifier hs-var">right</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either e b)
-&gt; (Either e b -&gt; IO (Either e b)) -&gt; IO (Either e b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Either e b -&gt; IO (Either e b)
forall a. a -&gt; IO a
</span><span class="hs-identifier hs-var">evaluate</span></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>  </span><span id="local-6989586621689587230"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689587230"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either e a
</span><a href="#local-6989586621689587233"><span class="hs-identifier hs-var">leftE</span></a></span><span> </span><span class="annot"><span class="annottext">Either e a -&gt; (e -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-operator hs-var">`onLeft`</span></a></span><span> </span><span class="annot"><span class="annottext">e -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-274"></span><span>  </span><span id="local-6989586621689587228"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621689587228"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either e b
</span><a href="#local-6989586621689587232"><span class="hs-identifier hs-var">rightE</span></a></span><span> </span><span class="annot"><span class="annottext">Either e b -&gt; (e -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-8.10.7/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-operator hs-var">`onLeft`</span></a></span><span> </span><span class="annot"><span class="annottext">e -&gt; m b
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-275"></span><span>  </span><span class="annot"><span class="annottext">(a, b) -&gt; m (a, b)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689587230"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621689587228"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span></pre></body></html>