<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Multiplexed subscription poller threads; see &quot;Hasura.GraphQL.Execute.Subscription&quot; for details.</span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.Common</span><span>
</span><span id="line-3"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Pollers</span></span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Poller"><span class="hs-identifier">Poller</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerId"><span class="hs-identifier">PollerId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerIOState"><span class="hs-identifier">PollerIOState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerKey"><span class="hs-identifier">PollerKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerMap"><span class="hs-identifier">PollerMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#dumpPollerMap"><span class="hs-identifier">dumpPollerMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetails"><span class="hs-identifier">PollDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchExecutionDetails"><span class="hs-identifier">BatchExecutionDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortExecutionDetails"><span class="hs-identifier">CohortExecutionDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier">SubscriptionPostPollHook</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#defaultSubscriptionPostPollHook"><span class="hs-identifier">defaultSubscriptionPostPollHook</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Cohorts</span></span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier">Cohort</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier">CohortSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier">CursorVariableValues</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CohortId"><span class="hs-identifier">CohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#newCohortId"><span class="hs-identifier">newCohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CohortVariables"><span class="hs-identifier">CohortVariables</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortKey"><span class="hs-identifier">CohortKey</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortMap"><span class="hs-identifier">CohortMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Subscribers</span></span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier">Subscriber</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberId"><span class="hs-identifier">SubscriberId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#newSubscriberId"><span class="hs-identifier">newSubscriberId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMetadata"><span class="hs-identifier">SubscriberMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#mkSubscriberMetadata"><span class="hs-identifier">mkSubscriberMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#unSubscriberMetadata"><span class="hs-identifier">unSubscriberMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMap"><span class="hs-identifier">SubscriberMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#OnChange"><span class="hs-identifier">OnChange</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionGQResponse"><span class="hs-identifier">SubscriptionGQResponse</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionResponse"><span class="hs-identifier">SubscriptionResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier">SubscriptionMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier">SubscriberExecutionDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Batch</span></span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchId"><span class="hs-identifier">BatchId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Hash</span></span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier">ResponseHash</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#mkRespHash"><span class="hs-identifier">mkRespHash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">where</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Immortal</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Immortal</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Crypto.Hash</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CH</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Clock</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.UUID</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UUID</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.UUID.V4</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UUID</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Options</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Plan</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.TMap.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.TMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TMap</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html"><span class="hs-identifier">Hasura.GraphQL.ParameterizedQueryHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier">ParameterizedQueryHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP.Protocol</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier">OperationId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Server</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WS</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier">SourceName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier">RequestId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">ListT</span></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">StmContainers.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STMMap</span></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">-- ----------------------------------------------------------------------------------------------</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- Subscribers</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span id="local-6989586621689696093"><span id="local-6989586621689696094"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="SubscriberId"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberId"><span class="hs-identifier hs-var">SubscriberId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SubscriberId"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberId"><span class="hs-identifier hs-var">SubscriberId</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unSubscriberId"><span class="annot"><span class="annottext">SubscriberId -&gt; UUID
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#unSubscriberId"><span class="hs-identifier hs-var hs-var">unSubscriberId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UUID.UUID</span></span><span class="hs-special">}</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689696085"><span id="local-6989586621689696087"><span id="local-6989586621689696089"><span class="annot"><span class="annottext">Int -&gt; SubscriberId -&gt; ShowS
[SubscriberId] -&gt; ShowS
SubscriberId -&gt; String
(Int -&gt; SubscriberId -&gt; ShowS)
-&gt; (SubscriberId -&gt; String)
-&gt; ([SubscriberId] -&gt; ShowS)
-&gt; Show SubscriberId
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SubscriberId] -&gt; ShowS
$cshowList :: [SubscriberId] -&gt; ShowS
show :: SubscriberId -&gt; String
$cshow :: SubscriberId -&gt; String
showsPrec :: Int -&gt; SubscriberId -&gt; ShowS
$cshowsPrec :: Int -&gt; SubscriberId -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689696080"><span id="local-6989586621689696082"><span class="annot"><span class="annottext">SubscriberId -&gt; SubscriberId -&gt; Bool
(SubscriberId -&gt; SubscriberId -&gt; Bool)
-&gt; (SubscriberId -&gt; SubscriberId -&gt; Bool) -&gt; Eq SubscriberId
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SubscriberId -&gt; SubscriberId -&gt; Bool
$c/= :: SubscriberId -&gt; SubscriberId -&gt; Bool
== :: SubscriberId -&gt; SubscriberId -&gt; Bool
$c== :: SubscriberId -&gt; SubscriberId -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. SubscriberId -&gt; Rep SubscriberId x)
-&gt; (forall x. Rep SubscriberId x -&gt; SubscriberId)
-&gt; Generic SubscriberId
forall x. Rep SubscriberId x -&gt; SubscriberId
forall x. SubscriberId -&gt; Rep SubscriberId x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep SubscriberId x -&gt; SubscriberId
$cfrom :: forall x. SubscriberId -&gt; Rep SubscriberId x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689696072"><span id="local-6989586621689696074"><span class="annot"><span class="annottext">Int -&gt; SubscriberId -&gt; Int
SubscriberId -&gt; Int
(Int -&gt; SubscriberId -&gt; Int)
-&gt; (SubscriberId -&gt; Int) -&gt; Hashable SubscriberId
forall a. (Int -&gt; a -&gt; Int) -&gt; (a -&gt; Int) -&gt; Hashable a
hash :: SubscriberId -&gt; Int
$chash :: SubscriberId -&gt; Int
hashWithSalt :: Int -&gt; SubscriberId -&gt; Int
$chashWithSalt :: Int -&gt; SubscriberId -&gt; Int
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Hashable</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689696063"><span id="local-6989586621689696065"><span id="local-6989586621689696067"><span id="local-6989586621689696069"><span class="annot"><span class="annottext">[SubscriberId] -&gt; Value
[SubscriberId] -&gt; Encoding
SubscriberId -&gt; Value
SubscriberId -&gt; Encoding
(SubscriberId -&gt; Value)
-&gt; (SubscriberId -&gt; Encoding)
-&gt; ([SubscriberId] -&gt; Value)
-&gt; ([SubscriberId] -&gt; Encoding)
-&gt; ToJSON SubscriberId
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [SubscriberId] -&gt; Encoding
$ctoEncodingList :: [SubscriberId] -&gt; Encoding
toJSONList :: [SubscriberId] -&gt; Value
$ctoJSONList :: [SubscriberId] -&gt; Value
toEncoding :: SubscriberId -&gt; Encoding
$ctoEncoding :: SubscriberId -&gt; Encoding
toJSON :: SubscriberId -&gt; Value
$ctoJSON :: SubscriberId -&gt; Value
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">J.ToJSON</span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#newSubscriberId"><span class="hs-identifier hs-type">newSubscriberId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberId"><span class="hs-identifier hs-type">SubscriberId</span></a></span><span>
</span><span id="line-79"></span><span id="newSubscriberId"><span class="annot"><span class="annottext">newSubscriberId :: IO SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#newSubscriberId"><span class="hs-identifier hs-var hs-var">newSubscriberId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><span class="annottext">UUID -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberId"><span class="hs-identifier hs-var">SubscriberId</span></a></span><span> </span><span class="annot"><span class="annottext">(UUID -&gt; SubscriberId) -&gt; IO UUID -&gt; IO SubscriberId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO UUID
</span><span class="hs-identifier hs-var">UUID.nextRandom</span></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- | Allows a user of the live query subsystem (currently websocket transport)</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- to attach arbitrary metadata about a subscriber. This information is available</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- as part of Subscriber in CohortExecutionDetails and can be logged by customizing</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- in pollerlog</span><span>
</span><span id="line-86"></span><span class="hs-keyword">newtype</span><span> </span><span id="SubscriberMetadata"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMetadata"><span class="hs-identifier hs-var">SubscriberMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SubscriberMetadata"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMetadata"><span class="hs-identifier hs-var">SubscriberMetadata</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unSubscriberMetadata"><span class="annot"><span class="annottext">SubscriberMetadata -&gt; Value
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#unSubscriberMetadata"><span class="hs-identifier hs-var hs-var">unSubscriberMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span class="hs-special">}</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689696053"><span id="local-6989586621689696055"><span id="local-6989586621689696057"><span class="annot"><span class="annottext">Int -&gt; SubscriberMetadata -&gt; ShowS
[SubscriberMetadata] -&gt; ShowS
SubscriberMetadata -&gt; String
(Int -&gt; SubscriberMetadata -&gt; ShowS)
-&gt; (SubscriberMetadata -&gt; String)
-&gt; ([SubscriberMetadata] -&gt; ShowS)
-&gt; Show SubscriberMetadata
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SubscriberMetadata] -&gt; ShowS
$cshowList :: [SubscriberMetadata] -&gt; ShowS
show :: SubscriberMetadata -&gt; String
$cshow :: SubscriberMetadata -&gt; String
showsPrec :: Int -&gt; SubscriberMetadata -&gt; ShowS
$cshowsPrec :: Int -&gt; SubscriberMetadata -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689696049"><span id="local-6989586621689696051"><span class="annot"><span class="annottext">SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool
(SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool)
-&gt; (SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool)
-&gt; Eq SubscriberMetadata
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool
$c/= :: SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool
== :: SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool
$c== :: SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689696041"><span id="local-6989586621689696043"><span id="local-6989586621689696045"><span id="local-6989586621689696047"><span class="annot"><span class="annottext">[SubscriberMetadata] -&gt; Value
[SubscriberMetadata] -&gt; Encoding
SubscriberMetadata -&gt; Value
SubscriberMetadata -&gt; Encoding
(SubscriberMetadata -&gt; Value)
-&gt; (SubscriberMetadata -&gt; Encoding)
-&gt; ([SubscriberMetadata] -&gt; Value)
-&gt; ([SubscriberMetadata] -&gt; Encoding)
-&gt; ToJSON SubscriberMetadata
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [SubscriberMetadata] -&gt; Encoding
$ctoEncodingList :: [SubscriberMetadata] -&gt; Encoding
toJSONList :: [SubscriberMetadata] -&gt; Value
$ctoJSONList :: [SubscriberMetadata] -&gt; Value
toEncoding :: SubscriberMetadata -&gt; Encoding
$ctoEncoding :: SubscriberMetadata -&gt; Encoding
toJSON :: SubscriberMetadata -&gt; Value
$ctoJSON :: SubscriberMetadata -&gt; Value
</span><a href="#local-6989586621689696041"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">J.ToJSON</span></a></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#mkSubscriberMetadata"><span class="hs-identifier hs-type">mkSubscriberMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#WSId"><span class="hs-identifier hs-type">WS.WSId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier hs-type">OperationId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMetadata"><span class="hs-identifier hs-type">SubscriberMetadata</span></a></span><span>
</span><span id="line-90"></span><span id="mkSubscriberMetadata"><span class="annot"><span class="annottext">mkSubscriberMetadata :: WSId
-&gt; OperationId
-&gt; Maybe OperationName
-&gt; RequestId
-&gt; SubscriberMetadata
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#mkSubscriberMetadata"><span class="hs-identifier hs-var hs-var">mkSubscriberMetadata</span></a></span></span><span> </span><span id="local-6989586621689696040"><span class="annot"><span class="annottext">WSId
</span><a href="#local-6989586621689696040"><span class="hs-identifier hs-var">websocketId</span></a></span></span><span> </span><span id="local-6989586621689696039"><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621689696039"><span class="hs-identifier hs-var">operationId</span></a></span></span><span> </span><span id="local-6989586621689696038"><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621689696038"><span class="hs-identifier hs-var">operationName</span></a></span></span><span> </span><span id="local-6989586621689696037"><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621689696037"><span class="hs-identifier hs-var">reqId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="annottext">Value -&gt; SubscriberMetadata
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMetadata"><span class="hs-identifier hs-var">SubscriberMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; SubscriberMetadata) -&gt; Value -&gt; SubscriberMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;websocket_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; WSId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">WSId
</span><a href="#local-6989586621689696040"><span class="hs-identifier hs-var">websocketId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;operation_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; OperationId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621689696039"><span class="hs-identifier hs-var">operationId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;operation_name&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Maybe OperationName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621689696038"><span class="hs-identifier hs-var">operationName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-96"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;request_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; RequestId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621689696037"><span class="hs-identifier hs-var">reqId</span></a></span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-keyword">data</span><span> </span><span id="Subscriber"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-var">Subscriber</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Subscriber"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-var">Subscriber</span></a></span></span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_sId"><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sId"><span class="hs-identifier hs-var hs-var">_sId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberId"><span class="hs-identifier hs-type">SubscriberId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-101"></span><span>    </span><span id="_sMetadata"><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberMetadata
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sMetadata"><span class="hs-identifier hs-var hs-var">_sMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMetadata"><span class="hs-identifier hs-type">SubscriberMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-102"></span><span>    </span><span id="_sRequestId"><span class="annot"><span class="annottext">Subscriber -&gt; RequestId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sRequestId"><span class="hs-identifier hs-var hs-var">_sRequestId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>    </span><span id="_sOperationName"><span class="annot"><span class="annottext">Subscriber -&gt; Maybe OperationName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sOperationName"><span class="hs-identifier hs-var hs-var">_sOperationName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>    </span><span id="_sOnChangeCallback"><span class="annot"><span class="annottext">Subscriber -&gt; OnChange
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sOnChangeCallback"><span class="hs-identifier hs-var hs-var">_sOnChangeCallback</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#OnChange"><span class="hs-identifier hs-type">OnChange</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="hs-comment">-- | Subscription onChange metadata, used for adding more extra analytics data</span><span>
</span><span id="line-108"></span><span class="hs-keyword">data</span><span> </span><span id="SubscriptionMetadata"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-var">SubscriptionMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SubscriptionMetadata"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionMetadata"><span class="hs-identifier hs-var">SubscriptionMetadata</span></a></span></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_sqmExecutionTime"><span class="annot"><span class="annottext">SubscriptionMetadata -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sqmExecutionTime"><span class="hs-identifier hs-var hs-var">_sqmExecutionTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-keyword">data</span><span> </span><span id="SubscriptionResponse"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionResponse"><span class="hs-identifier hs-var">SubscriptionResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SubscriptionResponse"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionResponse"><span class="hs-identifier hs-var">SubscriptionResponse</span></a></span></span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_lqrPayload"><span class="annot"><span class="annottext">SubscriptionResponse -&gt; ByteString
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_lqrPayload"><span class="hs-identifier hs-var hs-var">_lqrPayload</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span class="hs-special">,</span><span>
</span><span id="line-114"></span><span>    </span><span id="_lqrExecutionTime"><span class="annot"><span class="annottext">SubscriptionResponse -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_lqrExecutionTime"><span class="hs-identifier hs-var hs-var">_lqrExecutionTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="hs-keyword">type</span><span> </span><span id="SubscriptionGQResponse"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionGQResponse"><span class="hs-identifier hs-var">SubscriptionGQResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#GQResult"><span class="hs-identifier hs-type">GQResult</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionResponse"><span class="hs-identifier hs-type">SubscriptionResponse</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-keyword">type</span><span> </span><span id="OnChange"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#OnChange"><span class="hs-identifier hs-var">OnChange</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionGQResponse"><span class="hs-identifier hs-type">SubscriptionGQResponse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-keyword">type</span><span> </span><span id="SubscriberMap"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMap"><span class="hs-identifier hs-var">SubscriberMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#TMap"><span class="hs-identifier hs-type">TMap.TMap</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberId"><span class="hs-identifier hs-type">SubscriberId</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-comment">-- -------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- Cohorts</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">-- | A batched group of 'Subscriber's who are not only listening to the same query but also have</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- identical session and query variables. Each result pushed to a 'Cohort' is forwarded along to</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- each of its 'Subscriber's.</span><span>
</span><span id="line-129"></span><span class="hs-comment">--</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- In SQL, each 'Cohort' corresponds to a single row in the laterally-joined @_subs@ table (and</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- therefore a single row in the query result).</span><span>
</span><span id="line-132"></span><span class="hs-comment">--</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- See also 'CohortMap'.</span><span>
</span><span id="line-134"></span><span class="hs-keyword">data</span><span> </span><span id="Cohort"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-var">Cohort</span></a></span></span><span> </span><span id="local-6989586621689696022"><span class="annot"><a href="#local-6989586621689696022"><span class="hs-identifier hs-type">streamCursorVars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Cohort"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-var">Cohort</span></a></span></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | a unique identifier used to identify the cohort in the generated query</span><span>
</span><span id="line-136"></span><span>    </span><span id="_cCohortId"><span class="annot"><span class="annottext">Cohort streamCursorVars -&gt; CohortId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cCohortId"><span class="hs-identifier hs-var hs-var">_cCohortId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CohortId"><span class="hs-identifier hs-type">CohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-comment">-- | a hash of the previous query result, if any, used to determine if we need to push an updated</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-comment">-- result to the subscribers or not</span><span>
</span><span id="line-139"></span><span>    </span><span id="_cPreviousResponse"><span class="annot"><span class="annottext">Cohort streamCursorVars -&gt; TVar (Maybe ResponseHash)
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cPreviousResponse"><span class="hs-identifier hs-var hs-var">_cPreviousResponse</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM.TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-comment">-- | the subscribers we&#8217;ve already pushed a result to; we push new results to them iff the</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-comment">-- response changes</span><span>
</span><span id="line-142"></span><span>    </span><span id="_cExistingSubscribers"><span class="annot"><span class="annottext">Cohort streamCursorVars -&gt; SubscriberMap
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cExistingSubscribers"><span class="hs-identifier hs-var hs-var">_cExistingSubscribers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMap"><span class="hs-identifier hs-type">SubscriberMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-comment">-- | subscribers we haven&#8217;t yet pushed any results to; we push results to them regardless if the</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- result changed, then merge them in the map of existing subscribers</span><span>
</span><span id="line-145"></span><span>    </span><span id="_cNewSubscribers"><span class="annot"><span class="annottext">Cohort streamCursorVars -&gt; SubscriberMap
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var hs-var">_cNewSubscribers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMap"><span class="hs-identifier hs-type">SubscriberMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-comment">-- | a mutable type which holds the latest value of the subscription stream cursor. In case</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-comment">--   of live query subscription, this field is ignored by setting `streamCursorVars` to `()`</span><span>
</span><span id="line-148"></span><span>    </span><span id="_cStreamCursorVariables"><span class="annot"><span class="annottext">Cohort streamCursorVars -&gt; streamCursorVars
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cStreamCursorVariables"><span class="hs-identifier hs-var hs-var">_cStreamCursorVariables</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621689696022"><span class="hs-identifier hs-type">streamCursorVars</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="hs-comment">-- | The @BatchId@ is a number based ID to uniquely identify a batch in a single poll and</span><span>
</span><span id="line-152"></span><span class="hs-comment">--   it's used to identify the batch to which a cohort belongs to.</span><span>
</span><span id="line-153"></span><span class="hs-keyword">newtype</span><span> </span><span id="BatchId"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchId"><span class="hs-identifier hs-var">BatchId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BatchId"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchId"><span class="hs-identifier hs-var">BatchId</span></a></span></span><span> </span><span class="hs-special">{</span><span id="_unBatchId"><span class="annot"><span class="annottext">BatchId -&gt; Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_unBatchId"><span class="hs-identifier hs-var hs-var">_unBatchId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">}</span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689696008"><span id="local-6989586621689696010"><span id="local-6989586621689696012"><span class="annot"><span class="annottext">Int -&gt; BatchId -&gt; ShowS
[BatchId] -&gt; ShowS
BatchId -&gt; String
(Int -&gt; BatchId -&gt; ShowS)
-&gt; (BatchId -&gt; String) -&gt; ([BatchId] -&gt; ShowS) -&gt; Show BatchId
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [BatchId] -&gt; ShowS
$cshowList :: [BatchId] -&gt; ShowS
show :: BatchId -&gt; String
$cshow :: BatchId -&gt; String
showsPrec :: Int -&gt; BatchId -&gt; ShowS
$cshowsPrec :: Int -&gt; BatchId -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689696004"><span id="local-6989586621689696006"><span class="annot"><span class="annottext">BatchId -&gt; BatchId -&gt; Bool
(BatchId -&gt; BatchId -&gt; Bool)
-&gt; (BatchId -&gt; BatchId -&gt; Bool) -&gt; Eq BatchId
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: BatchId -&gt; BatchId -&gt; Bool
$c/= :: BatchId -&gt; BatchId -&gt; Bool
== :: BatchId -&gt; BatchId -&gt; Bool
$c== :: BatchId -&gt; BatchId -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689695996"><span id="local-6989586621689695998"><span id="local-6989586621689696000"><span id="local-6989586621689696002"><span class="annot"><span class="annottext">[BatchId] -&gt; Value
[BatchId] -&gt; Encoding
BatchId -&gt; Value
BatchId -&gt; Encoding
(BatchId -&gt; Value)
-&gt; (BatchId -&gt; Encoding)
-&gt; ([BatchId] -&gt; Value)
-&gt; ([BatchId] -&gt; Encoding)
-&gt; ToJSON BatchId
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [BatchId] -&gt; Encoding
$ctoEncodingList :: [BatchId] -&gt; Encoding
toJSONList :: [BatchId] -&gt; Value
$ctoJSONList :: [BatchId] -&gt; Value
toEncoding :: BatchId -&gt; Encoding
$ctoEncoding :: BatchId -&gt; Encoding
toJSON :: BatchId -&gt; Value
$ctoJSON :: BatchId -&gt; Value
</span><a href="#local-6989586621689695996"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">J.ToJSON</span></a></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="hs-comment">{- Note [Blake2b faster than SHA-256]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
At the time of writing, from https://blake2.net, it is stated,
&quot;BLAKE2 is a cryptographic hash function faster than MD5, SHA-1, SHA-2, and SHA-3,
yet is at least as secure as the latest standard SHA-3&quot;.
-}</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">-- | A hash used to determine if the result changed without having to keep the entire result in</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- memory. Using a cryptographic hash ensures that a hash collision is almost impossible: with 256</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- bits, even if a subscription changes once per second for an entire year, the probability of a</span><span>
</span><span id="line-166"></span><span class="hs-comment">-- hash collision is ~4.294417&#215;10-63. See Note [Blake2b faster than SHA-256].</span><span>
</span><span id="line-167"></span><span class="hs-keyword">newtype</span><span> </span><span id="ResponseHash"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier hs-var">ResponseHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ResponseHash"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier hs-var">ResponseHash</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unResponseHash"><span class="annot"><span class="annottext">ResponseHash -&gt; Digest Blake2b_256
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#unResponseHash"><span class="hs-identifier hs-var hs-var">unResponseHash</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CH.Digest</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CH.Blake2b_256</span></span><span class="hs-special">}</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689695988"><span id="local-6989586621689695990"><span id="local-6989586621689695992"><span class="annot"><span class="annottext">Int -&gt; ResponseHash -&gt; ShowS
[ResponseHash] -&gt; ShowS
ResponseHash -&gt; String
(Int -&gt; ResponseHash -&gt; ShowS)
-&gt; (ResponseHash -&gt; String)
-&gt; ([ResponseHash] -&gt; ShowS)
-&gt; Show ResponseHash
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ResponseHash] -&gt; ShowS
$cshowList :: [ResponseHash] -&gt; ShowS
show :: ResponseHash -&gt; String
$cshow :: ResponseHash -&gt; String
showsPrec :: Int -&gt; ResponseHash -&gt; ShowS
$cshowsPrec :: Int -&gt; ResponseHash -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689695984"><span id="local-6989586621689695986"><span class="annot"><span class="annottext">ResponseHash -&gt; ResponseHash -&gt; Bool
(ResponseHash -&gt; ResponseHash -&gt; Bool)
-&gt; (ResponseHash -&gt; ResponseHash -&gt; Bool) -&gt; Eq ResponseHash
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ResponseHash -&gt; ResponseHash -&gt; Bool
$c/= :: ResponseHash -&gt; ResponseHash -&gt; Bool
== :: ResponseHash -&gt; ResponseHash -&gt; Bool
$c== :: ResponseHash -&gt; ResponseHash -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621689695977"><span id="local-6989586621689695979"><span id="local-6989586621689695981"><span class="annot"><span class="hs-identifier hs-type">J.ToJSON</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-171"></span><span>  </span><span id="local-6989586621689695976"><span class="annot"><span class="annottext">toJSON :: ResponseHash -&gt; Value
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Value)
-&gt; (ResponseHash -&gt; String) -&gt; ResponseHash -&gt; Value
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Digest Blake2b_256 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(Digest Blake2b_256 -&gt; String)
-&gt; (ResponseHash -&gt; Digest Blake2b_256) -&gt; ResponseHash -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ResponseHash -&gt; Digest Blake2b_256
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#unResponseHash"><span class="hs-identifier hs-var hs-var">unResponseHash</span></a></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#mkRespHash"><span class="hs-identifier hs-type">mkRespHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span><span>
</span><span id="line-174"></span><span id="mkRespHash"><span class="annot"><span class="annottext">mkRespHash :: ByteString -&gt; ResponseHash
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#mkRespHash"><span class="hs-identifier hs-var hs-var">mkRespHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Digest Blake2b_256 -&gt; ResponseHash
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier hs-var">ResponseHash</span></a></span><span> </span><span class="annot"><span class="annottext">(Digest Blake2b_256 -&gt; ResponseHash)
-&gt; (ByteString -&gt; Digest Blake2b_256) -&gt; ByteString -&gt; ResponseHash
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Digest Blake2b_256
forall ba a.
(ByteArrayAccess ba, HashAlgorithm a) =&gt;
ba -&gt; Digest a
</span><span class="hs-identifier hs-var">CH.hash</span></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="hs-comment">-- | A key we use to determine if two 'Subscriber's belong in the same 'Cohort'</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- (assuming they already meet the criteria to be in the same 'Poller'). Note</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- the distinction between this and 'CohortId'; the latter is a completely</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- synthetic key used only to identify the cohort in the generated SQL query.</span><span>
</span><span id="line-180"></span><span class="hs-keyword">type</span><span> </span><span id="CohortKey"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortKey"><span class="hs-identifier hs-var">CohortKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CohortVariables"><span class="hs-identifier hs-type">CohortVariables</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- | This has the invariant, maintained in 'removeLiveQuery', that it contains</span><span>
</span><span id="line-183"></span><span class="hs-comment">-- no 'Cohort' with zero total (existing + new) subscribers.</span><span>
</span><span id="line-184"></span><span class="hs-keyword">type</span><span> </span><span id="CohortMap"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortMap"><span class="hs-identifier hs-var">CohortMap</span></a></span></span><span> </span><span id="local-6989586621689695971"><span class="annot"><a href="#local-6989586621689695971"><span class="hs-identifier hs-type">streamCursor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#TMap"><span class="hs-identifier hs-type">TMap.TMap</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortKey"><span class="hs-identifier hs-type">CohortKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-type">Cohort</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689695971"><span class="hs-identifier hs-type">streamCursor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span id="local-6989586621689696131"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#dumpCohortMap"><span class="hs-identifier hs-type">dumpCohortMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortMap"><span class="hs-identifier hs-type">CohortMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689696131"><span class="hs-identifier hs-type">streamCursor</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span></span><span>
</span><span id="line-187"></span><span id="dumpCohortMap"><span class="annot"><span class="annottext">dumpCohortMap :: CohortMap streamCursor -&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#dumpCohortMap"><span class="hs-identifier hs-var hs-var">dumpCohortMap</span></a></span></span><span> </span><span id="local-6989586621689695969"><span class="annot"><span class="annottext">CohortMap streamCursor
</span><a href="#local-6989586621689695969"><span class="hs-identifier hs-var">cohortMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-188"></span><span>  </span><span id="local-6989586621689695968"><span class="annot"><span class="annottext">[(CohortKey, Cohort streamCursor)]
</span><a href="#local-6989586621689695968"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM [(CohortKey, Cohort streamCursor)]
-&gt; IO [(CohortKey, Cohort streamCursor)]
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM [(CohortKey, Cohort streamCursor)]
 -&gt; IO [(CohortKey, Cohort streamCursor)])
-&gt; STM [(CohortKey, Cohort streamCursor)]
-&gt; IO [(CohortKey, Cohort streamCursor)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CohortMap streamCursor -&gt; STM [(CohortKey, Cohort streamCursor)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap streamCursor
</span><a href="#local-6989586621689695969"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="annottext">([Value] -&gt; Value) -&gt; IO [Value] -&gt; IO Value
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">(IO [Value] -&gt; IO Value)
-&gt; (((CohortKey, Cohort streamCursor) -&gt; IO Value) -&gt; IO [Value])
-&gt; ((CohortKey, Cohort streamCursor) -&gt; IO Value)
-&gt; IO Value
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(CohortKey, Cohort streamCursor)]
-&gt; ((CohortKey, Cohort streamCursor) -&gt; IO Value) -&gt; IO [Value]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(CohortKey, Cohort streamCursor)]
</span><a href="#local-6989586621689695968"><span class="hs-identifier hs-var">cohorts</span></a></span><span> </span><span class="annot"><span class="annottext">(((CohortKey, Cohort streamCursor) -&gt; IO Value) -&gt; IO Value)
-&gt; ((CohortKey, Cohort streamCursor) -&gt; IO Value) -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621689695964"><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621689695964"><span class="hs-identifier hs-var">variableValues</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689695963"><span class="annot"><span class="annottext">Cohort streamCursor
</span><a href="#local-6989586621689695963"><span class="hs-identifier hs-var">cohort</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-190"></span><span>    </span><span id="local-6989586621689695962"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689695962"><span class="hs-identifier hs-var">cohortJ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cohort streamCursor -&gt; IO Value
forall streamCursorVars. Cohort streamCursorVars -&gt; IO Value
</span><a href="#local-6989586621689695961"><span class="hs-identifier hs-var">dumpCohort</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort streamCursor
</span><a href="#local-6989586621689695963"><span class="hs-identifier hs-var">cohort</span></a></span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="annottext">Value -&gt; IO Value
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; IO Value) -&gt; Value -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-192"></span><span>      </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-193"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;variables&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; CohortKey -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621689695964"><span class="hs-identifier hs-var">variableValues</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-194"></span><span>          </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;cohort&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689695962"><span class="hs-identifier hs-var">cohortJ</span></a></span><span>
</span><span id="line-195"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-197"></span><span>    </span><span id="local-6989586621689695961"><span class="annot"><span class="annottext">dumpCohort :: Cohort streamCursorVars -&gt; IO Value
</span><a href="#local-6989586621689695961"><span class="hs-identifier hs-var hs-var">dumpCohort</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-type">Cohort</span></a></span><span> </span><span id="local-6989586621689695960"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689695960"><span class="hs-identifier hs-var">respId</span></a></span></span><span> </span><span id="local-6989586621689695959"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689695959"><span class="hs-identifier hs-var">respTV</span></a></span></span><span> </span><span id="local-6989586621689695958"><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621689695958"><span class="hs-identifier hs-var">curOps</span></a></span></span><span> </span><span id="local-6989586621689695957"><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621689695957"><span class="hs-identifier hs-var">newOps</span></a></span></span><span> </span><span class="annot"><span class="annottext">streamCursorVars
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>      </span><span class="annot"><span class="annottext">STM Value -&gt; IO Value
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Value -&gt; IO Value) -&gt; STM Value -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-199"></span><span>        </span><span id="local-6989586621689695956"><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689695956"><span class="hs-identifier hs-var">prevResHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash) -&gt; STM (Maybe ResponseHash)
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">STM.readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621689695959"><span class="hs-identifier hs-var">respTV</span></a></span><span>
</span><span id="line-200"></span><span>        </span><span id="local-6989586621689695954"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689695954"><span class="hs-identifier hs-var">curOpIds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621689695958"><span class="hs-identifier hs-var">curOps</span></a></span><span>
</span><span id="line-201"></span><span>        </span><span id="local-6989586621689695953"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689695953"><span class="hs-identifier hs-var">newOpIds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621689695957"><span class="hs-identifier hs-var">newOps</span></a></span><span>
</span><span id="line-202"></span><span>        </span><span class="annot"><span class="annottext">Value -&gt; STM Value
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; STM Value) -&gt; Value -&gt; STM Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-203"></span><span>          </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-204"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;resp_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; CohortId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621689695960"><span class="hs-identifier hs-var">respId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-205"></span><span>              </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;current_ops&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; [SubscriberId] -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; SubscriberId)
-&gt; [(SubscriberId, Subscriber)] -&gt; [SubscriberId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; SubscriberId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689695954"><span class="hs-identifier hs-var">curOpIds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-206"></span><span>              </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;new_ops&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; [SubscriberId] -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; SubscriberId)
-&gt; [(SubscriberId, Subscriber)] -&gt; [SubscriberId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; SubscriberId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621689695953"><span class="hs-identifier hs-var">newOpIds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-207"></span><span>              </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;previous_result_hash&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Maybe ResponseHash -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621689695956"><span class="hs-identifier hs-var">prevResHash</span></a></span><span>
</span><span id="line-208"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="hs-keyword">data</span><span> </span><span id="CohortSnapshot"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier hs-var">CohortSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CohortSnapshot"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortSnapshot"><span class="hs-identifier hs-var">CohortSnapshot</span></a></span></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_csVariables"><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortKey
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csVariables"><span class="hs-identifier hs-var hs-var">_csVariables</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CohortVariables"><span class="hs-identifier hs-type">CohortVariables</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-212"></span><span>    </span><span id="_csPreviousResponse"><span class="annot"><span class="annottext">CohortSnapshot -&gt; TVar (Maybe ResponseHash)
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csPreviousResponse"><span class="hs-identifier hs-var hs-var">_csPreviousResponse</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM.TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-213"></span><span>    </span><span id="_csExistingSubscribers"><span class="annot"><span class="annottext">CohortSnapshot -&gt; [Subscriber]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csExistingSubscribers"><span class="hs-identifier hs-var hs-var">_csExistingSubscribers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-214"></span><span>    </span><span id="_csNewSubscribers"><span class="annot"><span class="annottext">CohortSnapshot -&gt; [Subscriber]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_csNewSubscribers"><span class="hs-identifier hs-var hs-var">_csNewSubscribers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- Pollers</span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="hs-comment">-- | A unique, multiplexed query. Each 'Poller' has its own polling thread that</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- periodically polls Postgres and pushes results to each of its listening</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- 'Cohort's.</span><span>
</span><span id="line-223"></span><span class="hs-comment">--</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- In SQL, an 'Poller' corresponds to a single, multiplexed query, though in</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- practice, 'Poller's with large numbers of 'Cohort's are batched into</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- multiple concurrent queries for performance reasons.</span><span>
</span><span id="line-227"></span><span class="hs-keyword">data</span><span> </span><span id="Poller"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Poller"><span class="hs-identifier hs-var">Poller</span></a></span></span><span> </span><span id="local-6989586621689695947"><span class="annot"><a href="#local-6989586621689695947"><span class="hs-identifier hs-type">streamCursor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Poller"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Poller"><span class="hs-identifier hs-var">Poller</span></a></span></span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_pCohorts"><span class="annot"><span class="annottext">Poller streamCursor -&gt; CohortMap streamCursor
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pCohorts"><span class="hs-identifier hs-var hs-var">_pCohorts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortMap"><span class="hs-identifier hs-type">CohortMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689695947"><span class="hs-identifier hs-type">streamCursor</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-comment">-- | This is in a separate 'STM.TMVar' because it&#8217;s important that we are</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-comment">-- able to construct 'Poller' values in 'STM.STM' --- we need the insertion</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-comment">-- into the 'PollerMap' to be atomic to ensure that we don&#8217;t accidentally</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-comment">-- create two for the same query due to a race. However, we can&#8217;t spawn the</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-comment">-- worker thread or create the metrics store in 'STM.STM', so we insert it</span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-comment">-- into the 'Poller' only after we&#8217;re certain we won&#8217;t create any duplicates.</span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-comment">-- This var is &quot;write once&quot;, moving monotonically from empty to full.</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-comment">-- TODO this could probably be tightened up to something like</span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-comment">-- 'STM PollerIOState'</span><span>
</span><span id="line-239"></span><span>    </span><span id="_pIOState"><span class="annot"><span class="annottext">Poller streamCursor -&gt; TMVar PollerIOState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pIOState"><span class="hs-identifier hs-var hs-var">_pIOState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM.TMVar</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerIOState"><span class="hs-identifier hs-type">PollerIOState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="hs-keyword">data</span><span> </span><span id="PollerIOState"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerIOState"><span class="hs-identifier hs-var">PollerIOState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PollerIOState"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerIOState"><span class="hs-identifier hs-var">PollerIOState</span></a></span></span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | a handle on the poller&#8217;s worker thread that can be used to</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-comment">-- 'Immortal.stop' it if all its cohorts stop listening</span><span>
</span><span id="line-245"></span><span>    </span><span id="_pThread"><span class="annot"><span class="annottext">PollerIOState -&gt; Thread
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pThread"><span class="hs-identifier hs-var hs-var">_pThread</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span><span class="hs-special">,</span><span>
</span><span id="line-246"></span><span>    </span><span id="_pId"><span class="annot"><span class="annottext">PollerIOState -&gt; PollerId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pId"><span class="hs-identifier hs-var hs-var">_pId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerId"><span class="hs-identifier hs-type">PollerId</span></a></span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span id="local-6989586621689695939"><span id="local-6989586621689695940"></span></span><span class="hs-keyword">data</span><span> </span><span id="PollerKey"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerKey"><span class="hs-identifier hs-var">PollerKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-comment">-- we don't need operation name here as a subscription will only have a</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-comment">-- single top level field</span><span>
</span><span id="line-252"></span><span>  </span><span id="PollerKey"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerKey"><span class="hs-identifier hs-var">PollerKey</span></a></span></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_lgSource"><span class="annot"><span class="annottext">PollerKey -&gt; SourceName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_lgSource"><span class="hs-identifier hs-var hs-var">_lgSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-254"></span><span>    </span><span id="_lgRole"><span class="annot"><span class="annottext">PollerKey -&gt; RoleName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_lgRole"><span class="hs-identifier hs-var hs-var">_lgRole</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-255"></span><span>    </span><span id="_lgQuery"><span class="annot"><span class="annottext">PollerKey -&gt; Text
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_lgQuery"><span class="hs-identifier hs-var hs-var">_lgQuery</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-257"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689695929"><span id="local-6989586621689695931"><span id="local-6989586621689695933"><span class="annot"><span class="annottext">Int -&gt; PollerKey -&gt; ShowS
[PollerKey] -&gt; ShowS
PollerKey -&gt; String
(Int -&gt; PollerKey -&gt; ShowS)
-&gt; (PollerKey -&gt; String)
-&gt; ([PollerKey] -&gt; ShowS)
-&gt; Show PollerKey
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PollerKey] -&gt; ShowS
$cshowList :: [PollerKey] -&gt; ShowS
show :: PollerKey -&gt; String
$cshow :: PollerKey -&gt; String
showsPrec :: Int -&gt; PollerKey -&gt; ShowS
$cshowsPrec :: Int -&gt; PollerKey -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689695925"><span id="local-6989586621689695927"><span class="annot"><span class="annottext">PollerKey -&gt; PollerKey -&gt; Bool
(PollerKey -&gt; PollerKey -&gt; Bool)
-&gt; (PollerKey -&gt; PollerKey -&gt; Bool) -&gt; Eq PollerKey
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PollerKey -&gt; PollerKey -&gt; Bool
$c/= :: PollerKey -&gt; PollerKey -&gt; Bool
== :: PollerKey -&gt; PollerKey -&gt; Bool
$c== :: PollerKey -&gt; PollerKey -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. PollerKey -&gt; Rep PollerKey x)
-&gt; (forall x. Rep PollerKey x -&gt; PollerKey) -&gt; Generic PollerKey
forall x. Rep PollerKey x -&gt; PollerKey
forall x. PollerKey -&gt; Rep PollerKey x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep PollerKey x -&gt; PollerKey
$cfrom :: forall x. PollerKey -&gt; Rep PollerKey x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621689695919"><span id="local-6989586621689695921"><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span></span></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621689695912"><span id="local-6989586621689695914"><span id="local-6989586621689695916"><span class="annot"><span class="hs-identifier hs-type">J.ToJSON</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-262"></span><span>  </span><span id="local-6989586621689695911"><span class="annot"><span class="annottext">toJSON :: PollerKey -&gt; Value
</span><a href="#local-6989586621689695911"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span><span> </span><span id="local-6989586621689695910"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689695910"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621689695909"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689695909"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621689695908"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689695908"><span class="hs-identifier hs-var">query</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-264"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; SourceName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689695910"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-265"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;role&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; RoleName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689695909"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-266"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;query&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689695908"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-267"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="hs-keyword">type</span><span> </span><span id="PollerMap"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerMap"><span class="hs-identifier hs-var">PollerMap</span></a></span></span><span> </span><span id="local-6989586621689695907"><span class="annot"><a href="#local-6989586621689695907"><span class="hs-identifier hs-type">streamCursor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STMMap.Map</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Poller"><span class="hs-identifier hs-type">Poller</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689695907"><span class="hs-identifier hs-type">streamCursor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span id="local-6989586621689695906"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#dumpPollerMap"><span class="hs-identifier hs-type">dumpPollerMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerMap"><span class="hs-identifier hs-type">PollerMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689695906"><span class="hs-identifier hs-type">streamCursor</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span></span><span>
</span><span id="line-272"></span><span id="dumpPollerMap"><span class="annot"><span class="annottext">dumpPollerMap :: Bool -&gt; PollerMap streamCursor -&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#dumpPollerMap"><span class="hs-identifier hs-var hs-var">dumpPollerMap</span></a></span></span><span> </span><span id="local-6989586621689695905"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689695905"><span class="hs-identifier hs-var">extended</span></a></span></span><span> </span><span id="local-6989586621689695904"><span class="annot"><span class="annottext">PollerMap streamCursor
</span><a href="#local-6989586621689695904"><span class="hs-identifier hs-var">pollerMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-273"></span><span>  </span><span class="annot"><span class="annottext">([Value] -&gt; Value) -&gt; IO [Value] -&gt; IO Value
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">(IO [Value] -&gt; IO Value) -&gt; IO [Value] -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>    </span><span id="local-6989586621689695903"><span class="annot"><span class="annottext">[(PollerKey, Poller streamCursor)]
</span><a href="#local-6989586621689695903"><span class="hs-identifier hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM [(PollerKey, Poller streamCursor)]
-&gt; IO [(PollerKey, Poller streamCursor)]
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM [(PollerKey, Poller streamCursor)]
 -&gt; IO [(PollerKey, Poller streamCursor)])
-&gt; STM [(PollerKey, Poller streamCursor)]
-&gt; IO [(PollerKey, Poller streamCursor)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ListT STM (PollerKey, Poller streamCursor)
-&gt; STM [(PollerKey, Poller streamCursor)]
forall (m :: * -&gt; *) a. Monad m =&gt; ListT m a -&gt; m [a]
</span><span class="hs-identifier hs-var">ListT.toList</span></span><span> </span><span class="annot"><span class="annottext">(ListT STM (PollerKey, Poller streamCursor)
 -&gt; STM [(PollerKey, Poller streamCursor)])
-&gt; ListT STM (PollerKey, Poller streamCursor)
-&gt; STM [(PollerKey, Poller streamCursor)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PollerMap streamCursor
-&gt; ListT STM (PollerKey, Poller streamCursor)
forall key value. Map key value -&gt; ListT STM (key, value)
</span><span class="hs-identifier hs-var">STMMap.listT</span></span><span> </span><span class="annot"><span class="annottext">PollerMap streamCursor
</span><a href="#local-6989586621689695904"><span class="hs-identifier hs-var">pollerMap</span></a></span><span>
</span><span id="line-275"></span><span>    </span><span class="annot"><span class="annottext">[(PollerKey, Poller streamCursor)]
-&gt; ((PollerKey, Poller streamCursor) -&gt; IO Value) -&gt; IO [Value]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(PollerKey, Poller streamCursor)]
</span><a href="#local-6989586621689695903"><span class="hs-identifier hs-var">entries</span></a></span><span> </span><span class="annot"><span class="annottext">(((PollerKey, Poller streamCursor) -&gt; IO Value) -&gt; IO [Value])
-&gt; ((PollerKey, Poller streamCursor) -&gt; IO Value) -&gt; IO [Value]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span><span> </span><span id="local-6989586621689695900"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689695900"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621689695899"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689695899"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621689695898"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689695898"><span class="hs-identifier hs-var">query</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Poller"><span class="hs-identifier hs-type">Poller</span></a></span><span> </span><span id="local-6989586621689695897"><span class="annot"><span class="annottext">CohortMap streamCursor
</span><a href="#local-6989586621689695897"><span class="hs-identifier hs-var">cohortsMap</span></a></span></span><span> </span><span id="local-6989586621689695896"><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621689695896"><span class="hs-identifier hs-var">ioState</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerIOState"><span class="hs-identifier hs-type">PollerIOState</span></a></span><span> </span><span id="local-6989586621689695895"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689695895"><span class="hs-identifier hs-var">threadId</span></a></span></span><span> </span><span id="local-6989586621689695894"><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621689695894"><span class="hs-identifier hs-var">pollerId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM PollerIOState -&gt; IO PollerIOState
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM PollerIOState -&gt; IO PollerIOState)
-&gt; STM PollerIOState -&gt; IO PollerIOState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState -&gt; STM PollerIOState
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">STM.readTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621689695896"><span class="hs-identifier hs-var">ioState</span></a></span><span>
</span><span id="line-277"></span><span>      </span><span id="local-6989586621689695892"><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621689695892"><span class="hs-identifier hs-var">cohortsJ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-278"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689695905"><span class="hs-identifier hs-var">extended</span></a></span><span>
</span><span id="line-279"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; Maybe Value) -&gt; IO Value -&gt; IO (Maybe Value)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CohortMap streamCursor -&gt; IO Value
forall streamCursor. CohortMap streamCursor -&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#dumpCohortMap"><span class="hs-identifier hs-var">dumpCohortMap</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap streamCursor
</span><a href="#local-6989586621689695897"><span class="hs-identifier hs-var">cohortsMap</span></a></span><span>
</span><span id="line-280"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Value -&gt; IO (Maybe Value)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-281"></span><span>      </span><span class="annot"><span class="annottext">Value -&gt; IO Value
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; IO Value) -&gt; Value -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-283"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; SourceName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689695900"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-284"></span><span>            </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;role&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; RoleName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689695899"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-285"></span><span>            </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;thread_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; String -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Thread -&gt; ThreadId
</span><span class="hs-identifier hs-var">Immortal.threadId</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689695895"><span class="hs-identifier hs-var">threadId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-286"></span><span>            </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;poller_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; PollerId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621689695894"><span class="hs-identifier hs-var">pollerId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-287"></span><span>            </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;multiplexed_query&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689695898"><span class="hs-identifier hs-var">query</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-288"></span><span>            </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;cohorts&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Maybe Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621689695892"><span class="hs-identifier hs-var">cohortsJ</span></a></span><span>
</span><span id="line-289"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- | An ID to track unique 'Poller's, so that we can gather metrics about each</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- poller</span><span>
</span><span id="line-293"></span><span id="local-6989586621689695889"><span id="local-6989586621689695890"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="PollerId"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerId"><span class="hs-identifier hs-var">PollerId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PollerId"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerId"><span class="hs-identifier hs-var">PollerId</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unPollerId"><span class="annot"><span class="annottext">PollerId -&gt; UUID
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#unPollerId"><span class="hs-identifier hs-var hs-var">unPollerId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UUID.UUID</span></span><span class="hs-special">}</span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689695881"><span id="local-6989586621689695883"><span id="local-6989586621689695885"><span class="annot"><span class="annottext">Int -&gt; PollerId -&gt; ShowS
[PollerId] -&gt; ShowS
PollerId -&gt; String
(Int -&gt; PollerId -&gt; ShowS)
-&gt; (PollerId -&gt; String) -&gt; ([PollerId] -&gt; ShowS) -&gt; Show PollerId
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PollerId] -&gt; ShowS
$cshowList :: [PollerId] -&gt; ShowS
show :: PollerId -&gt; String
$cshow :: PollerId -&gt; String
showsPrec :: Int -&gt; PollerId -&gt; ShowS
$cshowsPrec :: Int -&gt; PollerId -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689695877"><span id="local-6989586621689695879"><span class="annot"><span class="annottext">PollerId -&gt; PollerId -&gt; Bool
(PollerId -&gt; PollerId -&gt; Bool)
-&gt; (PollerId -&gt; PollerId -&gt; Bool) -&gt; Eq PollerId
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PollerId -&gt; PollerId -&gt; Bool
$c/= :: PollerId -&gt; PollerId -&gt; Bool
== :: PollerId -&gt; PollerId -&gt; Bool
$c== :: PollerId -&gt; PollerId -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. PollerId -&gt; Rep PollerId x)
-&gt; (forall x. Rep PollerId x -&gt; PollerId) -&gt; Generic PollerId
forall x. Rep PollerId x -&gt; PollerId
forall x. PollerId -&gt; Rep PollerId x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep PollerId x -&gt; PollerId
$cfrom :: forall x. PollerId -&gt; Rep PollerId x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689695867"><span id="local-6989586621689695869"><span id="local-6989586621689695871"><span id="local-6989586621689695873"><span class="annot"><span class="annottext">[PollerId] -&gt; Value
[PollerId] -&gt; Encoding
PollerId -&gt; Value
PollerId -&gt; Encoding
(PollerId -&gt; Value)
-&gt; (PollerId -&gt; Encoding)
-&gt; ([PollerId] -&gt; Value)
-&gt; ([PollerId] -&gt; Encoding)
-&gt; ToJSON PollerId
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [PollerId] -&gt; Encoding
$ctoEncodingList :: [PollerId] -&gt; Encoding
toJSONList :: [PollerId] -&gt; Value
$ctoJSONList :: [PollerId] -&gt; Value
toEncoding :: PollerId -&gt; Encoding
$ctoEncoding :: PollerId -&gt; Encoding
toJSON :: PollerId -&gt; Value
$ctoJSON :: PollerId -&gt; Value
</span><a href="#local-6989586621689695867"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">J.ToJSON</span></a></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="hs-keyword">data</span><span> </span><span id="SubscriberExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-var">SubscriberExecutionDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SubscriberExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-var">SubscriberExecutionDetails</span></a></span></span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_sedSubscriberId"><span class="annot"><span class="annottext">SubscriberExecutionDetails -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sedSubscriberId"><span class="hs-identifier hs-var hs-var">_sedSubscriberId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberId"><span class="hs-identifier hs-type">SubscriberId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-298"></span><span>    </span><span id="_sedSubscriberMetadata"><span class="annot"><span class="annottext">SubscriberExecutionDetails -&gt; SubscriberMetadata
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sedSubscriberMetadata"><span class="hs-identifier hs-var hs-var">_sedSubscriberMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMetadata"><span class="hs-identifier hs-type">SubscriberMetadata</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689695858"><span id="local-6989586621689695860"><span id="local-6989586621689695862"><span class="annot"><span class="annottext">Int -&gt; SubscriberExecutionDetails -&gt; ShowS
[SubscriberExecutionDetails] -&gt; ShowS
SubscriberExecutionDetails -&gt; String
(Int -&gt; SubscriberExecutionDetails -&gt; ShowS)
-&gt; (SubscriberExecutionDetails -&gt; String)
-&gt; ([SubscriberExecutionDetails] -&gt; ShowS)
-&gt; Show SubscriberExecutionDetails
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SubscriberExecutionDetails] -&gt; ShowS
$cshowList :: [SubscriberExecutionDetails] -&gt; ShowS
show :: SubscriberExecutionDetails -&gt; String
$cshow :: SubscriberExecutionDetails -&gt; String
showsPrec :: Int -&gt; SubscriberExecutionDetails -&gt; ShowS
$cshowsPrec :: Int -&gt; SubscriberExecutionDetails -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689695854"><span id="local-6989586621689695856"><span class="annot"><span class="annottext">SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool
(SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool)
-&gt; (SubscriberExecutionDetails
    -&gt; SubscriberExecutionDetails -&gt; Bool)
-&gt; Eq SubscriberExecutionDetails
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool
$c/= :: SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool
== :: SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool
$c== :: SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-comment">-- | Execution information related to a cohort on a poll cycle</span><span>
</span><span id="line-303"></span><span class="hs-keyword">data</span><span> </span><span id="CohortExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortExecutionDetails"><span class="hs-identifier hs-var">CohortExecutionDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CohortExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortExecutionDetails"><span class="hs-identifier hs-var">CohortExecutionDetails</span></a></span></span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_cedCohortId"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; CohortId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedCohortId"><span class="hs-identifier hs-var hs-var">_cedCohortId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CohortId"><span class="hs-identifier hs-type">CohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-305"></span><span>    </span><span id="_cedVariables"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; CohortKey
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedVariables"><span class="hs-identifier hs-var hs-var">_cedVariables</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CohortVariables"><span class="hs-identifier hs-type">CohortVariables</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-comment">-- | Nothing in case of an error</span><span>
</span><span id="line-307"></span><span>    </span><span id="_cedResponseSize"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; Maybe Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedResponseSize"><span class="hs-identifier hs-var hs-var">_cedResponseSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-comment">-- | The response on this cycle has been pushed to these above subscribers</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-comment">-- New subscribers (those which haven't been around during the previous poll</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-comment">-- cycle) will always be part of this</span><span>
</span><span id="line-311"></span><span>    </span><span id="_cedPushedTo"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedPushedTo"><span class="hs-identifier hs-var hs-var">_cedPushedTo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-comment">-- | The response on this cycle has *not* been pushed to these above</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">-- subscribers. This would when the response hasn't changed from the previous</span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-comment">-- polled cycle</span><span>
</span><span id="line-315"></span><span>    </span><span id="_cedIgnored"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedIgnored"><span class="hs-identifier hs-var hs-var">_cedIgnored</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-316"></span><span>    </span><span id="_cedBatchId"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; BatchId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cedBatchId"><span class="hs-identifier hs-var hs-var">_cedBatchId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchId"><span class="hs-identifier hs-type">BatchId</span></a></span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689695841"><span id="local-6989586621689695843"><span id="local-6989586621689695845"><span class="annot"><span class="annottext">Int -&gt; CohortExecutionDetails -&gt; ShowS
[CohortExecutionDetails] -&gt; ShowS
CohortExecutionDetails -&gt; String
(Int -&gt; CohortExecutionDetails -&gt; ShowS)
-&gt; (CohortExecutionDetails -&gt; String)
-&gt; ([CohortExecutionDetails] -&gt; ShowS)
-&gt; Show CohortExecutionDetails
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CohortExecutionDetails] -&gt; ShowS
$cshowList :: [CohortExecutionDetails] -&gt; ShowS
show :: CohortExecutionDetails -&gt; String
$cshow :: CohortExecutionDetails -&gt; String
showsPrec :: Int -&gt; CohortExecutionDetails -&gt; ShowS
$cshowsPrec :: Int -&gt; CohortExecutionDetails -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689695837"><span id="local-6989586621689695839"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool
(CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool)
-&gt; (CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool)
-&gt; Eq CohortExecutionDetails
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool
$c/= :: CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool
== :: CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool
$c== :: CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="hs-comment">-- | Execution information related to a single batched execution</span><span>
</span><span id="line-321"></span><span class="hs-keyword">data</span><span> </span><span id="BatchExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchExecutionDetails"><span class="hs-identifier hs-var">BatchExecutionDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BatchExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchExecutionDetails"><span class="hs-identifier hs-var">BatchExecutionDetails</span></a></span></span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | postgres execution time of each batch</span><span>
</span><span id="line-323"></span><span>    </span><span id="_bedPgExecutionTime"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_bedPgExecutionTime"><span class="hs-identifier hs-var hs-var">_bedPgExecutionTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span class="hs-special">,</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-comment">-- | time to taken to push to all cohorts belonging to this batch</span><span>
</span><span id="line-325"></span><span>    </span><span id="_bedPushTime"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_bedPushTime"><span class="hs-identifier hs-var hs-var">_bedPushTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span class="hs-special">,</span><span>
</span><span id="line-326"></span><span>    </span><span class="hs-comment">-- | id of the batch</span><span>
</span><span id="line-327"></span><span>    </span><span id="_bedBatchId"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; BatchId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_bedBatchId"><span class="hs-identifier hs-var hs-var">_bedBatchId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchId"><span class="hs-identifier hs-type">BatchId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-comment">-- | execution details of the cohorts belonging to this batch</span><span>
</span><span id="line-329"></span><span>    </span><span id="_bedCohorts"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; [CohortExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_bedCohorts"><span class="hs-identifier hs-var hs-var">_bedCohorts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortExecutionDetails"><span class="hs-identifier hs-type">CohortExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-330"></span><span>    </span><span id="_bedBatchResponseSizeBytes"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; Maybe Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_bedBatchResponseSizeBytes"><span class="hs-identifier hs-var hs-var">_bedBatchResponseSizeBytes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689695825"><span id="local-6989586621689695827"><span id="local-6989586621689695829"><span class="annot"><span class="annottext">Int -&gt; BatchExecutionDetails -&gt; ShowS
[BatchExecutionDetails] -&gt; ShowS
BatchExecutionDetails -&gt; String
(Int -&gt; BatchExecutionDetails -&gt; ShowS)
-&gt; (BatchExecutionDetails -&gt; String)
-&gt; ([BatchExecutionDetails] -&gt; ShowS)
-&gt; Show BatchExecutionDetails
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [BatchExecutionDetails] -&gt; ShowS
$cshowList :: [BatchExecutionDetails] -&gt; ShowS
show :: BatchExecutionDetails -&gt; String
$cshow :: BatchExecutionDetails -&gt; String
showsPrec :: Int -&gt; BatchExecutionDetails -&gt; ShowS
$cshowsPrec :: Int -&gt; BatchExecutionDetails -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689695821"><span id="local-6989586621689695823"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool
(BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool)
-&gt; (BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool)
-&gt; Eq BatchExecutionDetails
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool
$c/= :: BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool
== :: BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool
$c== :: BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span class="hs-comment">-- | see Note [Minimal LiveQuery Poller Log]</span><span>
</span><span id="line-335"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#batchExecutionDetailMinimal"><span class="hs-identifier hs-type">batchExecutionDetailMinimal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchExecutionDetails"><span class="hs-identifier hs-type">BatchExecutionDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-336"></span><span id="batchExecutionDetailMinimal"><span class="annot"><span class="annottext">batchExecutionDetailMinimal :: BatchExecutionDetails -&gt; Value
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#batchExecutionDetailMinimal"><span class="hs-identifier hs-var hs-var">batchExecutionDetailMinimal</span></a></span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchExecutionDetails"><span class="hs-identifier hs-type">BatchExecutionDetails</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689695815"><span id="local-6989586621689695816"><span id="local-6989586621689695817"><span id="local-6989586621689695818"><span id="local-6989586621689695819"><span class="annot"><span class="annottext">[CohortExecutionDetails]
Maybe Int
DiffTime
BatchId
_bedBatchResponseSizeBytes :: Maybe Int
_bedCohorts :: [CohortExecutionDetails]
_bedBatchId :: BatchId
_bedPushTime :: DiffTime
_bedPgExecutionTime :: DiffTime
_bedBatchResponseSizeBytes :: BatchExecutionDetails -&gt; Maybe Int
_bedCohorts :: BatchExecutionDetails -&gt; [CohortExecutionDetails]
_bedBatchId :: BatchExecutionDetails -&gt; BatchId
_bedPushTime :: BatchExecutionDetails -&gt; DiffTime
_bedPgExecutionTime :: BatchExecutionDetails -&gt; DiffTime
</span><a href="#local-6989586621689695815"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689695814"><span class="annot"><span class="annottext">batchRespSize :: [Pair]
</span><a href="#local-6989586621689695814"><span class="hs-identifier hs-var hs-var">batchRespSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-338"></span><span>        </span><span class="annot"><span class="annottext">[Pair] -&gt; (Int -&gt; [Pair]) -&gt; Maybe Int -&gt; [Pair]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span>
</span><span id="line-339"></span><span>          </span><span class="annot"><span class="annottext">[Pair]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-340"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621689695812"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689695812"><span class="hs-identifier hs-var">respSize</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;batch_response_size_bytes&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Int -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689695812"><span class="hs-identifier hs-var">respSize</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>          </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621689695815"><span class="hs-identifier hs-var">_bedBatchResponseSizeBytes</span></a></span><span>
</span><span id="line-342"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-343"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;pg_execution_time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; DiffTime -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689695819"><span class="hs-identifier hs-var">_bedPgExecutionTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-344"></span><span>            </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;push_time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; DiffTime -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689695818"><span class="hs-identifier hs-var">_bedPushTime</span></a></span><span>
</span><span id="line-345"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-346"></span><span>            </span><span class="hs-comment">-- log batch resp size only when there are no errors</span><span>
</span><span id="line-347"></span><span>            </span><span class="annot"><span class="annottext">[Pair] -&gt; [Pair] -&gt; [Pair]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Pair]
</span><a href="#local-6989586621689695814"><span class="hs-identifier hs-var">batchRespSize</span></a></span><span>
</span><span id="line-348"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span class="hs-comment">-- TODO consider refactoring into two types: one that is returned from pollLiveQuery and pollStreamingQuery, and a parent type containing pollerId, sourceName, and so on, which is assembled at the callsites of those two functions. Move postPollHook out of those functions to callsites</span><span>
</span><span id="line-351"></span><span class="hs-keyword">data</span><span> </span><span id="PollDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetails"><span class="hs-identifier hs-var">PollDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PollDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetails"><span class="hs-identifier hs-var">PollDetails</span></a></span></span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | the unique ID (basically a thread that run as a 'Poller') for the</span><span>
</span><span id="line-353"></span><span>    </span><span class="hs-comment">-- 'Poller'</span><span>
</span><span id="line-354"></span><span>    </span><span id="_pdPollerId"><span class="annot"><span class="annottext">PollDetails -&gt; PollerId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdPollerId"><span class="hs-identifier hs-var hs-var">_pdPollerId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerId"><span class="hs-identifier hs-type">PollerId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-comment">-- | the multiplexed SQL query to be run against the database with all the</span><span>
</span><span id="line-356"></span><span>    </span><span class="hs-comment">-- variables together</span><span>
</span><span id="line-357"></span><span>    </span><span id="_pdGeneratedSql"><span class="annot"><span class="annottext">PollDetails -&gt; Text
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdGeneratedSql"><span class="hs-identifier hs-var hs-var">_pdGeneratedSql</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">,</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-comment">-- | the time taken to get a snapshot of cohorts from our 'SubscriptionsState'</span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-comment">-- data structure</span><span>
</span><span id="line-360"></span><span>    </span><span id="_pdSnapshotTime"><span class="annot"><span class="annottext">PollDetails -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdSnapshotTime"><span class="hs-identifier hs-var hs-var">_pdSnapshotTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span class="hs-special">,</span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-comment">-- | list of execution batches and their details</span><span>
</span><span id="line-362"></span><span>    </span><span id="_pdBatches"><span class="annot"><span class="annottext">PollDetails -&gt; [BatchExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdBatches"><span class="hs-identifier hs-var hs-var">_pdBatches</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BatchExecutionDetails"><span class="hs-identifier hs-type">BatchExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-comment">-- | total time spent on a poll cycle</span><span>
</span><span id="line-364"></span><span>    </span><span id="_pdTotalTime"><span class="annot"><span class="annottext">PollDetails -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdTotalTime"><span class="hs-identifier hs-var hs-var">_pdTotalTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span class="hs-special">,</span><span>
</span><span id="line-365"></span><span>    </span><span id="_pdLiveQueryOptions"><span class="annot"><span class="annottext">PollDetails -&gt; SubscriptionsOptions
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdLiveQueryOptions"><span class="hs-identifier hs-var hs-var">_pdLiveQueryOptions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#SubscriptionsOptions"><span class="hs-identifier hs-type">SubscriptionsOptions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-366"></span><span>    </span><span id="_pdSource"><span class="annot"><span class="annottext">PollDetails -&gt; SourceName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdSource"><span class="hs-identifier hs-var hs-var">_pdSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-367"></span><span>    </span><span id="_pdRole"><span class="annot"><span class="annottext">PollDetails -&gt; RoleName
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdRole"><span class="hs-identifier hs-var hs-var">_pdRole</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-368"></span><span>    </span><span id="_pdParameterizedQueryHash"><span class="annot"><span class="annottext">PollDetails -&gt; ParameterizedQueryHash
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pdParameterizedQueryHash"><span class="hs-identifier hs-var hs-var">_pdParameterizedQueryHash</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier hs-type">ParameterizedQueryHash</span></a></span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689695796"><span id="local-6989586621689695798"><span id="local-6989586621689695800"><span class="annot"><span class="annottext">Int -&gt; PollDetails -&gt; ShowS
[PollDetails] -&gt; ShowS
PollDetails -&gt; String
(Int -&gt; PollDetails -&gt; ShowS)
-&gt; (PollDetails -&gt; String)
-&gt; ([PollDetails] -&gt; ShowS)
-&gt; Show PollDetails
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PollDetails] -&gt; ShowS
$cshowList :: [PollDetails] -&gt; ShowS
show :: PollDetails -&gt; String
$cshow :: PollDetails -&gt; String
showsPrec :: Int -&gt; PollDetails -&gt; ShowS
$cshowsPrec :: Int -&gt; PollDetails -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689695792"><span id="local-6989586621689695794"><span class="annot"><span class="annottext">PollDetails -&gt; PollDetails -&gt; Bool
(PollDetails -&gt; PollDetails -&gt; Bool)
-&gt; (PollDetails -&gt; PollDetails -&gt; Bool) -&gt; Eq PollDetails
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PollDetails -&gt; PollDetails -&gt; Bool
$c/= :: PollDetails -&gt; PollDetails -&gt; Bool
== :: PollDetails -&gt; PollDetails -&gt; Bool
$c== :: PollDetails -&gt; PollDetails -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span class="hs-comment">{- Note [Minimal LiveQuery Poller Log]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We only want to log the minimal information in the livequery-poller-log as it
could be expensive to log the details of every subscriber (all poller related
information can always be retrieved by dumping the current live queries state)
We capture a lot more details in PollDetails and BatchExecutionDetails than
that is logged currently as other implementations such as pro can use them if
they need to.
-}</span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="hs-comment">-- | see Note [Minimal LiveQuery Poller Log]</span><span>
</span><span id="line-383"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#pollDetailMinimal"><span class="hs-identifier hs-type">pollDetailMinimal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-384"></span><span id="pollDetailMinimal"><span class="annot"><span class="annottext">pollDetailMinimal :: PollDetails -&gt; Value
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#pollDetailMinimal"><span class="hs-identifier hs-var hs-var">pollDetailMinimal</span></a></span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621689695782"><span id="local-6989586621689695783"><span id="local-6989586621689695784"><span id="local-6989586621689695785"><span id="local-6989586621689695786"><span id="local-6989586621689695787"><span id="local-6989586621689695788"><span id="local-6989586621689695789"><span id="local-6989586621689695790"><span class="annot"><span class="annottext">[BatchExecutionDetails]
Text
DiffTime
ParameterizedQueryHash
RoleName
SubscriptionsOptions
SourceName
PollerId
_pdParameterizedQueryHash :: ParameterizedQueryHash
_pdRole :: RoleName
_pdSource :: SourceName
_pdLiveQueryOptions :: SubscriptionsOptions
_pdTotalTime :: DiffTime
_pdBatches :: [BatchExecutionDetails]
_pdSnapshotTime :: DiffTime
_pdGeneratedSql :: Text
_pdPollerId :: PollerId
_pdParameterizedQueryHash :: PollDetails -&gt; ParameterizedQueryHash
_pdRole :: PollDetails -&gt; RoleName
_pdSource :: PollDetails -&gt; SourceName
_pdLiveQueryOptions :: PollDetails -&gt; SubscriptionsOptions
_pdTotalTime :: PollDetails -&gt; DiffTime
_pdBatches :: PollDetails -&gt; [BatchExecutionDetails]
_pdSnapshotTime :: PollDetails -&gt; DiffTime
_pdGeneratedSql :: PollDetails -&gt; Text
_pdPollerId :: PollDetails -&gt; PollerId
</span><a href="#local-6989586621689695782"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-385"></span><span>  </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;poller_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; PollerId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621689695790"><span class="hs-identifier hs-var">_pdPollerId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-387"></span><span>      </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;snapshot_time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; DiffTime -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689695788"><span class="hs-identifier hs-var">_pdSnapshotTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-388"></span><span>      </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;batches&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; [Value] -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">(BatchExecutionDetails -&gt; Value)
-&gt; [BatchExecutionDetails] -&gt; [Value]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; Value
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#batchExecutionDetailMinimal"><span class="hs-identifier hs-var">batchExecutionDetailMinimal</span></a></span><span> </span><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621689695787"><span class="hs-identifier hs-var">_pdBatches</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-389"></span><span>      </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;total_time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; DiffTime -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621689695786"><span class="hs-identifier hs-var">_pdTotalTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-390"></span><span>      </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; SourceName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689695784"><span class="hs-identifier hs-var">_pdSource</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-391"></span><span>      </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;role&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; RoleName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621689695783"><span class="hs-identifier hs-var">_pdRole</span></a></span><span>
</span><span id="line-392"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Logging.html#ToEngineLog"><span class="hs-identifier hs-type">L.ToEngineLog</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-395"></span><span>  </span><span id="local-6989586621689695778"><span class="annot"><span class="annottext">toEngineLog :: PollDetails -&gt; (LogLevel, EngineLogType Hasura, Value)
</span><a href="Hasura.Logging.html#toEngineLog"><span class="hs-identifier hs-var hs-var hs-var hs-var">toEngineLog</span></a></span></span><span> </span><span id="local-6989586621689695776"><span class="annot"><span class="annottext">PollDetails
</span><a href="#local-6989586621689695776"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">L.LevelInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EngineLogType Hasura
</span><a href="Hasura.Logging.html#ELTLivequeryPollerLog"><span class="hs-identifier hs-var">L.ELTLivequeryPollerLog</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PollDetails -&gt; Value
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#pollDetailMinimal"><span class="hs-identifier hs-var">pollDetailMinimal</span></a></span><span> </span><span class="annot"><span class="annottext">PollDetails
</span><a href="#local-6989586621689695776"><span class="hs-identifier hs-var">pl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span>
</span><span id="line-397"></span><span class="hs-keyword">type</span><span> </span><span id="SubscriptionPostPollHook"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier hs-var">SubscriptionPostPollHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span class="hs-comment">-- the default SubscriptionPostPollHook</span><span>
</span><span id="line-400"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#defaultSubscriptionPostPollHook"><span class="hs-identifier hs-type">defaultSubscriptionPostPollHook</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier hs-type">SubscriptionPostPollHook</span></a></span><span>
</span><span id="line-401"></span><span id="defaultSubscriptionPostPollHook"><span class="annot"><span class="annottext">defaultSubscriptionPostPollHook :: Logger Hasura -&gt; SubscriptionPostPollHook
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#defaultSubscriptionPostPollHook"><span class="hs-identifier hs-var hs-var">defaultSubscriptionPostPollHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621689695773"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689695773"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689695773"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-402"></span></pre></body></html>